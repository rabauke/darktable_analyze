
<html>
<head>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>
<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2">    This file is part of darktable,</a>
<a name="ln3">    copyright (c) 2011-2012 Robert Bieber, Johannes Hanika, Henrik Andersson.</a>
<a name="ln4"> </a>
<a name="ln5">    darktable is free software: you can redistribute it and/or modify</a>
<a name="ln6">    it under the terms of the GNU General Public License as published by</a>
<a name="ln7">    the Free Software Foundation, either version 3 of the License, or</a>
<a name="ln8">    (at your option) any later version.</a>
<a name="ln9"> </a>
<a name="ln10">    darktable is distributed in the hope that it will be useful,</a>
<a name="ln11">    but WITHOUT ANY WARRANTY; without even the implied warranty of</a>
<a name="ln12">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</a>
<a name="ln13">    GNU General Public License for more details.</a>
<a name="ln14"> </a>
<a name="ln15">    You should have received a copy of the GNU General Public License</a>
<a name="ln16">    along with darktable.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</a>
<a name="ln17">*/</a>
<a name="ln18"> </a>
<a name="ln19">#include &quot;libs/colorpicker.h&quot;</a>
<a name="ln20">#include &quot;common/darktable.h&quot;</a>
<a name="ln21">#include &quot;control/conf.h&quot;</a>
<a name="ln22">#include &quot;control/control.h&quot;</a>
<a name="ln23">#include &quot;develop/develop.h&quot;</a>
<a name="ln24">#include &quot;develop/imageop.h&quot;</a>
<a name="ln25">#include &quot;dtgtk/button.h&quot;</a>
<a name="ln26">#include &quot;dtgtk/togglebutton.h&quot;</a>
<a name="ln27">#include &quot;gui/accelerators.h&quot;</a>
<a name="ln28">#include &quot;gui/gtk.h&quot;</a>
<a name="ln29">#include &quot;libs/lib.h&quot;</a>
<a name="ln30">#include &quot;libs/lib_api.h&quot;</a>
<a name="ln31"> </a>
<a name="ln32">DT_MODULE(1);</a>
<a name="ln33"> </a>
<a name="ln34">typedef struct dt_lib_colorpicker_t</a>
<a name="ln35">{</a>
<a name="ln36">  GtkWidget *color_patch;</a>
<a name="ln37">  GtkWidget *output_label;</a>
<a name="ln38">  GtkWidget *color_mode_selector;</a>
<a name="ln39">  GtkWidget *statistic_selector;</a>
<a name="ln40">  GtkWidget *size_selector;</a>
<a name="ln41">  GtkWidget *picker_button;</a>
<a name="ln42">  GtkWidget *samples_container;</a>
<a name="ln43">  GtkWidget *samples_mode_selector;</a>
<a name="ln44">  GtkWidget *samples_statistic_selector;</a>
<a name="ln45">  GtkWidget *add_sample_button;</a>
<a name="ln46">  GtkWidget *display_samples_check_box;</a>
<a name="ln47">  GdkRGBA rgb;</a>
<a name="ln48">  gboolean from_proxy;</a>
<a name="ln49">} dt_lib_colorpicker_t;</a>
<a name="ln50"> </a>
<a name="ln51">const char *name(dt_lib_module_t *self)</a>
<a name="ln52">{</a>
<a name="ln53">  return _(&quot;color picker&quot;);</a>
<a name="ln54">}</a>
<a name="ln55"> </a>
<a name="ln56">const char **views(dt_lib_module_t *self)</a>
<a name="ln57">{</a>
<a name="ln58">  static const char *v[] = {&quot;darkroom&quot;, NULL};</a>
<a name="ln59">  return v;</a>
<a name="ln60">}</a>
<a name="ln61"> </a>
<a name="ln62">uint32_t container(dt_lib_module_t *self)</a>
<a name="ln63">{</a>
<a name="ln64">  return DT_UI_CONTAINER_PANEL_LEFT_CENTER;</a>
<a name="ln65">}</a>
<a name="ln66"> </a>
<a name="ln67">int expandable(dt_lib_module_t *self)</a>
<a name="ln68">{</a>
<a name="ln69">  return 1;</a>
<a name="ln70">}</a>
<a name="ln71"> </a>
<a name="ln72">int position()</a>
<a name="ln73">{</a>
<a name="ln74">  return 800;</a>
<a name="ln75">}</a>
<a name="ln76"> </a>
<a name="ln77">void init_key_accels(dt_lib_module_t *self)</a>
<a name="ln78">{</a>
<a name="ln79">  dt_accel_register_lib(self, NC_(&quot;accel&quot;, &quot;pick color&quot;), 0, 0);</a>
<a name="ln80">  dt_accel_register_lib(self, NC_(&quot;accel&quot;, &quot;add sample&quot;), 0, 0);</a>
<a name="ln81">}</a>
<a name="ln82"> </a>
<a name="ln83">void connect_key_accels(dt_lib_module_t *self)</a>
<a name="ln84">{</a>
<a name="ln85">  dt_lib_colorpicker_t *d = (dt_lib_colorpicker_t *)self-&gt;data;</a>
<a name="ln86">  dt_accel_connect_button_lib(self, &quot;pick color&quot;, d-&gt;picker_button);</a>
<a name="ln87">  dt_accel_connect_button_lib(self, &quot;add sample&quot;, d-&gt;add_sample_button);</a>
<a name="ln88">}</a>
<a name="ln89"> </a>
<a name="ln90">// GUI callbacks</a>
<a name="ln91"> </a>
<a name="ln92">static gboolean main_draw_callback(GtkWidget *widget, cairo_t *cr, gpointer data)</a>
<a name="ln93">{</a>
<a name="ln94">  guint width, height;</a>
<a name="ln95">  dt_lib_colorpicker_t *d = (dt_lib_colorpicker_t *)data;</a>
<a name="ln96"> </a>
<a name="ln97">  width = gtk_widget_get_allocated_width(widget);</a>
<a name="ln98">  height = gtk_widget_get_allocated_height(widget);</a>
<a name="ln99">  gdk_cairo_set_source_rgba (cr, &amp;d-&gt;rgb);</a>
<a name="ln100">  cairo_rectangle(cr, 0, 0, width, height);</a>
<a name="ln101">  cairo_fill (cr);</a>
<a name="ln102"> </a>
<a name="ln103">  return FALSE;</a>
<a name="ln104">}</a>
<a name="ln105"> </a>
<a name="ln106">static gboolean sample_draw_callback(GtkWidget *widget, cairo_t *cr, gpointer data)</a>
<a name="ln107">{</a>
<a name="ln108">  guint width, height;</a>
<a name="ln109">  dt_colorpicker_sample_t *sample = (dt_colorpicker_sample_t *)data;</a>
<a name="ln110"> </a>
<a name="ln111">  width = gtk_widget_get_allocated_width(widget);</a>
<a name="ln112">  height = gtk_widget_get_allocated_height(widget);</a>
<a name="ln113">  gdk_cairo_set_source_rgba(cr, &amp;sample-&gt;rgb);</a>
<a name="ln114">  cairo_rectangle(cr, 0, 0, width, height);</a>
<a name="ln115">  cairo_fill (cr);</a>
<a name="ln116"> </a>
<a name="ln117">  // if the sample is locked we want to add a lock</a>
<a name="ln118">  if(sample-&gt;locked)</a>
<a name="ln119">  {</a>
<a name="ln120">    int border = DT_PIXEL_APPLY_DPI(2);</a>
<a name="ln121">    int icon_width = width - 2 * border;</a>
<a name="ln122">    int icon_height = height - 2 * border;</a>
<a name="ln123">    if(icon_width &gt; 0 &amp;&amp; icon_height &gt; 0)</a>
<a name="ln124">    {</a>
<a name="ln125">      GdkRGBA fg_color;</a>
<a name="ln126">      gtk_style_context_get_color(gtk_widget_get_style_context(widget), gtk_widget_get_state_flags(widget), &amp;fg_color);</a>
<a name="ln127"> </a>
<a name="ln128">      gdk_cairo_set_source_rgba(cr, &amp;fg_color);</a>
<a name="ln129">      dtgtk_cairo_paint_lock(cr, border, border, icon_width, icon_height, 0, NULL);</a>
<a name="ln130">    }</a>
<a name="ln131">  }</a>
<a name="ln132"> </a>
<a name="ln133">  return FALSE;</a>
<a name="ln134">}</a>
<a name="ln135"> </a>
<a name="ln136">static void _update_picker_output(dt_lib_module_t *self)</a>
<a name="ln137">{</a>
<a name="ln138">  dt_lib_colorpicker_t *data = self-&gt;data;</a>
<a name="ln139">  char colstring[512];</a>
<a name="ln140">  dt_iop_module_t *module = get_colorout_module();</a>
<a name="ln141">  if(module)</a>
<a name="ln142">  {</a>
<a name="ln143">    const int reset = darktable.gui-&gt;reset;</a>
<a name="ln144">    darktable.gui-&gt;reset = 1;</a>
<a name="ln145">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(data-&gt;picker_button),</a>
<a name="ln146">                                 module-&gt;request_color_pick != DT_REQUEST_COLORPICK_OFF);</a>
<a name="ln147">    darktable.gui-&gt;reset = reset;</a>
<a name="ln148"> </a>
<a name="ln149">    int input_color = dt_conf_get_int(&quot;ui_last/colorpicker_model&quot;);</a>
<a name="ln150"> </a>
<a name="ln151">    // always adjust picked color:</a>
<a name="ln152">    int m = dt_conf_get_int(&quot;ui_last/colorpicker_mode&quot;);</a>
<a name="ln153">    float *rgb;</a>
<a name="ln154">    float *lab;</a>
<a name="ln155">    switch(m)</a>
<a name="ln156">    {</a>
<a name="ln157">      case 0: // mean</a>
<a name="ln158">        rgb = darktable.lib-&gt;proxy.colorpicker.picked_color_rgb_mean;</a>
<a name="ln159">        lab = darktable.lib-&gt;proxy.colorpicker.picked_color_lab_mean;</a>
<a name="ln160">        break;</a>
<a name="ln161">      case 1: // min</a>
<a name="ln162">        rgb = darktable.lib-&gt;proxy.colorpicker.picked_color_rgb_min;</a>
<a name="ln163">        lab = darktable.lib-&gt;proxy.colorpicker.picked_color_lab_min;</a>
<a name="ln164">        break;</a>
<a name="ln165">      default:</a>
<a name="ln166">        rgb = darktable.lib-&gt;proxy.colorpicker.picked_color_rgb_max;</a>
<a name="ln167">        lab = darktable.lib-&gt;proxy.colorpicker.picked_color_lab_max;</a>
<a name="ln168">        break;</a>
<a name="ln169">    }</a>
<a name="ln170">    switch(input_color)</a>
<a name="ln171">    {</a>
<a name="ln172">      case 0: // rgb</a>
<a name="ln173">        snprintf(colstring, sizeof(colstring), &quot;(%d, %d, %d)&quot;,</a>
<a name="ln174">                 (int)round(rgb[0] * 255.f), (int)round(rgb[1] * 255.f), (int)round(rgb[2] * 255.f));</a>
<a name="ln175">        break;</a>
<a name="ln176">      case 1: // Lab</a>
<a name="ln177">        snprintf(colstring, sizeof(colstring), &quot;(%.03f, %.03f, %.03f)&quot;, lab[0], lab[1], lab[2]);</a>
<a name="ln178">        break;</a>
<a name="ln179">    }</a>
<a name="ln180">    gtk_label_set_label(GTK_LABEL(data-&gt;output_label), colstring);</a>
<a name="ln181"> </a>
<a name="ln182">    // Setting the button color</a>
<a name="ln183">    data-&gt;rgb.red = CLAMP(rgb[0], 0.f, 1.f);</a>
<a name="ln184">    data-&gt;rgb.green = CLAMP(rgb[1], 0.f, 1.f);</a>
<a name="ln185">    data-&gt;rgb.blue = CLAMP(rgb[2], 0.f, 1.f);</a>
<a name="ln186">    gtk_widget_queue_draw(data-&gt;color_patch);</a>
<a name="ln187">  }</a>
<a name="ln188">}</a>
<a name="ln189"> </a>
<a name="ln190">static void _picker_button_toggled(GtkToggleButton *button, gpointer p)</a>
<a name="ln191">{</a>
<a name="ln192">  dt_lib_colorpicker_t *data = ((dt_lib_module_t *)p)-&gt;data;</a>
<a name="ln193">  gtk_widget_set_sensitive(GTK_WIDGET(data-&gt;add_sample_button), gtk_toggle_button_get_active(button));</a>
<a name="ln194">  if(darktable.gui-&gt;reset) return;</a>
<a name="ln195">  dt_iop_module_t *module = get_colorout_module();</a>
<a name="ln196">  if(module)</a>
<a name="ln197">  {</a>
<a name="ln198">    dt_iop_request_focus(module);</a>
<a name="ln199">    module-&gt;request_color_pick = gtk_toggle_button_get_active(button) ? DT_REQUEST_COLORPICK_MODULE</a>
<a name="ln200">                                                                      : DT_REQUEST_COLORPICK_OFF;</a>
<a name="ln201">    dt_dev_invalidate_from_gui(darktable.develop);</a>
<a name="ln202">  }</a>
<a name="ln203">  else</a>
<a name="ln204">  {</a>
<a name="ln205">    dt_iop_request_focus(NULL);</a>
<a name="ln206">  }</a>
<a name="ln207">  dt_control_queue_redraw();</a>
<a name="ln208">}</a>
<a name="ln209"> </a>
<a name="ln210">static void _statistic_changed(GtkComboBox *widget, gpointer p)</a>
<a name="ln211">{</a>
<a name="ln212">  dt_conf_set_int(&quot;ui_last/colorpicker_mode&quot;, gtk_combo_box_get_active(widget));</a>
<a name="ln213">  _update_picker_output((dt_lib_module_t *)p);</a>
<a name="ln214">}</a>
<a name="ln215"> </a>
<a name="ln216">static void _color_mode_changed(GtkComboBox *widget, gpointer p)</a>
<a name="ln217">{</a>
<a name="ln218">  dt_conf_set_int(&quot;ui_last/colorpicker_model&quot;, gtk_combo_box_get_active(widget));</a>
<a name="ln219">  _update_picker_output((dt_lib_module_t *)p);</a>
<a name="ln220">}</a>
<a name="ln221"> </a>
<a name="ln222">static void _size_changed(GtkComboBox *widget, gpointer p)</a>
<a name="ln223">{</a>
<a name="ln224">  dt_lib_colorpicker_t *data = ((dt_lib_module_t *)p)-&gt;data;</a>
<a name="ln225"> </a>
<a name="ln226">  const int size = gtk_combo_box_get_active(widget);</a>
<a name="ln227"> </a>
<a name="ln228">  dt_conf_set_int(&quot;ui_last/colorpicker_size&quot;, size);</a>
<a name="ln229">  darktable.lib-&gt;proxy.colorpicker.size = size;</a>
<a name="ln230">  gtk_widget_set_sensitive(data-&gt;statistic_selector, size);</a>
<a name="ln231"> </a>
<a name="ln232">  if (!data-&gt;from_proxy)</a>
<a name="ln233">    dt_dev_invalidate_from_gui(darktable.develop);</a>
<a name="ln234">  _update_picker_output(p);</a>
<a name="ln235">}</a>
<a name="ln236"> </a>
<a name="ln237">static void _update_samples_output(dt_lib_module_t *self)</a>
<a name="ln238">{</a>
<a name="ln239">  float fallback[] = { 0., 0., 0. };</a>
<a name="ln240">  float fallback_rgb[] = { 0, 0, 0 };</a>
<a name="ln241">  float *rgb = fallback_rgb;</a>
<a name="ln242">  float *lab = fallback;</a>
<a name="ln243">  char text[1024];</a>
<a name="ln244">  GSList *samples = darktable.lib-&gt;proxy.colorpicker.live_samples;</a>
<a name="ln245">  dt_colorpicker_sample_t *sample = NULL;</a>
<a name="ln246"> </a>
<a name="ln247">  int model = dt_conf_get_int(&quot;ui_last/colorsamples_model&quot;);</a>
<a name="ln248">  int statistic = dt_conf_get_int(&quot;ui_last/colorsamples_mode&quot;);</a>
<a name="ln249"> </a>
<a name="ln250">  while(samples)</a>
<a name="ln251">  {</a>
<a name="ln252">    sample = samples-&gt;data;</a>
<a name="ln253"> </a>
<a name="ln254">    switch(statistic)</a>
<a name="ln255">    {</a>
<a name="ln256">      case 0:</a>
<a name="ln257">        rgb = sample-&gt;picked_color_rgb_mean;</a>
<a name="ln258">        lab = sample-&gt;picked_color_lab_mean;</a>
<a name="ln259">        break;</a>
<a name="ln260"> </a>
<a name="ln261">      case 1:</a>
<a name="ln262">        rgb = sample-&gt;picked_color_rgb_min;</a>
<a name="ln263">        lab = sample-&gt;picked_color_lab_min;</a>
<a name="ln264">        break;</a>
<a name="ln265"> </a>
<a name="ln266">      case 2:</a>
<a name="ln267">        rgb = sample-&gt;picked_color_rgb_max;</a>
<a name="ln268">        lab = sample-&gt;picked_color_lab_max;</a>
<a name="ln269">        break;</a>
<a name="ln270">    }</a>
<a name="ln271"> </a>
<a name="ln272">    // Setting the output button</a>
<a name="ln273">    sample-&gt;rgb.red = CLAMP(rgb[0], 0.f, 1.f);</a>
<a name="ln274">    sample-&gt;rgb.green = CLAMP(rgb[1], 0.f, 1.f);</a>
<a name="ln275">    sample-&gt;rgb.blue = CLAMP(rgb[2], 0.f, 1.f);</a>
<a name="ln276">    gtk_widget_queue_draw(sample-&gt;color_patch);</a>
<a name="ln277"> </a>
<a name="ln278">    // Setting the output label</a>
<a name="ln279">    switch(model)</a>
<a name="ln280">    {</a>
<a name="ln281">      case 0:</a>
<a name="ln282">        // RGB</a>
<a name="ln283">        snprintf(text, sizeof(text), &quot;%3d %3d %3d&quot;,</a>
<a name="ln284">                 (int)round(rgb[0] * 255.f), (int)round(rgb[1] * 255.f), (int)round(rgb[2] * 255.f));</a>
<a name="ln285">        break;</a>
<a name="ln286"> </a>
<a name="ln287">      case 1:</a>
<a name="ln288">        // Lab</a>
<a name="ln289">        snprintf(text, sizeof(text), &quot;%5.02f %5.02f %5.02f&quot;, lab[0], lab[1], lab[2]);</a>
<a name="ln290">        break;</a>
<a name="ln291">    }</a>
<a name="ln292">    gtk_label_set_text(GTK_LABEL(sample-&gt;output_label), text);</a>
<a name="ln293"> </a>
<a name="ln294">    samples = g_slist_next(samples);</a>
<a name="ln295">  }</a>
<a name="ln296">}</a>
<a name="ln297"> </a>
<a name="ln298">static void _samples_statistic_changed(GtkComboBox *widget, gpointer p)</a>
<a name="ln299">{</a>
<a name="ln300">  dt_conf_set_int(&quot;ui_last/colorsamples_mode&quot;, gtk_combo_box_get_active(widget));</a>
<a name="ln301">  _update_samples_output((dt_lib_module_t *)p);</a>
<a name="ln302">}</a>
<a name="ln303"> </a>
<a name="ln304">static void _samples_mode_changed(GtkComboBox *widget, gpointer p)</a>
<a name="ln305">{</a>
<a name="ln306">  dt_conf_set_int(&quot;ui_last/colorsamples_model&quot;, gtk_combo_box_get_active(widget));</a>
<a name="ln307">  _update_samples_output((dt_lib_module_t *)p);</a>
<a name="ln308">}</a>
<a name="ln309"> </a>
<a name="ln310">static gboolean _live_sample_enter(GtkWidget *widget, GdkEvent *event, gpointer sample)</a>
<a name="ln311">{</a>
<a name="ln312">  darktable.lib-&gt;proxy.colorpicker.selected_sample = (dt_colorpicker_sample_t *)sample;</a>
<a name="ln313">  if(darktable.lib-&gt;proxy.colorpicker.display_samples) dt_dev_invalidate_from_gui(darktable.develop);</a>
<a name="ln314"> </a>
<a name="ln315">  return FALSE;</a>
<a name="ln316">}</a>
<a name="ln317"> </a>
<a name="ln318">static gboolean _live_sample_leave(GtkWidget *widget, GdkEvent *event, gpointer data)</a>
<a name="ln319">{</a>
<a name="ln320">  darktable.lib-&gt;proxy.colorpicker.selected_sample = NULL;</a>
<a name="ln321">  if(darktable.lib-&gt;proxy.colorpicker.display_samples) dt_dev_invalidate_from_gui(darktable.develop);</a>
<a name="ln322"> </a>
<a name="ln323">  return FALSE;</a>
<a name="ln324">}</a>
<a name="ln325"> </a>
<a name="ln326">static void _remove_sample(dt_colorpicker_sample_t *sample)</a>
<a name="ln327">{</a>
<a name="ln328">  gtk_widget_hide(sample-&gt;container);</a>
<a name="ln329">  gtk_widget_destroy(sample-&gt;color_patch);</a>
<a name="ln330">  gtk_widget_destroy(sample-&gt;patch_box);</a>
<a name="ln331">  gtk_widget_destroy(sample-&gt;output_label);</a>
<a name="ln332">  gtk_widget_destroy(sample-&gt;delete_button);</a>
<a name="ln333">  gtk_widget_destroy(sample-&gt;container);</a>
<a name="ln334">  darktable.lib-&gt;proxy.colorpicker.live_samples</a>
<a name="ln335">    = g_slist_remove(darktable.lib-&gt;proxy.colorpicker.live_samples, (gpointer)sample);</a>
<a name="ln336">  free(sample);</a>
<a name="ln337">}</a>
<a name="ln338"> </a>
<a name="ln339">static void _remove_sample_cb(GtkButton *widget, gpointer data)</a>
<a name="ln340">{</a>
<a name="ln341">  dt_colorpicker_sample_t *sample = (dt_colorpicker_sample_t *)data;</a>
<a name="ln342">  _remove_sample(sample);</a>
<a name="ln343">  dt_dev_invalidate_from_gui(darktable.develop);</a>
<a name="ln344">}</a>
<a name="ln345"> </a>
<a name="ln346">static gboolean _sample_lock_toggle(GtkWidget *widget, GdkEvent *event, gpointer data)</a>
<a name="ln347">{</a>
<a name="ln348">  dt_colorpicker_sample_t *sample = (dt_colorpicker_sample_t *)data;</a>
<a name="ln349">  sample-&gt;locked = !sample-&gt;locked;</a>
<a name="ln350">  gtk_widget_queue_draw(widget);</a>
<a name="ln351">  return FALSE;</a>
<a name="ln352">}</a>
<a name="ln353"> </a>
<a name="ln354">static void _add_sample(GtkButton *widget, gpointer self)</a>
<a name="ln355">{</a>
<a name="ln356">  dt_lib_colorpicker_t *data = ((dt_lib_module_t *)self)-&gt;data;</a>
<a name="ln357">  dt_colorpicker_sample_t *sample = (dt_colorpicker_sample_t *)malloc(sizeof(dt_colorpicker_sample_t));</a>
<a name="ln358">  darktable.lib-&gt;proxy.colorpicker.live_samples</a>
<a name="ln359">      = g_slist_append(darktable.lib-&gt;proxy.colorpicker.live_samples, sample);</a>
<a name="ln360">  dt_iop_module_t *module = get_colorout_module();</a>
<a name="ln361">  int i;</a>
<a name="ln362"> </a>
<a name="ln363">  sample-&gt;locked = 0;</a>
<a name="ln364">  sample-&gt;rgb.red = 0.7;</a>
<a name="ln365">  sample-&gt;rgb.green = 0.7;</a>
<a name="ln366">  sample-&gt;rgb.blue = 0.7;</a>
<a name="ln367">  sample-&gt;rgb.alpha = 1.0;</a>
<a name="ln368"> </a>
<a name="ln369">  // Initializing the UI</a>
<a name="ln370">  sample-&gt;container = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0);</a>
<a name="ln371">  gtk_box_pack_start(GTK_BOX(data-&gt;samples_container), sample-&gt;container, TRUE, TRUE, 0);</a>
<a name="ln372"> </a>
<a name="ln373">  sample-&gt;patch_box = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0);</a>
<a name="ln374">  gtk_widget_set_name(sample-&gt;patch_box, &quot;live-sample&quot;);</a>
<a name="ln375">  sample-&gt;color_patch = gtk_drawing_area_new();</a>
<a name="ln376">  gtk_box_pack_start(GTK_BOX(sample-&gt;patch_box), sample-&gt;color_patch, TRUE, TRUE, 0);</a>
<a name="ln377">  gtk_widget_set_events(sample-&gt;color_patch, GDK_ENTER_NOTIFY_MASK | GDK_LEAVE_NOTIFY_MASK | GDK_BUTTON_PRESS_MASK);</a>
<a name="ln378">  gtk_widget_set_tooltip_text(sample-&gt;color_patch, _(&quot;hover to highlight sample on canvas, &quot;</a>
<a name="ln379">                                                       &quot;click to lock sample&quot;));</a>
<a name="ln380">  gtk_box_pack_start(GTK_BOX(sample-&gt;container), sample-&gt;patch_box, TRUE, FALSE, 0);</a>
<a name="ln381"> </a>
<a name="ln382">  g_signal_connect(G_OBJECT(sample-&gt;color_patch), &quot;enter-notify-event&quot;, G_CALLBACK(_live_sample_enter),</a>
<a name="ln383">                   sample);</a>
<a name="ln384">  g_signal_connect(G_OBJECT(sample-&gt;color_patch), &quot;leave-notify-event&quot;, G_CALLBACK(_live_sample_leave),</a>
<a name="ln385">                   sample);</a>
<a name="ln386">  g_signal_connect(G_OBJECT(sample-&gt;color_patch), &quot;button-press-event&quot;, G_CALLBACK(_sample_lock_toggle),</a>
<a name="ln387">                   sample);</a>
<a name="ln388">  g_signal_connect(G_OBJECT(sample-&gt;color_patch), &quot;draw&quot;, G_CALLBACK(sample_draw_callback), sample);</a>
<a name="ln389"> </a>
<a name="ln390">  sample-&gt;output_label = gtk_label_new(&quot;&quot;);</a>
<a name="ln391">  gtk_widget_set_name(sample-&gt;output_label, &quot;live-sample-data&quot;);</a>
<a name="ln392">  gtk_box_pack_start(GTK_BOX(sample-&gt;container), sample-&gt;output_label, TRUE, TRUE, 0);</a>
<a name="ln393"> </a>
<a name="ln394">  sample-&gt;delete_button = gtk_button_new_with_label(_(&quot;remove&quot;));</a>
<a name="ln395">  gtk_box_pack_start(GTK_BOX(sample-&gt;container), sample-&gt;delete_button, FALSE, FALSE, 0);</a>
<a name="ln396"> </a>
<a name="ln397">  g_signal_connect(G_OBJECT(sample-&gt;delete_button), &quot;clicked&quot;, G_CALLBACK(_remove_sample_cb), sample);</a>
<a name="ln398"> </a>
<a name="ln399">  gtk_widget_show_all(data-&gt;samples_container);</a>
<a name="ln400"> </a>
<a name="ln401">  // Setting the actual data</a>
<a name="ln402">  if(dt_conf_get_int(&quot;ui_last/colorpicker_size&quot;))</a>
<a name="ln403">  {</a>
<a name="ln404">    sample-&gt;size = DT_COLORPICKER_SIZE_BOX;</a>
<a name="ln405">    for(i = 0; i &lt; 4; i++) sample-&gt;box[i] = module-&gt;color_picker_box[i];</a>
<a name="ln406">  }</a>
<a name="ln407">  else</a>
<a name="ln408">  {</a>
<a name="ln409">    sample-&gt;size = DT_COLORPICKER_SIZE_POINT;</a>
<a name="ln410">    for(i = 0; i &lt; 2; i++) sample-&gt;point[i] = module-&gt;color_picker_point[i];</a>
<a name="ln411">  }</a>
<a name="ln412"> </a>
<a name="ln413">  for(i = 0; i &lt; 3; i++)</a>
<a name="ln414">    sample-&gt;picked_color_lab_max[i] = darktable.lib-&gt;proxy.colorpicker.picked_color_lab_max[i];</a>
<a name="ln415">  for(i = 0; i &lt; 3; i++)</a>
<a name="ln416">    sample-&gt;picked_color_lab_mean[i] = darktable.lib-&gt;proxy.colorpicker.picked_color_lab_mean[i];</a>
<a name="ln417">  for(i = 0; i &lt; 3; i++)</a>
<a name="ln418">    sample-&gt;picked_color_lab_min[i] = darktable.lib-&gt;proxy.colorpicker.picked_color_lab_min[i];</a>
<a name="ln419">  for(i = 0; i &lt; 3; i++)</a>
<a name="ln420">    sample-&gt;picked_color_rgb_max[i] = darktable.lib-&gt;proxy.colorpicker.picked_color_rgb_max[i];</a>
<a name="ln421">  for(i = 0; i &lt; 3; i++)</a>
<a name="ln422">    sample-&gt;picked_color_rgb_mean[i] = darktable.lib-&gt;proxy.colorpicker.picked_color_rgb_mean[i];</a>
<a name="ln423">  for(i = 0; i &lt; 3; i++)</a>
<a name="ln424">    sample-&gt;picked_color_rgb_min[i] = darktable.lib-&gt;proxy.colorpicker.picked_color_rgb_min[i];</a>
<a name="ln425"> </a>
<a name="ln426">  // Updating the display</a>
<a name="ln427">  _update_samples_output((dt_lib_module_t *)self);</a>
<a name="ln428">}</a>
<a name="ln429"> </a>
<a name="ln430">static void _display_samples_changed(GtkToggleButton *button, gpointer data)</a>
<a name="ln431">{</a>
<a name="ln432">  dt_conf_set_int(&quot;ui_last/colorpicker_display_samples&quot;, gtk_toggle_button_get_active(button));</a>
<a name="ln433">  darktable.lib-&gt;proxy.colorpicker.display_samples = gtk_toggle_button_get_active(button);</a>
<a name="ln434">  dt_dev_invalidate_from_gui(darktable.develop);</a>
<a name="ln435">}</a>
<a name="ln436"> </a>
<a name="ln437">static void _restrict_histogram_changed(GtkToggleButton *button, gpointer data)</a>
<a name="ln438">{</a>
<a name="ln439">  dt_conf_set_int(&quot;ui_last/colorpicker_restrict_histogram&quot;, gtk_toggle_button_get_active(button));</a>
<a name="ln440">  darktable.lib-&gt;proxy.colorpicker.restrict_histogram = gtk_toggle_button_get_active(button);</a>
<a name="ln441">  dt_dev_invalidate_from_gui(darktable.develop);</a>
<a name="ln442">}</a>
<a name="ln443"> </a>
<a name="ln444">/* set sample area proxy impl */</a>
<a name="ln445">static void _set_sample_area(dt_lib_module_t *self, float size)</a>
<a name="ln446">{</a>
<a name="ln447">  dt_lib_colorpicker_t *d = (dt_lib_colorpicker_t *)self-&gt;data;</a>
<a name="ln448"> </a>
<a name="ln449">  if(darktable.develop-&gt;gui_module)</a>
<a name="ln450">  {</a>
<a name="ln451">    darktable.develop-&gt;gui_module-&gt;color_picker_box[0] = darktable.develop-&gt;gui_module-&gt;color_picker_box[1]</a>
<a name="ln452">        = 1.0 - size;</a>
<a name="ln453">    darktable.develop-&gt;gui_module-&gt;color_picker_box[2] = darktable.develop-&gt;gui_module-&gt;color_picker_box[3]</a>
<a name="ln454">        = size;</a>
<a name="ln455">  }</a>
<a name="ln456"> </a>
<a name="ln457">  d-&gt;from_proxy = TRUE;</a>
<a name="ln458">  gtk_combo_box_set_active(GTK_COMBO_BOX(d-&gt;size_selector), DT_COLORPICKER_SIZE_BOX);</a>
<a name="ln459">  d-&gt;from_proxy = FALSE;</a>
<a name="ln460">}</a>
<a name="ln461"> </a>
<a name="ln462">static void _set_sample_box_area(dt_lib_module_t *self, const float *const box)</a>
<a name="ln463">{</a>
<a name="ln464">  dt_lib_colorpicker_t *d = (dt_lib_colorpicker_t *)self-&gt;data;</a>
<a name="ln465"> </a>
<a name="ln466">  if(darktable.develop-&gt;gui_module)</a>
<a name="ln467">  {</a>
<a name="ln468">    for(int k = 0; k &lt; 4; k++) darktable.develop-&gt;gui_module-&gt;color_picker_box[k] = box[k];</a>
<a name="ln469">  }</a>
<a name="ln470"> </a>
<a name="ln471">  d-&gt;from_proxy = TRUE;</a>
<a name="ln472">  gtk_combo_box_set_active(GTK_COMBO_BOX(d-&gt;size_selector), DT_COLORPICKER_SIZE_BOX);</a>
<a name="ln473">  d-&gt;from_proxy = FALSE;</a>
<a name="ln474">}</a>
<a name="ln475"> </a>
<a name="ln476">static void _set_sample_point(dt_lib_module_t *self, float x, float y)</a>
<a name="ln477">{</a>
<a name="ln478">  dt_lib_colorpicker_t *d = (dt_lib_colorpicker_t *)self-&gt;data;</a>
<a name="ln479"> </a>
<a name="ln480">  if(darktable.develop-&gt;gui_module)</a>
<a name="ln481">  {</a>
<a name="ln482">    darktable.develop-&gt;gui_module-&gt;color_picker_point[0] = x;</a>
<a name="ln483">    darktable.develop-&gt;gui_module-&gt;color_picker_point[1] = y;</a>
<a name="ln484">  }</a>
<a name="ln485"> </a>
<a name="ln486">  d-&gt;from_proxy = TRUE;</a>
<a name="ln487">  gtk_combo_box_set_active(GTK_COMBO_BOX(d-&gt;size_selector), DT_COLORPICKER_SIZE_POINT);</a>
<a name="ln488">  d-&gt;from_proxy = FALSE;</a>
<a name="ln489">}</a>
<a name="ln490"> </a>
<a name="ln491">void gui_init(dt_lib_module_t *self)</a>
<a name="ln492">{</a>
<a name="ln493">  unsigned int i;</a>
<a name="ln494"> </a>
<a name="ln495">  GtkWidget *container = gtk_box_new(GTK_ORIENTATION_VERTICAL, 0);</a>
<a name="ln496">  GtkWidget *output_row = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0);</a>
<a name="ln497">  GtkWidget *output_options = gtk_box_new(GTK_ORIENTATION_VERTICAL, 0);</a>
<a name="ln498">  GtkWidget *picker_subrow = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0);</a>
<a name="ln499">  GtkWidget *restrict_button;</a>
<a name="ln500">  GtkWidget *samples_label = dt_ui_section_label_new(_(&quot;live samples&quot;));</a>
<a name="ln501">  GtkWidget *samples_options_row = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0);</a>
<a name="ln502"> </a>
<a name="ln503">  // Initializing self data structure</a>
<a name="ln504">  dt_lib_colorpicker_t *data = (dt_lib_colorpicker_t *)calloc(1, sizeof(dt_lib_colorpicker_t));</a>
<a name="ln505">  self-&gt;data = (void *)data;</a>
<a name="ln506">  data-&gt;rgb.red = 0.7;</a>
<a name="ln507">  data-&gt;rgb.green = 0.7;</a>
<a name="ln508">  data-&gt;rgb.blue = 0.7;</a>
<a name="ln509">  data-&gt;rgb.alpha = 1.0;</a>
<a name="ln510">  data-&gt;from_proxy = FALSE;</a>
<a name="ln511"> </a>
<a name="ln512">  // Initializing proxy functions and data</a>
<a name="ln513">  darktable.lib-&gt;proxy.colorpicker.module = self;</a>
<a name="ln514">  darktable.lib-&gt;proxy.colorpicker.size = dt_conf_get_int(&quot;ui_last/colorpicker_size&quot;);</a>
<a name="ln515">  darktable.lib-&gt;proxy.colorpicker.display_samples = dt_conf_get_int(&quot;ui_last/colorpicker_display_samples&quot;);</a>
<a name="ln516">  darktable.lib-&gt;proxy.colorpicker.live_samples = NULL;</a>
<a name="ln517">  darktable.lib-&gt;proxy.colorpicker.picked_color_rgb_mean = (float *)malloc(sizeof(float) * 3);</a>
<a name="ln518">  darktable.lib-&gt;proxy.colorpicker.picked_color_rgb_min = (float *)malloc(sizeof(float) * 3);</a>
<a name="ln519">  darktable.lib-&gt;proxy.colorpicker.picked_color_rgb_max = (float *)malloc(sizeof(float) * 3);</a>
<a name="ln520">  darktable.lib-&gt;proxy.colorpicker.picked_color_lab_mean = (float *)malloc(sizeof(float) * 3);</a>
<a name="ln521">  darktable.lib-&gt;proxy.colorpicker.picked_color_lab_min = (float *)malloc(sizeof(float) * 3);</a>
<a name="ln522">  darktable.lib-&gt;proxy.colorpicker.picked_color_lab_max = (float *)malloc(sizeof(float) * 3);</a>
<a name="ln523">  for(i = 0; i &lt; 3; i++)</a>
<a name="ln524">    darktable.lib-&gt;proxy.colorpicker.picked_color_rgb_mean[i]</a>
<a name="ln525">        = darktable.lib-&gt;proxy.colorpicker.picked_color_rgb_min[i]</a>
<a name="ln526">        = darktable.lib-&gt;proxy.colorpicker.picked_color_rgb_max[i] = 0;</a>
<a name="ln527">  for(i = 0; i &lt; 3; i++)</a>
<a name="ln528">    darktable.lib-&gt;proxy.colorpicker.picked_color_lab_mean[i]</a>
<a name="ln529">        = darktable.lib-&gt;proxy.colorpicker.picked_color_lab_min[i]</a>
<a name="ln530">        = darktable.lib-&gt;proxy.colorpicker.picked_color_lab_max[i] = 0;</a>
<a name="ln531">  darktable.lib-&gt;proxy.colorpicker.update_panel = _update_picker_output;</a>
<a name="ln532">  darktable.lib-&gt;proxy.colorpicker.update_samples = _update_samples_output;</a>
<a name="ln533">  darktable.lib-&gt;proxy.colorpicker.set_sample_area = _set_sample_area;</a>
<a name="ln534">  darktable.lib-&gt;proxy.colorpicker.set_sample_box_area = _set_sample_box_area;</a>
<a name="ln535">  darktable.lib-&gt;proxy.colorpicker.set_sample_point = _set_sample_point;</a>
<a name="ln536"> </a>
<a name="ln537">  // Setting up the GUI</a>
<a name="ln538">  self-&gt;widget = container;</a>
<a name="ln539">  gtk_box_pack_start(GTK_BOX(container), output_row, TRUE, TRUE, 0);</a>
<a name="ln540">  dt_gui_add_help_link(self-&gt;widget, dt_get_help_url(self-&gt;plugin_name));</a>
<a name="ln541"> </a>
<a name="ln542">  // The color patch</a>
<a name="ln543">  GtkWidget *picker_area = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0);</a>
<a name="ln544">  gtk_widget_set_name(GTK_WIDGET(picker_area), &quot;color-picker-area&quot;);</a>
<a name="ln545">  data-&gt;color_patch = gtk_drawing_area_new();</a>
<a name="ln546">  g_signal_connect(G_OBJECT(data-&gt;color_patch), &quot;draw&quot;, G_CALLBACK(main_draw_callback), data);</a>
<a name="ln547">  gtk_box_pack_start(GTK_BOX(picker_area), data-&gt;color_patch, TRUE, TRUE, 0);</a>
<a name="ln548">  gtk_box_pack_start(GTK_BOX(output_row), picker_area, FALSE, FALSE, 0);</a>
<a name="ln549"> </a>
<a name="ln550">  // The picker button, output selectors and label</a>
<a name="ln551">  gtk_box_pack_start(GTK_BOX(output_row), output_options, TRUE, TRUE, 0);</a>
<a name="ln552"> </a>
<a name="ln553">  data-&gt;size_selector = gtk_combo_box_text_new();</a>
<a name="ln554">  gtk_combo_box_text_append_text(GTK_COMBO_BOX_TEXT(data-&gt;size_selector), _(&quot;point&quot;));</a>
<a name="ln555">  gtk_combo_box_text_append_text(GTK_COMBO_BOX_TEXT(data-&gt;size_selector), _(&quot;area&quot;));</a>
<a name="ln556">  gtk_combo_box_set_active(GTK_COMBO_BOX(data-&gt;size_selector), dt_conf_get_int(&quot;ui_last/colorpicker_size&quot;));</a>
<a name="ln557">  gtk_box_pack_start(GTK_BOX(picker_subrow), data-&gt;size_selector, TRUE, TRUE, 0);</a>
<a name="ln558"> </a>
<a name="ln559">  g_signal_connect(G_OBJECT(data-&gt;size_selector), &quot;changed&quot;, G_CALLBACK(_size_changed), (gpointer)self);</a>
<a name="ln560"> </a>
<a name="ln561">  data-&gt;picker_button = dtgtk_togglebutton_new(dtgtk_cairo_paint_colorpicker, CPF_STYLE_BOX, NULL);</a>
<a name="ln562">  gtk_widget_set_name(GTK_WIDGET(data-&gt;picker_button), &quot;control-button&quot;);</a>
<a name="ln563">  gtk_box_pack_start(GTK_BOX(picker_subrow), data-&gt;picker_button, FALSE, FALSE, 0);</a>
<a name="ln564"> </a>
<a name="ln565">  g_signal_connect(G_OBJECT(data-&gt;picker_button), &quot;toggled&quot;, G_CALLBACK(_picker_button_toggled), self);</a>
<a name="ln566"> </a>
<a name="ln567">  gtk_box_pack_start(GTK_BOX(output_options), picker_subrow, TRUE, TRUE, 0);</a>
<a name="ln568"> </a>
<a name="ln569">  data-&gt;statistic_selector = gtk_combo_box_text_new();</a>
<a name="ln570">  gtk_combo_box_text_append_text(GTK_COMBO_BOX_TEXT(data-&gt;statistic_selector), _(&quot;mean&quot;));</a>
<a name="ln571">  gtk_combo_box_text_append_text(GTK_COMBO_BOX_TEXT(data-&gt;statistic_selector), _(&quot;min&quot;));</a>
<a name="ln572">  gtk_combo_box_text_append_text(GTK_COMBO_BOX_TEXT(data-&gt;statistic_selector), _(&quot;max&quot;));</a>
<a name="ln573">  gtk_combo_box_set_active(GTK_COMBO_BOX(data-&gt;statistic_selector),</a>
<a name="ln574">                           dt_conf_get_int(&quot;ui_last/colorpicker_mode&quot;));</a>
<a name="ln575">  gtk_widget_set_sensitive(data-&gt;statistic_selector, dt_conf_get_int(&quot;ui_last/colorpicker_size&quot;));</a>
<a name="ln576">  gtk_box_pack_start(GTK_BOX(output_options), data-&gt;statistic_selector, TRUE, TRUE, 0);</a>
<a name="ln577"> </a>
<a name="ln578">  g_signal_connect(G_OBJECT(data-&gt;statistic_selector), &quot;changed&quot;, G_CALLBACK(_statistic_changed), self);</a>
<a name="ln579"> </a>
<a name="ln580">  data-&gt;color_mode_selector = gtk_combo_box_text_new();</a>
<a name="ln581">  gtk_combo_box_text_append_text(GTK_COMBO_BOX_TEXT(data-&gt;color_mode_selector), _(&quot;RGB&quot;));</a>
<a name="ln582">  gtk_combo_box_text_append_text(GTK_COMBO_BOX_TEXT(data-&gt;color_mode_selector), _(&quot;Lab&quot;));</a>
<a name="ln583">  gtk_combo_box_set_active(GTK_COMBO_BOX(data-&gt;color_mode_selector),</a>
<a name="ln584">                           dt_conf_get_int(&quot;ui_last/colorpicker_model&quot;));</a>
<a name="ln585">  gtk_box_pack_start(GTK_BOX(output_options), data-&gt;color_mode_selector, TRUE, TRUE, 0);</a>
<a name="ln586"> </a>
<a name="ln587">  g_signal_connect(G_OBJECT(data-&gt;color_mode_selector), &quot;changed&quot;, G_CALLBACK(_color_mode_changed), self);</a>
<a name="ln588"> </a>
<a name="ln589">  data-&gt;output_label = gtk_label_new(&quot;&quot;);</a>
<a name="ln590">  gtk_label_set_justify(GTK_LABEL(data-&gt;output_label), GTK_JUSTIFY_CENTER);</a>
<a name="ln591">  gtk_box_pack_start(GTK_BOX(output_options), data-&gt;output_label, FALSE, FALSE, 0);</a>
<a name="ln592"> </a>
<a name="ln593">  restrict_button = gtk_check_button_new_with_label(_(&quot;restrict histogram to selection&quot;));</a>
<a name="ln594">  gtk_label_set_ellipsize(GTK_LABEL(gtk_bin_get_child(GTK_BIN(restrict_button))), PANGO_ELLIPSIZE_MIDDLE);</a>
<a name="ln595">  gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(restrict_button),</a>
<a name="ln596">                               dt_conf_get_int(&quot;ui_last/colorpicker_restrict_histogram&quot;));</a>
<a name="ln597">  darktable.lib-&gt;proxy.colorpicker.restrict_histogram</a>
<a name="ln598">      = dt_conf_get_int(&quot;ui_last/colorpicker_restrict_histogram&quot;);</a>
<a name="ln599">  gtk_box_pack_start(GTK_BOX(container), restrict_button, TRUE, TRUE, 0);</a>
<a name="ln600">  g_signal_connect(G_OBJECT(restrict_button), &quot;toggled&quot;, G_CALLBACK(_restrict_histogram_changed), NULL);</a>
<a name="ln601"> </a>
<a name="ln602">  // Adding the live samples section</a>
<a name="ln603">  gtk_box_pack_start(GTK_BOX(container), samples_label, TRUE, TRUE, 0);</a>
<a name="ln604">  gtk_box_pack_start(GTK_BOX(container), samples_options_row, TRUE, TRUE, 0);</a>
<a name="ln605"> </a>
<a name="ln606">  data-&gt;samples_statistic_selector = gtk_combo_box_text_new();</a>
<a name="ln607">  gtk_combo_box_text_append_text(GTK_COMBO_BOX_TEXT(data-&gt;samples_statistic_selector), _(&quot;mean&quot;));</a>
<a name="ln608">  gtk_combo_box_text_append_text(GTK_COMBO_BOX_TEXT(data-&gt;samples_statistic_selector), _(&quot;min&quot;));</a>
<a name="ln609">  gtk_combo_box_text_append_text(GTK_COMBO_BOX_TEXT(data-&gt;samples_statistic_selector), _(&quot;max&quot;));</a>
<a name="ln610">  gtk_combo_box_set_active(GTK_COMBO_BOX(data-&gt;samples_statistic_selector),</a>
<a name="ln611">                           dt_conf_get_int(&quot;ui_last/colorsamples_mode&quot;));</a>
<a name="ln612">  gtk_box_pack_start(GTK_BOX(samples_options_row), data-&gt;samples_statistic_selector, TRUE, TRUE, 0);</a>
<a name="ln613"> </a>
<a name="ln614">  g_signal_connect(G_OBJECT(data-&gt;samples_statistic_selector), &quot;changed&quot;,</a>
<a name="ln615">                   G_CALLBACK(_samples_statistic_changed), self);</a>
<a name="ln616"> </a>
<a name="ln617">  data-&gt;samples_mode_selector = gtk_combo_box_text_new();</a>
<a name="ln618">  gtk_combo_box_text_append_text(GTK_COMBO_BOX_TEXT(data-&gt;samples_mode_selector), _(&quot;RGB&quot;));</a>
<a name="ln619">  gtk_combo_box_text_append_text(GTK_COMBO_BOX_TEXT(data-&gt;samples_mode_selector), _(&quot;Lab&quot;));</a>
<a name="ln620">  gtk_combo_box_set_active(GTK_COMBO_BOX(data-&gt;samples_mode_selector),</a>
<a name="ln621">                           dt_conf_get_int(&quot;ui_last/colorsamples_model&quot;));</a>
<a name="ln622">  gtk_box_pack_start(GTK_BOX(samples_options_row), data-&gt;samples_mode_selector, TRUE, TRUE, 0);</a>
<a name="ln623"> </a>
<a name="ln624">  g_signal_connect(G_OBJECT(data-&gt;samples_mode_selector), &quot;changed&quot;, G_CALLBACK(_samples_mode_changed), self);</a>
<a name="ln625"> </a>
<a name="ln626">  data-&gt;add_sample_button = gtk_button_new_with_label(_(&quot;add&quot;));</a>
<a name="ln627">  gtk_widget_set_sensitive(data-&gt;add_sample_button, FALSE);</a>
<a name="ln628">  gtk_box_pack_start(GTK_BOX(samples_options_row), data-&gt;add_sample_button, FALSE, FALSE, 0);</a>
<a name="ln629"> </a>
<a name="ln630">  g_signal_connect(G_OBJECT(data-&gt;add_sample_button), &quot;clicked&quot;, G_CALLBACK(_add_sample), self);</a>
<a name="ln631"> </a>
<a name="ln632">  data-&gt;samples_container = gtk_box_new(GTK_ORIENTATION_VERTICAL, 0);</a>
<a name="ln633">  gtk_box_pack_start(GTK_BOX(container), data-&gt;samples_container, TRUE, TRUE, 0);</a>
<a name="ln634"> </a>
<a name="ln635">  data-&gt;display_samples_check_box = gtk_check_button_new_with_label(_(&quot;display sample areas on image&quot;));</a>
<a name="ln636">  gtk_label_set_ellipsize(GTK_LABEL(gtk_bin_get_child(GTK_BIN(data-&gt;display_samples_check_box))),</a>
<a name="ln637">                          PANGO_ELLIPSIZE_MIDDLE);</a>
<a name="ln638">  gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(data-&gt;display_samples_check_box),</a>
<a name="ln639">                               dt_conf_get_int(&quot;ui_last/colorpicker_display_samples&quot;));</a>
<a name="ln640">  gtk_box_pack_start(GTK_BOX(container), data-&gt;display_samples_check_box, TRUE, TRUE, 0);</a>
<a name="ln641"> </a>
<a name="ln642">  g_signal_connect(G_OBJECT(data-&gt;display_samples_check_box), &quot;toggled&quot;, G_CALLBACK(_display_samples_changed),</a>
<a name="ln643">                   NULL);</a>
<a name="ln644">}</a>
<a name="ln645"> </a>
<a name="ln646">void gui_cleanup(dt_lib_module_t *self)</a>
<a name="ln647">{</a>
<a name="ln648">  // Clearing proxy functions</a>
<a name="ln649">  darktable.lib-&gt;proxy.colorpicker.module = NULL;</a>
<a name="ln650">  darktable.lib-&gt;proxy.colorpicker.update_panel = NULL;</a>
<a name="ln651">  darktable.lib-&gt;proxy.colorpicker.update_samples = NULL;</a>
<a name="ln652"> </a>
<a name="ln653">  darktable.lib-&gt;proxy.colorpicker.set_sample_area = NULL;</a>
<a name="ln654">  darktable.lib-&gt;proxy.colorpicker.set_sample_box_area = NULL;</a>
<a name="ln655"> </a>
<a name="ln656">  free(darktable.lib-&gt;proxy.colorpicker.picked_color_rgb_mean);</a>
<a name="ln657">  free(darktable.lib-&gt;proxy.colorpicker.picked_color_rgb_min);</a>
<a name="ln658">  free(darktable.lib-&gt;proxy.colorpicker.picked_color_rgb_max);</a>
<a name="ln659">  free(darktable.lib-&gt;proxy.colorpicker.picked_color_lab_mean);</a>
<a name="ln660">  free(darktable.lib-&gt;proxy.colorpicker.picked_color_lab_min);</a>
<a name="ln661">  free(darktable.lib-&gt;proxy.colorpicker.picked_color_lab_max);</a>
<a name="ln662">  darktable.lib-&gt;proxy.colorpicker.picked_color_rgb_mean</a>
<a name="ln663">      = darktable.lib-&gt;proxy.colorpicker.picked_color_rgb_min</a>
<a name="ln664">      = darktable.lib-&gt;proxy.colorpicker.picked_color_rgb_max = NULL;</a>
<a name="ln665">  darktable.lib-&gt;proxy.colorpicker.picked_color_lab_mean</a>
<a name="ln666">      = darktable.lib-&gt;proxy.colorpicker.picked_color_lab_min</a>
<a name="ln667">      = darktable.lib-&gt;proxy.colorpicker.picked_color_lab_max = NULL;</a>
<a name="ln668"> </a>
<a name="ln669"> </a>
<a name="ln670">  while(darktable.lib-&gt;proxy.colorpicker.live_samples)</a>
<a name="ln671">    _remove_sample(darktable.lib-&gt;proxy.colorpicker.live_samples-&gt;data);</a>
<a name="ln672"> </a>
<a name="ln673">  free(self-&gt;data);</a>
<a name="ln674">  self-&gt;data = NULL;</a>
<a name="ln675">}</a>
<a name="ln676"> </a>
<a name="ln677">void gui_reset(dt_lib_module_t *self)</a>
<a name="ln678">{</a>
<a name="ln679">  dt_lib_colorpicker_t *data = self-&gt;data;</a>
<a name="ln680"> </a>
<a name="ln681">  int i;</a>
<a name="ln682"> </a>
<a name="ln683">  // First turning off any active picking</a>
<a name="ln684">  gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(data-&gt;picker_button), FALSE);</a>
<a name="ln685"> </a>
<a name="ln686">  // Resetting the picked colors</a>
<a name="ln687">  for(i = 0; i &lt; 3; i++)</a>
<a name="ln688">  {</a>
<a name="ln689">    darktable.lib-&gt;proxy.colorpicker.picked_color_rgb_mean[i]</a>
<a name="ln690">        = darktable.lib-&gt;proxy.colorpicker.picked_color_rgb_min[i]</a>
<a name="ln691">        = darktable.lib-&gt;proxy.colorpicker.picked_color_rgb_max[i] = 0;</a>
<a name="ln692"> </a>
<a name="ln693">    darktable.lib-&gt;proxy.colorpicker.picked_color_lab_mean[i]</a>
<a name="ln694">        = darktable.lib-&gt;proxy.colorpicker.picked_color_lab_min[i]</a>
<a name="ln695">        = darktable.lib-&gt;proxy.colorpicker.picked_color_lab_max[i] = 0;</a>
<a name="ln696">  }</a>
<a name="ln697"> </a>
<a name="ln698">  data-&gt;from_proxy = FALSE;</a>
<a name="ln699"> </a>
<a name="ln700">  _update_picker_output(self);</a>
<a name="ln701"> </a>
<a name="ln702">  // Removing any live samples</a>
<a name="ln703">  while(darktable.lib-&gt;proxy.colorpicker.live_samples)</a>
<a name="ln704">    _remove_sample(darktable.lib-&gt;proxy.colorpicker.live_samples-&gt;data);</a>
<a name="ln705"> </a>
<a name="ln706">  // Resetting GUI elements</a>
<a name="ln707">  gtk_combo_box_set_active(GTK_COMBO_BOX(data-&gt;size_selector), 0);</a>
<a name="ln708">  gtk_combo_box_set_active(GTK_COMBO_BOX(data-&gt;statistic_selector), 0);</a>
<a name="ln709">  gtk_combo_box_set_active(GTK_COMBO_BOX(data-&gt;color_mode_selector), 0);</a>
<a name="ln710">  gtk_combo_box_set_active(GTK_COMBO_BOX(data-&gt;samples_mode_selector), 0);</a>
<a name="ln711">  gtk_combo_box_set_active(GTK_COMBO_BOX(data-&gt;samples_statistic_selector), 0);</a>
<a name="ln712">  gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(data-&gt;display_samples_check_box), FALSE);</a>
<a name="ln713">}</a>
<a name="ln714">// modelines: These editor modelines have been set for all relevant files by tools/update_modelines.sh</a>
<a name="ln715">// vim: shiftwidth=2 expandtab tabstop=2 cindent</a>
<a name="ln716">// kate: tab-indents: off; indent-width 2; replace-tabs on; indent-mode cstyle; remove-trailing-spaces modified;</a>

</code></pre>
<div class="balloon" rel="180"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v614/" target="_blank">V614</a> Potentially uninitialized buffer 'colstring' used. Consider checking the second actual argument of the 'gtk_label_set_label' function.</p></div>
<div class="balloon" rel="292"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v614/" target="_blank">V614</a> Potentially uninitialized buffer 'text' used. Consider checking the second actual argument of the 'gtk_label_set_text' function.</p></div>
<div class="balloon" rel="363"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v522/" target="_blank">V522</a> There might be dereferencing of a potential null pointer 'sample'. Check lines: 363, 357.</p></div>
<div class="balloon" rel="506"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v522/" target="_blank">V522</a> There might be dereferencing of a potential null pointer 'data'. Check lines: 506, 504.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
