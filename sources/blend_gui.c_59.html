
<html>
<head>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>
<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2">    This file is part of darktable,</a>
<a name="ln3">    copyright (c) 2009--2012 johannes hanika.</a>
<a name="ln4">    copyright (c) 2011 Henrik Andersson.</a>
<a name="ln5">    copyright (c) 2012--2013 Ulrich Pegelow</a>
<a name="ln6"> </a>
<a name="ln7">    darktable is free software: you can redistribute it and/or modify</a>
<a name="ln8">    it under the terms of the GNU General Public License as published by</a>
<a name="ln9">    the Free Software Foundation, either version 3 of the License, or</a>
<a name="ln10">    (at your option) any later version.</a>
<a name="ln11"> </a>
<a name="ln12">    darktable is distributed in the hope that it will be useful,</a>
<a name="ln13">    but WITHOUT ANY WARRANTY; without even the implied warranty of</a>
<a name="ln14">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</a>
<a name="ln15">    GNU General Public License for more details.</a>
<a name="ln16"> </a>
<a name="ln17">    You should have received a copy of the GNU General Public License</a>
<a name="ln18">    along with darktable.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</a>
<a name="ln19">*/</a>
<a name="ln20">#include &quot;develop/blend.h&quot;</a>
<a name="ln21">#include &quot;bauhaus/bauhaus.h&quot;</a>
<a name="ln22">#include &quot;common/debug.h&quot;</a>
<a name="ln23">#include &quot;common/dtpthread.h&quot;</a>
<a name="ln24">#include &quot;common/opencl.h&quot;</a>
<a name="ln25">#include &quot;control/control.h&quot;</a>
<a name="ln26">#include &quot;develop/develop.h&quot;</a>
<a name="ln27">#include &quot;develop/imageop.h&quot;</a>
<a name="ln28">#include &quot;develop/masks.h&quot;</a>
<a name="ln29">#include &quot;develop/tiling.h&quot;</a>
<a name="ln30">#include &quot;dtgtk/button.h&quot;</a>
<a name="ln31">#include &quot;dtgtk/gradientslider.h&quot;</a>
<a name="ln32">#include &quot;gui/accelerators.h&quot;</a>
<a name="ln33">#include &quot;gui/gtk.h&quot;</a>
<a name="ln34">#include &quot;gui/presets.h&quot;</a>
<a name="ln35"> </a>
<a name="ln36">#include &lt;assert.h&gt;</a>
<a name="ln37">#include &lt;gmodule.h&gt;</a>
<a name="ln38">#include &lt;math.h&gt;</a>
<a name="ln39">#include &lt;stdlib.h&gt;</a>
<a name="ln40">#include &lt;string.h&gt;</a>
<a name="ln41">#include &lt;strings.h&gt;</a>
<a name="ln42"> </a>
<a name="ln43">#define CLAMP_RANGE(x, y, z) (CLAMP(x, y, z))</a>
<a name="ln44">#define NEUTRAL_GRAY 0.5</a>
<a name="ln45"> </a>
<a name="ln46">typedef enum _iop_gui_blendif_channel_t</a>
<a name="ln47">{</a>
<a name="ln48">  ch_L = 0,</a>
<a name="ln49">  ch_a = 1,</a>
<a name="ln50">  ch_b = 2,</a>
<a name="ln51">  ch_gray = 0,</a>
<a name="ln52">  ch_red = 1,</a>
<a name="ln53">  ch_green = 2,</a>
<a name="ln54">  ch_blue = 3,</a>
<a name="ln55">  ch_max = 4</a>
<a name="ln56">} _iop_gui_blendif_channel_t;</a>
<a name="ln57"> </a>
<a name="ln58">typedef enum dt_gui_blendif_pickcolor_type_t</a>
<a name="ln59">{</a>
<a name="ln60">  DT_BLENDIF_PICK_NONE = 0,</a>
<a name="ln61">  DT_BLENDIF_PICK_COLORPICK = 1,</a>
<a name="ln62">  DT_BLENDIF_PICK_SET_VALUES = 2</a>
<a name="ln63">} dt_gui_blendif_pickcolor_type_t;</a>
<a name="ln64"> </a>
<a name="ln65"> </a>
<a name="ln66">static const dt_iop_gui_blendif_colorstop_t _gradient_L[]</a>
<a name="ln67">    = { { 0.0f, { 0, 0, 0, 1.0 } },</a>
<a name="ln68">        { 0.5f, { NEUTRAL_GRAY / 2, NEUTRAL_GRAY / 2, NEUTRAL_GRAY / 2, 1.0 } },</a>
<a name="ln69">        { 1.0f, { NEUTRAL_GRAY, NEUTRAL_GRAY, NEUTRAL_GRAY, 1.0 } } };</a>
<a name="ln70"> </a>
<a name="ln71">static const dt_iop_gui_blendif_colorstop_t _gradient_a[]</a>
<a name="ln72">    = { { 0.0f, { 0, 0.34 * NEUTRAL_GRAY * 2, 0.27 * NEUTRAL_GRAY * 2, 1.0 } },</a>
<a name="ln73">        { 0.5f, { NEUTRAL_GRAY, NEUTRAL_GRAY, NEUTRAL_GRAY, 1.0 } },</a>
<a name="ln74">        { 1.0f, { 0.53 * NEUTRAL_GRAY * 2, 0.08 * NEUTRAL_GRAY * 2, 0.28 * NEUTRAL_GRAY * 2, 1.0 } } };</a>
<a name="ln75"> </a>
<a name="ln76">static const dt_iop_gui_blendif_colorstop_t _gradient_b[]</a>
<a name="ln77">    = { { 0.0f, { 0, 0.27 * NEUTRAL_GRAY * 2, 0.58 * NEUTRAL_GRAY * 2, 1.0 } },</a>
<a name="ln78">        { 0.5f, { NEUTRAL_GRAY, NEUTRAL_GRAY, NEUTRAL_GRAY, 1.0 } },</a>
<a name="ln79">        { 1.0f, { 0.81 * NEUTRAL_GRAY * 2, 0.66 * NEUTRAL_GRAY * 2, 0, 1.0 } } };</a>
<a name="ln80"> </a>
<a name="ln81">static const dt_iop_gui_blendif_colorstop_t _gradient_gray[]</a>
<a name="ln82">    = { { 0.0f, { 0, 0, 0, 1.0 } },</a>
<a name="ln83">        { 0.5f, { NEUTRAL_GRAY / 2, NEUTRAL_GRAY / 2, NEUTRAL_GRAY / 2, 1.0 } },</a>
<a name="ln84">        { 1.0f, { NEUTRAL_GRAY, NEUTRAL_GRAY, NEUTRAL_GRAY, 1.0 } } };</a>
<a name="ln85"> </a>
<a name="ln86">static const dt_iop_gui_blendif_colorstop_t _gradient_red[] = { { 0.0f, { 0, 0, 0, 1.0 } },</a>
<a name="ln87">                                                                { 0.5f, { NEUTRAL_GRAY / 2, 0, 0, 1.0 } },</a>
<a name="ln88">                                                                { 1.0f, { NEUTRAL_GRAY, 0, 0, 1.0 } } };</a>
<a name="ln89"> </a>
<a name="ln90">static const dt_iop_gui_blendif_colorstop_t _gradient_green[] = { { 0.0f, { 0, 0, 0, 1.0 } },</a>
<a name="ln91">                                                                  { 0.5f, { 0, NEUTRAL_GRAY / 2, 0, 1.0 } },</a>
<a name="ln92">                                                                  { 1.0f, { 0, NEUTRAL_GRAY, 0, 1.0 } } };</a>
<a name="ln93"> </a>
<a name="ln94">static const dt_iop_gui_blendif_colorstop_t _gradient_blue[] = { { 0.0f, { 0, 0, 0, 1.0 } },</a>
<a name="ln95">                                                                 { 0.5f, { 0, 0, NEUTRAL_GRAY / 2, 1.0 } },</a>
<a name="ln96">                                                                 { 1.0f, { 0, 0, NEUTRAL_GRAY, 1.0 } } };</a>
<a name="ln97"> </a>
<a name="ln98">static const dt_iop_gui_blendif_colorstop_t _gradient_chroma[]</a>
<a name="ln99">    = { { 0.0f, { NEUTRAL_GRAY, NEUTRAL_GRAY, NEUTRAL_GRAY, 1.0 } },</a>
<a name="ln100">        { 0.5f, { NEUTRAL_GRAY, NEUTRAL_GRAY / 2, NEUTRAL_GRAY, 1.0 } },</a>
<a name="ln101">        { 1.0f, { NEUTRAL_GRAY, 0, NEUTRAL_GRAY, 1.0 } } };</a>
<a name="ln102"> </a>
<a name="ln103">static const dt_iop_gui_blendif_colorstop_t _gradient_hue[] = {</a>
<a name="ln104">  { 0.0f, { 1.00f * 1.5f * NEUTRAL_GRAY, 0.68f * 1.5f * NEUTRAL_GRAY, 0.78f * 1.5f * NEUTRAL_GRAY, 1.0 } },</a>
<a name="ln105">  { 0.166f, { 0.95f * 1.5f * NEUTRAL_GRAY, 0.73f * 1.5f * NEUTRAL_GRAY, 0.56f * 1.5f * NEUTRAL_GRAY, 1.0 } },</a>
<a name="ln106">  { 0.333f, { 0.71f * 1.5f * NEUTRAL_GRAY, 0.81f * 1.5f * NEUTRAL_GRAY, 0.55f * 1.5f * NEUTRAL_GRAY, 1.0 } },</a>
<a name="ln107">  { 0.500f, { 0.45f * 1.5f * NEUTRAL_GRAY, 0.85f * 1.5f * NEUTRAL_GRAY, 0.77f * 1.5f * NEUTRAL_GRAY, 1.0 } },</a>
<a name="ln108">  { 0.666f, { 0.49f * 1.5f * NEUTRAL_GRAY, 0.82f * 1.5f * NEUTRAL_GRAY, 1.00f * 1.5f * NEUTRAL_GRAY, 1.0 } },</a>
<a name="ln109">  { 0.833f, { 0.82f * 1.5f * NEUTRAL_GRAY, 0.74f * 1.5f * NEUTRAL_GRAY, 1.00f * 1.5f * NEUTRAL_GRAY, 1.0 } },</a>
<a name="ln110">  { 1.0f, { 1.00f * 1.5f * NEUTRAL_GRAY, 0.68f * 1.5f * NEUTRAL_GRAY, 0.78f * 1.5f * NEUTRAL_GRAY, 1.0 } }</a>
<a name="ln111">};</a>
<a name="ln112"> </a>
<a name="ln113">static const dt_iop_gui_blendif_colorstop_t _gradient_HUE[]</a>
<a name="ln114">    = { { 0.0f, { NEUTRAL_GRAY, 0, 0, 1.0 } },</a>
<a name="ln115">        { 0.166f, { NEUTRAL_GRAY, NEUTRAL_GRAY, 0, 1.0 } },</a>
<a name="ln116">        { 0.332f, { 0, NEUTRAL_GRAY, 0, 1.0 } },</a>
<a name="ln117">        { 0.498f, { 0, NEUTRAL_GRAY, NEUTRAL_GRAY, 1.0 } },</a>
<a name="ln118">        { 0.664f, { 0, 0, NEUTRAL_GRAY, 1.0 } },</a>
<a name="ln119">        { 0.830f, { NEUTRAL_GRAY, 0, NEUTRAL_GRAY, 1.0 } },</a>
<a name="ln120">        { 1.0f, { NEUTRAL_GRAY, 0, 0, 1.0 } } };</a>
<a name="ln121"> </a>
<a name="ln122">static void _blendif_scale(dt_iop_colorspace_type_t cst, const float *in, float *out,</a>
<a name="ln123">                           const dt_iop_order_iccprofile_info_t *work_profile)</a>
<a name="ln124">{</a>
<a name="ln125">  out[0] = out[1] = out[2] = out[3] = out[4] = out[5] = out[6] = out[7] = -1.0f;</a>
<a name="ln126"> </a>
<a name="ln127">  switch(cst)</a>
<a name="ln128">  {</a>
<a name="ln129">    case iop_cs_Lab:</a>
<a name="ln130">      out[0] = CLAMP_RANGE(in[0] / 100.0f, 0.0f, 1.0f);</a>
<a name="ln131">      out[1] = CLAMP_RANGE((in[1] + 128.0f) / 256.0f, 0.0f, 1.0f);</a>
<a name="ln132">      out[2] = CLAMP_RANGE((in[2] + 128.0f) / 256.0f, 0.0f, 1.0f);</a>
<a name="ln133">      break;</a>
<a name="ln134">    case iop_cs_rgb:</a>
<a name="ln135">      if(work_profile == NULL)</a>
<a name="ln136">        out[0] = CLAMP_RANGE(0.3f * in[0] + 0.59f * in[1] + 0.11f * in[2], 0.0f, 1.0f);</a>
<a name="ln137">      else</a>
<a name="ln138">        out[0] = CLAMP_RANGE(dt_ioppr_get_rgb_matrix_luminance(in, work_profile), 0.0f, 1.0f);</a>
<a name="ln139">      out[1] = CLAMP_RANGE(in[0], 0.0f, 1.0f);</a>
<a name="ln140">      out[2] = CLAMP_RANGE(in[1], 0.0f, 1.0f);</a>
<a name="ln141">      out[3] = CLAMP_RANGE(in[2], 0.0f, 1.0f);</a>
<a name="ln142">      break;</a>
<a name="ln143">    case iop_cs_LCh:</a>
<a name="ln144">      out[3] = CLAMP_RANGE(in[1] / (128.0f * sqrtf(2.0f)), 0.0f, 1.0f);</a>
<a name="ln145">      out[4] = CLAMP_RANGE(in[2], 0.0f, 1.0f);</a>
<a name="ln146">      break;</a>
<a name="ln147">    case iop_cs_HSL:</a>
<a name="ln148">      out[4] = CLAMP_RANGE(in[0], 0.0f, 1.0f);</a>
<a name="ln149">      out[5] = CLAMP_RANGE(in[1], 0.0f, 1.0f);</a>
<a name="ln150">      out[6] = CLAMP_RANGE(in[2], 0.0f, 1.0f);</a>
<a name="ln151">      out[7] = -1;</a>
<a name="ln152">      break;</a>
<a name="ln153">    default:</a>
<a name="ln154">      out[0] = out[1] = out[2] = out[3] = out[4] = out[5] = out[6] = out[7] = -1.0f;</a>
<a name="ln155">  }</a>
<a name="ln156">}</a>
<a name="ln157"> </a>
<a name="ln158">static void _blendif_cook(dt_iop_colorspace_type_t cst, const float *in, float *out,</a>
<a name="ln159">                          const dt_iop_order_iccprofile_info_t *const work_profile)</a>
<a name="ln160">{</a>
<a name="ln161">  out[0] = out[1] = out[2] = out[3] = out[4] = out[5] = out[6] = out[7] = -1.0f;</a>
<a name="ln162"> </a>
<a name="ln163">  switch(cst)</a>
<a name="ln164">  {</a>
<a name="ln165">    case iop_cs_Lab:</a>
<a name="ln166">      out[0] = in[0];</a>
<a name="ln167">      out[1] = in[1];</a>
<a name="ln168">      out[2] = in[2];</a>
<a name="ln169">      break;</a>
<a name="ln170">    case iop_cs_rgb:</a>
<a name="ln171">      if(work_profile == NULL)</a>
<a name="ln172">        out[0] = (0.3f * in[0] + 0.59f * in[1] + 0.11f * in[2]) * 255.0f;</a>
<a name="ln173">      else</a>
<a name="ln174">        out[0] = dt_ioppr_get_rgb_matrix_luminance(in, work_profile) * 255.0f;</a>
<a name="ln175">      out[1] = in[0] * 255.0f;</a>
<a name="ln176">      out[2] = in[1] * 255.0f;</a>
<a name="ln177">      out[3] = in[2] * 255.0f;</a>
<a name="ln178">      break;</a>
<a name="ln179">    case iop_cs_LCh:</a>
<a name="ln180">      out[3] = in[1] / (128.0f * sqrtf(2.0f)) * 100.0f;</a>
<a name="ln181">      out[4] = in[2] * 360.0f;</a>
<a name="ln182">      break;</a>
<a name="ln183">    case iop_cs_HSL:</a>
<a name="ln184">      out[4] = in[0] * 360.0f;</a>
<a name="ln185">      out[5] = in[1] * 100.0f;</a>
<a name="ln186">      out[6] = in[2] * 100.0f;</a>
<a name="ln187">      break;</a>
<a name="ln188">    default:</a>
<a name="ln189">      out[0] = out[1] = out[2] = out[3] = out[4] = out[5] = out[6] = out[7] = -1.0f;</a>
<a name="ln190">  }</a>
<a name="ln191">}</a>
<a name="ln192"> </a>
<a name="ln193"> </a>
<a name="ln194">static void _blendif_scale_print_L(float value, char *string, int n)</a>
<a name="ln195">{</a>
<a name="ln196">  snprintf(string, n, &quot;%-4.0f&quot;, value * 100.0f);</a>
<a name="ln197">}</a>
<a name="ln198"> </a>
<a name="ln199">static void _blendif_scale_print_ab(float value, char *string, int n)</a>
<a name="ln200">{</a>
<a name="ln201">  snprintf(string, n, &quot;%-4.0f&quot;, value * 256.0f - 128.0f);</a>
<a name="ln202">}</a>
<a name="ln203"> </a>
<a name="ln204">static void _blendif_scale_print_rgb(float value, char *string, int n)</a>
<a name="ln205">{</a>
<a name="ln206">  snprintf(string, n, &quot;%-4.0f&quot;, value * 255.0f);</a>
<a name="ln207">}</a>
<a name="ln208"> </a>
<a name="ln209">static void _blendif_scale_print_hue(float value, char *string, int n)</a>
<a name="ln210">{</a>
<a name="ln211">  snprintf(string, n, &quot;%-4.0f&quot;, value * 360.0f);</a>
<a name="ln212">}</a>
<a name="ln213"> </a>
<a name="ln214">static void _blendif_scale_print_default(float value, char *string, int n)</a>
<a name="ln215">{</a>
<a name="ln216">  snprintf(string, n, &quot;%-4.0f&quot;, value * 100.0f);</a>
<a name="ln217">}</a>
<a name="ln218"> </a>
<a name="ln219">static void _blendop_masks_mode_callback(const unsigned int mask_mode, dt_iop_gui_blend_data_t *data)</a>
<a name="ln220">{</a>
<a name="ln221">  data-&gt;module-&gt;blend_params-&gt;mask_mode = mask_mode;</a>
<a name="ln222"> </a>
<a name="ln223">  if(mask_mode &amp; DEVELOP_MASK_ENABLED)</a>
<a name="ln224">  {</a>
<a name="ln225">    gtk_widget_show(GTK_WIDGET(data-&gt;top_box));</a>
<a name="ln226">  }</a>
<a name="ln227">  else</a>
<a name="ln228">  {</a>
<a name="ln229">    gtk_widget_hide(GTK_WIDGET(data-&gt;top_box));</a>
<a name="ln230">  }</a>
<a name="ln231"> </a>
<a name="ln232">  dt_iop_set_mask_mode(data-&gt;module, mask_mode);</a>
<a name="ln233"> </a>
<a name="ln234">  if((mask_mode &amp; DEVELOP_MASK_ENABLED)</a>
<a name="ln235">     &amp;&amp; ((data-&gt;masks_inited &amp;&amp; (mask_mode &amp; DEVELOP_MASK_MASK))</a>
<a name="ln236">         || (data-&gt;blendif_inited &amp;&amp; (mask_mode &amp; DEVELOP_MASK_CONDITIONAL))))</a>
<a name="ln237">  {</a>
<a name="ln238">    if(data-&gt;blendif_inited &amp;&amp; (mask_mode &amp; DEVELOP_MASK_CONDITIONAL))</a>
<a name="ln239">    {</a>
<a name="ln240">      dt_bauhaus_combobox_set(data-&gt;masks_combine_combo,</a>
<a name="ln241">                              g_list_index(data-&gt;masks_combine,</a>
<a name="ln242">                                           GUINT_TO_POINTER(data-&gt;module-&gt;blend_params-&gt;mask_combine</a>
<a name="ln243">                                                            &amp; (DEVELOP_COMBINE_INV | DEVELOP_COMBINE_INCL))));</a>
<a name="ln244">      gtk_widget_hide(GTK_WIDGET(data-&gt;masks_invert_combo));</a>
<a name="ln245">      gtk_widget_show(GTK_WIDGET(data-&gt;masks_combine_combo));</a>
<a name="ln246">    }</a>
<a name="ln247">    else</a>
<a name="ln248">    {</a>
<a name="ln249">      dt_bauhaus_combobox_set(</a>
<a name="ln250">          data-&gt;masks_invert_combo,</a>
<a name="ln251">          g_list_index(data-&gt;masks_invert,</a>
<a name="ln252">                       GUINT_TO_POINTER(data-&gt;module-&gt;blend_params-&gt;mask_combine &amp; DEVELOP_COMBINE_INV)));</a>
<a name="ln253">      gtk_widget_show(GTK_WIDGET(data-&gt;masks_invert_combo));</a>
<a name="ln254">      gtk_widget_hide(GTK_WIDGET(data-&gt;masks_combine_combo));</a>
<a name="ln255">    }</a>
<a name="ln256"> </a>
<a name="ln257">    /*</a>
<a name="ln258">     * if this iop is operating in raw space, it has only 1 channel per pixel,</a>
<a name="ln259">     * thus there is no alpha channel where we would normally store mask</a>
<a name="ln260">     * that would get displayed if following button have been pressed.</a>
<a name="ln261">     *</a>
<a name="ln262">     * TODO: revisit if/once there semi-raw iops (e.g temperature) with blending</a>
<a name="ln263">     */</a>
<a name="ln264">    if(data-&gt;module-&gt;blend_colorspace(data-&gt;module, NULL, NULL) == iop_cs_RAW)</a>
<a name="ln265">    {</a>
<a name="ln266">      data-&gt;module-&gt;request_mask_display = DT_DEV_PIXELPIPE_DISPLAY_NONE;</a>
<a name="ln267">      dtgtk_button_set_active(DTGTK_BUTTON(data-&gt;showmask), 0);</a>
<a name="ln268">      gtk_widget_hide(GTK_WIDGET(data-&gt;showmask));</a>
<a name="ln269"> </a>
<a name="ln270">      // disable also guided-filters on RAW based color space</a>
<a name="ln271">      gtk_widget_set_sensitive(data-&gt;masks_feathering_guide_combo, 0);</a>
<a name="ln272">      gtk_widget_hide(GTK_WIDGET(data-&gt;masks_feathering_guide_combo));</a>
<a name="ln273">      gtk_widget_set_sensitive(data-&gt;feathering_radius_slider, 0);</a>
<a name="ln274">      gtk_widget_hide(GTK_WIDGET(data-&gt;feathering_radius_slider));</a>
<a name="ln275">      gtk_widget_set_sensitive(data-&gt;brightness_slider, 0);</a>
<a name="ln276">      gtk_widget_hide(GTK_WIDGET(data-&gt;brightness_slider));</a>
<a name="ln277">      gtk_widget_set_sensitive(data-&gt;contrast_slider, 0);</a>
<a name="ln278">      gtk_widget_hide(GTK_WIDGET(data-&gt;contrast_slider));</a>
<a name="ln279">    }</a>
<a name="ln280">    else</a>
<a name="ln281">    {</a>
<a name="ln282">      gtk_widget_show(GTK_WIDGET(data-&gt;showmask));</a>
<a name="ln283">    }</a>
<a name="ln284"> </a>
<a name="ln285">    gtk_widget_show(GTK_WIDGET(data-&gt;bottom_box));</a>
<a name="ln286">  }</a>
<a name="ln287">  else</a>
<a name="ln288">  {</a>
<a name="ln289">    data-&gt;module-&gt;request_mask_display = DT_DEV_PIXELPIPE_DISPLAY_NONE;</a>
<a name="ln290">    dtgtk_button_set_active(DTGTK_BUTTON(data-&gt;showmask), 0);</a>
<a name="ln291">    data-&gt;module-&gt;suppress_mask = 0;</a>
<a name="ln292">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(data-&gt;suppress), 0);</a>
<a name="ln293"> </a>
<a name="ln294">    gtk_widget_hide(GTK_WIDGET(data-&gt;bottom_box));</a>
<a name="ln295">  }</a>
<a name="ln296"> </a>
<a name="ln297">  if(data-&gt;masks_inited &amp;&amp; (mask_mode &amp; DEVELOP_MASK_MASK))</a>
<a name="ln298">  {</a>
<a name="ln299">    gtk_widget_show(GTK_WIDGET(data-&gt;masks_box));</a>
<a name="ln300">  }</a>
<a name="ln301">  else if(data-&gt;masks_inited)</a>
<a name="ln302">  {</a>
<a name="ln303">    dt_masks_set_edit_mode(data-&gt;module, DT_MASKS_EDIT_OFF);</a>
<a name="ln304">    gtk_widget_hide(GTK_WIDGET(data-&gt;masks_box));</a>
<a name="ln305">  }</a>
<a name="ln306">  else</a>
<a name="ln307">  {</a>
<a name="ln308">    gtk_widget_hide(GTK_WIDGET(data-&gt;masks_box));</a>
<a name="ln309">  }</a>
<a name="ln310"> </a>
<a name="ln311">  if(data-&gt;raster_inited &amp;&amp; (mask_mode &amp; DEVELOP_MASK_RASTER))</a>
<a name="ln312">  {</a>
<a name="ln313">    gtk_widget_show(GTK_WIDGET(data-&gt;raster_box));</a>
<a name="ln314">  }</a>
<a name="ln315">  else if(data-&gt;raster_inited)</a>
<a name="ln316">  {</a>
<a name="ln317">//     dt_masks_set_edit_mode(data-&gt;module, DT_MASKS_EDIT_OFF);</a>
<a name="ln318">    gtk_widget_hide(GTK_WIDGET(data-&gt;raster_box));</a>
<a name="ln319">  }</a>
<a name="ln320">  else</a>
<a name="ln321">  {</a>
<a name="ln322">    gtk_widget_hide(GTK_WIDGET(data-&gt;raster_box));</a>
<a name="ln323">  }</a>
<a name="ln324"> </a>
<a name="ln325">  if(data-&gt;blendif_inited &amp;&amp; (mask_mode &amp; DEVELOP_MASK_CONDITIONAL))</a>
<a name="ln326">  {</a>
<a name="ln327">    gtk_widget_show(GTK_WIDGET(data-&gt;blendif_box));</a>
<a name="ln328">  }</a>
<a name="ln329">  else if(data-&gt;blendif_inited)</a>
<a name="ln330">  {</a>
<a name="ln331">    /* switch off color picker */</a>
<a name="ln332">    dt_iop_color_picker_reset(data-&gt;module, TRUE);</a>
<a name="ln333"> </a>
<a name="ln334">    gtk_widget_hide(GTK_WIDGET(data-&gt;blendif_box));</a>
<a name="ln335">  }</a>
<a name="ln336">  else</a>
<a name="ln337">  {</a>
<a name="ln338">    gtk_widget_hide(GTK_WIDGET(data-&gt;blendif_box));</a>
<a name="ln339">  }</a>
<a name="ln340"> </a>
<a name="ln341">  dt_dev_add_history_item(darktable.develop, data-&gt;module, TRUE);</a>
<a name="ln342">}</a>
<a name="ln343"> </a>
<a name="ln344"> </a>
<a name="ln345">static void _blendop_blend_mode_callback(GtkWidget *combo, dt_iop_gui_blend_data_t *data)</a>
<a name="ln346">{</a>
<a name="ln347">  data-&gt;module-&gt;blend_params-&gt;blend_mode = GPOINTER_TO_UINT(</a>
<a name="ln348">      g_list_nth_data(data-&gt;blend_modes, dt_bauhaus_combobox_get(data-&gt;blend_modes_combo)));</a>
<a name="ln349">  dt_dev_add_history_item(darktable.develop, data-&gt;module, TRUE);</a>
<a name="ln350">}</a>
<a name="ln351"> </a>
<a name="ln352">static void _blendop_masks_combine_callback(GtkWidget *combo, dt_iop_gui_blend_data_t *data)</a>
<a name="ln353">{</a>
<a name="ln354">  const unsigned combine = GPOINTER_TO_UINT(</a>
<a name="ln355">      g_list_nth_data(data-&gt;masks_combine, dt_bauhaus_combobox_get(data-&gt;masks_combine_combo)));</a>
<a name="ln356">  data-&gt;module-&gt;blend_params-&gt;mask_combine &amp;= ~(DEVELOP_COMBINE_INV | DEVELOP_COMBINE_INCL);</a>
<a name="ln357">  data-&gt;module-&gt;blend_params-&gt;mask_combine |= combine;</a>
<a name="ln358">  dt_dev_add_history_item(darktable.develop, data-&gt;module, TRUE);</a>
<a name="ln359">}</a>
<a name="ln360"> </a>
<a name="ln361">static void _blendop_masks_invert_callback(GtkWidget *combo, dt_iop_gui_blend_data_t *data)</a>
<a name="ln362">{</a>
<a name="ln363">  unsigned int invert = GPOINTER_TO_UINT(g_list_nth_data(data-&gt;masks_invert,</a>
<a name="ln364">                                                         dt_bauhaus_combobox_get(data-&gt;masks_invert_combo)))</a>
<a name="ln365">                        &amp; DEVELOP_COMBINE_INV;</a>
<a name="ln366">  if(invert)</a>
<a name="ln367">    data-&gt;module-&gt;blend_params-&gt;mask_combine |= DEVELOP_COMBINE_INV;</a>
<a name="ln368">  else</a>
<a name="ln369">    data-&gt;module-&gt;blend_params-&gt;mask_combine &amp;= ~DEVELOP_COMBINE_INV;</a>
<a name="ln370">  dt_dev_add_history_item(darktable.develop, data-&gt;module, TRUE);</a>
<a name="ln371">}</a>
<a name="ln372"> </a>
<a name="ln373">static void _blendop_opacity_callback(GtkWidget *slider, dt_iop_gui_blend_data_t *data)</a>
<a name="ln374">{</a>
<a name="ln375">  data-&gt;module-&gt;blend_params-&gt;opacity = dt_bauhaus_slider_get(slider);</a>
<a name="ln376">  dt_dev_add_history_item(darktable.develop, data-&gt;module, TRUE);</a>
<a name="ln377">}</a>
<a name="ln378"> </a>
<a name="ln379">static void _blendop_blendif_feathering_radius_callback(GtkWidget *slider, dt_iop_gui_blend_data_t *data)</a>
<a name="ln380">{</a>
<a name="ln381">  data-&gt;module-&gt;blend_params-&gt;feathering_radius = dt_bauhaus_slider_get(slider);</a>
<a name="ln382">  dt_dev_add_history_item(darktable.develop, data-&gt;module, TRUE);</a>
<a name="ln383">}</a>
<a name="ln384"> </a>
<a name="ln385">static void _blendop_masks_feathering_guide_callback(GtkWidget *combo, dt_iop_gui_blend_data_t *data)</a>
<a name="ln386">{</a>
<a name="ln387">  data-&gt;module-&gt;blend_params-&gt;feathering_guide = GPOINTER_TO_UINT(</a>
<a name="ln388">      g_list_nth_data(data-&gt;masks_feathering_guide, dt_bauhaus_combobox_get(data-&gt;masks_feathering_guide_combo)));</a>
<a name="ln389">  dt_dev_add_history_item(darktable.develop, data-&gt;module, TRUE);</a>
<a name="ln390">}</a>
<a name="ln391"> </a>
<a name="ln392">static void _blendop_blendif_blur_radius_callback(GtkWidget *slider, dt_iop_gui_blend_data_t *data)</a>
<a name="ln393">{</a>
<a name="ln394">  data-&gt;module-&gt;blend_params-&gt;blur_radius = dt_bauhaus_slider_get(slider);</a>
<a name="ln395">  dt_dev_add_history_item(darktable.develop, data-&gt;module, TRUE);</a>
<a name="ln396">}</a>
<a name="ln397"> </a>
<a name="ln398">static void _blendop_blendif_brightness_callback(GtkWidget *slider, dt_iop_gui_blend_data_t *data)</a>
<a name="ln399">{</a>
<a name="ln400">  data-&gt;module-&gt;blend_params-&gt;brightness = dt_bauhaus_slider_get(slider);</a>
<a name="ln401">  dt_dev_add_history_item(darktable.develop, data-&gt;module, TRUE);</a>
<a name="ln402">}</a>
<a name="ln403"> </a>
<a name="ln404">static void _blendop_blendif_contrast_callback(GtkWidget *slider, dt_iop_gui_blend_data_t *data)</a>
<a name="ln405">{</a>
<a name="ln406">  data-&gt;module-&gt;blend_params-&gt;contrast = dt_bauhaus_slider_get(slider);</a>
<a name="ln407">  dt_dev_add_history_item(darktable.develop, data-&gt;module, TRUE);</a>
<a name="ln408">}</a>
<a name="ln409"> </a>
<a name="ln410">static void _blendop_blendif_reset_picker_set_values(dt_iop_gui_blend_data_t *data)</a>
<a name="ln411">{</a>
<a name="ln412">  if(data-&gt;color_picker.current_picker == DT_BLENDIF_PICK_SET_VALUES)</a>
<a name="ln413">    dt_iop_color_picker_reset(data-&gt;module, TRUE);</a>
<a name="ln414">}</a>
<a name="ln415"> </a>
<a name="ln416">static void _blendop_blendif_upper_callback(GtkDarktableGradientSlider *slider, dt_iop_gui_blend_data_t *data)</a>
<a name="ln417">{</a>
<a name="ln418">  if(darktable.gui-&gt;reset) return;</a>
<a name="ln419">  dt_develop_blend_params_t *bp = data-&gt;module-&gt;blend_params;</a>
<a name="ln420"> </a>
<a name="ln421">  int tab = data-&gt;tab;</a>
<a name="ln422">  int ch = data-&gt;channels[tab][1];</a>
<a name="ln423"> </a>
<a name="ln424">  float *parameters = &amp;(bp-&gt;blendif_parameters[4 * ch]);</a>
<a name="ln425"> </a>
<a name="ln426">  _blendop_blendif_reset_picker_set_values(data);</a>
<a name="ln427"> </a>
<a name="ln428">  for(int k = 0; k &lt; 4; k++) parameters[k] = dtgtk_gradient_slider_multivalue_get_value(slider, k);</a>
<a name="ln429"> </a>
<a name="ln430">  for(int k = 0; k &lt; 4; k++)</a>
<a name="ln431">  {</a>
<a name="ln432">    char text[256];</a>
<a name="ln433">    (data-&gt;scale_print[tab])(parameters[k], text, sizeof(text));</a>
<a name="ln434">    gtk_label_set_text(data-&gt;upper_label[k], text);</a>
<a name="ln435">  }</a>
<a name="ln436"> </a>
<a name="ln437">  /** de-activate processing of this channel if maximum span is selected */</a>
<a name="ln438">  if(parameters[1] == 0.0f &amp;&amp; parameters[2] == 1.0f)</a>
<a name="ln439">    bp-&gt;blendif &amp;= ~(1 &lt;&lt; ch);</a>
<a name="ln440">  else</a>
<a name="ln441">    bp-&gt;blendif |= (1 &lt;&lt; ch);</a>
<a name="ln442"> </a>
<a name="ln443">  dt_dev_add_history_item(darktable.develop, data-&gt;module, TRUE);</a>
<a name="ln444">}</a>
<a name="ln445"> </a>
<a name="ln446"> </a>
<a name="ln447">static void _blendop_blendif_lower_callback(GtkDarktableGradientSlider *slider, dt_iop_gui_blend_data_t *data)</a>
<a name="ln448">{</a>
<a name="ln449">  if(darktable.gui-&gt;reset) return;</a>
<a name="ln450">  dt_develop_blend_params_t *bp = data-&gt;module-&gt;blend_params;</a>
<a name="ln451"> </a>
<a name="ln452">  int tab = data-&gt;tab;</a>
<a name="ln453">  int ch = data-&gt;channels[tab][0];</a>
<a name="ln454"> </a>
<a name="ln455">  float *parameters = &amp;(bp-&gt;blendif_parameters[4 * ch]);</a>
<a name="ln456"> </a>
<a name="ln457">  _blendop_blendif_reset_picker_set_values(data);</a>
<a name="ln458"> </a>
<a name="ln459">  for(int k = 0; k &lt; 4; k++) parameters[k] = dtgtk_gradient_slider_multivalue_get_value(slider, k);</a>
<a name="ln460"> </a>
<a name="ln461">  for(int k = 0; k &lt; 4; k++)</a>
<a name="ln462">  {</a>
<a name="ln463">    char text[256];</a>
<a name="ln464">    (data-&gt;scale_print[tab])(parameters[k], text, sizeof(text));</a>
<a name="ln465">    gtk_label_set_text(data-&gt;lower_label[k], text);</a>
<a name="ln466">  }</a>
<a name="ln467"> </a>
<a name="ln468">  /** de-activate processing of this channel if maximum span is selected */</a>
<a name="ln469">  if(parameters[1] == 0.0f &amp;&amp; parameters[2] == 1.0f)</a>
<a name="ln470">    bp-&gt;blendif &amp;= ~(1 &lt;&lt; ch);</a>
<a name="ln471">  else</a>
<a name="ln472">    bp-&gt;blendif |= (1 &lt;&lt; ch);</a>
<a name="ln473"> </a>
<a name="ln474">  dt_dev_add_history_item(darktable.develop, data-&gt;module, TRUE);</a>
<a name="ln475">}</a>
<a name="ln476"> </a>
<a name="ln477"> </a>
<a name="ln478">static void _blendop_blendif_polarity_callback(GtkToggleButton *togglebutton, dt_iop_gui_blend_data_t *data)</a>
<a name="ln479">{</a>
<a name="ln480">  int active = gtk_toggle_button_get_active(togglebutton);</a>
<a name="ln481">  if(darktable.gui-&gt;reset) return;</a>
<a name="ln482">  dt_develop_blend_params_t *bp = data-&gt;module-&gt;blend_params;</a>
<a name="ln483"> </a>
<a name="ln484">  int tab = data-&gt;tab;</a>
<a name="ln485">  int ch = GTK_WIDGET(togglebutton) == data-&gt;lower_polarity ? data-&gt;channels[tab][0] : data-&gt;channels[tab][1];</a>
<a name="ln486">  GtkDarktableGradientSlider *slider = GTK_WIDGET(togglebutton) == data-&gt;lower_polarity ? data-&gt;lower_slider</a>
<a name="ln487">                                                                                        : data-&gt;upper_slider;</a>
<a name="ln488"> </a>
<a name="ln489">  if(!active)</a>
<a name="ln490">    bp-&gt;blendif |= (1 &lt;&lt; (ch + 16));</a>
<a name="ln491">  else</a>
<a name="ln492">    bp-&gt;blendif &amp;= ~(1 &lt;&lt; (ch + 16));</a>
<a name="ln493"> </a>
<a name="ln494">  dtgtk_gradient_slider_multivalue_set_marker(</a>
<a name="ln495">      slider, active ? GRADIENT_SLIDER_MARKER_LOWER_OPEN_BIG : GRADIENT_SLIDER_MARKER_UPPER_OPEN_BIG, 0);</a>
<a name="ln496">  dtgtk_gradient_slider_multivalue_set_marker(</a>
<a name="ln497">      slider, active ? GRADIENT_SLIDER_MARKER_UPPER_FILLED_BIG : GRADIENT_SLIDER_MARKER_LOWER_FILLED_BIG, 1);</a>
<a name="ln498">  dtgtk_gradient_slider_multivalue_set_marker(</a>
<a name="ln499">      slider, active ? GRADIENT_SLIDER_MARKER_UPPER_FILLED_BIG : GRADIENT_SLIDER_MARKER_LOWER_FILLED_BIG, 2);</a>
<a name="ln500">  dtgtk_gradient_slider_multivalue_set_marker(</a>
<a name="ln501">      slider, active ? GRADIENT_SLIDER_MARKER_LOWER_OPEN_BIG : GRADIENT_SLIDER_MARKER_UPPER_OPEN_BIG, 3);</a>
<a name="ln502"> </a>
<a name="ln503">  dt_dev_add_history_item(darktable.develop, data-&gt;module, TRUE);</a>
<a name="ln504">}</a>
<a name="ln505"> </a>
<a name="ln506">static dt_iop_colorspace_type_t _blendop_blendif_get_picker_colorspace(dt_iop_gui_blend_data_t *bd)</a>
<a name="ln507">{</a>
<a name="ln508">  dt_iop_colorspace_type_t picker_cst = -1;</a>
<a name="ln509"> </a>
<a name="ln510">  if(bd-&gt;csp == iop_cs_rgb)</a>
<a name="ln511">  {</a>
<a name="ln512">    if(bd-&gt;tab &lt; 4)</a>
<a name="ln513">      picker_cst = iop_cs_rgb;</a>
<a name="ln514">    else</a>
<a name="ln515">      picker_cst = iop_cs_HSL;</a>
<a name="ln516">  }</a>
<a name="ln517">  else if(bd-&gt;csp == iop_cs_Lab)</a>
<a name="ln518">  {</a>
<a name="ln519">    if(bd-&gt;tab &lt; 3)</a>
<a name="ln520">      picker_cst = iop_cs_Lab;</a>
<a name="ln521">    else</a>
<a name="ln522">      picker_cst = iop_cs_LCh;</a>
<a name="ln523">  }</a>
<a name="ln524"> </a>
<a name="ln525">  return picker_cst;</a>
<a name="ln526">}</a>
<a name="ln527"> </a>
<a name="ln528">static void _update_gradient_slider(GtkWidget *widget, dt_iop_module_t *module)</a>
<a name="ln529">{</a>
<a name="ln530">  dt_iop_gui_blend_data_t *data = module-&gt;blend_data;</a>
<a name="ln531">  float picker_mean[8], picker_min[8], picker_max[8];</a>
<a name="ln532">  float cooked[8];</a>
<a name="ln533">  float *raw_mean, *raw_min, *raw_max;</a>
<a name="ln534">  char text[256];</a>
<a name="ln535">  GtkLabel *label;</a>
<a name="ln536"> </a>
<a name="ln537">  if(widget == GTK_WIDGET(data-&gt;lower_slider))</a>
<a name="ln538">  {</a>
<a name="ln539">    raw_mean = module-&gt;picked_color;</a>
<a name="ln540">    raw_min = module-&gt;picked_color_min;</a>
<a name="ln541">    raw_max = module-&gt;picked_color_max;</a>
<a name="ln542">    label = data-&gt;lower_picker_label;</a>
<a name="ln543">  }</a>
<a name="ln544">  else</a>
<a name="ln545">  {</a>
<a name="ln546">    raw_mean = module-&gt;picked_output_color;</a>
<a name="ln547">    raw_min = module-&gt;picked_output_color_min;</a>
<a name="ln548">    raw_max = module-&gt;picked_output_color_max;</a>
<a name="ln549">    label = data-&gt;upper_picker_label;</a>
<a name="ln550">  }</a>
<a name="ln551"> </a>
<a name="ln552">  const int reset = darktable.gui-&gt;reset;</a>
<a name="ln553">  darktable.gui-&gt;reset = 1;</a>
<a name="ln554">  if((module-&gt;request_color_pick == DT_REQUEST_COLORPICK_BLEND) &amp;&amp; (raw_min[0] != INFINITY))</a>
<a name="ln555">  {</a>
<a name="ln556">    const int cst = (dt_iop_color_picker_get_active_cst(module) == iop_cs_NONE)</a>
<a name="ln557">                        ? data-&gt;csp</a>
<a name="ln558">                        : dt_iop_color_picker_get_active_cst(module);</a>
<a name="ln559">    const dt_iop_order_iccprofile_info_t *work_profile</a>
<a name="ln560">        = dt_ioppr_get_iop_work_profile_info(module, module-&gt;dev-&gt;iop);</a>
<a name="ln561">    _blendif_scale(cst, raw_mean, picker_mean, work_profile);</a>
<a name="ln562">    _blendif_scale(cst, raw_min, picker_min, work_profile);</a>
<a name="ln563">    _blendif_scale(cst, raw_max, picker_max, work_profile);</a>
<a name="ln564">    _blendif_cook(cst, raw_mean, cooked, work_profile);</a>
<a name="ln565"> </a>
<a name="ln566">    snprintf(text, sizeof(text), &quot;(%.1f)&quot;, cooked[data-&gt;tab]);</a>
<a name="ln567"> </a>
<a name="ln568">    dtgtk_gradient_slider_multivalue_set_picker_meanminmax(</a>
<a name="ln569">        DTGTK_GRADIENT_SLIDER(widget), picker_mean[data-&gt;tab], picker_min[data-&gt;tab], picker_max[data-&gt;tab]);</a>
<a name="ln570">    gtk_label_set_text(label, text);</a>
<a name="ln571">  }</a>
<a name="ln572">  else</a>
<a name="ln573">  {</a>
<a name="ln574">    dtgtk_gradient_slider_multivalue_set_picker(DTGTK_GRADIENT_SLIDER(widget), NAN);</a>
<a name="ln575">    gtk_label_set_text(label, &quot;&quot;);</a>
<a name="ln576">  }</a>
<a name="ln577"> </a>
<a name="ln578">  darktable.gui-&gt;reset = reset;</a>
<a name="ln579">}</a>
<a name="ln580"> </a>
<a name="ln581">static gboolean _blendop_blendif_draw(GtkWidget *widget, cairo_t *cr, dt_iop_module_t *module)</a>
<a name="ln582">{</a>
<a name="ln583">  if(darktable.gui-&gt;reset) return FALSE;</a>
<a name="ln584"> </a>
<a name="ln585">  _update_gradient_slider(widget, module);</a>
<a name="ln586"> </a>
<a name="ln587">  return FALSE;</a>
<a name="ln588">}</a>
<a name="ln589"> </a>
<a name="ln590">static void _blendop_blendif_tab_switch(GtkNotebook *notebook, GtkWidget *page, guint page_num,</a>
<a name="ln591">                                        dt_iop_gui_blend_data_t *data)</a>
<a name="ln592">{</a>
<a name="ln593">  const int cst_old = _blendop_blendif_get_picker_colorspace(data);</a>
<a name="ln594"> </a>
<a name="ln595">  data-&gt;tab = page_num;</a>
<a name="ln596"> </a>
<a name="ln597">  if(data-&gt;module-&gt;request_color_pick == DT_REQUEST_COLORPICK_BLEND &amp;&amp;</a>
<a name="ln598">      (cst_old != _blendop_blendif_get_picker_colorspace(data) || data-&gt;color_picker.current_picker == DT_BLENDIF_PICK_SET_VALUES))</a>
<a name="ln599">  {</a>
<a name="ln600">    dt_iop_color_picker_set_cst(&amp;data-&gt;color_picker, _blendop_blendif_get_picker_colorspace(data));</a>
<a name="ln601">    dt_dev_reprocess_all(data-&gt;module-&gt;dev);</a>
<a name="ln602">    dt_control_queue_redraw();</a>
<a name="ln603">  }</a>
<a name="ln604"> </a>
<a name="ln605">  dt_iop_gui_update_blendif(data-&gt;module);</a>
<a name="ln606">}</a>
<a name="ln607"> </a>
<a name="ln608">static void _blendop_blendif_showmask_clicked(GtkWidget *button, GdkEventButton *event, dt_iop_module_t *module)</a>
<a name="ln609">{</a>
<a name="ln610">  if(darktable.gui-&gt;reset) return;</a>
<a name="ln611"> </a>
<a name="ln612">  // if blendif is bypassed don't allow to set this button on</a>
<a name="ln613">  if(module-&gt;bypass_blendif)</a>
<a name="ln614">  {</a>
<a name="ln615">    dt_control_log(_(&quot;display mask is currently disabled by another module&quot;));</a>
<a name="ln616"> </a>
<a name="ln617">    if(darktable.gui-&gt;reset) return;</a>
<a name="ln618">    const int reset = darktable.gui-&gt;reset;</a>
<a name="ln619">    darktable.gui-&gt;reset = 1;</a>
<a name="ln620">    dtgtk_button_set_active(DTGTK_BUTTON(button), FALSE);</a>
<a name="ln621">    darktable.gui-&gt;reset = reset;</a>
<a name="ln622">    return;</a>
<a name="ln623">  }</a>
<a name="ln624"> </a>
<a name="ln625">  if(event-&gt;button == 1)</a>
<a name="ln626">  {</a>
<a name="ln627">    const int has_mask_display = module-&gt;request_mask_display &amp; (DT_DEV_PIXELPIPE_DISPLAY_MASK | DT_DEV_PIXELPIPE_DISPLAY_CHANNEL);</a>
<a name="ln628"> </a>
<a name="ln629">    module-&gt;request_mask_display &amp;= ~(DT_DEV_PIXELPIPE_DISPLAY_MASK | DT_DEV_PIXELPIPE_DISPLAY_CHANNEL | DT_DEV_PIXELPIPE_DISPLAY_ANY);</a>
<a name="ln630"> </a>
<a name="ln631">    GdkModifierType modifiers = gtk_accelerator_get_default_mod_mask();</a>
<a name="ln632">    if((event-&gt;state &amp; modifiers) == (GDK_CONTROL_MASK | GDK_SHIFT_MASK))</a>
<a name="ln633">      module-&gt;request_mask_display |= (DT_DEV_PIXELPIPE_DISPLAY_MASK | DT_DEV_PIXELPIPE_DISPLAY_CHANNEL);</a>
<a name="ln634">    else if((event-&gt;state &amp; modifiers) == GDK_SHIFT_MASK)</a>
<a name="ln635">      module-&gt;request_mask_display |= DT_DEV_PIXELPIPE_DISPLAY_CHANNEL;</a>
<a name="ln636">    else if((event-&gt;state &amp; modifiers) == GDK_CONTROL_MASK)</a>
<a name="ln637">      module-&gt;request_mask_display |= DT_DEV_PIXELPIPE_DISPLAY_MASK;</a>
<a name="ln638">    else</a>
<a name="ln639">      module-&gt;request_mask_display |= (has_mask_display ? 0 : DT_DEV_PIXELPIPE_DISPLAY_MASK);</a>
<a name="ln640"> </a>
<a name="ln641">    if(module-&gt;request_mask_display &amp; (DT_DEV_PIXELPIPE_DISPLAY_MASK | DT_DEV_PIXELPIPE_DISPLAY_CHANNEL))</a>
<a name="ln642">      dtgtk_button_set_active(DTGTK_BUTTON(button), 1);</a>
<a name="ln643">    else</a>
<a name="ln644">      dtgtk_button_set_active(DTGTK_BUTTON(button), 0);</a>
<a name="ln645"> </a>
<a name="ln646"> </a>
<a name="ln647">    if(module-&gt;off) gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(module-&gt;off), 1);</a>
<a name="ln648"> </a>
<a name="ln649">    dt_iop_request_focus(module);</a>
<a name="ln650">    dt_dev_reprocess_all(module-&gt;dev);</a>
<a name="ln651">  }</a>
<a name="ln652">}</a>
<a name="ln653"> </a>
<a name="ln654">static void _blendop_masks_modes_none_clicked(GtkWidget *button, GdkEventButton *event, dt_iop_module_t *module)</a>
<a name="ln655">{</a>
<a name="ln656">  if(darktable.gui-&gt;reset) return;</a>
<a name="ln657">  dt_iop_gui_blend_data_t *data = module-&gt;blend_data;</a>
<a name="ln658"> </a>
<a name="ln659">  if(event-&gt;button == 1 &amp;&amp; data-&gt;selected_mask_mode != button)</a>
<a name="ln660">  {</a>
<a name="ln661">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(data-&gt;selected_mask_mode),</a>
<a name="ln662">                                 FALSE); // unsets currently toggled if any</a>
<a name="ln663"> </a>
<a name="ln664">    _blendop_masks_mode_callback(DEVELOP_MASK_DISABLED, data);</a>
<a name="ln665">    data-&gt;selected_mask_mode = button;</a>
<a name="ln666">  }</a>
<a name="ln667">}</a>
<a name="ln668"> </a>
<a name="ln669">static void _blendop_masks_modes_toggle(GtkToggleButton *button, dt_iop_module_t *module, const unsigned int mask_mode)</a>
<a name="ln670">{</a>
<a name="ln671">  if(darktable.gui-&gt;reset) return;</a>
<a name="ln672">  dt_iop_gui_blend_data_t *data = module-&gt;blend_data;</a>
<a name="ln673"> </a>
<a name="ln674">  gboolean was_toggled = gtk_toggle_button_get_active(button);</a>
<a name="ln675"> </a>
<a name="ln676">  // avoids trying to untoggle the cancel button</a>
<a name="ln677">  if(data-&gt;selected_mask_mode</a>
<a name="ln678">     != g_list_nth_data(data-&gt;masks_modes_toggles,</a>
<a name="ln679">                        g_list_index(data-&gt;masks_modes, GUINT_TO_POINTER(DEVELOP_MASK_DISABLED))))</a>
<a name="ln680">  {</a>
<a name="ln681">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(data-&gt;selected_mask_mode), FALSE);</a>
<a name="ln682">  }</a>
<a name="ln683"> </a>
<a name="ln684">  if(was_toggled)</a>
<a name="ln685">  {</a>
<a name="ln686">    _blendop_masks_mode_callback(mask_mode, data);</a>
<a name="ln687">    data-&gt;selected_mask_mode = GTK_WIDGET(button);</a>
<a name="ln688">  }</a>
<a name="ln689">  else</a>
<a name="ln690">  {</a>
<a name="ln691">    _blendop_masks_mode_callback(DEVELOP_MASK_DISABLED, data);</a>
<a name="ln692">    data-&gt;selected_mask_mode = GTK_WIDGET(</a>
<a name="ln693">      g_list_nth_data(data-&gt;masks_modes_toggles,</a>
<a name="ln694">                      g_list_index(data-&gt;masks_modes, (gconstpointer)DEVELOP_MASK_DISABLED)));</a>
<a name="ln695">  }</a>
<a name="ln696">}</a>
<a name="ln697"> </a>
<a name="ln698">static void _blendop_masks_modes_uni_toggled(GtkToggleButton *button, dt_iop_module_t *module)</a>
<a name="ln699">{</a>
<a name="ln700">  _blendop_masks_modes_toggle(button, module, DEVELOP_MASK_ENABLED);</a>
<a name="ln701">}</a>
<a name="ln702"> </a>
<a name="ln703">static void _blendop_masks_modes_drawn_toggled(GtkToggleButton *button, dt_iop_module_t *module)</a>
<a name="ln704">{</a>
<a name="ln705">  _blendop_masks_modes_toggle(button, module, DEVELOP_MASK_ENABLED | DEVELOP_MASK_MASK);</a>
<a name="ln706">}</a>
<a name="ln707"> </a>
<a name="ln708">static void _blendop_masks_modes_param_toggled(GtkToggleButton *button, dt_iop_module_t *module)</a>
<a name="ln709">{</a>
<a name="ln710">  _blendop_masks_modes_toggle(button, module, DEVELOP_MASK_ENABLED | DEVELOP_MASK_CONDITIONAL);</a>
<a name="ln711">}</a>
<a name="ln712"> </a>
<a name="ln713">static void _blendop_masks_modes_both_toggled(GtkToggleButton *button, dt_iop_module_t *module)</a>
<a name="ln714">{</a>
<a name="ln715">  _blendop_masks_modes_toggle(button, module, DEVELOP_MASK_ENABLED | DEVELOP_MASK_MASK_CONDITIONAL);</a>
<a name="ln716">}</a>
<a name="ln717"> </a>
<a name="ln718">static void _blendop_masks_modes_raster_toggled(GtkToggleButton *button, dt_iop_module_t *module)</a>
<a name="ln719">{</a>
<a name="ln720">  _blendop_masks_modes_toggle(button, module, DEVELOP_MASK_ENABLED | DEVELOP_MASK_RASTER);</a>
<a name="ln721">}</a>
<a name="ln722"> </a>
<a name="ln723">static void _blendop_blendif_suppress_toggled(GtkToggleButton *togglebutton, dt_iop_module_t *module)</a>
<a name="ln724">{</a>
<a name="ln725">  module-&gt;suppress_mask = gtk_toggle_button_get_active(togglebutton);</a>
<a name="ln726">  if(darktable.gui-&gt;reset) return;</a>
<a name="ln727"> </a>
<a name="ln728">  if(module-&gt;off) gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(module-&gt;off), 1);</a>
<a name="ln729">  dt_iop_request_focus(module);</a>
<a name="ln730"> </a>
<a name="ln731">  dt_dev_reprocess_all(module-&gt;dev);</a>
<a name="ln732">}</a>
<a name="ln733"> </a>
<a name="ln734">static void _blendop_blendif_reset(GtkButton *button, dt_iop_module_t *module)</a>
<a name="ln735">{</a>
<a name="ln736">  module-&gt;blend_params-&gt;blendif = module-&gt;default_blendop_params-&gt;blendif;</a>
<a name="ln737">  memcpy(module-&gt;blend_params-&gt;blendif_parameters, module-&gt;default_blendop_params-&gt;blendif_parameters,</a>
<a name="ln738">         4 * DEVELOP_BLENDIF_SIZE * sizeof(float));</a>
<a name="ln739"> </a>
<a name="ln740">  dt_iop_color_picker_reset(module, TRUE);</a>
<a name="ln741">  dt_iop_gui_update_blendif(module);</a>
<a name="ln742">  dt_dev_add_history_item(darktable.develop, module, TRUE);</a>
<a name="ln743">}</a>
<a name="ln744"> </a>
<a name="ln745">static void _blendop_blendif_invert(GtkButton *button, dt_iop_module_t *module)</a>
<a name="ln746">{</a>
<a name="ln747">  if(darktable.gui-&gt;reset) return;</a>
<a name="ln748"> </a>
<a name="ln749">  dt_iop_gui_blend_data_t *data = module-&gt;blend_data;</a>
<a name="ln750"> </a>
<a name="ln751">  unsigned int toggle_mask = 0;</a>
<a name="ln752"> </a>
<a name="ln753">  switch(data-&gt;csp)</a>
<a name="ln754">  {</a>
<a name="ln755">    case iop_cs_Lab:</a>
<a name="ln756">      toggle_mask = DEVELOP_BLENDIF_Lab_MASK &lt;&lt; 16;</a>
<a name="ln757">      break;</a>
<a name="ln758"> </a>
<a name="ln759">    case iop_cs_rgb:</a>
<a name="ln760">      toggle_mask = DEVELOP_BLENDIF_RGB_MASK &lt;&lt; 16;</a>
<a name="ln761">      break;</a>
<a name="ln762"> </a>
<a name="ln763">    case iop_cs_RAW:</a>
<a name="ln764">      toggle_mask = 0;</a>
<a name="ln765">      break;</a>
<a name="ln766"> </a>
<a name="ln767">    case iop_cs_LCh:</a>
<a name="ln768">    case iop_cs_HSL:</a>
<a name="ln769">    case iop_cs_NONE:</a>
<a name="ln770">      toggle_mask = 0;</a>
<a name="ln771">      break;</a>
<a name="ln772">  }</a>
<a name="ln773"> </a>
<a name="ln774">  module-&gt;blend_params-&gt;blendif ^= toggle_mask;</a>
<a name="ln775">  module-&gt;blend_params-&gt;mask_combine ^= DEVELOP_COMBINE_MASKS_POS;</a>
<a name="ln776">  module-&gt;blend_params-&gt;mask_combine ^= DEVELOP_COMBINE_INCL;</a>
<a name="ln777">  dt_iop_gui_update_blending(module);</a>
<a name="ln778">  dt_dev_add_history_item(darktable.develop, module, TRUE);</a>
<a name="ln779">}</a>
<a name="ln780"> </a>
<a name="ln781">static int _blendop_masks_add_path(GtkWidget *widget, GdkEventButton *event, dt_iop_module_t *self)</a>
<a name="ln782">{</a>
<a name="ln783">  if(darktable.gui-&gt;reset) return FALSE;</a>
<a name="ln784">  dt_iop_gui_blend_data_t *bd = (dt_iop_gui_blend_data_t *)self-&gt;blend_data;</a>
<a name="ln785"> </a>
<a name="ln786">  if(event-&gt;button == 1)</a>
<a name="ln787">  {</a>
<a name="ln788">    // we want to be sure that the iop has focus</a>
<a name="ln789">    dt_iop_request_focus(self);</a>
<a name="ln790">    dt_iop_color_picker_reset(self, TRUE);</a>
<a name="ln791">    bd-&gt;masks_shown = DT_MASKS_EDIT_FULL;</a>
<a name="ln792">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_edit), TRUE);</a>
<a name="ln793">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(widget), TRUE);</a>
<a name="ln794">    // we create the new form</a>
<a name="ln795">    dt_masks_form_t *form = dt_masks_create(DT_MASKS_PATH);</a>
<a name="ln796">    dt_masks_change_form_gui(form);</a>
<a name="ln797">    darktable.develop-&gt;form_gui-&gt;creation = TRUE;</a>
<a name="ln798">    darktable.develop-&gt;form_gui-&gt;creation_module = self;</a>
<a name="ln799">    dt_control_queue_redraw_center();</a>
<a name="ln800">    return TRUE;</a>
<a name="ln801">  }</a>
<a name="ln802"> </a>
<a name="ln803">  return FALSE;</a>
<a name="ln804">}</a>
<a name="ln805"> </a>
<a name="ln806">static int _blendop_masks_add_circle(GtkWidget *widget, GdkEventButton *event, dt_iop_module_t *self)</a>
<a name="ln807">{</a>
<a name="ln808">  if(darktable.gui-&gt;reset) return FALSE;</a>
<a name="ln809">  dt_iop_gui_blend_data_t *bd = (dt_iop_gui_blend_data_t *)self-&gt;blend_data;</a>
<a name="ln810"> </a>
<a name="ln811">  if(event-&gt;button == 1)</a>
<a name="ln812">  {</a>
<a name="ln813">    // we want to be sure that the iop has focus</a>
<a name="ln814">    dt_iop_request_focus(self);</a>
<a name="ln815">    dt_iop_color_picker_reset(self, TRUE);</a>
<a name="ln816">    bd-&gt;masks_shown = DT_MASKS_EDIT_FULL;</a>
<a name="ln817">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_edit), TRUE);</a>
<a name="ln818">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(widget), TRUE);</a>
<a name="ln819">    // we create the new form</a>
<a name="ln820">    dt_masks_form_t *spot = dt_masks_create(DT_MASKS_CIRCLE);</a>
<a name="ln821">    dt_masks_change_form_gui(spot);</a>
<a name="ln822">    darktable.develop-&gt;form_gui-&gt;creation = TRUE;</a>
<a name="ln823">    darktable.develop-&gt;form_gui-&gt;creation_module = self;</a>
<a name="ln824">    dt_control_queue_redraw_center();</a>
<a name="ln825">    return TRUE;</a>
<a name="ln826">  }</a>
<a name="ln827"> </a>
<a name="ln828">  return FALSE;</a>
<a name="ln829">}</a>
<a name="ln830"> </a>
<a name="ln831">static int _blendop_masks_add_ellipse(GtkWidget *widget, GdkEventButton *event, dt_iop_module_t *self)</a>
<a name="ln832">{</a>
<a name="ln833">  if(darktable.gui-&gt;reset) return FALSE;</a>
<a name="ln834">  dt_iop_gui_blend_data_t *bd = (dt_iop_gui_blend_data_t *)self-&gt;blend_data;</a>
<a name="ln835"> </a>
<a name="ln836">  if(event-&gt;button == 1)</a>
<a name="ln837">  {</a>
<a name="ln838">    // we want to be sure that the iop has focus</a>
<a name="ln839">    dt_iop_request_focus(self);</a>
<a name="ln840">    dt_iop_color_picker_reset(self, TRUE);</a>
<a name="ln841">    bd-&gt;masks_shown = DT_MASKS_EDIT_FULL;</a>
<a name="ln842">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_edit), TRUE);</a>
<a name="ln843">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(widget), TRUE);</a>
<a name="ln844">    // we create the new form</a>
<a name="ln845">    dt_masks_form_t *spot = dt_masks_create(DT_MASKS_ELLIPSE);</a>
<a name="ln846">    dt_masks_change_form_gui(spot);</a>
<a name="ln847">    darktable.develop-&gt;form_gui-&gt;creation = TRUE;</a>
<a name="ln848">    darktable.develop-&gt;form_gui-&gt;creation_module = self;</a>
<a name="ln849">    dt_control_queue_redraw_center();</a>
<a name="ln850">    return TRUE;</a>
<a name="ln851">  }</a>
<a name="ln852"> </a>
<a name="ln853">  return FALSE;</a>
<a name="ln854">}</a>
<a name="ln855"> </a>
<a name="ln856">static int _blendop_masks_add_brush(GtkWidget *widget, GdkEventButton *event, dt_iop_module_t *self)</a>
<a name="ln857">{</a>
<a name="ln858">  if(darktable.gui-&gt;reset) return FALSE;</a>
<a name="ln859">  dt_iop_gui_blend_data_t *bd = (dt_iop_gui_blend_data_t *)self-&gt;blend_data;</a>
<a name="ln860"> </a>
<a name="ln861">  if(event-&gt;button == 1)</a>
<a name="ln862">  {</a>
<a name="ln863">    // we want to be sure that the iop has focus</a>
<a name="ln864">    dt_iop_request_focus(self);</a>
<a name="ln865">    dt_iop_color_picker_reset(self, TRUE);</a>
<a name="ln866">    bd-&gt;masks_shown = DT_MASKS_EDIT_FULL;</a>
<a name="ln867">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_edit), TRUE);</a>
<a name="ln868">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(widget), TRUE);</a>
<a name="ln869">    // we create the new form</a>
<a name="ln870">    dt_masks_form_t *form = dt_masks_create(DT_MASKS_BRUSH);</a>
<a name="ln871">    dt_masks_change_form_gui(form);</a>
<a name="ln872">    darktable.develop-&gt;form_gui-&gt;creation = TRUE;</a>
<a name="ln873">    darktable.develop-&gt;form_gui-&gt;creation_module = self;</a>
<a name="ln874">    dt_control_queue_redraw_center();</a>
<a name="ln875">    return TRUE;</a>
<a name="ln876">  }</a>
<a name="ln877"> </a>
<a name="ln878">  return FALSE;</a>
<a name="ln879">}</a>
<a name="ln880"> </a>
<a name="ln881">static int _blendop_masks_add_gradient(GtkWidget *widget, GdkEventButton *event, dt_iop_module_t *self)</a>
<a name="ln882">{</a>
<a name="ln883">  if(darktable.gui-&gt;reset) return FALSE;</a>
<a name="ln884">  dt_iop_gui_blend_data_t *bd = (dt_iop_gui_blend_data_t *)self-&gt;blend_data;</a>
<a name="ln885"> </a>
<a name="ln886">  if(event-&gt;button == 1)</a>
<a name="ln887">  {</a>
<a name="ln888">    // we want to be sure that the iop has focus</a>
<a name="ln889">    dt_iop_request_focus(self);</a>
<a name="ln890">    dt_iop_color_picker_reset(self, TRUE);</a>
<a name="ln891">    bd-&gt;masks_shown = DT_MASKS_EDIT_FULL;</a>
<a name="ln892">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_edit), TRUE);</a>
<a name="ln893">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(widget), TRUE);</a>
<a name="ln894">    // we create the new form</a>
<a name="ln895">    dt_masks_form_t *spot = dt_masks_create(DT_MASKS_GRADIENT);</a>
<a name="ln896">    dt_masks_change_form_gui(spot);</a>
<a name="ln897">    darktable.develop-&gt;form_gui-&gt;creation = TRUE;</a>
<a name="ln898">    darktable.develop-&gt;form_gui-&gt;creation_module = self;</a>
<a name="ln899">    dt_control_queue_redraw_center();</a>
<a name="ln900">    return TRUE;</a>
<a name="ln901">  }</a>
<a name="ln902"> </a>
<a name="ln903">  return FALSE;</a>
<a name="ln904">}</a>
<a name="ln905"> </a>
<a name="ln906"> </a>
<a name="ln907">static int _blendop_masks_show_and_edit(GtkWidget *widget, GdkEventButton *event, dt_iop_module_t *self)</a>
<a name="ln908">{</a>
<a name="ln909">  if(darktable.gui-&gt;reset) return FALSE;</a>
<a name="ln910">  dt_iop_gui_blend_data_t *bd = (dt_iop_gui_blend_data_t *)self-&gt;blend_data;</a>
<a name="ln911"> </a>
<a name="ln912">  if(event-&gt;button == 1)</a>
<a name="ln913">  {</a>
<a name="ln914">    darktable.gui-&gt;reset = 1;</a>
<a name="ln915"> </a>
<a name="ln916">    dt_iop_request_focus(self);</a>
<a name="ln917">    dt_iop_color_picker_reset(self, TRUE);</a>
<a name="ln918"> </a>
<a name="ln919">    dt_masks_form_t *grp = dt_masks_get_from_id(darktable.develop, self-&gt;blend_params-&gt;mask_id);</a>
<a name="ln920">    if(grp &amp;&amp; (grp-&gt;type &amp; DT_MASKS_GROUP) &amp;&amp; g_list_length(grp-&gt;points) &gt; 0)</a>
<a name="ln921">    {</a>
<a name="ln922">      const int control_button_pressed = event-&gt;state &amp; GDK_CONTROL_MASK;</a>
<a name="ln923"> </a>
<a name="ln924">      switch(bd-&gt;masks_shown)</a>
<a name="ln925">      {</a>
<a name="ln926">        case DT_MASKS_EDIT_FULL:</a>
<a name="ln927">          bd-&gt;masks_shown = control_button_pressed ? DT_MASKS_EDIT_RESTRICTED : DT_MASKS_EDIT_OFF;</a>
<a name="ln928">          break;</a>
<a name="ln929"> </a>
<a name="ln930">        case DT_MASKS_EDIT_RESTRICTED:</a>
<a name="ln931">          bd-&gt;masks_shown = !control_button_pressed ? DT_MASKS_EDIT_FULL : DT_MASKS_EDIT_OFF;</a>
<a name="ln932">          break;</a>
<a name="ln933"> </a>
<a name="ln934">        default:</a>
<a name="ln935">        case DT_MASKS_EDIT_OFF:</a>
<a name="ln936">          bd-&gt;masks_shown = control_button_pressed ? DT_MASKS_EDIT_RESTRICTED : DT_MASKS_EDIT_FULL;</a>
<a name="ln937">      }</a>
<a name="ln938">    }</a>
<a name="ln939">    else</a>
<a name="ln940">      bd-&gt;masks_shown = DT_MASKS_EDIT_OFF;</a>
<a name="ln941"> </a>
<a name="ln942">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_edit), bd-&gt;masks_shown != DT_MASKS_EDIT_OFF);</a>
<a name="ln943">    dt_masks_set_edit_mode(self, bd-&gt;masks_shown);</a>
<a name="ln944"> </a>
<a name="ln945">    darktable.gui-&gt;reset = 0;</a>
<a name="ln946"> </a>
<a name="ln947">    return TRUE;</a>
<a name="ln948">  }</a>
<a name="ln949"> </a>
<a name="ln950">  return FALSE;</a>
<a name="ln951">}</a>
<a name="ln952"> </a>
<a name="ln953">static void _blendop_masks_polarity_callback(GtkToggleButton *togglebutton, dt_iop_module_t *self)</a>
<a name="ln954">{</a>
<a name="ln955">  if(darktable.gui-&gt;reset) return;</a>
<a name="ln956"> </a>
<a name="ln957">  int active = gtk_toggle_button_get_active(togglebutton);</a>
<a name="ln958">  dt_develop_blend_params_t *bp = (dt_develop_blend_params_t *)self-&gt;blend_params;</a>
<a name="ln959"> </a>
<a name="ln960">  if(active)</a>
<a name="ln961">    bp-&gt;mask_combine |= DEVELOP_COMBINE_MASKS_POS;</a>
<a name="ln962">  else</a>
<a name="ln963">    bp-&gt;mask_combine &amp;= ~DEVELOP_COMBINE_MASKS_POS;</a>
<a name="ln964"> </a>
<a name="ln965">  dt_dev_add_history_item(darktable.develop, self, TRUE);</a>
<a name="ln966">}</a>
<a name="ln967"> </a>
<a name="ln968">static int _iop_color_picker_get_set(dt_iop_module_t *self, GtkWidget *button)</a>
<a name="ln969">{</a>
<a name="ln970">  dt_iop_gui_blend_data_t *data = self-&gt;blend_data;</a>
<a name="ln971">  const int current_picker = data-&gt;color_picker.current_picker;</a>
<a name="ln972"> </a>
<a name="ln973">  data-&gt;color_picker.current_picker = DT_BLENDIF_PICK_NONE;</a>
<a name="ln974"> </a>
<a name="ln975">  if(button == data-&gt;colorpicker)</a>
<a name="ln976">    data-&gt;color_picker.current_picker = DT_BLENDIF_PICK_COLORPICK;</a>
<a name="ln977">  else if(button == data-&gt;colorpicker_set_values)</a>
<a name="ln978">    data-&gt;color_picker.current_picker = DT_BLENDIF_PICK_SET_VALUES;</a>
<a name="ln979"> </a>
<a name="ln980">  if(current_picker == data-&gt;color_picker.current_picker)</a>
<a name="ln981">    return DT_COLOR_PICKER_ALREADY_SELECTED;</a>
<a name="ln982">  else</a>
<a name="ln983">    return data-&gt;color_picker.current_picker;</a>
<a name="ln984">}</a>
<a name="ln985"> </a>
<a name="ln986">static void _iop_color_picker_apply(struct dt_iop_module_t *module, dt_dev_pixelpipe_iop_t *piece)</a>
<a name="ln987">{</a>
<a name="ln988">  if(darktable.gui-&gt;reset) return;</a>
<a name="ln989"> </a>
<a name="ln990">  dt_iop_gui_blend_data_t *data = module-&gt;blend_data;</a>
<a name="ln991">  switch(data-&gt;color_picker.current_picker)</a>
<a name="ln992">  {</a>
<a name="ln993">  case DT_BLENDIF_PICK_SET_VALUES:</a>
<a name="ln994">  {</a>
<a name="ln995">    const int reset = darktable.gui-&gt;reset;</a>
<a name="ln996">    darktable.gui-&gt;reset = 1;</a>
<a name="ln997"> </a>
<a name="ln998">    dt_develop_blend_params_t *bp = module-&gt;blend_params;</a>
<a name="ln999">    const int tab = data-&gt;tab;</a>
<a name="ln1000">    const int lower_upper = data-&gt;picker_set_upper_lower; // lower=0, upper=1</a>
<a name="ln1001">    const int ch = data-&gt;channels[tab][lower_upper];</a>
<a name="ln1002">    float *parameters = &amp;(bp-&gt;blendif_parameters[4 * ch]);</a>
<a name="ln1003">    float *raw_mean, *raw_min, *raw_max;</a>
<a name="ln1004">    float picker_mean[8], picker_min[8], picker_max[8];</a>
<a name="ln1005">    float picker_values[4];</a>
<a name="ln1006">    GtkDarktableGradientSlider *slider = (lower_upper == 0) ? data-&gt;lower_slider: data-&gt;upper_slider;</a>
<a name="ln1007"> </a>
<a name="ln1008">    if(lower_upper == 0)</a>
<a name="ln1009">    {</a>
<a name="ln1010">      raw_mean = module-&gt;picked_color;</a>
<a name="ln1011">      raw_min = module-&gt;picked_color_min;</a>
<a name="ln1012">      raw_max = module-&gt;picked_color_max;</a>
<a name="ln1013">    }</a>
<a name="ln1014">    else</a>
<a name="ln1015">    {</a>
<a name="ln1016">      raw_mean = module-&gt;picked_output_color;</a>
<a name="ln1017">      raw_min = module-&gt;picked_output_color_min;</a>
<a name="ln1018">      raw_max = module-&gt;picked_output_color_max;</a>
<a name="ln1019">    }</a>
<a name="ln1020"> </a>
<a name="ln1021">    const int cst = (dt_iop_color_picker_get_active_cst(module) == iop_cs_NONE)</a>
<a name="ln1022">                        ? data-&gt;csp</a>
<a name="ln1023">                        : dt_iop_color_picker_get_active_cst(module);</a>
<a name="ln1024">    const dt_iop_order_iccprofile_info_t *work_profile = dt_ioppr_get_pipe_work_profile_info(piece-&gt;pipe);</a>
<a name="ln1025">    _blendif_scale(cst, raw_mean, picker_mean, work_profile);</a>
<a name="ln1026">    _blendif_scale(cst, raw_min, picker_min, work_profile);</a>
<a name="ln1027">    _blendif_scale(cst, raw_max, picker_max, work_profile);</a>
<a name="ln1028"> </a>
<a name="ln1029">    const float feather = 0.01f;</a>
<a name="ln1030"> </a>
<a name="ln1031">    if(picker_min[tab] &gt; picker_max[tab])</a>
<a name="ln1032">    {</a>
<a name="ln1033">      const float tmp = picker_min[tab];</a>
<a name="ln1034">      picker_min[tab] = picker_max[tab];</a>
<a name="ln1035">      picker_max[tab] = tmp;</a>
<a name="ln1036">    }</a>
<a name="ln1037"> </a>
<a name="ln1038">    picker_values[0] = CLAMP(picker_min[tab] - feather, 0.f, 1.f);</a>
<a name="ln1039">    picker_values[1] = CLAMP(picker_min[tab] + feather, 0.f, 1.f);</a>
<a name="ln1040">    picker_values[2] = CLAMP(picker_max[tab] - feather, 0.f, 1.f);</a>
<a name="ln1041">    picker_values[3] = CLAMP(picker_max[tab] + feather, 0.f, 1.f);</a>
<a name="ln1042"> </a>
<a name="ln1043">    if(picker_values[1] &gt; picker_values[2])</a>
<a name="ln1044">    {</a>
<a name="ln1045">      picker_values[1] = CLAMP(picker_min[tab], 0.f, 1.f);</a>
<a name="ln1046">      picker_values[2] = CLAMP(picker_max[tab], 0.f, 1.f);</a>
<a name="ln1047">    }</a>
<a name="ln1048"> </a>
<a name="ln1049">    picker_values[0] = CLAMP(picker_values[0], 0.f, picker_values[1]);</a>
<a name="ln1050">    picker_values[3] = CLAMP(picker_values[3], picker_values[2], 1.f);</a>
<a name="ln1051"> </a>
<a name="ln1052">    for(int k = 0; k &lt; 4; k++)</a>
<a name="ln1053">      dtgtk_gradient_slider_multivalue_set_value(slider, picker_values[k], k);</a>
<a name="ln1054"> </a>
<a name="ln1055">    // update picked values</a>
<a name="ln1056">    _update_gradient_slider(GTK_WIDGET(data-&gt;lower_slider), module);</a>
<a name="ln1057">    _update_gradient_slider(GTK_WIDGET(data-&gt;upper_slider), module);</a>
<a name="ln1058"> </a>
<a name="ln1059">    for(int k = 0; k &lt; 4; k++)</a>
<a name="ln1060">    {</a>
<a name="ln1061">      char text[256];</a>
<a name="ln1062">      (data-&gt;scale_print[tab])(dtgtk_gradient_slider_multivalue_get_value(slider, k), text, sizeof(text));</a>
<a name="ln1063">      if(lower_upper == 0)</a>
<a name="ln1064">        gtk_label_set_text(data-&gt;lower_label[k], text);</a>
<a name="ln1065">      else</a>
<a name="ln1066">        gtk_label_set_text(data-&gt;upper_label[k], text);</a>
<a name="ln1067">    }</a>
<a name="ln1068"> </a>
<a name="ln1069">    darktable.gui-&gt;reset = reset;</a>
<a name="ln1070"> </a>
<a name="ln1071">    // save values to parameters</a>
<a name="ln1072">    for(int k = 0; k &lt; 4; k++)</a>
<a name="ln1073">      parameters[k] = dtgtk_gradient_slider_multivalue_get_value(slider, k);</a>
<a name="ln1074"> </a>
<a name="ln1075">    // de-activate processing of this channel if maximum span is selected</a>
<a name="ln1076">    if(parameters[1] == 0.0f &amp;&amp; parameters[2] == 1.0f)</a>
<a name="ln1077">      bp-&gt;blendif &amp;= ~(1 &lt;&lt; ch);</a>
<a name="ln1078">    else</a>
<a name="ln1079">      bp-&gt;blendif |= (1 &lt;&lt; ch);</a>
<a name="ln1080"> </a>
<a name="ln1081">    dt_dev_add_history_item(darktable.develop, module, TRUE);</a>
<a name="ln1082">  }</a>
<a name="ln1083">  break;</a>
<a name="ln1084">  case DT_BLENDIF_PICK_COLORPICK:</a>
<a name="ln1085">    _update_gradient_slider(GTK_WIDGET(data-&gt;upper_slider), module);</a>
<a name="ln1086">    _update_gradient_slider(GTK_WIDGET(data-&gt;lower_slider), module);</a>
<a name="ln1087">    break;</a>
<a name="ln1088">  default:</a>
<a name="ln1089">    break;</a>
<a name="ln1090">  }</a>
<a name="ln1091">}</a>
<a name="ln1092"> </a>
<a name="ln1093">static void _iop_color_picker_update(dt_iop_module_t *self)</a>
<a name="ln1094">{</a>
<a name="ln1095">  dt_iop_gui_blend_data_t *data = self-&gt;blend_data;</a>
<a name="ln1096">  const int which_colorpicker = data-&gt;color_picker.current_picker;</a>
<a name="ln1097">  const int reset = darktable.gui-&gt;reset;</a>
<a name="ln1098">  darktable.gui-&gt;reset = 1;</a>
<a name="ln1099"> </a>
<a name="ln1100">  gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(data-&gt;colorpicker), which_colorpicker == DT_BLENDIF_PICK_COLORPICK);</a>
<a name="ln1101">  gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(data-&gt;colorpicker_set_values), which_colorpicker == DT_BLENDIF_PICK_SET_VALUES);</a>
<a name="ln1102"> </a>
<a name="ln1103">  if(self-&gt;request_color_pick != DT_REQUEST_COLORPICK_BLEND)</a>
<a name="ln1104">  {</a>
<a name="ln1105">    dt_iop_color_picker_set_cst(&amp;data-&gt;color_picker, iop_cs_NONE);</a>
<a name="ln1106"> </a>
<a name="ln1107">    dtgtk_gradient_slider_multivalue_set_picker(DTGTK_GRADIENT_SLIDER(data-&gt;upper_slider), NAN);</a>
<a name="ln1108">    gtk_label_set_text(data-&gt;upper_picker_label, &quot;&quot;);</a>
<a name="ln1109">    dtgtk_gradient_slider_multivalue_set_picker(DTGTK_GRADIENT_SLIDER(data-&gt;lower_slider), NAN);</a>
<a name="ln1110">    gtk_label_set_text(data-&gt;lower_picker_label, &quot;&quot;);</a>
<a name="ln1111">  }</a>
<a name="ln1112"> </a>
<a name="ln1113">  darktable.gui-&gt;reset = reset;</a>
<a name="ln1114">}</a>
<a name="ln1115"> </a>
<a name="ln1116">static gboolean _blendop_blendif_color_picker_callback_button_press(GtkWidget *widget, GdkEventButton *e, dt_iop_module_t *module)</a>
<a name="ln1117">{</a>
<a name="ln1118">  if(darktable.gui-&gt;reset) return FALSE;</a>
<a name="ln1119"> </a>
<a name="ln1120">  dt_iop_gui_blend_data_t *bd = (dt_iop_gui_blend_data_t *)module-&gt;blend_data;</a>
<a name="ln1121">  dt_iop_color_picker_t *color_picker = &amp;bd-&gt;color_picker;</a>
<a name="ln1122">  dt_iop_color_picker_set_cst(&amp;bd-&gt;color_picker, _blendop_blendif_get_picker_colorspace(bd));</a>
<a name="ln1123"> </a>
<a name="ln1124">  // this is not pretty but we don't have a kind per-picker</a>
<a name="ln1125">  // if at some some point a module needs it we can think something more elegant</a>
<a name="ln1126">  if(widget == bd-&gt;colorpicker)</a>
<a name="ln1127">    color_picker-&gt;kind = DT_COLOR_PICKER_POINT_AREA;</a>
<a name="ln1128">  else</a>
<a name="ln1129">    color_picker-&gt;kind = DT_COLOR_PICKER_AREA;</a>
<a name="ln1130"> </a>
<a name="ln1131">  GdkModifierType modifiers = gtk_accelerator_get_default_mod_mask();</a>
<a name="ln1132">  if((e-&gt;state &amp; modifiers) == GDK_CONTROL_MASK) // lower=0, upper=1</a>
<a name="ln1133">    bd-&gt;picker_set_upper_lower = 1;</a>
<a name="ln1134">  else</a>
<a name="ln1135">    bd-&gt;picker_set_upper_lower = 0;</a>
<a name="ln1136"> </a>
<a name="ln1137">  return dt_iop_color_picker_callback_button_press(widget, e, color_picker);</a>
<a name="ln1138">}</a>
<a name="ln1139"> </a>
<a name="ln1140">// magic mode: if mouse curser enters a gradient slider with shift and/or control pressed we</a>
<a name="ln1141">// enter channel display and/or mask display mode</a>
<a name="ln1142">static gboolean _blendop_blendif_enter(GtkWidget *widget, GdkEventCrossing *event, dt_iop_module_t *module)</a>
<a name="ln1143">{</a>
<a name="ln1144">  if(darktable.gui-&gt;reset) return FALSE;</a>
<a name="ln1145">  dt_iop_gui_blend_data_t *data = module-&gt;blend_data;</a>
<a name="ln1146"> </a>
<a name="ln1147">  dt_pthread_mutex_lock(&amp;data-&gt;lock);</a>
<a name="ln1148">  if(data-&gt;timeout_handle)</a>
<a name="ln1149">  {</a>
<a name="ln1150">    // purge any remaining timeout handlers</a>
<a name="ln1151">    g_source_remove(data-&gt;timeout_handle);</a>
<a name="ln1152">    data-&gt;timeout_handle = 0;</a>
<a name="ln1153">  }</a>
<a name="ln1154">  else</a>
<a name="ln1155">  {</a>
<a name="ln1156">    // save request_mask_display to restore later</a>
<a name="ln1157">    data-&gt;save_for_leave = module-&gt;request_mask_display;</a>
<a name="ln1158">  }</a>
<a name="ln1159">  dt_pthread_mutex_unlock(&amp;data-&gt;lock);</a>
<a name="ln1160"> </a>
<a name="ln1161">  dt_dev_pixelpipe_display_mask_t new_request_mask_display = module-&gt;request_mask_display;</a>
<a name="ln1162"> </a>
<a name="ln1163">  // depending on shift modifiers we activate channel and/or mask display</a>
<a name="ln1164">  GdkModifierType modifiers = gtk_accelerator_get_default_mod_mask();</a>
<a name="ln1165">  if((event-&gt;state &amp; modifiers) == (GDK_SHIFT_MASK | GDK_CONTROL_MASK))</a>
<a name="ln1166">  {</a>
<a name="ln1167">    new_request_mask_display |= (DT_DEV_PIXELPIPE_DISPLAY_MASK | DT_DEV_PIXELPIPE_DISPLAY_CHANNEL);</a>
<a name="ln1168">  }</a>
<a name="ln1169">  else if((event-&gt;state &amp; modifiers) == GDK_SHIFT_MASK)</a>
<a name="ln1170">  {</a>
<a name="ln1171">    new_request_mask_display |= DT_DEV_PIXELPIPE_DISPLAY_CHANNEL;</a>
<a name="ln1172">  }</a>
<a name="ln1173">  else if((event-&gt;state &amp; modifiers) == GDK_CONTROL_MASK)</a>
<a name="ln1174">  {</a>
<a name="ln1175">    new_request_mask_display |= DT_DEV_PIXELPIPE_DISPLAY_MASK;</a>
<a name="ln1176">  }</a>
<a name="ln1177"> </a>
<a name="ln1178">  // in case user requests channel display: get the cannel</a>
<a name="ln1179">  if(new_request_mask_display &amp; DT_DEV_PIXELPIPE_DISPLAY_CHANNEL)</a>
<a name="ln1180">  {</a>
<a name="ln1181">    int tab = data-&gt;tab;</a>
<a name="ln1182">    int inout = (widget == GTK_WIDGET(data-&gt;lower_slider)) ? 0 : 1;</a>
<a name="ln1183">    dt_dev_pixelpipe_display_mask_t channel = data-&gt;display_channel[tab][inout];</a>
<a name="ln1184"> </a>
<a name="ln1185">    new_request_mask_display &amp;= ~DT_DEV_PIXELPIPE_DISPLAY_ANY;</a>
<a name="ln1186">    new_request_mask_display |= channel;</a>
<a name="ln1187">  }</a>
<a name="ln1188"> </a>
<a name="ln1189">  // only if something has changed: reprocess center view</a>
<a name="ln1190">  if(new_request_mask_display != module-&gt;request_mask_display)</a>
<a name="ln1191">  {</a>
<a name="ln1192">    module-&gt;request_mask_display = new_request_mask_display;</a>
<a name="ln1193">    dt_dev_reprocess_all(module-&gt;dev);</a>
<a name="ln1194">  }</a>
<a name="ln1195"> </a>
<a name="ln1196">  return TRUE;</a>
<a name="ln1197">}</a>
<a name="ln1198"> </a>
<a name="ln1199">// handler for delayed mask/channel display mode switch-off</a>
<a name="ln1200">static gboolean _blendop_blendif_leave_delayed(gpointer data)</a>
<a name="ln1201">{</a>
<a name="ln1202">  dt_iop_module_t *module = (dt_iop_module_t *)data;</a>
<a name="ln1203">  dt_iop_gui_blend_data_t *bd = module-&gt;blend_data;</a>
<a name="ln1204"> </a>
<a name="ln1205">  dt_pthread_mutex_lock(&amp;bd-&gt;lock);</a>
<a name="ln1206">  // restore saved request_mask_display and reprocess image</a>
<a name="ln1207">  if(bd-&gt;timeout_handle &amp;&amp; (module-&gt;request_mask_display != bd-&gt;save_for_leave))</a>
<a name="ln1208">  {</a>
<a name="ln1209">    module-&gt;request_mask_display = bd-&gt;save_for_leave;</a>
<a name="ln1210">    dt_dev_reprocess_all(module-&gt;dev);</a>
<a name="ln1211">  }</a>
<a name="ln1212"> </a>
<a name="ln1213">  bd-&gt;timeout_handle = 0;</a>
<a name="ln1214">  dt_pthread_mutex_unlock(&amp;bd-&gt;lock);</a>
<a name="ln1215"> </a>
<a name="ln1216">  // return FALSE and thereby terminate the handler</a>
<a name="ln1217">  return FALSE;</a>
<a name="ln1218">}</a>
<a name="ln1219"> </a>
<a name="ln1220">// de-activate magic mode when leaving the gradient slider</a>
<a name="ln1221">static gboolean _blendop_blendif_leave(GtkWidget *widget, GdkEventCrossing *event, dt_iop_module_t *module)</a>
<a name="ln1222">{</a>
<a name="ln1223">  if(darktable.gui-&gt;reset) return FALSE;</a>
<a name="ln1224">  dt_iop_gui_blend_data_t *data = module-&gt;blend_data;</a>
<a name="ln1225"> </a>
<a name="ln1226">  if(module-&gt;request_mask_display &amp; (DT_DEV_PIXELPIPE_DISPLAY_MASK | DT_DEV_PIXELPIPE_DISPLAY_CHANNEL))</a>
<a name="ln1227">  {</a>
<a name="ln1228">    // do not immediately switch-off mask/channel display in case user leaves gradient only briefly.</a>
<a name="ln1229">    // instead we activate a handler function that gets triggered after some timeout</a>
<a name="ln1230">    dt_pthread_mutex_lock(&amp;data-&gt;lock);</a>
<a name="ln1231">    if(!data-&gt;timeout_handle &amp;&amp; (module-&gt;request_mask_display != data-&gt;save_for_leave))</a>
<a name="ln1232">      data-&gt;timeout_handle = g_timeout_add(1000, _blendop_blendif_leave_delayed, module);</a>
<a name="ln1233">    dt_pthread_mutex_unlock(&amp;data-&gt;lock);</a>
<a name="ln1234">  }</a>
<a name="ln1235"> </a>
<a name="ln1236">  return TRUE;</a>
<a name="ln1237">}</a>
<a name="ln1238"> </a>
<a name="ln1239">void dt_iop_gui_update_blendif(dt_iop_module_t *module)</a>
<a name="ln1240">{</a>
<a name="ln1241">  dt_iop_gui_blend_data_t *data = module-&gt;blend_data;</a>
<a name="ln1242">  dt_develop_blend_params_t *bp = module-&gt;blend_params;</a>
<a name="ln1243">  dt_develop_blend_params_t *dp = module-&gt;default_blendop_params;</a>
<a name="ln1244"> </a>
<a name="ln1245">  if(!data || !data-&gt;blendif_support || !data-&gt;blendif_inited) return;</a>
<a name="ln1246"> </a>
<a name="ln1247">  dt_pthread_mutex_lock(&amp;data-&gt;lock);</a>
<a name="ln1248">  if(data-&gt;timeout_handle)</a>
<a name="ln1249">  {</a>
<a name="ln1250">    g_source_remove(data-&gt;timeout_handle);</a>
<a name="ln1251">    data-&gt;timeout_handle = 0;</a>
<a name="ln1252">    if(module-&gt;request_mask_display != data-&gt;save_for_leave)</a>
<a name="ln1253">    {</a>
<a name="ln1254">      module-&gt;request_mask_display = data-&gt;save_for_leave;</a>
<a name="ln1255">      dt_dev_reprocess_all(module-&gt;dev);</a>
<a name="ln1256">    }</a>
<a name="ln1257">  }</a>
<a name="ln1258">  dt_pthread_mutex_unlock(&amp;data-&gt;lock);</a>
<a name="ln1259"> </a>
<a name="ln1260">  int tab = data-&gt;tab;</a>
<a name="ln1261">  int in_ch = data-&gt;channels[tab][0];</a>
<a name="ln1262">  int out_ch = data-&gt;channels[tab][1];</a>
<a name="ln1263"> </a>
<a name="ln1264">  float *iparameters = &amp;(bp-&gt;blendif_parameters[4 * in_ch]);</a>
<a name="ln1265">  float *oparameters = &amp;(bp-&gt;blendif_parameters[4 * out_ch]);</a>
<a name="ln1266">  float *idefaults = &amp;(dp-&gt;blendif_parameters[4 * in_ch]);</a>
<a name="ln1267">  float *odefaults = &amp;(dp-&gt;blendif_parameters[4 * out_ch]);</a>
<a name="ln1268"> </a>
<a name="ln1269">  int ipolarity = !(bp-&gt;blendif &amp; (1 &lt;&lt; (in_ch + 16)));</a>
<a name="ln1270">  int opolarity = !(bp-&gt;blendif &amp; (1 &lt;&lt; (out_ch + 16)));</a>
<a name="ln1271">  char text[256];</a>
<a name="ln1272"> </a>
<a name="ln1273">  int reset = darktable.gui-&gt;reset;</a>
<a name="ln1274">  darktable.gui-&gt;reset = 1;</a>
<a name="ln1275"> </a>
<a name="ln1276">  gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(data-&gt;lower_polarity), ipolarity);</a>
<a name="ln1277">  gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(data-&gt;upper_polarity), opolarity);</a>
<a name="ln1278"> </a>
<a name="ln1279">  dtgtk_gradient_slider_multivalue_set_marker(</a>
<a name="ln1280">      data-&gt;lower_slider,</a>
<a name="ln1281">      ipolarity ? GRADIENT_SLIDER_MARKER_LOWER_OPEN_BIG : GRADIENT_SLIDER_MARKER_UPPER_OPEN_BIG, 0);</a>
<a name="ln1282">  dtgtk_gradient_slider_multivalue_set_marker(</a>
<a name="ln1283">      data-&gt;lower_slider,</a>
<a name="ln1284">      ipolarity ? GRADIENT_SLIDER_MARKER_UPPER_FILLED_BIG : GRADIENT_SLIDER_MARKER_LOWER_FILLED_BIG, 1);</a>
<a name="ln1285">  dtgtk_gradient_slider_multivalue_set_marker(</a>
<a name="ln1286">      data-&gt;lower_slider,</a>
<a name="ln1287">      ipolarity ? GRADIENT_SLIDER_MARKER_UPPER_FILLED_BIG : GRADIENT_SLIDER_MARKER_LOWER_FILLED_BIG, 2);</a>
<a name="ln1288">  dtgtk_gradient_slider_multivalue_set_marker(</a>
<a name="ln1289">      data-&gt;lower_slider,</a>
<a name="ln1290">      ipolarity ? GRADIENT_SLIDER_MARKER_LOWER_OPEN_BIG : GRADIENT_SLIDER_MARKER_UPPER_OPEN_BIG, 3);</a>
<a name="ln1291"> </a>
<a name="ln1292">  dtgtk_gradient_slider_multivalue_set_marker(</a>
<a name="ln1293">      data-&gt;upper_slider,</a>
<a name="ln1294">      opolarity ? GRADIENT_SLIDER_MARKER_LOWER_OPEN_BIG : GRADIENT_SLIDER_MARKER_UPPER_OPEN_BIG, 0);</a>
<a name="ln1295">  dtgtk_gradient_slider_multivalue_set_marker(</a>
<a name="ln1296">      data-&gt;upper_slider,</a>
<a name="ln1297">      opolarity ? GRADIENT_SLIDER_MARKER_UPPER_FILLED_BIG : GRADIENT_SLIDER_MARKER_LOWER_FILLED_BIG, 1);</a>
<a name="ln1298">  dtgtk_gradient_slider_multivalue_set_marker(</a>
<a name="ln1299">      data-&gt;upper_slider,</a>
<a name="ln1300">      opolarity ? GRADIENT_SLIDER_MARKER_UPPER_FILLED_BIG : GRADIENT_SLIDER_MARKER_LOWER_FILLED_BIG, 2);</a>
<a name="ln1301">  dtgtk_gradient_slider_multivalue_set_marker(</a>
<a name="ln1302">      data-&gt;upper_slider,</a>
<a name="ln1303">      opolarity ? GRADIENT_SLIDER_MARKER_LOWER_OPEN_BIG : GRADIENT_SLIDER_MARKER_UPPER_OPEN_BIG, 3);</a>
<a name="ln1304"> </a>
<a name="ln1305">  for(int k = 0; k &lt; 4; k++)</a>
<a name="ln1306">  {</a>
<a name="ln1307">    dtgtk_gradient_slider_multivalue_set_value(data-&gt;lower_slider, iparameters[k], k);</a>
<a name="ln1308">    dtgtk_gradient_slider_multivalue_set_value(data-&gt;upper_slider, oparameters[k], k);</a>
<a name="ln1309">    dtgtk_gradient_slider_multivalue_set_resetvalue(data-&gt;lower_slider, idefaults[k], k);</a>
<a name="ln1310">    dtgtk_gradient_slider_multivalue_set_resetvalue(data-&gt;upper_slider, odefaults[k], k);</a>
<a name="ln1311">  }</a>
<a name="ln1312"> </a>
<a name="ln1313">  for(int k = 0; k &lt; 4; k++)</a>
<a name="ln1314">  {</a>
<a name="ln1315">    (data-&gt;scale_print[tab])(iparameters[k], text, sizeof(text));</a>
<a name="ln1316">    gtk_label_set_text(data-&gt;lower_label[k], text);</a>
<a name="ln1317">    (data-&gt;scale_print[tab])(oparameters[k], text, sizeof(text));</a>
<a name="ln1318">    gtk_label_set_text(data-&gt;upper_label[k], text);</a>
<a name="ln1319">  }</a>
<a name="ln1320"> </a>
<a name="ln1321">  dtgtk_gradient_slider_multivalue_clear_stops(data-&gt;lower_slider);</a>
<a name="ln1322">  dtgtk_gradient_slider_multivalue_clear_stops(data-&gt;upper_slider);</a>
<a name="ln1323"> </a>
<a name="ln1324">  for(int k = 0; k &lt; data-&gt;numberstops[tab]; k++)</a>
<a name="ln1325">  {</a>
<a name="ln1326">    dtgtk_gradient_slider_multivalue_set_stop(data-&gt;lower_slider, (data-&gt;colorstops[tab])[k].stoppoint,</a>
<a name="ln1327">                                              (data-&gt;colorstops[tab])[k].color);</a>
<a name="ln1328">    dtgtk_gradient_slider_multivalue_set_stop(data-&gt;upper_slider, (data-&gt;colorstops[tab])[k].stoppoint,</a>
<a name="ln1329">                                              (data-&gt;colorstops[tab])[k].color);</a>
<a name="ln1330">  }</a>
<a name="ln1331"> </a>
<a name="ln1332">  dtgtk_gradient_slider_multivalue_set_increment(data-&gt;lower_slider, data-&gt;increments[tab]);</a>
<a name="ln1333">  dtgtk_gradient_slider_multivalue_set_increment(data-&gt;upper_slider, data-&gt;increments[tab]);</a>
<a name="ln1334"> </a>
<a name="ln1335">  darktable.gui-&gt;reset = reset;</a>
<a name="ln1336">}</a>
<a name="ln1337"> </a>
<a name="ln1338"> </a>
<a name="ln1339">void dt_iop_gui_init_blendif(GtkBox *blendw, dt_iop_module_t *module)</a>
<a name="ln1340">{</a>
<a name="ln1341">  dt_iop_gui_blend_data_t *bd = (dt_iop_gui_blend_data_t *)module-&gt;blend_data;</a>
<a name="ln1342"> </a>
<a name="ln1343">  bd-&gt;blendif_box = GTK_BOX(gtk_box_new(GTK_ORIENTATION_VERTICAL, DT_BAUHAUS_SPACE));</a>
<a name="ln1344">  // add event box so that one can click into the area to get help for parametric masks</a>
<a name="ln1345">  GtkWidget* event_box = gtk_event_box_new();</a>
<a name="ln1346">  dt_gui_add_help_link(GTK_WIDGET(event_box), &quot;parametric_mask.html&quot;);</a>
<a name="ln1347">  gtk_container_add(GTK_CONTAINER(blendw), event_box);</a>
<a name="ln1348"> </a>
<a name="ln1349">  /* create and add blendif support if module supports it */</a>
<a name="ln1350">  if(bd-&gt;blendif_support)</a>
<a name="ln1351">  {</a>
<a name="ln1352">    char *Lab_labels[] = { &quot;  L  &quot;, &quot;  a  &quot;, &quot;  b  &quot;, &quot; C &quot;, &quot; h &quot; };</a>
<a name="ln1353">    char *Lab_tooltips[]</a>
<a name="ln1354">        = { _(&quot;sliders for L channel&quot;), _(&quot;sliders for a channel&quot;), _(&quot;sliders for b channel&quot;),</a>
<a name="ln1355">            _(&quot;sliders for chroma channel (of LCh)&quot;), _(&quot;sliders for hue channel (of LCh)&quot;) };</a>
<a name="ln1356">    char *rgb_labels[] = { _(&quot; g &quot;), _(&quot; R &quot;), _(&quot; G &quot;), _(&quot; B &quot;), _(&quot; H &quot;), _(&quot; S &quot;), _(&quot; L &quot;) };</a>
<a name="ln1357">    char *rgb_tooltips[]</a>
<a name="ln1358">        = { _(&quot;sliders for gray value&quot;), _(&quot;sliders for red channel&quot;), _(&quot;sliders for green channel&quot;),</a>
<a name="ln1359">            _(&quot;sliders for blue channel&quot;), _(&quot;sliders for hue channel (of HSL)&quot;),</a>
<a name="ln1360">            _(&quot;sliders for chroma channel (of HSL)&quot;), _(&quot;sliders for value channel (of HSL)&quot;) };</a>
<a name="ln1361"> </a>
<a name="ln1362">    char *ttinput = _(&quot;adjustment based on input received by this module:\n* range defined by upper markers: &quot;</a>
<a name="ln1363">                      &quot;blend fully\n* range defined by lower markers: do not blend at all\n* range between &quot;</a>
<a name="ln1364">                      &quot;adjacent upper/lower markers: blend gradually&quot;);</a>
<a name="ln1365"> </a>
<a name="ln1366">    char *ttoutput = _(&quot;adjustment based on unblended output of this module:\n* range defined by upper &quot;</a>
<a name="ln1367">                       &quot;markers: blend fully\n* range defined by lower markers: do not blend at all\n* range &quot;</a>
<a name="ln1368">                       &quot;between adjacent upper/lower markers: blend gradually&quot;);</a>
<a name="ln1369"> </a>
<a name="ln1370">    bd-&gt;tab = 0;</a>
<a name="ln1371">    const int bs = DT_PIXEL_APPLY_DPI(14);</a>
<a name="ln1372"> </a>
<a name="ln1373">    int maxchannels = 0;</a>
<a name="ln1374">    char **labels = NULL;</a>
<a name="ln1375">    char **tooltips = NULL;</a>
<a name="ln1376"> </a>
<a name="ln1377">    switch(bd-&gt;csp)</a>
<a name="ln1378">    {</a>
<a name="ln1379">      case iop_cs_Lab:</a>
<a name="ln1380">        maxchannels = 5;</a>
<a name="ln1381">        labels = Lab_labels;</a>
<a name="ln1382">        tooltips = Lab_tooltips;</a>
<a name="ln1383">        bd-&gt;scale_print[0] = _blendif_scale_print_L;</a>
<a name="ln1384">        bd-&gt;scale_print[1] = _blendif_scale_print_ab;</a>
<a name="ln1385">        bd-&gt;scale_print[2] = _blendif_scale_print_ab;</a>
<a name="ln1386">        bd-&gt;scale_print[3] = _blendif_scale_print_default;</a>
<a name="ln1387">        bd-&gt;scale_print[4] = _blendif_scale_print_hue;</a>
<a name="ln1388">        bd-&gt;increments[0] = 1.0f / 100.0f;</a>
<a name="ln1389">        bd-&gt;increments[1] = 1.0f / 256.0f;</a>
<a name="ln1390">        bd-&gt;increments[2] = 1.0f / 256.0f;</a>
<a name="ln1391">        bd-&gt;increments[3] = 1.0f / 100.0f;</a>
<a name="ln1392">        bd-&gt;increments[4] = 1.0f / 360.0f;</a>
<a name="ln1393">        bd-&gt;channels[0][0] = DEVELOP_BLENDIF_L_in;</a>
<a name="ln1394">        bd-&gt;channels[0][1] = DEVELOP_BLENDIF_L_out;</a>
<a name="ln1395">        bd-&gt;channels[1][0] = DEVELOP_BLENDIF_A_in;</a>
<a name="ln1396">        bd-&gt;channels[1][1] = DEVELOP_BLENDIF_A_out;</a>
<a name="ln1397">        bd-&gt;channels[2][0] = DEVELOP_BLENDIF_B_in;</a>
<a name="ln1398">        bd-&gt;channels[2][1] = DEVELOP_BLENDIF_B_out;</a>
<a name="ln1399">        bd-&gt;channels[3][0] = DEVELOP_BLENDIF_C_in;</a>
<a name="ln1400">        bd-&gt;channels[3][1] = DEVELOP_BLENDIF_C_out;</a>
<a name="ln1401">        bd-&gt;channels[4][0] = DEVELOP_BLENDIF_h_in;</a>
<a name="ln1402">        bd-&gt;channels[4][1] = DEVELOP_BLENDIF_h_out;</a>
<a name="ln1403">        bd-&gt;display_channel[0][0] = DT_DEV_PIXELPIPE_DISPLAY_L;</a>
<a name="ln1404">        bd-&gt;display_channel[0][1] = DT_DEV_PIXELPIPE_DISPLAY_L | DT_DEV_PIXELPIPE_DISPLAY_OUTPUT;</a>
<a name="ln1405">        bd-&gt;display_channel[1][0] = DT_DEV_PIXELPIPE_DISPLAY_a;</a>
<a name="ln1406">        bd-&gt;display_channel[1][1] = DT_DEV_PIXELPIPE_DISPLAY_a | DT_DEV_PIXELPIPE_DISPLAY_OUTPUT;</a>
<a name="ln1407">        bd-&gt;display_channel[2][0] = DT_DEV_PIXELPIPE_DISPLAY_b;</a>
<a name="ln1408">        bd-&gt;display_channel[2][1] = DT_DEV_PIXELPIPE_DISPLAY_b | DT_DEV_PIXELPIPE_DISPLAY_OUTPUT;</a>
<a name="ln1409">        bd-&gt;display_channel[3][0] = DT_DEV_PIXELPIPE_DISPLAY_LCH_C;</a>
<a name="ln1410">        bd-&gt;display_channel[3][1] = DT_DEV_PIXELPIPE_DISPLAY_LCH_C | DT_DEV_PIXELPIPE_DISPLAY_OUTPUT;</a>
<a name="ln1411">        bd-&gt;display_channel[4][0] = DT_DEV_PIXELPIPE_DISPLAY_LCH_h;</a>
<a name="ln1412">        bd-&gt;display_channel[4][1] = DT_DEV_PIXELPIPE_DISPLAY_LCH_h | DT_DEV_PIXELPIPE_DISPLAY_OUTPUT;</a>
<a name="ln1413">        bd-&gt;colorstops[0] = _gradient_L;</a>
<a name="ln1414">        bd-&gt;numberstops[0] = sizeof(_gradient_L) / sizeof(dt_iop_gui_blendif_colorstop_t);</a>
<a name="ln1415">        bd-&gt;colorstops[1] = _gradient_a;</a>
<a name="ln1416">        bd-&gt;numberstops[1] = sizeof(_gradient_a) / sizeof(dt_iop_gui_blendif_colorstop_t);</a>
<a name="ln1417">        bd-&gt;colorstops[2] = _gradient_b;</a>
<a name="ln1418">        bd-&gt;numberstops[2] = sizeof(_gradient_b) / sizeof(dt_iop_gui_blendif_colorstop_t);</a>
<a name="ln1419">        bd-&gt;colorstops[3] = _gradient_chroma;</a>
<a name="ln1420">        bd-&gt;numberstops[3] = sizeof(_gradient_chroma) / sizeof(dt_iop_gui_blendif_colorstop_t);</a>
<a name="ln1421">        bd-&gt;colorstops[4] = _gradient_hue;</a>
<a name="ln1422">        bd-&gt;numberstops[4] = sizeof(_gradient_hue) / sizeof(dt_iop_gui_blendif_colorstop_t);</a>
<a name="ln1423">        break;</a>
<a name="ln1424">      case iop_cs_rgb:</a>
<a name="ln1425">        maxchannels = 7;</a>
<a name="ln1426">        labels = rgb_labels;</a>
<a name="ln1427">        tooltips = rgb_tooltips;</a>
<a name="ln1428">        bd-&gt;scale_print[0] = _blendif_scale_print_rgb;</a>
<a name="ln1429">        bd-&gt;scale_print[1] = _blendif_scale_print_rgb;</a>
<a name="ln1430">        bd-&gt;scale_print[2] = _blendif_scale_print_rgb;</a>
<a name="ln1431">        bd-&gt;scale_print[3] = _blendif_scale_print_rgb;</a>
<a name="ln1432">        bd-&gt;scale_print[4] = _blendif_scale_print_hue;</a>
<a name="ln1433">        bd-&gt;scale_print[5] = _blendif_scale_print_default;</a>
<a name="ln1434">        bd-&gt;scale_print[6] = _blendif_scale_print_L;</a>
<a name="ln1435">        bd-&gt;increments[0] = 1.0f / 255.0f;</a>
<a name="ln1436">        bd-&gt;increments[1] = 1.0f / 255.0f;</a>
<a name="ln1437">        bd-&gt;increments[2] = 1.0f / 255.0f;</a>
<a name="ln1438">        bd-&gt;increments[3] = 1.0f / 255.0f;</a>
<a name="ln1439">        bd-&gt;increments[4] = 1.0f / 360.0f;</a>
<a name="ln1440">        bd-&gt;increments[5] = 1.0f / 100.0f;</a>
<a name="ln1441">        bd-&gt;increments[6] = 1.0f / 100.0f;</a>
<a name="ln1442">        bd-&gt;channels[0][0] = DEVELOP_BLENDIF_GRAY_in;</a>
<a name="ln1443">        bd-&gt;channels[0][1] = DEVELOP_BLENDIF_GRAY_out;</a>
<a name="ln1444">        bd-&gt;channels[1][0] = DEVELOP_BLENDIF_RED_in;</a>
<a name="ln1445">        bd-&gt;channels[1][1] = DEVELOP_BLENDIF_RED_out;</a>
<a name="ln1446">        bd-&gt;channels[2][0] = DEVELOP_BLENDIF_GREEN_in;</a>
<a name="ln1447">        bd-&gt;channels[2][1] = DEVELOP_BLENDIF_GREEN_out;</a>
<a name="ln1448">        bd-&gt;channels[3][0] = DEVELOP_BLENDIF_BLUE_in;</a>
<a name="ln1449">        bd-&gt;channels[3][1] = DEVELOP_BLENDIF_BLUE_out;</a>
<a name="ln1450">        bd-&gt;channels[4][0] = DEVELOP_BLENDIF_H_in;</a>
<a name="ln1451">        bd-&gt;channels[4][1] = DEVELOP_BLENDIF_H_out;</a>
<a name="ln1452">        bd-&gt;channels[5][0] = DEVELOP_BLENDIF_S_in;</a>
<a name="ln1453">        bd-&gt;channels[5][1] = DEVELOP_BLENDIF_S_out;</a>
<a name="ln1454">        bd-&gt;channels[6][0] = DEVELOP_BLENDIF_l_in;</a>
<a name="ln1455">        bd-&gt;channels[6][1] = DEVELOP_BLENDIF_l_out;</a>
<a name="ln1456">        bd-&gt;display_channel[0][0] = DT_DEV_PIXELPIPE_DISPLAY_GRAY;</a>
<a name="ln1457">        bd-&gt;display_channel[0][1] = DT_DEV_PIXELPIPE_DISPLAY_GRAY | DT_DEV_PIXELPIPE_DISPLAY_OUTPUT;</a>
<a name="ln1458">        bd-&gt;display_channel[1][0] = DT_DEV_PIXELPIPE_DISPLAY_R;</a>
<a name="ln1459">        bd-&gt;display_channel[1][1] = DT_DEV_PIXELPIPE_DISPLAY_R | DT_DEV_PIXELPIPE_DISPLAY_OUTPUT;</a>
<a name="ln1460">        bd-&gt;display_channel[2][0] = DT_DEV_PIXELPIPE_DISPLAY_G;</a>
<a name="ln1461">        bd-&gt;display_channel[2][1] = DT_DEV_PIXELPIPE_DISPLAY_G | DT_DEV_PIXELPIPE_DISPLAY_OUTPUT;</a>
<a name="ln1462">        bd-&gt;display_channel[3][0] = DT_DEV_PIXELPIPE_DISPLAY_B;</a>
<a name="ln1463">        bd-&gt;display_channel[3][1] = DT_DEV_PIXELPIPE_DISPLAY_B | DT_DEV_PIXELPIPE_DISPLAY_OUTPUT;</a>
<a name="ln1464">        bd-&gt;display_channel[4][0] = DT_DEV_PIXELPIPE_DISPLAY_HSL_H;</a>
<a name="ln1465">        bd-&gt;display_channel[4][1] = DT_DEV_PIXELPIPE_DISPLAY_HSL_H | DT_DEV_PIXELPIPE_DISPLAY_OUTPUT;</a>
<a name="ln1466">        bd-&gt;display_channel[5][0] = DT_DEV_PIXELPIPE_DISPLAY_HSL_S;</a>
<a name="ln1467">        bd-&gt;display_channel[5][1] = DT_DEV_PIXELPIPE_DISPLAY_HSL_S | DT_DEV_PIXELPIPE_DISPLAY_OUTPUT;</a>
<a name="ln1468">        bd-&gt;display_channel[6][0] = DT_DEV_PIXELPIPE_DISPLAY_HSL_l;</a>
<a name="ln1469">        bd-&gt;display_channel[6][1] = DT_DEV_PIXELPIPE_DISPLAY_HSL_l | DT_DEV_PIXELPIPE_DISPLAY_OUTPUT;</a>
<a name="ln1470">        bd-&gt;colorstops[0] = _gradient_gray;</a>
<a name="ln1471">        bd-&gt;numberstops[0] = sizeof(_gradient_gray) / sizeof(dt_iop_gui_blendif_colorstop_t);</a>
<a name="ln1472">        bd-&gt;colorstops[1] = _gradient_red;</a>
<a name="ln1473">        bd-&gt;numberstops[1] = sizeof(_gradient_red) / sizeof(dt_iop_gui_blendif_colorstop_t);</a>
<a name="ln1474">        bd-&gt;colorstops[2] = _gradient_green;</a>
<a name="ln1475">        bd-&gt;numberstops[2] = sizeof(_gradient_green) / sizeof(dt_iop_gui_blendif_colorstop_t);</a>
<a name="ln1476">        bd-&gt;colorstops[3] = _gradient_blue;</a>
<a name="ln1477">        bd-&gt;numberstops[3] = sizeof(_gradient_blue) / sizeof(dt_iop_gui_blendif_colorstop_t);</a>
<a name="ln1478">        bd-&gt;colorstops[4] = _gradient_HUE;</a>
<a name="ln1479">        bd-&gt;numberstops[4] = sizeof(_gradient_HUE) / sizeof(dt_iop_gui_blendif_colorstop_t);</a>
<a name="ln1480">        bd-&gt;colorstops[5] = _gradient_chroma;</a>
<a name="ln1481">        bd-&gt;numberstops[5] = sizeof(_gradient_chroma) / sizeof(dt_iop_gui_blendif_colorstop_t);</a>
<a name="ln1482">        bd-&gt;colorstops[6] = _gradient_gray;</a>
<a name="ln1483">        bd-&gt;numberstops[6] = sizeof(_gradient_gray) / sizeof(dt_iop_gui_blendif_colorstop_t);</a>
<a name="ln1484">        break;</a>
<a name="ln1485">      default:</a>
<a name="ln1486">        assert(FALSE); // blendif not supported for RAW, which is already caught upstream; we should not get</a>
<a name="ln1487">                       // here</a>
<a name="ln1488">    }</a>
<a name="ln1489"> </a>
<a name="ln1490">    GtkWidget *uplabel = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0);</a>
<a name="ln1491">    GtkWidget *lowlabel = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0);</a>
<a name="ln1492">    GtkWidget *upslider = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, DT_PIXEL_APPLY_DPI(5));</a>
<a name="ln1493">    GtkWidget *lowslider = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, DT_PIXEL_APPLY_DPI(5));</a>
<a name="ln1494">    GtkWidget *notebook = gtk_box_new(GTK_ORIENTATION_VERTICAL, 0);</a>
<a name="ln1495">    GtkWidget *header = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, DT_PIXEL_APPLY_DPI(5));</a>
<a name="ln1496"> </a>
<a name="ln1497">    bd-&gt;channel_tabs = GTK_NOTEBOOK(gtk_notebook_new());</a>
<a name="ln1498"> </a>
<a name="ln1499">    for(int ch = 0; ch &lt; maxchannels; ch++)</a>
<a name="ln1500">    {</a>
<a name="ln1501">      gtk_notebook_append_page(GTK_NOTEBOOK(bd-&gt;channel_tabs),</a>
<a name="ln1502">                               GTK_WIDGET(gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0)),</a>
<a name="ln1503">                               gtk_label_new(labels[ch]));</a>
<a name="ln1504">      gtk_widget_set_tooltip_text(gtk_notebook_get_tab_label(bd-&gt;channel_tabs,</a>
<a name="ln1505">                                                             gtk_notebook_get_nth_page(bd-&gt;channel_tabs, -1)),</a>
<a name="ln1506">                                  tooltips[ch]);</a>
<a name="ln1507">    }</a>
<a name="ln1508"> </a>
<a name="ln1509">    gtk_widget_show_all(GTK_WIDGET(gtk_notebook_get_nth_page(bd-&gt;channel_tabs, bd-&gt;tab)));</a>
<a name="ln1510">    gtk_notebook_set_current_page(GTK_NOTEBOOK(bd-&gt;channel_tabs), bd-&gt;tab);</a>
<a name="ln1511">    gtk_notebook_set_scrollable(bd-&gt;channel_tabs, TRUE);</a>
<a name="ln1512"> </a>
<a name="ln1513">    gtk_box_pack_start(GTK_BOX(notebook), GTK_WIDGET(bd-&gt;channel_tabs), FALSE, FALSE, 0);</a>
<a name="ln1514"> </a>
<a name="ln1515">    bd-&gt;colorpicker</a>
<a name="ln1516">        = dtgtk_togglebutton_new(dtgtk_cairo_paint_colorpicker, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln1517">    gtk_widget_set_tooltip_text(bd-&gt;colorpicker, _(&quot;pick GUI color from image\nctrl+click to select an area&quot;));</a>
<a name="ln1518">    gtk_widget_set_size_request(GTK_WIDGET(bd-&gt;colorpicker), bs, bs);</a>
<a name="ln1519"> </a>
<a name="ln1520">    bd-&gt;colorpicker_set_values = dtgtk_togglebutton_new(dtgtk_cairo_paint_colorpicker_set_values,</a>
<a name="ln1521">                                                        CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln1522">    gtk_widget_set_tooltip_text(bd-&gt;colorpicker_set_values, _(&quot;set the range based on an area from the image\n&quot;</a>
<a name="ln1523">        &quot;click+drag to use the input image\nctrl+click + drag to use the output image&quot;));</a>
<a name="ln1524">    gtk_widget_set_size_request(GTK_WIDGET(bd-&gt;colorpicker_set_values), bs, bs);</a>
<a name="ln1525"> </a>
<a name="ln1526">    GtkWidget *res = dtgtk_button_new(dtgtk_cairo_paint_reset, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln1527">    gtk_widget_set_tooltip_text(res, _(&quot;reset blend mask settings&quot;));</a>
<a name="ln1528">    gtk_widget_set_size_request(res, bs, bs);</a>
<a name="ln1529"> </a>
<a name="ln1530">    GtkWidget *inv = dtgtk_button_new(dtgtk_cairo_paint_invert, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln1531">    gtk_widget_set_tooltip_text(inv, _(&quot;invert all channel's polarities&quot;));</a>
<a name="ln1532">    gtk_widget_set_size_request(inv, bs, bs);</a>
<a name="ln1533"> </a>
<a name="ln1534">    gtk_box_pack_start(GTK_BOX(header), GTK_WIDGET(notebook), TRUE, TRUE, 0);</a>
<a name="ln1535">    gtk_box_pack_end(GTK_BOX(header), GTK_WIDGET(res), FALSE, FALSE, 0);</a>
<a name="ln1536">    gtk_box_pack_end(GTK_BOX(header), GTK_WIDGET(inv), FALSE, FALSE, 0);</a>
<a name="ln1537">    gtk_box_pack_end(GTK_BOX(header), GTK_WIDGET(bd-&gt;colorpicker_set_values), FALSE, FALSE, 0);</a>
<a name="ln1538">    gtk_box_pack_end(GTK_BOX(header), GTK_WIDGET(bd-&gt;colorpicker), FALSE, FALSE, 0);</a>
<a name="ln1539"> </a>
<a name="ln1540">    bd-&gt;lower_slider = DTGTK_GRADIENT_SLIDER_MULTIVALUE(dtgtk_gradient_slider_multivalue_new(4));</a>
<a name="ln1541">    bd-&gt;upper_slider = DTGTK_GRADIENT_SLIDER_MULTIVALUE(dtgtk_gradient_slider_multivalue_new(4));</a>
<a name="ln1542"> </a>
<a name="ln1543">    bd-&gt;lower_polarity</a>
<a name="ln1544">        = dtgtk_togglebutton_new(dtgtk_cairo_paint_plusminus, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln1545">    gtk_widget_set_tooltip_text(bd-&gt;lower_polarity, _(&quot;toggle polarity. best seen by enabling 'display mask'&quot;));</a>
<a name="ln1546"> </a>
<a name="ln1547">    bd-&gt;upper_polarity</a>
<a name="ln1548">        = dtgtk_togglebutton_new(dtgtk_cairo_paint_plusminus, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln1549">    gtk_widget_set_tooltip_text(bd-&gt;upper_polarity, _(&quot;toggle polarity. best seen by enabling 'display mask'&quot;));</a>
<a name="ln1550"> </a>
<a name="ln1551">    gtk_box_pack_start(GTK_BOX(upslider), GTK_WIDGET(bd-&gt;upper_slider), TRUE, TRUE, 0);</a>
<a name="ln1552">    gtk_box_pack_end(GTK_BOX(upslider), GTK_WIDGET(bd-&gt;upper_polarity), FALSE, FALSE, 0);</a>
<a name="ln1553"> </a>
<a name="ln1554">    gtk_box_pack_start(GTK_BOX(lowslider), GTK_WIDGET(bd-&gt;lower_slider), TRUE, TRUE, 0);</a>
<a name="ln1555">    gtk_box_pack_end(GTK_BOX(lowslider), GTK_WIDGET(bd-&gt;lower_polarity), FALSE, FALSE, 0);</a>
<a name="ln1556"> </a>
<a name="ln1557"> </a>
<a name="ln1558">    GtkWidget *output = gtk_label_new(_(&quot;output&quot;));</a>
<a name="ln1559">    bd-&gt;upper_picker_label = GTK_LABEL(gtk_label_new(&quot;&quot;));</a>
<a name="ln1560">    gtk_box_pack_start(GTK_BOX(uplabel), GTK_WIDGET(output), FALSE, FALSE, 0);</a>
<a name="ln1561">    gtk_box_pack_start(GTK_BOX(uplabel), GTK_WIDGET(bd-&gt;upper_picker_label), TRUE, TRUE, 0);</a>
<a name="ln1562">    for(int k = 0; k &lt; 4; k++)</a>
<a name="ln1563">    {</a>
<a name="ln1564">      bd-&gt;upper_label[k] = GTK_LABEL(gtk_label_new(NULL));</a>
<a name="ln1565">      gtk_label_set_width_chars(bd-&gt;upper_label[k], 5);</a>
<a name="ln1566">      gtk_box_pack_start(GTK_BOX(uplabel), GTK_WIDGET(bd-&gt;upper_label[k]), FALSE, FALSE, 0);</a>
<a name="ln1567">    }</a>
<a name="ln1568"> </a>
<a name="ln1569">    GtkWidget *input = gtk_label_new(_(&quot;input&quot;));</a>
<a name="ln1570">    bd-&gt;lower_picker_label = GTK_LABEL(gtk_label_new(&quot;&quot;));</a>
<a name="ln1571">    gtk_box_pack_start(GTK_BOX(lowlabel), GTK_WIDGET(input), FALSE, FALSE, 0);</a>
<a name="ln1572">    gtk_box_pack_start(GTK_BOX(lowlabel), GTK_WIDGET(bd-&gt;lower_picker_label), TRUE, TRUE, 0);</a>
<a name="ln1573">    for(int k = 0; k &lt; 4; k++)</a>
<a name="ln1574">    {</a>
<a name="ln1575">      bd-&gt;lower_label[k] = GTK_LABEL(gtk_label_new(NULL));</a>
<a name="ln1576">      gtk_label_set_width_chars(bd-&gt;lower_label[k], 5);</a>
<a name="ln1577">      gtk_box_pack_start(GTK_BOX(lowlabel), GTK_WIDGET(bd-&gt;lower_label[k]), FALSE, FALSE, 0);</a>
<a name="ln1578">    }</a>
<a name="ln1579"> </a>
<a name="ln1580">    gtk_widget_set_tooltip_text(GTK_WIDGET(bd-&gt;lower_slider), _(&quot;double click to reset&quot;));</a>
<a name="ln1581">    gtk_widget_set_tooltip_text(GTK_WIDGET(bd-&gt;upper_slider), _(&quot;double click to reset&quot;));</a>
<a name="ln1582">    gtk_widget_set_tooltip_text(output, ttoutput);</a>
<a name="ln1583">    gtk_widget_set_tooltip_text(input, ttinput);</a>
<a name="ln1584"> </a>
<a name="ln1585">    g_signal_connect(G_OBJECT(bd-&gt;lower_slider), &quot;draw&quot;, G_CALLBACK(_blendop_blendif_draw), module);</a>
<a name="ln1586"> </a>
<a name="ln1587">    g_signal_connect(G_OBJECT(bd-&gt;upper_slider), &quot;draw&quot;, G_CALLBACK(_blendop_blendif_draw), module);</a>
<a name="ln1588"> </a>
<a name="ln1589">    g_signal_connect(G_OBJECT(bd-&gt;channel_tabs), &quot;switch_page&quot;, G_CALLBACK(_blendop_blendif_tab_switch), bd);</a>
<a name="ln1590"> </a>
<a name="ln1591">    g_signal_connect(G_OBJECT(bd-&gt;upper_slider), &quot;value-changed&quot;, G_CALLBACK(_blendop_blendif_upper_callback),</a>
<a name="ln1592">                     bd);</a>
<a name="ln1593"> </a>
<a name="ln1594">    g_signal_connect(G_OBJECT(bd-&gt;lower_slider), &quot;value-changed&quot;, G_CALLBACK(_blendop_blendif_lower_callback),</a>
<a name="ln1595">                     bd);</a>
<a name="ln1596"> </a>
<a name="ln1597">    g_signal_connect(G_OBJECT(bd-&gt;lower_slider), &quot;leave-notify-event&quot;, G_CALLBACK(_blendop_blendif_leave), module);</a>
<a name="ln1598"> </a>
<a name="ln1599">    g_signal_connect(G_OBJECT(bd-&gt;upper_slider), &quot;leave-notify-event&quot;, G_CALLBACK(_blendop_blendif_leave), module);</a>
<a name="ln1600"> </a>
<a name="ln1601">    g_signal_connect(G_OBJECT(bd-&gt;lower_slider), &quot;enter-notify-event&quot;, G_CALLBACK(_blendop_blendif_enter), module);</a>
<a name="ln1602"> </a>
<a name="ln1603">    g_signal_connect(G_OBJECT(bd-&gt;upper_slider), &quot;enter-notify-event&quot;, G_CALLBACK(_blendop_blendif_enter), module);</a>
<a name="ln1604"> </a>
<a name="ln1605">    g_signal_connect(G_OBJECT(bd-&gt;colorpicker), &quot;button-press-event&quot;, G_CALLBACK(_blendop_blendif_color_picker_callback_button_press), module);</a>
<a name="ln1606"> </a>
<a name="ln1607">    g_signal_connect(G_OBJECT(bd-&gt;colorpicker_set_values), &quot;button-press-event&quot;, G_CALLBACK(_blendop_blendif_color_picker_callback_button_press), module);</a>
<a name="ln1608"> </a>
<a name="ln1609">    g_signal_connect(G_OBJECT(res), &quot;clicked&quot;, G_CALLBACK(_blendop_blendif_reset), module);</a>
<a name="ln1610"> </a>
<a name="ln1611">    g_signal_connect(G_OBJECT(inv), &quot;clicked&quot;, G_CALLBACK(_blendop_blendif_invert), module);</a>
<a name="ln1612"> </a>
<a name="ln1613">    g_signal_connect(G_OBJECT(bd-&gt;lower_polarity), &quot;toggled&quot;, G_CALLBACK(_blendop_blendif_polarity_callback),</a>
<a name="ln1614">                     bd);</a>
<a name="ln1615"> </a>
<a name="ln1616">    g_signal_connect(G_OBJECT(bd-&gt;upper_polarity), &quot;toggled&quot;, G_CALLBACK(_blendop_blendif_polarity_callback),</a>
<a name="ln1617">                     bd);</a>
<a name="ln1618"> </a>
<a name="ln1619">    gtk_box_pack_start(GTK_BOX(bd-&gt;blendif_box), dt_ui_section_label_new(_(&quot;parametric mask&quot;)), TRUE, TRUE, 0);</a>
<a name="ln1620">    gtk_box_pack_start(GTK_BOX(bd-&gt;blendif_box), GTK_WIDGET(header), TRUE, FALSE, 0);</a>
<a name="ln1621">    gtk_box_pack_start(GTK_BOX(bd-&gt;blendif_box), GTK_WIDGET(uplabel), TRUE, FALSE, 0);</a>
<a name="ln1622">    gtk_box_pack_start(GTK_BOX(bd-&gt;blendif_box), GTK_WIDGET(upslider), TRUE, FALSE, 0);</a>
<a name="ln1623">    gtk_box_pack_start(GTK_BOX(bd-&gt;blendif_box), GTK_WIDGET(lowlabel), TRUE, FALSE, 0);</a>
<a name="ln1624">    gtk_box_pack_start(GTK_BOX(bd-&gt;blendif_box), GTK_WIDGET(lowslider), TRUE, FALSE, 0);</a>
<a name="ln1625"> </a>
<a name="ln1626">    dt_iop_init_blend_picker(&amp;bd-&gt;color_picker,</a>
<a name="ln1627">                       module,</a>
<a name="ln1628">                       DT_COLOR_PICKER_POINT_AREA,</a>
<a name="ln1629">                       _iop_color_picker_get_set,</a>
<a name="ln1630">                       _iop_color_picker_apply,</a>
<a name="ln1631">                       _iop_color_picker_update);</a>
<a name="ln1632"> </a>
<a name="ln1633">    bd-&gt;blendif_inited = 1;</a>
<a name="ln1634">  }</a>
<a name="ln1635"> </a>
<a name="ln1636">  gtk_container_add(GTK_CONTAINER(event_box), GTK_WIDGET(bd-&gt;blendif_box));</a>
<a name="ln1637">}</a>
<a name="ln1638"> </a>
<a name="ln1639">void dt_iop_gui_update_masks(dt_iop_module_t *module)</a>
<a name="ln1640">{</a>
<a name="ln1641">  dt_iop_gui_blend_data_t *bd = (dt_iop_gui_blend_data_t *)module-&gt;blend_data;</a>
<a name="ln1642">  dt_develop_blend_params_t *bp = module-&gt;blend_params;</a>
<a name="ln1643"> </a>
<a name="ln1644">  if(!bd || !bd-&gt;masks_support || !bd-&gt;masks_inited) return;</a>
<a name="ln1645"> </a>
<a name="ln1646">  /* update masks state */</a>
<a name="ln1647">  dt_masks_form_t *grp = dt_masks_get_from_id(darktable.develop, module-&gt;blend_params-&gt;mask_id);</a>
<a name="ln1648">  dt_bauhaus_combobox_clear(bd-&gt;masks_combo);</a>
<a name="ln1649">  if(grp &amp;&amp; (grp-&gt;type &amp; DT_MASKS_GROUP) &amp;&amp; g_list_length(grp-&gt;points) &gt; 0)</a>
<a name="ln1650">  {</a>
<a name="ln1651">    char txt[512];</a>
<a name="ln1652">    guint n = g_list_length(grp-&gt;points);</a>
<a name="ln1653">    snprintf(txt, sizeof(txt), ngettext(&quot;%d shape used&quot;, &quot;%d shapes used&quot;, n), n);</a>
<a name="ln1654">    dt_bauhaus_combobox_add(bd-&gt;masks_combo, txt);</a>
<a name="ln1655">  }</a>
<a name="ln1656">  else</a>
<a name="ln1657">  {</a>
<a name="ln1658">    dt_bauhaus_combobox_add(bd-&gt;masks_combo, _(&quot;no mask used&quot;));</a>
<a name="ln1659">    bd-&gt;masks_shown = DT_MASKS_EDIT_OFF;</a>
<a name="ln1660">    // reset the gui</a>
<a name="ln1661">    dt_masks_set_edit_mode(module, DT_MASKS_EDIT_OFF);</a>
<a name="ln1662">  }</a>
<a name="ln1663">  dt_bauhaus_combobox_set(bd-&gt;masks_combo, 0);</a>
<a name="ln1664"> </a>
<a name="ln1665">  gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_edit), bd-&gt;masks_shown != DT_MASKS_EDIT_OFF);</a>
<a name="ln1666">  gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_polarity),</a>
<a name="ln1667">                               bp-&gt;mask_combine &amp; DEVELOP_COMBINE_MASKS_POS);</a>
<a name="ln1668"> </a>
<a name="ln1669">  // update buttons status</a>
<a name="ln1670">  int b1 = 0, b2 = 0, b3 = 0, b4 = 0, b5 = 0;</a>
<a name="ln1671">  if(module-&gt;dev-&gt;form_gui &amp;&amp; module-&gt;dev-&gt;form_visible &amp;&amp; module-&gt;dev-&gt;form_gui-&gt;creation</a>
<a name="ln1672">     &amp;&amp; module-&gt;dev-&gt;form_gui-&gt;creation_module == module)</a>
<a name="ln1673">  {</a>
<a name="ln1674">    if(module-&gt;dev-&gt;form_visible-&gt;type &amp; DT_MASKS_CIRCLE)</a>
<a name="ln1675">      b1 = 1;</a>
<a name="ln1676">    else if(module-&gt;dev-&gt;form_visible-&gt;type &amp; DT_MASKS_PATH)</a>
<a name="ln1677">      b2 = 1;</a>
<a name="ln1678">    else if(module-&gt;dev-&gt;form_visible-&gt;type &amp; DT_MASKS_GRADIENT)</a>
<a name="ln1679">      b3 = 1;</a>
<a name="ln1680">    else if(module-&gt;dev-&gt;form_visible-&gt;type &amp; DT_MASKS_ELLIPSE)</a>
<a name="ln1681">      b4 = 1;</a>
<a name="ln1682">    else if(module-&gt;dev-&gt;form_visible-&gt;type &amp; DT_MASKS_BRUSH)</a>
<a name="ln1683">      b5 = 1;</a>
<a name="ln1684">  }</a>
<a name="ln1685">  gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_circle), b1);</a>
<a name="ln1686">  gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_path), b2);</a>
<a name="ln1687">  gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_gradient), b3);</a>
<a name="ln1688">  gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_ellipse), b4);</a>
<a name="ln1689">  gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_brush), b5);</a>
<a name="ln1690">}</a>
<a name="ln1691"> </a>
<a name="ln1692">void dt_iop_gui_init_masks(GtkBox *blendw, dt_iop_module_t *module)</a>
<a name="ln1693">{</a>
<a name="ln1694">  dt_iop_gui_blend_data_t *bd = (dt_iop_gui_blend_data_t *)module-&gt;blend_data;</a>
<a name="ln1695"> </a>
<a name="ln1696">  bd-&gt;masks_box = GTK_BOX(gtk_box_new(GTK_ORIENTATION_VERTICAL, DT_BAUHAUS_SPACE));</a>
<a name="ln1697">  // add event box so that one can click into the area to get help for drawn masks</a>
<a name="ln1698">  GtkWidget* event_box = gtk_event_box_new();</a>
<a name="ln1699">  dt_gui_add_help_link(GTK_WIDGET(event_box), &quot;drawn_mask.html&quot;);</a>
<a name="ln1700">  gtk_container_add(GTK_CONTAINER(blendw), event_box);</a>
<a name="ln1701"> </a>
<a name="ln1702">  /* create and add masks support if module supports it */</a>
<a name="ln1703">  if(bd-&gt;masks_support)</a>
<a name="ln1704">  {</a>
<a name="ln1705">    const int bs = DT_PIXEL_APPLY_DPI(14);</a>
<a name="ln1706"> </a>
<a name="ln1707">    bd-&gt;masks_combo_ids = NULL;</a>
<a name="ln1708">    bd-&gt;masks_shown = DT_MASKS_EDIT_OFF;</a>
<a name="ln1709"> </a>
<a name="ln1710">    GtkWidget *hbox = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0);</a>
<a name="ln1711">    GtkWidget *abox = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0);</a>
<a name="ln1712"> </a>
<a name="ln1713">    bd-&gt;masks_combo = dt_bauhaus_combobox_new(module);</a>
<a name="ln1714">    dt_bauhaus_widget_set_label(bd-&gt;masks_combo, _(&quot;blend&quot;), _(&quot;drawn mask&quot;));</a>
<a name="ln1715">    dt_bauhaus_combobox_add(bd-&gt;masks_combo, _(&quot;no mask used&quot;));</a>
<a name="ln1716">    dt_bauhaus_combobox_set(bd-&gt;masks_combo, 0);</a>
<a name="ln1717">    g_signal_connect(G_OBJECT(bd-&gt;masks_combo), &quot;value-changed&quot;,</a>
<a name="ln1718">                     G_CALLBACK(dt_masks_iop_value_changed_callback), module);</a>
<a name="ln1719">    dt_bauhaus_combobox_add_populate_fct(bd-&gt;masks_combo, dt_masks_iop_combo_populate);</a>
<a name="ln1720">    gtk_box_pack_start(GTK_BOX(hbox), bd-&gt;masks_combo, TRUE, TRUE, 0);</a>
<a name="ln1721"> </a>
<a name="ln1722">    bd-&gt;masks_edit</a>
<a name="ln1723">        = dtgtk_togglebutton_new(dtgtk_cairo_paint_masks_eye, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln1724">    g_signal_connect(G_OBJECT(bd-&gt;masks_edit), &quot;button-press-event&quot;, G_CALLBACK(_blendop_masks_show_and_edit),</a>
<a name="ln1725">                     module);</a>
<a name="ln1726">    gtk_widget_set_tooltip_text(bd-&gt;masks_edit, _(&quot;show and edit mask elements&quot;));</a>
<a name="ln1727">    gtk_widget_set_size_request(GTK_WIDGET(bd-&gt;masks_edit), bs, bs);</a>
<a name="ln1728">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_edit), FALSE);</a>
<a name="ln1729">    gtk_box_pack_start(GTK_BOX(hbox), bd-&gt;masks_edit, FALSE, FALSE, 0);</a>
<a name="ln1730"> </a>
<a name="ln1731">    bd-&gt;masks_polarity</a>
<a name="ln1732">        = dtgtk_togglebutton_new(dtgtk_cairo_paint_plusminus, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln1733">    gtk_widget_set_tooltip_text(bd-&gt;masks_polarity, _(&quot;toggle polarity of drawn mask&quot;));</a>
<a name="ln1734">    g_signal_connect(G_OBJECT(bd-&gt;masks_polarity), &quot;toggled&quot;, G_CALLBACK(_blendop_masks_polarity_callback),</a>
<a name="ln1735">                     module);</a>
<a name="ln1736">    gtk_widget_set_size_request(GTK_WIDGET(bd-&gt;masks_polarity), bs, bs);</a>
<a name="ln1737">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_polarity), FALSE);</a>
<a name="ln1738">    gtk_box_pack_start(GTK_BOX(hbox), bd-&gt;masks_polarity, FALSE, FALSE, 0);</a>
<a name="ln1739"> </a>
<a name="ln1740">    bd-&gt;masks_gradient</a>
<a name="ln1741">        = dtgtk_togglebutton_new(dtgtk_cairo_paint_masks_gradient, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln1742">    g_signal_connect(G_OBJECT(bd-&gt;masks_gradient), &quot;button-press-event&quot;,</a>
<a name="ln1743">                     G_CALLBACK(_blendop_masks_add_gradient), module);</a>
<a name="ln1744">    gtk_widget_set_tooltip_text(bd-&gt;masks_gradient, _(&quot;add gradient&quot;));</a>
<a name="ln1745">    gtk_widget_set_size_request(GTK_WIDGET(bd-&gt;masks_gradient), bs, bs);</a>
<a name="ln1746">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_gradient), FALSE);</a>
<a name="ln1747">    gtk_box_pack_end(GTK_BOX(abox), bd-&gt;masks_gradient, FALSE, FALSE, 0);</a>
<a name="ln1748"> </a>
<a name="ln1749">    bd-&gt;masks_path</a>
<a name="ln1750">        = dtgtk_togglebutton_new(dtgtk_cairo_paint_masks_path, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln1751">    g_signal_connect(G_OBJECT(bd-&gt;masks_path), &quot;button-press-event&quot;, G_CALLBACK(_blendop_masks_add_path),</a>
<a name="ln1752">                     module);</a>
<a name="ln1753">    gtk_widget_set_tooltip_text(bd-&gt;masks_path, _(&quot;add path&quot;));</a>
<a name="ln1754">    gtk_widget_set_size_request(GTK_WIDGET(bd-&gt;masks_path), bs, bs);</a>
<a name="ln1755">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_path), FALSE);</a>
<a name="ln1756">    gtk_box_pack_end(GTK_BOX(abox), bd-&gt;masks_path, FALSE, FALSE, bs);</a>
<a name="ln1757"> </a>
<a name="ln1758">    bd-&gt;masks_ellipse</a>
<a name="ln1759">        = dtgtk_togglebutton_new(dtgtk_cairo_paint_masks_ellipse, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln1760">    g_signal_connect(G_OBJECT(bd-&gt;masks_ellipse), &quot;button-press-event&quot;,</a>
<a name="ln1761">                     G_CALLBACK(_blendop_masks_add_ellipse), module);</a>
<a name="ln1762">    gtk_widget_set_tooltip_text(bd-&gt;masks_ellipse, _(&quot;add ellipse&quot;));</a>
<a name="ln1763">    gtk_widget_set_size_request(GTK_WIDGET(bd-&gt;masks_ellipse), bs, bs);</a>
<a name="ln1764">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_ellipse), FALSE);</a>
<a name="ln1765">    gtk_box_pack_end(GTK_BOX(abox), bd-&gt;masks_ellipse, FALSE, FALSE, 0);</a>
<a name="ln1766"> </a>
<a name="ln1767">    bd-&gt;masks_circle</a>
<a name="ln1768">        = dtgtk_togglebutton_new(dtgtk_cairo_paint_masks_circle, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln1769">    g_signal_connect(G_OBJECT(bd-&gt;masks_circle), &quot;button-press-event&quot;, G_CALLBACK(_blendop_masks_add_circle),</a>
<a name="ln1770">                     module);</a>
<a name="ln1771">    gtk_widget_set_tooltip_text(bd-&gt;masks_circle, _(&quot;add circle&quot;));</a>
<a name="ln1772">    gtk_widget_set_size_request(GTK_WIDGET(bd-&gt;masks_circle), bs, bs);</a>
<a name="ln1773">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_circle), FALSE);</a>
<a name="ln1774">    gtk_box_pack_end(GTK_BOX(abox), bd-&gt;masks_circle, FALSE, FALSE, bs);</a>
<a name="ln1775"> </a>
<a name="ln1776">    bd-&gt;masks_brush</a>
<a name="ln1777">        = dtgtk_togglebutton_new(dtgtk_cairo_paint_masks_brush, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln1778">    g_signal_connect(G_OBJECT(bd-&gt;masks_brush), &quot;button-press-event&quot;, G_CALLBACK(_blendop_masks_add_brush),</a>
<a name="ln1779">                     module);</a>
<a name="ln1780">    gtk_widget_set_tooltip_text(bd-&gt;masks_brush, _(&quot;add brush&quot;));</a>
<a name="ln1781">    gtk_widget_set_size_request(GTK_WIDGET(bd-&gt;masks_brush), bs, bs);</a>
<a name="ln1782">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_brush), FALSE);</a>
<a name="ln1783">    gtk_box_pack_end(GTK_BOX(abox), bd-&gt;masks_brush, FALSE, FALSE, 0);</a>
<a name="ln1784"> </a>
<a name="ln1785"> </a>
<a name="ln1786">    gtk_box_pack_start(GTK_BOX(bd-&gt;masks_box), dt_ui_section_label_new(_(&quot;drawn mask&quot;)), TRUE, TRUE, 0);</a>
<a name="ln1787">    gtk_box_pack_start(GTK_BOX(bd-&gt;masks_box), GTK_WIDGET(hbox), TRUE, TRUE, 0);</a>
<a name="ln1788">    gtk_box_pack_start(GTK_BOX(bd-&gt;masks_box), GTK_WIDGET(abox), TRUE, TRUE, 0);</a>
<a name="ln1789"> </a>
<a name="ln1790">    bd-&gt;masks_inited = 1;</a>
<a name="ln1791">  }</a>
<a name="ln1792">  gtk_container_add(GTK_CONTAINER(event_box), GTK_WIDGET(bd-&gt;masks_box));</a>
<a name="ln1793">}</a>
<a name="ln1794"> </a>
<a name="ln1795">typedef struct raster_combo_entry_t</a>
<a name="ln1796">{</a>
<a name="ln1797">  dt_iop_module_t *module;</a>
<a name="ln1798">  int id;</a>
<a name="ln1799">} raster_combo_entry_t;</a>
<a name="ln1800"> </a>
<a name="ln1801">static void _raster_combo_populate(GtkWidget *w, struct dt_iop_module_t **m)</a>
<a name="ln1802">{</a>
<a name="ln1803">  dt_iop_module_t *module = *m;</a>
<a name="ln1804">  dt_iop_request_focus(module);</a>
<a name="ln1805"> </a>
<a name="ln1806">  dt_bauhaus_combobox_clear(w);</a>
<a name="ln1807"> </a>
<a name="ln1808">  raster_combo_entry_t *entry = (raster_combo_entry_t *)malloc(sizeof(raster_combo_entry_t));</a>
<a name="ln1809">  entry-&gt;module = NULL;</a>
<a name="ln1810">  entry-&gt;id = 0;</a>
<a name="ln1811">  dt_bauhaus_combobox_add_full(w, _(&quot;no mask used&quot;), DT_BAUHAUS_COMBOBOX_ALIGN_RIGHT, entry, free);</a>
<a name="ln1812"> </a>
<a name="ln1813">  int i = 1;</a>
<a name="ln1814"> </a>
<a name="ln1815">  for(GList* iter = darktable.develop-&gt;iop; iter; iter = g_list_next(iter))</a>
<a name="ln1816">  {</a>
<a name="ln1817">    dt_iop_module_t *iop = (dt_iop_module_t *)iter-&gt;data;</a>
<a name="ln1818">    if(iop == module)</a>
<a name="ln1819">      break;</a>
<a name="ln1820"> </a>
<a name="ln1821">    GHashTableIter masks_iter;</a>
<a name="ln1822">    gpointer key, value;</a>
<a name="ln1823"> </a>
<a name="ln1824">    g_hash_table_iter_init(&amp;masks_iter, iop-&gt;raster_mask.source.masks);</a>
<a name="ln1825">    while(g_hash_table_iter_next(&amp;masks_iter, &amp;key, &amp;value))</a>
<a name="ln1826">    {</a>
<a name="ln1827">      const int id = GPOINTER_TO_INT(key);</a>
<a name="ln1828">      const char *modulename = (char *)value;</a>
<a name="ln1829">      entry = (raster_combo_entry_t *)malloc(sizeof(raster_combo_entry_t));</a>
<a name="ln1830">      entry-&gt;module = iop;</a>
<a name="ln1831">      entry-&gt;id = id;</a>
<a name="ln1832">      dt_bauhaus_combobox_add_full(w, modulename, DT_BAUHAUS_COMBOBOX_ALIGN_RIGHT, entry, free);</a>
<a name="ln1833">      if(iop == module-&gt;raster_mask.sink.source &amp;&amp; module-&gt;raster_mask.sink.id == id)</a>
<a name="ln1834">        dt_bauhaus_combobox_set(w, i);</a>
<a name="ln1835">      i++;</a>
<a name="ln1836">    }</a>
<a name="ln1837">  }</a>
<a name="ln1838">}</a>
<a name="ln1839"> </a>
<a name="ln1840">static void _raster_value_changed_callback(GtkWidget *widget, struct dt_iop_module_t *module)</a>
<a name="ln1841">{</a>
<a name="ln1842">  raster_combo_entry_t *entry = dt_bauhaus_combobox_get_data(widget);</a>
<a name="ln1843"> </a>
<a name="ln1844">  // nothing to do</a>
<a name="ln1845">  if(entry-&gt;module == module-&gt;raster_mask.sink.source &amp;&amp; entry-&gt;id == module-&gt;raster_mask.sink.id)</a>
<a name="ln1846">    return;</a>
<a name="ln1847"> </a>
<a name="ln1848">  if(module-&gt;raster_mask.sink.source)</a>
<a name="ln1849">  {</a>
<a name="ln1850">    // we no longer use this one</a>
<a name="ln1851">    g_hash_table_remove(module-&gt;raster_mask.sink.source-&gt;raster_mask.source.users, module);</a>
<a name="ln1852">  }</a>
<a name="ln1853"> </a>
<a name="ln1854">  module-&gt;raster_mask.sink.source = entry-&gt;module;</a>
<a name="ln1855">  module-&gt;raster_mask.sink.id = entry-&gt;id;</a>
<a name="ln1856"> </a>
<a name="ln1857">  gboolean reprocess = FALSE;</a>
<a name="ln1858"> </a>
<a name="ln1859">  if(entry-&gt;module)</a>
<a name="ln1860">  {</a>
<a name="ln1861">    reprocess = dt_iop_is_raster_mask_used(entry-&gt;module, 0) == FALSE;</a>
<a name="ln1862">    g_hash_table_add(entry-&gt;module-&gt;raster_mask.source.users, module);</a>
<a name="ln1863"> </a>
<a name="ln1864">    // update blend_params!</a>
<a name="ln1865">    memcpy(module-&gt;blend_params-&gt;raster_mask_source, entry-&gt;module-&gt;op, sizeof(module-&gt;blend_params-&gt;raster_mask_source));</a>
<a name="ln1866">    module-&gt;blend_params-&gt;raster_mask_instance = entry-&gt;module-&gt;multi_priority;</a>
<a name="ln1867">    module-&gt;blend_params-&gt;raster_mask_id = entry-&gt;id;</a>
<a name="ln1868">  }</a>
<a name="ln1869">  else</a>
<a name="ln1870">  {</a>
<a name="ln1871">    memset(module-&gt;blend_params-&gt;raster_mask_source, 0, sizeof(module-&gt;blend_params-&gt;raster_mask_source));</a>
<a name="ln1872">    module-&gt;blend_params-&gt;raster_mask_instance = 0;</a>
<a name="ln1873">    module-&gt;blend_params-&gt;raster_mask_id = 0;</a>
<a name="ln1874">  }</a>
<a name="ln1875"> </a>
<a name="ln1876">  dt_dev_add_history_item(module-&gt;dev, module, TRUE);</a>
<a name="ln1877"> </a>
<a name="ln1878">  if(reprocess)</a>
<a name="ln1879">    dt_dev_reprocess_all(module-&gt;dev);</a>
<a name="ln1880">}</a>
<a name="ln1881"> </a>
<a name="ln1882">void dt_iop_gui_update_raster(dt_iop_module_t *module)</a>
<a name="ln1883">{</a>
<a name="ln1884">  dt_iop_gui_blend_data_t *bd = (dt_iop_gui_blend_data_t *)module-&gt;blend_data;</a>
<a name="ln1885">  dt_develop_blend_params_t *bp = module-&gt;blend_params;</a>
<a name="ln1886"> </a>
<a name="ln1887">  if(!bd || !bd-&gt;masks_support || !bd-&gt;raster_inited) return;</a>
<a name="ln1888"> </a>
<a name="ln1889">  gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;raster_polarity), bp-&gt;raster_mask_invert);</a>
<a name="ln1890"> </a>
<a name="ln1891">  _raster_combo_populate(bd-&gt;raster_combo, &amp;module);</a>
<a name="ln1892">}</a>
<a name="ln1893"> </a>
<a name="ln1894">static void _raster_polarity_callback(GtkToggleButton *togglebutton, dt_iop_module_t *self)</a>
<a name="ln1895">{</a>
<a name="ln1896">  if(darktable.gui-&gt;reset) return;</a>
<a name="ln1897"> </a>
<a name="ln1898">  dt_develop_blend_params_t *bp = (dt_develop_blend_params_t *)self-&gt;blend_params;</a>
<a name="ln1899"> </a>
<a name="ln1900">  bp-&gt;raster_mask_invert = gtk_toggle_button_get_active(togglebutton);</a>
<a name="ln1901"> </a>
<a name="ln1902">  dt_dev_add_history_item(darktable.develop, self, TRUE);</a>
<a name="ln1903">}</a>
<a name="ln1904"> </a>
<a name="ln1905">void dt_iop_gui_init_raster(GtkBox *blendw, dt_iop_module_t *module)</a>
<a name="ln1906">{</a>
<a name="ln1907">  dt_iop_gui_blend_data_t *bd = (dt_iop_gui_blend_data_t *)module-&gt;blend_data;</a>
<a name="ln1908"> </a>
<a name="ln1909">  bd-&gt;raster_box = GTK_BOX(gtk_box_new(GTK_ORIENTATION_VERTICAL, DT_BAUHAUS_SPACE));</a>
<a name="ln1910">  // add event box so that one can click into the area to get help for drawn masks</a>
<a name="ln1911">  GtkWidget* event_box = gtk_event_box_new();</a>
<a name="ln1912">//  dt_gui_add_help_link(GTK_WIDGET(event_box), &quot;raster_mask.html&quot;);</a>
<a name="ln1913">  gtk_container_add(GTK_CONTAINER(blendw), event_box);</a>
<a name="ln1914"> </a>
<a name="ln1915">  /* create and add raster support if module supports it (it's coupled to masks at the moment) */</a>
<a name="ln1916">  if(bd-&gt;masks_support)</a>
<a name="ln1917">  {</a>
<a name="ln1918">    const int bs = DT_PIXEL_APPLY_DPI(14);</a>
<a name="ln1919"> </a>
<a name="ln1920">    GtkWidget *hbox = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0);</a>
<a name="ln1921"> </a>
<a name="ln1922">    bd-&gt;raster_combo = dt_bauhaus_combobox_new(module);</a>
<a name="ln1923">    dt_bauhaus_widget_set_label(bd-&gt;raster_combo, _(&quot;blend&quot;), _(&quot;raster mask&quot;));</a>
<a name="ln1924">    dt_bauhaus_combobox_add(bd-&gt;raster_combo, _(&quot;no mask used&quot;));</a>
<a name="ln1925">    dt_bauhaus_combobox_set(bd-&gt;raster_combo, 0);</a>
<a name="ln1926">    g_signal_connect(G_OBJECT(bd-&gt;raster_combo), &quot;value-changed&quot;,</a>
<a name="ln1927">                     G_CALLBACK(_raster_value_changed_callback), module);</a>
<a name="ln1928">    dt_bauhaus_combobox_add_populate_fct(bd-&gt;raster_combo, _raster_combo_populate);</a>
<a name="ln1929">    gtk_box_pack_start(GTK_BOX(hbox), bd-&gt;raster_combo, TRUE, TRUE, 0);</a>
<a name="ln1930"> </a>
<a name="ln1931">    bd-&gt;raster_polarity = dtgtk_togglebutton_new(dtgtk_cairo_paint_plusminus, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER,</a>
<a name="ln1932">                                                 NULL);</a>
<a name="ln1933">    gtk_widget_set_tooltip_text(bd-&gt;raster_polarity, _(&quot;toggle polarity of raster mask&quot;));</a>
<a name="ln1934">    g_signal_connect(G_OBJECT(bd-&gt;raster_polarity), &quot;toggled&quot;, G_CALLBACK(_raster_polarity_callback), module);</a>
<a name="ln1935">    gtk_widget_set_size_request(GTK_WIDGET(bd-&gt;raster_polarity), bs, bs);</a>
<a name="ln1936">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;raster_polarity), FALSE);</a>
<a name="ln1937">    gtk_box_pack_start(GTK_BOX(hbox), bd-&gt;raster_polarity, FALSE, FALSE, 0);</a>
<a name="ln1938"> </a>
<a name="ln1939">    gtk_box_pack_start(GTK_BOX(bd-&gt;raster_box), GTK_WIDGET(hbox), TRUE, TRUE, 0);</a>
<a name="ln1940"> </a>
<a name="ln1941">    bd-&gt;raster_inited = 1;</a>
<a name="ln1942">  }</a>
<a name="ln1943">  gtk_container_add(GTK_CONTAINER(event_box), GTK_WIDGET(bd-&gt;raster_box));</a>
<a name="ln1944">}</a>
<a name="ln1945"> </a>
<a name="ln1946">void dt_iop_gui_cleanup_blending(dt_iop_module_t *module)</a>
<a name="ln1947">{</a>
<a name="ln1948">  if(!module-&gt;blend_data) return;</a>
<a name="ln1949">  dt_iop_gui_blend_data_t *bd = (dt_iop_gui_blend_data_t *)module-&gt;blend_data;</a>
<a name="ln1950"> </a>
<a name="ln1951">  dt_pthread_mutex_lock(&amp;bd-&gt;lock);</a>
<a name="ln1952">  if(bd-&gt;timeout_handle)</a>
<a name="ln1953">    g_source_remove(bd-&gt;timeout_handle);</a>
<a name="ln1954"> </a>
<a name="ln1955">  g_list_free(bd-&gt;blend_modes);</a>
<a name="ln1956">  g_list_free(bd-&gt;masks_modes);</a>
<a name="ln1957">  g_list_free(bd-&gt;masks_modes_toggles);</a>
<a name="ln1958">  g_list_free(bd-&gt;masks_combine);</a>
<a name="ln1959">  g_list_free(bd-&gt;masks_invert);</a>
<a name="ln1960">  g_list_free(bd-&gt;masks_feathering_guide);</a>
<a name="ln1961">  g_list_free_full(bd-&gt;blend_modes_all, g_free);</a>
<a name="ln1962">  free(bd-&gt;masks_combo_ids);</a>
<a name="ln1963">  dt_pthread_mutex_unlock(&amp;bd-&gt;lock);</a>
<a name="ln1964">  dt_pthread_mutex_destroy(&amp;bd-&gt;lock);</a>
<a name="ln1965"> </a>
<a name="ln1966">  memset(module-&gt;blend_data, 0, sizeof(dt_iop_gui_blend_data_t));</a>
<a name="ln1967"> </a>
<a name="ln1968">  g_free(module-&gt;blend_data);</a>
<a name="ln1969">  module-&gt;blend_data = NULL;</a>
<a name="ln1970">}</a>
<a name="ln1971"> </a>
<a name="ln1972">void dt_iop_gui_update_blending(dt_iop_module_t *module)</a>
<a name="ln1973">{</a>
<a name="ln1974">  dt_iop_gui_blend_data_t *bd = (dt_iop_gui_blend_data_t *)module-&gt;blend_data;</a>
<a name="ln1975"> </a>
<a name="ln1976">  if(!(module-&gt;flags() &amp; IOP_FLAGS_SUPPORTS_BLENDING) || !bd || !bd-&gt;blend_inited) return;</a>
<a name="ln1977"> </a>
<a name="ln1978">  unsigned int mode = g_list_index(bd-&gt;masks_modes, GUINT_TO_POINTER(module-&gt;blend_params-&gt;mask_mode));</a>
<a name="ln1979"> </a>
<a name="ln1980">  // unsets currently toggled if any, won't try to untoggle the cancel button</a>
<a name="ln1981">  if(bd-&gt;selected_mask_mode</a>
<a name="ln1982">     != g_list_nth_data(bd-&gt;masks_modes_toggles,</a>
<a name="ln1983">                        g_list_index(bd-&gt;masks_modes, GUINT_TO_POINTER(DEVELOP_MASK_DISABLED))))</a>
<a name="ln1984">  {</a>
<a name="ln1985">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;selected_mask_mode), FALSE);</a>
<a name="ln1986">  }</a>
<a name="ln1987"> </a>
<a name="ln1988">  if(mode &gt; 0)</a>
<a name="ln1989">  {</a>
<a name="ln1990">    GtkToggleButton *to_be_activated = GTK_TOGGLE_BUTTON(g_list_nth_data(bd-&gt;masks_modes_toggles, mode));</a>
<a name="ln1991">    gtk_toggle_button_set_active(to_be_activated, TRUE);</a>
<a name="ln1992">    bd-&gt;selected_mask_mode = GTK_WIDGET(to_be_activated);</a>
<a name="ln1993">  }</a>
<a name="ln1994">  else</a>
<a name="ln1995">  {</a>
<a name="ln1996">    bd-&gt;selected_mask_mode = g_list_nth_data(</a>
<a name="ln1997">        bd-&gt;masks_modes_toggles, g_list_index(bd-&gt;masks_modes, GUINT_TO_POINTER(DEVELOP_MASK_DISABLED)));</a>
<a name="ln1998">  }</a>
<a name="ln1999"> </a>
<a name="ln2000">  int reset = darktable.gui-&gt;reset;</a>
<a name="ln2001">  darktable.gui-&gt;reset = 1;</a>
<a name="ln2002"> </a>
<a name="ln2003">  /* special handling of deprecated blend modes */</a>
<a name="ln2004">  int blend_mode_number = g_list_index(bd-&gt;blend_modes, GUINT_TO_POINTER(module-&gt;blend_params-&gt;blend_mode));</a>
<a name="ln2005">  if(blend_mode_number &lt; 0)</a>
<a name="ln2006">  {</a>
<a name="ln2007">    GList *complete_list = bd-&gt;blend_modes_all;</a>
<a name="ln2008"> </a>
<a name="ln2009">    while(complete_list)</a>
<a name="ln2010">    {</a>
<a name="ln2011">      dt_iop_blend_mode_t *bm = (dt_iop_blend_mode_t *)complete_list-&gt;data;</a>
<a name="ln2012">      if(bm-&gt;mode == module-&gt;blend_params-&gt;blend_mode)</a>
<a name="ln2013">      {</a>
<a name="ln2014">        dt_bauhaus_combobox_add(bd-&gt;blend_modes_combo, bm-&gt;name);</a>
<a name="ln2015">        bd-&gt;blend_modes = g_list_append(bd-&gt;blend_modes, GUINT_TO_POINTER(bm-&gt;mode));</a>
<a name="ln2016">        break;</a>
<a name="ln2017">      }</a>
<a name="ln2018">      complete_list = g_list_next(complete_list);</a>
<a name="ln2019">    }</a>
<a name="ln2020"> </a>
<a name="ln2021">    if(complete_list)</a>
<a name="ln2022">    {</a>
<a name="ln2023">      /* found it and added it to combobox, now find entry number */</a>
<a name="ln2024">      blend_mode_number = g_list_index(bd-&gt;blend_modes, GUINT_TO_POINTER(module-&gt;blend_params-&gt;blend_mode));</a>
<a name="ln2025">    }</a>
<a name="ln2026">    else</a>
<a name="ln2027">    {</a>
<a name="ln2028">      /* should never happen: unknown blend mode */</a>
<a name="ln2029">      dt_control_log(&quot;unknown blend mode '%d' in module '%s'&quot;, module-&gt;blend_params-&gt;blend_mode, module-&gt;op);</a>
<a name="ln2030">      blend_mode_number = 0;</a>
<a name="ln2031">    }</a>
<a name="ln2032">  }</a>
<a name="ln2033"> </a>
<a name="ln2034">  dt_bauhaus_combobox_set(bd-&gt;blend_modes_combo, blend_mode_number);</a>
<a name="ln2035"> </a>
<a name="ln2036">  dt_bauhaus_combobox_set(</a>
<a name="ln2037">      bd-&gt;masks_combine_combo,</a>
<a name="ln2038">      g_list_index(bd-&gt;masks_combine, GUINT_TO_POINTER(module-&gt;blend_params-&gt;mask_combine</a>
<a name="ln2039">                                                       &amp; (DEVELOP_COMBINE_INV | DEVELOP_COMBINE_INCL))));</a>
<a name="ln2040">  dt_bauhaus_combobox_set(bd-&gt;masks_invert_combo,</a>
<a name="ln2041">                          g_list_index(bd-&gt;masks_invert, GUINT_TO_POINTER(module-&gt;blend_params-&gt;mask_combine</a>
<a name="ln2042">                                                                          &amp; DEVELOP_COMBINE_INV)));</a>
<a name="ln2043">  dt_bauhaus_slider_set(bd-&gt;opacity_slider, module-&gt;blend_params-&gt;opacity);</a>
<a name="ln2044">  dt_bauhaus_combobox_set(</a>
<a name="ln2045">      bd-&gt;masks_feathering_guide_combo,</a>
<a name="ln2046">      g_list_index(bd-&gt;masks_feathering_guide, GUINT_TO_POINTER(module-&gt;blend_params-&gt;feathering_guide)));</a>
<a name="ln2047">  dt_bauhaus_slider_set(bd-&gt;feathering_radius_slider, module-&gt;blend_params-&gt;feathering_radius);</a>
<a name="ln2048">  dt_bauhaus_slider_set(bd-&gt;blur_radius_slider, module-&gt;blend_params-&gt;blur_radius);</a>
<a name="ln2049">  dt_bauhaus_slider_set(bd-&gt;brightness_slider, module-&gt;blend_params-&gt;brightness);</a>
<a name="ln2050">  dt_bauhaus_slider_set(bd-&gt;contrast_slider, module-&gt;blend_params-&gt;contrast);</a>
<a name="ln2051"> </a>
<a name="ln2052">  dt_iop_gui_update_blendif(module);</a>
<a name="ln2053">  dt_iop_gui_update_masks(module);</a>
<a name="ln2054">  dt_iop_gui_update_raster(module);</a>
<a name="ln2055"> </a>
<a name="ln2056">  /* now show hide controls as required */</a>
<a name="ln2057">  const unsigned int mask_mode = module-&gt;blend_params-&gt;mask_mode;</a>
<a name="ln2058"> </a>
<a name="ln2059">  if(mask_mode &amp; DEVELOP_MASK_ENABLED)</a>
<a name="ln2060">  {</a>
<a name="ln2061">    gtk_widget_show(GTK_WIDGET(bd-&gt;top_box));</a>
<a name="ln2062">  }</a>
<a name="ln2063">  else</a>
<a name="ln2064">  {</a>
<a name="ln2065">    gtk_widget_hide(GTK_WIDGET(bd-&gt;top_box));</a>
<a name="ln2066">  }</a>
<a name="ln2067"> </a>
<a name="ln2068">  if((mask_mode &amp; DEVELOP_MASK_ENABLED) &amp;&amp; ((bd-&gt;masks_inited &amp;&amp; (mask_mode &amp; DEVELOP_MASK_MASK))</a>
<a name="ln2069">                                            || (bd-&gt;blendif_inited &amp;&amp; (mask_mode &amp; DEVELOP_MASK_CONDITIONAL))))</a>
<a name="ln2070">  {</a>
<a name="ln2071">    if(bd-&gt;blendif_inited &amp;&amp; (mask_mode &amp; DEVELOP_MASK_CONDITIONAL))</a>
<a name="ln2072">    {</a>
<a name="ln2073">      gtk_widget_hide(GTK_WIDGET(bd-&gt;masks_invert_combo));</a>
<a name="ln2074">      gtk_widget_show(GTK_WIDGET(bd-&gt;masks_combine_combo));</a>
<a name="ln2075">    }</a>
<a name="ln2076">    else</a>
<a name="ln2077">    {</a>
<a name="ln2078">      gtk_widget_show(GTK_WIDGET(bd-&gt;masks_invert_combo));</a>
<a name="ln2079">      gtk_widget_hide(GTK_WIDGET(bd-&gt;masks_combine_combo));</a>
<a name="ln2080">    }</a>
<a name="ln2081"> </a>
<a name="ln2082">    /*</a>
<a name="ln2083">     * if this iop is operating in raw space, it has only 1 channel per pixel,</a>
<a name="ln2084">     * thus there is no alpha channel where we would normally store mask</a>
<a name="ln2085">     * that would get displayed if following button have been pressed.</a>
<a name="ln2086">     *</a>
<a name="ln2087">     * TODO: revisit if/once there semi-raw iops (e.g temperature) with blending</a>
<a name="ln2088">     */</a>
<a name="ln2089">    if(module-&gt;blend_colorspace(module, NULL, NULL) == iop_cs_RAW)</a>
<a name="ln2090">    {</a>
<a name="ln2091">      module-&gt;request_mask_display = DT_DEV_PIXELPIPE_DISPLAY_NONE;</a>
<a name="ln2092">      dtgtk_button_set_active(DTGTK_BUTTON(bd-&gt;showmask), 0);</a>
<a name="ln2093">      gtk_widget_hide(GTK_WIDGET(bd-&gt;showmask));</a>
<a name="ln2094">    }</a>
<a name="ln2095">    else</a>
<a name="ln2096">    {</a>
<a name="ln2097">      gtk_widget_show(GTK_WIDGET(bd-&gt;showmask));</a>
<a name="ln2098">    }</a>
<a name="ln2099"> </a>
<a name="ln2100">    gtk_widget_show(GTK_WIDGET(bd-&gt;bottom_box));</a>
<a name="ln2101">  }</a>
<a name="ln2102">  else</a>
<a name="ln2103">  {</a>
<a name="ln2104">    module-&gt;request_mask_display = DT_DEV_PIXELPIPE_DISPLAY_NONE;</a>
<a name="ln2105">    dtgtk_button_set_active(DTGTK_BUTTON(bd-&gt;showmask), 0);</a>
<a name="ln2106">    module-&gt;suppress_mask = 0;</a>
<a name="ln2107">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;suppress), 0);</a>
<a name="ln2108"> </a>
<a name="ln2109">    gtk_widget_hide(GTK_WIDGET(bd-&gt;bottom_box));</a>
<a name="ln2110">  }</a>
<a name="ln2111"> </a>
<a name="ln2112"> </a>
<a name="ln2113">  if(bd-&gt;masks_inited &amp;&amp; (mask_mode &amp; DEVELOP_MASK_MASK))</a>
<a name="ln2114">  {</a>
<a name="ln2115">    gtk_widget_show(GTK_WIDGET(bd-&gt;masks_box));</a>
<a name="ln2116">  }</a>
<a name="ln2117">  else if(bd-&gt;masks_inited)</a>
<a name="ln2118">  {</a>
<a name="ln2119">    dt_masks_set_edit_mode(module, DT_MASKS_EDIT_OFF);</a>
<a name="ln2120"> </a>
<a name="ln2121">    gtk_widget_hide(GTK_WIDGET(bd-&gt;masks_box));</a>
<a name="ln2122">  }</a>
<a name="ln2123">  else</a>
<a name="ln2124">  {</a>
<a name="ln2125">    gtk_widget_hide(GTK_WIDGET(bd-&gt;masks_box));</a>
<a name="ln2126">  }</a>
<a name="ln2127"> </a>
<a name="ln2128">  if(bd-&gt;raster_inited &amp;&amp; (mask_mode &amp; DEVELOP_MASK_RASTER))</a>
<a name="ln2129">  {</a>
<a name="ln2130">    gtk_widget_show(GTK_WIDGET(bd-&gt;raster_box));</a>
<a name="ln2131">  }</a>
<a name="ln2132">  else if(bd-&gt;raster_inited)</a>
<a name="ln2133">  {</a>
<a name="ln2134">//     dt_masks_set_edit_mode(module, DT_MASKS_EDIT_OFF);</a>
<a name="ln2135"> </a>
<a name="ln2136">    gtk_widget_hide(GTK_WIDGET(bd-&gt;raster_box));</a>
<a name="ln2137">  }</a>
<a name="ln2138">  else</a>
<a name="ln2139">  {</a>
<a name="ln2140">    gtk_widget_hide(GTK_WIDGET(bd-&gt;raster_box));</a>
<a name="ln2141">  }</a>
<a name="ln2142"> </a>
<a name="ln2143">  if(bd-&gt;blendif_inited &amp;&amp; (mask_mode &amp; DEVELOP_MASK_CONDITIONAL))</a>
<a name="ln2144">  {</a>
<a name="ln2145">    gtk_widget_show(GTK_WIDGET(bd-&gt;blendif_box));</a>
<a name="ln2146">  }</a>
<a name="ln2147">  else if(bd-&gt;blendif_inited)</a>
<a name="ln2148">  {</a>
<a name="ln2149">    /* switch off color picker */</a>
<a name="ln2150">    dt_iop_color_picker_reset(module, TRUE);</a>
<a name="ln2151"> </a>
<a name="ln2152">    gtk_widget_hide(GTK_WIDGET(bd-&gt;blendif_box));</a>
<a name="ln2153">  }</a>
<a name="ln2154">  else</a>
<a name="ln2155">  {</a>
<a name="ln2156">    gtk_widget_hide(GTK_WIDGET(bd-&gt;blendif_box));</a>
<a name="ln2157">  }</a>
<a name="ln2158"> </a>
<a name="ln2159">  darktable.gui-&gt;reset = reset;</a>
<a name="ln2160">}</a>
<a name="ln2161"> </a>
<a name="ln2162">static void _collect_blend_modes(GList **list, const char *name, unsigned int mode)</a>
<a name="ln2163">{</a>
<a name="ln2164">  dt_iop_blend_mode_t *bm;</a>
<a name="ln2165">  bm = g_malloc(sizeof(dt_iop_blend_mode_t));</a>
<a name="ln2166">  g_strlcpy(bm-&gt;name, name, sizeof(bm-&gt;name));</a>
<a name="ln2167">  bm-&gt;mode = mode;</a>
<a name="ln2168">  *list = g_list_append(*list, bm);</a>
<a name="ln2169">}</a>
<a name="ln2170"> </a>
<a name="ln2171"> </a>
<a name="ln2172">static void _add_blendmode_combo(GList **list, GtkWidget *combobox, GList *complete, unsigned int mode)</a>
<a name="ln2173">{</a>
<a name="ln2174">  GList *all = complete;</a>
<a name="ln2175"> </a>
<a name="ln2176">  while(all)</a>
<a name="ln2177">  {</a>
<a name="ln2178">    dt_iop_blend_mode_t *bm = (dt_iop_blend_mode_t *)all-&gt;data;</a>
<a name="ln2179">    if(bm-&gt;mode == mode)</a>
<a name="ln2180">    {</a>
<a name="ln2181">      dt_bauhaus_combobox_add(combobox, bm-&gt;name);</a>
<a name="ln2182">      *list = g_list_append(*list, GUINT_TO_POINTER(bm-&gt;mode));</a>
<a name="ln2183">      break;</a>
<a name="ln2184">    }</a>
<a name="ln2185">    all = g_list_next(all);</a>
<a name="ln2186">  }</a>
<a name="ln2187">}</a>
<a name="ln2188"> </a>
<a name="ln2189"> </a>
<a name="ln2190">void dt_iop_gui_init_blending(GtkWidget *iopw, dt_iop_module_t *module)</a>
<a name="ln2191">{</a>
<a name="ln2192"> </a>
<a name="ln2193">  /* create and add blend mode if module supports it */</a>
<a name="ln2194">  if(module-&gt;flags() &amp; IOP_FLAGS_SUPPORTS_BLENDING)</a>
<a name="ln2195">  {</a>
<a name="ln2196">    const int bs = DT_PIXEL_APPLY_DPI(14);</a>
<a name="ln2197"> </a>
<a name="ln2198">    module-&gt;blend_data = g_malloc0(sizeof(dt_iop_gui_blend_data_t));</a>
<a name="ln2199">    dt_iop_gui_blend_data_t *bd = (dt_iop_gui_blend_data_t *)module-&gt;blend_data;</a>
<a name="ln2200"> </a>
<a name="ln2201">    bd-&gt;iopw = iopw;</a>
<a name="ln2202">    bd-&gt;module = module;</a>
<a name="ln2203">    bd-&gt;csp = module-&gt;blend_colorspace(module, NULL, NULL);</a>
<a name="ln2204">    bd-&gt;blendif_support = (bd-&gt;csp == iop_cs_Lab || bd-&gt;csp == iop_cs_rgb);</a>
<a name="ln2205">    bd-&gt;masks_support = !(module-&gt;flags() &amp; IOP_FLAGS_NO_MASKS);</a>
<a name="ln2206"> </a>
<a name="ln2207">    bd-&gt;masks_modes = NULL;</a>
<a name="ln2208">    bd-&gt;masks_modes_toggles = NULL;</a>
<a name="ln2209">    bd-&gt;blend_modes = NULL;</a>
<a name="ln2210">    bd-&gt;masks_combine = NULL;</a>
<a name="ln2211">    bd-&gt;masks_invert = NULL;</a>
<a name="ln2212">    bd-&gt;blend_modes_all = NULL;</a>
<a name="ln2213"> </a>
<a name="ln2214">    dt_pthread_mutex_init(&amp;bd-&gt;lock, NULL);</a>
<a name="ln2215">    dt_pthread_mutex_lock(&amp;bd-&gt;lock);</a>
<a name="ln2216">    bd-&gt;timeout_handle = 0;</a>
<a name="ln2217">    bd-&gt;save_for_leave = 0;</a>
<a name="ln2218">    dt_pthread_mutex_unlock(&amp;bd-&gt;lock);</a>
<a name="ln2219"> </a>
<a name="ln2220">    bd-&gt;picker_set_upper_lower = 0;</a>
<a name="ln2221"> </a>
<a name="ln2222"> </a>
<a name="ln2223">    /** generate a list of all available blend modes */</a>
<a name="ln2224">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;normal&quot;), DEVELOP_BLEND_NORMAL2);</a>
<a name="ln2225">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;normal bounded&quot;), DEVELOP_BLEND_BOUNDED);</a>
<a name="ln2226">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;lighten&quot;), DEVELOP_BLEND_LIGHTEN);</a>
<a name="ln2227">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;darken&quot;), DEVELOP_BLEND_DARKEN);</a>
<a name="ln2228">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;multiply&quot;), DEVELOP_BLEND_MULTIPLY);</a>
<a name="ln2229">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;average&quot;), DEVELOP_BLEND_AVERAGE);</a>
<a name="ln2230">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;addition&quot;), DEVELOP_BLEND_ADD);</a>
<a name="ln2231">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;subtract&quot;), DEVELOP_BLEND_SUBSTRACT);</a>
<a name="ln2232">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;difference&quot;), DEVELOP_BLEND_DIFFERENCE2);</a>
<a name="ln2233">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;screen&quot;), DEVELOP_BLEND_SCREEN);</a>
<a name="ln2234">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;overlay&quot;), DEVELOP_BLEND_OVERLAY);</a>
<a name="ln2235">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;softlight&quot;), DEVELOP_BLEND_SOFTLIGHT);</a>
<a name="ln2236">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;hardlight&quot;), DEVELOP_BLEND_HARDLIGHT);</a>
<a name="ln2237">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;vividlight&quot;), DEVELOP_BLEND_VIVIDLIGHT);</a>
<a name="ln2238">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;linearlight&quot;), DEVELOP_BLEND_LINEARLIGHT);</a>
<a name="ln2239">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;pinlight&quot;), DEVELOP_BLEND_PINLIGHT);</a>
<a name="ln2240">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;lightness&quot;), DEVELOP_BLEND_LIGHTNESS);</a>
<a name="ln2241">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;chroma&quot;), DEVELOP_BLEND_CHROMA);</a>
<a name="ln2242">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;hue&quot;), DEVELOP_BLEND_HUE);</a>
<a name="ln2243">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;color&quot;), DEVELOP_BLEND_COLOR);</a>
<a name="ln2244">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;coloradjustment&quot;),</a>
<a name="ln2245">                         DEVELOP_BLEND_COLORADJUST);</a>
<a name="ln2246">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;Lab lightness&quot;),</a>
<a name="ln2247">                         DEVELOP_BLEND_LAB_LIGHTNESS);</a>
<a name="ln2248">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;Lab color&quot;), DEVELOP_BLEND_LAB_COLOR);</a>
<a name="ln2249">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;Lab L-channel&quot;),</a>
<a name="ln2250">                         DEVELOP_BLEND_LAB_L);</a>
<a name="ln2251">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;Lab a-channel&quot;),</a>
<a name="ln2252">                         DEVELOP_BLEND_LAB_A);</a>
<a name="ln2253">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;Lab b-channel&quot;),</a>
<a name="ln2254">                         DEVELOP_BLEND_LAB_B);</a>
<a name="ln2255">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;HSV lightness&quot;),</a>
<a name="ln2256">                         DEVELOP_BLEND_HSV_LIGHTNESS);</a>
<a name="ln2257">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;HSV color&quot;), DEVELOP_BLEND_HSV_COLOR);</a>
<a name="ln2258">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;RGB red channel&quot;),</a>
<a name="ln2259">                         DEVELOP_BLEND_RGB_R);</a>
<a name="ln2260">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;RGB green channel&quot;),</a>
<a name="ln2261">                         DEVELOP_BLEND_RGB_G);</a>
<a name="ln2262">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;RGB blue channel&quot;),</a>
<a name="ln2263">                         DEVELOP_BLEND_RGB_B);</a>
<a name="ln2264"> </a>
<a name="ln2265">    /** deprecated blend modes: make them available as legacy history stacks might want them */</a>
<a name="ln2266">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;difference (deprecated)&quot;),</a>
<a name="ln2267">                         DEVELOP_BLEND_DIFFERENCE);</a>
<a name="ln2268">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;inverse (deprecated)&quot;),</a>
<a name="ln2269">                         DEVELOP_BLEND_INVERSE);</a>
<a name="ln2270">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;normal (deprecated)&quot;), DEVELOP_BLEND_NORMAL);</a>
<a name="ln2271">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;unbounded (deprecated)&quot;),</a>
<a name="ln2272">                         DEVELOP_BLEND_UNBOUNDED);</a>
<a name="ln2273"> </a>
<a name="ln2274">    //toggle buttons creation for masks modes</a>
<a name="ln2275">    GtkWidget *but = NULL;</a>
<a name="ln2276"> </a>
<a name="ln2277">    // DEVELOP_MASK_DISABLED</a>
<a name="ln2278">    but = dtgtk_button_new(dtgtk_cairo_paint_cancel, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln2279">    gtk_widget_set_tooltip_text(but, _(&quot;off&quot;));</a>
<a name="ln2280">    bd-&gt;masks_modes = g_list_append(bd-&gt;masks_modes, GUINT_TO_POINTER(DEVELOP_MASK_DISABLED));</a>
<a name="ln2281">    bd-&gt;masks_modes_toggles = g_list_append(bd-&gt;masks_modes_toggles , GTK_WIDGET(but));</a>
<a name="ln2282">    g_signal_connect(G_OBJECT(but), &quot;button-press-event&quot;, G_CALLBACK(_blendop_masks_modes_none_clicked), module);</a>
<a name="ln2283"> </a>
<a name="ln2284">    // DEVELOP_MASK_ENABLED</a>
<a name="ln2285">    but = dtgtk_togglebutton_new(dtgtk_cairo_paint_masks_uniform, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln2286">    gtk_widget_set_tooltip_text(but, _(&quot;uniformly&quot;));</a>
<a name="ln2287">    bd-&gt;masks_modes = g_list_append(bd-&gt;masks_modes, GUINT_TO_POINTER(DEVELOP_MASK_ENABLED));</a>
<a name="ln2288">    bd-&gt;masks_modes_toggles  = g_list_append(bd-&gt;masks_modes_toggles , GTK_WIDGET(but));</a>
<a name="ln2289">    g_signal_connect(G_OBJECT(but), &quot;toggled&quot;, G_CALLBACK(_blendop_masks_modes_uni_toggled), module);</a>
<a name="ln2290"> </a>
<a name="ln2291">    if(bd-&gt;masks_support) //DEVELOP_MASK_ENABLED | DEVELOP_MASK_MASK</a>
<a name="ln2292">    {</a>
<a name="ln2293">      but = dtgtk_togglebutton_new(dtgtk_cairo_paint_masks_drawn, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln2294">      gtk_widget_set_tooltip_text(but, _(&quot;drawn mask&quot;));</a>
<a name="ln2295">      bd-&gt;masks_modes = g_list_append(bd-&gt;masks_modes, GUINT_TO_POINTER(DEVELOP_MASK_ENABLED | DEVELOP_MASK_MASK));</a>
<a name="ln2296">      bd-&gt;masks_modes_toggles = g_list_append(bd-&gt;masks_modes_toggles, GTK_WIDGET(but));</a>
<a name="ln2297">      g_signal_connect(G_OBJECT(but), &quot;toggled&quot;, G_CALLBACK(_blendop_masks_modes_drawn_toggled), module);</a>
<a name="ln2298">    }</a>
<a name="ln2299">    if(bd-&gt;blendif_support) //DEVELOP_MASK_ENABLED | DEVELOP_MASK_CONDITIONAL</a>
<a name="ln2300">    {</a>
<a name="ln2301">      but = dtgtk_togglebutton_new(dtgtk_cairo_paint_masks_parametric, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER,</a>
<a name="ln2302">                                   NULL);</a>
<a name="ln2303">      gtk_widget_set_tooltip_text(but, _(&quot;parametric mask&quot;));</a>
<a name="ln2304">      bd-&gt;masks_modes</a>
<a name="ln2305">          = g_list_append(bd-&gt;masks_modes, GUINT_TO_POINTER(DEVELOP_MASK_ENABLED | DEVELOP_MASK_CONDITIONAL));</a>
<a name="ln2306">      bd-&gt;masks_modes_toggles = g_list_append(bd-&gt;masks_modes_toggles, GTK_WIDGET(but));</a>
<a name="ln2307">      g_signal_connect(G_OBJECT(but), &quot;toggled&quot;, G_CALLBACK(_blendop_masks_modes_param_toggled), module);</a>
<a name="ln2308">    }</a>
<a name="ln2309"> </a>
<a name="ln2310">    if(bd-&gt;blendif_support &amp;&amp; bd-&gt;masks_support) //DEVELOP_MASK_ENABLED | DEVELOP_MASK_MASK_CONDITIONAL</a>
<a name="ln2311">    {</a>
<a name="ln2312">      but = dtgtk_togglebutton_new(dtgtk_cairo_paint_masks_drawn_and_parametric,</a>
<a name="ln2313">                                   CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL); // overlays and</a>
<a name="ln2314">      gtk_widget_set_tooltip_text(but, _(&quot;drawn &amp; parametric mask&quot;));</a>
<a name="ln2315">      bd-&gt;masks_modes</a>
<a name="ln2316">          = g_list_append(bd-&gt;masks_modes, GUINT_TO_POINTER(DEVELOP_MASK_ENABLED | DEVELOP_MASK_MASK_CONDITIONAL));</a>
<a name="ln2317">      bd-&gt;masks_modes_toggles = g_list_append(bd-&gt;masks_modes_toggles, GTK_WIDGET(but));</a>
<a name="ln2318">      g_signal_connect(G_OBJECT(but), &quot;toggled&quot;, G_CALLBACK(_blendop_masks_modes_both_toggled), module);</a>
<a name="ln2319">    }</a>
<a name="ln2320"> </a>
<a name="ln2321">    if(bd-&gt;masks_support) //DEVELOP_MASK_ENABLED | DEVELOP_MASK_RASTER</a>
<a name="ln2322">    {</a>
<a name="ln2323">      but = dtgtk_togglebutton_new(dtgtk_cairo_paint_masks_raster, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln2324">      gtk_widget_set_tooltip_text(but, _(&quot;raster mask&quot;));</a>
<a name="ln2325">      bd-&gt;masks_modes</a>
<a name="ln2326">          = g_list_append(bd-&gt;masks_modes, GUINT_TO_POINTER(DEVELOP_MASK_ENABLED | DEVELOP_MASK_RASTER));</a>
<a name="ln2327">      bd-&gt;masks_modes_toggles = g_list_append(bd-&gt;masks_modes_toggles, GTK_WIDGET(but));</a>
<a name="ln2328">      g_signal_connect(G_OBJECT(but), &quot;toggled&quot;, G_CALLBACK(_blendop_masks_modes_raster_toggled), module);</a>
<a name="ln2329">    }</a>
<a name="ln2330">    // initial state is no mask</a>
<a name="ln2331">    bd-&gt;selected_mask_mode = GTK_WIDGET(</a>
<a name="ln2332">        g_list_nth_data(bd-&gt;masks_modes_toggles,</a>
<a name="ln2333">                        g_list_index(bd-&gt;masks_modes, (gconstpointer)DEVELOP_MASK_DISABLED)));</a>
<a name="ln2334"> </a>
<a name="ln2335">    bd-&gt;blend_modes_combo = dt_bauhaus_combobox_new(module);</a>
<a name="ln2336">    dt_bauhaus_widget_set_label(bd-&gt;blend_modes_combo, _(&quot;blend&quot;), _(&quot;blend mode&quot;));</a>
<a name="ln2337">    gtk_widget_set_tooltip_text(bd-&gt;blend_modes_combo, _(&quot;choose blending mode&quot;));</a>
<a name="ln2338"> </a>
<a name="ln2339">    switch(bd-&gt;csp)</a>
<a name="ln2340">    {</a>
<a name="ln2341">      case iop_cs_Lab:</a>
<a name="ln2342">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2343">                             DEVELOP_BLEND_NORMAL2);</a>
<a name="ln2344">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2345">                             DEVELOP_BLEND_BOUNDED);</a>
<a name="ln2346">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2347">                             DEVELOP_BLEND_LIGHTEN);</a>
<a name="ln2348">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2349">                             DEVELOP_BLEND_DARKEN);</a>
<a name="ln2350">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2351">                             DEVELOP_BLEND_MULTIPLY);</a>
<a name="ln2352">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2353">                             DEVELOP_BLEND_AVERAGE);</a>
<a name="ln2354">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2355">                             DEVELOP_BLEND_ADD);</a>
<a name="ln2356">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2357">                             DEVELOP_BLEND_SUBSTRACT);</a>
<a name="ln2358">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2359">                             DEVELOP_BLEND_DIFFERENCE2);</a>
<a name="ln2360">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2361">                             DEVELOP_BLEND_SCREEN);</a>
<a name="ln2362">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2363">                             DEVELOP_BLEND_OVERLAY);</a>
<a name="ln2364">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2365">                             DEVELOP_BLEND_SOFTLIGHT);</a>
<a name="ln2366">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2367">                             DEVELOP_BLEND_HARDLIGHT);</a>
<a name="ln2368">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2369">                             DEVELOP_BLEND_VIVIDLIGHT);</a>
<a name="ln2370">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2371">                             DEVELOP_BLEND_LINEARLIGHT);</a>
<a name="ln2372">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2373">                             DEVELOP_BLEND_PINLIGHT);</a>
<a name="ln2374">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2375">                             DEVELOP_BLEND_LAB_LIGHTNESS);</a>
<a name="ln2376">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2377">                             DEVELOP_BLEND_LAB_A);</a>
<a name="ln2378">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2379">                             DEVELOP_BLEND_LAB_B);</a>
<a name="ln2380">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2381">                             DEVELOP_BLEND_LAB_COLOR);</a>
<a name="ln2382">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2383">                             DEVELOP_BLEND_LIGHTNESS);</a>
<a name="ln2384">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2385">                             DEVELOP_BLEND_CHROMA);</a>
<a name="ln2386">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2387">                             DEVELOP_BLEND_HUE);</a>
<a name="ln2388">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2389">                             DEVELOP_BLEND_COLOR);</a>
<a name="ln2390">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2391">                             DEVELOP_BLEND_COLORADJUST);</a>
<a name="ln2392">        break;</a>
<a name="ln2393"> </a>
<a name="ln2394">      case iop_cs_rgb:</a>
<a name="ln2395">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2396">                             DEVELOP_BLEND_NORMAL2);</a>
<a name="ln2397">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2398">                             DEVELOP_BLEND_BOUNDED);</a>
<a name="ln2399">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2400">                             DEVELOP_BLEND_LIGHTEN);</a>
<a name="ln2401">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2402">                             DEVELOP_BLEND_DARKEN);</a>
<a name="ln2403">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2404">                             DEVELOP_BLEND_MULTIPLY);</a>
<a name="ln2405">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2406">                             DEVELOP_BLEND_AVERAGE);</a>
<a name="ln2407">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2408">                             DEVELOP_BLEND_ADD);</a>
<a name="ln2409">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2410">                             DEVELOP_BLEND_SUBSTRACT);</a>
<a name="ln2411">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2412">                             DEVELOP_BLEND_DIFFERENCE2);</a>
<a name="ln2413">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2414">                             DEVELOP_BLEND_SCREEN);</a>
<a name="ln2415">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2416">                             DEVELOP_BLEND_OVERLAY);</a>
<a name="ln2417">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2418">                             DEVELOP_BLEND_SOFTLIGHT);</a>
<a name="ln2419">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2420">                             DEVELOP_BLEND_HARDLIGHT);</a>
<a name="ln2421">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2422">                             DEVELOP_BLEND_VIVIDLIGHT);</a>
<a name="ln2423">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2424">                             DEVELOP_BLEND_LINEARLIGHT);</a>
<a name="ln2425">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2426">                             DEVELOP_BLEND_PINLIGHT);</a>
<a name="ln2427">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2428">                             DEVELOP_BLEND_HSV_LIGHTNESS);</a>
<a name="ln2429">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2430">                             DEVELOP_BLEND_HSV_COLOR);</a>
<a name="ln2431">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2432">                             DEVELOP_BLEND_RGB_R);</a>
<a name="ln2433">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2434">                             DEVELOP_BLEND_RGB_G);</a>
<a name="ln2435">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2436">                             DEVELOP_BLEND_RGB_B);</a>
<a name="ln2437">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2438">                             DEVELOP_BLEND_LIGHTNESS);</a>
<a name="ln2439">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2440">                             DEVELOP_BLEND_CHROMA);</a>
<a name="ln2441">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2442">                             DEVELOP_BLEND_HUE);</a>
<a name="ln2443">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2444">                             DEVELOP_BLEND_COLOR);</a>
<a name="ln2445">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2446">                             DEVELOP_BLEND_COLORADJUST);</a>
<a name="ln2447">        break;</a>
<a name="ln2448"> </a>
<a name="ln2449">      case iop_cs_RAW:</a>
<a name="ln2450">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2451">                             DEVELOP_BLEND_NORMAL2);</a>
<a name="ln2452">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2453">                             DEVELOP_BLEND_BOUNDED);</a>
<a name="ln2454">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2455">                             DEVELOP_BLEND_LIGHTEN);</a>
<a name="ln2456">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2457">                             DEVELOP_BLEND_DARKEN);</a>
<a name="ln2458">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2459">                             DEVELOP_BLEND_MULTIPLY);</a>
<a name="ln2460">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2461">                             DEVELOP_BLEND_AVERAGE);</a>
<a name="ln2462">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2463">                             DEVELOP_BLEND_ADD);</a>
<a name="ln2464">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2465">                             DEVELOP_BLEND_SUBSTRACT);</a>
<a name="ln2466">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2467">                             DEVELOP_BLEND_DIFFERENCE2);</a>
<a name="ln2468">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2469">                             DEVELOP_BLEND_SCREEN);</a>
<a name="ln2470">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2471">                             DEVELOP_BLEND_OVERLAY);</a>
<a name="ln2472">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2473">                             DEVELOP_BLEND_SOFTLIGHT);</a>
<a name="ln2474">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2475">                             DEVELOP_BLEND_HARDLIGHT);</a>
<a name="ln2476">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2477">                             DEVELOP_BLEND_VIVIDLIGHT);</a>
<a name="ln2478">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2479">                             DEVELOP_BLEND_LINEARLIGHT);</a>
<a name="ln2480">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2481">                             DEVELOP_BLEND_PINLIGHT);</a>
<a name="ln2482">        break;</a>
<a name="ln2483">      case iop_cs_LCh:</a>
<a name="ln2484">      case iop_cs_HSL:</a>
<a name="ln2485">      case iop_cs_NONE:</a>
<a name="ln2486">        break;</a>
<a name="ln2487">    }</a>
<a name="ln2488"> </a>
<a name="ln2489"> </a>
<a name="ln2490">    dt_bauhaus_combobox_set(bd-&gt;blend_modes_combo, 0);</a>
<a name="ln2491">    g_signal_connect(G_OBJECT(bd-&gt;blend_modes_combo), &quot;value-changed&quot;,</a>
<a name="ln2492">                     G_CALLBACK(_blendop_blend_mode_callback), bd);</a>
<a name="ln2493">    dt_gui_add_help_link(GTK_WIDGET(bd-&gt;blend_modes_combo), &quot;blending_operators.html&quot;);</a>
<a name="ln2494"> </a>
<a name="ln2495"> </a>
<a name="ln2496">    bd-&gt;opacity_slider = dt_bauhaus_slider_new_with_range(module, 0.0, 100.0, 1, 100.0, 0);</a>
<a name="ln2497">    dt_bauhaus_widget_set_label(bd-&gt;opacity_slider, _(&quot;blend&quot;), _(&quot;opacity&quot;));</a>
<a name="ln2498">    dt_bauhaus_slider_set_format(bd-&gt;opacity_slider, &quot;%.0f%%&quot;);</a>
<a name="ln2499">    module-&gt;fusion_slider = bd-&gt;opacity_slider;</a>
<a name="ln2500">    gtk_widget_set_tooltip_text(bd-&gt;opacity_slider, _(&quot;set the opacity of the blending&quot;));</a>
<a name="ln2501">    g_signal_connect(G_OBJECT(bd-&gt;opacity_slider), &quot;value-changed&quot;, G_CALLBACK(_blendop_opacity_callback), bd);</a>
<a name="ln2502"> </a>
<a name="ln2503"> </a>
<a name="ln2504">    bd-&gt;masks_combine_combo = dt_bauhaus_combobox_new(module);</a>
<a name="ln2505">    dt_bauhaus_widget_set_label(bd-&gt;masks_combine_combo, _(&quot;blend&quot;), _(&quot;combine masks&quot;));</a>
<a name="ln2506"> </a>
<a name="ln2507">    dt_bauhaus_combobox_add(bd-&gt;masks_combine_combo, _(&quot;exclusive&quot;));</a>
<a name="ln2508">    bd-&gt;masks_combine = g_list_append(bd-&gt;masks_combine, GUINT_TO_POINTER(DEVELOP_COMBINE_NORM_EXCL));</a>
<a name="ln2509"> </a>
<a name="ln2510">    dt_bauhaus_combobox_add(bd-&gt;masks_combine_combo, _(&quot;inclusive&quot;));</a>
<a name="ln2511">    bd-&gt;masks_combine = g_list_append(bd-&gt;masks_combine, GUINT_TO_POINTER(DEVELOP_COMBINE_NORM_INCL));</a>
<a name="ln2512"> </a>
<a name="ln2513">    dt_bauhaus_combobox_add(bd-&gt;masks_combine_combo, _(&quot;exclusive &amp; inverted&quot;));</a>
<a name="ln2514">    bd-&gt;masks_combine = g_list_append(bd-&gt;masks_combine, GUINT_TO_POINTER(DEVELOP_COMBINE_INV_EXCL));</a>
<a name="ln2515"> </a>
<a name="ln2516">    dt_bauhaus_combobox_add(bd-&gt;masks_combine_combo, _(&quot;inclusive &amp; inverted&quot;));</a>
<a name="ln2517">    bd-&gt;masks_combine = g_list_append(bd-&gt;masks_combine, GUINT_TO_POINTER(DEVELOP_COMBINE_INV_INCL));</a>
<a name="ln2518"> </a>
<a name="ln2519">    dt_bauhaus_combobox_set(bd-&gt;masks_combine_combo, 0);</a>
<a name="ln2520">    gtk_widget_set_tooltip_text(bd-&gt;masks_combine_combo,</a>
<a name="ln2521">                                _(&quot;how to combine individual drawn mask and different channels of parametric mask&quot;));</a>
<a name="ln2522">    g_signal_connect(G_OBJECT(bd-&gt;masks_combine_combo), &quot;value-changed&quot;,</a>
<a name="ln2523">                     G_CALLBACK(_blendop_masks_combine_callback), bd);</a>
<a name="ln2524"> </a>
<a name="ln2525"> </a>
<a name="ln2526">    bd-&gt;masks_invert_combo = dt_bauhaus_combobox_new(module);</a>
<a name="ln2527">    dt_bauhaus_widget_set_label(bd-&gt;masks_invert_combo, _(&quot;blend&quot;), _(&quot;invert mask&quot;));</a>
<a name="ln2528"> </a>
<a name="ln2529">    dt_bauhaus_combobox_add(bd-&gt;masks_invert_combo, _(&quot;off&quot;));</a>
<a name="ln2530">    bd-&gt;masks_invert = g_list_append(bd-&gt;masks_invert, GUINT_TO_POINTER(DEVELOP_COMBINE_NORM));</a>
<a name="ln2531"> </a>
<a name="ln2532">    dt_bauhaus_combobox_add(bd-&gt;masks_invert_combo, _(&quot;on&quot;));</a>
<a name="ln2533">    bd-&gt;masks_invert = g_list_append(bd-&gt;masks_invert, GUINT_TO_POINTER(DEVELOP_COMBINE_INV));</a>
<a name="ln2534"> </a>
<a name="ln2535">    dt_bauhaus_combobox_set(bd-&gt;masks_invert_combo, 0);</a>
<a name="ln2536">    gtk_widget_set_tooltip_text(bd-&gt;masks_invert_combo, _(&quot;apply mask in normal or inverted mode&quot;));</a>
<a name="ln2537">    g_signal_connect(G_OBJECT(bd-&gt;masks_invert_combo), &quot;value-changed&quot;,</a>
<a name="ln2538">                     G_CALLBACK(_blendop_masks_invert_callback), bd);</a>
<a name="ln2539"> </a>
<a name="ln2540"> </a>
<a name="ln2541">    bd-&gt;masks_feathering_guide_combo = dt_bauhaus_combobox_new(module);</a>
<a name="ln2542">    dt_bauhaus_widget_set_label(bd-&gt;masks_feathering_guide_combo, _(&quot;feathering guide&quot;), _(&quot;feathering guide&quot;));</a>
<a name="ln2543"> </a>
<a name="ln2544">    dt_bauhaus_combobox_add(bd-&gt;masks_feathering_guide_combo, _(&quot;output image&quot;));</a>
<a name="ln2545">    bd-&gt;masks_feathering_guide</a>
<a name="ln2546">        = g_list_append(bd-&gt;masks_feathering_guide, GUINT_TO_POINTER(DEVELOP_MASK_GUIDE_OUT));</a>
<a name="ln2547"> </a>
<a name="ln2548">    dt_bauhaus_combobox_add(bd-&gt;masks_feathering_guide_combo, _(&quot;input image&quot;));</a>
<a name="ln2549">    bd-&gt;masks_feathering_guide</a>
<a name="ln2550">        = g_list_append(bd-&gt;masks_feathering_guide, GUINT_TO_POINTER(DEVELOP_MASK_GUIDE_IN));</a>
<a name="ln2551"> </a>
<a name="ln2552">    dt_bauhaus_combobox_set(bd-&gt;masks_feathering_guide_combo, 0);</a>
<a name="ln2553">    gtk_widget_set_tooltip_text(bd-&gt;masks_feathering_guide_combo,</a>
<a name="ln2554">                                _(&quot;choose to guide mask by input or output image&quot;));</a>
<a name="ln2555">    g_signal_connect(G_OBJECT(bd-&gt;masks_feathering_guide_combo), &quot;value-changed&quot;,</a>
<a name="ln2556">                     G_CALLBACK(_blendop_masks_feathering_guide_callback), bd);</a>
<a name="ln2557"> </a>
<a name="ln2558"> </a>
<a name="ln2559">    bd-&gt;feathering_radius_slider = dt_bauhaus_slider_new_with_range(module, 0.0, 250.0, 0.1, 0.0, 1);</a>
<a name="ln2560">    dt_bauhaus_widget_set_label(bd-&gt;feathering_radius_slider, _(&quot;blend&quot;), _(&quot;feathering radius&quot;));</a>
<a name="ln2561">    dt_bauhaus_slider_set_format(bd-&gt;feathering_radius_slider, &quot;%.1f&quot;);</a>
<a name="ln2562">    gtk_widget_set_tooltip_text(bd-&gt;feathering_radius_slider, _(&quot;spatial radius of feathering&quot;));</a>
<a name="ln2563">    g_signal_connect(G_OBJECT(bd-&gt;feathering_radius_slider), &quot;value-changed&quot;,</a>
<a name="ln2564">                     G_CALLBACK(_blendop_blendif_feathering_radius_callback), bd);</a>
<a name="ln2565"> </a>
<a name="ln2566"> </a>
<a name="ln2567">    bd-&gt;blur_radius_slider = dt_bauhaus_slider_new_with_range(module, 0.0, 100.0, 0.1, 0.0, 1);</a>
<a name="ln2568">    dt_bauhaus_widget_set_label(bd-&gt;blur_radius_slider, _(&quot;blend&quot;), _(&quot;mask blur&quot;));</a>
<a name="ln2569">    dt_bauhaus_slider_set_format(bd-&gt;blur_radius_slider, &quot;%.1f&quot;);</a>
<a name="ln2570">    gtk_widget_set_tooltip_text(bd-&gt;blur_radius_slider, _(&quot;radius for gaussian blur of blend mask&quot;));</a>
<a name="ln2571">    g_signal_connect(G_OBJECT(bd-&gt;blur_radius_slider), &quot;value-changed&quot;,</a>
<a name="ln2572">                     G_CALLBACK(_blendop_blendif_blur_radius_callback), bd);</a>
<a name="ln2573"> </a>
<a name="ln2574"> </a>
<a name="ln2575">    bd-&gt;brightness_slider = dt_bauhaus_slider_new_with_range(module, -1.0, 1.0, 0.01, 0.0, 2);</a>
<a name="ln2576">    dt_bauhaus_widget_set_label(bd-&gt;brightness_slider, _(&quot;blend&quot;), _(&quot;mask opacity&quot;));</a>
<a name="ln2577">    dt_bauhaus_slider_set_format(bd-&gt;brightness_slider, &quot;%.2f&quot;);</a>
<a name="ln2578">    gtk_widget_set_tooltip_text(bd-&gt;brightness_slider, _(&quot;shifts and tilts the tone curve of the blend mask to adjust its &quot;</a>
<a name="ln2579">                                                         &quot;brightness without affecting fully transparent/fully opaque &quot;</a>
<a name="ln2580">                                                         &quot;regions&quot;));</a>
<a name="ln2581">    g_signal_connect(G_OBJECT(bd-&gt;brightness_slider), &quot;value-changed&quot;,</a>
<a name="ln2582">                     G_CALLBACK(_blendop_blendif_brightness_callback), bd);</a>
<a name="ln2583"> </a>
<a name="ln2584"> </a>
<a name="ln2585">    bd-&gt;contrast_slider = dt_bauhaus_slider_new_with_range(module, -1.0, 1.0, 0.01, 0.0, 2);</a>
<a name="ln2586">    dt_bauhaus_widget_set_label(bd-&gt;contrast_slider, _(&quot;blend&quot;), _(&quot;mask contrast&quot;));</a>
<a name="ln2587">    dt_bauhaus_slider_set_format(bd-&gt;contrast_slider, &quot;%.2f&quot;);</a>
<a name="ln2588">    gtk_widget_set_tooltip_text(bd-&gt;contrast_slider, _(&quot;gives the tone curve of the blend mask an s-like shape to &quot;</a>
<a name="ln2589">                                                       &quot;adjust its contrast&quot;));</a>
<a name="ln2590">    g_signal_connect(G_OBJECT(bd-&gt;contrast_slider), &quot;value-changed&quot;,</a>
<a name="ln2591">                     G_CALLBACK(_blendop_blendif_contrast_callback), bd);</a>
<a name="ln2592"> </a>
<a name="ln2593"> </a>
<a name="ln2594">    bd-&gt;showmask = dtgtk_button_new(dtgtk_cairo_paint_showmask, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln2595">    gtk_widget_set_tooltip_text(bd-&gt;showmask, _(&quot;display mask and/or color channel. ctrl-click to display mask, &quot;</a>
<a name="ln2596">                                                &quot;shift-click to display channel. hover over parametric mask slider to &quot;</a>
<a name="ln2597">                                                &quot;select channel for display&quot;));</a>
<a name="ln2598">    gtk_widget_set_size_request(GTK_WIDGET(bd-&gt;showmask), bs, bs);</a>
<a name="ln2599">    g_signal_connect(G_OBJECT(bd-&gt;showmask), &quot;button-press-event&quot;, G_CALLBACK(_blendop_blendif_showmask_clicked), module);</a>
<a name="ln2600">    gtk_widget_set_name(bd-&gt;showmask, &quot;show_mask_button&quot;);</a>
<a name="ln2601"> </a>
<a name="ln2602">    bd-&gt;suppress</a>
<a name="ln2603">        = dtgtk_togglebutton_new(dtgtk_cairo_paint_eye_toggle, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln2604">    gtk_widget_set_tooltip_text(bd-&gt;suppress, _(&quot;temporarily switch off blend mask. only for module in focus&quot;));</a>
<a name="ln2605">    gtk_widget_set_size_request(GTK_WIDGET(bd-&gt;suppress), bs, bs);</a>
<a name="ln2606">    g_signal_connect(G_OBJECT(bd-&gt;suppress), &quot;toggled&quot;, G_CALLBACK(_blendop_blendif_suppress_toggled), module);</a>
<a name="ln2607"> </a>
<a name="ln2608">    GtkWidget *box = gtk_box_new(GTK_ORIENTATION_VERTICAL, DT_BAUHAUS_SPACE);</a>
<a name="ln2609">    gtk_box_pack_start(GTK_BOX(iopw), GTK_WIDGET(box), TRUE, TRUE, 0);</a>
<a name="ln2610"> </a>
<a name="ln2611">    GtkWidget *blend_label = dt_ui_section_label_new(_(&quot;blend options&quot;));</a>
<a name="ln2612">    gtk_box_pack_start(GTK_BOX(box), blend_label, TRUE, TRUE, 0);</a>
<a name="ln2613">    gtk_widget_set_tooltip_text(GTK_WIDGET(blend_label), _(&quot;activate blending: uniformly, with drawn mask, with &quot;</a>
<a name="ln2614">                                                        &quot;parametric mask, or combination of both&quot;));</a>
<a name="ln2615"> </a>
<a name="ln2616">    //box enclosing the mask mode selection buttons</a>
<a name="ln2617">    bd-&gt;masks_modes_box = GTK_BOX(gtk_box_new(GTK_ORIENTATION_HORIZONTAL, DT_BAUHAUS_SPACE));</a>
<a name="ln2618">    //mask selection buttons packing in mask_box</a>
<a name="ln2619">    for (int i = 0; i &lt; g_list_length(bd-&gt;masks_modes_toggles); i++)</a>
<a name="ln2620">      gtk_box_pack_start(GTK_BOX(bd-&gt;masks_modes_box), GTK_WIDGET(g_list_nth_data(bd-&gt;masks_modes_toggles, i)), TRUE, TRUE, 0);</a>
<a name="ln2621">    gtk_box_pack_start(GTK_BOX(box), GTK_WIDGET(bd-&gt;masks_modes_box), FALSE, FALSE, 0);</a>
<a name="ln2622">    dt_gui_add_help_link(GTK_WIDGET(bd-&gt;masks_modes_box), &quot;blending.html&quot;);</a>
<a name="ln2623"> </a>
<a name="ln2624">    bd-&gt;top_box = GTK_BOX(gtk_box_new(GTK_ORIENTATION_VERTICAL, DT_BAUHAUS_SPACE));</a>
<a name="ln2625">    gtk_box_pack_start(GTK_BOX(bd-&gt;top_box), bd-&gt;blend_modes_combo, TRUE, TRUE, 0);</a>
<a name="ln2626">    gtk_box_pack_start(GTK_BOX(bd-&gt;top_box), bd-&gt;opacity_slider, TRUE, TRUE, 0);</a>
<a name="ln2627">    gtk_box_pack_start(GTK_BOX(box), GTK_WIDGET(bd-&gt;top_box), TRUE, TRUE, 0);</a>
<a name="ln2628"> </a>
<a name="ln2629">    dt_iop_gui_init_masks(GTK_BOX(iopw), module);</a>
<a name="ln2630">    dt_iop_gui_init_raster(GTK_BOX(iopw), module);</a>
<a name="ln2631">    dt_iop_gui_init_blendif(GTK_BOX(iopw), module);</a>
<a name="ln2632"> </a>
<a name="ln2633">    GtkWidget *hbox = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 4*DT_BAUHAUS_SPACE);</a>
<a name="ln2634">    gtk_box_pack_end(GTK_BOX(hbox), GTK_WIDGET(bd-&gt;showmask), FALSE, FALSE, 0);</a>
<a name="ln2635">    gtk_box_pack_end(GTK_BOX(hbox), GTK_WIDGET(bd-&gt;suppress), FALSE, FALSE, 0);</a>
<a name="ln2636">    bd-&gt;bottom_box = GTK_BOX(gtk_box_new(GTK_ORIENTATION_VERTICAL, DT_BAUHAUS_SPACE));</a>
<a name="ln2637">    gtk_box_pack_start(GTK_BOX(bd-&gt;bottom_box), GTK_WIDGET(bd-&gt;masks_combine_combo), TRUE, TRUE, 0);</a>
<a name="ln2638">    gtk_box_pack_start(GTK_BOX(bd-&gt;bottom_box), GTK_WIDGET(bd-&gt;masks_invert_combo), TRUE, TRUE, 0);</a>
<a name="ln2639">    gtk_box_pack_start(GTK_BOX(bd-&gt;bottom_box), dt_ui_section_label_new(_(&quot;mask refinement&quot;)), TRUE, TRUE, 0);</a>
<a name="ln2640">    gtk_box_pack_start(GTK_BOX(bd-&gt;bottom_box), bd-&gt;masks_feathering_guide_combo, TRUE, TRUE, 0);</a>
<a name="ln2641">    gtk_box_pack_start(GTK_BOX(bd-&gt;bottom_box), bd-&gt;feathering_radius_slider, TRUE, TRUE, 0);</a>
<a name="ln2642">    gtk_box_pack_start(GTK_BOX(bd-&gt;bottom_box), bd-&gt;blur_radius_slider, TRUE, TRUE, 0);</a>
<a name="ln2643">    gtk_box_pack_start(GTK_BOX(bd-&gt;bottom_box), bd-&gt;brightness_slider, TRUE, TRUE, 0);</a>
<a name="ln2644">    gtk_box_pack_start(GTK_BOX(bd-&gt;bottom_box), bd-&gt;contrast_slider, TRUE, TRUE, 0);</a>
<a name="ln2645">    gtk_box_pack_start(GTK_BOX(bd-&gt;bottom_box), hbox, TRUE, TRUE, 0);</a>
<a name="ln2646">    gtk_box_pack_start(GTK_BOX(iopw), GTK_WIDGET(bd-&gt;bottom_box), TRUE, TRUE, 0);</a>
<a name="ln2647">    dt_gui_add_help_link(GTK_WIDGET(bd-&gt;bottom_box), &quot;combined_masks.html&quot;);</a>
<a name="ln2648"> </a>
<a name="ln2649">    bd-&gt;blend_inited = 1;</a>
<a name="ln2650">    gtk_widget_queue_draw(GTK_WIDGET(iopw));</a>
<a name="ln2651">    dt_iop_gui_update_blending(module);</a>
<a name="ln2652"> </a>
<a name="ln2653">  }</a>
<a name="ln2654">}</a>
<a name="ln2655"> </a>
<a name="ln2656">// modelines: These editor modelines have been set for all relevant files by tools/update_modelines.sh</a>
<a name="ln2657">// vim: shiftwidth=2 expandtab tabstop=2 cindent</a>
<a name="ln2658">// kate: tab-indents: off; indent-width 2; replace-tabs on; indent-mode cstyle; remove-trailing-spaces modified;</a>

</code></pre>
<div class="balloon" rel="679"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v575/" target="_blank">V575</a> The null pointer is passed into 'g_list_index' function. Inspect the second argument.</p></div>
<div class="balloon" rel="692"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v575/" target="_blank">V575</a> The null pointer is passed into 'g_list_index' function. Inspect the second argument.</p></div>
<div class="balloon" rel="1809"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v522/" target="_blank">V522</a> There might be dereferencing of a potential null pointer 'entry'. Check lines: 1809, 1808.</p></div>
<div class="balloon" rel="1983"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v575/" target="_blank">V575</a> The null pointer is passed into 'g_list_index' function. Inspect the second argument.</p></div>
<div class="balloon" rel="1997"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v575/" target="_blank">V575</a> The null pointer is passed into 'g_list_index' function. Inspect the second argument.</p></div>
<div class="balloon" rel="2331"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v575/" target="_blank">V575</a> The null pointer is passed into 'g_list_index' function. Inspect the second argument.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
