
<html>
<head>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>
<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2">    This file is part of darktable,</a>
<a name="ln3">    copyright (c) 2012 Pierre Lamot</a>
<a name="ln4">    copyright (c) 2015 tobias ellinghaus</a>
<a name="ln5"> </a>
<a name="ln6">    darktable is free software: you can redistribute it and/or modify</a>
<a name="ln7">    it under the terms of the GNU General Public License as published by</a>
<a name="ln8">    the Free Software Foundation, either version 3 of the License, or</a>
<a name="ln9">    (at your option) any later version.</a>
<a name="ln10"> </a>
<a name="ln11">    darktable is distributed in the hope that it will be useful,</a>
<a name="ln12">    but WITHOUT ANY WARRANTY; without even the implied warranty of</a>
<a name="ln13">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</a>
<a name="ln14">    GNU General Public License for more details.</a>
<a name="ln15"> </a>
<a name="ln16">    You should have received a copy of the GNU General Public License</a>
<a name="ln17">    along with darktable.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</a>
<a name="ln18">*/</a>
<a name="ln19"> </a>
<a name="ln20">#include &quot;common/darktable.h&quot;</a>
<a name="ln21">#include &quot;common/image.h&quot;</a>
<a name="ln22">#include &quot;common/image_cache.h&quot;</a>
<a name="ln23">#include &quot;common/imageio.h&quot;</a>
<a name="ln24">#include &quot;common/imageio_module.h&quot;</a>
<a name="ln25">#include &quot;common/metadata.h&quot;</a>
<a name="ln26">#include &quot;common/pwstorage/pwstorage.h&quot;</a>
<a name="ln27">#include &quot;common/tags.h&quot;</a>
<a name="ln28">#include &quot;common/curl_tools.h&quot;</a>
<a name="ln29">#include &quot;control/conf.h&quot;</a>
<a name="ln30">#include &quot;control/control.h&quot;</a>
<a name="ln31">#include &quot;dtgtk/button.h&quot;</a>
<a name="ln32">#include &quot;gui/gtk.h&quot;</a>
<a name="ln33">#include &quot;imageio/storage/imageio_storage_api.h&quot;</a>
<a name="ln34">#ifdef GDK_WINDOWING_QUARTZ</a>
<a name="ln35">#include &quot;osx/osx.h&quot;</a>
<a name="ln36">#endif</a>
<a name="ln37">#include &lt;curl/curl.h&gt;</a>
<a name="ln38">#include &lt;json-glib/json-glib.h&gt;</a>
<a name="ln39">#include &lt;stdio.h&gt;</a>
<a name="ln40">#include &lt;stdlib.h&gt;</a>
<a name="ln41">#include &lt;unistd.h&gt;</a>
<a name="ln42"> </a>
<a name="ln43">#ifdef HAVE_HTTP_SERVER</a>
<a name="ln44">#include &quot;common/http_server.h&quot;</a>
<a name="ln45">static const int port_pool[] = { 8123, 9123, 10123, 11123 };</a>
<a name="ln46">static const int n_ports = sizeof(port_pool) / sizeof(port_pool[0]);</a>
<a name="ln47">#endif</a>
<a name="ln48"> </a>
<a name="ln49">DT_MODULE(1)</a>
<a name="ln50"> </a>
<a name="ln51">#define FB_CALLBACK_ID &quot;facebook&quot;</a>
<a name="ln52">#define FB_WS_BASE_URL &quot;https://www.facebook.com/&quot;</a>
<a name="ln53">#define FB_GRAPH_BASE_URL &quot;https://graph.facebook.com/v2.8/&quot;</a>
<a name="ln54">#define FB_API_KEY &quot;315766121847254&quot;</a>
<a name="ln55"> </a>
<a name="ln56">// facebook doesn't allow pictures bigger than FB_IMAGE_MAX_SIZExFB_IMAGE_MAX_SIZE px</a>
<a name="ln57">#define FB_IMAGE_MAX_SIZE 2048</a>
<a name="ln58"> </a>
<a name="ln59">#define MSGCOLOR_RED &quot;#e07f7f&quot;</a>
<a name="ln60">#define MSGCOLOR_GREEN &quot;#7fe07f&quot;</a>
<a name="ln61">#define FACEBOOK_EXTRA_VERBOSE FALSE</a>
<a name="ln62"> </a>
<a name="ln63">typedef enum ComboUserModel</a>
<a name="ln64">{</a>
<a name="ln65">  COMBO_USER_MODEL_NAME_COL = 0,</a>
<a name="ln66">  COMBO_USER_MODEL_TOKEN_COL,</a>
<a name="ln67">  COMBO_USER_MODEL_ID_COL,</a>
<a name="ln68">  COMBO_USER_MODEL_NB_COL</a>
<a name="ln69">} ComboUserModel;</a>
<a name="ln70"> </a>
<a name="ln71">typedef enum ComboAlbumModel</a>
<a name="ln72">{</a>
<a name="ln73">  COMBO_ALBUM_MODEL_NAME_COL = 0,</a>
<a name="ln74">  COMBO_ALBUM_MODEL_ID_COL,</a>
<a name="ln75">  COMBO_ALBUM_MODEL_NB_COL</a>
<a name="ln76">} ComboAlbumModel;</a>
<a name="ln77"> </a>
<a name="ln78">typedef enum ComboPrivacyModel</a>
<a name="ln79">{</a>
<a name="ln80">  COMBO_PRIVACY_MODEL_NAME_COL = 0,</a>
<a name="ln81">  COMBO_PRIVACY_MODEL_VAL_COL,</a>
<a name="ln82">  COMBO_PRIVACY_MODEL_NB_COL</a>
<a name="ln83">} ComboPrivacyModel;</a>
<a name="ln84"> </a>
<a name="ln85"> </a>
<a name="ln86">/*</a>
<a name="ln87"> * note: we don't support some kinds of privacy setting:</a>
<a name="ln88"> *  CUSTOM : no plan to do this one for the moment</a>
<a name="ln89"> *  NETWORKS_FRIENDS : this seems to be deprecated, it is currently impossible</a>
<a name="ln90"> *      to create a new network (https://www.facebook.com/help/networks)</a>
<a name="ln91"> */</a>
<a name="ln92">typedef enum FBAlbumPrivacyPolicy</a>
<a name="ln93">{</a>
<a name="ln94">  FBALBUM_PRIVACY_EVERYONE,</a>
<a name="ln95">  FBALBUM_PRIVACY_ALL_FRIENDS,</a>
<a name="ln96">  FBALBUM_PRIVACY_NETWORKS_FRIENDS, // not implemented</a>
<a name="ln97">  FBALBUM_PRIVACY_FRIENDS_OF_FRIENDS,</a>
<a name="ln98">  FBALBUM_PRIVACY_SELF,</a>
<a name="ln99">  FBALBUM_PRIVACY_CUSTOM // not implemented</a>
<a name="ln100">} FBAlbumPrivacyPolicy;</a>
<a name="ln101"> </a>
<a name="ln102"> </a>
<a name="ln103">/**</a>
<a name="ln104"> * Represents information about an album</a>
<a name="ln105"> */</a>
<a name="ln106">typedef struct FBAlbum</a>
<a name="ln107">{</a>
<a name="ln108">  gchar *id;</a>
<a name="ln109">  gchar *name;</a>
<a name="ln110">  FBAlbumPrivacyPolicy privacy;</a>
<a name="ln111">} FBAlbum;</a>
<a name="ln112"> </a>
<a name="ln113">static FBAlbum *fb_album_init()</a>
<a name="ln114">{</a>
<a name="ln115">  return (FBAlbum *)g_malloc0(sizeof(FBAlbum));</a>
<a name="ln116">}</a>
<a name="ln117"> </a>
<a name="ln118">static void fb_album_destroy(FBAlbum *album)</a>
<a name="ln119">{</a>
<a name="ln120">  if(album == NULL) return;</a>
<a name="ln121">  g_free(album-&gt;id);</a>
<a name="ln122">  g_free(album-&gt;name);</a>
<a name="ln123">  g_free(album);</a>
<a name="ln124">}</a>
<a name="ln125"> </a>
<a name="ln126">/**</a>
<a name="ln127"> * Represents information about an account</a>
<a name="ln128"> */</a>
<a name="ln129">typedef struct FBAccountInfo</a>
<a name="ln130">{</a>
<a name="ln131">  gchar *id;</a>
<a name="ln132">  gchar *readablename;</a>
<a name="ln133">  gchar *token;</a>
<a name="ln134">} FBAccountInfo;</a>
<a name="ln135"> </a>
<a name="ln136">static FBAccountInfo *fb_account_info_init()</a>
<a name="ln137">{</a>
<a name="ln138">  return (FBAccountInfo *)g_malloc0(sizeof(FBAccountInfo));</a>
<a name="ln139">}</a>
<a name="ln140"> </a>
<a name="ln141">static void fb_account_info_destroy(FBAccountInfo *account)</a>
<a name="ln142">{</a>
<a name="ln143">  if(account == NULL) return;</a>
<a name="ln144">  g_free(account-&gt;id);</a>
<a name="ln145">  g_free(account-&gt;readablename);</a>
<a name="ln146">  g_free(account-&gt;token);</a>
<a name="ln147">  g_free(account);</a>
<a name="ln148">}</a>
<a name="ln149"> </a>
<a name="ln150">typedef struct FBContext</a>
<a name="ln151">{</a>
<a name="ln152">  /// curl context</a>
<a name="ln153">  CURL *curl_ctx;</a>
<a name="ln154">  /// Json parser context</a>
<a name="ln155">  JsonParser *json_parser;</a>
<a name="ln156"> </a>
<a name="ln157">  GString *errmsg;</a>
<a name="ln158"> </a>
<a name="ln159">  /// authorization token</a>
<a name="ln160">  gchar *token;</a>
<a name="ln161"> </a>
<a name="ln162">  gchar *album_id;</a>
<a name="ln163">  char *album_title;</a>
<a name="ln164">  char *album_summary;</a>
<a name="ln165">  int album_permission;</a>
<a name="ln166">  gboolean new_album;</a>
<a name="ln167">} FBContext;</a>
<a name="ln168"> </a>
<a name="ln169">typedef struct dt_storage_facebook_gui_data_t</a>
<a name="ln170">{</a>
<a name="ln171">  // == ui elements ==</a>
<a name="ln172">  GtkLabel *label_status;</a>
<a name="ln173"> </a>
<a name="ln174">  GtkComboBox *comboBox_username;</a>
<a name="ln175">  GtkButton *button_login;</a>
<a name="ln176"> </a>
<a name="ln177">  GtkDarktableButton *dtbutton_refresh_album;</a>
<a name="ln178">  GtkComboBox *comboBox_album;</a>
<a name="ln179"> </a>
<a name="ln180">  //  == album creation section ==</a>
<a name="ln181">  GtkLabel *label_album_title;</a>
<a name="ln182">  GtkLabel *label_album_summary;</a>
<a name="ln183">  GtkLabel *label_album_privacy;</a>
<a name="ln184"> </a>
<a name="ln185">  GtkEntry *entry_album_title;</a>
<a name="ln186">  GtkEntry *entry_album_summary;</a>
<a name="ln187">  GtkComboBox *comboBox_privacy;</a>
<a name="ln188"> </a>
<a name="ln189">  GtkBox *hbox_album;</a>
<a name="ln190"> </a>
<a name="ln191">  // == context ==</a>
<a name="ln192">  gboolean connected;</a>
<a name="ln193">  FBContext *facebook_api;</a>
<a name="ln194"> </a>
<a name="ln195">  // == authentication dialog ==</a>
<a name="ln196">  GtkMessageDialog *auth_dialog;</a>
<a name="ln197">} dt_storage_facebook_gui_data_t;</a>
<a name="ln198"> </a>
<a name="ln199"> </a>
<a name="ln200">static FBContext *fb_api_init()</a>
<a name="ln201">{</a>
<a name="ln202">  FBContext *ctx = (FBContext *)g_malloc0(sizeof(FBContext));</a>
<a name="ln203">  ctx-&gt;curl_ctx = curl_easy_init();</a>
<a name="ln204">  ctx-&gt;errmsg = g_string_new(&quot;&quot;);</a>
<a name="ln205">  ctx-&gt;json_parser = json_parser_new();</a>
<a name="ln206">  return ctx;</a>
<a name="ln207">}</a>
<a name="ln208"> </a>
<a name="ln209"> </a>
<a name="ln210">static void fb_api_destroy(FBContext *ctx)</a>
<a name="ln211">{</a>
<a name="ln212">  if(ctx == NULL) return;</a>
<a name="ln213">  curl_easy_cleanup(ctx-&gt;curl_ctx);</a>
<a name="ln214">  g_free(ctx-&gt;token);</a>
<a name="ln215">  g_object_unref(ctx-&gt;json_parser);</a>
<a name="ln216">  g_string_free(ctx-&gt;errmsg, TRUE);</a>
<a name="ln217">  g_free(ctx);</a>
<a name="ln218">}</a>
<a name="ln219"> </a>
<a name="ln220"> </a>
<a name="ln221">typedef struct dt_storage_facebook_param_t</a>
<a name="ln222">{</a>
<a name="ln223">  gint64 hash;</a>
<a name="ln224">  FBContext *facebook_ctx;</a>
<a name="ln225">} dt_storage_facebook_param_t;</a>
<a name="ln226"> </a>
<a name="ln227"> </a>
<a name="ln228">//////////////////////////// curl requests related functions</a>
<a name="ln229"> </a>
<a name="ln230">/**</a>
<a name="ln231"> * extract the user token from the callback @a url</a>
<a name="ln232"> */</a>
<a name="ln233">static gchar *fb_extract_token_from_url(const gchar *url)</a>
<a name="ln234">{</a>
<a name="ln235">  g_return_val_if_fail((url != NULL), NULL);</a>
<a name="ln236">  if(!(g_str_has_prefix(url, &quot;http://localhost:8123/&quot; FB_CALLBACK_ID) == TRUE)) return NULL;</a>
<a name="ln237"> </a>
<a name="ln238">  char *authtoken = NULL;</a>
<a name="ln239"> </a>
<a name="ln240">  char **urlchunks = g_strsplit_set(url, &quot;#&amp;=&quot;, -1);</a>
<a name="ln241">  // starts at 1 to skip the url prefix, then values are in the form key=value</a>
<a name="ln242">  for(int i = 1; urlchunks[i] != NULL; i += 2)</a>
<a name="ln243">  {</a>
<a name="ln244">    if((g_strcmp0(urlchunks[i], &quot;access_token&quot;) == 0) &amp;&amp; (urlchunks[i + 1] != NULL))</a>
<a name="ln245">    {</a>
<a name="ln246">      authtoken = g_strdup(urlchunks[i + 1]);</a>
<a name="ln247">      break;</a>
<a name="ln248">    }</a>
<a name="ln249">    else if(g_strcmp0(urlchunks[i], &quot;error&quot;) == 0)</a>
<a name="ln250">    {</a>
<a name="ln251">      break;</a>
<a name="ln252">    }</a>
<a name="ln253">    if(urlchunks[i + 1] == NULL) // this shouldn't happens but we never know...</a>
<a name="ln254">    {</a>
<a name="ln255">      g_printerr(_(&quot;[facebook] unexpected URL format\n&quot;));</a>
<a name="ln256">      break;</a>
<a name="ln257">    }</a>
<a name="ln258">  }</a>
<a name="ln259">  g_strfreev(urlchunks);</a>
<a name="ln260">  return authtoken;</a>
<a name="ln261">}</a>
<a name="ln262"> </a>
<a name="ln263">static size_t curl_write_data_cb(void *ptr, size_t size, size_t nmemb, void *data)</a>
<a name="ln264">{</a>
<a name="ln265">  GString *string = (GString *)data;</a>
<a name="ln266">  g_string_append_len(string, ptr, size * nmemb);</a>
<a name="ln267">#if FACEBOOK_EXTRA_VERBOSE == TRUE</a>
<a name="ln268">  g_printf(&quot;server reply: %s\n&quot;, string-&gt;str);</a>
<a name="ln269">#endif</a>
<a name="ln270">  return size * nmemb;</a>
<a name="ln271">}</a>
<a name="ln272"> </a>
<a name="ln273">static JsonObject *fb_parse_response(FBContext *ctx, GString *response)</a>
<a name="ln274">{</a>
<a name="ln275">  GError *error;</a>
<a name="ln276">  const gboolean ret = json_parser_load_from_data(ctx-&gt;json_parser, response-&gt;str, response-&gt;len, &amp;error);</a>
<a name="ln277">  g_return_val_if_fail((ret), NULL);</a>
<a name="ln278"> </a>
<a name="ln279">  JsonNode *root = json_parser_get_root(ctx-&gt;json_parser);</a>
<a name="ln280">  // we should always have a dict</a>
<a name="ln281">  g_return_val_if_fail((json_node_get_node_type(root) == JSON_NODE_OBJECT), NULL);</a>
<a name="ln282"> </a>
<a name="ln283">  JsonObject *rootdict = json_node_get_object(root);</a>
<a name="ln284">  if(json_object_has_member(rootdict, &quot;error&quot;))</a>
<a name="ln285">  {</a>
<a name="ln286">    JsonObject *errorstruct = json_object_get_object_member(rootdict, &quot;error&quot;);</a>
<a name="ln287">    g_return_val_if_fail((errorstruct != NULL), NULL);</a>
<a name="ln288">    const gchar *errormessage = json_object_get_string_member(errorstruct, &quot;message&quot;);</a>
<a name="ln289">    g_return_val_if_fail((errormessage != NULL), NULL);</a>
<a name="ln290">    g_string_assign(ctx-&gt;errmsg, errormessage);</a>
<a name="ln291">    return NULL;</a>
<a name="ln292">  }</a>
<a name="ln293"> </a>
<a name="ln294">  return rootdict;</a>
<a name="ln295">}</a>
<a name="ln296"> </a>
<a name="ln297"> </a>
<a name="ln298">static void fb_query_get_add_url_arguments(const gchar *key, const gchar *value, GString *url)</a>
<a name="ln299">{</a>
<a name="ln300">  g_string_append(url, &quot;&amp;&quot;);</a>
<a name="ln301">  g_string_append(url, key);</a>
<a name="ln302">  g_string_append(url, &quot;=&quot;);</a>
<a name="ln303">  g_string_append(url, value);</a>
<a name="ln304">}</a>
<a name="ln305"> </a>
<a name="ln306">/**</a>
<a name="ln307"> * perform a GET request on facebook graph api</a>
<a name="ln308"> *</a>
<a name="ln309"> * @note use this one to read information (user info, existing albums, ...)</a>
<a name="ln310"> *</a>
<a name="ln311"> * @param ctx facebook context (token field must be set)</a>
<a name="ln312"> * @param method the method to call on the facebook graph API, the methods should not start with '/' example:</a>
<a name="ln313"> *&quot;me/albums&quot;</a>
<a name="ln314"> * @param args hashtable of the arguments to be added to the requests, must be in the form key (string) =</a>
<a name="ln315"> *value (string)</a>
<a name="ln316"> * @returns NULL if the request fails, or a JsonObject of the reply</a>
<a name="ln317"> */</a>
<a name="ln318">static JsonObject *fb_query_get(FBContext *ctx, const gchar *method, GHashTable *args)</a>
<a name="ln319">{</a>
<a name="ln320">  g_return_val_if_fail(ctx != NULL, NULL);</a>
<a name="ln321">  g_return_val_if_fail(ctx-&gt;token != NULL, NULL);</a>
<a name="ln322">  // build the query</a>
<a name="ln323">  GString *url = g_string_new(FB_GRAPH_BASE_URL);</a>
<a name="ln324">  g_string_append(url, method);</a>
<a name="ln325">  g_string_append(url, &quot;?access_token=&quot;);</a>
<a name="ln326">  g_string_append(url, ctx-&gt;token);</a>
<a name="ln327">  if(args != NULL) g_hash_table_foreach(args, (GHFunc)fb_query_get_add_url_arguments, url);</a>
<a name="ln328"> </a>
<a name="ln329">  // send the request</a>
<a name="ln330">  GString *response = g_string_new(&quot;&quot;);</a>
<a name="ln331"> </a>
<a name="ln332">  dt_curl_init(ctx-&gt;curl_ctx, FACEBOOK_EXTRA_VERBOSE);</a>
<a name="ln333"> </a>
<a name="ln334">  curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_URL, url-&gt;str);</a>
<a name="ln335">  curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_WRITEFUNCTION, curl_write_data_cb);</a>
<a name="ln336">  curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_WRITEDATA, response);</a>
<a name="ln337">  int res = curl_easy_perform(ctx-&gt;curl_ctx);</a>
<a name="ln338"> </a>
<a name="ln339">  if(res != CURLE_OK)</a>
<a name="ln340">  {</a>
<a name="ln341">    g_string_free(url, TRUE);</a>
<a name="ln342">    g_string_free(response, TRUE);</a>
<a name="ln343">    return NULL;</a>
<a name="ln344">  }</a>
<a name="ln345"> </a>
<a name="ln346">  // parse the response</a>
<a name="ln347">  JsonObject *respobj = fb_parse_response(ctx, response);</a>
<a name="ln348"> </a>
<a name="ln349">  g_string_free(response, TRUE);</a>
<a name="ln350">  g_string_free(url, TRUE);</a>
<a name="ln351">  return respobj;</a>
<a name="ln352">}</a>
<a name="ln353"> </a>
<a name="ln354">typedef struct</a>
<a name="ln355">{</a>
<a name="ln356">  struct curl_httppost *formpost;</a>
<a name="ln357">  struct curl_httppost *lastptr;</a>
<a name="ln358">} HttppostFormList;</a>
<a name="ln359"> </a>
<a name="ln360">static void fb_query_post_add_form_arguments(const gchar *key, const gchar *value, HttppostFormList *formlist)</a>
<a name="ln361">{</a>
<a name="ln362">  curl_formadd(&amp;(formlist-&gt;formpost), &amp;(formlist-&gt;lastptr), CURLFORM_COPYNAME, key, CURLFORM_COPYCONTENTS,</a>
<a name="ln363">               value, CURLFORM_END);</a>
<a name="ln364">}</a>
<a name="ln365"> </a>
<a name="ln366">static void fb_query_post_add_file_arguments(const gchar *key, const gchar *value, HttppostFormList *formlist)</a>
<a name="ln367">{</a>
<a name="ln368">  curl_formadd(&amp;(formlist-&gt;formpost), &amp;(formlist-&gt;lastptr), CURLFORM_COPYNAME, key, CURLFORM_COPYCONTENTS,</a>
<a name="ln369">               value, CURLFORM_END);</a>
<a name="ln370"> </a>
<a name="ln371">  curl_formadd(&amp;(formlist-&gt;formpost), &amp;(formlist-&gt;lastptr), CURLFORM_COPYNAME, key, CURLFORM_FILE, value,</a>
<a name="ln372">               CURLFORM_END);</a>
<a name="ln373">}</a>
<a name="ln374"> </a>
<a name="ln375">/**</a>
<a name="ln376"> * perform a POST request on facebook graph api</a>
<a name="ln377"> *</a>
<a name="ln378"> * @note use this one to create object (album, photos, ...)</a>
<a name="ln379"> *</a>
<a name="ln380"> * @param ctx facebook context (token field must be set)</a>
<a name="ln381"> * @param method the method to call on the facebook graph API, the methods should not start with '/' example:</a>
<a name="ln382"> *&quot;me/albums&quot;</a>
<a name="ln383"> * @param args hashtable of the arguments to be added to the requests, might be null if none</a>
<a name="ln384"> * @param files hashtable of the files to be send with the requests, might be null if none</a>
<a name="ln385"> * @returns NULL if the request fails, or a JsonObject of the reply</a>
<a name="ln386"> */</a>
<a name="ln387">static JsonObject *fb_query_post(FBContext *ctx, const gchar *method, GHashTable *args, GHashTable *files)</a>
<a name="ln388">{</a>
<a name="ln389">  g_return_val_if_fail(ctx != NULL, NULL);</a>
<a name="ln390">  g_return_val_if_fail(ctx-&gt;token != NULL, NULL);</a>
<a name="ln391"> </a>
<a name="ln392">  GString *url = g_string_new(FB_GRAPH_BASE_URL);</a>
<a name="ln393">  g_string_append(url, method);</a>
<a name="ln394"> </a>
<a name="ln395">  HttppostFormList formlist;</a>
<a name="ln396">  formlist.formpost = NULL;</a>
<a name="ln397">  formlist.lastptr = NULL;</a>
<a name="ln398"> </a>
<a name="ln399">  curl_formadd(&amp;(formlist.formpost), &amp;(formlist.lastptr), CURLFORM_COPYNAME, &quot;access_token&quot;,</a>
<a name="ln400">               CURLFORM_COPYCONTENTS, ctx-&gt;token, CURLFORM_END);</a>
<a name="ln401">  if(args != NULL) g_hash_table_foreach(args, (GHFunc)fb_query_post_add_form_arguments, &amp;formlist);</a>
<a name="ln402"> </a>
<a name="ln403">  if(files != NULL) g_hash_table_foreach(files, (GHFunc)fb_query_post_add_file_arguments, &amp;formlist);</a>
<a name="ln404"> </a>
<a name="ln405">  // send the requests</a>
<a name="ln406">  GString *response = g_string_new(&quot;&quot;);</a>
<a name="ln407"> </a>
<a name="ln408">  dt_curl_init(ctx-&gt;curl_ctx, FACEBOOK_EXTRA_VERBOSE);</a>
<a name="ln409"> </a>
<a name="ln410">  curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_URL, url-&gt;str);</a>
<a name="ln411">  curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_HTTPPOST, formlist.formpost);</a>
<a name="ln412">  curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_WRITEFUNCTION, curl_write_data_cb);</a>
<a name="ln413">  curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_WRITEDATA, response);</a>
<a name="ln414">  int res = curl_easy_perform(ctx-&gt;curl_ctx);</a>
<a name="ln415">  curl_formfree(formlist.formpost);</a>
<a name="ln416">  g_string_free(url, TRUE);</a>
<a name="ln417">  if(res != CURLE_OK) return NULL;</a>
<a name="ln418">  // parse the response</a>
<a name="ln419">  JsonObject *respobj = fb_parse_response(ctx, response);</a>
<a name="ln420">  g_string_free(response, TRUE);</a>
<a name="ln421">  return respobj;</a>
<a name="ln422">}</a>
<a name="ln423"> </a>
<a name="ln424">//////////////////////////// facebook api functions</a>
<a name="ln425"> </a>
<a name="ln426">/**</a>
<a name="ln427"> * @returns TRUE if the current token is valid</a>
<a name="ln428"> */</a>
<a name="ln429">static gboolean fb_test_auth_token(FBContext *ctx)</a>
<a name="ln430">{</a>
<a name="ln431">  JsonObject *obj = fb_query_get(ctx, &quot;me&quot;, NULL);</a>
<a name="ln432">  return obj != NULL;</a>
<a name="ln433">}</a>
<a name="ln434"> </a>
<a name="ln435">/**</a>
<a name="ln436"> * @return a GList of FBAlbums associated to the user</a>
<a name="ln437"> */</a>
<a name="ln438">static GList *fb_get_album_list(FBContext *ctx, gboolean *ok)</a>
<a name="ln439">{</a>
<a name="ln440">  if(!ok) return NULL;</a>
<a name="ln441"> </a>
<a name="ln442">  *ok = TRUE;</a>
<a name="ln443">  GList *album_list = NULL;</a>
<a name="ln444"> </a>
<a name="ln445">  GHashTable *args = g_hash_table_new((GHashFunc)g_str_hash, (GEqualFunc)g_str_equal);</a>
<a name="ln446">  g_hash_table_insert(args, &quot;fields&quot;, &quot;id,name,can_upload&quot;);</a>
<a name="ln447">  JsonObject *reply = fb_query_get(ctx, &quot;me/albums&quot;, args);</a>
<a name="ln448">  g_hash_table_destroy(args);</a>
<a name="ln449"> </a>
<a name="ln450">  if(reply == NULL) goto error;</a>
<a name="ln451"> </a>
<a name="ln452">  JsonArray *jsalbums = json_object_get_array_member(reply, &quot;data&quot;);</a>
<a name="ln453">  if(jsalbums == NULL) goto error;</a>
<a name="ln454"> </a>
<a name="ln455">  guint i;</a>
<a name="ln456">  for(i = 0; i &lt; json_array_get_length(jsalbums); i++)</a>
<a name="ln457">  {</a>
<a name="ln458">    JsonObject *obj = json_array_get_object_element(jsalbums, i);</a>
<a name="ln459">    if(obj == NULL) continue;</a>
<a name="ln460"> </a>
<a name="ln461">    JsonNode *canupload_node = json_object_get_member(obj, &quot;can_upload&quot;);</a>
<a name="ln462">    if(canupload_node == NULL || !json_node_get_boolean(canupload_node)) continue;</a>
<a name="ln463"> </a>
<a name="ln464">    FBAlbum *album = fb_album_init();</a>
<a name="ln465">    if(album == NULL) goto error;</a>
<a name="ln466"> </a>
<a name="ln467">    const char *id = json_object_get_string_member(obj, &quot;id&quot;);</a>
<a name="ln468">    const char *name = json_object_get_string_member(obj, &quot;name&quot;);</a>
<a name="ln469">    if(id == NULL || name == NULL)</a>
<a name="ln470">    {</a>
<a name="ln471">      fb_album_destroy(album);</a>
<a name="ln472">      goto error;</a>
<a name="ln473">    }</a>
<a name="ln474">    album-&gt;id = g_strdup(id);</a>
<a name="ln475">    album-&gt;name = g_strdup(name);</a>
<a name="ln476">    album_list = g_list_append(album_list, album);</a>
<a name="ln477">  }</a>
<a name="ln478">  return album_list;</a>
<a name="ln479"> </a>
<a name="ln480">error:</a>
<a name="ln481">  *ok = FALSE;</a>
<a name="ln482">  g_list_free_full(album_list, (GDestroyNotify)fb_album_destroy);</a>
<a name="ln483">  return NULL;</a>
<a name="ln484">}</a>
<a name="ln485"> </a>
<a name="ln486">/**</a>
<a name="ln487"> * @see https://developers.facebook.com/docs/reference/api/user/</a>
<a name="ln488"> * @return the id of the newly reacted</a>
<a name="ln489"> */</a>
<a name="ln490">static const gchar *fb_create_album(FBContext *ctx, gchar *name, gchar *summary, FBAlbumPrivacyPolicy privacy)</a>
<a name="ln491">{</a>
<a name="ln492">  GHashTable *args = g_hash_table_new((GHashFunc)g_str_hash, (GEqualFunc)g_str_equal);</a>
<a name="ln493">  g_hash_table_insert(args, &quot;name&quot;, name);</a>
<a name="ln494">  if(summary != NULL) g_hash_table_insert(args, &quot;message&quot;, summary);</a>
<a name="ln495">  switch(privacy)</a>
<a name="ln496">  {</a>
<a name="ln497">    case FBALBUM_PRIVACY_EVERYONE:</a>
<a name="ln498">      g_hash_table_insert(args, &quot;privacy&quot;, &quot;{\&quot;value\&quot;:\&quot;EVERYONE\&quot;}&quot;);</a>
<a name="ln499">      break;</a>
<a name="ln500">    case FBALBUM_PRIVACY_ALL_FRIENDS:</a>
<a name="ln501">      g_hash_table_insert(args, &quot;privacy&quot;, &quot;{\&quot;value\&quot;:\&quot;ALL_FRIENDS\&quot;}&quot;);</a>
<a name="ln502">      break;</a>
<a name="ln503">    case FBALBUM_PRIVACY_FRIENDS_OF_FRIENDS:</a>
<a name="ln504">      g_hash_table_insert(args, &quot;privacy&quot;, &quot;{\&quot;value\&quot;:\&quot;FRIENDS_OF_FRIENDS\&quot;}&quot;);</a>
<a name="ln505">      break;</a>
<a name="ln506">    case FBALBUM_PRIVACY_SELF:</a>
<a name="ln507">      g_hash_table_insert(args, &quot;privacy&quot;, &quot;{\&quot;value\&quot;:\&quot;SELF\&quot;}&quot;);</a>
<a name="ln508">      break;</a>
<a name="ln509">    default:</a>
<a name="ln510">      goto error;</a>
<a name="ln511">      break;</a>
<a name="ln512">  }</a>
<a name="ln513">  JsonObject *ref = fb_query_post(ctx, &quot;me/albums&quot;, args, NULL);</a>
<a name="ln514">  if(ref == NULL) goto error;</a>
<a name="ln515">  g_hash_table_destroy(args);</a>
<a name="ln516">  return json_object_get_string_member(ref, &quot;id&quot;);</a>
<a name="ln517"> </a>
<a name="ln518">error:</a>
<a name="ln519">  g_hash_table_destroy(args);</a>
<a name="ln520">  return NULL;</a>
<a name="ln521">}</a>
<a name="ln522"> </a>
<a name="ln523">/**</a>
<a name="ln524"> * @see https://developers.facebook.com/docs/reference/api/album/</a>
<a name="ln525"> * @return the id of the uploaded photo</a>
<a name="ln526"> */</a>
<a name="ln527">static const gchar *fb_upload_photo_to_album(FBContext *ctx, gchar *albumid, gchar *fpath, gchar *description)</a>
<a name="ln528">{</a>
<a name="ln529">  GString *method = g_string_new(albumid);</a>
<a name="ln530">  g_string_append(method, &quot;/photos&quot;);</a>
<a name="ln531"> </a>
<a name="ln532">  GHashTable *files = g_hash_table_new((GHashFunc)g_str_hash, (GEqualFunc)g_str_equal);</a>
<a name="ln533">  g_hash_table_insert(files, &quot;source&quot;, fpath);</a>
<a name="ln534"> </a>
<a name="ln535">  GHashTable *args = NULL;</a>
<a name="ln536">  if(description != NULL)</a>
<a name="ln537">  {</a>
<a name="ln538">    args = g_hash_table_new((GHashFunc)g_str_hash, (GEqualFunc)g_str_equal);</a>
<a name="ln539">    g_hash_table_insert(args, &quot;message&quot;, description);</a>
<a name="ln540">  }</a>
<a name="ln541"> </a>
<a name="ln542">  JsonObject *ref = fb_query_post(ctx, method-&gt;str, args, files);</a>
<a name="ln543">  g_string_free(method, TRUE);</a>
<a name="ln544"> </a>
<a name="ln545">  g_hash_table_destroy(files);</a>
<a name="ln546">  if(args != NULL)</a>
<a name="ln547">  {</a>
<a name="ln548">    g_hash_table_destroy(args);</a>
<a name="ln549">  }</a>
<a name="ln550">  if(ref == NULL) return NULL;</a>
<a name="ln551">  return json_object_get_string_member(ref, &quot;id&quot;);</a>
<a name="ln552">}</a>
<a name="ln553"> </a>
<a name="ln554">/**</a>
<a name="ln555"> * @see https://developers.facebook.com/docs/reference/api/user/</a>
<a name="ln556"> * @return basic information about the account</a>
<a name="ln557"> */</a>
<a name="ln558">static FBAccountInfo *fb_get_account_info(FBContext *ctx)</a>
<a name="ln559">{</a>
<a name="ln560">  JsonObject *obj = fb_query_get(ctx, &quot;me&quot;, NULL);</a>
<a name="ln561">  g_return_val_if_fail((obj != NULL), NULL);</a>
<a name="ln562">  const gchar *readablename = json_object_get_string_member(obj, &quot;name&quot;);</a>
<a name="ln563">  const gchar *user_id = json_object_get_string_member(obj, &quot;id&quot;);</a>
<a name="ln564">  g_return_val_if_fail(readablename != NULL &amp;&amp; user_id != NULL, NULL);</a>
<a name="ln565">  FBAccountInfo *accountinfo = fb_account_info_init();</a>
<a name="ln566">  accountinfo-&gt;id = g_strdup(user_id);</a>
<a name="ln567">  accountinfo-&gt;readablename = g_strdup(readablename);</a>
<a name="ln568">  accountinfo-&gt;token = g_strdup(ctx-&gt;token);</a>
<a name="ln569">  return accountinfo;</a>
<a name="ln570">}</a>
<a name="ln571"> </a>
<a name="ln572"> </a>
<a name="ln573">///////////////////////////////// UI functions</a>
<a name="ln574"> </a>
<a name="ln575">static gboolean combobox_separator(GtkTreeModel *model, GtkTreeIter *iter, gpointer data)</a>
<a name="ln576">{</a>
<a name="ln577">  GValue value = {</a>
<a name="ln578">    0,</a>
<a name="ln579">  };</a>
<a name="ln580">  gtk_tree_model_get_value(model, iter, 0, &amp;value);</a>
<a name="ln581">  gchar *v = NULL;</a>
<a name="ln582">  if(G_VALUE_HOLDS_STRING(&amp;value))</a>
<a name="ln583">  {</a>
<a name="ln584">    if((v = (gchar *)g_value_get_string(&amp;value)) != NULL &amp;&amp; *v == '\0') return TRUE;</a>
<a name="ln585">  }</a>
<a name="ln586">  g_value_unset(&amp;value);</a>
<a name="ln587">  return FALSE;</a>
<a name="ln588">}</a>
<a name="ln589"> </a>
<a name="ln590">/**</a>
<a name="ln591"> * @see https://developers.facebook.com/docs/authentication/</a>
<a name="ln592"> * @returns NULL if the user cancels the operation or a valid token</a>
<a name="ln593"> */</a>
<a name="ln594">static gboolean _open_browser(const char *callback_url)</a>
<a name="ln595">{</a>
<a name="ln596">  GError *error = NULL;</a>
<a name="ln597">  char *url = g_strdup_printf(FB_WS_BASE_URL &quot;dialog/oauth?&quot;</a>
<a name="ln598">                                             &quot;client_id=&quot; FB_API_KEY &quot;&amp;redirect_uri=%s&quot;</a>
<a name="ln599">                                             &quot;&amp;scope=user_photos,publish_actions&quot;</a>
<a name="ln600">                                             &quot;&amp;response_type=token&quot;,</a>
<a name="ln601">                              callback_url);</a>
<a name="ln602">  if(!gtk_show_uri(gdk_screen_get_default(), url, gtk_get_current_event_time(), &amp;error))</a>
<a name="ln603">  {</a>
<a name="ln604">    fprintf(stderr, &quot;[facebook] error opening browser: %s\n&quot;, error-&gt;message);</a>
<a name="ln605">    g_error_free(error);</a>
<a name="ln606">    g_free(url);</a>
<a name="ln607">    return FALSE;</a>
<a name="ln608">  }</a>
<a name="ln609">  g_free(url);</a>
<a name="ln610">  return TRUE;</a>
<a name="ln611">}</a>
<a name="ln612"> </a>
<a name="ln613">static gchar *facebook_get_user_auth_token_from_url(dt_storage_facebook_gui_data_t *ui)</a>
<a name="ln614">{</a>
<a name="ln615">  ///////////// open the authentication url in a browser. just use some port, we won't listen anyway</a>
<a name="ln616">  if(!_open_browser(&quot;http://localhost:8123/&quot; FB_CALLBACK_ID)) return NULL;</a>
<a name="ln617"> </a>
<a name="ln618">  ////////////// build &amp; show the validation dialog</a>
<a name="ln619">  gchar *text1 = _(&quot;step 1: a new window or tab of your browser should have been &quot;</a>
<a name="ln620">                   &quot;loaded. you have to login into your facebook account there &quot;</a>
<a name="ln621">                   &quot;and authorize darktable to upload photos before continuing.&quot;);</a>
<a name="ln622">  gchar *text2 = _(&quot;step 2: paste your browser URL and click the OK button once &quot;</a>
<a name="ln623">                   &quot;you are done.&quot;);</a>
<a name="ln624"> </a>
<a name="ln625">  GtkWidget *window = dt_ui_main_window(darktable.gui-&gt;ui);</a>
<a name="ln626">  GtkDialog *fb_auth_dialog = GTK_DIALOG(</a>
<a name="ln627">      gtk_message_dialog_new(GTK_WINDOW(window), GTK_DIALOG_DESTROY_WITH_PARENT, GTK_MESSAGE_QUESTION,</a>
<a name="ln628">                             GTK_BUTTONS_OK_CANCEL, _(&quot;facebook authentication&quot;)));</a>
<a name="ln629">#ifdef GDK_WINDOWING_QUARTZ</a>
<a name="ln630">  dt_osx_disallow_fullscreen(GTK_WIDGET(fb_auth_dialog));</a>
<a name="ln631">#endif</a>
<a name="ln632">  gtk_message_dialog_format_secondary_text(GTK_MESSAGE_DIALOG(fb_auth_dialog), &quot;%s\n\n%s&quot;, text1, text2);</a>
<a name="ln633"> </a>
<a name="ln634">  GtkWidget *entry = gtk_entry_new();</a>
<a name="ln635">  GtkWidget *hbox = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0);</a>
<a name="ln636">  gtk_box_pack_start(GTK_BOX(hbox), GTK_WIDGET(gtk_label_new(_(&quot;URL:&quot;))), FALSE, FALSE, 0);</a>
<a name="ln637">  gtk_box_pack_start(GTK_BOX(hbox), GTK_WIDGET(entry), TRUE, TRUE, 0);</a>
<a name="ln638"> </a>
<a name="ln639">  GtkWidget *fbauthdialog_vbox = gtk_message_dialog_get_message_area(GTK_MESSAGE_DIALOG(fb_auth_dialog));</a>
<a name="ln640">  gtk_box_pack_end(GTK_BOX(fbauthdialog_vbox), hbox, TRUE, TRUE, 0);</a>
<a name="ln641"> </a>
<a name="ln642">  gtk_widget_show_all(GTK_WIDGET(fb_auth_dialog));</a>
<a name="ln643"> </a>
<a name="ln644">  ////////////// wait for the user to enter the validation URL</a>
<a name="ln645">  gint result;</a>
<a name="ln646">  gchar *token = NULL;</a>
<a name="ln647">  const char *replyurl;</a>
<a name="ln648">  while(TRUE)</a>
<a name="ln649">  {</a>
<a name="ln650">    result = gtk_dialog_run(GTK_DIALOG(fb_auth_dialog));</a>
<a name="ln651">    if(result == GTK_RESPONSE_CANCEL) break;</a>
<a name="ln652">    replyurl = gtk_entry_get_text(GTK_ENTRY(entry));</a>
<a name="ln653">    if(replyurl == NULL || g_strcmp0(replyurl, &quot;&quot;) == 0)</a>
<a name="ln654">    {</a>
<a name="ln655">      gtk_message_dialog_format_secondary_markup(GTK_MESSAGE_DIALOG(fb_auth_dialog),</a>
<a name="ln656">                                                 &quot;%s\n\n%s\n\n&lt;span foreground=\&quot;&quot; MSGCOLOR_RED</a>
<a name="ln657">                                                 &quot;\&quot; &gt;&lt;small&gt;%s&lt;/small&gt;&lt;/span&gt;&quot;,</a>
<a name="ln658">                                                 text1, text2, _(&quot;please enter the validation URL&quot;));</a>
<a name="ln659">      continue;</a>
<a name="ln660">    }</a>
<a name="ln661">    token = fb_extract_token_from_url(replyurl);</a>
<a name="ln662">    if(token != NULL) // we have a valid token</a>
<a name="ln663">      break;</a>
<a name="ln664">    else</a>
<a name="ln665">      gtk_message_dialog_format_secondary_markup(</a>
<a name="ln666">          GTK_MESSAGE_DIALOG(fb_auth_dialog),</a>
<a name="ln667">          &quot;%s\n\n%s%s\n\n&lt;span foreground=\&quot;&quot; MSGCOLOR_RED &quot;\&quot;&gt;&lt;small&gt;%s&lt;/small&gt;&lt;/span&gt;&quot;, text1, text2,</a>
<a name="ln668">          _(&quot;the given URL is not valid, it should look like: &quot;),</a>
<a name="ln669">          FB_WS_BASE_URL &quot;connect/login_success.html?...&quot;);</a>
<a name="ln670">  }</a>
<a name="ln671">  gtk_widget_destroy(GTK_WIDGET(fb_auth_dialog));</a>
<a name="ln672"> </a>
<a name="ln673">  return token;</a>
<a name="ln674">}</a>
<a name="ln675"> </a>
<a name="ln676">#ifdef HAVE_HTTP_SERVER</a>
<a name="ln677">static void ui_authenticate_finish(dt_storage_facebook_gui_data_t *ui, gboolean mustsaveaccount);</a>
<a name="ln678"> </a>
<a name="ln679">static gboolean _server_callback(GHashTable *query, gpointer user_data)</a>
<a name="ln680">{</a>
<a name="ln681">  dt_storage_facebook_gui_data_t *ui = (dt_storage_facebook_gui_data_t *)user_data;</a>
<a name="ln682"> </a>
<a name="ln683">  const char *access_token = g_hash_table_lookup(query, &quot;access_token&quot;);</a>
<a name="ln684"> </a>
<a name="ln685">  if(access_token)</a>
<a name="ln686">  {</a>
<a name="ln687">    // we got what we wanted</a>
<a name="ln688">    dt_print(DT_DEBUG_CONTROL, &quot;[facebook] got access_token `%s' from facebook redirect\n&quot;, access_token);</a>
<a name="ln689"> </a>
<a name="ln690">    // close the dialog</a>
<a name="ln691">    gtk_widget_destroy(GTK_WIDGET(ui-&gt;auth_dialog));</a>
<a name="ln692">    ui-&gt;auth_dialog = NULL;</a>
<a name="ln693"> </a>
<a name="ln694">    FBContext *ctx = ui-&gt;facebook_api;</a>
<a name="ln695">    ctx-&gt;token = g_strdup(access_token);</a>
<a name="ln696"> </a>
<a name="ln697">    ui_authenticate_finish(ui, TRUE);</a>
<a name="ln698"> </a>
<a name="ln699">    dt_control_log(_(&quot;authentication successful&quot;));</a>
<a name="ln700">    return TRUE;</a>
<a name="ln701">  }</a>
<a name="ln702"> </a>
<a name="ln703">  dt_control_log(_(&quot;authentication failed&quot;));</a>
<a name="ln704"> </a>
<a name="ln705">  return FALSE;</a>
<a name="ln706">}</a>
<a name="ln707"> </a>
<a name="ln708"> </a>
<a name="ln709">static gboolean facebook_get_user_auth_token_from_server(dt_storage_facebook_gui_data_t *ui)</a>
<a name="ln710">{</a>
<a name="ln711">  // create a dialog telling the user to login in the browser</a>
<a name="ln712">  GtkWidget *win = dt_ui_main_window(darktable.gui-&gt;ui);</a>
<a name="ln713"> </a>
<a name="ln714">  GtkWidget *dialog = gtk_message_dialog_new(</a>
<a name="ln715">      GTK_WINDOW(win), GTK_DIALOG_DESTROY_WITH_PARENT, GTK_MESSAGE_INFO, GTK_BUTTONS_CANCEL,</a>
<a name="ln716">      _(&quot;a new window or tab of your browser should have been &quot;</a>
<a name="ln717">        &quot;loaded. you have to login into your facebook account there &quot;</a>
<a name="ln718">        &quot;and authorize darktable to upload photos before continuing.&quot;));</a>
<a name="ln719">#ifdef GDK_WINDOWING_QUARTZ</a>
<a name="ln720">  dt_osx_disallow_fullscreen(dialog);</a>
<a name="ln721">#endif</a>
<a name="ln722"> </a>
<a name="ln723">  gtk_window_set_title(GTK_WINDOW(dialog), _(&quot;facebook authentication&quot;));</a>
<a name="ln724"> </a>
<a name="ln725">  ui-&gt;auth_dialog = GTK_MESSAGE_DIALOG(dialog);</a>
<a name="ln726"> </a>
<a name="ln727">  // create an http server</a>
<a name="ln728">  dt_http_server_t *server = dt_http_server_create(port_pool, n_ports, &quot;facebook&quot;, _server_callback, ui);</a>
<a name="ln729">  if(!server)</a>
<a name="ln730">  {</a>
<a name="ln731">    gtk_widget_destroy(dialog);</a>
<a name="ln732">    return FALSE;</a>
<a name="ln733">  }</a>
<a name="ln734"> </a>
<a name="ln735">  // open the browser</a>
<a name="ln736">  if(!_open_browser(server-&gt;url))</a>
<a name="ln737">  {</a>
<a name="ln738">    gtk_widget_destroy(dialog);</a>
<a name="ln739">    dt_http_server_kill(server);</a>
<a name="ln740">    return FALSE;</a>
<a name="ln741">  }</a>
<a name="ln742"> </a>
<a name="ln743">  // show the window</a>
<a name="ln744">  if(gtk_dialog_run(GTK_DIALOG(dialog)) == GTK_RESPONSE_CANCEL)</a>
<a name="ln745">  {</a>
<a name="ln746">    // if cancel button is clicked -&gt; kill the server</a>
<a name="ln747">    dt_http_server_kill(server);</a>
<a name="ln748">    gtk_widget_destroy(dialog);</a>
<a name="ln749">  }</a>
<a name="ln750"> </a>
<a name="ln751">  return TRUE;</a>
<a name="ln752">}</a>
<a name="ln753">#endif // HAVE_HTTP_SERVER</a>
<a name="ln754"> </a>
<a name="ln755">static void load_account_info_fill(gchar *key, gchar *value, GSList **accountlist)</a>
<a name="ln756">{</a>
<a name="ln757">  JsonParser *parser = json_parser_new();</a>
<a name="ln758">  json_parser_load_from_data(parser, value, strlen(value), NULL);</a>
<a name="ln759">  JsonNode *root = json_parser_get_root(parser);</a>
<a name="ln760"> </a>
<a name="ln761">  // root can be null while parsing the account info</a>
<a name="ln762">  if(root)</a>
<a name="ln763">  {</a>
<a name="ln764">    JsonObject *obj = json_node_get_object(root);</a>
<a name="ln765">    FBAccountInfo *info = fb_account_info_init();</a>
<a name="ln766">    info-&gt;id = g_strdup(key);</a>
<a name="ln767">    info-&gt;token = g_strdup(json_object_get_string_member(obj, &quot;token&quot;));</a>
<a name="ln768">    info-&gt;readablename = g_strdup(json_object_get_string_member(obj, &quot;name&quot;));</a>
<a name="ln769">    *accountlist = g_slist_prepend(*accountlist, info);</a>
<a name="ln770">  }</a>
<a name="ln771">  g_object_unref(parser);</a>
<a name="ln772">}</a>
<a name="ln773"> </a>
<a name="ln774">/**</a>
<a name="ln775"> * @return a GSList of saved FBAccountInfo</a>
<a name="ln776"> */</a>
<a name="ln777">static GSList *load_account_info()</a>
<a name="ln778">{</a>
<a name="ln779">  GSList *accountlist = NULL;</a>
<a name="ln780"> </a>
<a name="ln781">  GHashTable *table = dt_pwstorage_get(&quot;facebook&quot;);</a>
<a name="ln782">  g_hash_table_foreach(table, (GHFunc)load_account_info_fill, &amp;accountlist);</a>
<a name="ln783">  g_hash_table_destroy(table);</a>
<a name="ln784">  return accountlist;</a>
<a name="ln785">}</a>
<a name="ln786"> </a>
<a name="ln787">static void save_account_info(dt_storage_facebook_gui_data_t *ui, FBAccountInfo *accountinfo)</a>
<a name="ln788">{</a>
<a name="ln789">  FBContext *ctx = ui-&gt;facebook_api;</a>
<a name="ln790">  g_return_if_fail(ctx != NULL);</a>
<a name="ln791"> </a>
<a name="ln792">  /// serialize data;</a>
<a name="ln793">  JsonBuilder *builder = json_builder_new();</a>
<a name="ln794">  json_builder_begin_object(builder);</a>
<a name="ln795">  json_builder_set_member_name(builder, &quot;name&quot;);</a>
<a name="ln796">  json_builder_add_string_value(builder, accountinfo-&gt;readablename);</a>
<a name="ln797">  json_builder_set_member_name(builder, &quot;token&quot;);</a>
<a name="ln798">  json_builder_add_string_value(builder, accountinfo-&gt;token);</a>
<a name="ln799">  json_builder_end_object(builder);</a>
<a name="ln800"> </a>
<a name="ln801">  JsonNode *node = json_builder_get_root(builder);</a>
<a name="ln802">  JsonGenerator *generator = json_generator_new();</a>
<a name="ln803">  json_generator_set_root(generator, node);</a>
<a name="ln804">#if JSON_CHECK_VERSION(0, 14, 0)</a>
<a name="ln805">  json_generator_set_pretty(generator, FALSE);</a>
<a name="ln806">#endif</a>
<a name="ln807">  gchar *data = json_generator_to_data(generator, NULL);</a>
<a name="ln808"> </a>
<a name="ln809">  json_node_free(node);</a>
<a name="ln810">  g_object_unref(generator);</a>
<a name="ln811">  g_object_unref(builder);</a>
<a name="ln812"> </a>
<a name="ln813">  GHashTable *table = dt_pwstorage_get(&quot;facebook&quot;);</a>
<a name="ln814">  g_hash_table_insert(table, g_strdup(accountinfo-&gt;id), data);</a>
<a name="ln815">  dt_pwstorage_set(&quot;facebook&quot;, table);</a>
<a name="ln816"> </a>
<a name="ln817">  g_hash_table_destroy(table);</a>
<a name="ln818">}</a>
<a name="ln819"> </a>
<a name="ln820">static void remove_account_info(const gchar *accountid)</a>
<a name="ln821">{</a>
<a name="ln822">  GHashTable *table = dt_pwstorage_get(&quot;facebook&quot;);</a>
<a name="ln823">  g_hash_table_remove(table, accountid);</a>
<a name="ln824">  dt_pwstorage_set(&quot;facebook&quot;, table);</a>
<a name="ln825">  g_hash_table_destroy(table);</a>
<a name="ln826">}</a>
<a name="ln827"> </a>
<a name="ln828">static void ui_refresh_users_fill(FBAccountInfo *value, gpointer dataptr)</a>
<a name="ln829">{</a>
<a name="ln830">  GtkListStore *liststore = GTK_LIST_STORE(dataptr);</a>
<a name="ln831">  GtkTreeIter iter;</a>
<a name="ln832">  gtk_list_store_append(liststore, &amp;iter);</a>
<a name="ln833">  gtk_list_store_set(liststore, &amp;iter, COMBO_USER_MODEL_NAME_COL, value-&gt;readablename, COMBO_USER_MODEL_TOKEN_COL,</a>
<a name="ln834">                     value-&gt;token, COMBO_USER_MODEL_ID_COL, value-&gt;id, -1);</a>
<a name="ln835">}</a>
<a name="ln836"> </a>
<a name="ln837">static void ui_refresh_users(dt_storage_facebook_gui_data_t *ui)</a>
<a name="ln838">{</a>
<a name="ln839">  GSList *accountlist = load_account_info();</a>
<a name="ln840">  GtkListStore *list_store = GTK_LIST_STORE(gtk_combo_box_get_model(ui-&gt;comboBox_username));</a>
<a name="ln841">  GtkTreeIter iter;</a>
<a name="ln842"> </a>
<a name="ln843">  gtk_list_store_clear(list_store);</a>
<a name="ln844">  gtk_list_store_append(list_store, &amp;iter);</a>
<a name="ln845"> </a>
<a name="ln846">  int active_account = 0;</a>
<a name="ln847">  if(g_slist_length(accountlist) == 0)</a>
<a name="ln848">  {</a>
<a name="ln849">    gtk_list_store_set(list_store, &amp;iter, COMBO_USER_MODEL_NAME_COL, _(&quot;new account&quot;),</a>
<a name="ln850">                       COMBO_USER_MODEL_TOKEN_COL, NULL, COMBO_USER_MODEL_ID_COL, NULL, -1);</a>
<a name="ln851">  }</a>
<a name="ln852">  else</a>
<a name="ln853">  {</a>
<a name="ln854">    gtk_list_store_set(list_store, &amp;iter, COMBO_USER_MODEL_NAME_COL, _(&quot;other account&quot;),</a>
<a name="ln855">                       COMBO_USER_MODEL_TOKEN_COL, NULL, COMBO_USER_MODEL_ID_COL, NULL, -1);</a>
<a name="ln856">    gtk_list_store_append(list_store, &amp;iter);</a>
<a name="ln857">    gtk_list_store_set(list_store, &amp;iter, COMBO_USER_MODEL_NAME_COL, &quot;&quot;, COMBO_USER_MODEL_TOKEN_COL, NULL,</a>
<a name="ln858">                       COMBO_USER_MODEL_ID_COL, NULL, -1); // separator</a>
<a name="ln859">    active_account = 2;</a>
<a name="ln860">  }</a>
<a name="ln861"> </a>
<a name="ln862">  g_slist_foreach(accountlist, (GFunc)ui_refresh_users_fill, list_store);</a>
<a name="ln863">  gtk_combo_box_set_active(ui-&gt;comboBox_username, active_account);</a>
<a name="ln864"> </a>
<a name="ln865">  g_slist_free_full(accountlist, (GDestroyNotify)fb_account_info_destroy);</a>
<a name="ln866">  gtk_combo_box_set_row_separator_func(ui-&gt;comboBox_username, combobox_separator, ui-&gt;comboBox_username, NULL);</a>
<a name="ln867">}</a>
<a name="ln868"> </a>
<a name="ln869">static void ui_refresh_albums_fill(FBAlbum *album, GtkListStore *list_store)</a>
<a name="ln870">{</a>
<a name="ln871">  GtkTreeIter iter;</a>
<a name="ln872">  gtk_list_store_append(list_store, &amp;iter);</a>
<a name="ln873">  gtk_list_store_set(list_store, &amp;iter, COMBO_ALBUM_MODEL_NAME_COL, album-&gt;name, COMBO_ALBUM_MODEL_ID_COL,</a>
<a name="ln874">                     album-&gt;id, -1);</a>
<a name="ln875">}</a>
<a name="ln876"> </a>
<a name="ln877">static void ui_refresh_albums(dt_storage_facebook_gui_data_t *ui)</a>
<a name="ln878">{</a>
<a name="ln879">  gboolean getlistok;</a>
<a name="ln880">  GList *albumList = fb_get_album_list(ui-&gt;facebook_api, &amp;getlistok);</a>
<a name="ln881">  if(!getlistok)</a>
<a name="ln882">  {</a>
<a name="ln883">    dt_control_log(_(&quot;unable to retrieve the album list&quot;));</a>
<a name="ln884">    goto cleanup;</a>
<a name="ln885">  }</a>
<a name="ln886"> </a>
<a name="ln887">  GtkListStore *model_album = GTK_LIST_STORE(gtk_combo_box_get_model(ui-&gt;comboBox_album));</a>
<a name="ln888">  GtkTreeIter iter;</a>
<a name="ln889">  gtk_list_store_clear(model_album);</a>
<a name="ln890">  gtk_list_store_append(model_album, &amp;iter);</a>
<a name="ln891">  gtk_list_store_set(model_album, &amp;iter, COMBO_ALBUM_MODEL_NAME_COL, _(&quot;create new album&quot;),</a>
<a name="ln892">                     COMBO_ALBUM_MODEL_ID_COL, NULL, -1);</a>
<a name="ln893">  if(albumList != NULL)</a>
<a name="ln894">  {</a>
<a name="ln895">    gtk_list_store_append(model_album, &amp;iter);</a>
<a name="ln896">    gtk_list_store_set(model_album, &amp;iter, COMBO_ALBUM_MODEL_NAME_COL, &quot;&quot;, COMBO_ALBUM_MODEL_ID_COL, NULL,</a>
<a name="ln897">                       -1); // separator</a>
<a name="ln898">  }</a>
<a name="ln899">  g_list_foreach(albumList, (GFunc)ui_refresh_albums_fill, model_album);</a>
<a name="ln900"> </a>
<a name="ln901">  if(albumList != NULL)</a>
<a name="ln902">    gtk_combo_box_set_active(ui-&gt;comboBox_album, 2);</a>
<a name="ln903">  else</a>
<a name="ln904">    gtk_combo_box_set_active(ui-&gt;comboBox_album, 0);</a>
<a name="ln905"> </a>
<a name="ln906">  gtk_widget_show_all(GTK_WIDGET(ui-&gt;comboBox_album));</a>
<a name="ln907">  g_list_free_full(albumList, (GDestroyNotify)fb_album_destroy);</a>
<a name="ln908"> </a>
<a name="ln909">cleanup:</a>
<a name="ln910">  return;</a>
<a name="ln911">}</a>
<a name="ln912"> </a>
<a name="ln913">static void ui_authenticate_finish(dt_storage_facebook_gui_data_t *ui, gboolean mustsaveaccount)</a>
<a name="ln914">{</a>
<a name="ln915">  FBContext *ctx = ui-&gt;facebook_api;</a>
<a name="ln916"> </a>
<a name="ln917">  if(ctx-&gt;token == NULL) goto error;</a>
<a name="ln918"> </a>
<a name="ln919">  if(mustsaveaccount)</a>
<a name="ln920">  {</a>
<a name="ln921">    FBAccountInfo *accountinfo = fb_get_account_info(ui-&gt;facebook_api);</a>
<a name="ln922">    if(accountinfo == NULL) goto error;</a>
<a name="ln923">    save_account_info(ui, accountinfo);</a>
<a name="ln924"> </a>
<a name="ln925">    // add account to user list and select it</a>
<a name="ln926">    GtkListStore *model = GTK_LIST_STORE(gtk_combo_box_get_model(ui-&gt;comboBox_username));</a>
<a name="ln927">    GtkTreeIter iter;</a>
<a name="ln928">    gboolean r;</a>
<a name="ln929">    gchar *uid;</a>
<a name="ln930"> </a>
<a name="ln931">    gboolean updated = FALSE;</a>
<a name="ln932"> </a>
<a name="ln933">    for(r = gtk_tree_model_get_iter_first(GTK_TREE_MODEL(model), &amp;iter); r == TRUE;</a>
<a name="ln934">        r = gtk_tree_model_iter_next(GTK_TREE_MODEL(model), &amp;iter))</a>
<a name="ln935">    {</a>
<a name="ln936">      gtk_tree_model_get(GTK_TREE_MODEL(model), &amp;iter, COMBO_USER_MODEL_ID_COL, &amp;uid, -1);</a>
<a name="ln937"> </a>
<a name="ln938">      if(g_strcmp0(uid, accountinfo-&gt;id) == 0)</a>
<a name="ln939">      {</a>
<a name="ln940">        gtk_list_store_set(model, &amp;iter, COMBO_USER_MODEL_NAME_COL, accountinfo-&gt;readablename,</a>
<a name="ln941">                           COMBO_USER_MODEL_TOKEN_COL, accountinfo-&gt;token, -1);</a>
<a name="ln942">        updated = TRUE;</a>
<a name="ln943">        break;</a>
<a name="ln944">      }</a>
<a name="ln945">    }</a>
<a name="ln946"> </a>
<a name="ln947">    if(!updated)</a>
<a name="ln948">    {</a>
<a name="ln949">      gtk_list_store_append(model, &amp;iter);</a>
<a name="ln950">      gtk_list_store_set(model, &amp;iter, COMBO_USER_MODEL_NAME_COL, accountinfo-&gt;readablename,</a>
<a name="ln951">                         COMBO_USER_MODEL_TOKEN_COL, accountinfo-&gt;token, COMBO_USER_MODEL_ID_COL,</a>
<a name="ln952">                         accountinfo-&gt;id, -1);</a>
<a name="ln953">    }</a>
<a name="ln954">    gtk_combo_box_set_active_iter(ui-&gt;comboBox_username, &amp;iter);</a>
<a name="ln955">    // we have to re-set the current token here since ui_combo_username_changed is called</a>
<a name="ln956">    // on gtk_combo_box_set_active_iter (and thus is resetting the active token)</a>
<a name="ln957">    ctx-&gt;token = g_strdup(accountinfo-&gt;token);</a>
<a name="ln958">    fb_account_info_destroy(accountinfo);</a>
<a name="ln959">  }</a>
<a name="ln960"> </a>
<a name="ln961">  ui_refresh_albums(ui);</a>
<a name="ln962">  ui-&gt;connected = TRUE;</a>
<a name="ln963">  gtk_button_set_label(ui-&gt;button_login, _(&quot;logout&quot;));</a>
<a name="ln964">  gtk_widget_set_sensitive(GTK_WIDGET(ui-&gt;comboBox_album), TRUE);</a>
<a name="ln965"> </a>
<a name="ln966">  return;</a>
<a name="ln967"> </a>
<a name="ln968">error:</a>
<a name="ln969">  gtk_button_set_label(ui-&gt;button_login, _(&quot;login&quot;));</a>
<a name="ln970">  gtk_widget_set_sensitive(GTK_WIDGET(ui-&gt;comboBox_album), FALSE);</a>
<a name="ln971">}</a>
<a name="ln972"> </a>
<a name="ln973">static void ui_authenticate(dt_storage_facebook_gui_data_t *ui)</a>
<a name="ln974">{</a>
<a name="ln975">  if(ui-&gt;facebook_api == NULL)</a>
<a name="ln976">  {</a>
<a name="ln977">    ui-&gt;facebook_api = fb_api_init();</a>
<a name="ln978">  }</a>
<a name="ln979"> </a>
<a name="ln980">  FBContext *ctx = ui-&gt;facebook_api;</a>
<a name="ln981">  gboolean mustsaveaccount = FALSE;</a>
<a name="ln982"> </a>
<a name="ln983">  gchar *uiselectedaccounttoken = NULL;</a>
<a name="ln984">  GtkTreeIter iter;</a>
<a name="ln985">  gtk_combo_box_get_active_iter(ui-&gt;comboBox_username, &amp;iter);</a>
<a name="ln986">  GtkTreeModel *accountModel = gtk_combo_box_get_model(ui-&gt;comboBox_username);</a>
<a name="ln987">  gtk_tree_model_get(accountModel, &amp;iter, 1, &amp;uiselectedaccounttoken, -1);</a>
<a name="ln988"> </a>
<a name="ln989">  gtk_button_set_label(ui-&gt;button_login, _(&quot;login&quot;));</a>
<a name="ln990">  gtk_widget_set_sensitive(GTK_WIDGET(ui-&gt;comboBox_album), FALSE);</a>
<a name="ln991"> </a>
<a name="ln992">  g_free(ctx-&gt;token);</a>
<a name="ln993">  ctx-&gt;token = g_strdup(uiselectedaccounttoken);</a>
<a name="ln994">  // check selected token if we already have one</a>
<a name="ln995">  if(ctx-&gt;token != NULL &amp;&amp; !fb_test_auth_token(ctx))</a>
<a name="ln996">  {</a>
<a name="ln997">    g_free(ctx-&gt;token);</a>
<a name="ln998">    ctx-&gt;token = NULL;</a>
<a name="ln999">  }</a>
<a name="ln1000"> </a>
<a name="ln1001">  if(ctx-&gt;token == NULL)</a>
<a name="ln1002">  {</a>
<a name="ln1003">    mustsaveaccount = TRUE;</a>
<a name="ln1004"> </a>
<a name="ln1005">#ifdef HAVE_HTTP_SERVER</a>
<a name="ln1006">    // try to get the token from the callback URL</a>
<a name="ln1007">    if(facebook_get_user_auth_token_from_server(ui)) return;</a>
<a name="ln1008">#endif</a>
<a name="ln1009"> </a>
<a name="ln1010">    // if we reached this point we either have no http server support</a>
<a name="ln1011">    // or couldn't start it (no free port, ...)</a>
<a name="ln1012">    ctx-&gt;token = facebook_get_user_auth_token_from_url(ui); // ask user to log in</a>
<a name="ln1013">  }</a>
<a name="ln1014"> </a>
<a name="ln1015">  ui_authenticate_finish(ui, mustsaveaccount);</a>
<a name="ln1016">}</a>
<a name="ln1017"> </a>
<a name="ln1018"> </a>
<a name="ln1019">static void ui_login_clicked(GtkButton *button, gpointer data)</a>
<a name="ln1020">{</a>
<a name="ln1021">  dt_storage_facebook_gui_data_t *ui = (dt_storage_facebook_gui_data_t *)data;</a>
<a name="ln1022">  if(ui-&gt;connected == FALSE)</a>
<a name="ln1023">  {</a>
<a name="ln1024">    ui_authenticate(ui);</a>
<a name="ln1025">  }</a>
<a name="ln1026">  else // disconnect user</a>
<a name="ln1027">  {</a>
<a name="ln1028">    if(ui-&gt;facebook_api-&gt;token != NULL)</a>
<a name="ln1029">    {</a>
<a name="ln1030">      GtkTreeModel *model = gtk_combo_box_get_model(ui-&gt;comboBox_username);</a>
<a name="ln1031">      GtkTreeIter iter;</a>
<a name="ln1032">      gtk_combo_box_get_active_iter(ui-&gt;comboBox_username, &amp;iter);</a>
<a name="ln1033">      gchar *userid;</a>
<a name="ln1034">      gtk_tree_model_get(model, &amp;iter, COMBO_USER_MODEL_ID_COL, &amp;userid, -1);</a>
<a name="ln1035">      remove_account_info(userid);</a>
<a name="ln1036">      gtk_button_set_label(ui-&gt;button_login, _(&quot;login&quot;));</a>
<a name="ln1037">      gtk_widget_set_sensitive(GTK_WIDGET(ui-&gt;comboBox_album), FALSE);</a>
<a name="ln1038">      ui_refresh_users(ui);</a>
<a name="ln1039">      ui-&gt;connected = FALSE;</a>
<a name="ln1040">    }</a>
<a name="ln1041">  }</a>
<a name="ln1042">}</a>
<a name="ln1043"> </a>
<a name="ln1044"> </a>
<a name="ln1045">static void ui_reset_albums_creation(struct dt_storage_facebook_gui_data_t *ui)</a>
<a name="ln1046">{</a>
<a name="ln1047">  GtkListStore *model_album = GTK_LIST_STORE(gtk_combo_box_get_model(ui-&gt;comboBox_album));</a>
<a name="ln1048">  gtk_list_store_clear(model_album);</a>
<a name="ln1049">  gtk_entry_set_text(ui-&gt;entry_album_summary, &quot;&quot;);</a>
<a name="ln1050">  gtk_entry_set_text(ui-&gt;entry_album_title, &quot;&quot;);</a>
<a name="ln1051">  gtk_widget_hide(GTK_WIDGET(ui-&gt;hbox_album));</a>
<a name="ln1052">}</a>
<a name="ln1053"> </a>
<a name="ln1054">static void ui_combo_username_changed(GtkComboBox *combo, struct dt_storage_facebook_gui_data_t *ui)</a>
<a name="ln1055">{</a>
<a name="ln1056">  GtkTreeIter iter;</a>
<a name="ln1057">  gchar *token = NULL;</a>
<a name="ln1058">  if(!gtk_combo_box_get_active_iter(combo, &amp;iter)) return; // ie: list is empty while clearing the combo</a>
<a name="ln1059">  GtkTreeModel *model = gtk_combo_box_get_model(combo);</a>
<a name="ln1060">  gtk_tree_model_get(model, &amp;iter, 1, &amp;token, -1); // get the selected token</a>
<a name="ln1061">  ui-&gt;connected = FALSE;</a>
<a name="ln1062">  gtk_button_set_label(ui-&gt;button_login, _(&quot;login&quot;));</a>
<a name="ln1063">  g_free(ui-&gt;facebook_api-&gt;token);</a>
<a name="ln1064">  ui-&gt;facebook_api-&gt;token = NULL;</a>
<a name="ln1065">  ui_reset_albums_creation(ui);</a>
<a name="ln1066">}</a>
<a name="ln1067"> </a>
<a name="ln1068">static void ui_combo_album_changed(GtkComboBox *combo, gpointer data)</a>
<a name="ln1069">{</a>
<a name="ln1070">  dt_storage_facebook_gui_data_t *ui = (dt_storage_facebook_gui_data_t *)data;</a>
<a name="ln1071"> </a>
<a name="ln1072">  GtkTreeIter iter;</a>
<a name="ln1073">  gchar *albumid = NULL;</a>
<a name="ln1074">  if(gtk_combo_box_get_active_iter(combo, &amp;iter))</a>
<a name="ln1075">  {</a>
<a name="ln1076">    GtkTreeModel *model = gtk_combo_box_get_model(combo);</a>
<a name="ln1077">    gtk_tree_model_get(model, &amp;iter, 1, &amp;albumid, -1); // get the album id</a>
<a name="ln1078">  }</a>
<a name="ln1079"> </a>
<a name="ln1080">  if(albumid == NULL)</a>
<a name="ln1081">  {</a>
<a name="ln1082">    gtk_widget_set_no_show_all(GTK_WIDGET(ui-&gt;hbox_album), FALSE);</a>
<a name="ln1083">    gtk_widget_show_all(GTK_WIDGET(ui-&gt;hbox_album));</a>
<a name="ln1084">  }</a>
<a name="ln1085">  else</a>
<a name="ln1086">  {</a>
<a name="ln1087">    gtk_widget_set_no_show_all(GTK_WIDGET(ui-&gt;hbox_album), TRUE);</a>
<a name="ln1088">    gtk_widget_hide(GTK_WIDGET(ui-&gt;hbox_album));</a>
<a name="ln1089">  }</a>
<a name="ln1090">}</a>
<a name="ln1091"> </a>
<a name="ln1092">////////////////////////// darktable library interface</a>
<a name="ln1093"> </a>
<a name="ln1094">/* plugin name */</a>
<a name="ln1095">const char *name(const struct dt_imageio_module_storage_t *self)</a>
<a name="ln1096">{</a>
<a name="ln1097">  return _(&quot;facebook webalbum&quot;);</a>
<a name="ln1098">}</a>
<a name="ln1099"> </a>
<a name="ln1100">int recommended_dimension(struct dt_imageio_module_storage_t *self, dt_imageio_module_data_t *data,</a>
<a name="ln1101">                          uint32_t *width, uint32_t *height)</a>
<a name="ln1102">{</a>
<a name="ln1103">  *width = FB_IMAGE_MAX_SIZE;</a>
<a name="ln1104">  *height = FB_IMAGE_MAX_SIZE;</a>
<a name="ln1105">  return 1;</a>
<a name="ln1106">}</a>
<a name="ln1107"> </a>
<a name="ln1108">/* construct widget above */</a>
<a name="ln1109">void gui_init(struct dt_imageio_module_storage_t *self)</a>
<a name="ln1110">{</a>
<a name="ln1111">  self-&gt;gui_data = g_malloc0(sizeof(dt_storage_facebook_gui_data_t));</a>
<a name="ln1112">  dt_storage_facebook_gui_data_t *ui = self-&gt;gui_data;</a>
<a name="ln1113">  ui-&gt;facebook_api = fb_api_init();</a>
<a name="ln1114"> </a>
<a name="ln1115">  self-&gt;widget = gtk_box_new(GTK_ORIENTATION_VERTICAL, 0);</a>
<a name="ln1116"> </a>
<a name="ln1117">  // create labels</a>
<a name="ln1118">  ui-&gt;label_album_title = GTK_LABEL(gtk_label_new(_(&quot;title&quot;)));</a>
<a name="ln1119">  ui-&gt;label_album_summary = GTK_LABEL(gtk_label_new(_(&quot;summary&quot;)));</a>
<a name="ln1120">  ui-&gt;label_album_privacy = GTK_LABEL(gtk_label_new(_(&quot;privacy&quot;)));</a>
<a name="ln1121">  ui-&gt;label_status = GTK_LABEL(gtk_label_new(NULL));</a>
<a name="ln1122"> </a>
<a name="ln1123">  gtk_widget_set_halign(GTK_WIDGET(ui-&gt;label_album_title), GTK_ALIGN_START);</a>
<a name="ln1124">  gtk_widget_set_halign(GTK_WIDGET(ui-&gt;label_album_summary), GTK_ALIGN_START);</a>
<a name="ln1125">  gtk_widget_set_halign(GTK_WIDGET(ui-&gt;label_album_privacy), GTK_ALIGN_START);</a>
<a name="ln1126"> </a>
<a name="ln1127">  // create entries</a>
<a name="ln1128">  GtkListStore *model_username = gtk_list_store_new(COMBO_USER_MODEL_NB_COL, G_TYPE_STRING, G_TYPE_STRING,</a>
<a name="ln1129">                                                    G_TYPE_STRING); // text, token, id</a>
<a name="ln1130">  ui-&gt;comboBox_username = GTK_COMBO_BOX(gtk_combo_box_new_with_model(GTK_TREE_MODEL(model_username)));</a>
<a name="ln1131">  GtkCellRenderer *p_cell = gtk_cell_renderer_text_new();</a>
<a name="ln1132">  gtk_cell_layout_pack_start(GTK_CELL_LAYOUT(ui-&gt;comboBox_username), p_cell, FALSE);</a>
<a name="ln1133">  gtk_cell_layout_set_attributes(GTK_CELL_LAYOUT(ui-&gt;comboBox_username), p_cell, &quot;text&quot;, 0, NULL);</a>
<a name="ln1134"> </a>
<a name="ln1135">  ui-&gt;entry_album_title = GTK_ENTRY(gtk_entry_new());</a>
<a name="ln1136">  ui-&gt;entry_album_summary = GTK_ENTRY(gtk_entry_new());</a>
<a name="ln1137"> </a>
<a name="ln1138">  dt_gui_key_accel_block_on_focus_connect(GTK_WIDGET(ui-&gt;comboBox_username));</a>
<a name="ln1139">  dt_gui_key_accel_block_on_focus_connect(GTK_WIDGET(ui-&gt;entry_album_title));</a>
<a name="ln1140">  dt_gui_key_accel_block_on_focus_connect(GTK_WIDGET(ui-&gt;entry_album_summary));</a>
<a name="ln1141"> </a>
<a name="ln1142">  gtk_entry_set_width_chars(GTK_ENTRY(ui-&gt;entry_album_title), 0);</a>
<a name="ln1143">  gtk_entry_set_width_chars(GTK_ENTRY(ui-&gt;entry_album_summary), 0);</a>
<a name="ln1144"> </a>
<a name="ln1145"> </a>
<a name="ln1146">  // retrieve saved accounts</a>
<a name="ln1147">  ui_refresh_users(ui);</a>
<a name="ln1148"> </a>
<a name="ln1149">  //////// album list /////////</a>
<a name="ln1150">  GtkWidget *albumlist = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0);</a>
<a name="ln1151">  GtkListStore *model_album</a>
<a name="ln1152">      = gtk_list_store_new(COMBO_ALBUM_MODEL_NB_COL, G_TYPE_STRING, G_TYPE_STRING); // name, id</a>
<a name="ln1153">  ui-&gt;comboBox_album = GTK_COMBO_BOX(gtk_combo_box_new_with_model(GTK_TREE_MODEL(model_album)));</a>
<a name="ln1154">  p_cell = gtk_cell_renderer_text_new();</a>
<a name="ln1155">  gtk_cell_layout_pack_start(GTK_CELL_LAYOUT(ui-&gt;comboBox_album), p_cell, FALSE);</a>
<a name="ln1156">  gtk_cell_layout_set_attributes(GTK_CELL_LAYOUT(ui-&gt;comboBox_album), p_cell, &quot;text&quot;, 0, NULL);</a>
<a name="ln1157"> </a>
<a name="ln1158">  gtk_widget_set_sensitive(GTK_WIDGET(ui-&gt;comboBox_album), FALSE);</a>
<a name="ln1159">  gtk_combo_box_set_row_separator_func(ui-&gt;comboBox_album, combobox_separator, ui-&gt;comboBox_album, NULL);</a>
<a name="ln1160">  gtk_box_pack_start(GTK_BOX(albumlist), GTK_WIDGET(ui-&gt;comboBox_album), TRUE, TRUE, 0);</a>
<a name="ln1161"> </a>
<a name="ln1162">  ui-&gt;comboBox_privacy = GTK_COMBO_BOX(gtk_combo_box_text_new());</a>
<a name="ln1163">  GtkListStore *list_store = gtk_list_store_new(COMBO_ALBUM_MODEL_NB_COL, G_TYPE_STRING, G_TYPE_INT);</a>
<a name="ln1164">  GtkTreeIter iter;</a>
<a name="ln1165">  gtk_list_store_append(list_store, &amp;iter);</a>
<a name="ln1166">  gtk_list_store_set(list_store, &amp;iter, COMBO_PRIVACY_MODEL_NAME_COL, _(&quot;only me&quot;),</a>
<a name="ln1167">                     COMBO_PRIVACY_MODEL_VAL_COL, FBALBUM_PRIVACY_SELF, -1);</a>
<a name="ln1168">  gtk_list_store_append(list_store, &amp;iter);</a>
<a name="ln1169">  gtk_list_store_set(list_store, &amp;iter, COMBO_PRIVACY_MODEL_NAME_COL, _(&quot;friends&quot;),</a>
<a name="ln1170">                     COMBO_PRIVACY_MODEL_VAL_COL, FBALBUM_PRIVACY_ALL_FRIENDS, -1);</a>
<a name="ln1171">  gtk_list_store_append(list_store, &amp;iter);</a>
<a name="ln1172">  gtk_list_store_set(list_store, &amp;iter, COMBO_PRIVACY_MODEL_NAME_COL, _(&quot;public&quot;),</a>
<a name="ln1173">                     COMBO_PRIVACY_MODEL_VAL_COL, FBALBUM_PRIVACY_EVERYONE, -1);</a>
<a name="ln1174">  gtk_list_store_append(list_store, &amp;iter);</a>
<a name="ln1175">  gtk_list_store_set(list_store, &amp;iter, COMBO_PRIVACY_MODEL_NAME_COL, _(&quot;friends of friends&quot;),</a>
<a name="ln1176">                     COMBO_PRIVACY_MODEL_VAL_COL, FBALBUM_PRIVACY_FRIENDS_OF_FRIENDS, -1);</a>
<a name="ln1177"> </a>
<a name="ln1178">  gtk_combo_box_set_model(ui-&gt;comboBox_privacy, GTK_TREE_MODEL(list_store));</a>
<a name="ln1179"> </a>
<a name="ln1180">  gtk_combo_box_set_active(GTK_COMBO_BOX(ui-&gt;comboBox_privacy), 1); // Set default permission to private</a>
<a name="ln1181">  ui-&gt;button_login = GTK_BUTTON(gtk_button_new_with_label(_(&quot;login&quot;)));</a>
<a name="ln1182">  ui-&gt;connected = FALSE;</a>
<a name="ln1183"> </a>
<a name="ln1184">  // pack the ui</a>
<a name="ln1185">  ////the auth box</a>
<a name="ln1186">  GtkWidget *hbox_auth = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0);</a>
<a name="ln1187">  GtkWidget *vbox_auth_labels = gtk_box_new(GTK_ORIENTATION_VERTICAL, 0);</a>
<a name="ln1188">  GtkWidget *vbox_auth_fields = gtk_box_new(GTK_ORIENTATION_VERTICAL, 0);</a>
<a name="ln1189">  gtk_box_pack_start(GTK_BOX(hbox_auth), vbox_auth_labels, FALSE, FALSE, 0);</a>
<a name="ln1190">  gtk_box_pack_start(GTK_BOX(hbox_auth), vbox_auth_fields, TRUE, TRUE, 0);</a>
<a name="ln1191">  gtk_box_pack_start(GTK_BOX(self-&gt;widget), GTK_WIDGET(hbox_auth), TRUE, FALSE, 0);</a>
<a name="ln1192">  gtk_box_pack_start(GTK_BOX(vbox_auth_fields), GTK_WIDGET(ui-&gt;comboBox_username), TRUE, FALSE, 0);</a>
<a name="ln1193"> </a>
<a name="ln1194">  gtk_box_pack_start(GTK_BOX(vbox_auth_labels), GTK_WIDGET(gtk_label_new(&quot;&quot;)), TRUE, TRUE, 0);</a>
<a name="ln1195">  gtk_box_pack_start(GTK_BOX(vbox_auth_fields), GTK_WIDGET(ui-&gt;button_login), TRUE, FALSE, 0);</a>
<a name="ln1196"> </a>
<a name="ln1197">  gtk_box_pack_start(GTK_BOX(vbox_auth_fields), GTK_WIDGET(albumlist), TRUE, FALSE, 0);</a>
<a name="ln1198"> </a>
<a name="ln1199">  ////the album creation box</a>
<a name="ln1200">  ui-&gt;hbox_album = GTK_BOX(gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0));</a>
<a name="ln1201">  gtk_widget_set_no_show_all(GTK_WIDGET(ui-&gt;hbox_album), TRUE); // hide it by default</a>
<a name="ln1202">  GtkWidget *vbox_album_labels = gtk_box_new(GTK_ORIENTATION_VERTICAL, 0);</a>
<a name="ln1203">  GtkWidget *vbox_album_fields = gtk_box_new(GTK_ORIENTATION_VERTICAL, 0);</a>
<a name="ln1204">  gtk_box_pack_start(GTK_BOX(self-&gt;widget), GTK_WIDGET(ui-&gt;hbox_album), TRUE, FALSE, 0);</a>
<a name="ln1205">  gtk_box_pack_start(GTK_BOX(ui-&gt;hbox_album), vbox_album_labels, FALSE, FALSE, 0);</a>
<a name="ln1206">  gtk_box_pack_start(GTK_BOX(ui-&gt;hbox_album), vbox_album_fields, TRUE, TRUE, 0);</a>
<a name="ln1207">  gtk_box_pack_start(GTK_BOX(vbox_album_labels), GTK_WIDGET(ui-&gt;label_album_title), TRUE, TRUE, 0);</a>
<a name="ln1208">  gtk_box_pack_start(GTK_BOX(vbox_album_fields), GTK_WIDGET(ui-&gt;entry_album_title), TRUE, FALSE, 0);</a>
<a name="ln1209">  gtk_box_pack_start(GTK_BOX(vbox_album_labels), GTK_WIDGET(ui-&gt;label_album_summary), TRUE, TRUE, 0);</a>
<a name="ln1210">  gtk_box_pack_start(GTK_BOX(vbox_album_fields), GTK_WIDGET(ui-&gt;entry_album_summary), TRUE, FALSE, 0);</a>
<a name="ln1211">  gtk_box_pack_start(GTK_BOX(vbox_album_labels), GTK_WIDGET(ui-&gt;label_album_privacy), TRUE, TRUE, 0);</a>
<a name="ln1212">  gtk_box_pack_start(GTK_BOX(vbox_album_fields), GTK_WIDGET(ui-&gt;comboBox_privacy), TRUE, FALSE, 0);</a>
<a name="ln1213"> </a>
<a name="ln1214">  // connect buttons to signals</a>
<a name="ln1215">  g_signal_connect(G_OBJECT(ui-&gt;button_login), &quot;clicked&quot;, G_CALLBACK(ui_login_clicked), (gpointer)ui);</a>
<a name="ln1216">  g_signal_connect(G_OBJECT(ui-&gt;comboBox_username), &quot;changed&quot;, G_CALLBACK(ui_combo_username_changed),</a>
<a name="ln1217">                   (gpointer)ui);</a>
<a name="ln1218">  g_signal_connect(G_OBJECT(ui-&gt;comboBox_album), &quot;changed&quot;, G_CALLBACK(ui_combo_album_changed), (gpointer)ui);</a>
<a name="ln1219"> </a>
<a name="ln1220">  g_object_unref(model_username);</a>
<a name="ln1221">  g_object_unref(model_album);</a>
<a name="ln1222">  g_object_unref(list_store);</a>
<a name="ln1223">}</a>
<a name="ln1224"> </a>
<a name="ln1225">/* destroy resources */</a>
<a name="ln1226">void gui_cleanup(struct dt_imageio_module_storage_t *self)</a>
<a name="ln1227">{</a>
<a name="ln1228">  dt_storage_facebook_gui_data_t *ui = self-&gt;gui_data;</a>
<a name="ln1229">  dt_gui_key_accel_block_on_focus_disconnect(GTK_WIDGET(ui-&gt;comboBox_username));</a>
<a name="ln1230">  dt_gui_key_accel_block_on_focus_disconnect(GTK_WIDGET(ui-&gt;entry_album_title));</a>
<a name="ln1231">  dt_gui_key_accel_block_on_focus_disconnect(GTK_WIDGET(ui-&gt;entry_album_summary));</a>
<a name="ln1232">  if(ui-&gt;facebook_api != NULL) fb_api_destroy(ui-&gt;facebook_api);</a>
<a name="ln1233">  g_free(self-&gt;gui_data);</a>
<a name="ln1234">}</a>
<a name="ln1235"> </a>
<a name="ln1236">/* reset options to defaults */</a>
<a name="ln1237">void gui_reset(struct dt_imageio_module_storage_t *self)</a>
<a name="ln1238">{</a>
<a name="ln1239">  // TODO?</a>
<a name="ln1240">}</a>
<a name="ln1241"> </a>
<a name="ln1242">/* try and see if this format is supported? */</a>
<a name="ln1243">int supported(struct dt_imageio_module_storage_t *self, struct dt_imageio_module_format_t *format)</a>
<a name="ln1244">{</a>
<a name="ln1245">  if(strcmp(format-&gt;mime(NULL), &quot;image/jpeg&quot;) == 0)</a>
<a name="ln1246">    return 1;</a>
<a name="ln1247">  else if(strcmp(format-&gt;mime(NULL), &quot;image/png&quot;) == 0)</a>
<a name="ln1248">    return 1;</a>
<a name="ln1249">  return 0;</a>
<a name="ln1250">}</a>
<a name="ln1251"> </a>
<a name="ln1252">/* this actually does the work */</a>
<a name="ln1253">int store(dt_imageio_module_storage_t *self, struct dt_imageio_module_data_t *sdata, const int imgid,</a>
<a name="ln1254">          dt_imageio_module_format_t *format, dt_imageio_module_data_t *fdata, const int num, const int total,</a>
<a name="ln1255">          const gboolean high_quality, const gboolean upscale, dt_colorspaces_color_profile_type_t icc_type,</a>
<a name="ln1256">          const gchar *icc_filename, dt_iop_color_intent_t icc_intent)</a>
<a name="ln1257">{</a>
<a name="ln1258">  gint result = 1;</a>
<a name="ln1259">  dt_storage_facebook_param_t *p = (dt_storage_facebook_param_t *)sdata;</a>
<a name="ln1260"> </a>
<a name="ln1261">  const char *ext = format-&gt;extension(fdata);</a>
<a name="ln1262">  char fname[PATH_MAX] = { 0 };</a>
<a name="ln1263">  dt_loc_get_tmp_dir(fname, sizeof(fname));</a>
<a name="ln1264">  g_strlcat(fname, &quot;/darktable.XXXXXX.&quot;, sizeof(fname));</a>
<a name="ln1265">  g_strlcat(fname, ext, sizeof(fname));</a>
<a name="ln1266"> </a>
<a name="ln1267">  gint fd = g_mkstemp(fname);</a>
<a name="ln1268">  if(fd == -1)</a>
<a name="ln1269">  {</a>
<a name="ln1270">    dt_control_log(&quot;failed to create temporary image for facebook export&quot;);</a>
<a name="ln1271">    return 1;</a>
<a name="ln1272">  }</a>
<a name="ln1273">  close(fd);</a>
<a name="ln1274"> </a>
<a name="ln1275">  // get metadata</a>
<a name="ln1276">  const dt_image_t *img = dt_image_cache_get(darktable.image_cache, imgid, 'r');</a>
<a name="ln1277">  char *caption = NULL;</a>
<a name="ln1278">  GList *caption_list = NULL;</a>
<a name="ln1279"> </a>
<a name="ln1280">  caption_list = dt_metadata_get(img-&gt;id, &quot;Xmp.dc.title&quot;, NULL);</a>
<a name="ln1281">  if(caption_list != NULL)</a>
<a name="ln1282">  {</a>
<a name="ln1283">    caption = g_strdup(caption_list-&gt;data);</a>
<a name="ln1284">    g_list_free_full(caption_list, &amp;g_free);</a>
<a name="ln1285">  }</a>
<a name="ln1286">  else</a>
<a name="ln1287">  {</a>
<a name="ln1288">    caption_list = dt_metadata_get(img-&gt;id, &quot;Xmp.dc.description&quot;, NULL);</a>
<a name="ln1289">    if(caption_list != NULL)</a>
<a name="ln1290">    {</a>
<a name="ln1291">      caption = g_strdup(caption_list-&gt;data);</a>
<a name="ln1292">      g_list_free_full(caption_list, &amp;g_free);</a>
<a name="ln1293">    }</a>
<a name="ln1294">  }</a>
<a name="ln1295">  dt_image_cache_read_release(darktable.image_cache, img);</a>
<a name="ln1296"> </a>
<a name="ln1297">  // facebook doesn't allow pictures bigger than FB_IMAGE_MAX_SIZExFB_IMAGE_MAX_SIZE px</a>
<a name="ln1298">  if(fdata-&gt;max_height == 0 || fdata-&gt;max_height &gt; FB_IMAGE_MAX_SIZE) fdata-&gt;max_height = FB_IMAGE_MAX_SIZE;</a>
<a name="ln1299">  if(fdata-&gt;max_width == 0 || fdata-&gt;max_width &gt; FB_IMAGE_MAX_SIZE) fdata-&gt;max_width = FB_IMAGE_MAX_SIZE;</a>
<a name="ln1300"> </a>
<a name="ln1301">  if(dt_imageio_export(imgid, fname, format, fdata, high_quality, upscale, FALSE, icc_type, icc_filename, icc_intent,</a>
<a name="ln1302">                       self, sdata, num, total)</a>
<a name="ln1303">     != 0)</a>
<a name="ln1304">  {</a>
<a name="ln1305">    g_printerr(&quot;[facebook] could not export to file: `%s'!\n&quot;, fname);</a>
<a name="ln1306">    dt_control_log(_(&quot;could not export to file `%s'!&quot;), fname);</a>
<a name="ln1307">    result = 0;</a>
<a name="ln1308">    goto cleanup;</a>
<a name="ln1309">  }</a>
<a name="ln1310"> </a>
<a name="ln1311">  if(p-&gt;facebook_ctx-&gt;album_id == NULL)</a>
<a name="ln1312">  {</a>
<a name="ln1313">    if(p-&gt;facebook_ctx-&gt;album_title == NULL || strlen(p-&gt;facebook_ctx-&gt;album_title) == 0)</a>
<a name="ln1314">    {</a>
<a name="ln1315">      dt_control_log(_(&quot;unable to create album, no title provided&quot;));</a>
<a name="ln1316">      result = 0;</a>
<a name="ln1317">      goto cleanup;</a>
<a name="ln1318">    }</a>
<a name="ln1319">    const gchar *album_id</a>
<a name="ln1320">        = fb_create_album(p-&gt;facebook_ctx, p-&gt;facebook_ctx-&gt;album_title, p-&gt;facebook_ctx-&gt;album_summary,</a>
<a name="ln1321">                          p-&gt;facebook_ctx-&gt;album_permission);</a>
<a name="ln1322">    if(album_id == NULL)</a>
<a name="ln1323">    {</a>
<a name="ln1324">      dt_control_log(_(&quot;unable to create album&quot;));</a>
<a name="ln1325">      result = 0;</a>
<a name="ln1326">      goto cleanup;</a>
<a name="ln1327">    }</a>
<a name="ln1328">    p-&gt;facebook_ctx-&gt;album_id = g_strdup(album_id);</a>
<a name="ln1329">  }</a>
<a name="ln1330"> </a>
<a name="ln1331">  const char *photoid = fb_upload_photo_to_album(p-&gt;facebook_ctx, p-&gt;facebook_ctx-&gt;album_id, fname, caption);</a>
<a name="ln1332">  if(photoid == NULL)</a>
<a name="ln1333">  {</a>
<a name="ln1334">    dt_control_log(_(&quot;unable to export photo to webalbum&quot;));</a>
<a name="ln1335">    result = 0;</a>
<a name="ln1336">    goto cleanup;</a>
<a name="ln1337">  }</a>
<a name="ln1338"> </a>
<a name="ln1339">cleanup:</a>
<a name="ln1340">  g_unlink(fname);</a>
<a name="ln1341">  g_free(caption);</a>
<a name="ln1342"> </a>
<a name="ln1343">  if(result)</a>
<a name="ln1344">  {</a>
<a name="ln1345">    // this makes sense only if the export was successful</a>
<a name="ln1346">    dt_control_log(ngettext(&quot;%d/%d exported to facebook webalbum&quot;, &quot;%d/%d exported to facebook webalbum&quot;, num),</a>
<a name="ln1347">                   num, total);</a>
<a name="ln1348">  }</a>
<a name="ln1349">  return 0;</a>
<a name="ln1350">}</a>
<a name="ln1351"> </a>
<a name="ln1352">static gboolean _finalize_store(gpointer user_data)</a>
<a name="ln1353">{</a>
<a name="ln1354">  dt_storage_facebook_gui_data_t *ui = (dt_storage_facebook_gui_data_t *)user_data;</a>
<a name="ln1355">  ui_reset_albums_creation(ui);</a>
<a name="ln1356">  ui_refresh_albums(ui);</a>
<a name="ln1357"> </a>
<a name="ln1358">  return FALSE;</a>
<a name="ln1359">}</a>
<a name="ln1360"> </a>
<a name="ln1361">void finalize_store(struct dt_imageio_module_storage_t *self, dt_imageio_module_data_t *data)</a>
<a name="ln1362">{</a>
<a name="ln1363">  g_main_context_invoke(NULL, _finalize_store, self-&gt;gui_data);</a>
<a name="ln1364">}</a>
<a name="ln1365"> </a>
<a name="ln1366">size_t params_size(dt_imageio_module_storage_t *self)</a>
<a name="ln1367">{</a>
<a name="ln1368">  return sizeof(gint64);</a>
<a name="ln1369">}</a>
<a name="ln1370"> </a>
<a name="ln1371"> </a>
<a name="ln1372">void init(dt_imageio_module_storage_t *self)</a>
<a name="ln1373">{</a>
<a name="ln1374">}</a>
<a name="ln1375">void *get_params(struct dt_imageio_module_storage_t *self)</a>
<a name="ln1376">{</a>
<a name="ln1377">  dt_storage_facebook_gui_data_t *ui = (dt_storage_facebook_gui_data_t *)self-&gt;gui_data;</a>
<a name="ln1378">  if(!ui) return NULL; // gui not initialized, CLI mode</a>
<a name="ln1379">  if(ui-&gt;facebook_api == NULL || ui-&gt;facebook_api-&gt;token == NULL)</a>
<a name="ln1380">  {</a>
<a name="ln1381">    return NULL;</a>
<a name="ln1382">  }</a>
<a name="ln1383">  dt_storage_facebook_param_t *p</a>
<a name="ln1384">      = (dt_storage_facebook_param_t *)g_malloc0(sizeof(dt_storage_facebook_param_t));</a>
<a name="ln1385">  p-&gt;hash = 1;</a>
<a name="ln1386">  p-&gt;facebook_ctx = ui-&gt;facebook_api;</a>
<a name="ln1387">  int index = gtk_combo_box_get_active(ui-&gt;comboBox_album);</a>
<a name="ln1388">  if(index &lt; 0)</a>
<a name="ln1389">  {</a>
<a name="ln1390">    g_free(p);</a>
<a name="ln1391">    return NULL;</a>
<a name="ln1392">  }</a>
<a name="ln1393">  else if(index == 0)</a>
<a name="ln1394">  {</a>
<a name="ln1395">    p-&gt;facebook_ctx-&gt;album_id = NULL;</a>
<a name="ln1396">    p-&gt;facebook_ctx-&gt;album_title = g_strdup(gtk_entry_get_text(ui-&gt;entry_album_title));</a>
<a name="ln1397">    p-&gt;facebook_ctx-&gt;album_summary = g_strdup(gtk_entry_get_text(ui-&gt;entry_album_summary));</a>
<a name="ln1398">    GtkTreeModel *model = gtk_combo_box_get_model(ui-&gt;comboBox_privacy);</a>
<a name="ln1399">    GtkTreeIter iter;</a>
<a name="ln1400">    int permission = -1;</a>
<a name="ln1401">    gtk_combo_box_get_active_iter(ui-&gt;comboBox_privacy, &amp;iter);</a>
<a name="ln1402">    gtk_tree_model_get(model, &amp;iter, COMBO_PRIVACY_MODEL_VAL_COL, &amp;permission, -1);</a>
<a name="ln1403">    p-&gt;facebook_ctx-&gt;album_permission = permission;</a>
<a name="ln1404">  }</a>
<a name="ln1405">  else</a>
<a name="ln1406">  {</a>
<a name="ln1407">    GtkTreeModel *model = gtk_combo_box_get_model(ui-&gt;comboBox_album);</a>
<a name="ln1408">    GtkTreeIter iter;</a>
<a name="ln1409">    gchar *albumid = NULL;</a>
<a name="ln1410">    gtk_combo_box_get_active_iter(ui-&gt;comboBox_album, &amp;iter);</a>
<a name="ln1411">    gtk_tree_model_get(model, &amp;iter, COMBO_ALBUM_MODEL_ID_COL, &amp;albumid, -1);</a>
<a name="ln1412">    p-&gt;facebook_ctx-&gt;album_id = g_strdup(albumid);</a>
<a name="ln1413">  }</a>
<a name="ln1414"> </a>
<a name="ln1415">  // recreate a new context for further usages</a>
<a name="ln1416">  ui-&gt;facebook_api = fb_api_init();</a>
<a name="ln1417">  ui-&gt;facebook_api-&gt;token = g_strdup(p-&gt;facebook_ctx-&gt;token);</a>
<a name="ln1418">  return p;</a>
<a name="ln1419">}</a>
<a name="ln1420"> </a>
<a name="ln1421"> </a>
<a name="ln1422">void free_params(struct dt_imageio_module_storage_t *self, dt_imageio_module_data_t *data)</a>
<a name="ln1423">{</a>
<a name="ln1424">  if(!data) return;</a>
<a name="ln1425">  dt_storage_facebook_param_t *p = (dt_storage_facebook_param_t *)data;</a>
<a name="ln1426">  fb_api_destroy(p-&gt;facebook_ctx);</a>
<a name="ln1427">  g_free(p);</a>
<a name="ln1428">}</a>
<a name="ln1429"> </a>
<a name="ln1430">int set_params(struct dt_imageio_module_storage_t *self, const void *params, const int size)</a>
<a name="ln1431">{</a>
<a name="ln1432">  if(size != self-&gt;params_size(self)) return 1;</a>
<a name="ln1433">  // gui stuff not updated, as sensitive user data is not stored in the preset.</a>
<a name="ln1434">  // TODO: store name/hash in kwallet/etc module and get encrypted stuff from there!</a>
<a name="ln1435">  return 0;</a>
<a name="ln1436">}</a>
<a name="ln1437"> </a>
<a name="ln1438">// modelines: These editor modelines have been set for all relevant files by tools/update_modelines.sh</a>
<a name="ln1439">// vim: shiftwidth=2 expandtab tabstop=2 cindent</a>
<a name="ln1440">// kate: tab-indents: off; indent-width 2; replace-tabs on; indent-mode cstyle; remove-trailing-spaces modified;</a>

</code></pre>
<div class="balloon" rel="336"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v568/" target="_blank">V568</a> It's odd that 'sizeof()' operator evaluates the size of a pointer to a class, but not the size of the 'response' class object.</p></div>
<div class="balloon" rel="411"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v568/" target="_blank">V568</a> It's odd that 'sizeof()' operator evaluates the size of a pointer to a class, but not the size of the 'formlist.formpost' class object.</p></div>
<div class="balloon" rel="413"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v568/" target="_blank">V568</a> It's odd that 'sizeof()' operator evaluates the size of a pointer to a class, but not the size of the 'response' class object.</p></div>
<div class="balloon" rel="899"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1004/" target="_blank">V1004</a> The 'albumList' pointer was used unsafely after it was verified against nullptr. Check lines: 893, 899.</p></div>
<div class="balloon" rel="899"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v595/" target="_blank">V595</a> The 'albumList' pointer was utilized before it was verified against nullptr. Check lines: 899, 901.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
