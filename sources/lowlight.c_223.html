
<html>
<head>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>
<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2">    This file is part of darktable,</a>
<a name="ln3">    copyright (c) 2011 Rostyslav Pidgornyi</a>
<a name="ln4"> </a>
<a name="ln5">    darktable is free software: you can redistribute it and/or modify</a>
<a name="ln6">    it under the terms of the GNU General Public License as published by</a>
<a name="ln7">    the Free Software Foundation, either version 3 of the License, or</a>
<a name="ln8">    (at your option) any later version.</a>
<a name="ln9"> </a>
<a name="ln10">    darktable is distributed in the hope that it will be useful,</a>
<a name="ln11">    but WITHOUT ANY WARRANTY; without even the implied warranty of</a>
<a name="ln12">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</a>
<a name="ln13">    GNU General Public License for more details.</a>
<a name="ln14"> </a>
<a name="ln15">    You should have received a copy of the GNU General Public License</a>
<a name="ln16">    along with darktable.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</a>
<a name="ln17">*/</a>
<a name="ln18">#ifdef HAVE_CONFIG_H</a>
<a name="ln19">#include &quot;config.h&quot;</a>
<a name="ln20">#endif</a>
<a name="ln21">#include &quot;bauhaus/bauhaus.h&quot;</a>
<a name="ln22">#include &quot;common/colorspaces_inline_conversions.h&quot;</a>
<a name="ln23">#include &quot;common/darktable.h&quot;</a>
<a name="ln24">#include &quot;common/debug.h&quot;</a>
<a name="ln25">#include &quot;common/opencl.h&quot;</a>
<a name="ln26">#include &quot;control/conf.h&quot;</a>
<a name="ln27">#include &quot;control/control.h&quot;</a>
<a name="ln28">#include &quot;develop/develop.h&quot;</a>
<a name="ln29">#include &quot;dtgtk/drawingarea.h&quot;</a>
<a name="ln30">#include &quot;gui/accelerators.h&quot;</a>
<a name="ln31">#include &quot;gui/draw.h&quot;</a>
<a name="ln32">#include &quot;gui/gtk.h&quot;</a>
<a name="ln33">#include &quot;gui/presets.h&quot;</a>
<a name="ln34">#include &quot;iop/iop_api.h&quot;</a>
<a name="ln35">#include &lt;inttypes.h&gt;</a>
<a name="ln36">#include &lt;math.h&gt;</a>
<a name="ln37">#include &lt;stdlib.h&gt;</a>
<a name="ln38">#include &lt;string.h&gt;</a>
<a name="ln39"> </a>
<a name="ln40">DT_MODULE_INTROSPECTION(1, dt_iop_lowlight_params_t)</a>
<a name="ln41"> </a>
<a name="ln42">#define DT_IOP_LOWLIGHT_INSET DT_PIXEL_APPLY_DPI(5)</a>
<a name="ln43">#define DT_IOP_LOWLIGHT_RES 64</a>
<a name="ln44">#define DT_IOP_LOWLIGHT_BANDS 6</a>
<a name="ln45">#define DT_IOP_LOWLIGHT_LUT_RES 0x10000</a>
<a name="ln46"> </a>
<a name="ln47">typedef struct dt_iop_lowlight_params_t</a>
<a name="ln48">{</a>
<a name="ln49">  float blueness;</a>
<a name="ln50">  float transition_x[DT_IOP_LOWLIGHT_BANDS], transition_y[DT_IOP_LOWLIGHT_BANDS];</a>
<a name="ln51">} dt_iop_lowlight_params_t;</a>
<a name="ln52"> </a>
<a name="ln53">typedef struct dt_iop_lowlight_gui_data_t</a>
<a name="ln54">{</a>
<a name="ln55">  dt_draw_curve_t *transition_curve; // curve for gui to draw</a>
<a name="ln56"> </a>
<a name="ln57">  GtkWidget *scale_blueness;</a>
<a name="ln58">  GtkDrawingArea *area;</a>
<a name="ln59">  double mouse_x, mouse_y, mouse_pick;</a>
<a name="ln60">  float mouse_radius;</a>
<a name="ln61">  dt_iop_lowlight_params_t drag_params;</a>
<a name="ln62">  int dragging;</a>
<a name="ln63">  int x_move;</a>
<a name="ln64">  float draw_xs[DT_IOP_LOWLIGHT_RES], draw_ys[DT_IOP_LOWLIGHT_RES];</a>
<a name="ln65">  float draw_min_xs[DT_IOP_LOWLIGHT_RES], draw_min_ys[DT_IOP_LOWLIGHT_RES];</a>
<a name="ln66">  float draw_max_xs[DT_IOP_LOWLIGHT_RES], draw_max_ys[DT_IOP_LOWLIGHT_RES];</a>
<a name="ln67">} dt_iop_lowlight_gui_data_t;</a>
<a name="ln68"> </a>
<a name="ln69">typedef struct dt_iop_lowlight_data_t</a>
<a name="ln70">{</a>
<a name="ln71">  float blueness;</a>
<a name="ln72">  dt_draw_curve_t *curve;</a>
<a name="ln73">  float lut[DT_IOP_LOWLIGHT_LUT_RES];</a>
<a name="ln74">} dt_iop_lowlight_data_t;</a>
<a name="ln75"> </a>
<a name="ln76">typedef struct dt_iop_lowlight_global_data_t</a>
<a name="ln77">{</a>
<a name="ln78">  int kernel_lowlight;</a>
<a name="ln79">} dt_iop_lowlight_global_data_t;</a>
<a name="ln80"> </a>
<a name="ln81"> </a>
<a name="ln82">const char *name()</a>
<a name="ln83">{</a>
<a name="ln84">  return _(&quot;lowlight vision&quot;);</a>
<a name="ln85">}</a>
<a name="ln86"> </a>
<a name="ln87">int flags()</a>
<a name="ln88">{</a>
<a name="ln89">  return IOP_FLAGS_INCLUDE_IN_STYLES | IOP_FLAGS_SUPPORTS_BLENDING | IOP_FLAGS_ALLOW_TILING;</a>
<a name="ln90">}</a>
<a name="ln91"> </a>
<a name="ln92">int default_group()</a>
<a name="ln93">{</a>
<a name="ln94">  return IOP_GROUP_EFFECT;</a>
<a name="ln95">}</a>
<a name="ln96"> </a>
<a name="ln97">int default_colorspace(dt_iop_module_t *self, dt_dev_pixelpipe_t *pipe, dt_dev_pixelpipe_iop_t *piece)</a>
<a name="ln98">{</a>
<a name="ln99">  return iop_cs_Lab;</a>
<a name="ln100">}</a>
<a name="ln101"> </a>
<a name="ln102"> </a>
<a name="ln103">void init_key_accels(dt_iop_module_so_t *self)</a>
<a name="ln104">{</a>
<a name="ln105">  dt_accel_register_slider_iop(self, FALSE, NC_(&quot;accel&quot;, &quot;blue shift&quot;));</a>
<a name="ln106">}</a>
<a name="ln107"> </a>
<a name="ln108">void connect_key_accels(dt_iop_module_t *self)</a>
<a name="ln109">{</a>
<a name="ln110">  dt_iop_lowlight_gui_data_t *g = (dt_iop_lowlight_gui_data_t *)self-&gt;gui_data;</a>
<a name="ln111">  dt_accel_connect_slider_iop(self, &quot;blue shift&quot;, g-&gt;scale_blueness);</a>
<a name="ln112">}</a>
<a name="ln113"> </a>
<a name="ln114">static float lookup(const float *lut, const float i)</a>
<a name="ln115">{</a>
<a name="ln116">  const int bin0 = MIN(0xffff, MAX(0, DT_IOP_LOWLIGHT_LUT_RES * i));</a>
<a name="ln117">  const int bin1 = MIN(0xffff, MAX(0, DT_IOP_LOWLIGHT_LUT_RES * i + 1));</a>
<a name="ln118">  const float f = DT_IOP_LOWLIGHT_LUT_RES * i - bin0;</a>
<a name="ln119">  return lut[bin1] * f + lut[bin0] * (1. - f);</a>
<a name="ln120">}</a>
<a name="ln121"> </a>
<a name="ln122">void process(struct dt_iop_module_t *self, dt_dev_pixelpipe_iop_t *piece, const void *const i, void *const o,</a>
<a name="ln123">             const dt_iop_roi_t *const roi_in, const dt_iop_roi_t *const roi_out)</a>
<a name="ln124">{</a>
<a name="ln125">  dt_iop_lowlight_data_t *d = (dt_iop_lowlight_data_t *)(piece-&gt;data);</a>
<a name="ln126">  const int ch = piece-&gt;colors;</a>
<a name="ln127"> </a>
<a name="ln128">  // empiric coefficient</a>
<a name="ln129">  const float c = 0.5f;</a>
<a name="ln130">  const float threshold = 0.01f;</a>
<a name="ln131"> </a>
<a name="ln132">  // scotopic white, blue saturated</a>
<a name="ln133">  float Lab_sw[3] = { 100.0f, 0, -d-&gt;blueness };</a>
<a name="ln134">  float XYZ_sw[3];</a>
<a name="ln135"> </a>
<a name="ln136">  dt_Lab_to_XYZ(Lab_sw, XYZ_sw);</a>
<a name="ln137"> </a>
<a name="ln138">#ifdef _OPENMP</a>
<a name="ln139">#pragma omp parallel for default(none) schedule(static) shared(d, XYZ_sw)</a>
<a name="ln140">#endif</a>
<a name="ln141">  for(size_t k = 0; k &lt; (size_t)roi_out-&gt;width * roi_out-&gt;height; k++)</a>
<a name="ln142">  {</a>
<a name="ln143">    float *in = (float *)i + ch * k;</a>
<a name="ln144">    float *out = (float *)o + ch * k;</a>
<a name="ln145">    float XYZ[3], XYZ_s[3];</a>
<a name="ln146">    float V;</a>
<a name="ln147">    float w;</a>
<a name="ln148"> </a>
<a name="ln149">    dt_Lab_to_XYZ(in, XYZ);</a>
<a name="ln150"> </a>
<a name="ln151">    // calculate scotopic luminance</a>
<a name="ln152">    if(XYZ[0] &gt; threshold)</a>
<a name="ln153">    {</a>
<a name="ln154">      // normal flow</a>
<a name="ln155">      V = XYZ[1] * (1.33f * (1.0f + (XYZ[1] + XYZ[2]) / XYZ[0]) - 1.68f);</a>
<a name="ln156">    }</a>
<a name="ln157">    else</a>
<a name="ln158">    {</a>
<a name="ln159">      // low red flow, avoids &quot;snow&quot; on dark noisy areas</a>
<a name="ln160">      V = XYZ[1] * (1.33f * (1.0f + (XYZ[1] + XYZ[2]) / threshold) - 1.68f);</a>
<a name="ln161">    }</a>
<a name="ln162"> </a>
<a name="ln163">    // scale using empiric coefficient and fit inside limits</a>
<a name="ln164">    V = fminf(1.0f, fmaxf(0.0f, c * V));</a>
<a name="ln165"> </a>
<a name="ln166">    // blending coefficient from curve</a>
<a name="ln167">    w = lookup(d-&gt;lut, in[0] / 100.f);</a>
<a name="ln168"> </a>
<a name="ln169">    XYZ_s[0] = V * XYZ_sw[0];</a>
<a name="ln170">    XYZ_s[1] = V * XYZ_sw[1];</a>
<a name="ln171">    XYZ_s[2] = V * XYZ_sw[2];</a>
<a name="ln172"> </a>
<a name="ln173">    XYZ[0] = w * XYZ[0] + (1.0f - w) * XYZ_s[0];</a>
<a name="ln174">    XYZ[1] = w * XYZ[1] + (1.0f - w) * XYZ_s[1];</a>
<a name="ln175">    XYZ[2] = w * XYZ[2] + (1.0f - w) * XYZ_s[2];</a>
<a name="ln176"> </a>
<a name="ln177">    dt_XYZ_to_Lab(XYZ, out);</a>
<a name="ln178"> </a>
<a name="ln179">    out[3] = in[3];</a>
<a name="ln180">  }</a>
<a name="ln181">}</a>
<a name="ln182"> </a>
<a name="ln183">#ifdef HAVE_OPENCL</a>
<a name="ln184">int process_cl(struct dt_iop_module_t *self, dt_dev_pixelpipe_iop_t *piece, cl_mem dev_in, cl_mem dev_out,</a>
<a name="ln185">               const dt_iop_roi_t *const roi_in, const dt_iop_roi_t *const roi_out)</a>
<a name="ln186">{</a>
<a name="ln187">  dt_iop_lowlight_data_t *d = (dt_iop_lowlight_data_t *)piece-&gt;data;</a>
<a name="ln188">  dt_iop_lowlight_global_data_t *gd = (dt_iop_lowlight_global_data_t *)self-&gt;data;</a>
<a name="ln189"> </a>
<a name="ln190">  cl_mem dev_m = NULL;</a>
<a name="ln191">  cl_int err = -999;</a>
<a name="ln192">  const int devid = piece-&gt;pipe-&gt;devid;</a>
<a name="ln193"> </a>
<a name="ln194">  const int width = roi_out-&gt;width;</a>
<a name="ln195">  const int height = roi_out-&gt;height;</a>
<a name="ln196"> </a>
<a name="ln197">  // scotopic white, blue saturated</a>
<a name="ln198">  float Lab_sw[3] = { 100.0f, 0.0f, -d-&gt;blueness };</a>
<a name="ln199">  float XYZ_sw[4];</a>
<a name="ln200"> </a>
<a name="ln201">  dt_Lab_to_XYZ(Lab_sw, XYZ_sw);</a>
<a name="ln202"> </a>
<a name="ln203">  dev_m = dt_opencl_copy_host_to_device(devid, d-&gt;lut, 256, 256, sizeof(float));</a>
<a name="ln204">  if(dev_m == NULL) goto error;</a>
<a name="ln205"> </a>
<a name="ln206">  size_t sizes[2] = { ROUNDUPWD(width), ROUNDUPHT(height) };</a>
<a name="ln207">  dt_opencl_set_kernel_arg(devid, gd-&gt;kernel_lowlight, 0, sizeof(cl_mem), &amp;dev_in);</a>
<a name="ln208">  dt_opencl_set_kernel_arg(devid, gd-&gt;kernel_lowlight, 1, sizeof(cl_mem), &amp;dev_out);</a>
<a name="ln209">  dt_opencl_set_kernel_arg(devid, gd-&gt;kernel_lowlight, 2, sizeof(int), &amp;width);</a>
<a name="ln210">  dt_opencl_set_kernel_arg(devid, gd-&gt;kernel_lowlight, 3, sizeof(int), &amp;height);</a>
<a name="ln211">  dt_opencl_set_kernel_arg(devid, gd-&gt;kernel_lowlight, 4, 4 * sizeof(float), &amp;XYZ_sw);</a>
<a name="ln212">  dt_opencl_set_kernel_arg(devid, gd-&gt;kernel_lowlight, 5, sizeof(cl_mem), &amp;dev_m);</a>
<a name="ln213">  err = dt_opencl_enqueue_kernel_2d(devid, gd-&gt;kernel_lowlight, sizes);</a>
<a name="ln214">  if(err != CL_SUCCESS) goto error;</a>
<a name="ln215"> </a>
<a name="ln216">  dt_opencl_release_mem_object(dev_m);</a>
<a name="ln217">  return TRUE;</a>
<a name="ln218"> </a>
<a name="ln219">error:</a>
<a name="ln220">  dt_opencl_release_mem_object(dev_m);</a>
<a name="ln221">  dt_print(DT_DEBUG_OPENCL, &quot;[opencl_lowlight] couldn't enqueue kernel! %d\n&quot;, err);</a>
<a name="ln222">  return FALSE;</a>
<a name="ln223">}</a>
<a name="ln224">#endif</a>
<a name="ln225"> </a>
<a name="ln226"> </a>
<a name="ln227">void init_global(dt_iop_module_so_t *module)</a>
<a name="ln228">{</a>
<a name="ln229">  const int program = 2; // basic.cl from programs.conf</a>
<a name="ln230">  dt_iop_lowlight_global_data_t *gd</a>
<a name="ln231">      = (dt_iop_lowlight_global_data_t *)malloc(sizeof(dt_iop_lowlight_global_data_t));</a>
<a name="ln232">  module-&gt;data = gd;</a>
<a name="ln233">  gd-&gt;kernel_lowlight = dt_opencl_create_kernel(program, &quot;lowlight&quot;);</a>
<a name="ln234">}</a>
<a name="ln235"> </a>
<a name="ln236"> </a>
<a name="ln237">void cleanup_global(dt_iop_module_so_t *module)</a>
<a name="ln238">{</a>
<a name="ln239">  dt_iop_lowlight_global_data_t *gd = (dt_iop_lowlight_global_data_t *)module-&gt;data;</a>
<a name="ln240">  dt_opencl_free_kernel(gd-&gt;kernel_lowlight);</a>
<a name="ln241">  free(module-&gt;data);</a>
<a name="ln242">  module-&gt;data = NULL;</a>
<a name="ln243">}</a>
<a name="ln244"> </a>
<a name="ln245"> </a>
<a name="ln246">void commit_params(struct dt_iop_module_t *self, dt_iop_params_t *p1, dt_dev_pixelpipe_t *pipe,</a>
<a name="ln247">                   dt_dev_pixelpipe_iop_t *piece)</a>
<a name="ln248">{</a>
<a name="ln249">  dt_iop_lowlight_data_t *d = (dt_iop_lowlight_data_t *)(piece-&gt;data);</a>
<a name="ln250">  dt_iop_lowlight_params_t *p = (dt_iop_lowlight_params_t *)p1;</a>
<a name="ln251">  dt_draw_curve_set_point(d-&gt;curve, 0, p-&gt;transition_x[DT_IOP_LOWLIGHT_BANDS - 2] - 1.0, p-&gt;transition_y[0]);</a>
<a name="ln252">  for(int k = 0; k &lt; DT_IOP_LOWLIGHT_BANDS; k++)</a>
<a name="ln253">    dt_draw_curve_set_point(d-&gt;curve, k + 1, p-&gt;transition_x[k], p-&gt;transition_y[k]);</a>
<a name="ln254">  dt_draw_curve_set_point(d-&gt;curve, DT_IOP_LOWLIGHT_BANDS + 1, p-&gt;transition_x[1] + 1.0,</a>
<a name="ln255">                          p-&gt;transition_y[DT_IOP_LOWLIGHT_BANDS - 1]);</a>
<a name="ln256">  dt_draw_curve_calc_values(d-&gt;curve, 0.0, 1.0, DT_IOP_LOWLIGHT_LUT_RES, NULL, d-&gt;lut);</a>
<a name="ln257">  d-&gt;blueness = p-&gt;blueness;</a>
<a name="ln258">}</a>
<a name="ln259"> </a>
<a name="ln260">void init_pipe(struct dt_iop_module_t *self, dt_dev_pixelpipe_t *pipe, dt_dev_pixelpipe_iop_t *piece)</a>
<a name="ln261">{</a>
<a name="ln262">  dt_iop_lowlight_data_t *d = (dt_iop_lowlight_data_t *)malloc(sizeof(dt_iop_lowlight_data_t));</a>
<a name="ln263">  dt_iop_lowlight_params_t *default_params = (dt_iop_lowlight_params_t *)self-&gt;default_params;</a>
<a name="ln264">  piece-&gt;data = (void *)d;</a>
<a name="ln265">  d-&gt;curve = dt_draw_curve_new(0.0, 1.0, CATMULL_ROM);</a>
<a name="ln266">  (void)dt_draw_curve_add_point(d-&gt;curve, default_params-&gt;transition_x[DT_IOP_LOWLIGHT_BANDS - 2] - 1.0,</a>
<a name="ln267">                                default_params-&gt;transition_y[DT_IOP_LOWLIGHT_BANDS - 2]);</a>
<a name="ln268">  for(int k = 0; k &lt; DT_IOP_LOWLIGHT_BANDS; k++)</a>
<a name="ln269">    (void)dt_draw_curve_add_point(d-&gt;curve, default_params-&gt;transition_x[k], default_params-&gt;transition_y[k]);</a>
<a name="ln270">  (void)dt_draw_curve_add_point(d-&gt;curve, default_params-&gt;transition_x[1] + 1.0,</a>
<a name="ln271">                                default_params-&gt;transition_y[1]);</a>
<a name="ln272">}</a>
<a name="ln273"> </a>
<a name="ln274">void cleanup_pipe(struct dt_iop_module_t *self, dt_dev_pixelpipe_t *pipe, dt_dev_pixelpipe_iop_t *piece)</a>
<a name="ln275">{</a>
<a name="ln276">  // clean up everything again.</a>
<a name="ln277">  dt_iop_lowlight_data_t *d = (dt_iop_lowlight_data_t *)(piece-&gt;data);</a>
<a name="ln278">  dt_draw_curve_destroy(d-&gt;curve);</a>
<a name="ln279">  free(piece-&gt;data);</a>
<a name="ln280">  piece-&gt;data = NULL;</a>
<a name="ln281">}</a>
<a name="ln282"> </a>
<a name="ln283">void gui_update(struct dt_iop_module_t *self)</a>
<a name="ln284">{</a>
<a name="ln285">  dt_iop_lowlight_gui_data_t *g = (dt_iop_lowlight_gui_data_t *)self-&gt;gui_data;</a>
<a name="ln286">  dt_iop_lowlight_params_t *p = (dt_iop_lowlight_params_t *)self-&gt;params;</a>
<a name="ln287">  dt_bauhaus_slider_set(g-&gt;scale_blueness, p-&gt;blueness);</a>
<a name="ln288">  gtk_widget_queue_draw(self-&gt;widget);</a>
<a name="ln289">}</a>
<a name="ln290"> </a>
<a name="ln291">void init(dt_iop_module_t *module)</a>
<a name="ln292">{</a>
<a name="ln293">  module-&gt;params = calloc(1, sizeof(dt_iop_lowlight_params_t));</a>
<a name="ln294">  module-&gt;default_params = calloc(1, sizeof(dt_iop_lowlight_params_t));</a>
<a name="ln295">  module-&gt;default_enabled = 0; // we're a rather slow and rare op.</a>
<a name="ln296">  module-&gt;params_size = sizeof(dt_iop_lowlight_params_t);</a>
<a name="ln297">  module-&gt;gui_data = NULL;</a>
<a name="ln298">  dt_iop_lowlight_params_t tmp;</a>
<a name="ln299">  for(int k = 0; k &lt; DT_IOP_LOWLIGHT_BANDS; k++) tmp.transition_x[k] = k / (DT_IOP_LOWLIGHT_BANDS - 1.0);</a>
<a name="ln300">  for(int k = 0; k &lt; DT_IOP_LOWLIGHT_BANDS; k++) tmp.transition_y[k] = 0.5f;</a>
<a name="ln301">  tmp.blueness = 0.0f;</a>
<a name="ln302">  memcpy(module-&gt;params, &amp;tmp, sizeof(dt_iop_lowlight_params_t));</a>
<a name="ln303">  memcpy(module-&gt;default_params, &amp;tmp, sizeof(dt_iop_lowlight_params_t));</a>
<a name="ln304">}</a>
<a name="ln305"> </a>
<a name="ln306">void cleanup(dt_iop_module_t *module)</a>
<a name="ln307">{</a>
<a name="ln308">  free(module-&gt;params);</a>
<a name="ln309">  module-&gt;params = NULL;</a>
<a name="ln310">}</a>
<a name="ln311"> </a>
<a name="ln312">void init_presets(dt_iop_module_so_t *self)</a>
<a name="ln313">{</a>
<a name="ln314">  dt_iop_lowlight_params_t p;</a>
<a name="ln315"> </a>
<a name="ln316">  DT_DEBUG_SQLITE3_EXEC(dt_database_get(darktable.db), &quot;BEGIN&quot;, NULL, NULL, NULL);</a>
<a name="ln317"> </a>
<a name="ln318">  p.transition_x[0] = 0.000000;</a>
<a name="ln319">  p.transition_x[1] = 0.200000;</a>
<a name="ln320">  p.transition_x[2] = 0.400000;</a>
<a name="ln321">  p.transition_x[3] = 0.600000;</a>
<a name="ln322">  p.transition_x[4] = 0.800000;</a>
<a name="ln323">  p.transition_x[5] = 1.000000;</a>
<a name="ln324"> </a>
<a name="ln325">  p.transition_y[0] = 1.000000;</a>
<a name="ln326">  p.transition_y[1] = 1.000000;</a>
<a name="ln327">  p.transition_y[2] = 1.000000;</a>
<a name="ln328">  p.transition_y[3] = 1.000000;</a>
<a name="ln329">  p.transition_y[4] = 1.000000;</a>
<a name="ln330">  p.transition_y[5] = 1.000000;</a>
<a name="ln331"> </a>
<a name="ln332">  p.blueness = 0.0f;</a>
<a name="ln333">  dt_gui_presets_add_generic(_(&quot;daylight&quot;), self-&gt;op, self-&gt;version(), &amp;p, sizeof(p), 1);</a>
<a name="ln334"> </a>
<a name="ln335">  p.transition_x[0] = 0.000000;</a>
<a name="ln336">  p.transition_x[1] = 0.200000;</a>
<a name="ln337">  p.transition_x[2] = 0.400000;</a>
<a name="ln338">  p.transition_x[3] = 0.600000;</a>
<a name="ln339">  p.transition_x[4] = 0.800000;</a>
<a name="ln340">  p.transition_x[5] = 1.000000;</a>
<a name="ln341"> </a>
<a name="ln342">  p.transition_y[0] = 0.600000;</a>
<a name="ln343">  p.transition_y[1] = 0.800000;</a>
<a name="ln344">  p.transition_y[2] = 0.950000;</a>
<a name="ln345">  p.transition_y[3] = 0.980000;</a>
<a name="ln346">  p.transition_y[4] = 1.000000;</a>
<a name="ln347">  p.transition_y[5] = 1.000000;</a>
<a name="ln348"> </a>
<a name="ln349">  p.blueness = 30.0f;</a>
<a name="ln350">  dt_gui_presets_add_generic(_(&quot;indoor bright&quot;), self-&gt;op, self-&gt;version(), &amp;p, sizeof(p), 1);</a>
<a name="ln351"> </a>
<a name="ln352">  p.transition_x[0] = 0.000000;</a>
<a name="ln353">  p.transition_x[1] = 0.200000;</a>
<a name="ln354">  p.transition_x[2] = 0.400000;</a>
<a name="ln355">  p.transition_x[3] = 0.600000;</a>
<a name="ln356">  p.transition_x[4] = 0.800000;</a>
<a name="ln357">  p.transition_x[5] = 1.000000;</a>
<a name="ln358"> </a>
<a name="ln359">  p.transition_y[0] = 0.300000;</a>
<a name="ln360">  p.transition_y[1] = 0.500000;</a>
<a name="ln361">  p.transition_y[2] = 0.700000;</a>
<a name="ln362">  p.transition_y[3] = 0.850000;</a>
<a name="ln363">  p.transition_y[4] = 0.970000;</a>
<a name="ln364">  p.transition_y[5] = 1.000000;</a>
<a name="ln365"> </a>
<a name="ln366">  p.blueness = 30.0f;</a>
<a name="ln367">  dt_gui_presets_add_generic(_(&quot;indoor dim&quot;), self-&gt;op, self-&gt;version(), &amp;p, sizeof(p), 1);</a>
<a name="ln368"> </a>
<a name="ln369">  p.transition_x[0] = 0.000000;</a>
<a name="ln370">  p.transition_x[1] = 0.200000;</a>
<a name="ln371">  p.transition_x[2] = 0.400000;</a>
<a name="ln372">  p.transition_x[3] = 0.600000;</a>
<a name="ln373">  p.transition_x[4] = 0.800000;</a>
<a name="ln374">  p.transition_x[5] = 1.000000;</a>
<a name="ln375"> </a>
<a name="ln376">  p.transition_y[0] = 0.050000;</a>
<a name="ln377">  p.transition_y[1] = 0.200000;</a>
<a name="ln378">  p.transition_y[2] = 0.400000;</a>
<a name="ln379">  p.transition_y[3] = 0.700000;</a>
<a name="ln380">  p.transition_y[4] = 0.920000;</a>
<a name="ln381">  p.transition_y[5] = 1.000000;</a>
<a name="ln382"> </a>
<a name="ln383">  p.blueness = 40.0f;</a>
<a name="ln384">  dt_gui_presets_add_generic(_(&quot;indoor dark&quot;), self-&gt;op, self-&gt;version(), &amp;p, sizeof(p), 1);</a>
<a name="ln385"> </a>
<a name="ln386">  p.transition_x[0] = 0.000000;</a>
<a name="ln387">  p.transition_x[1] = 0.200000;</a>
<a name="ln388">  p.transition_x[2] = 0.400000;</a>
<a name="ln389">  p.transition_x[3] = 0.600000;</a>
<a name="ln390">  p.transition_x[4] = 0.800000;</a>
<a name="ln391">  p.transition_x[5] = 1.000000;</a>
<a name="ln392"> </a>
<a name="ln393">  p.transition_y[0] = 0.070000;</a>
<a name="ln394">  p.transition_y[1] = 0.100000;</a>
<a name="ln395">  p.transition_y[2] = 0.180000;</a>
<a name="ln396">  p.transition_y[3] = 0.350000;</a>
<a name="ln397">  p.transition_y[4] = 0.750000;</a>
<a name="ln398">  p.transition_y[5] = 1.000000;</a>
<a name="ln399"> </a>
<a name="ln400">  p.blueness = 50.0f;</a>
<a name="ln401">  dt_gui_presets_add_generic(_(&quot;twilight&quot;), self-&gt;op, self-&gt;version(), &amp;p, sizeof(p), 1);</a>
<a name="ln402"> </a>
<a name="ln403">  p.transition_x[0] = 0.000000;</a>
<a name="ln404">  p.transition_x[1] = 0.200000;</a>
<a name="ln405">  p.transition_x[2] = 0.400000;</a>
<a name="ln406">  p.transition_x[3] = 0.600000;</a>
<a name="ln407">  p.transition_x[4] = 0.800000;</a>
<a name="ln408">  p.transition_x[5] = 1.000000;</a>
<a name="ln409"> </a>
<a name="ln410">  p.transition_y[0] = 0.000000;</a>
<a name="ln411">  p.transition_y[1] = 0.450000;</a>
<a name="ln412">  p.transition_y[2] = 0.750000;</a>
<a name="ln413">  p.transition_y[3] = 0.930000;</a>
<a name="ln414">  p.transition_y[4] = 0.990000;</a>
<a name="ln415">  p.transition_y[5] = 1.000000;</a>
<a name="ln416"> </a>
<a name="ln417">  p.blueness = 30.0f;</a>
<a name="ln418">  dt_gui_presets_add_generic(_(&quot;night street lit&quot;), self-&gt;op, self-&gt;version(), &amp;p, sizeof(p), 1);</a>
<a name="ln419"> </a>
<a name="ln420">  p.transition_x[0] = 0.000000;</a>
<a name="ln421">  p.transition_x[1] = 0.200000;</a>
<a name="ln422">  p.transition_x[2] = 0.400000;</a>
<a name="ln423">  p.transition_x[3] = 0.600000;</a>
<a name="ln424">  p.transition_x[4] = 0.800000;</a>
<a name="ln425">  p.transition_x[5] = 1.000000;</a>
<a name="ln426"> </a>
<a name="ln427">  p.transition_y[0] = 0.000000;</a>
<a name="ln428">  p.transition_y[1] = 0.150000;</a>
<a name="ln429">  p.transition_y[2] = 0.350000;</a>
<a name="ln430">  p.transition_y[3] = 0.800000;</a>
<a name="ln431">  p.transition_y[4] = 0.970000;</a>
<a name="ln432">  p.transition_y[5] = 1.000000;</a>
<a name="ln433"> </a>
<a name="ln434">  p.blueness = 30.0f;</a>
<a name="ln435">  dt_gui_presets_add_generic(_(&quot;night street&quot;), self-&gt;op, self-&gt;version(), &amp;p, sizeof(p), 1);</a>
<a name="ln436"> </a>
<a name="ln437">  p.transition_x[0] = 0.000000;</a>
<a name="ln438">  p.transition_x[1] = 0.150000;</a>
<a name="ln439">  p.transition_x[2] = 0.400000;</a>
<a name="ln440">  p.transition_x[3] = 0.600000;</a>
<a name="ln441">  p.transition_x[4] = 0.800000;</a>
<a name="ln442">  p.transition_x[5] = 1.000000;</a>
<a name="ln443"> </a>
<a name="ln444">  p.transition_y[0] = 0.000000;</a>
<a name="ln445">  p.transition_y[1] = 0.020000;</a>
<a name="ln446">  p.transition_y[2] = 0.050000;</a>
<a name="ln447">  p.transition_y[3] = 0.200000;</a>
<a name="ln448">  p.transition_y[4] = 0.550000;</a>
<a name="ln449">  p.transition_y[5] = 1.000000;</a>
<a name="ln450"> </a>
<a name="ln451">  p.blueness = 40.0f;</a>
<a name="ln452">  dt_gui_presets_add_generic(_(&quot;night street dark&quot;), self-&gt;op, self-&gt;version(), &amp;p, sizeof(p), 1);</a>
<a name="ln453"> </a>
<a name="ln454">  p.transition_x[0] = 0.000000;</a>
<a name="ln455">  p.transition_x[1] = 0.200000;</a>
<a name="ln456">  p.transition_x[2] = 0.400000;</a>
<a name="ln457">  p.transition_x[3] = 0.600000;</a>
<a name="ln458">  p.transition_x[4] = 0.800000;</a>
<a name="ln459">  p.transition_x[5] = 1.000000;</a>
<a name="ln460"> </a>
<a name="ln461">  p.transition_y[0] = 0.000000;</a>
<a name="ln462">  p.transition_y[1] = 0.000000;</a>
<a name="ln463">  p.transition_y[2] = 0.000000;</a>
<a name="ln464">  p.transition_y[3] = 0.000000;</a>
<a name="ln465">  p.transition_y[4] = 0.000000;</a>
<a name="ln466">  p.transition_y[5] = 0.000000;</a>
<a name="ln467"> </a>
<a name="ln468"> </a>
<a name="ln469">  p.blueness = 50.0f;</a>
<a name="ln470">  dt_gui_presets_add_generic(_(&quot;night&quot;), self-&gt;op, self-&gt;version(), &amp;p, sizeof(p), 1);</a>
<a name="ln471"> </a>
<a name="ln472">  DT_DEBUG_SQLITE3_EXEC(dt_database_get(darktable.db), &quot;COMMIT&quot;, NULL, NULL, NULL);</a>
<a name="ln473">}</a>
<a name="ln474"> </a>
<a name="ln475">// fills in new parameters based on mouse position (in 0,1)</a>
<a name="ln476">static void dt_iop_lowlight_get_params(dt_iop_lowlight_params_t *p, const double mouse_x,</a>
<a name="ln477">                                       const double mouse_y, const float rad)</a>
<a name="ln478">{</a>
<a name="ln479">  for(int k = 0; k &lt; DT_IOP_LOWLIGHT_BANDS; k++)</a>
<a name="ln480">  {</a>
<a name="ln481">    const float f = expf(-(mouse_x - p-&gt;transition_x[k]) * (mouse_x - p-&gt;transition_x[k]) / (rad * rad));</a>
<a name="ln482">    p-&gt;transition_y[k] = (1 - f) * p-&gt;transition_y[k] + f * mouse_y;</a>
<a name="ln483">  }</a>
<a name="ln484">}</a>
<a name="ln485"> </a>
<a name="ln486">static gboolean lowlight_draw(GtkWidget *widget, cairo_t *crf, gpointer user_data)</a>
<a name="ln487">{</a>
<a name="ln488">  dt_iop_module_t *self = (dt_iop_module_t *)user_data;</a>
<a name="ln489">  dt_iop_lowlight_gui_data_t *c = (dt_iop_lowlight_gui_data_t *)self-&gt;gui_data;</a>
<a name="ln490">  dt_iop_lowlight_params_t p = *(dt_iop_lowlight_params_t *)self-&gt;params;</a>
<a name="ln491"> </a>
<a name="ln492">  dt_draw_curve_set_point(c-&gt;transition_curve, 0, p.transition_x[DT_IOP_LOWLIGHT_BANDS - 2] - 1.0,</a>
<a name="ln493">                          p.transition_y[0]);</a>
<a name="ln494">  for(int k = 0; k &lt; DT_IOP_LOWLIGHT_BANDS; k++)</a>
<a name="ln495">    dt_draw_curve_set_point(c-&gt;transition_curve, k + 1, p.transition_x[k], p.transition_y[k]);</a>
<a name="ln496">  dt_draw_curve_set_point(c-&gt;transition_curve, DT_IOP_LOWLIGHT_BANDS + 1, p.transition_x[1] + 1.0,</a>
<a name="ln497">                          p.transition_y[DT_IOP_LOWLIGHT_BANDS - 1]);</a>
<a name="ln498"> </a>
<a name="ln499">  const int inset = DT_IOP_LOWLIGHT_INSET;</a>
<a name="ln500">  GtkAllocation allocation;</a>
<a name="ln501">  gtk_widget_get_allocation(widget, &amp;allocation);</a>
<a name="ln502">  int width = allocation.width, height = allocation.height;</a>
<a name="ln503">  cairo_surface_t *cst = dt_cairo_image_surface_create(CAIRO_FORMAT_ARGB32, width, height);</a>
<a name="ln504">  cairo_t *cr = cairo_create(cst);</a>
<a name="ln505"> </a>
<a name="ln506">  cairo_set_source_rgb(cr, .2, .2, .2);</a>
<a name="ln507">  cairo_paint(cr);</a>
<a name="ln508"> </a>
<a name="ln509">  cairo_translate(cr, inset, inset);</a>
<a name="ln510">  width -= 2 * inset;</a>
<a name="ln511">  height -= 2 * inset;</a>
<a name="ln512"> </a>
<a name="ln513">  cairo_set_line_width(cr, DT_PIXEL_APPLY_DPI(1.0));</a>
<a name="ln514">  cairo_set_source_rgb(cr, .1, .1, .1);</a>
<a name="ln515">  cairo_rectangle(cr, 0, 0, width, height);</a>
<a name="ln516">  cairo_stroke(cr);</a>
<a name="ln517"> </a>
<a name="ln518">  cairo_set_source_rgb(cr, .3, .3, .3);</a>
<a name="ln519">  cairo_rectangle(cr, 0, 0, width, height);</a>
<a name="ln520">  cairo_fill(cr);</a>
<a name="ln521"> </a>
<a name="ln522">  // draw grid</a>
<a name="ln523">  cairo_set_line_width(cr, DT_PIXEL_APPLY_DPI(.4));</a>
<a name="ln524">  cairo_set_source_rgb(cr, .1, .1, .1);</a>
<a name="ln525">  dt_draw_grid(cr, 8, 0, 0, width, height);</a>
<a name="ln526"> </a>
<a name="ln527"> </a>
<a name="ln528">  if(c-&gt;mouse_y &gt; 0 || c-&gt;dragging)</a>
<a name="ln529">  {</a>
<a name="ln530">    // draw min/max curves:</a>
<a name="ln531">    dt_iop_lowlight_get_params(&amp;p, c-&gt;mouse_x, 1., c-&gt;mouse_radius);</a>
<a name="ln532">    dt_draw_curve_set_point(c-&gt;transition_curve, 0, p.transition_x[DT_IOP_LOWLIGHT_BANDS - 2] - 1.0,</a>
<a name="ln533">                            p.transition_y[0]);</a>
<a name="ln534">    for(int k = 0; k &lt; DT_IOP_LOWLIGHT_BANDS; k++)</a>
<a name="ln535">      dt_draw_curve_set_point(c-&gt;transition_curve, k + 1, p.transition_x[k], p.transition_y[k]);</a>
<a name="ln536">    dt_draw_curve_set_point(c-&gt;transition_curve, DT_IOP_LOWLIGHT_BANDS + 1, p.transition_x[1] + 1.0,</a>
<a name="ln537">                            p.transition_y[DT_IOP_LOWLIGHT_BANDS - 1]);</a>
<a name="ln538">    dt_draw_curve_calc_values(c-&gt;transition_curve, 0.0, 1.0, DT_IOP_LOWLIGHT_RES, c-&gt;draw_min_xs,</a>
<a name="ln539">                              c-&gt;draw_min_ys);</a>
<a name="ln540"> </a>
<a name="ln541">    p = *(dt_iop_lowlight_params_t *)self-&gt;params;</a>
<a name="ln542">    dt_iop_lowlight_get_params(&amp;p, c-&gt;mouse_x, .0, c-&gt;mouse_radius);</a>
<a name="ln543">    dt_draw_curve_set_point(c-&gt;transition_curve, 0, p.transition_x[DT_IOP_LOWLIGHT_BANDS - 2] - 1.0,</a>
<a name="ln544">                            p.transition_y[0]);</a>
<a name="ln545">    for(int k = 0; k &lt; DT_IOP_LOWLIGHT_BANDS; k++)</a>
<a name="ln546">      dt_draw_curve_set_point(c-&gt;transition_curve, k + 1, p.transition_x[k], p.transition_y[k]);</a>
<a name="ln547">    dt_draw_curve_set_point(c-&gt;transition_curve, DT_IOP_LOWLIGHT_BANDS + 1, p.transition_x[1] + 1.0,</a>
<a name="ln548">                            p.transition_y[DT_IOP_LOWLIGHT_BANDS - 1]);</a>
<a name="ln549">    dt_draw_curve_calc_values(c-&gt;transition_curve, 0.0, 1.0, DT_IOP_LOWLIGHT_RES, c-&gt;draw_max_xs,</a>
<a name="ln550">                              c-&gt;draw_max_ys);</a>
<a name="ln551">  }</a>
<a name="ln552"> </a>
<a name="ln553">  cairo_save(cr);</a>
<a name="ln554"> </a>
<a name="ln555">  // draw x positions</a>
<a name="ln556">  cairo_set_source_rgb(cr, 0.6, 0.6, 0.6);</a>
<a name="ln557">  cairo_set_line_width(cr, DT_PIXEL_APPLY_DPI(1.));</a>
<a name="ln558">  const float arrw = DT_PIXEL_APPLY_DPI(7.0f);</a>
<a name="ln559">  for(int k = 0; k &lt; DT_IOP_LOWLIGHT_BANDS; k++)</a>
<a name="ln560">  {</a>
<a name="ln561">    cairo_move_to(cr, width * p.transition_x[k], height + inset - DT_PIXEL_APPLY_DPI(1));</a>
<a name="ln562">    cairo_rel_line_to(cr, -arrw * .5f, 0);</a>
<a name="ln563">    cairo_rel_line_to(cr, arrw * .5f, -arrw);</a>
<a name="ln564">    cairo_rel_line_to(cr, arrw * .5f, arrw);</a>
<a name="ln565">    cairo_close_path(cr);</a>
<a name="ln566">    if(c-&gt;x_move == k)</a>
<a name="ln567">      cairo_fill(cr);</a>
<a name="ln568">    else</a>
<a name="ln569">      cairo_stroke(cr);</a>
<a name="ln570">  }</a>
<a name="ln571"> </a>
<a name="ln572">  // draw selected cursor</a>
<a name="ln573">  cairo_translate(cr, 0, height);</a>
<a name="ln574"> </a>
<a name="ln575">  // cairo_set_operator(cr, CAIRO_OPERATOR_ADD);</a>
<a name="ln576">  // cairo_set_operator(cr, CAIRO_OPERATOR_OVER);</a>
<a name="ln577">  cairo_set_line_width(cr, DT_PIXEL_APPLY_DPI(2.));</a>
<a name="ln578">  cairo_set_source_rgba(cr, .7, .7, .7, 1.0);</a>
<a name="ln579"> </a>
<a name="ln580">  p = *(dt_iop_lowlight_params_t *)self-&gt;params;</a>
<a name="ln581">  dt_draw_curve_set_point(c-&gt;transition_curve, 0, p.transition_x[DT_IOP_LOWLIGHT_BANDS - 2] - 1.0,</a>
<a name="ln582">                          p.transition_y[0]);</a>
<a name="ln583">  for(int k = 0; k &lt; DT_IOP_LOWLIGHT_BANDS; k++)</a>
<a name="ln584">    dt_draw_curve_set_point(c-&gt;transition_curve, k + 1, p.transition_x[k], p.transition_y[k]);</a>
<a name="ln585">  dt_draw_curve_set_point(c-&gt;transition_curve, DT_IOP_LOWLIGHT_BANDS + 1, p.transition_x[1] + 1.0,</a>
<a name="ln586">                          p.transition_y[DT_IOP_LOWLIGHT_BANDS - 1]);</a>
<a name="ln587">  dt_draw_curve_calc_values(c-&gt;transition_curve, 0.0, 1.0, DT_IOP_LOWLIGHT_RES, c-&gt;draw_xs, c-&gt;draw_ys);</a>
<a name="ln588">  cairo_move_to(cr, 0 * width / (float)(DT_IOP_LOWLIGHT_RES - 1), -height * c-&gt;draw_ys[0]);</a>
<a name="ln589">  for(int k = 1; k &lt; DT_IOP_LOWLIGHT_RES; k++)</a>
<a name="ln590">    cairo_line_to(cr, k * width / (float)(DT_IOP_LOWLIGHT_RES - 1), -height * c-&gt;draw_ys[k]);</a>
<a name="ln591">  cairo_stroke(cr);</a>
<a name="ln592"> </a>
<a name="ln593">  // draw dots on knots</a>
<a name="ln594">  cairo_set_source_rgb(cr, 0.7, 0.7, 0.7);</a>
<a name="ln595">  cairo_set_line_width(cr, DT_PIXEL_APPLY_DPI(1.));</a>
<a name="ln596">  for(int k = 0; k &lt; DT_IOP_LOWLIGHT_BANDS; k++)</a>
<a name="ln597">  {</a>
<a name="ln598">    cairo_arc(cr, width * p.transition_x[k], -height * p.transition_y[k], DT_PIXEL_APPLY_DPI(3.0), 0.0,</a>
<a name="ln599">              2.0 * M_PI);</a>
<a name="ln600">    if(c-&gt;x_move == k)</a>
<a name="ln601">      cairo_fill(cr);</a>
<a name="ln602">    else</a>
<a name="ln603">      cairo_stroke(cr);</a>
<a name="ln604">  }</a>
<a name="ln605"> </a>
<a name="ln606">  if(c-&gt;mouse_y &gt; 0 || c-&gt;dragging)</a>
<a name="ln607">  {</a>
<a name="ln608">    // draw min/max, if selected</a>
<a name="ln609">    cairo_set_source_rgba(cr, .7, .7, .7, .6);</a>
<a name="ln610">    cairo_move_to(cr, 0, -height * c-&gt;draw_min_ys[0]);</a>
<a name="ln611">    for(int k = 1; k &lt; DT_IOP_LOWLIGHT_RES; k++)</a>
<a name="ln612">      cairo_line_to(cr, k * width / (float)(DT_IOP_LOWLIGHT_RES - 1), -height * c-&gt;draw_min_ys[k]);</a>
<a name="ln613">    for(int k = DT_IOP_LOWLIGHT_RES - 1; k &gt;= 0; k--)</a>
<a name="ln614">      cairo_line_to(cr, k * width / (float)(DT_IOP_LOWLIGHT_RES - 1), -height * c-&gt;draw_max_ys[k]);</a>
<a name="ln615">    cairo_close_path(cr);</a>
<a name="ln616">    cairo_fill(cr);</a>
<a name="ln617">    // draw mouse focus circle</a>
<a name="ln618">    cairo_set_source_rgba(cr, .9, .9, .9, .5);</a>
<a name="ln619">    const float pos = DT_IOP_LOWLIGHT_RES * c-&gt;mouse_x;</a>
<a name="ln620">    int k = (int)pos;</a>
<a name="ln621">    const float f = k - pos;</a>
<a name="ln622">    if(k &gt;= DT_IOP_LOWLIGHT_RES - 1) k = DT_IOP_LOWLIGHT_RES - 2;</a>
<a name="ln623">    float ht = -height * (f * c-&gt;draw_ys[k] + (1 - f) * c-&gt;draw_ys[k + 1]);</a>
<a name="ln624">    cairo_arc(cr, c-&gt;mouse_x * width, ht, c-&gt;mouse_radius * width, 0, 2. * M_PI);</a>
<a name="ln625">    cairo_stroke(cr);</a>
<a name="ln626">  }</a>
<a name="ln627"> </a>
<a name="ln628">  cairo_restore(cr);</a>
<a name="ln629"> </a>
<a name="ln630">  cairo_set_operator(cr, CAIRO_OPERATOR_SOURCE);</a>
<a name="ln631"> </a>
<a name="ln632">  // draw labels:</a>
<a name="ln633">  PangoLayout *layout;</a>
<a name="ln634">  PangoRectangle ink;</a>
<a name="ln635">  PangoFontDescription *desc = pango_font_description_copy_static(darktable.bauhaus-&gt;pango_font_desc);</a>
<a name="ln636">  pango_font_description_set_weight(desc, PANGO_WEIGHT_BOLD);</a>
<a name="ln637">  pango_font_description_set_absolute_size(desc,(.06 * height) * PANGO_SCALE);</a>
<a name="ln638">  layout = pango_cairo_create_layout(cr);</a>
<a name="ln639">  pango_layout_set_font_description(layout, desc);</a>
<a name="ln640">  cairo_set_source_rgb(cr, .1, .1, .1);</a>
<a name="ln641"> </a>
<a name="ln642">  pango_layout_set_text(layout, _(&quot;dark&quot;), -1);</a>
<a name="ln643">  pango_layout_get_pixel_extents(layout, &amp;ink, NULL);</a>
<a name="ln644">  cairo_move_to(cr, .02 * width - ink.y, .5 * (height + ink.width));</a>
<a name="ln645">  cairo_save(cr);</a>
<a name="ln646">  cairo_rotate(cr, -M_PI * .5f);</a>
<a name="ln647">  pango_cairo_show_layout(cr, layout);</a>
<a name="ln648">  cairo_restore(cr);</a>
<a name="ln649"> </a>
<a name="ln650">  pango_layout_set_text(layout, _(&quot;bright&quot;), -1);</a>
<a name="ln651">  pango_layout_get_pixel_extents(layout, &amp;ink, NULL);</a>
<a name="ln652">  cairo_move_to(cr, .98 * width - ink.height, .5 * (height + ink.width));</a>
<a name="ln653">  cairo_save(cr);</a>
<a name="ln654">  cairo_rotate(cr, -M_PI * .5f);</a>
<a name="ln655">  pango_cairo_show_layout(cr, layout);</a>
<a name="ln656">  cairo_restore(cr);</a>
<a name="ln657"> </a>
<a name="ln658"> </a>
<a name="ln659">  pango_layout_set_text(layout, _(&quot;day vision&quot;), -1);</a>
<a name="ln660">  pango_layout_get_pixel_extents(layout, &amp;ink, NULL);</a>
<a name="ln661">  cairo_move_to(cr, .5 * (width - ink.width), .08 * height - ink.height);</a>
<a name="ln662">  pango_cairo_show_layout(cr, layout);</a>
<a name="ln663"> </a>
<a name="ln664">  pango_layout_set_text(layout, _(&quot;night vision&quot;), -1);</a>
<a name="ln665">  pango_layout_get_pixel_extents(layout, &amp;ink, NULL);</a>
<a name="ln666">  cairo_move_to(cr, .5 * (width - ink.width), .97 * height - ink.height);</a>
<a name="ln667">  pango_cairo_show_layout(cr, layout);</a>
<a name="ln668"> </a>
<a name="ln669">  pango_font_description_free(desc);</a>
<a name="ln670">  g_object_unref(layout);</a>
<a name="ln671">  cairo_destroy(cr);</a>
<a name="ln672">  cairo_set_source_surface(crf, cst, 0, 0);</a>
<a name="ln673">  cairo_paint(crf);</a>
<a name="ln674">  cairo_surface_destroy(cst);</a>
<a name="ln675">  return TRUE;</a>
<a name="ln676">}</a>
<a name="ln677"> </a>
<a name="ln678">static gboolean lowlight_motion_notify(GtkWidget *widget, GdkEventMotion *event, gpointer user_data)</a>
<a name="ln679">{</a>
<a name="ln680">  dt_iop_module_t *self = (dt_iop_module_t *)user_data;</a>
<a name="ln681">  dt_iop_lowlight_gui_data_t *c = (dt_iop_lowlight_gui_data_t *)self-&gt;gui_data;</a>
<a name="ln682">  dt_iop_lowlight_params_t *p = (dt_iop_lowlight_params_t *)self-&gt;params;</a>
<a name="ln683">  const int inset = DT_IOP_LOWLIGHT_INSET;</a>
<a name="ln684">  GtkAllocation allocation;</a>
<a name="ln685">  gtk_widget_get_allocation(widget, &amp;allocation);</a>
<a name="ln686">  int height = allocation.height - 2 * inset, width = allocation.width - 2 * inset;</a>
<a name="ln687">  if(!c-&gt;dragging) c-&gt;mouse_x = CLAMP(event-&gt;x - inset, 0, width) / (float)width;</a>
<a name="ln688">  c-&gt;mouse_y = 1.0 - CLAMP(event-&gt;y - inset, 0, height) / (float)height;</a>
<a name="ln689">  if(c-&gt;dragging)</a>
<a name="ln690">  {</a>
<a name="ln691">    *p = c-&gt;drag_params;</a>
<a name="ln692">    if(c-&gt;x_move &gt;= 0)</a>
<a name="ln693">    {</a>
<a name="ln694">      const float mx = CLAMP(event-&gt;x - inset, 0, width) / (float)width;</a>
<a name="ln695">      if(c-&gt;x_move &gt; 0 &amp;&amp; c-&gt;x_move &lt; DT_IOP_LOWLIGHT_BANDS - 1)</a>
<a name="ln696">      {</a>
<a name="ln697">        const float minx = p-&gt;transition_x[c-&gt;x_move - 1] + 0.001f;</a>
<a name="ln698">        const float maxx = p-&gt;transition_x[c-&gt;x_move + 1] - 0.001f;</a>
<a name="ln699">        p-&gt;transition_x[c-&gt;x_move] = fminf(maxx, fmaxf(minx, mx));</a>
<a name="ln700">      }</a>
<a name="ln701">    }</a>
<a name="ln702">    else</a>
<a name="ln703">    {</a>
<a name="ln704">      dt_iop_lowlight_get_params(p, c-&gt;mouse_x, c-&gt;mouse_y + c-&gt;mouse_pick, c-&gt;mouse_radius);</a>
<a name="ln705">    }</a>
<a name="ln706">    dt_dev_add_history_item(darktable.develop, self, TRUE);</a>
<a name="ln707">  }</a>
<a name="ln708">  else if(event-&gt;y &gt; height)</a>
<a name="ln709">  {</a>
<a name="ln710">    c-&gt;x_move = 0;</a>
<a name="ln711">    float dist = fabs(p-&gt;transition_x[0] - c-&gt;mouse_x);</a>
<a name="ln712">    for(int k = 1; k &lt; DT_IOP_LOWLIGHT_BANDS; k++)</a>
<a name="ln713">    {</a>
<a name="ln714">      float d2 = fabs(p-&gt;transition_x[k] - c-&gt;mouse_x);</a>
<a name="ln715">      if(d2 &lt; dist)</a>
<a name="ln716">      {</a>
<a name="ln717">        c-&gt;x_move = k;</a>
<a name="ln718">        dist = d2;</a>
<a name="ln719">      }</a>
<a name="ln720">    }</a>
<a name="ln721">  }</a>
<a name="ln722">  else</a>
<a name="ln723">  {</a>
<a name="ln724">    c-&gt;x_move = -1;</a>
<a name="ln725">  }</a>
<a name="ln726">  gtk_widget_queue_draw(widget);</a>
<a name="ln727">  gint x, y;</a>
<a name="ln728">#if GTK_CHECK_VERSION(3, 20, 0)</a>
<a name="ln729">  gdk_window_get_device_position(event-&gt;window,</a>
<a name="ln730">      gdk_seat_get_pointer(gdk_display_get_default_seat(</a>
<a name="ln731">          gdk_window_get_display(event-&gt;window))),</a>
<a name="ln732">      &amp;x, &amp;y, 0);</a>
<a name="ln733">#else</a>
<a name="ln734">  gdk_window_get_device_position(event-&gt;window,</a>
<a name="ln735">                                 gdk_device_manager_get_client_pointer(</a>
<a name="ln736">                                     gdk_display_get_device_manager(gdk_window_get_display(event-&gt;window))),</a>
<a name="ln737">                                 &amp;x, &amp;y, NULL);</a>
<a name="ln738">#endif</a>
<a name="ln739">  return TRUE;</a>
<a name="ln740">}</a>
<a name="ln741"> </a>
<a name="ln742">static gboolean lowlight_button_press(GtkWidget *widget, GdkEventButton *event, gpointer user_data)</a>
<a name="ln743">{</a>
<a name="ln744">  dt_iop_module_t *self = (dt_iop_module_t *)user_data;</a>
<a name="ln745">  if(event-&gt;button == 1 &amp;&amp; event-&gt;type == GDK_2BUTTON_PRESS)</a>
<a name="ln746">  {</a>
<a name="ln747">    // reset current curve</a>
<a name="ln748">    dt_iop_lowlight_params_t *p = (dt_iop_lowlight_params_t *)self-&gt;params;</a>
<a name="ln749">    dt_iop_lowlight_params_t *d = (dt_iop_lowlight_params_t *)self-&gt;default_params;</a>
<a name="ln750">    /*   dt_iop_lowlight_gui_data_t *c = (dt_iop_lowlight_gui_data_t *)self-&gt;gui_data; */</a>
<a name="ln751">    for(int k = 0; k &lt; DT_IOP_LOWLIGHT_BANDS; k++)</a>
<a name="ln752">    {</a>
<a name="ln753">      p-&gt;transition_x[k] = d-&gt;transition_x[k];</a>
<a name="ln754">      p-&gt;transition_y[k] = d-&gt;transition_y[k];</a>
<a name="ln755">    }</a>
<a name="ln756">    dt_dev_add_history_item(darktable.develop, self, TRUE);</a>
<a name="ln757">    gtk_widget_queue_draw(self-&gt;widget);</a>
<a name="ln758">  }</a>
<a name="ln759">  else if(event-&gt;button == 1)</a>
<a name="ln760">  {</a>
<a name="ln761">    dt_iop_lowlight_gui_data_t *c = (dt_iop_lowlight_gui_data_t *)self-&gt;gui_data;</a>
<a name="ln762">    c-&gt;drag_params = *(dt_iop_lowlight_params_t *)self-&gt;params;</a>
<a name="ln763">    const int inset = DT_IOP_LOWLIGHT_INSET;</a>
<a name="ln764">    GtkAllocation allocation;</a>
<a name="ln765">    gtk_widget_get_allocation(widget, &amp;allocation);</a>
<a name="ln766">    int height = allocation.height - 2 * inset, width = allocation.width - 2 * inset;</a>
<a name="ln767">    c-&gt;mouse_pick</a>
<a name="ln768">        = dt_draw_curve_calc_value(c-&gt;transition_curve, CLAMP(event-&gt;x - inset, 0, width) / (float)width);</a>
<a name="ln769">    c-&gt;mouse_pick -= 1.0 - CLAMP(event-&gt;y - inset, 0, height) / (float)height;</a>
<a name="ln770">    c-&gt;dragging = 1;</a>
<a name="ln771">    return TRUE;</a>
<a name="ln772">  }</a>
<a name="ln773">  return FALSE;</a>
<a name="ln774">}</a>
<a name="ln775"> </a>
<a name="ln776">static gboolean lowlight_button_release(GtkWidget *widget, GdkEventButton *event, gpointer user_data)</a>
<a name="ln777">{</a>
<a name="ln778">  if(event-&gt;button == 1)</a>
<a name="ln779">  {</a>
<a name="ln780">    dt_iop_module_t *self = (dt_iop_module_t *)user_data;</a>
<a name="ln781">    dt_iop_lowlight_gui_data_t *c = (dt_iop_lowlight_gui_data_t *)self-&gt;gui_data;</a>
<a name="ln782">    c-&gt;dragging = 0;</a>
<a name="ln783">    return TRUE;</a>
<a name="ln784">  }</a>
<a name="ln785">  return FALSE;</a>
<a name="ln786">}</a>
<a name="ln787"> </a>
<a name="ln788">static gboolean lowlight_leave_notify(GtkWidget *widget, GdkEventCrossing *event, gpointer user_data)</a>
<a name="ln789">{</a>
<a name="ln790">  dt_iop_module_t *self = (dt_iop_module_t *)user_data;</a>
<a name="ln791">  dt_iop_lowlight_gui_data_t *c = (dt_iop_lowlight_gui_data_t *)self-&gt;gui_data;</a>
<a name="ln792">  if(!c-&gt;dragging) c-&gt;mouse_y = -1.0;</a>
<a name="ln793">  gtk_widget_queue_draw(widget);</a>
<a name="ln794">  return TRUE;</a>
<a name="ln795">}</a>
<a name="ln796"> </a>
<a name="ln797">static gboolean lowlight_scrolled(GtkWidget *widget, GdkEventScroll *event, gpointer user_data)</a>
<a name="ln798">{</a>
<a name="ln799">  dt_iop_module_t *self = (dt_iop_module_t *)user_data;</a>
<a name="ln800">  dt_iop_lowlight_gui_data_t *c = (dt_iop_lowlight_gui_data_t *)self-&gt;gui_data;</a>
<a name="ln801"> </a>
<a name="ln802">  gdouble delta_y;</a>
<a name="ln803">  if(dt_gui_get_scroll_deltas(event, NULL, &amp;delta_y))</a>
<a name="ln804">  {</a>
<a name="ln805">    c-&gt;mouse_radius = CLAMP(c-&gt;mouse_radius * (1.0 + 0.1 * delta_y), 0.2 / DT_IOP_LOWLIGHT_BANDS, 1.0);</a>
<a name="ln806">    gtk_widget_queue_draw(widget);</a>
<a name="ln807">  }</a>
<a name="ln808"> </a>
<a name="ln809">  return TRUE;</a>
<a name="ln810">}</a>
<a name="ln811"> </a>
<a name="ln812">static void blueness_callback(GtkWidget *slider, gpointer user_data)</a>
<a name="ln813">{</a>
<a name="ln814">  dt_iop_module_t *self = (dt_iop_module_t *)user_data;</a>
<a name="ln815">  if(self-&gt;dt-&gt;gui-&gt;reset) return;</a>
<a name="ln816">  dt_iop_lowlight_params_t *p = (dt_iop_lowlight_params_t *)self-&gt;params;</a>
<a name="ln817">  p-&gt;blueness = dt_bauhaus_slider_get(slider);</a>
<a name="ln818">  dt_dev_add_history_item(darktable.develop, self, TRUE);</a>
<a name="ln819">}</a>
<a name="ln820"> </a>
<a name="ln821">void gui_init(struct dt_iop_module_t *self)</a>
<a name="ln822">{</a>
<a name="ln823">  self-&gt;gui_data = malloc(sizeof(dt_iop_lowlight_gui_data_t));</a>
<a name="ln824">  dt_iop_lowlight_gui_data_t *c = (dt_iop_lowlight_gui_data_t *)self-&gt;gui_data;</a>
<a name="ln825">  dt_iop_lowlight_params_t *p = (dt_iop_lowlight_params_t *)self-&gt;params;</a>
<a name="ln826"> </a>
<a name="ln827">  c-&gt;transition_curve = dt_draw_curve_new(0.0, 1.0, CATMULL_ROM);</a>
<a name="ln828">  (void)dt_draw_curve_add_point(c-&gt;transition_curve, p-&gt;transition_x[DT_IOP_LOWLIGHT_BANDS - 2] - 1.0,</a>
<a name="ln829">                                p-&gt;transition_y[DT_IOP_LOWLIGHT_BANDS - 2]);</a>
<a name="ln830">  for(int k = 0; k &lt; DT_IOP_LOWLIGHT_BANDS; k++)</a>
<a name="ln831">    (void)dt_draw_curve_add_point(c-&gt;transition_curve, p-&gt;transition_x[k], p-&gt;transition_y[k]);</a>
<a name="ln832">  (void)dt_draw_curve_add_point(c-&gt;transition_curve, p-&gt;transition_x[1] + 1.0, p-&gt;transition_y[1]);</a>
<a name="ln833"> </a>
<a name="ln834">  c-&gt;mouse_x = c-&gt;mouse_y = c-&gt;mouse_pick = -1.0;</a>
<a name="ln835">  c-&gt;dragging = 0;</a>
<a name="ln836">  c-&gt;x_move = -1;</a>
<a name="ln837">  c-&gt;mouse_radius = 1.0 / DT_IOP_LOWLIGHT_BANDS;</a>
<a name="ln838"> </a>
<a name="ln839">  self-&gt;widget = gtk_box_new(GTK_ORIENTATION_VERTICAL, DT_BAUHAUS_SPACE);</a>
<a name="ln840">  dt_gui_add_help_link(self-&gt;widget, dt_get_help_url(self-&gt;op));</a>
<a name="ln841"> </a>
<a name="ln842">  c-&gt;area = GTK_DRAWING_AREA(dtgtk_drawing_area_new_with_aspect_ratio(0.75));</a>
<a name="ln843"> </a>
<a name="ln844">  gtk_box_pack_start(GTK_BOX(self-&gt;widget), GTK_WIDGET(c-&gt;area), FALSE, FALSE, 0);</a>
<a name="ln845"> </a>
<a name="ln846">  gtk_widget_add_events(GTK_WIDGET(c-&gt;area), GDK_POINTER_MOTION_MASK | GDK_POINTER_MOTION_HINT_MASK</a>
<a name="ln847">                                             | GDK_BUTTON_PRESS_MASK | GDK_BUTTON_RELEASE_MASK</a>
<a name="ln848">                                             | GDK_LEAVE_NOTIFY_MASK | darktable.gui-&gt;scroll_mask);</a>
<a name="ln849">  g_signal_connect(G_OBJECT(c-&gt;area), &quot;draw&quot;, G_CALLBACK(lowlight_draw), self);</a>
<a name="ln850">  g_signal_connect(G_OBJECT(c-&gt;area), &quot;button-press-event&quot;, G_CALLBACK(lowlight_button_press), self);</a>
<a name="ln851">  g_signal_connect(G_OBJECT(c-&gt;area), &quot;button-release-event&quot;, G_CALLBACK(lowlight_button_release), self);</a>
<a name="ln852">  g_signal_connect(G_OBJECT(c-&gt;area), &quot;motion-notify-event&quot;, G_CALLBACK(lowlight_motion_notify), self);</a>
<a name="ln853">  g_signal_connect(G_OBJECT(c-&gt;area), &quot;leave-notify-event&quot;, G_CALLBACK(lowlight_leave_notify), self);</a>
<a name="ln854">  g_signal_connect(G_OBJECT(c-&gt;area), &quot;scroll-event&quot;, G_CALLBACK(lowlight_scrolled), self);</a>
<a name="ln855"> </a>
<a name="ln856">  c-&gt;scale_blueness = dt_bauhaus_slider_new_with_range(self, 0.0, 100.0, 1.0, p-&gt;blueness, 2);</a>
<a name="ln857">  dt_bauhaus_widget_set_label(c-&gt;scale_blueness, NULL, _(&quot;blue shift&quot;));</a>
<a name="ln858">  dt_bauhaus_slider_set_format(c-&gt;scale_blueness, &quot;%0.2f%%&quot;);</a>
<a name="ln859">  gtk_widget_set_tooltip_text(c-&gt;scale_blueness, _(&quot;blueness in shadows&quot;));</a>
<a name="ln860"> </a>
<a name="ln861">  gtk_box_pack_start(GTK_BOX(self-&gt;widget), GTK_WIDGET(c-&gt;scale_blueness), TRUE, TRUE, 5);</a>
<a name="ln862"> </a>
<a name="ln863">  g_signal_connect(G_OBJECT(c-&gt;scale_blueness), &quot;value-changed&quot;, G_CALLBACK(blueness_callback), self);</a>
<a name="ln864">}</a>
<a name="ln865"> </a>
<a name="ln866">void gui_cleanup(struct dt_iop_module_t *self)</a>
<a name="ln867">{</a>
<a name="ln868">  dt_iop_lowlight_gui_data_t *c = (dt_iop_lowlight_gui_data_t *)self-&gt;gui_data;</a>
<a name="ln869">  dt_draw_curve_destroy(c-&gt;transition_curve);</a>
<a name="ln870">  free(self-&gt;gui_data);</a>
<a name="ln871">  self-&gt;gui_data = NULL;</a>
<a name="ln872">}</a>
<a name="ln873"> </a>
<a name="ln874">// modelines: These editor modelines have been set for all relevant files by tools/update_modelines.sh</a>
<a name="ln875">// vim: shiftwidth=2 expandtab tabstop=2 cindent</a>
<a name="ln876">// kate: tab-indents: off; indent-width 2; replace-tabs on; indent-mode cstyle; remove-trailing-spaces modified;</a>

</code></pre>
<div class="balloon" rel="233"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v522/" target="_blank">V522</a> There might be dereferencing of a potential null pointer 'gd'. Check lines: 233, 231.</p></div>
<div class="balloon" rel="265"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v522/" target="_blank">V522</a> There might be dereferencing of a potential null pointer 'd'. Check lines: 265, 262.</p></div>
<div class="balloon" rel="302"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v575/" target="_blank">V575</a> The potential null pointer is passed into 'memcpy' function. Inspect the first argument. Check lines: 302, 293.</p></div>
<div class="balloon" rel="303"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v575/" target="_blank">V575</a> The potential null pointer is passed into 'memcpy' function. Inspect the first argument. Check lines: 303, 294.</p></div>
<div class="balloon" rel="827"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v522/" target="_blank">V522</a> There might be dereferencing of a potential null pointer 'c'. Check lines: 827, 823.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
