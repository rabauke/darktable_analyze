
<html>
<head>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>
<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2">    This file is part of darktable,</a>
<a name="ln3">    copyright (c) 2018 Pascal Obry</a>
<a name="ln4"> </a>
<a name="ln5">    darktable is free software: you can redistribute it and/or modify</a>
<a name="ln6">    it under the terms of the GNU General Public License as published by</a>
<a name="ln7">    the Free Software Foundation, either version 3 of the License, or</a>
<a name="ln8">    (at your option) any later version.</a>
<a name="ln9"> </a>
<a name="ln10">    darktable is distributed in the hope that it will be useful,</a>
<a name="ln11">    but WITHOUT ANY WARRANTY; without even the implied warranty of</a>
<a name="ln12">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</a>
<a name="ln13">    GNU General Public License for more details.</a>
<a name="ln14"> </a>
<a name="ln15">    You should have received a copy of the GNU General Public License</a>
<a name="ln16">    along with darktable.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</a>
<a name="ln17">*/</a>
<a name="ln18"> </a>
<a name="ln19">#include &quot;bauhaus/bauhaus.h&quot;</a>
<a name="ln20">#include &quot;common/darktable.h&quot;</a>
<a name="ln21">#include &quot;common/image.h&quot;</a>
<a name="ln22">#include &quot;common/image_cache.h&quot;</a>
<a name="ln23">#include &quot;common/imageio.h&quot;</a>
<a name="ln24">#include &quot;common/imageio_module.h&quot;</a>
<a name="ln25">#include &quot;common/metadata.h&quot;</a>
<a name="ln26">#include &quot;common/pwstorage/pwstorage.h&quot;</a>
<a name="ln27">#include &quot;common/tags.h&quot;</a>
<a name="ln28">#include &quot;control/conf.h&quot;</a>
<a name="ln29">#include &quot;control/control.h&quot;</a>
<a name="ln30">#include &quot;dtgtk/button.h&quot;</a>
<a name="ln31">#include &quot;gui/gtk.h&quot;</a>
<a name="ln32">#include &quot;imageio/storage/imageio_storage_api.h&quot;</a>
<a name="ln33">#include &lt;curl/curl.h&gt;</a>
<a name="ln34">#include &lt;json-glib/json-glib.h&gt;</a>
<a name="ln35">#include &lt;stdio.h&gt;</a>
<a name="ln36">#include &lt;stdlib.h&gt;</a>
<a name="ln37">#include &lt;unistd.h&gt;</a>
<a name="ln38"> </a>
<a name="ln39">DT_MODULE(1)</a>
<a name="ln40"> </a>
<a name="ln41">// #define piwigo_EXTRA_VERBOSE</a>
<a name="ln42"> </a>
<a name="ln43">#define MAX_ALBUM_NAME_SIZE 100</a>
<a name="ln44"> </a>
<a name="ln45">typedef struct _piwigo_api_context_t</a>
<a name="ln46">{</a>
<a name="ln47">  /// curl context</a>
<a name="ln48">  CURL *curl_ctx;</a>
<a name="ln49">  JsonParser *json_parser;</a>
<a name="ln50">  JsonObject *response;</a>
<a name="ln51">  gboolean authenticated;</a>
<a name="ln52">  gchar *cookie_file;</a>
<a name="ln53">  gchar *url;</a>
<a name="ln54"> </a>
<a name="ln55">  gchar *server;</a>
<a name="ln56">  gchar *username;</a>
<a name="ln57">  gchar *password;</a>
<a name="ln58">  gboolean error_occured;</a>
<a name="ln59">} _piwigo_api_context_t;</a>
<a name="ln60"> </a>
<a name="ln61">typedef struct _piwigo_album_t</a>
<a name="ln62">{</a>
<a name="ln63">  int64_t id;</a>
<a name="ln64">  char name[MAX_ALBUM_NAME_SIZE];</a>
<a name="ln65">  char label[MAX_ALBUM_NAME_SIZE];</a>
<a name="ln66">  int64_t size;</a>
<a name="ln67">} _piwigo_album_t;</a>
<a name="ln68"> </a>
<a name="ln69">typedef struct _piwigo_account_t</a>
<a name="ln70">{</a>
<a name="ln71">  gchar *server;</a>
<a name="ln72">  gchar *username;</a>
<a name="ln73">  gchar *password;</a>
<a name="ln74">} _piwigo_account_t;</a>
<a name="ln75"> </a>
<a name="ln76">typedef struct dt_storage_piwigo_gui_data_t</a>
<a name="ln77">{</a>
<a name="ln78">  GtkLabel *status_label;</a>
<a name="ln79">  GtkEntry *server_entry;</a>
<a name="ln80">  GtkEntry *user_entry, *pwd_entry, *new_album_entry;</a>
<a name="ln81">  GtkBox *create_box;                               // Create album options...</a>
<a name="ln82">  GtkWidget *permission_list, *export_tags;</a>
<a name="ln83">  GtkWidget *album_list, *parent_album_list;</a>
<a name="ln84">  GtkWidget *account_list;</a>
<a name="ln85"> </a>
<a name="ln86">  GList *albums;</a>
<a name="ln87">  GList *accounts;</a>
<a name="ln88"> </a>
<a name="ln89">  /** Current Piwigo context for the gui */</a>
<a name="ln90">  _piwigo_api_context_t *api;</a>
<a name="ln91">} dt_storage_piwigo_gui_data_t;</a>
<a name="ln92"> </a>
<a name="ln93">typedef struct _curl_args_t</a>
<a name="ln94">{</a>
<a name="ln95">  char name[100];</a>
<a name="ln96">  char value[512];</a>
<a name="ln97">} _curl_args_t;</a>
<a name="ln98"> </a>
<a name="ln99">typedef struct dt_storage_piwigo_params_t</a>
<a name="ln100">{</a>
<a name="ln101">  _piwigo_api_context_t *api;</a>
<a name="ln102">  int64_t album_id;</a>
<a name="ln103">  int64_t parent_album_id;</a>
<a name="ln104">  char *album;</a>
<a name="ln105">  gboolean new_album;</a>
<a name="ln106">  int privacy;</a>
<a name="ln107">  gboolean export_tags;</a>
<a name="ln108">  gchar *tags;</a>
<a name="ln109">} dt_storage_piwigo_params_t;</a>
<a name="ln110"> </a>
<a name="ln111">/* low-level routine doing the HTTP POST request */</a>
<a name="ln112">static void _piwigo_api_post(_piwigo_api_context_t *ctx, GList *args, char *filename, gboolean isauth);</a>
<a name="ln113"> </a>
<a name="ln114">static size_t curl_write_data_cb(void *ptr, size_t size, size_t nmemb, void *data)</a>
<a name="ln115">{</a>
<a name="ln116">  GString *string = (GString *)data;</a>
<a name="ln117">  g_string_append_len(string, ptr, size * nmemb);</a>
<a name="ln118">#ifdef piwigo_EXTRA_VERBOSE</a>
<a name="ln119">  g_printf(&quot;server reply: %s\n&quot;, string-&gt;str);</a>
<a name="ln120">#endif</a>
<a name="ln121">  return size * nmemb;</a>
<a name="ln122">}</a>
<a name="ln123"> </a>
<a name="ln124">static GList *_piwigo_query_add_arguments(GList *args, const char *name, const char *value)</a>
<a name="ln125">{</a>
<a name="ln126">  _curl_args_t *arg = malloc(sizeof(_curl_args_t));</a>
<a name="ln127">  g_strlcpy(arg-&gt;name, name, sizeof(arg-&gt;name));</a>
<a name="ln128">  g_strlcpy(arg-&gt;value, value, sizeof(arg-&gt;value));</a>
<a name="ln129">  return g_list_append(args, arg);</a>
<a name="ln130">}</a>
<a name="ln131"> </a>
<a name="ln132">static _piwigo_api_context_t *_piwigo_ctx_init(void)</a>
<a name="ln133">{</a>
<a name="ln134">  _piwigo_api_context_t *ctx = malloc(sizeof(struct _piwigo_api_context_t));</a>
<a name="ln135"> </a>
<a name="ln136">  ctx-&gt;curl_ctx = curl_easy_init();</a>
<a name="ln137">  ctx-&gt;json_parser = json_parser_new();</a>
<a name="ln138">  ctx-&gt;authenticated = FALSE;</a>
<a name="ln139">  ctx-&gt;url = NULL;</a>
<a name="ln140">  ctx-&gt;cookie_file = NULL;</a>
<a name="ln141">  ctx-&gt;error_occured = FALSE;</a>
<a name="ln142">  return ctx;</a>
<a name="ln143">}</a>
<a name="ln144"> </a>
<a name="ln145">static void _piwigo_ctx_destroy(_piwigo_api_context_t **ctx)</a>
<a name="ln146">{</a>
<a name="ln147">  if(*ctx)</a>
<a name="ln148">  {</a>
<a name="ln149">    curl_easy_cleanup((*ctx)-&gt;curl_ctx);</a>
<a name="ln150">    if((*ctx)-&gt;cookie_file) g_unlink((*ctx)-&gt;cookie_file);</a>
<a name="ln151">    g_object_unref((*ctx)-&gt;json_parser);</a>
<a name="ln152">    g_free((*ctx)-&gt;cookie_file);</a>
<a name="ln153">    g_free((*ctx)-&gt;url);</a>
<a name="ln154">    g_free((*ctx)-&gt;server);</a>
<a name="ln155">    g_free((*ctx)-&gt;username);</a>
<a name="ln156">    g_free((*ctx)-&gt;password);</a>
<a name="ln157">    free(*ctx);</a>
<a name="ln158">    *ctx = NULL;</a>
<a name="ln159">  }</a>
<a name="ln160">}</a>
<a name="ln161"> </a>
<a name="ln162">static void _piwigo_free_account(void *data)</a>
<a name="ln163">{</a>
<a name="ln164">  _piwigo_account_t *account = (_piwigo_account_t *)data;</a>
<a name="ln165">  g_free(account-&gt;server);</a>
<a name="ln166">  g_free(account-&gt;username);</a>
<a name="ln167">  g_free(account-&gt;password);</a>
<a name="ln168">}</a>
<a name="ln169"> </a>
<a name="ln170">static void _piwigo_load_account(dt_storage_piwigo_gui_data_t *ui)</a>
<a name="ln171">{</a>
<a name="ln172">  if(!ui-&gt;accounts)</a>
<a name="ln173">  {</a>
<a name="ln174">    g_list_free_full(ui-&gt;accounts, _piwigo_free_account);</a>
<a name="ln175">    ui-&gt;accounts = NULL;</a>
<a name="ln176">  }</a>
<a name="ln177"> </a>
<a name="ln178">  GHashTable *table = dt_pwstorage_get(&quot;piwigo&quot;);</a>
<a name="ln179">  GHashTableIter iter;</a>
<a name="ln180">  gpointer key, value;</a>
<a name="ln181"> </a>
<a name="ln182">  g_hash_table_iter_init (&amp;iter, table);</a>
<a name="ln183"> </a>
<a name="ln184">  while (g_hash_table_iter_next (&amp;iter, &amp;key, &amp;value))</a>
<a name="ln185">  {</a>
<a name="ln186">    if(key &amp;&amp; value)</a>
<a name="ln187">    {</a>
<a name="ln188">      gchar *data = (gchar *)value;</a>
<a name="ln189">      JsonParser *parser = json_parser_new();</a>
<a name="ln190">      json_parser_load_from_data(parser, data, strlen(data), NULL);</a>
<a name="ln191">      JsonNode *root = json_parser_get_root(parser);</a>
<a name="ln192"> </a>
<a name="ln193">      if(root)</a>
<a name="ln194">      {</a>
<a name="ln195">        JsonObject *obj = json_node_get_object(root);</a>
<a name="ln196">        _piwigo_account_t *account = malloc(sizeof(_piwigo_account_t));</a>
<a name="ln197"> </a>
<a name="ln198">        account-&gt;server =  g_strdup(json_object_get_string_member(obj, &quot;server&quot;));</a>
<a name="ln199">        account-&gt;username =  g_strdup(json_object_get_string_member(obj, &quot;username&quot;));</a>
<a name="ln200">        account-&gt;password =  g_strdup(json_object_get_string_member(obj, &quot;password&quot;));</a>
<a name="ln201"> </a>
<a name="ln202">        if(account-&gt;server &amp;&amp; strlen(account-&gt;server)&gt;0)</a>
<a name="ln203">          ui-&gt;accounts = g_list_append(ui-&gt;accounts, account);</a>
<a name="ln204">      }</a>
<a name="ln205"> </a>
<a name="ln206">      g_object_unref(parser);</a>
<a name="ln207">    }</a>
<a name="ln208">  }</a>
<a name="ln209"> </a>
<a name="ln210">  g_hash_table_destroy(table);</a>
<a name="ln211">}</a>
<a name="ln212"> </a>
<a name="ln213">static _piwigo_account_t *_piwigo_get_account(dt_storage_piwigo_gui_data_t *ui, const gchar *server)</a>
<a name="ln214">{</a>
<a name="ln215">  if(!server) return NULL;</a>
<a name="ln216"> </a>
<a name="ln217">  GList *a = ui-&gt;accounts;</a>
<a name="ln218"> </a>
<a name="ln219">  while(a)</a>
<a name="ln220">  {</a>
<a name="ln221">    _piwigo_account_t *account = (_piwigo_account_t *)a-&gt;data;;</a>
<a name="ln222">    if(account-&gt;server &amp;&amp; !strcmp(server, account-&gt;server)) return account;</a>
<a name="ln223">    a = g_list_next(a);</a>
<a name="ln224">  }</a>
<a name="ln225"> </a>
<a name="ln226">  return NULL;</a>
<a name="ln227">}</a>
<a name="ln228"> </a>
<a name="ln229">static void _piwigo_set_account(dt_storage_piwigo_gui_data_t *ui)</a>
<a name="ln230">{</a>
<a name="ln231">  /// serialize data;</a>
<a name="ln232">  JsonBuilder *builder = json_builder_new();</a>
<a name="ln233">  json_builder_begin_object(builder);</a>
<a name="ln234">  json_builder_set_member_name(builder, &quot;server&quot;);</a>
<a name="ln235">  json_builder_add_string_value(builder, gtk_entry_get_text(ui-&gt;server_entry));</a>
<a name="ln236">  json_builder_set_member_name(builder, &quot;username&quot;);</a>
<a name="ln237">  json_builder_add_string_value(builder, gtk_entry_get_text(ui-&gt;user_entry));</a>
<a name="ln238">  json_builder_set_member_name(builder, &quot;password&quot;);</a>
<a name="ln239">  json_builder_add_string_value(builder, gtk_entry_get_text(ui-&gt;pwd_entry));</a>
<a name="ln240"> </a>
<a name="ln241">  json_builder_end_object(builder);</a>
<a name="ln242"> </a>
<a name="ln243">  JsonNode *node = json_builder_get_root(builder);</a>
<a name="ln244">  JsonGenerator *generator = json_generator_new();</a>
<a name="ln245">  json_generator_set_root(generator, node);</a>
<a name="ln246">#if JSON_CHECK_VERSION(0, 14, 0)</a>
<a name="ln247">  json_generator_set_pretty(generator, FALSE);</a>
<a name="ln248">#endif</a>
<a name="ln249">  gchar *data = json_generator_to_data(generator, NULL);</a>
<a name="ln250"> </a>
<a name="ln251">  json_node_free(node);</a>
<a name="ln252">  g_object_unref(generator);</a>
<a name="ln253">  g_object_unref(builder);</a>
<a name="ln254"> </a>
<a name="ln255">  GHashTable *table = dt_pwstorage_get(&quot;piwigo&quot;);</a>
<a name="ln256">  g_hash_table_insert(table, g_strdup(gtk_entry_get_text(ui-&gt;server_entry)), data);</a>
<a name="ln257">  dt_pwstorage_set(&quot;piwigo&quot;, table);</a>
<a name="ln258">  g_hash_table_destroy(table);</a>
<a name="ln259">}</a>
<a name="ln260"> </a>
<a name="ln261">/** Set status connection text */</a>
<a name="ln262">static void _piwigo_set_status(dt_storage_piwigo_gui_data_t *ui, gchar *message, gchar *color)</a>
<a name="ln263">{</a>
<a name="ln264">  if(!color) color = &quot;#ffffff&quot;;</a>
<a name="ln265">  gchar mup[512] = { 0 };</a>
<a name="ln266">  snprintf(mup, sizeof(mup), &quot;&lt;span foreground=\&quot;%s\&quot; &gt;&lt;small&gt;%s&lt;/small&gt;&lt;/span&gt;&quot;, color, message);</a>
<a name="ln267">  gtk_label_set_markup(ui-&gt;status_label, mup);</a>
<a name="ln268">}</a>
<a name="ln269"> </a>
<a name="ln270">static int _piwigo_api_post_internal(_piwigo_api_context_t *ctx, GList *args, char *filename, gboolean isauth)</a>
<a name="ln271">{</a>
<a name="ln272">  curl_mime *form = NULL;</a>
<a name="ln273"> </a>
<a name="ln274">  GString *url = g_string_new(ctx-&gt;url);</a>
<a name="ln275"> </a>
<a name="ln276">  // send the requests</a>
<a name="ln277">  GString *response = g_string_new(&quot;&quot;);</a>
<a name="ln278"> </a>
<a name="ln279">  curl_easy_reset(ctx-&gt;curl_ctx);</a>
<a name="ln280">  curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_URL, url-&gt;str);</a>
<a name="ln281">  curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_POST, 1);</a>
<a name="ln282">#ifdef piwigo_EXTRA_VERBOSE</a>
<a name="ln283">  curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_VERBOSE, 2);</a>
<a name="ln284">#endif</a>
<a name="ln285">  curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_SSL_VERIFYPEER, FALSE);</a>
<a name="ln286">  curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_WRITEFUNCTION, curl_write_data_cb);</a>
<a name="ln287">  curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_WRITEDATA, response);</a>
<a name="ln288"> </a>
<a name="ln289">  if(isauth)</a>
<a name="ln290">  {</a>
<a name="ln291">    /* construct a temporary file name */</a>
<a name="ln292">    char cookie_fmt[PATH_MAX] = { 0 };</a>
<a name="ln293">    dt_loc_get_tmp_dir(cookie_fmt, sizeof(cookie_fmt));</a>
<a name="ln294">    g_strlcat(cookie_fmt, &quot;/cookies.%.4lf.txt&quot;, sizeof(cookie_fmt));</a>
<a name="ln295"> </a>
<a name="ln296">    ctx-&gt;cookie_file = g_strdup_printf(cookie_fmt, dt_get_wtime());</a>
<a name="ln297"> </a>
<a name="ln298">    // not that this is safe as the cookie file is written only when the curl context is finalized.</a>
<a name="ln299">    // At this stage we unlink the file.</a>
<a name="ln300">    curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_COOKIEJAR, ctx-&gt;cookie_file);</a>
<a name="ln301">  }</a>
<a name="ln302">  else</a>
<a name="ln303">  {</a>
<a name="ln304">    curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_COOKIEFILE, ctx-&gt;cookie_file);</a>
<a name="ln305">  }</a>
<a name="ln306"> </a>
<a name="ln307">  if(filename)</a>
<a name="ln308">  {</a>
<a name="ln309">    curl_mimepart *field = NULL;</a>
<a name="ln310"> </a>
<a name="ln311">    form = curl_mime_init(ctx-&gt;curl_ctx);</a>
<a name="ln312"> </a>
<a name="ln313">    GList *a = args;</a>
<a name="ln314"> </a>
<a name="ln315">    while (a)</a>
<a name="ln316">    {</a>
<a name="ln317">      _curl_args_t *ca = (_curl_args_t *)a-&gt;data;</a>
<a name="ln318">      field = curl_mime_addpart(form);</a>
<a name="ln319">      curl_mime_name(field, ca-&gt;name);</a>
<a name="ln320">      curl_mime_data(field, ca-&gt;value, CURL_ZERO_TERMINATED);</a>
<a name="ln321">      a = g_list_next(a);</a>
<a name="ln322">    }</a>
<a name="ln323"> </a>
<a name="ln324">    field = curl_mime_addpart(form);</a>
<a name="ln325">    curl_mime_name(field, &quot;image&quot;);</a>
<a name="ln326">    curl_mime_filedata(field, filename);</a>
<a name="ln327"> </a>
<a name="ln328">    curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_MIMEPOST, form);</a>
<a name="ln329">  }</a>
<a name="ln330">  else</a>
<a name="ln331">  {</a>
<a name="ln332">    GString *gargs = g_string_new(&quot;&quot;);</a>
<a name="ln333"> </a>
<a name="ln334">    GList *a = args;</a>
<a name="ln335"> </a>
<a name="ln336">    while (a)</a>
<a name="ln337">    {</a>
<a name="ln338">      _curl_args_t *ca = (_curl_args_t *)a-&gt;data;</a>
<a name="ln339">      if(a!=args) g_string_append(gargs, &quot;&amp;&quot;);</a>
<a name="ln340">      g_string_append(gargs, ca-&gt;name);</a>
<a name="ln341">      g_string_append(gargs, &quot;=&quot;);</a>
<a name="ln342">      g_string_append(gargs, ca-&gt;value);</a>
<a name="ln343"> </a>
<a name="ln344">      a = g_list_next(a);</a>
<a name="ln345">    }</a>
<a name="ln346"> </a>
<a name="ln347">    curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_COPYPOSTFIELDS, gargs-&gt;str);</a>
<a name="ln348">    g_string_free(gargs, TRUE);</a>
<a name="ln349">  }</a>
<a name="ln350"> </a>
<a name="ln351">  int res = curl_easy_perform(ctx-&gt;curl_ctx);</a>
<a name="ln352"> </a>
<a name="ln353">#ifdef piwigo_EXTRA_VERBOSE</a>
<a name="ln354">  g_printf(&quot;curl_easy_perform status %d\n&quot;, res);</a>
<a name="ln355">#endif</a>
<a name="ln356"> </a>
<a name="ln357">  if(filename) curl_mime_free(form);</a>
<a name="ln358"> </a>
<a name="ln359">  g_string_free(url, TRUE);</a>
<a name="ln360"> </a>
<a name="ln361">  ctx-&gt;response = NULL;</a>
<a name="ln362"> </a>
<a name="ln363">  if(res == CURLE_OK)</a>
<a name="ln364">  {</a>
<a name="ln365">    GError *error = NULL;</a>
<a name="ln366">    gboolean ret = json_parser_load_from_data(ctx-&gt;json_parser, response-&gt;str, response-&gt;len, &amp;error);</a>
<a name="ln367">    if(!ret) goto cleanup;</a>
<a name="ln368">    JsonNode *root = json_parser_get_root(ctx-&gt;json_parser);</a>
<a name="ln369">    // we should always have a dict</a>
<a name="ln370">    if(json_node_get_node_type(root) != JSON_NODE_OBJECT) goto cleanup;</a>
<a name="ln371">    ctx-&gt;response = json_node_get_object(root);</a>
<a name="ln372">    const char *status = json_object_get_string_member(ctx-&gt;response, &quot;stat&quot;);</a>
<a name="ln373">    ctx-&gt;error_occured = (status &amp;&amp; (strcmp(status,&quot;fail&quot;)==0));</a>
<a name="ln374">  }</a>
<a name="ln375">  else</a>
<a name="ln376">    ctx-&gt;error_occured = TRUE;</a>
<a name="ln377"> </a>
<a name="ln378"> cleanup:</a>
<a name="ln379">  g_string_free(response, TRUE);</a>
<a name="ln380">  return res;</a>
<a name="ln381">}</a>
<a name="ln382"> </a>
<a name="ln383">static void _piwigo_api_authenticate(_piwigo_api_context_t *ctx)</a>
<a name="ln384">{</a>
<a name="ln385">  GList *args = NULL;</a>
<a name="ln386"> </a>
<a name="ln387">  args = _piwigo_query_add_arguments(args, &quot;method&quot;, &quot;pwg.session.login&quot;);</a>
<a name="ln388">  args = _piwigo_query_add_arguments(args, &quot;username&quot;, ctx-&gt;username);</a>
<a name="ln389">  args = _piwigo_query_add_arguments(args, &quot;password&quot;, ctx-&gt;password);</a>
<a name="ln390">  if(!strcmp(ctx-&gt;server, &quot;piwigo.com&quot;))</a>
<a name="ln391">    ctx-&gt;url = g_strdup_printf(&quot;https://%s.piwigo.com/ws.php?format=json&quot;, ctx-&gt;username);</a>
<a name="ln392">  else if(strstr(ctx-&gt;server, &quot;http&quot;) == ctx-&gt;server)</a>
<a name="ln393">    ctx-&gt;url = g_strdup_printf(&quot;%s/ws.php?format=json&quot;, ctx-&gt;server);</a>
<a name="ln394">  else</a>
<a name="ln395">    ctx-&gt;url = g_strdup_printf(&quot;https://%s/ws.php?format=json&quot;, ctx-&gt;server);</a>
<a name="ln396"> </a>
<a name="ln397">  _piwigo_api_post(ctx, args, NULL, TRUE);</a>
<a name="ln398"> </a>
<a name="ln399">  g_list_free(args);</a>
<a name="ln400">}</a>
<a name="ln401"> </a>
<a name="ln402">static void _piwigo_api_post(_piwigo_api_context_t *ctx, GList *args, char *filename, gboolean isauth)</a>
<a name="ln403">{</a>
<a name="ln404">  int res = _piwigo_api_post_internal(ctx, args, filename, isauth);</a>
<a name="ln405"> </a>
<a name="ln406">  if(res == CURLE_COULDNT_CONNECT || res == CURLE_SSL_CONNECT_ERROR)</a>
<a name="ln407">  {</a>
<a name="ln408">#ifdef piwigo_EXTRA_VERBOSE</a>
<a name="ln409">    g_printf(&quot;curl post error (%d), try authentication again\n&quot;, res);</a>
<a name="ln410">#endif</a>
<a name="ln411"> </a>
<a name="ln412">    //  recreate a new CURL connection</a>
<a name="ln413">    curl_easy_cleanup(ctx-&gt;curl_ctx);</a>
<a name="ln414">    ctx-&gt;curl_ctx = curl_easy_init();</a>
<a name="ln415">    ctx-&gt;authenticated = FALSE;</a>
<a name="ln416"> </a>
<a name="ln417">    if(!isauth)</a>
<a name="ln418">    {</a>
<a name="ln419">      // an error during the curl post command, could be an authentication issue, try to authenticate again</a>
<a name="ln420">      // but only if this is not an authentication post, otherwise this will happen below anyway.</a>
<a name="ln421">      _piwigo_api_authenticate(ctx);</a>
<a name="ln422">    }</a>
<a name="ln423"> </a>
<a name="ln424">    // authentication ok, send again</a>
<a name="ln425">    if(ctx-&gt;response &amp;&amp; !ctx-&gt;error_occured)</a>
<a name="ln426">    {</a>
<a name="ln427">      ctx-&gt;authenticated = TRUE;</a>
<a name="ln428">#ifdef piwigo_EXTRA_VERBOSE</a>
<a name="ln429">      g_printf(&quot;authenticated again, retry\n&quot;);</a>
<a name="ln430">#endif</a>
<a name="ln431">      res = _piwigo_api_post_internal(ctx, args, filename, isauth);</a>
<a name="ln432">#ifdef piwigo_EXTRA_VERBOSE</a>
<a name="ln433">      g_printf(&quot;second post exit with status %d\n&quot;, res);</a>
<a name="ln434">#endif</a>
<a name="ln435">    }</a>
<a name="ln436">    else</a>
<a name="ln437">    {</a>
<a name="ln438">#ifdef piwigo_EXTRA_VERBOSE</a>
<a name="ln439">      g_printf(&quot;failed second authentication\n&quot;);</a>
<a name="ln440">#endif</a>
<a name="ln441">    }</a>
<a name="ln442">  }</a>
<a name="ln443">}</a>
<a name="ln444"> </a>
<a name="ln445">static void _piwigo_authenticate(dt_storage_piwigo_gui_data_t *ui)</a>
<a name="ln446">{</a>
<a name="ln447">  if(!ui-&gt;api) ui-&gt;api = _piwigo_ctx_init();</a>
<a name="ln448"> </a>
<a name="ln449">  ui-&gt;api-&gt;server = g_strdup(gtk_entry_get_text(ui-&gt;server_entry));</a>
<a name="ln450">  ui-&gt;api-&gt;username = g_strdup(gtk_entry_get_text(ui-&gt;user_entry));</a>
<a name="ln451">  ui-&gt;api-&gt;password = g_strdup(gtk_entry_get_text(ui-&gt;pwd_entry));</a>
<a name="ln452"> </a>
<a name="ln453">  _piwigo_api_authenticate(ui-&gt;api);</a>
<a name="ln454"> </a>
<a name="ln455">  ui-&gt;api-&gt;authenticated = FALSE;</a>
<a name="ln456"> </a>
<a name="ln457">  if(ui-&gt;api-&gt;response &amp;&amp; !ui-&gt;api-&gt;error_occured)</a>
<a name="ln458">  {</a>
<a name="ln459">    ui-&gt;api-&gt;authenticated = TRUE;</a>
<a name="ln460">    gtk_widget_set_sensitive(GTK_WIDGET(ui-&gt;album_list), ui-&gt;api-&gt;authenticated);</a>
<a name="ln461"> </a>
<a name="ln462">    if(ui-&gt;api-&gt;authenticated)</a>
<a name="ln463">    {</a>
<a name="ln464">      _piwigo_set_status(ui, _(&quot;authenticated&quot;), &quot;#7fe07f&quot;);</a>
<a name="ln465">      dt_conf_set_string(&quot;plugins/imageio/storage/export/piwigo/server&quot;, ui-&gt;api-&gt;server);</a>
<a name="ln466">      _piwigo_set_account(ui);</a>
<a name="ln467">    }</a>
<a name="ln468">    else</a>
<a name="ln469">    {</a>
<a name="ln470">      const gchar *errormessage = json_object_get_string_member(ui-&gt;api-&gt;response, &quot;message&quot;);</a>
<a name="ln471">      fprintf(stderr, &quot;[imageio_storage_piwigo] could not authenticate: `%s'!\n&quot;, errormessage);</a>
<a name="ln472">      _piwigo_set_status(ui, _(&quot;not authenticated&quot;), &quot;#e07f7f&quot;);</a>
<a name="ln473">      _piwigo_ctx_destroy(&amp;ui-&gt;api);</a>
<a name="ln474">    }</a>
<a name="ln475">  }</a>
<a name="ln476">  else</a>
<a name="ln477">  {</a>
<a name="ln478">    _piwigo_set_status(ui, _(&quot;not authenticated, cannot reach server&quot;), &quot;#e07f7f&quot;);</a>
<a name="ln479">    _piwigo_ctx_destroy(&amp;ui-&gt;api);</a>
<a name="ln480">  }</a>
<a name="ln481">}</a>
<a name="ln482"> </a>
<a name="ln483">static void _piwigo_entry_changed(GtkEntry *entry, gpointer data)</a>
<a name="ln484">{</a>
<a name="ln485">  dt_storage_piwigo_gui_data_t *ui = (dt_storage_piwigo_gui_data_t *)data;</a>
<a name="ln486"> </a>
<a name="ln487">  _piwigo_set_status(ui, _(&quot;not authenticated&quot;), &quot;#e07f7f&quot;);</a>
<a name="ln488">    gtk_widget_set_sensitive(GTK_WIDGET(ui-&gt;album_list), FALSE);</a>
<a name="ln489"> </a>
<a name="ln490">  if(ui-&gt;api) _piwigo_ctx_destroy(&amp;ui-&gt;api);</a>
<a name="ln491">}</a>
<a name="ln492"> </a>
<a name="ln493">static void _piwigo_server_entry_changed(GtkEntry *entry, gpointer data)</a>
<a name="ln494">{</a>
<a name="ln495">  dt_storage_piwigo_gui_data_t *ui = (dt_storage_piwigo_gui_data_t *)data;</a>
<a name="ln496"> </a>
<a name="ln497">  if(ui-&gt;api)</a>
<a name="ln498">  {</a>
<a name="ln499">    _piwigo_set_status(ui, _(&quot;not authenticated&quot;), &quot;#e07f7f&quot;);</a>
<a name="ln500">    _piwigo_ctx_destroy(&amp;ui-&gt;api);</a>
<a name="ln501">    gtk_widget_set_sensitive(GTK_WIDGET(ui-&gt;album_list), FALSE);</a>
<a name="ln502">  }</a>
<a name="ln503">}</a>
<a name="ln504"> </a>
<a name="ln505">static void _piwigo_account_changed(GtkComboBox *cb, gpointer data)</a>
<a name="ln506">{</a>
<a name="ln507">  dt_storage_piwigo_gui_data_t *ui = (dt_storage_piwigo_gui_data_t *)data;</a>
<a name="ln508">  const gchar *value = dt_bauhaus_combobox_get_text(ui-&gt;account_list);</a>
<a name="ln509">  const _piwigo_account_t *account = _piwigo_get_account(ui, value);</a>
<a name="ln510"> </a>
<a name="ln511">  if(account)</a>
<a name="ln512">  {</a>
<a name="ln513">    gtk_entry_set_text(ui-&gt;server_entry, account-&gt;server);</a>
<a name="ln514">    gtk_entry_set_text(ui-&gt;user_entry, account-&gt;username);</a>
<a name="ln515">    gtk_entry_set_text(ui-&gt;pwd_entry, account-&gt;password);</a>
<a name="ln516">  }</a>
<a name="ln517">}</a>
<a name="ln518"> </a>
<a name="ln519">static void _piwigo_album_changed(GtkComboBox *cb, gpointer data)</a>
<a name="ln520">{</a>
<a name="ln521">  dt_storage_piwigo_gui_data_t *ui = (dt_storage_piwigo_gui_data_t *)data;</a>
<a name="ln522">  const gchar *value = dt_bauhaus_combobox_get_text(ui-&gt;album_list);</a>
<a name="ln523"> </a>
<a name="ln524">  if(value != NULL &amp;&amp; strcmp(value, _(&quot;create new album&quot;)) == 0)</a>
<a name="ln525">  {</a>
<a name="ln526">    gtk_widget_set_no_show_all(GTK_WIDGET(ui-&gt;create_box), FALSE);</a>
<a name="ln527">    gtk_widget_show_all(GTK_WIDGET(ui-&gt;create_box));</a>
<a name="ln528">  }</a>
<a name="ln529">  else</a>
<a name="ln530">    gtk_widget_hide(GTK_WIDGET(ui-&gt;create_box));</a>
<a name="ln531">}</a>
<a name="ln532"> </a>
<a name="ln533">/** Refresh albums */</a>
<a name="ln534">static void _piwigo_refresh_albums(dt_storage_piwigo_gui_data_t *ui, const gchar *select_album)</a>
<a name="ln535">{</a>
<a name="ln536">  gtk_widget_set_sensitive(GTK_WIDGET(ui-&gt;album_list), FALSE);</a>
<a name="ln537">  gtk_widget_set_sensitive(GTK_WIDGET(ui-&gt;parent_album_list), FALSE);</a>
<a name="ln538"> </a>
<a name="ln539">  if(ui-&gt;api == NULL || ui-&gt;api-&gt;authenticated == FALSE)</a>
<a name="ln540">  {</a>
<a name="ln541">    _piwigo_authenticate(ui);</a>
<a name="ln542">    if(ui-&gt;api == NULL || !ui-&gt;api-&gt;authenticated) return;</a>
<a name="ln543">  }</a>
<a name="ln544"> </a>
<a name="ln545">  gchar *to_select;</a>
<a name="ln546">  int index = 0;</a>
<a name="ln547"> </a>
<a name="ln548">  // get the new album name, it will be checked in the</a>
<a name="ln549">  if(select_album == NULL)</a>
<a name="ln550">  {</a>
<a name="ln551">    to_select = g_strdup(dt_bauhaus_combobox_get_text(ui-&gt;album_list));</a>
<a name="ln552">    if(to_select)</a>
<a name="ln553">    {</a>
<a name="ln554">      // cut the count of picture in album to get the name only</a>
<a name="ln555">      gchar *p = to_select;</a>
<a name="ln556">      while(*p)</a>
<a name="ln557">      {</a>
<a name="ln558">        if(*p == ' ' &amp;&amp; *(p+1) == '(')</a>
<a name="ln559">        {</a>
<a name="ln560">          *p = '\0';</a>
<a name="ln561">          break;</a>
<a name="ln562">        }</a>
<a name="ln563">        p++;</a>
<a name="ln564">      }</a>
<a name="ln565">    }</a>
<a name="ln566">  }</a>
<a name="ln567">  else</a>
<a name="ln568">    to_select = g_strdup(select_album);</a>
<a name="ln569"> </a>
<a name="ln570">  // First clear the combobox except first 2 items (none / create new album)</a>
<a name="ln571">  dt_bauhaus_combobox_clear(ui-&gt;album_list);</a>
<a name="ln572">  dt_bauhaus_combobox_clear(ui-&gt;parent_album_list);</a>
<a name="ln573">  g_list_free(ui-&gt;albums);</a>
<a name="ln574">  ui-&gt;albums = NULL;</a>
<a name="ln575"> </a>
<a name="ln576">  GList *args = NULL;</a>
<a name="ln577"> </a>
<a name="ln578">  args = _piwigo_query_add_arguments(args, &quot;method&quot;, &quot;pwg.categories.getList&quot;);</a>
<a name="ln579">  args = _piwigo_query_add_arguments(args, &quot;cat_id&quot;, &quot;0&quot;);</a>
<a name="ln580">  args = _piwigo_query_add_arguments(args, &quot;recursive&quot;, &quot;true&quot;);</a>
<a name="ln581"> </a>
<a name="ln582">  _piwigo_api_post(ui-&gt;api, args, NULL, FALSE);</a>
<a name="ln583"> </a>
<a name="ln584">  g_list_free(args);</a>
<a name="ln585"> </a>
<a name="ln586">  if(ui-&gt;api-&gt;response &amp;&amp; !ui-&gt;api-&gt;error_occured)</a>
<a name="ln587">  {</a>
<a name="ln588">    dt_bauhaus_combobox_add(ui-&gt;album_list, _(&quot;create new album&quot;));</a>
<a name="ln589">    dt_bauhaus_combobox_add(ui-&gt;parent_album_list, _(&quot;---&quot;));</a>
<a name="ln590"> </a>
<a name="ln591">    JsonObject *result = json_node_get_object(json_object_get_member(ui-&gt;api-&gt;response, &quot;result&quot;));</a>
<a name="ln592">    JsonArray *albums = json_object_get_array_member(result, &quot;categories&quot;);</a>
<a name="ln593"> </a>
<a name="ln594">    if(json_array_get_length(albums)&gt;0 &amp;&amp; index==0) index = 1;</a>
<a name="ln595">    if(index &gt; json_array_get_length(albums) - 1) index = json_array_get_length(albums) - 1;</a>
<a name="ln596"> </a>
<a name="ln597">    for(int i = 0; i &lt; json_array_get_length(albums); i++)</a>
<a name="ln598">    {</a>
<a name="ln599">      char data[MAX_ALBUM_NAME_SIZE] = { 0 };</a>
<a name="ln600">      JsonObject *album = json_array_get_object_element(albums, i);</a>
<a name="ln601"> </a>
<a name="ln602">      _piwigo_album_t *new_album = g_malloc0(sizeof(struct _piwigo_album_t));</a>
<a name="ln603"> </a>
<a name="ln604">      g_strlcpy(new_album-&gt;name, json_object_get_string_member(album, &quot;name&quot;), sizeof(new_album-&gt;name));</a>
<a name="ln605">      new_album-&gt;id = json_object_get_int_member(album, &quot;id&quot;);</a>
<a name="ln606">      new_album-&gt;size = json_object_get_int_member(album, &quot;nb_images&quot;);</a>
<a name="ln607">      const int isroot = json_object_get_null_member(album, &quot;id_uppercat&quot;);</a>
<a name="ln608">      int indent = 0;</a>
<a name="ln609"> </a>
<a name="ln610">      if(!isroot)</a>
<a name="ln611">      {</a>
<a name="ln612">        const char *hierarchy = json_object_get_string_member(album, &quot;uppercats&quot;);</a>
<a name="ln613">        char const *p = hierarchy;</a>
<a name="ln614">        while(*p++) if(*p == ',') indent++;</a>
<a name="ln615">      }</a>
<a name="ln616"> </a>
<a name="ln617">      snprintf(data, sizeof(data), &quot;%*c%s (%ld)&quot;, indent * 3, ' ', new_album-&gt;name, new_album-&gt;size);</a>
<a name="ln618"> </a>
<a name="ln619">      if(to_select &amp;&amp; !strcmp(new_album-&gt;name, to_select)) index = i + 1;</a>
<a name="ln620"> </a>
<a name="ln621">      g_strlcpy(new_album-&gt;label, data, sizeof(new_album-&gt;label));</a>
<a name="ln622"> </a>
<a name="ln623">      ui-&gt;albums = g_list_append(ui-&gt;albums, new_album);</a>
<a name="ln624"> </a>
<a name="ln625">      dt_bauhaus_combobox_add_aligned(ui-&gt;album_list, data, DT_BAUHAUS_COMBOBOX_ALIGN_LEFT);</a>
<a name="ln626">      dt_bauhaus_combobox_add_aligned(ui-&gt;parent_album_list, data, DT_BAUHAUS_COMBOBOX_ALIGN_LEFT);</a>
<a name="ln627">    }</a>
<a name="ln628">  }</a>
<a name="ln629">  else</a>
<a name="ln630">    dt_control_log(_(&quot;cannot refresh albums&quot;));</a>
<a name="ln631"> </a>
<a name="ln632">  g_free(to_select);</a>
<a name="ln633"> </a>
<a name="ln634">  gtk_widget_set_sensitive(GTK_WIDGET(ui-&gt;album_list), TRUE);</a>
<a name="ln635">  gtk_widget_set_sensitive(GTK_WIDGET(ui-&gt;parent_album_list), TRUE);</a>
<a name="ln636">  dt_bauhaus_combobox_set(ui-&gt;album_list, index);</a>
<a name="ln637">}</a>
<a name="ln638"> </a>
<a name="ln639"> </a>
<a name="ln640">static const gboolean _piwigo_api_create_new_album(dt_storage_piwigo_params_t *p)</a>
<a name="ln641">{</a>
<a name="ln642">  GList *args = NULL;</a>
<a name="ln643"> </a>
<a name="ln644">  args = _piwigo_query_add_arguments(args, &quot;method&quot;, &quot;pwg.categories.add&quot;);</a>
<a name="ln645">  args = _piwigo_query_add_arguments(args, &quot;name&quot;, p-&gt;album);</a>
<a name="ln646">  if(p-&gt;parent_album_id != 0)</a>
<a name="ln647">  {</a>
<a name="ln648">    char pid[100];</a>
<a name="ln649">    snprintf(pid, sizeof(pid), &quot;%ld&quot;, p-&gt;parent_album_id);</a>
<a name="ln650">    args = _piwigo_query_add_arguments(args, &quot;parent&quot;, pid);</a>
<a name="ln651">  }</a>
<a name="ln652">  args = _piwigo_query_add_arguments(args, &quot;status&quot;, p-&gt;privacy==0?&quot;public&quot;:&quot;private&quot;);</a>
<a name="ln653"> </a>
<a name="ln654">  _piwigo_api_post(p-&gt;api, args, NULL, FALSE);</a>
<a name="ln655"> </a>
<a name="ln656">  g_list_free(args);</a>
<a name="ln657"> </a>
<a name="ln658">  if (!p-&gt;api-&gt;response || p-&gt;api-&gt;error_occured)</a>
<a name="ln659">  {</a>
<a name="ln660">    return FALSE;</a>
<a name="ln661">  }</a>
<a name="ln662">  else</a>
<a name="ln663">  {</a>
<a name="ln664">    JsonObject *result = json_node_get_object(json_object_get_member(p-&gt;api-&gt;response, &quot;result&quot;));</a>
<a name="ln665">    // set new album id in paremeter</a>
<a name="ln666">    p-&gt;album_id = json_object_get_int_member(result, &quot;id&quot;);</a>
<a name="ln667">  }</a>
<a name="ln668"> </a>
<a name="ln669">  return TRUE;</a>
<a name="ln670">}</a>
<a name="ln671"> </a>
<a name="ln672">static const gboolean _piwigo_api_upload_photo(dt_storage_piwigo_params_t *p, gchar *fname,</a>
<a name="ln673">                                               gchar *author, gchar *caption, gchar *description)</a>
<a name="ln674">{</a>
<a name="ln675">  GList *args = NULL;</a>
<a name="ln676">  char cat[10];</a>
<a name="ln677">  char privacy[10];</a>
<a name="ln678"> </a>
<a name="ln679">  snprintf(cat, sizeof(cat), &quot;%ld&quot;, p-&gt;album_id);</a>
<a name="ln680">  snprintf(privacy, sizeof(privacy), &quot;%d&quot;, p-&gt;privacy);</a>
<a name="ln681"> </a>
<a name="ln682">  args = _piwigo_query_add_arguments(args, &quot;method&quot;, &quot;pwg.images.addSimple&quot;);</a>
<a name="ln683">  args = _piwigo_query_add_arguments(args, &quot;image&quot;, fname);</a>
<a name="ln684">  args = _piwigo_query_add_arguments(args, &quot;category&quot;, cat);</a>
<a name="ln685">  args = _piwigo_query_add_arguments(args, &quot;level&quot;, privacy);</a>
<a name="ln686"> </a>
<a name="ln687">  if(caption &amp;&amp; strlen(caption)&gt;0)</a>
<a name="ln688">    args = _piwigo_query_add_arguments(args, &quot;name&quot;, caption);</a>
<a name="ln689"> </a>
<a name="ln690">  if(author &amp;&amp; strlen(author)&gt;0)</a>
<a name="ln691">    args = _piwigo_query_add_arguments(args, &quot;author&quot;, author);</a>
<a name="ln692"> </a>
<a name="ln693">  if(description &amp;&amp; strlen(description)&gt;0)</a>
<a name="ln694">    args = _piwigo_query_add_arguments(args, &quot;comment&quot;, description);</a>
<a name="ln695"> </a>
<a name="ln696">  if(p-&gt;export_tags &amp;&amp; p-&gt;tags &amp;&amp; strlen(p-&gt;tags)&gt;0)</a>
<a name="ln697">    args = _piwigo_query_add_arguments(args, &quot;tags&quot;, p-&gt;tags);</a>
<a name="ln698"> </a>
<a name="ln699">  _piwigo_api_post(p-&gt;api, args, fname, FALSE);</a>
<a name="ln700"> </a>
<a name="ln701">  g_list_free(args);</a>
<a name="ln702"> </a>
<a name="ln703">  return !p-&gt;api-&gt;error_occured;</a>
<a name="ln704">}</a>
<a name="ln705"> </a>
<a name="ln706">// Login button pressed...</a>
<a name="ln707">static void _piwigo_login_clicked(GtkButton *button, gpointer data)</a>
<a name="ln708">{</a>
<a name="ln709">  dt_storage_piwigo_gui_data_t *ui = (dt_storage_piwigo_gui_data_t *)data;</a>
<a name="ln710">  _piwigo_ctx_destroy(&amp;ui-&gt;api);</a>
<a name="ln711">  _piwigo_refresh_albums(ui, NULL);</a>
<a name="ln712">}</a>
<a name="ln713"> </a>
<a name="ln714">// Refresh button pressed...</a>
<a name="ln715">static void _piwigo_refresh_clicked(GtkButton *button, gpointer data)</a>
<a name="ln716">{</a>
<a name="ln717">  dt_storage_piwigo_gui_data_t *ui = (dt_storage_piwigo_gui_data_t *)data;</a>
<a name="ln718">  _piwigo_refresh_albums(ui, NULL);</a>
<a name="ln719">}</a>
<a name="ln720"> </a>
<a name="ln721">const char *name(const struct dt_imageio_module_storage_t *self)</a>
<a name="ln722">{</a>
<a name="ln723">  return _(&quot;piwigo&quot;);</a>
<a name="ln724">}</a>
<a name="ln725"> </a>
<a name="ln726">void gui_init(dt_imageio_module_storage_t *self)</a>
<a name="ln727">{</a>
<a name="ln728">  self-&gt;gui_data = (dt_storage_piwigo_gui_data_t *)g_malloc0(sizeof(dt_storage_piwigo_gui_data_t));</a>
<a name="ln729">  dt_storage_piwigo_gui_data_t *ui = self-&gt;gui_data;</a>
<a name="ln730"> </a>
<a name="ln731">  ui-&gt;albums = NULL;</a>
<a name="ln732">  ui-&gt;accounts = NULL;</a>
<a name="ln733">  ui-&gt;api = NULL;</a>
<a name="ln734"> </a>
<a name="ln735">  self-&gt;widget = gtk_box_new(GTK_ORIENTATION_VERTICAL, DT_PIXEL_APPLY_DPI(8));</a>
<a name="ln736"> </a>
<a name="ln737">  _piwigo_load_account(ui);</a>
<a name="ln738"> </a>
<a name="ln739">  gchar *server = dt_conf_get_string(&quot;plugins/imageio/storage/export/piwigo/server&quot;);</a>
<a name="ln740"> </a>
<a name="ln741">  // look for last server information</a>
<a name="ln742">  _piwigo_account_t *last_account = _piwigo_get_account(ui, server);</a>
<a name="ln743"> </a>
<a name="ln744">  GtkWidget *hbox, *label, *button;</a>
<a name="ln745"> </a>
<a name="ln746">  // account</a>
<a name="ln747">  ui-&gt;account_list = dt_bauhaus_combobox_new(NULL);</a>
<a name="ln748">  dt_bauhaus_widget_set_label(ui-&gt;account_list, NULL, _(&quot;accounts&quot;));</a>
<a name="ln749">  GList *a = ui-&gt;accounts;</a>
<a name="ln750">  int account_index = -1, index=0;</a>
<a name="ln751">  while(a)</a>
<a name="ln752">  {</a>
<a name="ln753">    _piwigo_account_t *account = (_piwigo_account_t *)a-&gt;data;</a>
<a name="ln754">    dt_bauhaus_combobox_add(ui-&gt;account_list, account-&gt;server);</a>
<a name="ln755">    if(!strcmp(account-&gt;server, server)) account_index = index;</a>
<a name="ln756">    index++;</a>
<a name="ln757">    a = g_list_next(a);</a>
<a name="ln758">  }</a>
<a name="ln759">  gtk_widget_set_hexpand(ui-&gt;account_list, TRUE);</a>
<a name="ln760">  g_signal_connect(G_OBJECT(ui-&gt;account_list), &quot;value-changed&quot;, G_CALLBACK(_piwigo_account_changed), (gpointer)ui);</a>
<a name="ln761">  gtk_box_pack_start(GTK_BOX(self-&gt;widget), ui-&gt;account_list, FALSE, FALSE, 0);</a>
<a name="ln762"> </a>
<a name="ln763">  // server</a>
<a name="ln764">  hbox = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, DT_PIXEL_APPLY_DPI(8));</a>
<a name="ln765">  label = gtk_label_new(_(&quot;server&quot;));</a>
<a name="ln766">  g_object_set(G_OBJECT(label), &quot;xalign&quot;, 0.0, (gchar *)0);</a>
<a name="ln767">  ui-&gt;server_entry = GTK_ENTRY(gtk_entry_new());</a>
<a name="ln768">  gtk_widget_set_tooltip_text(GTK_WIDGET(ui-&gt;server_entry),</a>
<a name="ln769">                              _(&quot;the server name\ndefault protocol is https\nspecify http:// if non secure server&quot;));</a>
<a name="ln770">  gtk_widget_set_hexpand(GTK_WIDGET(ui-&gt;server_entry), TRUE);</a>
<a name="ln771">  dt_gui_key_accel_block_on_focus_connect(GTK_WIDGET(ui-&gt;server_entry));</a>
<a name="ln772">  gtk_entry_set_text(ui-&gt;server_entry, last_account?last_account-&gt;server:&quot;piwigo.com&quot;);</a>
<a name="ln773">  g_signal_connect(G_OBJECT(ui-&gt;server_entry), &quot;changed&quot;, G_CALLBACK(_piwigo_server_entry_changed), (gpointer)ui);</a>
<a name="ln774">  gtk_entry_set_width_chars(GTK_ENTRY(ui-&gt;server_entry), 0);</a>
<a name="ln775">  gtk_box_pack_start(GTK_BOX(hbox), GTK_WIDGET(label), FALSE, FALSE, 0);</a>
<a name="ln776">  gtk_box_pack_start(GTK_BOX(hbox), GTK_WIDGET(ui-&gt;server_entry), TRUE, TRUE, 0);</a>
<a name="ln777">  gtk_box_pack_start(GTK_BOX(self-&gt;widget), GTK_WIDGET(hbox), TRUE, TRUE, 0);</a>
<a name="ln778">  g_free(server);</a>
<a name="ln779"> </a>
<a name="ln780">  // login</a>
<a name="ln781">  hbox = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, DT_PIXEL_APPLY_DPI(8));</a>
<a name="ln782">  label = gtk_label_new(_(&quot;user&quot;));</a>
<a name="ln783">  g_object_set(G_OBJECT(label), &quot;xalign&quot;, 0.0, (gchar *)0);</a>
<a name="ln784">  ui-&gt;user_entry = GTK_ENTRY(gtk_entry_new());</a>
<a name="ln785">  gtk_widget_set_hexpand(GTK_WIDGET(ui-&gt;user_entry), TRUE);</a>
<a name="ln786">  dt_gui_key_accel_block_on_focus_connect(GTK_WIDGET(ui-&gt;user_entry));</a>
<a name="ln787">  gtk_entry_set_text(ui-&gt;user_entry, last_account?last_account-&gt;username:&quot;&quot;);</a>
<a name="ln788">  g_signal_connect(G_OBJECT(ui-&gt;user_entry), &quot;changed&quot;, G_CALLBACK(_piwigo_entry_changed), (gpointer)ui);</a>
<a name="ln789">  gtk_entry_set_width_chars(GTK_ENTRY(ui-&gt;user_entry), 0);</a>
<a name="ln790">  gtk_box_pack_start(GTK_BOX(hbox), GTK_WIDGET(label), FALSE, FALSE, 0);</a>
<a name="ln791">  gtk_box_pack_start(GTK_BOX(hbox), GTK_WIDGET(ui-&gt;user_entry), TRUE, TRUE, 0);</a>
<a name="ln792">  gtk_box_pack_start(GTK_BOX(self-&gt;widget), GTK_WIDGET(hbox), TRUE, TRUE, 0);</a>
<a name="ln793"> </a>
<a name="ln794">  // password</a>
<a name="ln795">  hbox = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, DT_PIXEL_APPLY_DPI(8));</a>
<a name="ln796">  label = gtk_label_new(_(&quot;password&quot;));</a>
<a name="ln797">  g_object_set(G_OBJECT(label), &quot;xalign&quot;, 0.0, (gchar *)0);</a>
<a name="ln798">  ui-&gt;pwd_entry = GTK_ENTRY(gtk_entry_new());</a>
<a name="ln799">  gtk_entry_set_visibility(GTK_ENTRY(ui-&gt;pwd_entry), FALSE);</a>
<a name="ln800">  gtk_widget_set_hexpand(GTK_WIDGET(ui-&gt;pwd_entry), TRUE);</a>
<a name="ln801">  dt_gui_key_accel_block_on_focus_connect(GTK_WIDGET(ui-&gt;pwd_entry));</a>
<a name="ln802">  gtk_entry_set_text(ui-&gt;pwd_entry, last_account?last_account-&gt;password:&quot;&quot;);</a>
<a name="ln803">  g_signal_connect(G_OBJECT(ui-&gt;pwd_entry), &quot;changed&quot;, G_CALLBACK(_piwigo_entry_changed), (gpointer)ui);</a>
<a name="ln804">  gtk_entry_set_width_chars(GTK_ENTRY(ui-&gt;pwd_entry), 0);</a>
<a name="ln805">  gtk_box_pack_start(GTK_BOX(hbox), GTK_WIDGET(label), FALSE, FALSE, 0);</a>
<a name="ln806">  gtk_box_pack_start(GTK_BOX(hbox), GTK_WIDGET(ui-&gt;pwd_entry), TRUE, TRUE, 0);</a>
<a name="ln807">  gtk_box_pack_start(GTK_BOX(self-&gt;widget), GTK_WIDGET(hbox), TRUE, TRUE, 0);</a>
<a name="ln808"> </a>
<a name="ln809">  // login button</a>
<a name="ln810">  button = gtk_button_new_with_label(_(&quot;login&quot;));</a>
<a name="ln811">  gtk_widget_set_tooltip_text(button, _(&quot;piwigo login&quot;));</a>
<a name="ln812">  g_signal_connect(G_OBJECT(button), &quot;clicked&quot;, G_CALLBACK(_piwigo_login_clicked), (gpointer)ui);</a>
<a name="ln813">  gtk_box_pack_start(GTK_BOX(self-&gt;widget), button, FALSE, FALSE, 0);</a>
<a name="ln814"> </a>
<a name="ln815">  // status area</a>
<a name="ln816">  ui-&gt;status_label = GTK_LABEL(gtk_label_new(NULL));</a>
<a name="ln817">  gtk_widget_set_halign(GTK_WIDGET(ui-&gt;status_label), GTK_ALIGN_START);</a>
<a name="ln818">  gtk_box_pack_start(GTK_BOX(self-&gt;widget), GTK_WIDGET(ui-&gt;status_label), FALSE, FALSE, 0);</a>
<a name="ln819"> </a>
<a name="ln820">  ui-&gt;export_tags = dt_bauhaus_combobox_new(NULL);</a>
<a name="ln821">  dt_bauhaus_widget_set_label(ui-&gt;export_tags, NULL, _(&quot;export tags&quot;));</a>
<a name="ln822">  dt_bauhaus_combobox_add(ui-&gt;export_tags, _(&quot;yes&quot;));</a>
<a name="ln823">  dt_bauhaus_combobox_add(ui-&gt;export_tags, _(&quot;no&quot;));</a>
<a name="ln824">  dt_bauhaus_combobox_set(ui-&gt;export_tags, 0);</a>
<a name="ln825">  gtk_widget_set_hexpand(ui-&gt;export_tags, TRUE);</a>
<a name="ln826">  gtk_box_pack_start(GTK_BOX(self-&gt;widget), ui-&gt;export_tags, FALSE, FALSE, 0);</a>
<a name="ln827"> </a>
<a name="ln828">  // select account</a>
<a name="ln829">  if(account_index != -1) dt_bauhaus_combobox_set(ui-&gt;account_list, account_index);</a>
<a name="ln830"> </a>
<a name="ln831">  // permissions list</a>
<a name="ln832">  ui-&gt;permission_list = dt_bauhaus_combobox_new(NULL);</a>
<a name="ln833">  dt_bauhaus_widget_set_label(ui-&gt;permission_list, NULL, _(&quot;visible to&quot;));</a>
<a name="ln834">  dt_bauhaus_combobox_add(ui-&gt;permission_list, _(&quot;everyone&quot;));</a>
<a name="ln835">  dt_bauhaus_combobox_add(ui-&gt;permission_list, _(&quot;contacts&quot;));</a>
<a name="ln836">  dt_bauhaus_combobox_add(ui-&gt;permission_list, _(&quot;friends&quot;));</a>
<a name="ln837">  dt_bauhaus_combobox_add(ui-&gt;permission_list, _(&quot;family&quot;));</a>
<a name="ln838">  dt_bauhaus_combobox_add(ui-&gt;permission_list, _(&quot;you&quot;));</a>
<a name="ln839">  dt_bauhaus_combobox_set(ui-&gt;permission_list, 0); // Set default permission to private</a>
<a name="ln840">  gtk_box_pack_start(GTK_BOX(self-&gt;widget), ui-&gt;permission_list, FALSE, FALSE, 0);</a>
<a name="ln841"> </a>
<a name="ln842">  // album list</a>
<a name="ln843">  hbox = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, DT_PIXEL_APPLY_DPI(5));</a>
<a name="ln844"> </a>
<a name="ln845">  ui-&gt;album_list = dt_bauhaus_combobox_new(NULL); // Available albums</a>
<a name="ln846">  dt_bauhaus_widget_set_label(ui-&gt;album_list, NULL, _(&quot;albums&quot;));</a>
<a name="ln847">  g_signal_connect(G_OBJECT(ui-&gt;album_list), &quot;value-changed&quot;, G_CALLBACK(_piwigo_album_changed), (gpointer)ui);</a>
<a name="ln848">  gtk_widget_set_sensitive(ui-&gt;album_list, FALSE);</a>
<a name="ln849">  gtk_box_pack_start(GTK_BOX(hbox), ui-&gt;album_list, TRUE, TRUE, 0);</a>
<a name="ln850"> </a>
<a name="ln851">  button = dtgtk_button_new(dtgtk_cairo_paint_refresh, CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln852">  gtk_widget_set_tooltip_text(button, _(&quot;refresh album list&quot;));</a>
<a name="ln853">  g_signal_connect(G_OBJECT(button), &quot;clicked&quot;, G_CALLBACK(_piwigo_refresh_clicked), (gpointer)ui);</a>
<a name="ln854">  gtk_box_pack_start(GTK_BOX(hbox), button, FALSE, FALSE, 0);</a>
<a name="ln855"> </a>
<a name="ln856">  gtk_box_pack_start(GTK_BOX(self-&gt;widget), hbox, FALSE, FALSE, 0);</a>
<a name="ln857"> </a>
<a name="ln858">  // new album</a>
<a name="ln859">  ui-&gt;create_box = GTK_BOX(gtk_box_new(GTK_ORIENTATION_VERTICAL, DT_PIXEL_APPLY_DPI(5)));</a>
<a name="ln860">  gtk_widget_set_no_show_all(GTK_WIDGET(ui-&gt;create_box), TRUE);</a>
<a name="ln861">  gtk_box_pack_start(GTK_BOX(self-&gt;widget), GTK_WIDGET(ui-&gt;create_box), FALSE, FALSE, 0);</a>
<a name="ln862"> </a>
<a name="ln863">  hbox = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, DT_PIXEL_APPLY_DPI(10));</a>
<a name="ln864"> </a>
<a name="ln865">  label = gtk_label_new(_(&quot;title&quot;));</a>
<a name="ln866">  g_object_set(G_OBJECT(label), &quot;xalign&quot;, 0.0, (gchar *)0);</a>
<a name="ln867">  gtk_box_pack_start(GTK_BOX(hbox), label, FALSE, FALSE, 0);</a>
<a name="ln868"> </a>
<a name="ln869">  ui-&gt;new_album_entry = GTK_ENTRY(gtk_entry_new()); // Album title</a>
<a name="ln870">  dt_gui_key_accel_block_on_focus_connect(GTK_WIDGET(ui-&gt;new_album_entry));</a>
<a name="ln871">  gtk_entry_set_text(ui-&gt;new_album_entry, _(&quot;new album&quot;));</a>
<a name="ln872">  gtk_box_pack_start(GTK_BOX(hbox), GTK_WIDGET(ui-&gt;new_album_entry), TRUE, TRUE, 0);</a>
<a name="ln873">  gtk_entry_set_width_chars(GTK_ENTRY(ui-&gt;new_album_entry), 0);</a>
<a name="ln874"> </a>
<a name="ln875">  gtk_box_pack_start(ui-&gt;create_box, hbox, FALSE, FALSE, 0);</a>
<a name="ln876"> </a>
<a name="ln877">  // parent album list</a>
<a name="ln878">  ui-&gt;parent_album_list = dt_bauhaus_combobox_new(NULL); // Available albums</a>
<a name="ln879">  dt_bauhaus_widget_set_label(ui-&gt;parent_album_list, NULL, _(&quot;parent album&quot;));</a>
<a name="ln880">  gtk_widget_set_sensitive(ui-&gt;parent_album_list, TRUE);</a>
<a name="ln881">  gtk_box_pack_start(ui-&gt;create_box, ui-&gt;parent_album_list, TRUE, TRUE, 0);</a>
<a name="ln882"> </a>
<a name="ln883">  _piwigo_set_status(ui, _(&quot;click login button to start&quot;), &quot;#ffffff&quot;);</a>
<a name="ln884">}</a>
<a name="ln885"> </a>
<a name="ln886">void gui_cleanup(dt_imageio_module_storage_t *self)</a>
<a name="ln887">{</a>
<a name="ln888">  dt_storage_piwigo_gui_data_t *ui = self-&gt;gui_data;</a>
<a name="ln889">  dt_gui_key_accel_block_on_focus_disconnect(GTK_WIDGET(ui-&gt;user_entry));</a>
<a name="ln890">  dt_gui_key_accel_block_on_focus_disconnect(GTK_WIDGET(ui-&gt;new_album_entry));</a>
<a name="ln891">  g_free(self-&gt;gui_data);</a>
<a name="ln892">}</a>
<a name="ln893"> </a>
<a name="ln894">void gui_reset(dt_imageio_module_storage_t *self)</a>
<a name="ln895">{</a>
<a name="ln896">}</a>
<a name="ln897"> </a>
<a name="ln898">static gboolean _finalize_store(gpointer user_data)</a>
<a name="ln899">{</a>
<a name="ln900">  dt_storage_piwigo_gui_data_t *g = (dt_storage_piwigo_gui_data_t *)user_data;</a>
<a name="ln901">  _piwigo_refresh_albums(g, dt_bauhaus_combobox_get_text(g-&gt;album_list));</a>
<a name="ln902">  return FALSE;</a>
<a name="ln903">}</a>
<a name="ln904"> </a>
<a name="ln905">void finalize_store(struct dt_imageio_module_storage_t *self, dt_imageio_module_data_t *data)</a>
<a name="ln906">{</a>
<a name="ln907">  g_main_context_invoke(NULL, _finalize_store, self-&gt;gui_data);</a>
<a name="ln908">}</a>
<a name="ln909"> </a>
<a name="ln910">int store(dt_imageio_module_storage_t *self, dt_imageio_module_data_t *sdata, const int imgid,</a>
<a name="ln911">          dt_imageio_module_format_t *format, dt_imageio_module_data_t *fdata, const int num, const int total,</a>
<a name="ln912">          const gboolean high_quality, const gboolean upscale, dt_colorspaces_color_profile_type_t icc_type,</a>
<a name="ln913">          const gchar *icc_filename, dt_iop_color_intent_t icc_intent)</a>
<a name="ln914">{</a>
<a name="ln915">  dt_storage_piwigo_gui_data_t *ui = self-&gt;gui_data;</a>
<a name="ln916"> </a>
<a name="ln917">  gint result = 0;</a>
<a name="ln918"> </a>
<a name="ln919">  const char *ext = format-&gt;extension(fdata);</a>
<a name="ln920"> </a>
<a name="ln921">  // Let's upload image...</a>
<a name="ln922"> </a>
<a name="ln923">  /* construct a temporary file name */</a>
<a name="ln924">  char fname[PATH_MAX] = { 0 };</a>
<a name="ln925">  dt_loc_get_tmp_dir(fname, sizeof(fname));</a>
<a name="ln926">  g_strlcat(fname, &quot;/darktable.XXXXXX.&quot;, sizeof(fname));</a>
<a name="ln927">  g_strlcat(fname, ext, sizeof(fname));</a>
<a name="ln928"> </a>
<a name="ln929">  char *caption = NULL;</a>
<a name="ln930">  char *description = NULL;</a>
<a name="ln931">  char *author = NULL;</a>
<a name="ln932"> </a>
<a name="ln933">  gint fd = g_mkstemp(fname);</a>
<a name="ln934">  if(fd == -1)</a>
<a name="ln935">  {</a>
<a name="ln936">    dt_control_log(&quot;failed to create temporary image for piwigo export&quot;);</a>
<a name="ln937">    fprintf(stderr, &quot;failed to create tempfile: %s\n&quot;, fname);</a>
<a name="ln938">    return 1;</a>
<a name="ln939">  }</a>
<a name="ln940">  close(fd);</a>
<a name="ln941">  const dt_image_t *img = dt_image_cache_get(darktable.image_cache, imgid, 'r');</a>
<a name="ln942"> </a>
<a name="ln943">  // If title is not existing, then use the filename without extension. If not, then use title instead</a>
<a name="ln944">  GList *title = dt_metadata_get(img-&gt;id, &quot;Xmp.dc.title&quot;, NULL);</a>
<a name="ln945">  if(title != NULL)</a>
<a name="ln946">  {</a>
<a name="ln947">    caption = g_strdup(title-&gt;data);</a>
<a name="ln948">    g_list_free_full(title, &amp;g_free);</a>
<a name="ln949">  }</a>
<a name="ln950">  else</a>
<a name="ln951">  {</a>
<a name="ln952">    caption = g_path_get_basename(img-&gt;filename);</a>
<a name="ln953">    (g_strrstr(caption, &quot;.&quot;))[0] = '\0'; // chop extension...</a>
<a name="ln954">  }</a>
<a name="ln955"> </a>
<a name="ln956">  GList *desc = dt_metadata_get(img-&gt;id, &quot;Xmp.dc.description&quot;, NULL);</a>
<a name="ln957">  if(desc != NULL)</a>
<a name="ln958">  {</a>
<a name="ln959">    description = g_strdup(desc-&gt;data);</a>
<a name="ln960">    g_list_free_full(desc, &amp;g_free);</a>
<a name="ln961">  }</a>
<a name="ln962">  dt_image_cache_read_release(darktable.image_cache, img);</a>
<a name="ln963"> </a>
<a name="ln964">  GList *auth = dt_metadata_get(img-&gt;id, &quot;Xmp.dc.creator&quot;, NULL);</a>
<a name="ln965">  if(auth != NULL)</a>
<a name="ln966">  {</a>
<a name="ln967">    author = g_strdup(auth-&gt;data);</a>
<a name="ln968">    g_list_free_full(auth, &amp;g_free);</a>
<a name="ln969">  }</a>
<a name="ln970"> </a>
<a name="ln971">  if(dt_imageio_export(imgid, fname, format, fdata, high_quality, upscale, FALSE, icc_type, icc_filename, icc_intent,</a>
<a name="ln972">                       self, sdata, num, total) != 0)</a>
<a name="ln973">  {</a>
<a name="ln974">    fprintf(stderr, &quot;[imageio_storage_piwigo] could not export to file: `%s'!\n&quot;, fname);</a>
<a name="ln975">    dt_control_log(_(&quot;could not export to file `%s'!&quot;), fname);</a>
<a name="ln976">    result = 1;</a>
<a name="ln977">    goto cleanup;</a>
<a name="ln978">  }</a>
<a name="ln979"> </a>
<a name="ln980">  dt_pthread_mutex_lock(&amp;darktable.plugin_threadsafe);</a>
<a name="ln981">  {</a>
<a name="ln982">    gboolean status = TRUE;</a>
<a name="ln983">    dt_storage_piwigo_params_t *p = (dt_storage_piwigo_params_t *)sdata;</a>
<a name="ln984"> </a>
<a name="ln985">    if(p-&gt;export_tags)</a>
<a name="ln986">    {</a>
<a name="ln987">      GList *tags_list = dt_tag_get_list(imgid);</a>
<a name="ln988">      if(p-&gt;tags) g_free(p-&gt;tags);</a>
<a name="ln989">      p-&gt;tags = dt_util_glist_to_str(&quot;,&quot;, tags_list);</a>
<a name="ln990">      g_list_free_full(tags_list, g_free);</a>
<a name="ln991">    }</a>
<a name="ln992"> </a>
<a name="ln993">    if(p-&gt;new_album)</a>
<a name="ln994">    {</a>
<a name="ln995">      status = _piwigo_api_create_new_album(p);</a>
<a name="ln996">      if(!status) dt_control_log(_(&quot;cannot create a new piwigo album!&quot;));</a>
<a name="ln997">    }</a>
<a name="ln998"> </a>
<a name="ln999">    if(status)</a>
<a name="ln1000">    {</a>
<a name="ln1001">      status = _piwigo_api_upload_photo(p, fname, author, caption, description);</a>
<a name="ln1002">      if(!status)</a>
<a name="ln1003">      {</a>
<a name="ln1004">        fprintf(stderr, &quot;[imageio_storage_piwigo] could not upload to piwigo!\n&quot;);</a>
<a name="ln1005">        dt_control_log(_(&quot;could not upload to piwigo!&quot;));</a>
<a name="ln1006">        result = 1;</a>
<a name="ln1007">      }</a>
<a name="ln1008">      else if (p-&gt;new_album)</a>
<a name="ln1009">      {</a>
<a name="ln1010">        // we do not want to create more albums when multiple upload</a>
<a name="ln1011">        p-&gt;new_album = FALSE;</a>
<a name="ln1012">        _piwigo_refresh_albums(ui, p-&gt;album);</a>
<a name="ln1013">      }</a>
<a name="ln1014">    }</a>
<a name="ln1015">  }</a>
<a name="ln1016">  dt_pthread_mutex_unlock(&amp;darktable.plugin_threadsafe);</a>
<a name="ln1017"> </a>
<a name="ln1018">cleanup:</a>
<a name="ln1019"> </a>
<a name="ln1020">  // And remove from filesystem..</a>
<a name="ln1021">  g_unlink(fname);</a>
<a name="ln1022">  g_free(caption);</a>
<a name="ln1023">  g_free(description);</a>
<a name="ln1024">  g_free(author);</a>
<a name="ln1025"> </a>
<a name="ln1026">  if(!result)</a>
<a name="ln1027">  {</a>
<a name="ln1028">    // this makes sense only if the export was successful</a>
<a name="ln1029">    dt_control_log(ngettext(&quot;%d/%d exported to piwigo webalbum&quot;, &quot;%d/%d exported to piwigo webalbum&quot;, num),</a>
<a name="ln1030">                   num, total);</a>
<a name="ln1031">  }</a>
<a name="ln1032">  return result;</a>
<a name="ln1033">}</a>
<a name="ln1034"> </a>
<a name="ln1035">size_t params_size(dt_imageio_module_storage_t *self)</a>
<a name="ln1036">{</a>
<a name="ln1037">  return sizeof(int64_t);</a>
<a name="ln1038">}</a>
<a name="ln1039"> </a>
<a name="ln1040">void init(dt_imageio_module_storage_t *self)</a>
<a name="ln1041">{</a>
<a name="ln1042">}</a>
<a name="ln1043"> </a>
<a name="ln1044">static uint64_t _piwigo_album_id(const gchar *name, GList *albums)</a>
<a name="ln1045">{</a>
<a name="ln1046">  uint64_t id = 0;</a>
<a name="ln1047"> </a>
<a name="ln1048">  GList *a = albums;</a>
<a name="ln1049">  while(a)</a>
<a name="ln1050">  {</a>
<a name="ln1051">    _piwigo_album_t *album = (_piwigo_album_t *)a-&gt;data;</a>
<a name="ln1052">    if(!strcmp(name, album-&gt;label))</a>
<a name="ln1053">    {</a>
<a name="ln1054">      id = album-&gt;id;</a>
<a name="ln1055">      break;</a>
<a name="ln1056">    }</a>
<a name="ln1057">    a = g_list_next(a);</a>
<a name="ln1058">  }</a>
<a name="ln1059"> </a>
<a name="ln1060">  return id;</a>
<a name="ln1061">}</a>
<a name="ln1062"> </a>
<a name="ln1063">void *get_params(dt_imageio_module_storage_t *self)</a>
<a name="ln1064">{</a>
<a name="ln1065">  dt_storage_piwigo_gui_data_t *ui = (dt_storage_piwigo_gui_data_t *)self-&gt;gui_data;</a>
<a name="ln1066">  if(!ui) return NULL; // gui not initialized, CLI mode</a>
<a name="ln1067">  dt_storage_piwigo_params_t *p = (dt_storage_piwigo_params_t *)g_malloc0(sizeof(dt_storage_piwigo_params_t));</a>
<a name="ln1068"> </a>
<a name="ln1069">  if(!p) return NULL;</a>
<a name="ln1070"> </a>
<a name="ln1071">  // fill d from controls in ui</a>
<a name="ln1072">  if(ui-&gt;api &amp;&amp; ui-&gt;api-&gt;authenticated == TRUE)</a>
<a name="ln1073">  {</a>
<a name="ln1074">    // create a new context for the import. set username/password to be able to connect.</a>
<a name="ln1075">    p-&gt;api = _piwigo_ctx_init();</a>
<a name="ln1076">    p-&gt;api-&gt;authenticated = FALSE;</a>
<a name="ln1077">    p-&gt;api-&gt;server = g_strdup(ui-&gt;api-&gt;server);</a>
<a name="ln1078">    p-&gt;api-&gt;username = g_strdup(ui-&gt;api-&gt;username);</a>
<a name="ln1079">    p-&gt;api-&gt;password = g_strdup(ui-&gt;api-&gt;password);</a>
<a name="ln1080">    _piwigo_api_authenticate(p-&gt;api);</a>
<a name="ln1081"> </a>
<a name="ln1082">    int index = dt_bauhaus_combobox_get(ui-&gt;album_list);</a>
<a name="ln1083"> </a>
<a name="ln1084">    p-&gt;album_id = 0;</a>
<a name="ln1085">    p-&gt;export_tags = (dt_bauhaus_combobox_get(ui-&gt;export_tags) == 0);</a>
<a name="ln1086">    p-&gt;tags = NULL;</a>
<a name="ln1087"> </a>
<a name="ln1088">    switch(dt_bauhaus_combobox_get(ui-&gt;permission_list))</a>
<a name="ln1089">    {</a>
<a name="ln1090">      case 0:                // everyone</a>
<a name="ln1091">        p-&gt;privacy = 0;</a>
<a name="ln1092">        break;</a>
<a name="ln1093">      case 1:                // contacts</a>
<a name="ln1094">        p-&gt;privacy = 1;</a>
<a name="ln1095">        break;</a>
<a name="ln1096">      case 2:                // friends</a>
<a name="ln1097">        p-&gt;privacy = 2;</a>
<a name="ln1098">        break;</a>
<a name="ln1099">      case 3:                // family</a>
<a name="ln1100">        p-&gt;privacy = 4;</a>
<a name="ln1101">        break;</a>
<a name="ln1102">      default:               // you / admin</a>
<a name="ln1103">        p-&gt;privacy = 8;</a>
<a name="ln1104">    }</a>
<a name="ln1105"> </a>
<a name="ln1106">    if(index &gt;= 0)</a>
<a name="ln1107">    {</a>
<a name="ln1108">      switch(index)</a>
<a name="ln1109">      {</a>
<a name="ln1110">        case 0: // Create album</a>
<a name="ln1111">          p-&gt;parent_album_id = _piwigo_album_id(dt_bauhaus_combobox_get_text(ui-&gt;parent_album_list), ui-&gt;albums);</a>
<a name="ln1112">          p-&gt;album = g_strdup(gtk_entry_get_text(ui-&gt;new_album_entry));</a>
<a name="ln1113">          p-&gt;new_album = TRUE;</a>
<a name="ln1114">          break;</a>
<a name="ln1115"> </a>
<a name="ln1116">        default:</a>
<a name="ln1117">          p-&gt;album = g_strdup(dt_bauhaus_combobox_get_text(ui-&gt;album_list));</a>
<a name="ln1118">          p-&gt;new_album = FALSE;</a>
<a name="ln1119"> </a>
<a name="ln1120">          if(p-&gt;album == NULL)</a>
<a name="ln1121">          {</a>
<a name="ln1122">            // Something went wrong...</a>
<a name="ln1123">            fprintf(stderr, &quot;Something went wrong.. album index %d = NULL\n&quot;, index - 2);</a>
<a name="ln1124">            goto cleanup;</a>
<a name="ln1125">          }</a>
<a name="ln1126"> </a>
<a name="ln1127">          p-&gt;album_id = _piwigo_album_id(p-&gt;album, ui-&gt;albums);</a>
<a name="ln1128"> </a>
<a name="ln1129">          if(!p-&gt;album_id)</a>
<a name="ln1130">          {</a>
<a name="ln1131">            fprintf(stderr, &quot;[imageio_storage_piwigo] cannot find album `%s'!\n&quot;, p-&gt;album);</a>
<a name="ln1132">            goto cleanup;</a>
<a name="ln1133">          }</a>
<a name="ln1134"> </a>
<a name="ln1135">          break;</a>
<a name="ln1136">      }</a>
<a name="ln1137">    }</a>
<a name="ln1138">    else</a>
<a name="ln1139">      goto cleanup;</a>
<a name="ln1140">  }</a>
<a name="ln1141">  else</a>
<a name="ln1142">    goto cleanup;</a>
<a name="ln1143"> </a>
<a name="ln1144">  return p;</a>
<a name="ln1145"> </a>
<a name="ln1146"> cleanup:</a>
<a name="ln1147">    g_free(p);</a>
<a name="ln1148">    return NULL;</a>
<a name="ln1149">}</a>
<a name="ln1150"> </a>
<a name="ln1151">int set_params(dt_imageio_module_storage_t *self, const void *params, const int size)</a>
<a name="ln1152">{</a>
<a name="ln1153">  if(size != self-&gt;params_size(self)) return 1;</a>
<a name="ln1154">  // gui stuff not updated, as sensitive user data is not stored in the preset.</a>
<a name="ln1155">  // TODO: store name/hash in kwallet/etc module and get encrypted stuff from there!</a>
<a name="ln1156">  return 0;</a>
<a name="ln1157">}</a>
<a name="ln1158"> </a>
<a name="ln1159">int supported(dt_imageio_module_storage_t *storage, dt_imageio_module_format_t *format)</a>
<a name="ln1160">{</a>
<a name="ln1161">  if(strcmp(format-&gt;mime(NULL), &quot;image/jpeg&quot;) == 0)</a>
<a name="ln1162">    return 1;</a>
<a name="ln1163">  else if(strcmp(format-&gt;mime(NULL), &quot;image/png&quot;) == 0)</a>
<a name="ln1164">    return 1;</a>
<a name="ln1165"> </a>
<a name="ln1166">  return 0;</a>
<a name="ln1167">}</a>
<a name="ln1168"> </a>
<a name="ln1169">void free_params(dt_imageio_module_storage_t *self, dt_imageio_module_data_t *params)</a>
<a name="ln1170">{</a>
<a name="ln1171">  dt_storage_piwigo_params_t *p = (dt_storage_piwigo_params_t *)params;</a>
<a name="ln1172"> </a>
<a name="ln1173">  if(p)</a>
<a name="ln1174">  {</a>
<a name="ln1175">    g_free(p-&gt;album);</a>
<a name="ln1176">    g_free(p-&gt;tags);</a>
<a name="ln1177">    _piwigo_ctx_destroy(&amp;p-&gt;api);</a>
<a name="ln1178">    free(p);</a>
<a name="ln1179">  }</a>
<a name="ln1180">}</a>
<a name="ln1181"> </a>
<a name="ln1182">// modelines: These editor modelines have been set for all relevant files by tools/update_modelines.sh</a>
<a name="ln1183">// vim: shiftwidth=2 expandtab tabstop=2 cindent</a>
<a name="ln1184">// kate: tab-indents: off; indent-width 2; replace-tabs on; indent-mode cstyle; remove-trailing-spaces modified;</a>

</code></pre>
<div class="balloon" rel="127"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v522/" target="_blank">V522</a> There might be dereferencing of a potential null pointer 'arg'. Check lines: 127, 126.</p></div>
<div class="balloon" rel="136"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v522/" target="_blank">V522</a> There might be dereferencing of a potential null pointer 'ctx'. Check lines: 136, 134.</p></div>
<div class="balloon" rel="174"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v575/" target="_blank">V575</a> The null pointer is passed into 'g_list_free_full' function. Inspect the first argument.</p></div>
<div class="balloon" rel="198"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v522/" target="_blank">V522</a> There might be dereferencing of a potential null pointer 'account'. Check lines: 198, 196.</p></div>
<div class="balloon" rel="285"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v627/" target="_blank">V627</a> Consider inspecting the expression. The argument of sizeof() is the macro which expands to a number.</p></div>
<div class="balloon" rel="287"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v568/" target="_blank">V568</a> It's odd that 'sizeof()' operator evaluates the size of a pointer to a class, but not the size of the 'response' class object.</p></div>
<div class="balloon" rel="462"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v547/" target="_blank">V547</a> Expression 'ui->api->authenticated' is always true.</p></div>
<div class="balloon" rel="594"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v560/" target="_blank">V560</a> A part of conditional expression is always true: index == 0.</p></div>
<div class="balloon" rel="617"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v576/" target="_blank">V576</a> Incorrect format. Consider checking the seventh actual argument of the 'snprintf' function. The memsize type argument is expected.</p></div>
<div class="balloon" rel="649"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v576/" target="_blank">V576</a> Incorrect format. Consider checking the fourth actual argument of the 'snprintf' function. The memsize type argument is expected.</p></div>
<div class="balloon" rel="679"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v576/" target="_blank">V576</a> Incorrect format. Consider checking the fourth actual argument of the 'snprintf' function. The memsize type argument is expected.</p></div>
<div class="balloon" rel="1076"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v522/" target="_blank">V522</a> There might be dereferencing of a potential null pointer 'p->api'.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
