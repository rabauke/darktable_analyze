
<html>
<head>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>
<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2">    This file is part of darktable,</a>
<a name="ln3">    copyright (c) 2018 Pascal Obry</a>
<a name="ln4"> </a>
<a name="ln5">    darktable is free software: you can redistribute it and/or modify</a>
<a name="ln6">    it under the terms of the GNU General Public License as published by</a>
<a name="ln7">    the Free Software Foundation, either version 3 of the License, or</a>
<a name="ln8">    (at your option) any later version.</a>
<a name="ln9"> </a>
<a name="ln10">    darktable is distributed in the hope that it will be useful,</a>
<a name="ln11">    but WITHOUT ANY WARRANTY; without even the implied warranty of</a>
<a name="ln12">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</a>
<a name="ln13">    GNU General Public License for more details.</a>
<a name="ln14"> </a>
<a name="ln15">    You should have received a copy of the GNU General Public License</a>
<a name="ln16">    along with darktable.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</a>
<a name="ln17">*/</a>
<a name="ln18"> </a>
<a name="ln19">#include &quot;bauhaus/bauhaus.h&quot;</a>
<a name="ln20">#include &quot;common/darktable.h&quot;</a>
<a name="ln21">#include &quot;common/image.h&quot;</a>
<a name="ln22">#include &quot;common/image_cache.h&quot;</a>
<a name="ln23">#include &quot;common/imageio.h&quot;</a>
<a name="ln24">#include &quot;common/imageio_module.h&quot;</a>
<a name="ln25">#include &quot;common/metadata.h&quot;</a>
<a name="ln26">#include &quot;common/pwstorage/pwstorage.h&quot;</a>
<a name="ln27">#include &quot;common/tags.h&quot;</a>
<a name="ln28">#include &quot;common/curl_tools.h&quot;</a>
<a name="ln29">#include &quot;control/conf.h&quot;</a>
<a name="ln30">#include &quot;control/control.h&quot;</a>
<a name="ln31">#include &quot;dtgtk/button.h&quot;</a>
<a name="ln32">#include &quot;gui/gtk.h&quot;</a>
<a name="ln33">#include &quot;imageio/storage/imageio_storage_api.h&quot;</a>
<a name="ln34">#include &lt;curl/curl.h&gt;</a>
<a name="ln35">#include &lt;json-glib/json-glib.h&gt;</a>
<a name="ln36">#include &lt;stdio.h&gt;</a>
<a name="ln37">#include &lt;stdlib.h&gt;</a>
<a name="ln38">#include &lt;unistd.h&gt;</a>
<a name="ln39">#include &lt;inttypes.h&gt;</a>
<a name="ln40"> </a>
<a name="ln41">DT_MODULE(1)</a>
<a name="ln42"> </a>
<a name="ln43">#define piwigo_EXTRA_VERBOSE FALSE</a>
<a name="ln44"> </a>
<a name="ln45">#define MAX_ALBUM_NAME_SIZE 100</a>
<a name="ln46"> </a>
<a name="ln47">typedef struct _piwigo_api_context_t</a>
<a name="ln48">{</a>
<a name="ln49">  /// curl context</a>
<a name="ln50">  CURL *curl_ctx;</a>
<a name="ln51">  JsonParser *json_parser;</a>
<a name="ln52">  JsonObject *response;</a>
<a name="ln53">  gboolean authenticated;</a>
<a name="ln54">  gchar *cookie_file;</a>
<a name="ln55">  gchar *url;</a>
<a name="ln56"> </a>
<a name="ln57">  gchar *server;</a>
<a name="ln58">  gchar *username;</a>
<a name="ln59">  gchar *password;</a>
<a name="ln60">  gboolean error_occured;</a>
<a name="ln61">} _piwigo_api_context_t;</a>
<a name="ln62"> </a>
<a name="ln63">typedef struct _piwigo_album_t</a>
<a name="ln64">{</a>
<a name="ln65">  int64_t id;</a>
<a name="ln66">  char name[MAX_ALBUM_NAME_SIZE];</a>
<a name="ln67">  char label[MAX_ALBUM_NAME_SIZE];</a>
<a name="ln68">  int64_t size;</a>
<a name="ln69">} _piwigo_album_t;</a>
<a name="ln70"> </a>
<a name="ln71">typedef struct _piwigo_account_t</a>
<a name="ln72">{</a>
<a name="ln73">  gchar *server;</a>
<a name="ln74">  gchar *username;</a>
<a name="ln75">  gchar *password;</a>
<a name="ln76">} _piwigo_account_t;</a>
<a name="ln77"> </a>
<a name="ln78">typedef struct dt_storage_piwigo_gui_data_t</a>
<a name="ln79">{</a>
<a name="ln80">  GtkLabel *status_label;</a>
<a name="ln81">  GtkEntry *server_entry;</a>
<a name="ln82">  GtkEntry *user_entry, *pwd_entry, *new_album_entry;</a>
<a name="ln83">  GtkBox *create_box;                               // Create album options...</a>
<a name="ln84">  GtkWidget *permission_list, *export_tags;</a>
<a name="ln85">  GtkWidget *album_list, *parent_album_list;</a>
<a name="ln86">  GtkWidget *account_list;</a>
<a name="ln87"> </a>
<a name="ln88">  GList *albums;</a>
<a name="ln89">  GList *accounts;</a>
<a name="ln90"> </a>
<a name="ln91">  /** Current Piwigo context for the gui */</a>
<a name="ln92">  _piwigo_api_context_t *api;</a>
<a name="ln93">} dt_storage_piwigo_gui_data_t;</a>
<a name="ln94"> </a>
<a name="ln95">typedef struct _curl_args_t</a>
<a name="ln96">{</a>
<a name="ln97">  char name[100];</a>
<a name="ln98">  char value[512];</a>
<a name="ln99">} _curl_args_t;</a>
<a name="ln100"> </a>
<a name="ln101">typedef struct dt_storage_piwigo_params_t</a>
<a name="ln102">{</a>
<a name="ln103">  _piwigo_api_context_t *api;</a>
<a name="ln104">  int64_t album_id;</a>
<a name="ln105">  int64_t parent_album_id;</a>
<a name="ln106">  char *album;</a>
<a name="ln107">  gboolean new_album;</a>
<a name="ln108">  int privacy;</a>
<a name="ln109">  gboolean export_tags;</a>
<a name="ln110">  gchar *tags;</a>
<a name="ln111">} dt_storage_piwigo_params_t;</a>
<a name="ln112"> </a>
<a name="ln113">/* low-level routine doing the HTTP POST request */</a>
<a name="ln114">static void _piwigo_api_post(_piwigo_api_context_t *ctx, GList *args, char *filename, gboolean isauth);</a>
<a name="ln115"> </a>
<a name="ln116">static size_t curl_write_data_cb(void *ptr, size_t size, size_t nmemb, void *data)</a>
<a name="ln117">{</a>
<a name="ln118">  GString *string = (GString *)data;</a>
<a name="ln119">  g_string_append_len(string, ptr, size * nmemb);</a>
<a name="ln120">#if piwigo_EXTRA_VERBOSE == TRUE</a>
<a name="ln121">  g_printf(&quot;server reply: %s\n&quot;, string-&gt;str);</a>
<a name="ln122">#endif</a>
<a name="ln123">  return size * nmemb;</a>
<a name="ln124">}</a>
<a name="ln125"> </a>
<a name="ln126">static GList *_piwigo_query_add_arguments(GList *args, const char *name, const char *value)</a>
<a name="ln127">{</a>
<a name="ln128">  _curl_args_t *arg = malloc(sizeof(_curl_args_t));</a>
<a name="ln129">  g_strlcpy(arg-&gt;name, name, sizeof(arg-&gt;name));</a>
<a name="ln130">  g_strlcpy(arg-&gt;value, value, sizeof(arg-&gt;value));</a>
<a name="ln131">  return g_list_append(args, arg);</a>
<a name="ln132">}</a>
<a name="ln133"> </a>
<a name="ln134">static _piwigo_api_context_t *_piwigo_ctx_init(void)</a>
<a name="ln135">{</a>
<a name="ln136">  _piwigo_api_context_t *ctx = malloc(sizeof(struct _piwigo_api_context_t));</a>
<a name="ln137"> </a>
<a name="ln138">  ctx-&gt;curl_ctx = curl_easy_init();</a>
<a name="ln139">  ctx-&gt;json_parser = json_parser_new();</a>
<a name="ln140">  ctx-&gt;authenticated = FALSE;</a>
<a name="ln141">  ctx-&gt;url = NULL;</a>
<a name="ln142">  ctx-&gt;cookie_file = NULL;</a>
<a name="ln143">  ctx-&gt;error_occured = FALSE;</a>
<a name="ln144">  return ctx;</a>
<a name="ln145">}</a>
<a name="ln146"> </a>
<a name="ln147">static void _piwigo_ctx_destroy(_piwigo_api_context_t **ctx)</a>
<a name="ln148">{</a>
<a name="ln149">  if(*ctx)</a>
<a name="ln150">  {</a>
<a name="ln151">    curl_easy_cleanup((*ctx)-&gt;curl_ctx);</a>
<a name="ln152">    if((*ctx)-&gt;cookie_file) g_unlink((*ctx)-&gt;cookie_file);</a>
<a name="ln153">    g_object_unref((*ctx)-&gt;json_parser);</a>
<a name="ln154">    g_free((*ctx)-&gt;cookie_file);</a>
<a name="ln155">    g_free((*ctx)-&gt;url);</a>
<a name="ln156">    g_free((*ctx)-&gt;server);</a>
<a name="ln157">    g_free((*ctx)-&gt;username);</a>
<a name="ln158">    g_free((*ctx)-&gt;password);</a>
<a name="ln159">    free(*ctx);</a>
<a name="ln160">    *ctx = NULL;</a>
<a name="ln161">  }</a>
<a name="ln162">}</a>
<a name="ln163"> </a>
<a name="ln164">static void _piwigo_free_account(void *data)</a>
<a name="ln165">{</a>
<a name="ln166">  _piwigo_account_t *account = (_piwigo_account_t *)data;</a>
<a name="ln167">  g_free(account-&gt;server);</a>
<a name="ln168">  g_free(account-&gt;username);</a>
<a name="ln169">  g_free(account-&gt;password);</a>
<a name="ln170">}</a>
<a name="ln171"> </a>
<a name="ln172">static void _piwigo_load_account(dt_storage_piwigo_gui_data_t *ui)</a>
<a name="ln173">{</a>
<a name="ln174">  if(!ui-&gt;accounts)</a>
<a name="ln175">  {</a>
<a name="ln176">    g_list_free_full(ui-&gt;accounts, _piwigo_free_account);</a>
<a name="ln177">    ui-&gt;accounts = NULL;</a>
<a name="ln178">  }</a>
<a name="ln179"> </a>
<a name="ln180">  GHashTable *table = dt_pwstorage_get(&quot;piwigo&quot;);</a>
<a name="ln181">  GHashTableIter iter;</a>
<a name="ln182">  gpointer key, value;</a>
<a name="ln183"> </a>
<a name="ln184">  g_hash_table_iter_init (&amp;iter, table);</a>
<a name="ln185"> </a>
<a name="ln186">  while (g_hash_table_iter_next (&amp;iter, &amp;key, &amp;value))</a>
<a name="ln187">  {</a>
<a name="ln188">    if(key &amp;&amp; value)</a>
<a name="ln189">    {</a>
<a name="ln190">      gchar *data = (gchar *)value;</a>
<a name="ln191">      JsonParser *parser = json_parser_new();</a>
<a name="ln192">      json_parser_load_from_data(parser, data, strlen(data), NULL);</a>
<a name="ln193">      JsonNode *root = json_parser_get_root(parser);</a>
<a name="ln194"> </a>
<a name="ln195">      if(root)</a>
<a name="ln196">      {</a>
<a name="ln197">        JsonObject *obj = json_node_get_object(root);</a>
<a name="ln198">        _piwigo_account_t *account = malloc(sizeof(_piwigo_account_t));</a>
<a name="ln199"> </a>
<a name="ln200">        account-&gt;server =  g_strdup(json_object_get_string_member(obj, &quot;server&quot;));</a>
<a name="ln201">        account-&gt;username =  g_strdup(json_object_get_string_member(obj, &quot;username&quot;));</a>
<a name="ln202">        account-&gt;password =  g_strdup(json_object_get_string_member(obj, &quot;password&quot;));</a>
<a name="ln203"> </a>
<a name="ln204">        if(account-&gt;server &amp;&amp; strlen(account-&gt;server)&gt;0)</a>
<a name="ln205">          ui-&gt;accounts = g_list_append(ui-&gt;accounts, account);</a>
<a name="ln206">      }</a>
<a name="ln207"> </a>
<a name="ln208">      g_object_unref(parser);</a>
<a name="ln209">    }</a>
<a name="ln210">  }</a>
<a name="ln211"> </a>
<a name="ln212">  g_hash_table_destroy(table);</a>
<a name="ln213">}</a>
<a name="ln214"> </a>
<a name="ln215">static _piwigo_account_t *_piwigo_get_account(dt_storage_piwigo_gui_data_t *ui, const gchar *server)</a>
<a name="ln216">{</a>
<a name="ln217">  if(!server) return NULL;</a>
<a name="ln218"> </a>
<a name="ln219">  GList *a = ui-&gt;accounts;</a>
<a name="ln220"> </a>
<a name="ln221">  while(a)</a>
<a name="ln222">  {</a>
<a name="ln223">    _piwigo_account_t *account = (_piwigo_account_t *)a-&gt;data;;</a>
<a name="ln224">    if(account-&gt;server &amp;&amp; !strcmp(server, account-&gt;server)) return account;</a>
<a name="ln225">    a = g_list_next(a);</a>
<a name="ln226">  }</a>
<a name="ln227"> </a>
<a name="ln228">  return NULL;</a>
<a name="ln229">}</a>
<a name="ln230"> </a>
<a name="ln231">static void _piwigo_set_account(dt_storage_piwigo_gui_data_t *ui)</a>
<a name="ln232">{</a>
<a name="ln233">  /// serialize data;</a>
<a name="ln234">  JsonBuilder *builder = json_builder_new();</a>
<a name="ln235">  json_builder_begin_object(builder);</a>
<a name="ln236">  json_builder_set_member_name(builder, &quot;server&quot;);</a>
<a name="ln237">  json_builder_add_string_value(builder, gtk_entry_get_text(ui-&gt;server_entry));</a>
<a name="ln238">  json_builder_set_member_name(builder, &quot;username&quot;);</a>
<a name="ln239">  json_builder_add_string_value(builder, gtk_entry_get_text(ui-&gt;user_entry));</a>
<a name="ln240">  json_builder_set_member_name(builder, &quot;password&quot;);</a>
<a name="ln241">  json_builder_add_string_value(builder, gtk_entry_get_text(ui-&gt;pwd_entry));</a>
<a name="ln242"> </a>
<a name="ln243">  json_builder_end_object(builder);</a>
<a name="ln244"> </a>
<a name="ln245">  JsonNode *node = json_builder_get_root(builder);</a>
<a name="ln246">  JsonGenerator *generator = json_generator_new();</a>
<a name="ln247">  json_generator_set_root(generator, node);</a>
<a name="ln248">#if JSON_CHECK_VERSION(0, 14, 0)</a>
<a name="ln249">  json_generator_set_pretty(generator, FALSE);</a>
<a name="ln250">#endif</a>
<a name="ln251">  gchar *data = json_generator_to_data(generator, NULL);</a>
<a name="ln252"> </a>
<a name="ln253">  json_node_free(node);</a>
<a name="ln254">  g_object_unref(generator);</a>
<a name="ln255">  g_object_unref(builder);</a>
<a name="ln256"> </a>
<a name="ln257">  GHashTable *table = dt_pwstorage_get(&quot;piwigo&quot;);</a>
<a name="ln258">  g_hash_table_insert(table, g_strdup(gtk_entry_get_text(ui-&gt;server_entry)), data);</a>
<a name="ln259">  dt_pwstorage_set(&quot;piwigo&quot;, table);</a>
<a name="ln260">  g_hash_table_destroy(table);</a>
<a name="ln261">}</a>
<a name="ln262"> </a>
<a name="ln263">/** Set status connection text */</a>
<a name="ln264">static void _piwigo_set_status(dt_storage_piwigo_gui_data_t *ui, gchar *message, gchar *color)</a>
<a name="ln265">{</a>
<a name="ln266">  if(!color) color = &quot;#ffffff&quot;;</a>
<a name="ln267">  gchar mup[512] = { 0 };</a>
<a name="ln268">  snprintf(mup, sizeof(mup), &quot;&lt;span foreground=\&quot;%s\&quot; &gt;&lt;small&gt;%s&lt;/small&gt;&lt;/span&gt;&quot;, color, message);</a>
<a name="ln269">  gtk_label_set_markup(ui-&gt;status_label, mup);</a>
<a name="ln270">}</a>
<a name="ln271"> </a>
<a name="ln272">static int _piwigo_api_post_internal(_piwigo_api_context_t *ctx, GList *args, char *filename, gboolean isauth)</a>
<a name="ln273">{</a>
<a name="ln274">  curl_mime *form = NULL;</a>
<a name="ln275"> </a>
<a name="ln276">  GString *url = g_string_new(ctx-&gt;url);</a>
<a name="ln277"> </a>
<a name="ln278">  // send the requests</a>
<a name="ln279">  GString *response = g_string_new(&quot;&quot;);</a>
<a name="ln280"> </a>
<a name="ln281">  dt_curl_init(ctx-&gt;curl_ctx, piwigo_EXTRA_VERBOSE);</a>
<a name="ln282"> </a>
<a name="ln283">  curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_URL, url-&gt;str);</a>
<a name="ln284">  curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_POST, 1);</a>
<a name="ln285">  curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_WRITEFUNCTION, curl_write_data_cb);</a>
<a name="ln286">  curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_WRITEDATA, response);</a>
<a name="ln287"> </a>
<a name="ln288">  if(isauth)</a>
<a name="ln289">  {</a>
<a name="ln290">    /* construct a temporary file name */</a>
<a name="ln291">    char cookie_fmt[PATH_MAX] = { 0 };</a>
<a name="ln292">    dt_loc_get_tmp_dir(cookie_fmt, sizeof(cookie_fmt));</a>
<a name="ln293">    g_strlcat(cookie_fmt, &quot;/cookies.%.4lf.txt&quot;, sizeof(cookie_fmt));</a>
<a name="ln294"> </a>
<a name="ln295">    ctx-&gt;cookie_file = g_strdup_printf(cookie_fmt, dt_get_wtime());</a>
<a name="ln296"> </a>
<a name="ln297">    // not that this is safe as the cookie file is written only when the curl context is finalized.</a>
<a name="ln298">    // At this stage we unlink the file.</a>
<a name="ln299">    curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_COOKIEJAR, ctx-&gt;cookie_file);</a>
<a name="ln300">  }</a>
<a name="ln301">  else</a>
<a name="ln302">  {</a>
<a name="ln303">    curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_COOKIEFILE, ctx-&gt;cookie_file);</a>
<a name="ln304">  }</a>
<a name="ln305"> </a>
<a name="ln306">  if(filename)</a>
<a name="ln307">  {</a>
<a name="ln308">    curl_mimepart *field = NULL;</a>
<a name="ln309"> </a>
<a name="ln310">    form = curl_mime_init(ctx-&gt;curl_ctx);</a>
<a name="ln311"> </a>
<a name="ln312">    GList *a = args;</a>
<a name="ln313"> </a>
<a name="ln314">    while (a)</a>
<a name="ln315">    {</a>
<a name="ln316">      _curl_args_t *ca = (_curl_args_t *)a-&gt;data;</a>
<a name="ln317">      field = curl_mime_addpart(form);</a>
<a name="ln318">      curl_mime_name(field, ca-&gt;name);</a>
<a name="ln319">      curl_mime_data(field, ca-&gt;value, CURL_ZERO_TERMINATED);</a>
<a name="ln320">      a = g_list_next(a);</a>
<a name="ln321">    }</a>
<a name="ln322"> </a>
<a name="ln323">    field = curl_mime_addpart(form);</a>
<a name="ln324">    curl_mime_name(field, &quot;image&quot;);</a>
<a name="ln325">    curl_mime_filedata(field, filename);</a>
<a name="ln326"> </a>
<a name="ln327">    curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_MIMEPOST, form);</a>
<a name="ln328">  }</a>
<a name="ln329">  else</a>
<a name="ln330">  {</a>
<a name="ln331">    GString *gargs = g_string_new(&quot;&quot;);</a>
<a name="ln332"> </a>
<a name="ln333">    GList *a = args;</a>
<a name="ln334"> </a>
<a name="ln335">    while (a)</a>
<a name="ln336">    {</a>
<a name="ln337">      _curl_args_t *ca = (_curl_args_t *)a-&gt;data;</a>
<a name="ln338">      if(a!=args) g_string_append(gargs, &quot;&amp;&quot;);</a>
<a name="ln339">      g_string_append(gargs, ca-&gt;name);</a>
<a name="ln340">      g_string_append(gargs, &quot;=&quot;);</a>
<a name="ln341">      g_string_append(gargs, ca-&gt;value);</a>
<a name="ln342"> </a>
<a name="ln343">      a = g_list_next(a);</a>
<a name="ln344">    }</a>
<a name="ln345"> </a>
<a name="ln346">    curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_COPYPOSTFIELDS, gargs-&gt;str);</a>
<a name="ln347">    g_string_free(gargs, TRUE);</a>
<a name="ln348">  }</a>
<a name="ln349"> </a>
<a name="ln350">  int res = curl_easy_perform(ctx-&gt;curl_ctx);</a>
<a name="ln351"> </a>
<a name="ln352">#if piwigo_EXTRA_VERBOSE == TRUE</a>
<a name="ln353">  g_printf(&quot;curl_easy_perform status %d\n&quot;, res);</a>
<a name="ln354">#endif</a>
<a name="ln355"> </a>
<a name="ln356">  if(filename) curl_mime_free(form);</a>
<a name="ln357"> </a>
<a name="ln358">  g_string_free(url, TRUE);</a>
<a name="ln359"> </a>
<a name="ln360">  ctx-&gt;response = NULL;</a>
<a name="ln361"> </a>
<a name="ln362">  if(res == CURLE_OK)</a>
<a name="ln363">  {</a>
<a name="ln364">    GError *error = NULL;</a>
<a name="ln365">    gboolean ret = json_parser_load_from_data(ctx-&gt;json_parser, response-&gt;str, response-&gt;len, &amp;error);</a>
<a name="ln366">    if(!ret) goto cleanup;</a>
<a name="ln367">    JsonNode *root = json_parser_get_root(ctx-&gt;json_parser);</a>
<a name="ln368">    // we should always have a dict</a>
<a name="ln369">    if(json_node_get_node_type(root) != JSON_NODE_OBJECT) goto cleanup;</a>
<a name="ln370">    ctx-&gt;response = json_node_get_object(root);</a>
<a name="ln371">    const char *status = json_object_get_string_member(ctx-&gt;response, &quot;stat&quot;);</a>
<a name="ln372">    ctx-&gt;error_occured = (status &amp;&amp; (strcmp(status,&quot;fail&quot;)==0));</a>
<a name="ln373">  }</a>
<a name="ln374">  else</a>
<a name="ln375">    ctx-&gt;error_occured = TRUE;</a>
<a name="ln376"> </a>
<a name="ln377"> cleanup:</a>
<a name="ln378">  g_string_free(response, TRUE);</a>
<a name="ln379">  return res;</a>
<a name="ln380">}</a>
<a name="ln381"> </a>
<a name="ln382">static void _piwigo_api_authenticate(_piwigo_api_context_t *ctx)</a>
<a name="ln383">{</a>
<a name="ln384">  GList *args = NULL;</a>
<a name="ln385"> </a>
<a name="ln386">  args = _piwigo_query_add_arguments(args, &quot;method&quot;, &quot;pwg.session.login&quot;);</a>
<a name="ln387">  args = _piwigo_query_add_arguments(args, &quot;username&quot;, ctx-&gt;username);</a>
<a name="ln388">  args = _piwigo_query_add_arguments(args, &quot;password&quot;, ctx-&gt;password);</a>
<a name="ln389">  if(!strcmp(ctx-&gt;server, &quot;piwigo.com&quot;))</a>
<a name="ln390">    ctx-&gt;url = g_strdup_printf(&quot;https://%s.piwigo.com/ws.php?format=json&quot;, ctx-&gt;username);</a>
<a name="ln391">  else if(strstr(ctx-&gt;server, &quot;http&quot;) == ctx-&gt;server)</a>
<a name="ln392">    ctx-&gt;url = g_strdup_printf(&quot;%s/ws.php?format=json&quot;, ctx-&gt;server);</a>
<a name="ln393">  else</a>
<a name="ln394">    ctx-&gt;url = g_strdup_printf(&quot;https://%s/ws.php?format=json&quot;, ctx-&gt;server);</a>
<a name="ln395"> </a>
<a name="ln396">  _piwigo_api_post(ctx, args, NULL, TRUE);</a>
<a name="ln397"> </a>
<a name="ln398">  g_list_free(args);</a>
<a name="ln399">}</a>
<a name="ln400"> </a>
<a name="ln401">static void _piwigo_api_post(_piwigo_api_context_t *ctx, GList *args, char *filename, gboolean isauth)</a>
<a name="ln402">{</a>
<a name="ln403">  int res = _piwigo_api_post_internal(ctx, args, filename, isauth);</a>
<a name="ln404"> </a>
<a name="ln405">  if(res == CURLE_COULDNT_CONNECT || res == CURLE_SSL_CONNECT_ERROR)</a>
<a name="ln406">  {</a>
<a name="ln407">#if piwigo_EXTRA_VERBOSE == TRUE</a>
<a name="ln408">    g_printf(&quot;curl post error (%d), try authentication again\n&quot;, res);</a>
<a name="ln409">#endif</a>
<a name="ln410"> </a>
<a name="ln411">    //  recreate a new CURL connection</a>
<a name="ln412">    curl_easy_cleanup(ctx-&gt;curl_ctx);</a>
<a name="ln413">    ctx-&gt;curl_ctx = curl_easy_init();</a>
<a name="ln414">    ctx-&gt;authenticated = FALSE;</a>
<a name="ln415"> </a>
<a name="ln416">    if(!isauth)</a>
<a name="ln417">    {</a>
<a name="ln418">      // an error during the curl post command, could be an authentication issue, try to authenticate again</a>
<a name="ln419">      // but only if this is not an authentication post, otherwise this will happen below anyway.</a>
<a name="ln420">      _piwigo_api_authenticate(ctx);</a>
<a name="ln421">    }</a>
<a name="ln422"> </a>
<a name="ln423">    // authentication ok, send again</a>
<a name="ln424">    if(ctx-&gt;response &amp;&amp; !ctx-&gt;error_occured)</a>
<a name="ln425">    {</a>
<a name="ln426">      ctx-&gt;authenticated = TRUE;</a>
<a name="ln427">#if piwigo_EXTRA_VERBOSE == TRUE</a>
<a name="ln428">      g_printf(&quot;authenticated again, retry\n&quot;);</a>
<a name="ln429">#endif</a>
<a name="ln430">      res = _piwigo_api_post_internal(ctx, args, filename, isauth);</a>
<a name="ln431">#if piwigo_EXTRA_VERBOSE == TRUE</a>
<a name="ln432">      g_printf(&quot;second post exit with status %d\n&quot;, res);</a>
<a name="ln433">#endif</a>
<a name="ln434">    }</a>
<a name="ln435">    else</a>
<a name="ln436">    {</a>
<a name="ln437">#if piwigo_EXTRA_VERBOSE == TRUE</a>
<a name="ln438">      g_printf(&quot;failed second authentication\n&quot;);</a>
<a name="ln439">#endif</a>
<a name="ln440">    }</a>
<a name="ln441">  }</a>
<a name="ln442">}</a>
<a name="ln443"> </a>
<a name="ln444">static void _piwigo_authenticate(dt_storage_piwigo_gui_data_t *ui)</a>
<a name="ln445">{</a>
<a name="ln446">  if(!ui-&gt;api) ui-&gt;api = _piwigo_ctx_init();</a>
<a name="ln447"> </a>
<a name="ln448">  ui-&gt;api-&gt;server = g_strdup(gtk_entry_get_text(ui-&gt;server_entry));</a>
<a name="ln449">  ui-&gt;api-&gt;username = g_strdup(gtk_entry_get_text(ui-&gt;user_entry));</a>
<a name="ln450">  ui-&gt;api-&gt;password = g_strdup(gtk_entry_get_text(ui-&gt;pwd_entry));</a>
<a name="ln451"> </a>
<a name="ln452">  _piwigo_api_authenticate(ui-&gt;api);</a>
<a name="ln453"> </a>
<a name="ln454">  ui-&gt;api-&gt;authenticated = FALSE;</a>
<a name="ln455"> </a>
<a name="ln456">  if(ui-&gt;api-&gt;response &amp;&amp; !ui-&gt;api-&gt;error_occured)</a>
<a name="ln457">  {</a>
<a name="ln458">    ui-&gt;api-&gt;authenticated = TRUE;</a>
<a name="ln459">    gtk_widget_set_sensitive(GTK_WIDGET(ui-&gt;album_list), ui-&gt;api-&gt;authenticated);</a>
<a name="ln460"> </a>
<a name="ln461">    if(ui-&gt;api-&gt;authenticated)</a>
<a name="ln462">    {</a>
<a name="ln463">      _piwigo_set_status(ui, _(&quot;authenticated&quot;), &quot;#7fe07f&quot;);</a>
<a name="ln464">      dt_conf_set_string(&quot;plugins/imageio/storage/export/piwigo/server&quot;, ui-&gt;api-&gt;server);</a>
<a name="ln465">      _piwigo_set_account(ui);</a>
<a name="ln466">    }</a>
<a name="ln467">    else</a>
<a name="ln468">    {</a>
<a name="ln469">      const gchar *errormessage = json_object_get_string_member(ui-&gt;api-&gt;response, &quot;message&quot;);</a>
<a name="ln470">      fprintf(stderr, &quot;[imageio_storage_piwigo] could not authenticate: `%s'!\n&quot;, errormessage);</a>
<a name="ln471">      _piwigo_set_status(ui, _(&quot;not authenticated&quot;), &quot;#e07f7f&quot;);</a>
<a name="ln472">      _piwigo_ctx_destroy(&amp;ui-&gt;api);</a>
<a name="ln473">    }</a>
<a name="ln474">  }</a>
<a name="ln475">  else</a>
<a name="ln476">  {</a>
<a name="ln477">    _piwigo_set_status(ui, _(&quot;not authenticated, cannot reach server&quot;), &quot;#e07f7f&quot;);</a>
<a name="ln478">    _piwigo_ctx_destroy(&amp;ui-&gt;api);</a>
<a name="ln479">  }</a>
<a name="ln480">}</a>
<a name="ln481"> </a>
<a name="ln482">static void _piwigo_entry_changed(GtkEntry *entry, gpointer data)</a>
<a name="ln483">{</a>
<a name="ln484">  dt_storage_piwigo_gui_data_t *ui = (dt_storage_piwigo_gui_data_t *)data;</a>
<a name="ln485"> </a>
<a name="ln486">  _piwigo_set_status(ui, _(&quot;not authenticated&quot;), &quot;#e07f7f&quot;);</a>
<a name="ln487">    gtk_widget_set_sensitive(GTK_WIDGET(ui-&gt;album_list), FALSE);</a>
<a name="ln488"> </a>
<a name="ln489">  if(ui-&gt;api) _piwigo_ctx_destroy(&amp;ui-&gt;api);</a>
<a name="ln490">}</a>
<a name="ln491"> </a>
<a name="ln492">static void _piwigo_server_entry_changed(GtkEntry *entry, gpointer data)</a>
<a name="ln493">{</a>
<a name="ln494">  dt_storage_piwigo_gui_data_t *ui = (dt_storage_piwigo_gui_data_t *)data;</a>
<a name="ln495"> </a>
<a name="ln496">  if(ui-&gt;api)</a>
<a name="ln497">  {</a>
<a name="ln498">    _piwigo_set_status(ui, _(&quot;not authenticated&quot;), &quot;#e07f7f&quot;);</a>
<a name="ln499">    _piwigo_ctx_destroy(&amp;ui-&gt;api);</a>
<a name="ln500">    gtk_widget_set_sensitive(GTK_WIDGET(ui-&gt;album_list), FALSE);</a>
<a name="ln501">  }</a>
<a name="ln502">}</a>
<a name="ln503"> </a>
<a name="ln504">static void _piwigo_account_changed(GtkComboBox *cb, gpointer data)</a>
<a name="ln505">{</a>
<a name="ln506">  dt_storage_piwigo_gui_data_t *ui = (dt_storage_piwigo_gui_data_t *)data;</a>
<a name="ln507">  const gchar *value = dt_bauhaus_combobox_get_text(ui-&gt;account_list);</a>
<a name="ln508">  const _piwigo_account_t *account = _piwigo_get_account(ui, value);</a>
<a name="ln509"> </a>
<a name="ln510">  if(account)</a>
<a name="ln511">  {</a>
<a name="ln512">    gtk_entry_set_text(ui-&gt;server_entry, account-&gt;server);</a>
<a name="ln513">    gtk_entry_set_text(ui-&gt;user_entry, account-&gt;username);</a>
<a name="ln514">    gtk_entry_set_text(ui-&gt;pwd_entry, account-&gt;password);</a>
<a name="ln515">  }</a>
<a name="ln516">}</a>
<a name="ln517"> </a>
<a name="ln518">static void _piwigo_album_changed(GtkComboBox *cb, gpointer data)</a>
<a name="ln519">{</a>
<a name="ln520">  dt_storage_piwigo_gui_data_t *ui = (dt_storage_piwigo_gui_data_t *)data;</a>
<a name="ln521">  const gchar *value = dt_bauhaus_combobox_get_text(ui-&gt;album_list);</a>
<a name="ln522"> </a>
<a name="ln523">  if(value != NULL &amp;&amp; strcmp(value, _(&quot;create new album&quot;)) == 0)</a>
<a name="ln524">  {</a>
<a name="ln525">    gtk_widget_set_no_show_all(GTK_WIDGET(ui-&gt;create_box), FALSE);</a>
<a name="ln526">    gtk_widget_show_all(GTK_WIDGET(ui-&gt;create_box));</a>
<a name="ln527">  }</a>
<a name="ln528">  else</a>
<a name="ln529">    gtk_widget_hide(GTK_WIDGET(ui-&gt;create_box));</a>
<a name="ln530">}</a>
<a name="ln531"> </a>
<a name="ln532">/** Refresh albums */</a>
<a name="ln533">static void _piwigo_refresh_albums(dt_storage_piwigo_gui_data_t *ui, const gchar *select_album)</a>
<a name="ln534">{</a>
<a name="ln535">  gtk_widget_set_sensitive(GTK_WIDGET(ui-&gt;album_list), FALSE);</a>
<a name="ln536">  gtk_widget_set_sensitive(GTK_WIDGET(ui-&gt;parent_album_list), FALSE);</a>
<a name="ln537"> </a>
<a name="ln538">  if(ui-&gt;api == NULL || ui-&gt;api-&gt;authenticated == FALSE)</a>
<a name="ln539">  {</a>
<a name="ln540">    _piwigo_authenticate(ui);</a>
<a name="ln541">    if(ui-&gt;api == NULL || !ui-&gt;api-&gt;authenticated) return;</a>
<a name="ln542">  }</a>
<a name="ln543"> </a>
<a name="ln544">  gchar *to_select;</a>
<a name="ln545">  int index = 0;</a>
<a name="ln546"> </a>
<a name="ln547">  // get the new album name, it will be checked in the</a>
<a name="ln548">  if(select_album == NULL)</a>
<a name="ln549">  {</a>
<a name="ln550">    to_select = g_strdup(dt_bauhaus_combobox_get_text(ui-&gt;album_list));</a>
<a name="ln551">    if(to_select)</a>
<a name="ln552">    {</a>
<a name="ln553">      // cut the count of picture in album to get the name only</a>
<a name="ln554">      gchar *p = to_select;</a>
<a name="ln555">      while(*p)</a>
<a name="ln556">      {</a>
<a name="ln557">        if(*p == ' ' &amp;&amp; *(p+1) == '(')</a>
<a name="ln558">        {</a>
<a name="ln559">          *p = '\0';</a>
<a name="ln560">          break;</a>
<a name="ln561">        }</a>
<a name="ln562">        p++;</a>
<a name="ln563">      }</a>
<a name="ln564">    }</a>
<a name="ln565">  }</a>
<a name="ln566">  else</a>
<a name="ln567">    to_select = g_strdup(select_album);</a>
<a name="ln568"> </a>
<a name="ln569">  // First clear the combobox except first 2 items (none / create new album)</a>
<a name="ln570">  dt_bauhaus_combobox_clear(ui-&gt;album_list);</a>
<a name="ln571">  dt_bauhaus_combobox_clear(ui-&gt;parent_album_list);</a>
<a name="ln572">  g_list_free(ui-&gt;albums);</a>
<a name="ln573">  ui-&gt;albums = NULL;</a>
<a name="ln574"> </a>
<a name="ln575">  GList *args = NULL;</a>
<a name="ln576"> </a>
<a name="ln577">  args = _piwigo_query_add_arguments(args, &quot;method&quot;, &quot;pwg.categories.getList&quot;);</a>
<a name="ln578">  args = _piwigo_query_add_arguments(args, &quot;cat_id&quot;, &quot;0&quot;);</a>
<a name="ln579">  args = _piwigo_query_add_arguments(args, &quot;recursive&quot;, &quot;true&quot;);</a>
<a name="ln580"> </a>
<a name="ln581">  _piwigo_api_post(ui-&gt;api, args, NULL, FALSE);</a>
<a name="ln582"> </a>
<a name="ln583">  g_list_free(args);</a>
<a name="ln584"> </a>
<a name="ln585">  if(ui-&gt;api-&gt;response &amp;&amp; !ui-&gt;api-&gt;error_occured)</a>
<a name="ln586">  {</a>
<a name="ln587">    dt_bauhaus_combobox_add(ui-&gt;album_list, _(&quot;create new album&quot;));</a>
<a name="ln588">    dt_bauhaus_combobox_add(ui-&gt;parent_album_list, _(&quot;---&quot;));</a>
<a name="ln589"> </a>
<a name="ln590">    JsonObject *result = json_node_get_object(json_object_get_member(ui-&gt;api-&gt;response, &quot;result&quot;));</a>
<a name="ln591">    JsonArray *albums = json_object_get_array_member(result, &quot;categories&quot;);</a>
<a name="ln592"> </a>
<a name="ln593">    if(json_array_get_length(albums)&gt;0 &amp;&amp; index==0) index = 1;</a>
<a name="ln594">    if(index &gt; json_array_get_length(albums) - 1) index = json_array_get_length(albums) - 1;</a>
<a name="ln595"> </a>
<a name="ln596">    for(int i = 0; i &lt; json_array_get_length(albums); i++)</a>
<a name="ln597">    {</a>
<a name="ln598">      char data[MAX_ALBUM_NAME_SIZE] = { 0 };</a>
<a name="ln599">      JsonObject *album = json_array_get_object_element(albums, i);</a>
<a name="ln600"> </a>
<a name="ln601">      _piwigo_album_t *new_album = g_malloc0(sizeof(struct _piwigo_album_t));</a>
<a name="ln602"> </a>
<a name="ln603">      g_strlcpy(new_album-&gt;name, json_object_get_string_member(album, &quot;name&quot;), sizeof(new_album-&gt;name));</a>
<a name="ln604">      new_album-&gt;id = json_object_get_int_member(album, &quot;id&quot;);</a>
<a name="ln605">      new_album-&gt;size = json_object_get_int_member(album, &quot;nb_images&quot;);</a>
<a name="ln606">      const int isroot = json_object_get_null_member(album, &quot;id_uppercat&quot;);</a>
<a name="ln607">      int indent = 0;</a>
<a name="ln608"> </a>
<a name="ln609">      if(!isroot)</a>
<a name="ln610">      {</a>
<a name="ln611">        const char *hierarchy = json_object_get_string_member(album, &quot;uppercats&quot;);</a>
<a name="ln612">        char const *p = hierarchy;</a>
<a name="ln613">        while(*p++) if(*p == ',') indent++;</a>
<a name="ln614">      }</a>
<a name="ln615"> </a>
<a name="ln616">      snprintf(data, sizeof(data), &quot;%*c%s (%&quot;PRId64&quot;)&quot;, indent * 3, ' ', new_album-&gt;name, new_album-&gt;size);</a>
<a name="ln617"> </a>
<a name="ln618">      if(to_select &amp;&amp; !strcmp(new_album-&gt;name, to_select)) index = i + 1;</a>
<a name="ln619"> </a>
<a name="ln620">      g_strlcpy(new_album-&gt;label, data, sizeof(new_album-&gt;label));</a>
<a name="ln621"> </a>
<a name="ln622">      ui-&gt;albums = g_list_append(ui-&gt;albums, new_album);</a>
<a name="ln623"> </a>
<a name="ln624">      dt_bauhaus_combobox_add_aligned(ui-&gt;album_list, data, DT_BAUHAUS_COMBOBOX_ALIGN_LEFT);</a>
<a name="ln625">      dt_bauhaus_combobox_add_aligned(ui-&gt;parent_album_list, data, DT_BAUHAUS_COMBOBOX_ALIGN_LEFT);</a>
<a name="ln626">    }</a>
<a name="ln627">  }</a>
<a name="ln628">  else</a>
<a name="ln629">    dt_control_log(_(&quot;cannot refresh albums&quot;));</a>
<a name="ln630"> </a>
<a name="ln631">  g_free(to_select);</a>
<a name="ln632"> </a>
<a name="ln633">  gtk_widget_set_sensitive(GTK_WIDGET(ui-&gt;album_list), TRUE);</a>
<a name="ln634">  gtk_widget_set_sensitive(GTK_WIDGET(ui-&gt;parent_album_list), TRUE);</a>
<a name="ln635">  dt_bauhaus_combobox_set(ui-&gt;album_list, index);</a>
<a name="ln636">}</a>
<a name="ln637"> </a>
<a name="ln638"> </a>
<a name="ln639">static const gboolean _piwigo_api_create_new_album(dt_storage_piwigo_params_t *p)</a>
<a name="ln640">{</a>
<a name="ln641">  GList *args = NULL;</a>
<a name="ln642"> </a>
<a name="ln643">  args = _piwigo_query_add_arguments(args, &quot;method&quot;, &quot;pwg.categories.add&quot;);</a>
<a name="ln644">  args = _piwigo_query_add_arguments(args, &quot;name&quot;, p-&gt;album);</a>
<a name="ln645">  if(p-&gt;parent_album_id != 0)</a>
<a name="ln646">  {</a>
<a name="ln647">    char pid[100];</a>
<a name="ln648">    snprintf(pid, sizeof(pid), &quot;%&quot;PRId64, p-&gt;parent_album_id);</a>
<a name="ln649">    args = _piwigo_query_add_arguments(args, &quot;parent&quot;, pid);</a>
<a name="ln650">  }</a>
<a name="ln651">  args = _piwigo_query_add_arguments(args, &quot;status&quot;, p-&gt;privacy==0?&quot;public&quot;:&quot;private&quot;);</a>
<a name="ln652"> </a>
<a name="ln653">  _piwigo_api_post(p-&gt;api, args, NULL, FALSE);</a>
<a name="ln654"> </a>
<a name="ln655">  g_list_free(args);</a>
<a name="ln656"> </a>
<a name="ln657">  if (!p-&gt;api-&gt;response || p-&gt;api-&gt;error_occured)</a>
<a name="ln658">  {</a>
<a name="ln659">    return FALSE;</a>
<a name="ln660">  }</a>
<a name="ln661">  else</a>
<a name="ln662">  {</a>
<a name="ln663">    JsonObject *result = json_node_get_object(json_object_get_member(p-&gt;api-&gt;response, &quot;result&quot;));</a>
<a name="ln664">    // set new album id in paremeter</a>
<a name="ln665">    p-&gt;album_id = json_object_get_int_member(result, &quot;id&quot;);</a>
<a name="ln666">  }</a>
<a name="ln667"> </a>
<a name="ln668">  return TRUE;</a>
<a name="ln669">}</a>
<a name="ln670"> </a>
<a name="ln671">static const gboolean _piwigo_api_upload_photo(dt_storage_piwigo_params_t *p, gchar *fname,</a>
<a name="ln672">                                               gchar *author, gchar *caption, gchar *description)</a>
<a name="ln673">{</a>
<a name="ln674">  GList *args = NULL;</a>
<a name="ln675">  char cat[10];</a>
<a name="ln676">  char privacy[10];</a>
<a name="ln677"> </a>
<a name="ln678">  snprintf(cat, sizeof(cat), &quot;%&quot;PRId64, p-&gt;album_id);</a>
<a name="ln679">  snprintf(privacy, sizeof(privacy), &quot;%d&quot;, p-&gt;privacy);</a>
<a name="ln680"> </a>
<a name="ln681">  args = _piwigo_query_add_arguments(args, &quot;method&quot;, &quot;pwg.images.addSimple&quot;);</a>
<a name="ln682">  args = _piwigo_query_add_arguments(args, &quot;image&quot;, fname);</a>
<a name="ln683">  args = _piwigo_query_add_arguments(args, &quot;category&quot;, cat);</a>
<a name="ln684">  args = _piwigo_query_add_arguments(args, &quot;level&quot;, privacy);</a>
<a name="ln685"> </a>
<a name="ln686">  if(caption &amp;&amp; strlen(caption)&gt;0)</a>
<a name="ln687">    args = _piwigo_query_add_arguments(args, &quot;name&quot;, caption);</a>
<a name="ln688"> </a>
<a name="ln689">  if(author &amp;&amp; strlen(author)&gt;0)</a>
<a name="ln690">    args = _piwigo_query_add_arguments(args, &quot;author&quot;, author);</a>
<a name="ln691"> </a>
<a name="ln692">  if(description &amp;&amp; strlen(description)&gt;0)</a>
<a name="ln693">    args = _piwigo_query_add_arguments(args, &quot;comment&quot;, description);</a>
<a name="ln694"> </a>
<a name="ln695">  if(p-&gt;export_tags &amp;&amp; p-&gt;tags &amp;&amp; strlen(p-&gt;tags)&gt;0)</a>
<a name="ln696">    args = _piwigo_query_add_arguments(args, &quot;tags&quot;, p-&gt;tags);</a>
<a name="ln697"> </a>
<a name="ln698">  _piwigo_api_post(p-&gt;api, args, fname, FALSE);</a>
<a name="ln699"> </a>
<a name="ln700">  g_list_free(args);</a>
<a name="ln701"> </a>
<a name="ln702">  return !p-&gt;api-&gt;error_occured;</a>
<a name="ln703">}</a>
<a name="ln704"> </a>
<a name="ln705">// Login button pressed...</a>
<a name="ln706">static void _piwigo_login_clicked(GtkButton *button, gpointer data)</a>
<a name="ln707">{</a>
<a name="ln708">  dt_storage_piwigo_gui_data_t *ui = (dt_storage_piwigo_gui_data_t *)data;</a>
<a name="ln709">  _piwigo_ctx_destroy(&amp;ui-&gt;api);</a>
<a name="ln710">  _piwigo_refresh_albums(ui, NULL);</a>
<a name="ln711">}</a>
<a name="ln712"> </a>
<a name="ln713">// Refresh button pressed...</a>
<a name="ln714">static void _piwigo_refresh_clicked(GtkButton *button, gpointer data)</a>
<a name="ln715">{</a>
<a name="ln716">  dt_storage_piwigo_gui_data_t *ui = (dt_storage_piwigo_gui_data_t *)data;</a>
<a name="ln717">  _piwigo_refresh_albums(ui, NULL);</a>
<a name="ln718">}</a>
<a name="ln719"> </a>
<a name="ln720">const char *name(const struct dt_imageio_module_storage_t *self)</a>
<a name="ln721">{</a>
<a name="ln722">  return _(&quot;piwigo&quot;);</a>
<a name="ln723">}</a>
<a name="ln724"> </a>
<a name="ln725">void gui_init(dt_imageio_module_storage_t *self)</a>
<a name="ln726">{</a>
<a name="ln727">  self-&gt;gui_data = (dt_storage_piwigo_gui_data_t *)g_malloc0(sizeof(dt_storage_piwigo_gui_data_t));</a>
<a name="ln728">  dt_storage_piwigo_gui_data_t *ui = self-&gt;gui_data;</a>
<a name="ln729"> </a>
<a name="ln730">  ui-&gt;albums = NULL;</a>
<a name="ln731">  ui-&gt;accounts = NULL;</a>
<a name="ln732">  ui-&gt;api = NULL;</a>
<a name="ln733"> </a>
<a name="ln734">  self-&gt;widget = gtk_box_new(GTK_ORIENTATION_VERTICAL, DT_PIXEL_APPLY_DPI(8));</a>
<a name="ln735"> </a>
<a name="ln736">  _piwigo_load_account(ui);</a>
<a name="ln737"> </a>
<a name="ln738">  gchar *server = dt_conf_get_string(&quot;plugins/imageio/storage/export/piwigo/server&quot;);</a>
<a name="ln739"> </a>
<a name="ln740">  // look for last server information</a>
<a name="ln741">  _piwigo_account_t *last_account = _piwigo_get_account(ui, server);</a>
<a name="ln742"> </a>
<a name="ln743">  GtkWidget *hbox, *label, *button;</a>
<a name="ln744"> </a>
<a name="ln745">  // account</a>
<a name="ln746">  ui-&gt;account_list = dt_bauhaus_combobox_new(NULL);</a>
<a name="ln747">  dt_bauhaus_widget_set_label(ui-&gt;account_list, NULL, _(&quot;accounts&quot;));</a>
<a name="ln748">  GList *a = ui-&gt;accounts;</a>
<a name="ln749">  int account_index = -1, index=0;</a>
<a name="ln750">  while(a)</a>
<a name="ln751">  {</a>
<a name="ln752">    _piwigo_account_t *account = (_piwigo_account_t *)a-&gt;data;</a>
<a name="ln753">    dt_bauhaus_combobox_add(ui-&gt;account_list, account-&gt;server);</a>
<a name="ln754">    if(!strcmp(account-&gt;server, server)) account_index = index;</a>
<a name="ln755">    index++;</a>
<a name="ln756">    a = g_list_next(a);</a>
<a name="ln757">  }</a>
<a name="ln758">  gtk_widget_set_hexpand(ui-&gt;account_list, TRUE);</a>
<a name="ln759">  g_signal_connect(G_OBJECT(ui-&gt;account_list), &quot;value-changed&quot;, G_CALLBACK(_piwigo_account_changed), (gpointer)ui);</a>
<a name="ln760">  gtk_box_pack_start(GTK_BOX(self-&gt;widget), ui-&gt;account_list, FALSE, FALSE, 0);</a>
<a name="ln761"> </a>
<a name="ln762">  // server</a>
<a name="ln763">  hbox = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, DT_PIXEL_APPLY_DPI(8));</a>
<a name="ln764">  label = gtk_label_new(_(&quot;server&quot;));</a>
<a name="ln765">  g_object_set(G_OBJECT(label), &quot;xalign&quot;, 0.0, (gchar *)0);</a>
<a name="ln766">  ui-&gt;server_entry = GTK_ENTRY(gtk_entry_new());</a>
<a name="ln767">  gtk_widget_set_tooltip_text(GTK_WIDGET(ui-&gt;server_entry),</a>
<a name="ln768">                              _(&quot;the server name\ndefault protocol is https\nspecify http:// if non secure server&quot;));</a>
<a name="ln769">  gtk_widget_set_hexpand(GTK_WIDGET(ui-&gt;server_entry), TRUE);</a>
<a name="ln770">  dt_gui_key_accel_block_on_focus_connect(GTK_WIDGET(ui-&gt;server_entry));</a>
<a name="ln771">  gtk_entry_set_text(ui-&gt;server_entry, last_account?last_account-&gt;server:&quot;piwigo.com&quot;);</a>
<a name="ln772">  g_signal_connect(G_OBJECT(ui-&gt;server_entry), &quot;changed&quot;, G_CALLBACK(_piwigo_server_entry_changed), (gpointer)ui);</a>
<a name="ln773">  gtk_entry_set_width_chars(GTK_ENTRY(ui-&gt;server_entry), 0);</a>
<a name="ln774">  gtk_box_pack_start(GTK_BOX(hbox), GTK_WIDGET(label), FALSE, FALSE, 0);</a>
<a name="ln775">  gtk_box_pack_start(GTK_BOX(hbox), GTK_WIDGET(ui-&gt;server_entry), TRUE, TRUE, 0);</a>
<a name="ln776">  gtk_box_pack_start(GTK_BOX(self-&gt;widget), GTK_WIDGET(hbox), TRUE, TRUE, 0);</a>
<a name="ln777">  g_free(server);</a>
<a name="ln778"> </a>
<a name="ln779">  // login</a>
<a name="ln780">  hbox = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, DT_PIXEL_APPLY_DPI(8));</a>
<a name="ln781">  label = gtk_label_new(_(&quot;user&quot;));</a>
<a name="ln782">  g_object_set(G_OBJECT(label), &quot;xalign&quot;, 0.0, (gchar *)0);</a>
<a name="ln783">  ui-&gt;user_entry = GTK_ENTRY(gtk_entry_new());</a>
<a name="ln784">  gtk_widget_set_hexpand(GTK_WIDGET(ui-&gt;user_entry), TRUE);</a>
<a name="ln785">  dt_gui_key_accel_block_on_focus_connect(GTK_WIDGET(ui-&gt;user_entry));</a>
<a name="ln786">  gtk_entry_set_text(ui-&gt;user_entry, last_account?last_account-&gt;username:&quot;&quot;);</a>
<a name="ln787">  g_signal_connect(G_OBJECT(ui-&gt;user_entry), &quot;changed&quot;, G_CALLBACK(_piwigo_entry_changed), (gpointer)ui);</a>
<a name="ln788">  gtk_entry_set_width_chars(GTK_ENTRY(ui-&gt;user_entry), 0);</a>
<a name="ln789">  gtk_box_pack_start(GTK_BOX(hbox), GTK_WIDGET(label), FALSE, FALSE, 0);</a>
<a name="ln790">  gtk_box_pack_start(GTK_BOX(hbox), GTK_WIDGET(ui-&gt;user_entry), TRUE, TRUE, 0);</a>
<a name="ln791">  gtk_box_pack_start(GTK_BOX(self-&gt;widget), GTK_WIDGET(hbox), TRUE, TRUE, 0);</a>
<a name="ln792"> </a>
<a name="ln793">  // password</a>
<a name="ln794">  hbox = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, DT_PIXEL_APPLY_DPI(8));</a>
<a name="ln795">  label = gtk_label_new(_(&quot;password&quot;));</a>
<a name="ln796">  g_object_set(G_OBJECT(label), &quot;xalign&quot;, 0.0, (gchar *)0);</a>
<a name="ln797">  ui-&gt;pwd_entry = GTK_ENTRY(gtk_entry_new());</a>
<a name="ln798">  gtk_entry_set_visibility(GTK_ENTRY(ui-&gt;pwd_entry), FALSE);</a>
<a name="ln799">  gtk_widget_set_hexpand(GTK_WIDGET(ui-&gt;pwd_entry), TRUE);</a>
<a name="ln800">  dt_gui_key_accel_block_on_focus_connect(GTK_WIDGET(ui-&gt;pwd_entry));</a>
<a name="ln801">  gtk_entry_set_text(ui-&gt;pwd_entry, last_account?last_account-&gt;password:&quot;&quot;);</a>
<a name="ln802">  g_signal_connect(G_OBJECT(ui-&gt;pwd_entry), &quot;changed&quot;, G_CALLBACK(_piwigo_entry_changed), (gpointer)ui);</a>
<a name="ln803">  gtk_entry_set_width_chars(GTK_ENTRY(ui-&gt;pwd_entry), 0);</a>
<a name="ln804">  gtk_box_pack_start(GTK_BOX(hbox), GTK_WIDGET(label), FALSE, FALSE, 0);</a>
<a name="ln805">  gtk_box_pack_start(GTK_BOX(hbox), GTK_WIDGET(ui-&gt;pwd_entry), TRUE, TRUE, 0);</a>
<a name="ln806">  gtk_box_pack_start(GTK_BOX(self-&gt;widget), GTK_WIDGET(hbox), TRUE, TRUE, 0);</a>
<a name="ln807"> </a>
<a name="ln808">  // login button</a>
<a name="ln809">  button = gtk_button_new_with_label(_(&quot;login&quot;));</a>
<a name="ln810">  gtk_widget_set_tooltip_text(button, _(&quot;piwigo login&quot;));</a>
<a name="ln811">  g_signal_connect(G_OBJECT(button), &quot;clicked&quot;, G_CALLBACK(_piwigo_login_clicked), (gpointer)ui);</a>
<a name="ln812">  gtk_box_pack_start(GTK_BOX(self-&gt;widget), button, FALSE, FALSE, 0);</a>
<a name="ln813"> </a>
<a name="ln814">  // status area</a>
<a name="ln815">  ui-&gt;status_label = GTK_LABEL(gtk_label_new(NULL));</a>
<a name="ln816">  gtk_widget_set_halign(GTK_WIDGET(ui-&gt;status_label), GTK_ALIGN_START);</a>
<a name="ln817">  gtk_box_pack_start(GTK_BOX(self-&gt;widget), GTK_WIDGET(ui-&gt;status_label), FALSE, FALSE, 0);</a>
<a name="ln818"> </a>
<a name="ln819">  ui-&gt;export_tags = dt_bauhaus_combobox_new(NULL);</a>
<a name="ln820">  dt_bauhaus_widget_set_label(ui-&gt;export_tags, NULL, _(&quot;export tags&quot;));</a>
<a name="ln821">  dt_bauhaus_combobox_add(ui-&gt;export_tags, _(&quot;yes&quot;));</a>
<a name="ln822">  dt_bauhaus_combobox_add(ui-&gt;export_tags, _(&quot;no&quot;));</a>
<a name="ln823">  dt_bauhaus_combobox_set(ui-&gt;export_tags, 0);</a>
<a name="ln824">  gtk_widget_set_hexpand(ui-&gt;export_tags, TRUE);</a>
<a name="ln825">  gtk_box_pack_start(GTK_BOX(self-&gt;widget), ui-&gt;export_tags, FALSE, FALSE, 0);</a>
<a name="ln826"> </a>
<a name="ln827">  // select account</a>
<a name="ln828">  if(account_index != -1) dt_bauhaus_combobox_set(ui-&gt;account_list, account_index);</a>
<a name="ln829"> </a>
<a name="ln830">  // permissions list</a>
<a name="ln831">  ui-&gt;permission_list = dt_bauhaus_combobox_new(NULL);</a>
<a name="ln832">  dt_bauhaus_widget_set_label(ui-&gt;permission_list, NULL, _(&quot;visible to&quot;));</a>
<a name="ln833">  dt_bauhaus_combobox_add(ui-&gt;permission_list, _(&quot;everyone&quot;));</a>
<a name="ln834">  dt_bauhaus_combobox_add(ui-&gt;permission_list, _(&quot;contacts&quot;));</a>
<a name="ln835">  dt_bauhaus_combobox_add(ui-&gt;permission_list, _(&quot;friends&quot;));</a>
<a name="ln836">  dt_bauhaus_combobox_add(ui-&gt;permission_list, _(&quot;family&quot;));</a>
<a name="ln837">  dt_bauhaus_combobox_add(ui-&gt;permission_list, _(&quot;you&quot;));</a>
<a name="ln838">  dt_bauhaus_combobox_set(ui-&gt;permission_list, 0); // Set default permission to private</a>
<a name="ln839">  gtk_box_pack_start(GTK_BOX(self-&gt;widget), ui-&gt;permission_list, FALSE, FALSE, 0);</a>
<a name="ln840"> </a>
<a name="ln841">  // album list</a>
<a name="ln842">  hbox = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, DT_PIXEL_APPLY_DPI(5));</a>
<a name="ln843"> </a>
<a name="ln844">  ui-&gt;album_list = dt_bauhaus_combobox_new(NULL); // Available albums</a>
<a name="ln845">  dt_bauhaus_widget_set_label(ui-&gt;album_list, NULL, _(&quot;albums&quot;));</a>
<a name="ln846">  g_signal_connect(G_OBJECT(ui-&gt;album_list), &quot;value-changed&quot;, G_CALLBACK(_piwigo_album_changed), (gpointer)ui);</a>
<a name="ln847">  gtk_widget_set_sensitive(ui-&gt;album_list, FALSE);</a>
<a name="ln848">  gtk_box_pack_start(GTK_BOX(hbox), ui-&gt;album_list, TRUE, TRUE, 0);</a>
<a name="ln849"> </a>
<a name="ln850">  button = dtgtk_button_new(dtgtk_cairo_paint_refresh, CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln851">  gtk_widget_set_tooltip_text(button, _(&quot;refresh album list&quot;));</a>
<a name="ln852">  g_signal_connect(G_OBJECT(button), &quot;clicked&quot;, G_CALLBACK(_piwigo_refresh_clicked), (gpointer)ui);</a>
<a name="ln853">  gtk_box_pack_start(GTK_BOX(hbox), button, FALSE, FALSE, 0);</a>
<a name="ln854"> </a>
<a name="ln855">  gtk_box_pack_start(GTK_BOX(self-&gt;widget), hbox, FALSE, FALSE, 0);</a>
<a name="ln856"> </a>
<a name="ln857">  // new album</a>
<a name="ln858">  ui-&gt;create_box = GTK_BOX(gtk_box_new(GTK_ORIENTATION_VERTICAL, DT_PIXEL_APPLY_DPI(5)));</a>
<a name="ln859">  gtk_widget_set_no_show_all(GTK_WIDGET(ui-&gt;create_box), TRUE);</a>
<a name="ln860">  gtk_box_pack_start(GTK_BOX(self-&gt;widget), GTK_WIDGET(ui-&gt;create_box), FALSE, FALSE, 0);</a>
<a name="ln861"> </a>
<a name="ln862">  hbox = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, DT_PIXEL_APPLY_DPI(10));</a>
<a name="ln863"> </a>
<a name="ln864">  label = gtk_label_new(_(&quot;title&quot;));</a>
<a name="ln865">  g_object_set(G_OBJECT(label), &quot;xalign&quot;, 0.0, (gchar *)0);</a>
<a name="ln866">  gtk_box_pack_start(GTK_BOX(hbox), label, FALSE, FALSE, 0);</a>
<a name="ln867"> </a>
<a name="ln868">  ui-&gt;new_album_entry = GTK_ENTRY(gtk_entry_new()); // Album title</a>
<a name="ln869">  dt_gui_key_accel_block_on_focus_connect(GTK_WIDGET(ui-&gt;new_album_entry));</a>
<a name="ln870">  gtk_entry_set_text(ui-&gt;new_album_entry, _(&quot;new album&quot;));</a>
<a name="ln871">  gtk_box_pack_start(GTK_BOX(hbox), GTK_WIDGET(ui-&gt;new_album_entry), TRUE, TRUE, 0);</a>
<a name="ln872">  gtk_entry_set_width_chars(GTK_ENTRY(ui-&gt;new_album_entry), 0);</a>
<a name="ln873"> </a>
<a name="ln874">  gtk_box_pack_start(ui-&gt;create_box, hbox, FALSE, FALSE, 0);</a>
<a name="ln875"> </a>
<a name="ln876">  // parent album list</a>
<a name="ln877">  ui-&gt;parent_album_list = dt_bauhaus_combobox_new(NULL); // Available albums</a>
<a name="ln878">  dt_bauhaus_widget_set_label(ui-&gt;parent_album_list, NULL, _(&quot;parent album&quot;));</a>
<a name="ln879">  gtk_widget_set_sensitive(ui-&gt;parent_album_list, TRUE);</a>
<a name="ln880">  gtk_box_pack_start(ui-&gt;create_box, ui-&gt;parent_album_list, TRUE, TRUE, 0);</a>
<a name="ln881"> </a>
<a name="ln882">  _piwigo_set_status(ui, _(&quot;click login button to start&quot;), &quot;#ffffff&quot;);</a>
<a name="ln883">}</a>
<a name="ln884"> </a>
<a name="ln885">void gui_cleanup(dt_imageio_module_storage_t *self)</a>
<a name="ln886">{</a>
<a name="ln887">  dt_storage_piwigo_gui_data_t *ui = self-&gt;gui_data;</a>
<a name="ln888">  dt_gui_key_accel_block_on_focus_disconnect(GTK_WIDGET(ui-&gt;user_entry));</a>
<a name="ln889">  dt_gui_key_accel_block_on_focus_disconnect(GTK_WIDGET(ui-&gt;new_album_entry));</a>
<a name="ln890">  g_free(self-&gt;gui_data);</a>
<a name="ln891">}</a>
<a name="ln892"> </a>
<a name="ln893">void gui_reset(dt_imageio_module_storage_t *self)</a>
<a name="ln894">{</a>
<a name="ln895">}</a>
<a name="ln896"> </a>
<a name="ln897">static gboolean _finalize_store(gpointer user_data)</a>
<a name="ln898">{</a>
<a name="ln899">  dt_storage_piwigo_gui_data_t *g = (dt_storage_piwigo_gui_data_t *)user_data;</a>
<a name="ln900">  _piwigo_refresh_albums(g, dt_bauhaus_combobox_get_text(g-&gt;album_list));</a>
<a name="ln901">  return FALSE;</a>
<a name="ln902">}</a>
<a name="ln903"> </a>
<a name="ln904">void finalize_store(struct dt_imageio_module_storage_t *self, dt_imageio_module_data_t *data)</a>
<a name="ln905">{</a>
<a name="ln906">  g_main_context_invoke(NULL, _finalize_store, self-&gt;gui_data);</a>
<a name="ln907">}</a>
<a name="ln908"> </a>
<a name="ln909">int store(dt_imageio_module_storage_t *self, dt_imageio_module_data_t *sdata, const int imgid,</a>
<a name="ln910">          dt_imageio_module_format_t *format, dt_imageio_module_data_t *fdata, const int num, const int total,</a>
<a name="ln911">          const gboolean high_quality, const gboolean upscale, dt_colorspaces_color_profile_type_t icc_type,</a>
<a name="ln912">          const gchar *icc_filename, dt_iop_color_intent_t icc_intent)</a>
<a name="ln913">{</a>
<a name="ln914">  dt_storage_piwigo_gui_data_t *ui = self-&gt;gui_data;</a>
<a name="ln915"> </a>
<a name="ln916">  gint result = 0;</a>
<a name="ln917"> </a>
<a name="ln918">  const char *ext = format-&gt;extension(fdata);</a>
<a name="ln919"> </a>
<a name="ln920">  // Let's upload image...</a>
<a name="ln921"> </a>
<a name="ln922">  /* construct a temporary file name */</a>
<a name="ln923">  char fname[PATH_MAX] = { 0 };</a>
<a name="ln924">  dt_loc_get_tmp_dir(fname, sizeof(fname));</a>
<a name="ln925">  g_strlcat(fname, &quot;/darktable.XXXXXX.&quot;, sizeof(fname));</a>
<a name="ln926">  g_strlcat(fname, ext, sizeof(fname));</a>
<a name="ln927"> </a>
<a name="ln928">  char *caption = NULL;</a>
<a name="ln929">  char *description = NULL;</a>
<a name="ln930">  char *author = NULL;</a>
<a name="ln931"> </a>
<a name="ln932">  gint fd = g_mkstemp(fname);</a>
<a name="ln933">  if(fd == -1)</a>
<a name="ln934">  {</a>
<a name="ln935">    dt_control_log(&quot;failed to create temporary image for piwigo export&quot;);</a>
<a name="ln936">    fprintf(stderr, &quot;failed to create tempfile: %s\n&quot;, fname);</a>
<a name="ln937">    return 1;</a>
<a name="ln938">  }</a>
<a name="ln939">  close(fd);</a>
<a name="ln940">  const dt_image_t *img = dt_image_cache_get(darktable.image_cache, imgid, 'r');</a>
<a name="ln941"> </a>
<a name="ln942">  // If title is not existing, then use the filename without extension. If not, then use title instead</a>
<a name="ln943">  GList *title = dt_metadata_get(img-&gt;id, &quot;Xmp.dc.title&quot;, NULL);</a>
<a name="ln944">  if(title != NULL)</a>
<a name="ln945">  {</a>
<a name="ln946">    caption = g_strdup(title-&gt;data);</a>
<a name="ln947">    g_list_free_full(title, &amp;g_free);</a>
<a name="ln948">  }</a>
<a name="ln949">  else</a>
<a name="ln950">  {</a>
<a name="ln951">    caption = g_path_get_basename(img-&gt;filename);</a>
<a name="ln952">    (g_strrstr(caption, &quot;.&quot;))[0] = '\0'; // chop extension...</a>
<a name="ln953">  }</a>
<a name="ln954"> </a>
<a name="ln955">  GList *desc = dt_metadata_get(img-&gt;id, &quot;Xmp.dc.description&quot;, NULL);</a>
<a name="ln956">  if(desc != NULL)</a>
<a name="ln957">  {</a>
<a name="ln958">    description = g_strdup(desc-&gt;data);</a>
<a name="ln959">    g_list_free_full(desc, &amp;g_free);</a>
<a name="ln960">  }</a>
<a name="ln961">  dt_image_cache_read_release(darktable.image_cache, img);</a>
<a name="ln962"> </a>
<a name="ln963">  GList *auth = dt_metadata_get(img-&gt;id, &quot;Xmp.dc.creator&quot;, NULL);</a>
<a name="ln964">  if(auth != NULL)</a>
<a name="ln965">  {</a>
<a name="ln966">    author = g_strdup(auth-&gt;data);</a>
<a name="ln967">    g_list_free_full(auth, &amp;g_free);</a>
<a name="ln968">  }</a>
<a name="ln969"> </a>
<a name="ln970">  if(dt_imageio_export(imgid, fname, format, fdata, high_quality, upscale, FALSE, icc_type, icc_filename, icc_intent,</a>
<a name="ln971">                       self, sdata, num, total) != 0)</a>
<a name="ln972">  {</a>
<a name="ln973">    fprintf(stderr, &quot;[imageio_storage_piwigo] could not export to file: `%s'!\n&quot;, fname);</a>
<a name="ln974">    dt_control_log(_(&quot;could not export to file `%s'!&quot;), fname);</a>
<a name="ln975">    result = 1;</a>
<a name="ln976">    goto cleanup;</a>
<a name="ln977">  }</a>
<a name="ln978"> </a>
<a name="ln979">  dt_pthread_mutex_lock(&amp;darktable.plugin_threadsafe);</a>
<a name="ln980">  {</a>
<a name="ln981">    gboolean status = TRUE;</a>
<a name="ln982">    dt_storage_piwigo_params_t *p = (dt_storage_piwigo_params_t *)sdata;</a>
<a name="ln983"> </a>
<a name="ln984">    if(p-&gt;export_tags)</a>
<a name="ln985">    {</a>
<a name="ln986">      GList *tags_list = dt_tag_get_list(imgid);</a>
<a name="ln987">      if(p-&gt;tags) g_free(p-&gt;tags);</a>
<a name="ln988">      p-&gt;tags = dt_util_glist_to_str(&quot;,&quot;, tags_list);</a>
<a name="ln989">      g_list_free_full(tags_list, g_free);</a>
<a name="ln990">    }</a>
<a name="ln991"> </a>
<a name="ln992">    if(p-&gt;new_album)</a>
<a name="ln993">    {</a>
<a name="ln994">      status = _piwigo_api_create_new_album(p);</a>
<a name="ln995">      if(!status) dt_control_log(_(&quot;cannot create a new piwigo album!&quot;));</a>
<a name="ln996">    }</a>
<a name="ln997"> </a>
<a name="ln998">    if(status)</a>
<a name="ln999">    {</a>
<a name="ln1000">      status = _piwigo_api_upload_photo(p, fname, author, caption, description);</a>
<a name="ln1001">      if(!status)</a>
<a name="ln1002">      {</a>
<a name="ln1003">        fprintf(stderr, &quot;[imageio_storage_piwigo] could not upload to piwigo!\n&quot;);</a>
<a name="ln1004">        dt_control_log(_(&quot;could not upload to piwigo!&quot;));</a>
<a name="ln1005">        result = 1;</a>
<a name="ln1006">      }</a>
<a name="ln1007">      else if (p-&gt;new_album)</a>
<a name="ln1008">      {</a>
<a name="ln1009">        // we do not want to create more albums when multiple upload</a>
<a name="ln1010">        p-&gt;new_album = FALSE;</a>
<a name="ln1011">        _piwigo_refresh_albums(ui, p-&gt;album);</a>
<a name="ln1012">      }</a>
<a name="ln1013">    }</a>
<a name="ln1014">  }</a>
<a name="ln1015">  dt_pthread_mutex_unlock(&amp;darktable.plugin_threadsafe);</a>
<a name="ln1016"> </a>
<a name="ln1017">cleanup:</a>
<a name="ln1018"> </a>
<a name="ln1019">  // And remove from filesystem..</a>
<a name="ln1020">  g_unlink(fname);</a>
<a name="ln1021">  g_free(caption);</a>
<a name="ln1022">  g_free(description);</a>
<a name="ln1023">  g_free(author);</a>
<a name="ln1024"> </a>
<a name="ln1025">  if(!result)</a>
<a name="ln1026">  {</a>
<a name="ln1027">    // this makes sense only if the export was successful</a>
<a name="ln1028">    dt_control_log(ngettext(&quot;%d/%d exported to piwigo webalbum&quot;, &quot;%d/%d exported to piwigo webalbum&quot;, num),</a>
<a name="ln1029">                   num, total);</a>
<a name="ln1030">  }</a>
<a name="ln1031">  return result;</a>
<a name="ln1032">}</a>
<a name="ln1033"> </a>
<a name="ln1034">size_t params_size(dt_imageio_module_storage_t *self)</a>
<a name="ln1035">{</a>
<a name="ln1036">  return sizeof(int64_t);</a>
<a name="ln1037">}</a>
<a name="ln1038"> </a>
<a name="ln1039">void init(dt_imageio_module_storage_t *self)</a>
<a name="ln1040">{</a>
<a name="ln1041">}</a>
<a name="ln1042"> </a>
<a name="ln1043">static uint64_t _piwigo_album_id(const gchar *name, GList *albums)</a>
<a name="ln1044">{</a>
<a name="ln1045">  uint64_t id = 0;</a>
<a name="ln1046"> </a>
<a name="ln1047">  GList *a = albums;</a>
<a name="ln1048">  while(a)</a>
<a name="ln1049">  {</a>
<a name="ln1050">    _piwigo_album_t *album = (_piwigo_album_t *)a-&gt;data;</a>
<a name="ln1051">    if(!strcmp(name, album-&gt;label))</a>
<a name="ln1052">    {</a>
<a name="ln1053">      id = album-&gt;id;</a>
<a name="ln1054">      break;</a>
<a name="ln1055">    }</a>
<a name="ln1056">    a = g_list_next(a);</a>
<a name="ln1057">  }</a>
<a name="ln1058"> </a>
<a name="ln1059">  return id;</a>
<a name="ln1060">}</a>
<a name="ln1061"> </a>
<a name="ln1062">void *get_params(dt_imageio_module_storage_t *self)</a>
<a name="ln1063">{</a>
<a name="ln1064">  dt_storage_piwigo_gui_data_t *ui = (dt_storage_piwigo_gui_data_t *)self-&gt;gui_data;</a>
<a name="ln1065">  if(!ui) return NULL; // gui not initialized, CLI mode</a>
<a name="ln1066">  dt_storage_piwigo_params_t *p = (dt_storage_piwigo_params_t *)g_malloc0(sizeof(dt_storage_piwigo_params_t));</a>
<a name="ln1067"> </a>
<a name="ln1068">  if(!p) return NULL;</a>
<a name="ln1069"> </a>
<a name="ln1070">  // fill d from controls in ui</a>
<a name="ln1071">  if(ui-&gt;api &amp;&amp; ui-&gt;api-&gt;authenticated == TRUE)</a>
<a name="ln1072">  {</a>
<a name="ln1073">    // create a new context for the import. set username/password to be able to connect.</a>
<a name="ln1074">    p-&gt;api = _piwigo_ctx_init();</a>
<a name="ln1075">    p-&gt;api-&gt;authenticated = FALSE;</a>
<a name="ln1076">    p-&gt;api-&gt;server = g_strdup(ui-&gt;api-&gt;server);</a>
<a name="ln1077">    p-&gt;api-&gt;username = g_strdup(ui-&gt;api-&gt;username);</a>
<a name="ln1078">    p-&gt;api-&gt;password = g_strdup(ui-&gt;api-&gt;password);</a>
<a name="ln1079">    _piwigo_api_authenticate(p-&gt;api);</a>
<a name="ln1080"> </a>
<a name="ln1081">    int index = dt_bauhaus_combobox_get(ui-&gt;album_list);</a>
<a name="ln1082"> </a>
<a name="ln1083">    p-&gt;album_id = 0;</a>
<a name="ln1084">    p-&gt;export_tags = (dt_bauhaus_combobox_get(ui-&gt;export_tags) == 0);</a>
<a name="ln1085">    p-&gt;tags = NULL;</a>
<a name="ln1086"> </a>
<a name="ln1087">    switch(dt_bauhaus_combobox_get(ui-&gt;permission_list))</a>
<a name="ln1088">    {</a>
<a name="ln1089">      case 0:                // everyone</a>
<a name="ln1090">        p-&gt;privacy = 0;</a>
<a name="ln1091">        break;</a>
<a name="ln1092">      case 1:                // contacts</a>
<a name="ln1093">        p-&gt;privacy = 1;</a>
<a name="ln1094">        break;</a>
<a name="ln1095">      case 2:                // friends</a>
<a name="ln1096">        p-&gt;privacy = 2;</a>
<a name="ln1097">        break;</a>
<a name="ln1098">      case 3:                // family</a>
<a name="ln1099">        p-&gt;privacy = 4;</a>
<a name="ln1100">        break;</a>
<a name="ln1101">      default:               // you / admin</a>
<a name="ln1102">        p-&gt;privacy = 8;</a>
<a name="ln1103">    }</a>
<a name="ln1104"> </a>
<a name="ln1105">    if(index &gt;= 0)</a>
<a name="ln1106">    {</a>
<a name="ln1107">      switch(index)</a>
<a name="ln1108">      {</a>
<a name="ln1109">        case 0: // Create album</a>
<a name="ln1110">          p-&gt;parent_album_id = _piwigo_album_id(dt_bauhaus_combobox_get_text(ui-&gt;parent_album_list), ui-&gt;albums);</a>
<a name="ln1111">          p-&gt;album = g_strdup(gtk_entry_get_text(ui-&gt;new_album_entry));</a>
<a name="ln1112">          p-&gt;new_album = TRUE;</a>
<a name="ln1113">          break;</a>
<a name="ln1114"> </a>
<a name="ln1115">        default:</a>
<a name="ln1116">          p-&gt;album = g_strdup(dt_bauhaus_combobox_get_text(ui-&gt;album_list));</a>
<a name="ln1117">          p-&gt;new_album = FALSE;</a>
<a name="ln1118"> </a>
<a name="ln1119">          if(p-&gt;album == NULL)</a>
<a name="ln1120">          {</a>
<a name="ln1121">            // Something went wrong...</a>
<a name="ln1122">            fprintf(stderr, &quot;Something went wrong.. album index %d = NULL\n&quot;, index - 2);</a>
<a name="ln1123">            goto cleanup;</a>
<a name="ln1124">          }</a>
<a name="ln1125"> </a>
<a name="ln1126">          p-&gt;album_id = _piwigo_album_id(p-&gt;album, ui-&gt;albums);</a>
<a name="ln1127"> </a>
<a name="ln1128">          if(!p-&gt;album_id)</a>
<a name="ln1129">          {</a>
<a name="ln1130">            fprintf(stderr, &quot;[imageio_storage_piwigo] cannot find album `%s'!\n&quot;, p-&gt;album);</a>
<a name="ln1131">            goto cleanup;</a>
<a name="ln1132">          }</a>
<a name="ln1133"> </a>
<a name="ln1134">          break;</a>
<a name="ln1135">      }</a>
<a name="ln1136">    }</a>
<a name="ln1137">    else</a>
<a name="ln1138">      goto cleanup;</a>
<a name="ln1139">  }</a>
<a name="ln1140">  else</a>
<a name="ln1141">    goto cleanup;</a>
<a name="ln1142"> </a>
<a name="ln1143">  return p;</a>
<a name="ln1144"> </a>
<a name="ln1145"> cleanup:</a>
<a name="ln1146">    g_free(p);</a>
<a name="ln1147">    return NULL;</a>
<a name="ln1148">}</a>
<a name="ln1149"> </a>
<a name="ln1150">int set_params(dt_imageio_module_storage_t *self, const void *params, const int size)</a>
<a name="ln1151">{</a>
<a name="ln1152">  if(size != self-&gt;params_size(self)) return 1;</a>
<a name="ln1153">  // gui stuff not updated, as sensitive user data is not stored in the preset.</a>
<a name="ln1154">  // TODO: store name/hash in kwallet/etc module and get encrypted stuff from there!</a>
<a name="ln1155">  return 0;</a>
<a name="ln1156">}</a>
<a name="ln1157"> </a>
<a name="ln1158">int supported(dt_imageio_module_storage_t *storage, dt_imageio_module_format_t *format)</a>
<a name="ln1159">{</a>
<a name="ln1160">  if(strcmp(format-&gt;mime(NULL), &quot;image/jpeg&quot;) == 0)</a>
<a name="ln1161">    return 1;</a>
<a name="ln1162">  else if(strcmp(format-&gt;mime(NULL), &quot;image/png&quot;) == 0)</a>
<a name="ln1163">    return 1;</a>
<a name="ln1164"> </a>
<a name="ln1165">  return 0;</a>
<a name="ln1166">}</a>
<a name="ln1167"> </a>
<a name="ln1168">void free_params(dt_imageio_module_storage_t *self, dt_imageio_module_data_t *params)</a>
<a name="ln1169">{</a>
<a name="ln1170">  dt_storage_piwigo_params_t *p = (dt_storage_piwigo_params_t *)params;</a>
<a name="ln1171"> </a>
<a name="ln1172">  if(p)</a>
<a name="ln1173">  {</a>
<a name="ln1174">    g_free(p-&gt;album);</a>
<a name="ln1175">    g_free(p-&gt;tags);</a>
<a name="ln1176">    _piwigo_ctx_destroy(&amp;p-&gt;api);</a>
<a name="ln1177">    free(p);</a>
<a name="ln1178">  }</a>
<a name="ln1179">}</a>
<a name="ln1180"> </a>
<a name="ln1181">// modelines: These editor modelines have been set for all relevant files by tools/update_modelines.sh</a>
<a name="ln1182">// vim: shiftwidth=2 expandtab tabstop=2 cindent</a>
<a name="ln1183">// kate: tab-indents: off; indent-width 2; replace-tabs on; indent-mode cstyle; remove-trailing-spaces modified;</a>

</code></pre>
<div class="balloon" rel="129"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v522/" target="_blank">V522</a> There might be dereferencing of a potential null pointer 'arg'. Check lines: 129, 128.</p></div>
<div class="balloon" rel="138"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v522/" target="_blank">V522</a> There might be dereferencing of a potential null pointer 'ctx'. Check lines: 138, 136.</p></div>
<div class="balloon" rel="176"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v575/" target="_blank">V575</a> The null pointer is passed into 'g_list_free_full' function. Inspect the first argument.</p></div>
<div class="balloon" rel="200"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v522/" target="_blank">V522</a> There might be dereferencing of a potential null pointer 'account'. Check lines: 200, 198.</p></div>
<div class="balloon" rel="286"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v568/" target="_blank">V568</a> It's odd that 'sizeof()' operator evaluates the size of a pointer to a class, but not the size of the 'response' class object.</p></div>
<div class="balloon" rel="461"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v547/" target="_blank">V547</a> Expression 'ui->api->authenticated' is always true.</p></div>
<div class="balloon" rel="593"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v560/" target="_blank">V560</a> A part of conditional expression is always true: index == 0.</p></div>
<div class="balloon" rel="1075"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v522/" target="_blank">V522</a> There might be dereferencing of a potential null pointer 'p->api'.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
