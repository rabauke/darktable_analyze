
<html>
<head>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>
<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> *    This file is part of darktable,</a>
<a name="ln3"> *    copyright (c) 2015 tobias ellinghaus.</a>
<a name="ln4"> *</a>
<a name="ln5"> *    darktable is free software: you can redistribute it and/or modify</a>
<a name="ln6"> *    it under the terms of the GNU General Public License as published by</a>
<a name="ln7"> *    the Free Software Foundation, either version 3 of the License, or</a>
<a name="ln8"> *    (at your option) any later version.</a>
<a name="ln9"> *</a>
<a name="ln10"> *    darktable is distributed in the hope that it will be useful,</a>
<a name="ln11"> *    but WITHOUT ANY WARRANTY; without even the implied warranty of</a>
<a name="ln12"> *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</a>
<a name="ln13"> *    GNU General Public License for more details.</a>
<a name="ln14"> *</a>
<a name="ln15"> *    You should have received a copy of the GNU General Public License</a>
<a name="ln16"> *    along with darktable.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</a>
<a name="ln17"> */</a>
<a name="ln18"> </a>
<a name="ln19">#include &quot;common/pdf.h&quot;</a>
<a name="ln20">#include &quot;bauhaus/bauhaus.h&quot;</a>
<a name="ln21">#include &quot;common/colorspaces.h&quot;</a>
<a name="ln22">#include &quot;common/darktable.h&quot;</a>
<a name="ln23">#include &quot;common/imageio.h&quot;</a>
<a name="ln24">#include &quot;common/imageio_module.h&quot;</a>
<a name="ln25">#include &quot;common/variables.h&quot;</a>
<a name="ln26">#include &quot;control/control.h&quot;</a>
<a name="ln27">#include &quot;dtgtk/button.h&quot;</a>
<a name="ln28">#include &quot;gui/gtkentry.h&quot;</a>
<a name="ln29">#include &quot;imageio/format/imageio_format_api.h&quot;</a>
<a name="ln30"> </a>
<a name="ln31">DT_MODULE(1)</a>
<a name="ln32"> </a>
<a name="ln33">// clang-format off</a>
<a name="ln34"> </a>
<a name="ln35">// gui data</a>
<a name="ln36">typedef struct pdf_t</a>
<a name="ln37">{</a>
<a name="ln38">  GtkEntry       *title;</a>
<a name="ln39">  GtkWidget      *size;</a>
<a name="ln40">  GtkWidget      *orientation;</a>
<a name="ln41">  GtkEntry       *border;</a>
<a name="ln42">  GtkSpinButton  *dpi;</a>
<a name="ln43">  GtkWidget      *rotate;</a>
<a name="ln44">  GtkWidget      *pages;</a>
<a name="ln45">  GtkWidget      *icc;</a>
<a name="ln46">  GtkWidget      *mode;</a>
<a name="ln47">  GtkWidget      *bpp;</a>
<a name="ln48">  GtkWidget      *compression;</a>
<a name="ln49">} pdf_t;</a>
<a name="ln50"> </a>
<a name="ln51">typedef enum _pdf_orientation_t</a>
<a name="ln52">{</a>
<a name="ln53">  ORIENTATION_PORTRAIT  = 0,</a>
<a name="ln54">  ORIENTATION_LANDSCAPE = 1</a>
<a name="ln55">} _pdf_orientation_t;</a>
<a name="ln56"> </a>
<a name="ln57">typedef enum _pdf_pages_t</a>
<a name="ln58">{</a>
<a name="ln59">  PAGES_ALL     = 0,</a>
<a name="ln60">  PAGES_SINGLE  = 1,</a>
<a name="ln61">  PAGES_CONTACT = 2</a>
<a name="ln62">} _pdf_pages_t;</a>
<a name="ln63"> </a>
<a name="ln64">typedef enum _pdf_mode_t</a>
<a name="ln65">{</a>
<a name="ln66">  MODE_NORMAL = 0,</a>
<a name="ln67">  MODE_DRAFT  = 1,</a>
<a name="ln68">  MODE_DEBUG  = 2,</a>
<a name="ln69">} _pdf_mode_t;</a>
<a name="ln70"> </a>
<a name="ln71">static const struct</a>
<a name="ln72">{</a>
<a name="ln73">  char *name;</a>
<a name="ln74">  int   bpp;</a>
<a name="ln75">} _pdf_bpp[] =</a>
<a name="ln76">{</a>
<a name="ln77">  { N_(&quot;8 bit&quot;),   8 },</a>
<a name="ln78">  { N_(&quot;16 bit&quot;), 16 },</a>
<a name="ln79">  { NULL,          0 }</a>
<a name="ln80">};</a>
<a name="ln81"> </a>
<a name="ln82">typedef struct _pdf_icc_t</a>
<a name="ln83">{</a>
<a name="ln84">  const dt_colorspaces_color_profile_t *profile;</a>
<a name="ln85">  int   icc_id;</a>
<a name="ln86">} _pdf_icc_t;</a>
<a name="ln87"> </a>
<a name="ln88">// saved params -- just there to get the sizeof() without worrying about padding, ...</a>
<a name="ln89">typedef struct dt_imageio_pdf_params_t</a>
<a name="ln90">{</a>
<a name="ln91">  dt_imageio_module_data_t  global;</a>
<a name="ln92">  char                      title[128];</a>
<a name="ln93">  char                      size[64];</a>
<a name="ln94">  _pdf_orientation_t        orientation;</a>
<a name="ln95">  char                      border[64];</a>
<a name="ln96">  float                     dpi;</a>
<a name="ln97">  gboolean                  rotate;</a>
<a name="ln98">  _pdf_pages_t              pages;</a>
<a name="ln99">  gboolean                  icc;</a>
<a name="ln100">  _pdf_mode_t               mode;</a>
<a name="ln101">  dt_pdf_stream_encoder_t   compression;</a>
<a name="ln102">  int                       bpp;</a>
<a name="ln103"> </a>
<a name="ln104">  // the following are unused at the moment</a>
<a name="ln105">  int                       intent;</a>
<a name="ln106">} dt_imageio_pdf_params_t;</a>
<a name="ln107"> </a>
<a name="ln108">// the real type used in the code</a>
<a name="ln109">typedef struct dt_imageio_pdf_t</a>
<a name="ln110">{</a>
<a name="ln111">  dt_imageio_pdf_params_t  params;</a>
<a name="ln112">  char                    *actual_filename;</a>
<a name="ln113">  dt_pdf_t                *pdf;</a>
<a name="ln114">  GList                   *images;</a>
<a name="ln115">  GList                   *icc_profiles;</a>
<a name="ln116">  float                    page_border;</a>
<a name="ln117">} dt_imageio_pdf_t;</a>
<a name="ln118"> </a>
<a name="ln119">// clang-format on</a>
<a name="ln120"> </a>
<a name="ln121">#ifdef USE_LUA</a>
<a name="ln122">static int orientation_member(lua_State *L)</a>
<a name="ln123">{</a>
<a name="ln124">  dt_imageio_pdf_t *d = (dt_imageio_pdf_t *)lua_touserdata(L,1);</a>
<a name="ln125">  dt_lua_orientation_t orientation;</a>
<a name="ln126">  if(lua_gettop(L) != 3)</a>
<a name="ln127">  {</a>
<a name="ln128">    if(d-&gt;params.orientation == ORIENTATION_LANDSCAPE) {</a>
<a name="ln129">      orientation = GTK_ORIENTATION_HORIZONTAL;</a>
<a name="ln130">    } else {</a>
<a name="ln131">      orientation = GTK_ORIENTATION_VERTICAL;</a>
<a name="ln132">    }</a>
<a name="ln133">    luaA_push(L,dt_lua_orientation_t,&amp;orientation);</a>
<a name="ln134">    return 1;</a>
<a name="ln135">  }</a>
<a name="ln136">  else</a>
<a name="ln137">  {</a>
<a name="ln138">    luaA_to(L,dt_lua_orientation_t,&amp;orientation,3);</a>
<a name="ln139">    if(orientation == GTK_ORIENTATION_HORIZONTAL) {</a>
<a name="ln140">      d-&gt;params.orientation = ORIENTATION_LANDSCAPE;</a>
<a name="ln141">    } else {</a>
<a name="ln142">      d-&gt;params.orientation = ORIENTATION_PORTRAIT;</a>
<a name="ln143">    }</a>
<a name="ln144">    return 0;</a>
<a name="ln145">  }</a>
<a name="ln146">}</a>
<a name="ln147"> </a>
<a name="ln148"> </a>
<a name="ln149">void init(dt_imageio_module_format_t *self)</a>
<a name="ln150">{</a>
<a name="ln151">  lua_State* L = darktable.lua_state.state ;</a>
<a name="ln152"> </a>
<a name="ln153">  luaA_enum(L, _pdf_pages_t);</a>
<a name="ln154">  luaA_enum_value_name(L, _pdf_pages_t, PAGES_ALL, &quot;all&quot;);</a>
<a name="ln155">  luaA_enum_value_name(L, _pdf_pages_t, PAGES_SINGLE, &quot;single&quot;);</a>
<a name="ln156">  luaA_enum_value_name(L, _pdf_pages_t, PAGES_CONTACT, &quot;contact&quot;);</a>
<a name="ln157"> </a>
<a name="ln158">  luaA_enum(L, _pdf_mode_t);</a>
<a name="ln159">  luaA_enum_value_name(L, _pdf_mode_t, MODE_NORMAL, &quot;normal&quot;);</a>
<a name="ln160">  luaA_enum_value_name(L, _pdf_mode_t, MODE_DRAFT, &quot;draft&quot;);</a>
<a name="ln161">  luaA_enum_value_name(L, _pdf_mode_t, MODE_DEBUG, &quot;debug&quot;);</a>
<a name="ln162"> </a>
<a name="ln163">  luaA_enum(L, dt_pdf_stream_encoder_t);</a>
<a name="ln164">  luaA_enum_value_name(L, dt_pdf_stream_encoder_t, DT_PDF_STREAM_ENCODER_ASCII_HEX, &quot;uncompressed&quot;);</a>
<a name="ln165">  luaA_enum_value_name(L, dt_pdf_stream_encoder_t, DT_PDF_STREAM_ENCODER_FLATE, &quot;deflate&quot;);</a>
<a name="ln166"> </a>
<a name="ln167">  dt_lua_register_module_member_indirect(L, self, dt_imageio_pdf_t, params,dt_imageio_pdf_params_t,title, char_128);</a>
<a name="ln168">  dt_lua_register_module_member_indirect(L, self, dt_imageio_pdf_t, params,dt_imageio_pdf_params_t,size, char_64);</a>
<a name="ln169">  dt_lua_register_module_member_indirect(L, self, dt_imageio_pdf_t, params,dt_imageio_pdf_params_t,border, char_64);</a>
<a name="ln170">  dt_lua_register_module_member_indirect(L, self, dt_imageio_pdf_t, params,dt_imageio_pdf_params_t,dpi, float);</a>
<a name="ln171">  dt_lua_register_module_member_indirect(L, self, dt_imageio_pdf_t, params,dt_imageio_pdf_params_t,rotate, bool);</a>
<a name="ln172">  dt_lua_register_module_member_indirect(L, self, dt_imageio_pdf_t, params,dt_imageio_pdf_params_t,pages, _pdf_pages_t);</a>
<a name="ln173">  dt_lua_register_module_member_indirect(L, self, dt_imageio_pdf_t, params,dt_imageio_pdf_params_t,icc, bool);</a>
<a name="ln174">  dt_lua_register_module_member_indirect(L, self, dt_imageio_pdf_t, params,dt_imageio_pdf_params_t,mode, _pdf_mode_t);</a>
<a name="ln175">  dt_lua_register_module_member_indirect(L, self, dt_imageio_pdf_t, params,dt_imageio_pdf_params_t,compression, dt_pdf_stream_encoder_t);</a>
<a name="ln176"> </a>
<a name="ln177"> </a>
<a name="ln178"> </a>
<a name="ln179">  lua_pushcfunction(L, orientation_member);</a>
<a name="ln180">  dt_lua_type_register_type(L, self-&gt;parameter_lua_type, &quot;orientation&quot;);</a>
<a name="ln181">}</a>
<a name="ln182">#else // USE_LUA</a>
<a name="ln183">void init(dt_imageio_module_format_t *self)</a>
<a name="ln184">{</a>
<a name="ln185">  // we need an empty init, even when compiled without Lua</a>
<a name="ln186">}</a>
<a name="ln187">#endif // USE_LUA</a>
<a name="ln188"> </a>
<a name="ln189">void cleanup(dt_imageio_module_format_t *self)</a>
<a name="ln190">{</a>
<a name="ln191">}</a>
<a name="ln192"> </a>
<a name="ln193">static int _paper_size(dt_imageio_pdf_params_t *d, float *page_width, float *page_height, float *page_border)</a>
<a name="ln194">{</a>
<a name="ln195">  float width, height, border;</a>
<a name="ln196"> </a>
<a name="ln197">  if(!dt_pdf_parse_paper_size(d-&gt;size, &amp;width, &amp;height))</a>
<a name="ln198">  {</a>
<a name="ln199">    fprintf(stderr, &quot;[imageio_format_pdf] invalid paper size: `%s'!\n&quot;, d-&gt;size);</a>
<a name="ln200">    dt_control_log(_(&quot;invalid paper size&quot;));</a>
<a name="ln201">    return 1;</a>
<a name="ln202">  }</a>
<a name="ln203"> </a>
<a name="ln204">  if(!dt_pdf_parse_length(d-&gt;border, &amp;border))</a>
<a name="ln205">  {</a>
<a name="ln206">    fprintf(stderr, &quot;[imageio_format_pdf] invalid border size: `%s'! using 0\n&quot;, d-&gt;border);</a>
<a name="ln207">    dt_control_log(_(&quot;invalid border size, using 0&quot;));</a>
<a name="ln208">//     return 1;</a>
<a name="ln209">    border = 0.0;</a>
<a name="ln210">  }</a>
<a name="ln211"> </a>
<a name="ln212">  if(d-&gt;orientation == ORIENTATION_LANDSCAPE)</a>
<a name="ln213">  {</a>
<a name="ln214">    float w = width, h = height;</a>
<a name="ln215">    width = MAX(w, h);</a>
<a name="ln216">    height = MIN(w, h);</a>
<a name="ln217">  }</a>
<a name="ln218">  else</a>
<a name="ln219">  {</a>
<a name="ln220">    float w = width, h = height;</a>
<a name="ln221">    width = MIN(w, h);</a>
<a name="ln222">    height = MAX(w, h);</a>
<a name="ln223">  }</a>
<a name="ln224"> </a>
<a name="ln225">  *page_width = width;</a>
<a name="ln226">  *page_height = height;</a>
<a name="ln227">  *page_border = border;</a>
<a name="ln228"> </a>
<a name="ln229">  return 0;</a>
<a name="ln230">}</a>
<a name="ln231"> </a>
<a name="ln232"> </a>
<a name="ln233">int write_image(dt_imageio_module_data_t *data, const char *filename, const void *in,</a>
<a name="ln234">                dt_colorspaces_color_profile_type_t over_type, const char *over_filename,</a>
<a name="ln235">                void *exif, int exif_len, int imgid, int num, int total, struct dt_dev_pixelpipe_t *pipe)</a>
<a name="ln236">{</a>
<a name="ln237">  dt_imageio_pdf_t *d = (dt_imageio_pdf_t *)data;</a>
<a name="ln238"> </a>
<a name="ln239">  // init the pdf. we start counting with 1.</a>
<a name="ln240">  if(num == 1)</a>
<a name="ln241">  {</a>
<a name="ln242">    float page_width, page_height, page_border;</a>
<a name="ln243">    float page_dpi = d-&gt;params.dpi;</a>
<a name="ln244"> </a>
<a name="ln245">    if(_paper_size(&amp;d-&gt;params, &amp;page_width, &amp;page_height, &amp;page_border))</a>
<a name="ln246">      return 1;</a>
<a name="ln247"> </a>
<a name="ln248">    unsigned int compression = d-&gt;params.compression;</a>
<a name="ln249">    compression = MIN(compression, DT_PDF_STREAM_ENCODER_FLATE);</a>
<a name="ln250"> </a>
<a name="ln251"> </a>
<a name="ln252">    dt_pdf_t *pdf = dt_pdf_start(filename, page_width, page_height, page_dpi, compression);</a>
<a name="ln253">    if(!pdf)</a>
<a name="ln254">    {</a>
<a name="ln255">      fprintf(stderr, &quot;[imageio_format_pdf] could not export to file: `%s'!\n&quot;, filename);</a>
<a name="ln256">      dt_control_log(_(&quot;could not export to file `%s'!&quot;), filename);</a>
<a name="ln257">      return 1;</a>
<a name="ln258">    }</a>
<a name="ln259"> </a>
<a name="ln260">    // TODO: escape ')' and maybe also '('</a>
<a name="ln261">    pdf-&gt;title = *d-&gt;params.title ? d-&gt;params.title : NULL;</a>
<a name="ln262"> </a>
<a name="ln263">    d-&gt;pdf = pdf;</a>
<a name="ln264">    d-&gt;actual_filename = g_strdup(filename);</a>
<a name="ln265">    d-&gt;page_border = page_border;</a>
<a name="ln266">  } // init the pdf</a>
<a name="ln267"> </a>
<a name="ln268">  // add the icc profile</a>
<a name="ln269">  int icc_id = 0;</a>
<a name="ln270">  if(imgid &gt; 0 &amp;&amp; d-&gt;params.icc &amp;&amp; d-&gt;params.mode == MODE_NORMAL)</a>
<a name="ln271">  {</a>
<a name="ln272">    // get the id of the profile</a>
<a name="ln273">    const dt_colorspaces_color_profile_t *profile = dt_colorspaces_get_output_profile(imgid, over_type, over_filename);</a>
<a name="ln274"> </a>
<a name="ln275">    // look it up in the list</a>
<a name="ln276">    for(GList *iter = d-&gt;icc_profiles; iter; iter = g_list_next(iter))</a>
<a name="ln277">    {</a>
<a name="ln278">      _pdf_icc_t *icc = (_pdf_icc_t *)iter-&gt;data;</a>
<a name="ln279">      if(icc-&gt;profile == profile)</a>
<a name="ln280">      {</a>
<a name="ln281">        icc_id = icc-&gt;icc_id;</a>
<a name="ln282">        break;</a>
<a name="ln283">      }</a>
<a name="ln284">    }</a>
<a name="ln285">    if(icc_id == 0)</a>
<a name="ln286">    {</a>
<a name="ln287">      uint32_t len = 0;</a>
<a name="ln288">      cmsSaveProfileToMem(profile-&gt;profile, 0, &amp;len);</a>
<a name="ln289">      if(len &gt; 0)</a>
<a name="ln290">      {</a>
<a name="ln291">        unsigned char *buf = malloc(len * sizeof(unsigned char));</a>
<a name="ln292">        cmsSaveProfileToMem(profile-&gt;profile, buf, &amp;len);</a>
<a name="ln293">        icc_id = dt_pdf_add_icc_from_data(d-&gt;pdf, buf, len);</a>
<a name="ln294">        free(buf);</a>
<a name="ln295">        _pdf_icc_t *icc = (_pdf_icc_t *)malloc(sizeof(_pdf_icc_t));</a>
<a name="ln296">        icc-&gt;profile = profile;</a>
<a name="ln297">        icc-&gt;icc_id = icc_id;</a>
<a name="ln298">        d-&gt;icc_profiles = g_list_append(d-&gt;icc_profiles, icc);</a>
<a name="ln299">      }</a>
<a name="ln300">    }</a>
<a name="ln301">  }</a>
<a name="ln302"> </a>
<a name="ln303">  void *image_data = NULL;</a>
<a name="ln304"> </a>
<a name="ln305">  // TODO</a>
<a name="ln306">  // decide if we want to push that conversion step into the pdf lib and maybe do it on the fly while writing.</a>
<a name="ln307">  // that would get rid of one buffer in the case of ASCII_HEX</a>
<a name="ln308">  if(d-&gt;params.mode == MODE_NORMAL)</a>
<a name="ln309">  {</a>
<a name="ln310">    if(d-&gt;params.bpp == 8)</a>
<a name="ln311">    {</a>
<a name="ln312">      image_data = malloc(data-&gt;width * data-&gt;height * 3);</a>
<a name="ln313">      const uint8_t *in_ptr = (const uint8_t *)in;</a>
<a name="ln314">      uint8_t *out_ptr = (uint8_t *)image_data;</a>
<a name="ln315">      for(int y = 0; y &lt; data-&gt;height; y++)</a>
<a name="ln316">      {</a>
<a name="ln317">        for(int x = 0; x &lt; data-&gt;width; x++, in_ptr += 4, out_ptr += 3)</a>
<a name="ln318">          memcpy(out_ptr, in_ptr, 3);</a>
<a name="ln319">      }</a>
<a name="ln320">    }</a>
<a name="ln321">    else</a>
<a name="ln322">    {</a>
<a name="ln323">      image_data = malloc(data-&gt;width * data-&gt;height * 3 * sizeof(uint16_t));</a>
<a name="ln324">      const uint16_t *in_ptr = (const uint16_t *)in;</a>
<a name="ln325">      uint16_t *out_ptr = (uint16_t *)image_data;</a>
<a name="ln326">      for(int y = 0; y &lt; data-&gt;height; y++)</a>
<a name="ln327">      {</a>
<a name="ln328">        for(int x = 0; x &lt; data-&gt;width; x++, in_ptr += 4, out_ptr += 3)</a>
<a name="ln329">        {</a>
<a name="ln330">          for(int c = 0; c &lt; 3; c++)</a>
<a name="ln331">            out_ptr[c] = (0xff00 &amp; (in_ptr[c] &lt;&lt; 8)) | (in_ptr[c] &gt;&gt; 8);</a>
<a name="ln332">        }</a>
<a name="ln333">      }</a>
<a name="ln334">    }</a>
<a name="ln335">  }</a>
<a name="ln336"> </a>
<a name="ln337">  dt_pdf_image_t *image = dt_pdf_add_image(d-&gt;pdf, image_data, d-&gt;params.global.width, d-&gt;params.global.height, d-&gt;params.bpp, icc_id, d-&gt;page_border);</a>
<a name="ln338"> </a>
<a name="ln339">  free(image_data);</a>
<a name="ln340"> </a>
<a name="ln341">  d-&gt;images = g_list_append(d-&gt;images, image);</a>
<a name="ln342"> </a>
<a name="ln343"> </a>
<a name="ln344">  // finish the pdf</a>
<a name="ln345">  if(num == total)</a>
<a name="ln346">  {</a>
<a name="ln347">    int n_images = g_list_length(d-&gt;images);</a>
<a name="ln348">    dt_pdf_page_t **pages = malloc(n_images * sizeof(dt_pdf_page_t *));</a>
<a name="ln349"> </a>
<a name="ln350">    gboolean outline_mode = d-&gt;params.mode != MODE_NORMAL;</a>
<a name="ln351">    gboolean show_bb = d-&gt;params.mode == MODE_DEBUG;</a>
<a name="ln352"> </a>
<a name="ln353">    // add a page for every image</a>
<a name="ln354">    GList *iter = d-&gt;images;</a>
<a name="ln355">    int i = 0;</a>
<a name="ln356">    while(iter)</a>
<a name="ln357">    {</a>
<a name="ln358">      dt_pdf_image_t *page = (dt_pdf_image_t *)iter-&gt;data;</a>
<a name="ln359">      page-&gt;outline_mode = outline_mode;</a>
<a name="ln360">      page-&gt;show_bb = show_bb;</a>
<a name="ln361">      page-&gt;rotate_to_fit = d-&gt;params.rotate;</a>
<a name="ln362">      pages[i] = dt_pdf_add_page(d-&gt;pdf, &amp;page, 1);</a>
<a name="ln363">      iter = g_list_next(iter);</a>
<a name="ln364">      i++;</a>
<a name="ln365">    }</a>
<a name="ln366"> </a>
<a name="ln367">    // add the contact sheet(s)</a>
<a name="ln368">    // TODO</a>
<a name="ln369"> </a>
<a name="ln370">    dt_pdf_finish(d-&gt;pdf, pages, n_images);</a>
<a name="ln371"> </a>
<a name="ln372">    // we allocated the images and pages. the main pdf object gets free'ed in dt_pdf_finish().</a>
<a name="ln373">    g_list_free_full(d-&gt;images, free);</a>
<a name="ln374">    for(i = 0; i &lt; n_images; i++) free(pages[i]);</a>
<a name="ln375">    free(pages);</a>
<a name="ln376">    g_free(d-&gt;actual_filename);</a>
<a name="ln377">    g_list_free_full(d-&gt;icc_profiles, free);</a>
<a name="ln378"> </a>
<a name="ln379">    d-&gt;pdf = NULL;</a>
<a name="ln380">    d-&gt;images = NULL;</a>
<a name="ln381">    d-&gt;actual_filename = NULL;</a>
<a name="ln382">    d-&gt;icc_profiles = NULL;</a>
<a name="ln383">  } // finish the pdf</a>
<a name="ln384"> </a>
<a name="ln385">  return 0;</a>
<a name="ln386">}</a>
<a name="ln387"> </a>
<a name="ln388">int bpp(dt_imageio_module_data_t *p)</a>
<a name="ln389">{</a>
<a name="ln390">  return ((dt_imageio_pdf_params_t *)p)-&gt;bpp;</a>
<a name="ln391">}</a>
<a name="ln392"> </a>
<a name="ln393">int levels(dt_imageio_module_data_t *p)</a>
<a name="ln394">{</a>
<a name="ln395">  return IMAGEIO_RGB | (((dt_imageio_pdf_params_t *)p)-&gt;bpp == 8 ? IMAGEIO_INT8 : IMAGEIO_INT16);</a>
<a name="ln396">}</a>
<a name="ln397"> </a>
<a name="ln398">const char *mime(dt_imageio_module_data_t *data)</a>
<a name="ln399">{</a>
<a name="ln400">  return &quot;application/pdf&quot;;</a>
<a name="ln401">}</a>
<a name="ln402"> </a>
<a name="ln403">const char *extension(dt_imageio_module_data_t *data)</a>
<a name="ln404">{</a>
<a name="ln405">  return &quot;pdf&quot;;</a>
<a name="ln406">}</a>
<a name="ln407"> </a>
<a name="ln408">const char *name()</a>
<a name="ln409">{</a>
<a name="ln410">  return _(&quot;PDF&quot;);</a>
<a name="ln411">}</a>
<a name="ln412"> </a>
<a name="ln413">int flags(dt_imageio_module_data_t *data)</a>
<a name="ln414">{</a>
<a name="ln415">  return FORMAT_FLAGS_NO_TMPFILE;</a>
<a name="ln416">}</a>
<a name="ln417"> </a>
<a name="ln418">int dimension(struct dt_imageio_module_format_t *self, dt_imageio_module_data_t *data, uint32_t *width, uint32_t *height)</a>
<a name="ln419">{</a>
<a name="ln420">  if(data)</a>
<a name="ln421">  {</a>
<a name="ln422">    dt_imageio_pdf_t *d = (dt_imageio_pdf_t *)data;</a>
<a name="ln423"> </a>
<a name="ln424">    float page_width, page_height, page_border;</a>
<a name="ln425">    float page_dpi = d-&gt;params.dpi;</a>
<a name="ln426"> </a>
<a name="ln427">    if(_paper_size(&amp;d-&gt;params, &amp;page_width, &amp;page_height, &amp;page_border))</a>
<a name="ln428">      return 1;</a>
<a name="ln429"> </a>
<a name="ln430">    *width = dt_pdf_point_to_pixel(page_width - 2 * page_border, page_dpi) + 0.5;</a>
<a name="ln431">    *height = dt_pdf_point_to_pixel(page_height - 2 * page_border, page_dpi) + 0.5;</a>
<a name="ln432"> </a>
<a name="ln433">    if(d-&gt;params.rotate)</a>
<a name="ln434">      *width = *height = MAX(*width, *height);</a>
<a name="ln435">  }</a>
<a name="ln436">  return 0;</a>
<a name="ln437">}</a>
<a name="ln438"> </a>
<a name="ln439">static void size_toggle_callback(GtkWidget *widget, gpointer user_data);</a>
<a name="ln440"> </a>
<a name="ln441">// set the paper size dropdown from the UNTRANSLATED string</a>
<a name="ln442">static void _set_paper_size(dt_imageio_module_format_t *self, const char *text)</a>
<a name="ln443">{</a>
<a name="ln444">  pdf_t *d = (pdf_t *)self-&gt;gui_data;</a>
<a name="ln445"> </a>
<a name="ln446">  if(text == NULL || *text == '\0')</a>
<a name="ln447">  {</a>
<a name="ln448">    _set_paper_size(self, dt_pdf_paper_sizes[0].name);</a>
<a name="ln449">    return;</a>
<a name="ln450">  }</a>
<a name="ln451"> </a>
<a name="ln452">  g_signal_handlers_block_by_func(d-&gt;size, size_toggle_callback, self);</a>
<a name="ln453"> </a>
<a name="ln454">  const GList *entries = dt_bauhaus_combobox_get_entries(d-&gt;size);</a>
<a name="ln455">  int pos = 0;</a>
<a name="ln456"> </a>
<a name="ln457">  while(entries)</a>
<a name="ln458">  {</a>
<a name="ln459">    const dt_bauhaus_combobox_entry_t *entry = (dt_bauhaus_combobox_entry_t *)entries-&gt;data;</a>
<a name="ln460">    if((pos &lt; dt_pdf_paper_sizes_n &amp;&amp; !strcasecmp(text, dt_pdf_paper_sizes[pos].name))</a>
<a name="ln461">        || !strcasecmp(text, entry-&gt;label))</a>
<a name="ln462">      break;</a>
<a name="ln463">    pos++;</a>
<a name="ln464">    entries = g_list_next(entries);</a>
<a name="ln465">  }</a>
<a name="ln466"> </a>
<a name="ln467">  if(entries)</a>
<a name="ln468">  {</a>
<a name="ln469">    // we jumped out of the loop -&gt; found it</a>
<a name="ln470">    dt_bauhaus_combobox_set(d-&gt;size, pos);</a>
<a name="ln471">    dt_conf_set_string(&quot;plugins/imageio/format/pdf/size&quot;, text);</a>
<a name="ln472">  }</a>
<a name="ln473">  else</a>
<a name="ln474">  {</a>
<a name="ln475">    // newly seen -- check if it is valid</a>
<a name="ln476">    float width, height;</a>
<a name="ln477">    if(dt_pdf_parse_paper_size(text, &amp;width, &amp;height))</a>
<a name="ln478">    {</a>
<a name="ln479">      // seems to be ok</a>
<a name="ln480">      dt_bauhaus_combobox_add(d-&gt;size, text);</a>
<a name="ln481">      dt_bauhaus_combobox_set(d-&gt;size, pos);</a>
<a name="ln482">      dt_conf_set_string(&quot;plugins/imageio/format/pdf/size&quot;, text);</a>
<a name="ln483">    }</a>
<a name="ln484">    else</a>
<a name="ln485">    {</a>
<a name="ln486">      dt_control_log(_(&quot;invalid paper size&quot;));</a>
<a name="ln487">      gchar *old_size = dt_conf_get_string(&quot;plugins/imageio/format/pdf/size&quot;);</a>
<a name="ln488">      if(old_size)</a>
<a name="ln489">      {</a>
<a name="ln490">        // safeguard against strange stuff in config</a>
<a name="ln491">        if(dt_pdf_parse_paper_size(old_size, &amp;width, &amp;height))</a>
<a name="ln492">          _set_paper_size(self, old_size);</a>
<a name="ln493">        else</a>
<a name="ln494">          _set_paper_size(self, dt_pdf_paper_sizes[0].name);</a>
<a name="ln495"> </a>
<a name="ln496">        g_free(old_size);</a>
<a name="ln497">      }</a>
<a name="ln498">    }</a>
<a name="ln499">  }</a>
<a name="ln500"> </a>
<a name="ln501">  g_signal_handlers_unblock_by_func(d-&gt;size, size_toggle_callback, self);</a>
<a name="ln502"> </a>
<a name="ln503">}</a>
<a name="ln504"> </a>
<a name="ln505">static void title_changed_callback(GtkWidget *widget, gpointer user_data)</a>
<a name="ln506">{</a>
<a name="ln507">  dt_conf_set_string(&quot;plugins/imageio/format/pdf/title&quot;, gtk_entry_get_text(GTK_ENTRY(widget)));</a>
<a name="ln508">}</a>
<a name="ln509"> </a>
<a name="ln510">static void border_changed_callback(GtkWidget *widget, gpointer user_data)</a>
<a name="ln511">{</a>
<a name="ln512">  dt_conf_set_string(&quot;plugins/imageio/format/pdf/border&quot;, gtk_entry_get_text(GTK_ENTRY(widget)));</a>
<a name="ln513">}</a>
<a name="ln514"> </a>
<a name="ln515">static void size_toggle_callback(GtkWidget *widget, gpointer user_data)</a>
<a name="ln516">{</a>
<a name="ln517">  unsigned int pos = dt_bauhaus_combobox_get(widget);</a>
<a name="ln518">  if(pos &lt; dt_pdf_paper_sizes_n)</a>
<a name="ln519">    _set_paper_size(user_data, dt_pdf_paper_sizes[pos].name); // has to be untranslated</a>
<a name="ln520">    else</a>
<a name="ln521">      _set_paper_size(user_data, dt_bauhaus_combobox_get_text(widget));</a>
<a name="ln522">}</a>
<a name="ln523"> </a>
<a name="ln524">static void orientation_toggle_callback(GtkWidget *widget, gpointer user_data)</a>
<a name="ln525">{</a>
<a name="ln526">  dt_conf_set_int(&quot;plugins/imageio/format/pdf/orientation&quot;, dt_bauhaus_combobox_get(widget));</a>
<a name="ln527">}</a>
<a name="ln528"> </a>
<a name="ln529">static void dpi_changed_callback(GtkWidget *widget, gpointer user_data)</a>
<a name="ln530">{</a>
<a name="ln531">  dt_conf_set_float(&quot;plugins/imageio/format/pdf/dpi&quot;, gtk_spin_button_get_value(GTK_SPIN_BUTTON(widget)));</a>
<a name="ln532">}</a>
<a name="ln533"> </a>
<a name="ln534">static void rotate_toggle_callback(GtkWidget *widget, gpointer user_data)</a>
<a name="ln535">{</a>
<a name="ln536">  dt_conf_set_bool(&quot;plugins/imageio/format/pdf/rotate&quot;, dt_bauhaus_combobox_get(widget) == 1);</a>
<a name="ln537">}</a>
<a name="ln538"> </a>
<a name="ln539">static void pages_toggle_callback(GtkWidget *widget, gpointer user_data)</a>
<a name="ln540">{</a>
<a name="ln541">  dt_conf_set_int(&quot;plugins/imageio/format/pdf/pages&quot;, dt_bauhaus_combobox_get(widget));</a>
<a name="ln542">}</a>
<a name="ln543"> </a>
<a name="ln544">static void icc_toggle_callback(GtkWidget *widget, gpointer user_data)</a>
<a name="ln545">{</a>
<a name="ln546">  dt_conf_set_bool(&quot;plugins/imageio/format/pdf/icc&quot;, dt_bauhaus_combobox_get(widget) == 1);</a>
<a name="ln547">}</a>
<a name="ln548"> </a>
<a name="ln549">static void mode_toggle_callback(GtkWidget *widget, gpointer user_data)</a>
<a name="ln550">{</a>
<a name="ln551">  dt_conf_set_int(&quot;plugins/imageio/format/pdf/mode&quot;, dt_bauhaus_combobox_get(widget));</a>
<a name="ln552">}</a>
<a name="ln553"> </a>
<a name="ln554">static void bpp_toggle_callback(GtkWidget *widget, gpointer user_data)</a>
<a name="ln555">{</a>
<a name="ln556">  const int sel = dt_bauhaus_combobox_get(widget);</a>
<a name="ln557">  // we don't allow typing in that dropdown so -1 shouldn't happen, but coverity doesn't know that</a>
<a name="ln558">  if(sel &gt;= 0)</a>
<a name="ln559">    dt_conf_set_int(&quot;plugins/imageio/format/pdf/bpp&quot;, _pdf_bpp[sel].bpp);</a>
<a name="ln560">}</a>
<a name="ln561"> </a>
<a name="ln562">static void compression_toggle_callback(GtkWidget *widget, gpointer user_data)</a>
<a name="ln563">{</a>
<a name="ln564">  dt_conf_set_int(&quot;plugins/imageio/format/pdf/compression&quot;, dt_bauhaus_combobox_get(widget));</a>
<a name="ln565">}</a>
<a name="ln566"> </a>
<a name="ln567">void gui_init(dt_imageio_module_format_t *self)</a>
<a name="ln568">{</a>
<a name="ln569">  pdf_t *d = calloc(1, sizeof(pdf_t));</a>
<a name="ln570">  self-&gt;gui_data = (void *)d;</a>
<a name="ln571">  self-&gt;widget = gtk_grid_new();</a>
<a name="ln572">  GtkGrid *grid = GTK_GRID(self-&gt;widget);</a>
<a name="ln573">  gtk_grid_set_row_spacing(grid, DT_PIXEL_APPLY_DPI(5));</a>
<a name="ln574">  gtk_grid_set_column_spacing(grid, DT_PIXEL_APPLY_DPI(8));</a>
<a name="ln575"> </a>
<a name="ln576">  GtkWidget *widget;</a>
<a name="ln577">  int line = 0;</a>
<a name="ln578"> </a>
<a name="ln579">  // title</a>
<a name="ln580"> </a>
<a name="ln581">  widget = gtk_label_new(_(&quot;title&quot;));</a>
<a name="ln582">  gtk_widget_set_halign(widget, GTK_ALIGN_START);</a>
<a name="ln583">  g_object_set(G_OBJECT(widget), &quot;xalign&quot;, 0.0, (gchar *)0);</a>
<a name="ln584">  gtk_grid_attach(grid, widget, 0, ++line, 1, 1);</a>
<a name="ln585"> </a>
<a name="ln586">  d-&gt;title = GTK_ENTRY(gtk_entry_new());</a>
<a name="ln587">  gtk_entry_set_placeholder_text(d-&gt;title, &quot;untitled&quot;);</a>
<a name="ln588">  gtk_widget_set_hexpand(GTK_WIDGET(d-&gt;title), TRUE);</a>
<a name="ln589">  gtk_grid_attach(grid, GTK_WIDGET(d-&gt;title), 1, line, 1, 1);</a>
<a name="ln590">  dt_gui_key_accel_block_on_focus_connect(GTK_WIDGET(d-&gt;title));</a>
<a name="ln591">  gtk_widget_set_tooltip_text(GTK_WIDGET(d-&gt;title), _(&quot;enter the title of the pdf&quot;));</a>
<a name="ln592">  gchar *str = dt_conf_get_string(&quot;plugins/imageio/format/pdf/title&quot;);</a>
<a name="ln593">  if(str)</a>
<a name="ln594">  {</a>
<a name="ln595">    gtk_entry_set_text(GTK_ENTRY(d-&gt;title), str);</a>
<a name="ln596">    g_free(str);</a>
<a name="ln597">  }</a>
<a name="ln598">  g_signal_connect(G_OBJECT(d-&gt;title), &quot;changed&quot;, G_CALLBACK(title_changed_callback), self);</a>
<a name="ln599"> </a>
<a name="ln600">  // paper size</a>
<a name="ln601"> </a>
<a name="ln602">  d-&gt;size = dt_bauhaus_combobox_new(NULL);</a>
<a name="ln603">  dt_bauhaus_combobox_set_editable(d-&gt;size, 1);</a>
<a name="ln604">  dt_bauhaus_widget_set_label(d-&gt;size, NULL, _(&quot;paper size&quot;));</a>
<a name="ln605">  for(int i = 0; dt_pdf_paper_sizes[i].name; i++)</a>
<a name="ln606">    dt_bauhaus_combobox_add(d-&gt;size, _(dt_pdf_paper_sizes[i].name));</a>
<a name="ln607">  gtk_grid_attach(grid, GTK_WIDGET(d-&gt;size), 0, ++line, 2, 1);</a>
<a name="ln608">  g_signal_connect(G_OBJECT(d-&gt;size), &quot;value-changed&quot;, G_CALLBACK(size_toggle_callback), self);</a>
<a name="ln609">  gtk_widget_set_tooltip_text(d-&gt;size, _(&quot;paper size of the pdf\neither one from the list or &quot;</a>
<a name="ln610">                                         &quot;\&quot;&lt;width&gt; [unit] x &lt;height&gt; &lt;unit&gt;\n&quot;</a>
<a name="ln611">                                         &quot;example: 210 mm x 2.97 cm&quot;));</a>
<a name="ln612">  str = dt_conf_get_string(&quot;plugins/imageio/format/pdf/size&quot;);</a>
<a name="ln613">  _set_paper_size(self, str);</a>
<a name="ln614">  g_free(str);</a>
<a name="ln615"> </a>
<a name="ln616">  // orientation</a>
<a name="ln617"> </a>
<a name="ln618">  d-&gt;orientation = dt_bauhaus_combobox_new(NULL);</a>
<a name="ln619">  dt_bauhaus_widget_set_label(d-&gt;orientation, NULL, _(&quot;page orientation&quot;));</a>
<a name="ln620">  dt_bauhaus_combobox_add(d-&gt;orientation, _(&quot;portrait&quot;));</a>
<a name="ln621">  dt_bauhaus_combobox_add(d-&gt;orientation, _(&quot;landscape&quot;));</a>
<a name="ln622">  gtk_grid_attach(grid, GTK_WIDGET(d-&gt;orientation), 0, ++line, 2, 1);</a>
<a name="ln623">  g_signal_connect(G_OBJECT(d-&gt;orientation), &quot;value-changed&quot;, G_CALLBACK(orientation_toggle_callback), self);</a>
<a name="ln624">  gtk_widget_set_tooltip_text(d-&gt;orientation, _(&quot;paper orientation of the pdf&quot;));</a>
<a name="ln625">  dt_bauhaus_combobox_set(d-&gt;orientation, dt_conf_get_int(&quot;plugins/imageio/format/pdf/orientation&quot;));</a>
<a name="ln626"> </a>
<a name="ln627">  // border</a>
<a name="ln628"> </a>
<a name="ln629">  widget = gtk_label_new(_(&quot;border&quot;));</a>
<a name="ln630">  gtk_widget_set_halign(widget, GTK_ALIGN_START);</a>
<a name="ln631">  g_object_set(G_OBJECT(widget), &quot;xalign&quot;, 0.0, (gchar *)0);</a>
<a name="ln632">  gtk_grid_attach(grid, widget, 0, ++line, 1, 1);</a>
<a name="ln633"> </a>
<a name="ln634">  d-&gt;border = GTK_ENTRY(gtk_entry_new());</a>
<a name="ln635">  gtk_entry_set_max_length(d-&gt;border, sizeof(((dt_imageio_pdf_params_t *)NULL)-&gt;border) - 1);</a>
<a name="ln636">  gtk_entry_set_placeholder_text(d-&gt;border, &quot;0 mm&quot;);</a>
<a name="ln637">  gtk_grid_attach(grid, GTK_WIDGET(d-&gt;border), 1, line, 1, 1);</a>
<a name="ln638">  dt_gui_key_accel_block_on_focus_connect(GTK_WIDGET(d-&gt;border));</a>
<a name="ln639">  gtk_widget_set_tooltip_text(GTK_WIDGET(d-&gt;border), _(&quot;empty space around the pdf\n&quot;</a>
<a name="ln640">                                                       &quot;format: size + unit\nexamples: 10 mm, 1 inch&quot;));</a>
<a name="ln641">  str = dt_conf_get_string(&quot;plugins/imageio/format/pdf/border&quot;);</a>
<a name="ln642">  if(str)</a>
<a name="ln643">  {</a>
<a name="ln644">    gtk_entry_set_text(GTK_ENTRY(d-&gt;border), str);</a>
<a name="ln645">    g_free(str);</a>
<a name="ln646">  }</a>
<a name="ln647">  g_signal_connect(G_OBJECT(d-&gt;border), &quot;changed&quot;, G_CALLBACK(border_changed_callback), self);</a>
<a name="ln648"> </a>
<a name="ln649">  // dpi</a>
<a name="ln650"> </a>
<a name="ln651">  widget = gtk_label_new(_(&quot;dpi&quot;));</a>
<a name="ln652">  gtk_widget_set_halign(widget, GTK_ALIGN_START);</a>
<a name="ln653">  g_object_set(G_OBJECT(widget), &quot;xalign&quot;, 0.0, (gchar *)0);</a>
<a name="ln654">  gtk_grid_attach(grid, widget, 0, ++line, 1, 1);</a>
<a name="ln655"> </a>
<a name="ln656">  d-&gt;dpi = GTK_SPIN_BUTTON(gtk_spin_button_new_with_range(1, 5000, 1));</a>
<a name="ln657">  gtk_grid_attach(grid, GTK_WIDGET(d-&gt;dpi), 1, line, 1, 1);</a>
<a name="ln658">  dt_gui_key_accel_block_on_focus_connect(GTK_WIDGET(d-&gt;dpi));</a>
<a name="ln659">  gtk_widget_set_tooltip_text(GTK_WIDGET(d-&gt;dpi), _(&quot;dpi of the images inside the pdf&quot;));</a>
<a name="ln660">  gtk_spin_button_set_value(d-&gt;dpi, dt_conf_get_float(&quot;plugins/imageio/format/pdf/dpi&quot;));</a>
<a name="ln661">  g_signal_connect(G_OBJECT(d-&gt;dpi), &quot;value-changed&quot;, G_CALLBACK(dpi_changed_callback), self);</a>
<a name="ln662"> </a>
<a name="ln663">  // rotate images yes|no</a>
<a name="ln664"> </a>
<a name="ln665">  d-&gt;rotate = dt_bauhaus_combobox_new(NULL);</a>
<a name="ln666">  dt_bauhaus_widget_set_label(d-&gt;rotate, NULL, _(&quot;rotate images&quot;));</a>
<a name="ln667">  dt_bauhaus_combobox_add(d-&gt;rotate, _(&quot;no&quot;));</a>
<a name="ln668">  dt_bauhaus_combobox_add(d-&gt;rotate, _(&quot;yes&quot;));</a>
<a name="ln669">  gtk_grid_attach(grid, GTK_WIDGET(d-&gt;rotate), 0, ++line, 2, 1);</a>
<a name="ln670">  g_signal_connect(G_OBJECT(d-&gt;rotate), &quot;value-changed&quot;, G_CALLBACK(rotate_toggle_callback), self);</a>
<a name="ln671">  gtk_widget_set_tooltip_text(d-&gt;rotate, _(&quot;images can be rotated to match the pdf orientation &quot;</a>
<a name="ln672">                                           &quot;to waste less space when printing&quot;));</a>
<a name="ln673">  dt_bauhaus_combobox_set(d-&gt;rotate, dt_conf_get_bool(&quot;plugins/imageio/format/pdf/rotate&quot;));</a>
<a name="ln674"> </a>
<a name="ln675">  // pages all|single images|contact sheet</a>
<a name="ln676"> </a>
<a name="ln677">  d-&gt;pages = dt_bauhaus_combobox_new(NULL);</a>
<a name="ln678">  dt_bauhaus_widget_set_label(d-&gt;pages, NULL, _(&quot;TODO: pages&quot;));</a>
<a name="ln679">  dt_bauhaus_combobox_add(d-&gt;pages, _(&quot;all&quot;));</a>
<a name="ln680">  dt_bauhaus_combobox_add(d-&gt;pages, _(&quot;single images&quot;));</a>
<a name="ln681">  dt_bauhaus_combobox_add(d-&gt;pages, _(&quot;contact sheet&quot;));</a>
<a name="ln682">//   gtk_grid_attach(grid, GTK_WIDGET(d-&gt;pages), 0, ++line, 2, 1);</a>
<a name="ln683">//   g_signal_connect(G_OBJECT(d-&gt;pages), &quot;value-changed&quot;, G_CALLBACK(pages_toggle_callback), self);</a>
<a name="ln684">  gtk_widget_set_tooltip_text(d-&gt;pages, _(&quot;what pages should be added to the pdf&quot;));</a>
<a name="ln685">  dt_bauhaus_combobox_set(d-&gt;pages, dt_conf_get_int(&quot;plugins/imageio/format/pdf/pages&quot;));</a>
<a name="ln686">  gtk_widget_set_sensitive(d-&gt;pages, FALSE); // TODO</a>
<a name="ln687"> </a>
<a name="ln688">  // embedded icc profile yes|no</a>
<a name="ln689"> </a>
<a name="ln690">  d-&gt;icc = dt_bauhaus_combobox_new(NULL);</a>
<a name="ln691">  dt_bauhaus_widget_set_label(d-&gt;icc, NULL, _(&quot;embed icc profiles&quot;));</a>
<a name="ln692">  dt_bauhaus_combobox_add(d-&gt;icc, _(&quot;no&quot;));</a>
<a name="ln693">  dt_bauhaus_combobox_add(d-&gt;icc, _(&quot;yes&quot;));</a>
<a name="ln694">  gtk_grid_attach(grid, GTK_WIDGET(d-&gt;icc), 0, ++line, 2, 1);</a>
<a name="ln695">  g_signal_connect(G_OBJECT(d-&gt;icc), &quot;value-changed&quot;, G_CALLBACK(icc_toggle_callback), self);</a>
<a name="ln696">  gtk_widget_set_tooltip_text(d-&gt;icc, _(&quot;images can be tagged with their icc profile&quot;));</a>
<a name="ln697">  dt_bauhaus_combobox_set(d-&gt;icc, dt_conf_get_bool(&quot;plugins/imageio/format/pdf/icc&quot;));</a>
<a name="ln698"> </a>
<a name="ln699">  // bpp</a>
<a name="ln700"> </a>
<a name="ln701">  d-&gt;bpp = dt_bauhaus_combobox_new(NULL);</a>
<a name="ln702">  dt_bauhaus_widget_set_label(d-&gt;bpp, NULL, _(&quot;bit depth&quot;));</a>
<a name="ln703">  int sel = 0;</a>
<a name="ln704">  int bpp = dt_conf_get_int(&quot;plugins/imageio/format/pdf/bpp&quot;);</a>
<a name="ln705">  for(int i = 0; _pdf_bpp[i].name; i++)</a>
<a name="ln706">  {</a>
<a name="ln707">    dt_bauhaus_combobox_add(d-&gt;bpp, _(_pdf_bpp[i].name));</a>
<a name="ln708">    if(_pdf_bpp[i].bpp == bpp) sel = i;</a>
<a name="ln709">  }</a>
<a name="ln710">  gtk_grid_attach(grid, GTK_WIDGET(d-&gt;bpp), 0, ++line, 2, 1);</a>
<a name="ln711">  g_signal_connect(G_OBJECT(d-&gt;bpp), &quot;value-changed&quot;, G_CALLBACK(bpp_toggle_callback), self);</a>
<a name="ln712">  gtk_widget_set_tooltip_text(d-&gt;bpp, _(&quot;bits per channel of the embedded images&quot;));</a>
<a name="ln713">  dt_bauhaus_combobox_set(d-&gt;bpp, sel);</a>
<a name="ln714"> </a>
<a name="ln715">  // compression</a>
<a name="ln716"> </a>
<a name="ln717">  d-&gt;compression = dt_bauhaus_combobox_new(NULL);</a>
<a name="ln718">  dt_bauhaus_widget_set_label(d-&gt;compression, NULL, _(&quot;compression&quot;));</a>
<a name="ln719">  dt_bauhaus_combobox_add(d-&gt;compression, _(&quot;uncompressed&quot;));</a>
<a name="ln720">  dt_bauhaus_combobox_add(d-&gt;compression, _(&quot;deflate&quot;));</a>
<a name="ln721">  gtk_grid_attach(grid, GTK_WIDGET(d-&gt;compression), 0, ++line, 2, 1);</a>
<a name="ln722">  g_signal_connect(G_OBJECT(d-&gt;compression), &quot;value-changed&quot;, G_CALLBACK(compression_toggle_callback), self);</a>
<a name="ln723">  gtk_widget_set_tooltip_text(d-&gt;compression, _(&quot;method used for image compression\n&quot;</a>
<a name="ln724">                                                &quot;uncompressed -- fast but big files\n&quot;</a>
<a name="ln725">                                                &quot;deflate -- smaller files but slower&quot;));</a>
<a name="ln726">  dt_bauhaus_combobox_set(d-&gt;compression, dt_conf_get_int(&quot;plugins/imageio/format/pdf/compression&quot;));</a>
<a name="ln727"> </a>
<a name="ln728">  // image mode normal|draft|debug</a>
<a name="ln729"> </a>
<a name="ln730">  d-&gt;mode = dt_bauhaus_combobox_new(NULL);</a>
<a name="ln731">  dt_bauhaus_widget_set_label(d-&gt;mode, NULL, _(&quot;image mode&quot;));</a>
<a name="ln732">  dt_bauhaus_combobox_add(d-&gt;mode, _(&quot;normal&quot;));</a>
<a name="ln733">  dt_bauhaus_combobox_add(d-&gt;mode, _(&quot;draft&quot;));</a>
<a name="ln734">  dt_bauhaus_combobox_add(d-&gt;mode, _(&quot;debug&quot;));</a>
<a name="ln735">  gtk_grid_attach(grid, GTK_WIDGET(d-&gt;mode), 0, ++line, 2, 1);</a>
<a name="ln736">  g_signal_connect(G_OBJECT(d-&gt;mode), &quot;value-changed&quot;, G_CALLBACK(mode_toggle_callback), self);</a>
<a name="ln737">  gtk_widget_set_tooltip_text(d-&gt;mode, _(&quot;normal -- just put the images into the pdf\n&quot;</a>
<a name="ln738">                                         &quot;draft -- images are replaced with boxes\n&quot;</a>
<a name="ln739">                                         &quot;debug -- only show the outlines and bounding boxen&quot;));</a>
<a name="ln740">  dt_bauhaus_combobox_set(d-&gt;mode, dt_conf_get_int(&quot;plugins/imageio/format/pdf/mode&quot;));</a>
<a name="ln741">}</a>
<a name="ln742"> </a>
<a name="ln743">void gui_cleanup(dt_imageio_module_format_t *self)</a>
<a name="ln744">{</a>
<a name="ln745">  pdf_t *d = (pdf_t *)self-&gt;gui_data;</a>
<a name="ln746">  dt_gui_key_accel_block_on_focus_disconnect(GTK_WIDGET(d-&gt;title));</a>
<a name="ln747">  dt_gui_key_accel_block_on_focus_disconnect(GTK_WIDGET(d-&gt;dpi));</a>
<a name="ln748">  free(self-&gt;gui_data);</a>
<a name="ln749">}</a>
<a name="ln750"> </a>
<a name="ln751">void gui_reset(dt_imageio_module_format_t *self)</a>
<a name="ln752">{</a>
<a name="ln753">  pdf_t *d = (pdf_t *)self-&gt;gui_data;</a>
<a name="ln754"> </a>
<a name="ln755">  dpi_changed_callback(GTK_WIDGET(d-&gt;dpi), self);</a>
<a name="ln756">  icc_toggle_callback(GTK_WIDGET(d-&gt;icc), self);</a>
<a name="ln757">  mode_toggle_callback(GTK_WIDGET(d-&gt;mode), self);</a>
<a name="ln758">  orientation_toggle_callback(GTK_WIDGET(d-&gt;orientation), self);</a>
<a name="ln759">  pages_toggle_callback(GTK_WIDGET(d-&gt;pages), self);</a>
<a name="ln760">  rotate_toggle_callback(GTK_WIDGET(d-&gt;rotate), self);</a>
<a name="ln761">  size_toggle_callback(GTK_WIDGET(d-&gt;size), self);</a>
<a name="ln762">  title_changed_callback(GTK_WIDGET(d-&gt;title), self);</a>
<a name="ln763">  bpp_toggle_callback(GTK_WIDGET(d-&gt;bpp), self);</a>
<a name="ln764">  compression_toggle_callback(GTK_WIDGET(d-&gt;compression), self);</a>
<a name="ln765">}</a>
<a name="ln766"> </a>
<a name="ln767">size_t params_size(dt_imageio_module_format_t *self)</a>
<a name="ln768">{</a>
<a name="ln769">  return sizeof(dt_imageio_pdf_params_t);</a>
<a name="ln770">}</a>
<a name="ln771"> </a>
<a name="ln772">void *get_params(dt_imageio_module_format_t *self)</a>
<a name="ln773">{</a>
<a name="ln774">  dt_imageio_pdf_t *d = (dt_imageio_pdf_t *)calloc(1, sizeof(dt_imageio_pdf_t));</a>
<a name="ln775"> </a>
<a name="ln776">  if(d)</a>
<a name="ln777">  {</a>
<a name="ln778">    gchar *text = dt_conf_get_string(&quot;plugins/imageio/format/pdf/title&quot;);</a>
<a name="ln779">    g_strlcpy(d-&gt;params.title, text, sizeof(d-&gt;params.title));</a>
<a name="ln780">    g_free(text);</a>
<a name="ln781"> </a>
<a name="ln782">    text = dt_conf_get_string(&quot;plugins/imageio/format/pdf/border&quot;);</a>
<a name="ln783">    g_strlcpy(d-&gt;params.border, text, sizeof(d-&gt;params.border));</a>
<a name="ln784">    g_free(text);</a>
<a name="ln785"> </a>
<a name="ln786">    text = dt_conf_get_string(&quot;plugins/imageio/format/pdf/size&quot;);</a>
<a name="ln787">    g_strlcpy(d-&gt;params.size, text, sizeof(d-&gt;params.size));</a>
<a name="ln788">    g_free(text);</a>
<a name="ln789"> </a>
<a name="ln790">    d-&gt;params.bpp = dt_conf_get_int(&quot;plugins/imageio/format/pdf/bpp&quot;);</a>
<a name="ln791">    d-&gt;params.compression = dt_conf_get_int(&quot;plugins/imageio/format/pdf/compression&quot;);</a>
<a name="ln792">    d-&gt;params.dpi = dt_conf_get_float(&quot;plugins/imageio/format/pdf/dpi&quot;);</a>
<a name="ln793">    d-&gt;params.icc = dt_conf_get_bool(&quot;plugins/imageio/format/pdf/icc&quot;);</a>
<a name="ln794">    d-&gt;params.mode = dt_conf_get_int(&quot;plugins/imageio/format/pdf/mode&quot;);</a>
<a name="ln795">    d-&gt;params.orientation = dt_conf_get_int(&quot;plugins/imageio/format/pdf/orientation&quot;);</a>
<a name="ln796">    d-&gt;params.pages = dt_conf_get_int(&quot;plugins/imageio/format/pdf/pages&quot;);</a>
<a name="ln797">    d-&gt;params.rotate = dt_conf_get_bool(&quot;plugins/imageio/format/pdf/rotate&quot;);</a>
<a name="ln798">  }</a>
<a name="ln799"> </a>
<a name="ln800">  return d;</a>
<a name="ln801">}</a>
<a name="ln802"> </a>
<a name="ln803">// in normal operations we free these after exporting the last image, but when an export</a>
<a name="ln804">// gets cancelled that last image doesn't get exported, so we have to take care of it here.</a>
<a name="ln805">void free_params(dt_imageio_module_format_t *self, dt_imageio_module_data_t *params)</a>
<a name="ln806">{</a>
<a name="ln807">  dt_imageio_pdf_t *d = (dt_imageio_pdf_t *)params;</a>
<a name="ln808"> </a>
<a name="ln809">  if(d-&gt;pdf)</a>
<a name="ln810">    dt_pdf_finish(d-&gt;pdf, NULL, 0);</a>
<a name="ln811"> </a>
<a name="ln812">  g_list_free_full(d-&gt;images, free);</a>
<a name="ln813"> </a>
<a name="ln814">  if(d-&gt;actual_filename)</a>
<a name="ln815">  {</a>
<a name="ln816">    g_unlink(d-&gt;actual_filename); // no need to leave broken files on disk</a>
<a name="ln817">    g_free(d-&gt;actual_filename);</a>
<a name="ln818">  }</a>
<a name="ln819"> </a>
<a name="ln820">  g_list_free_full(d-&gt;icc_profiles, free);</a>
<a name="ln821"> </a>
<a name="ln822">  d-&gt;pdf = NULL;</a>
<a name="ln823">  d-&gt;images = NULL;</a>
<a name="ln824">  d-&gt;actual_filename = NULL;</a>
<a name="ln825">  d-&gt;icc_profiles = NULL;</a>
<a name="ln826"> </a>
<a name="ln827">  free(params);</a>
<a name="ln828">}</a>
<a name="ln829"> </a>
<a name="ln830">int set_params(dt_imageio_module_format_t *self, const void *params, const int size)</a>
<a name="ln831">{</a>
<a name="ln832">  if(size != self-&gt;params_size(self)) return 1;</a>
<a name="ln833">  const dt_imageio_pdf_t *d = (dt_imageio_pdf_t *)params;</a>
<a name="ln834">  pdf_t *g = (pdf_t *)self-&gt;gui_data;</a>
<a name="ln835"> </a>
<a name="ln836">  for(int i = 0; _pdf_bpp[i].name; i++)</a>
<a name="ln837">  {</a>
<a name="ln838">    if(_pdf_bpp[i].bpp == d-&gt;params.bpp)</a>
<a name="ln839">      dt_bauhaus_combobox_set(g-&gt;bpp, i);</a>
<a name="ln840">  }</a>
<a name="ln841"> </a>
<a name="ln842">  gtk_entry_set_text(g-&gt;title, d-&gt;params.title);</a>
<a name="ln843">  gtk_entry_set_text(g-&gt;border, d-&gt;params.border);</a>
<a name="ln844">  dt_bauhaus_combobox_set(g-&gt;compression, d-&gt;params.compression);</a>
<a name="ln845">  gtk_spin_button_set_value(g-&gt;dpi, d-&gt;params.dpi);</a>
<a name="ln846">  dt_bauhaus_combobox_set(g-&gt;icc, d-&gt;params.icc);</a>
<a name="ln847">  dt_bauhaus_combobox_set(g-&gt;mode, d-&gt;params.mode);</a>
<a name="ln848">  dt_bauhaus_combobox_set(g-&gt;orientation, d-&gt;params.orientation);</a>
<a name="ln849">  dt_bauhaus_combobox_set(g-&gt;pages, d-&gt;params.pages);</a>
<a name="ln850">  dt_bauhaus_combobox_set(g-&gt;rotate, d-&gt;params.rotate);</a>
<a name="ln851">  _set_paper_size(self, d-&gt;params.size);</a>
<a name="ln852"> </a>
<a name="ln853">  dt_conf_set_string(&quot;plugins/imageio/format/pdf/title&quot;, d-&gt;params.title);</a>
<a name="ln854">  dt_conf_set_string(&quot;plugins/imageio/format/pdf/border&quot;, d-&gt;params.border);</a>
<a name="ln855">  dt_conf_set_int(&quot;plugins/imageio/format/pdf/bpp&quot;, d-&gt;params.bpp);</a>
<a name="ln856">  dt_conf_set_int(&quot;plugins/imageio/format/pdf/compression&quot;, d-&gt;params.compression);</a>
<a name="ln857">  dt_conf_set_float(&quot;plugins/imageio/format/pdf/dpi&quot;, d-&gt;params.dpi);</a>
<a name="ln858">  dt_conf_set_bool(&quot;plugins/imageio/format/pdf/icc&quot;, d-&gt;params.icc);</a>
<a name="ln859">  dt_conf_set_int(&quot;plugins/imageio/format/pdf/mode&quot;, d-&gt;params.mode);</a>
<a name="ln860">  dt_conf_set_int(&quot;plugins/imageio/format/pdf/orientation&quot;, d-&gt;params.orientation);</a>
<a name="ln861">  dt_conf_set_int(&quot;plugins/imageio/format/pdf/pages&quot;, d-&gt;params.pages);</a>
<a name="ln862">  dt_conf_set_bool(&quot;plugins/imageio/format/pdf/rotate&quot;, d-&gt;params.rotate);</a>
<a name="ln863"> </a>
<a name="ln864">  return 0;</a>
<a name="ln865">}</a>
<a name="ln866"> </a>
<a name="ln867">// modelines: These editor modelines have been set for all relevant files by tools/update_modelines.sh</a>
<a name="ln868">// vim: shiftwidth=2 expandtab tabstop=2 cindent</a>
<a name="ln869">// kate: tab-indents: off; indent-width 2; replace-tabs on; indent-mode cstyle; remove-trailing-spaces modified;</a>

</code></pre>
<div class="balloon" rel="296"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v522/" target="_blank">V522</a> There might be dereferencing of a potential null pointer 'icc'. Check lines: 296, 295.</p></div>
<div class="balloon" rel="318"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v575/" target="_blank">V575</a> The potential null pointer is passed into 'memcpy' function. Inspect the first argument. Check lines: 318, 312.</p></div>
<div class="balloon" rel="331"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v522/" target="_blank">V522</a> There might be dereferencing of a potential null pointer 'out_ptr'. Check lines: 331, 323.</p></div>
<div class="balloon" rel="362"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v522/" target="_blank">V522</a> There might be dereferencing of a potential null pointer 'pages'. Check lines: 362, 348.</p></div>
<div class="balloon" rel="586"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v522/" target="_blank">V522</a> There might be dereferencing of a potential null pointer 'd'. Check lines: 586, 569.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
