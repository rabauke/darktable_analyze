
<html>
<head>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>
<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2">    This file is part of darktable,</a>
<a name="ln3">    copyright (c) 2010-2011 henrik andersson.</a>
<a name="ln4"> </a>
<a name="ln5">    darktable is free software: you can redistribute it and/or modify</a>
<a name="ln6">    it under the terms of the GNU General Public License as published by</a>
<a name="ln7">    the Free Software Foundation, either version 3 of the License, or</a>
<a name="ln8">    (at your option) any later version.</a>
<a name="ln9"> </a>
<a name="ln10">    darktable is distributed in the hope that it will be useful,</a>
<a name="ln11">    but WITHOUT ANY WARRANTY; without even the implied warranty of</a>
<a name="ln12">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</a>
<a name="ln13">    GNU General Public License for more details.</a>
<a name="ln14"> </a>
<a name="ln15">    You should have received a copy of the GNU General Public License</a>
<a name="ln16">    along with darktable.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</a>
<a name="ln17">*/</a>
<a name="ln18"> </a>
<a name="ln19">#include &quot;common/styles.h&quot;</a>
<a name="ln20">#include &quot;common/collection.h&quot;</a>
<a name="ln21">#include &quot;common/darktable.h&quot;</a>
<a name="ln22">#include &quot;common/debug.h&quot;</a>
<a name="ln23">#include &quot;common/exif.h&quot;</a>
<a name="ln24">#include &quot;common/file_location.h&quot;</a>
<a name="ln25">#include &quot;common/history.h&quot;</a>
<a name="ln26">#include &quot;common/history_snapshot.h&quot;</a>
<a name="ln27">#include &quot;common/image_cache.h&quot;</a>
<a name="ln28">#include &quot;common/imageio.h&quot;</a>
<a name="ln29">#include &quot;common/tags.h&quot;</a>
<a name="ln30">#include &quot;control/control.h&quot;</a>
<a name="ln31">#include &quot;develop/develop.h&quot;</a>
<a name="ln32"> </a>
<a name="ln33">#include &quot;gui/accelerators.h&quot;</a>
<a name="ln34">#include &quot;gui/styles.h&quot;</a>
<a name="ln35">#include &lt;libxml/encoding.h&gt;</a>
<a name="ln36">#include &lt;libxml/xmlwriter.h&gt;</a>
<a name="ln37"> </a>
<a name="ln38">#include &lt;glib.h&gt;</a>
<a name="ln39">#include &lt;stdio.h&gt;</a>
<a name="ln40">#include &lt;string.h&gt;</a>
<a name="ln41"> </a>
<a name="ln42">typedef struct</a>
<a name="ln43">{</a>
<a name="ln44">  GString *name;</a>
<a name="ln45">  GString *description;</a>
<a name="ln46">} StyleInfoData;</a>
<a name="ln47"> </a>
<a name="ln48">typedef struct</a>
<a name="ln49">{</a>
<a name="ln50">  int num;</a>
<a name="ln51">  int module;</a>
<a name="ln52">  GString *operation;</a>
<a name="ln53">  GString *op_params;</a>
<a name="ln54">  GString *blendop_params;</a>
<a name="ln55">  int blendop_version;</a>
<a name="ln56">  int multi_priority;</a>
<a name="ln57">  GString *multi_name;</a>
<a name="ln58">  int enabled;</a>
<a name="ln59">  double iop_order;</a>
<a name="ln60">} StylePluginData;</a>
<a name="ln61"> </a>
<a name="ln62">typedef struct</a>
<a name="ln63">{</a>
<a name="ln64">  StyleInfoData *info;</a>
<a name="ln65">  GList *plugins;</a>
<a name="ln66">  gboolean in_plugin;</a>
<a name="ln67">} StyleData;</a>
<a name="ln68"> </a>
<a name="ln69">void dt_style_free(gpointer data)</a>
<a name="ln70">{</a>
<a name="ln71">  dt_style_t *style = (dt_style_t *)data;</a>
<a name="ln72">  g_free(style-&gt;name);</a>
<a name="ln73">  g_free(style-&gt;description);</a>
<a name="ln74">  style-&gt;name = NULL;</a>
<a name="ln75">  style-&gt;description = NULL;</a>
<a name="ln76">  g_free(style);</a>
<a name="ln77">}</a>
<a name="ln78"> </a>
<a name="ln79">void dt_style_item_free(gpointer data)</a>
<a name="ln80">{</a>
<a name="ln81">  dt_style_item_t *item = (dt_style_item_t *)data;</a>
<a name="ln82">  g_free(item-&gt;name);</a>
<a name="ln83">  g_free(item-&gt;operation);</a>
<a name="ln84">  g_free(item-&gt;multi_name);</a>
<a name="ln85">  free(item-&gt;params);</a>
<a name="ln86">  free(item-&gt;blendop_params);</a>
<a name="ln87">  item-&gt;name = NULL;</a>
<a name="ln88">  item-&gt;operation = NULL;</a>
<a name="ln89">  item-&gt;multi_name = NULL;</a>
<a name="ln90">  item-&gt;params = NULL;</a>
<a name="ln91">  item-&gt;blendop_params = NULL;</a>
<a name="ln92">  free(item);</a>
<a name="ln93">}</a>
<a name="ln94"> </a>
<a name="ln95">static gboolean _apply_style_shortcut_callback(GtkAccelGroup *accel_group, GObject *acceleratable,</a>
<a name="ln96">                                               guint keyval, GdkModifierType modifier, gpointer data)</a>
<a name="ln97">{</a>
<a name="ln98">  dt_styles_apply_to_selection(data, 0);</a>
<a name="ln99">  return TRUE;</a>
<a name="ln100">}</a>
<a name="ln101"> </a>
<a name="ln102">static void _destroy_style_shortcut_callback(gpointer data, GClosure *closure)</a>
<a name="ln103">{</a>
<a name="ln104">  g_free(data);</a>
<a name="ln105">}</a>
<a name="ln106"> </a>
<a name="ln107">static int32_t dt_styles_get_id_by_name(const char *name);</a>
<a name="ln108"> </a>
<a name="ln109">gboolean dt_styles_exists(const char *name)</a>
<a name="ln110">{</a>
<a name="ln111">  return (dt_styles_get_id_by_name(name)) != 0 ? TRUE : FALSE;</a>
<a name="ln112">}</a>
<a name="ln113"> </a>
<a name="ln114">static void _dt_style_cleanup_multi_instance(int id)</a>
<a name="ln115">{</a>
<a name="ln116">  sqlite3_stmt *stmt;</a>
<a name="ln117">  GList *list = NULL;</a>
<a name="ln118">  struct _data</a>
<a name="ln119">  {</a>
<a name="ln120">    int rowid;</a>
<a name="ln121">    int mi;</a>
<a name="ln122">  };</a>
<a name="ln123">  char last_operation[128] = { 0 };</a>
<a name="ln124">  int last_mi = 0;</a>
<a name="ln125"> </a>
<a name="ln126">  /* let's clean-up the style multi-instance. What we want to do is have a unique multi_priority value for</a>
<a name="ln127">     each iop.</a>
<a name="ln128">     Furthermore this value must start to 0 and increment one by one for each multi-instance of the same</a>
<a name="ln129">     module. On</a>
<a name="ln130">     SQLite there is no notion of ROW_NUMBER, so we use rather resource consuming SQL statement, but as a</a>
<a name="ln131">     style has</a>
<a name="ln132">     never a huge number of items that's not a real issue. */</a>
<a name="ln133"> </a>
<a name="ln134">  /* 1. read all data for the style and record multi_instance value. */</a>
<a name="ln135"> </a>
<a name="ln136">  DT_DEBUG_SQLITE3_PREPARE_V2(</a>
<a name="ln137">      dt_database_get(darktable.db),</a>
<a name="ln138">      &quot;SELECT rowid,operation FROM data.style_items WHERE styleid=?1 ORDER BY operation, multi_priority ASC&quot;, -1,</a>
<a name="ln139">      &amp;stmt, NULL);</a>
<a name="ln140">  DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, id);</a>
<a name="ln141"> </a>
<a name="ln142">  while(sqlite3_step(stmt) == SQLITE_ROW)</a>
<a name="ln143">  {</a>
<a name="ln144">    struct _data *d = malloc(sizeof(struct _data));</a>
<a name="ln145">    const char *operation = (const char *)sqlite3_column_text(stmt, 1);</a>
<a name="ln146"> </a>
<a name="ln147">    if(strncmp(last_operation, operation, 128) != 0)</a>
<a name="ln148">    {</a>
<a name="ln149">      last_mi = 0;</a>
<a name="ln150">      g_strlcpy(last_operation, operation, sizeof(last_operation));</a>
<a name="ln151">    }</a>
<a name="ln152">    else</a>
<a name="ln153">      last_mi++;</a>
<a name="ln154"> </a>
<a name="ln155">    d-&gt;rowid = sqlite3_column_int(stmt, 0);</a>
<a name="ln156">    d-&gt;mi = last_mi;</a>
<a name="ln157">    list = g_list_append(list, d);</a>
<a name="ln158">  }</a>
<a name="ln159">  sqlite3_finalize(stmt);</a>
<a name="ln160"> </a>
<a name="ln161">  /* 2. now update all multi_instance values previously recorded */</a>
<a name="ln162"> </a>
<a name="ln163">  list = g_list_first(list);</a>
<a name="ln164">  while(list)</a>
<a name="ln165">  {</a>
<a name="ln166">    struct _data *d = (struct _data *)list-&gt;data;</a>
<a name="ln167"> </a>
<a name="ln168">    DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln169">                                &quot;UPDATE data.style_items SET multi_priority=?1 WHERE rowid=?2&quot;, -1, &amp;stmt, NULL);</a>
<a name="ln170">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, d-&gt;mi);</a>
<a name="ln171">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 2, d-&gt;rowid);</a>
<a name="ln172">    sqlite3_step(stmt);</a>
<a name="ln173">    sqlite3_finalize(stmt);</a>
<a name="ln174"> </a>
<a name="ln175">    list = g_list_next(list);</a>
<a name="ln176">  }</a>
<a name="ln177"> </a>
<a name="ln178">  g_list_free_full(list, free);</a>
<a name="ln179">}</a>
<a name="ln180"> </a>
<a name="ln181">static gboolean dt_styles_create_style_header(const char *name, const char *description)</a>
<a name="ln182">{</a>
<a name="ln183">  sqlite3_stmt *stmt;</a>
<a name="ln184">  if(dt_styles_get_id_by_name(name) != 0)</a>
<a name="ln185">  {</a>
<a name="ln186">    dt_control_log(_(&quot;style with name '%s' already exists&quot;), name);</a>
<a name="ln187">    return FALSE;</a>
<a name="ln188">  }</a>
<a name="ln189">  /* first create the style header */</a>
<a name="ln190">  DT_DEBUG_SQLITE3_PREPARE_V2(</a>
<a name="ln191">      dt_database_get(darktable.db),</a>
<a name="ln192">      &quot;INSERT INTO data.styles (name,description,id) VALUES &quot;</a>
<a name="ln193">      &quot;(?1,?2,(SELECT COALESCE(MAX(id),0)+1 FROM data.styles))&quot;, -1, &amp;stmt, NULL);</a>
<a name="ln194">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 1, name, -1, SQLITE_STATIC);</a>
<a name="ln195">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 2, description, -1, SQLITE_STATIC);</a>
<a name="ln196">  sqlite3_step(stmt);</a>
<a name="ln197">  sqlite3_finalize(stmt);</a>
<a name="ln198">  return TRUE;</a>
<a name="ln199">}</a>
<a name="ln200"> </a>
<a name="ln201">static void _dt_style_update_from_image(int id, int imgid, GList *filter, GList *update)</a>
<a name="ln202">{</a>
<a name="ln203">  if(update &amp;&amp; imgid != -1)</a>
<a name="ln204">  {</a>
<a name="ln205">    GList *list = filter;</a>
<a name="ln206">    GList *upd = update;</a>
<a name="ln207">    char query[4096] = { 0 };</a>
<a name="ln208">    char tmp[500];</a>
<a name="ln209">    char *fields[] = { &quot;op_params&quot;,       &quot;module&quot;,         &quot;enabled&quot;,    &quot;blendop_params&quot;,</a>
<a name="ln210">                       &quot;blendop_version&quot;, &quot;multi_priority&quot;, &quot;multi_name&quot;, &quot;iop_order&quot;, 0 };</a>
<a name="ln211">    do</a>
<a name="ln212">    {</a>
<a name="ln213">      query[0] = '\0';</a>
<a name="ln214"> </a>
<a name="ln215">      // included and update set, we then need to update the corresponding style item</a>
<a name="ln216">      if(GPOINTER_TO_INT(upd-&gt;data) != -1 &amp;&amp; GPOINTER_TO_INT(list-&gt;data) != -1)</a>
<a name="ln217">      {</a>
<a name="ln218">        g_strlcpy(query, &quot;UPDATE data.style_items SET &quot;, sizeof(query));</a>
<a name="ln219"> </a>
<a name="ln220">        for(int k = 0; fields[k]; k++)</a>
<a name="ln221">        {</a>
<a name="ln222">          if(k != 0) g_strlcat(query, &quot;,&quot;, sizeof(query));</a>
<a name="ln223">          snprintf(tmp, sizeof(tmp), &quot;%s=(SELECT %s FROM main.history WHERE imgid=%d AND num=%d)&quot;, fields[k],</a>
<a name="ln224">                   fields[k], imgid, GPOINTER_TO_INT(upd-&gt;data));</a>
<a name="ln225">          g_strlcat(query, tmp, sizeof(query));</a>
<a name="ln226">        }</a>
<a name="ln227">        snprintf(tmp, sizeof(tmp), &quot; WHERE styleid=%d AND data.style_items.num=%d&quot;, id,</a>
<a name="ln228">                 GPOINTER_TO_INT(list-&gt;data));</a>
<a name="ln229">        g_strlcat(query, tmp, sizeof(query));</a>
<a name="ln230">      }</a>
<a name="ln231">      // update only, so we want to insert the new style item</a>
<a name="ln232">      else if(GPOINTER_TO_INT(upd-&gt;data) != -1)</a>
<a name="ln233">        snprintf(query, sizeof(query), &quot;INSERT INTO data.style_items &quot;</a>
<a name="ln234">                                       &quot;(styleid,num,module,operation,op_params,enabled,blendop_params,&quot;</a>
<a name="ln235">                                       &quot;blendop_version,multi_priority,multi_name,iop_order) SELECT %d,(SELECT num+1 &quot;</a>
<a name="ln236">                                       &quot;FROM data.style_items WHERE styleid=%d ORDER BY num DESC LIMIT 1), &quot;</a>
<a name="ln237">                                       &quot;module,operation,op_params,enabled,blendop_params,blendop_version,&quot;</a>
<a name="ln238">                                       &quot;multi_priority,multi_name,iop_order FROM main.history WHERE imgid=%d AND num=%d&quot;,</a>
<a name="ln239">                 id, id, imgid, GPOINTER_TO_INT(upd-&gt;data));</a>
<a name="ln240"> </a>
<a name="ln241">      if(*query) DT_DEBUG_SQLITE3_EXEC(dt_database_get(darktable.db), query, NULL, NULL, NULL);</a>
<a name="ln242"> </a>
<a name="ln243">      list = g_list_next(list);</a>
<a name="ln244">      upd = g_list_next(upd);</a>
<a name="ln245">    } while(list);</a>
<a name="ln246">  }</a>
<a name="ln247">}</a>
<a name="ln248"> </a>
<a name="ln249">void dt_styles_update(const char *name, const char *newname, const char *newdescription, GList *filter,</a>
<a name="ln250">                      int imgid, GList *update)</a>
<a name="ln251">{</a>
<a name="ln252">  sqlite3_stmt *stmt;</a>
<a name="ln253">  int id = 0;</a>
<a name="ln254">  gchar *desc = NULL;</a>
<a name="ln255"> </a>
<a name="ln256">  id = dt_styles_get_id_by_name(name);</a>
<a name="ln257">  if(id == 0) return;</a>
<a name="ln258"> </a>
<a name="ln259">  desc = dt_styles_get_description(name);</a>
<a name="ln260"> </a>
<a name="ln261">  if((g_strcmp0(name, newname)) || (g_strcmp0(desc, newdescription)))</a>
<a name="ln262">  {</a>
<a name="ln263">    DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln264">                                &quot;UPDATE data.styles SET name=?1, description=?2 WHERE id=?3&quot;, -1, &amp;stmt, NULL);</a>
<a name="ln265">    DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 1, newname, -1, SQLITE_STATIC);</a>
<a name="ln266">    DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 2, newdescription, -1, SQLITE_STATIC);</a>
<a name="ln267">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 3, id);</a>
<a name="ln268">    sqlite3_step(stmt);</a>
<a name="ln269">    sqlite3_finalize(stmt);</a>
<a name="ln270">  }</a>
<a name="ln271"> </a>
<a name="ln272">  if(filter)</a>
<a name="ln273">  {</a>
<a name="ln274">    GList *list = filter;</a>
<a name="ln275">    char tmp[64];</a>
<a name="ln276">    char include[2048] = { 0 };</a>
<a name="ln277">    g_strlcat(include, &quot;num NOT IN (&quot;, sizeof(include));</a>
<a name="ln278">    do</a>
<a name="ln279">    {</a>
<a name="ln280">      if(list != g_list_first(list)) g_strlcat(include, &quot;,&quot;, sizeof(include));</a>
<a name="ln281">      snprintf(tmp, sizeof(tmp), &quot;%d&quot;, GPOINTER_TO_INT(list-&gt;data));</a>
<a name="ln282">      g_strlcat(include, tmp, sizeof(include));</a>
<a name="ln283">    } while((list = g_list_next(list)));</a>
<a name="ln284">    g_strlcat(include, &quot;)&quot;, sizeof(include));</a>
<a name="ln285"> </a>
<a name="ln286">    char query[4096] = { 0 };</a>
<a name="ln287">    snprintf(query, sizeof(query), &quot;DELETE FROM data.style_items WHERE styleid=?1 AND %s&quot;, include);</a>
<a name="ln288">    DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), query, -1, &amp;stmt, NULL);</a>
<a name="ln289">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, id);</a>
<a name="ln290">    sqlite3_step(stmt);</a>
<a name="ln291">    sqlite3_finalize(stmt);</a>
<a name="ln292">  }</a>
<a name="ln293"> </a>
<a name="ln294">  _dt_style_update_from_image(id, imgid, filter, update);</a>
<a name="ln295"> </a>
<a name="ln296">  _dt_style_cleanup_multi_instance(id);</a>
<a name="ln297"> </a>
<a name="ln298">  /* backup style to disk */</a>
<a name="ln299">  char stylesdir[PATH_MAX] = { 0 };</a>
<a name="ln300">  dt_loc_get_user_config_dir(stylesdir, sizeof(stylesdir));</a>
<a name="ln301">  g_strlcat(stylesdir, &quot;/styles&quot;, sizeof(stylesdir));</a>
<a name="ln302">  g_mkdir_with_parents(stylesdir, 00755);</a>
<a name="ln303"> </a>
<a name="ln304">  dt_styles_save_to_file(newname, stylesdir, TRUE);</a>
<a name="ln305"> </a>
<a name="ln306">  /* delete old accelerator and create a new one */</a>
<a name="ln307">  // TODO: should better use dt_accel_rename_global() to keep the old accel_key untouched, but it seems to be</a>
<a name="ln308">  // buggy</a>
<a name="ln309">  if(g_strcmp0(name, newname))</a>
<a name="ln310">  {</a>
<a name="ln311">    char tmp_accel[1024];</a>
<a name="ln312">    snprintf(tmp_accel, sizeof(tmp_accel), C_(&quot;accel&quot;, &quot;styles/apply %s&quot;), name);</a>
<a name="ln313">    dt_accel_deregister_global(tmp_accel);</a>
<a name="ln314"> </a>
<a name="ln315">    gchar *tmp_name = g_strdup(newname); // freed by _destroy_style_shortcut_callback</a>
<a name="ln316">    snprintf(tmp_accel, sizeof(tmp_accel), C_(&quot;accel&quot;, &quot;styles/apply %s&quot;), newname);</a>
<a name="ln317">    dt_accel_register_global(tmp_accel, 0, 0);</a>
<a name="ln318">    GClosure *closure;</a>
<a name="ln319">    closure = g_cclosure_new(G_CALLBACK(_apply_style_shortcut_callback), tmp_name,</a>
<a name="ln320">                             _destroy_style_shortcut_callback);</a>
<a name="ln321">    dt_accel_connect_global(tmp_accel, closure);</a>
<a name="ln322">  }</a>
<a name="ln323"> </a>
<a name="ln324">  dt_control_signal_raise(darktable.signals, DT_SIGNAL_STYLE_CHANGED);</a>
<a name="ln325"> </a>
<a name="ln326">  g_free(desc);</a>
<a name="ln327">}</a>
<a name="ln328"> </a>
<a name="ln329">void dt_styles_create_from_style(const char *name, const char *newname, const char *description,</a>
<a name="ln330">                                 GList *filter, int imgid, GList *update)</a>
<a name="ln331">{</a>
<a name="ln332">  sqlite3_stmt *stmt;</a>
<a name="ln333">  int id = 0;</a>
<a name="ln334">  int oldid = 0;</a>
<a name="ln335"> </a>
<a name="ln336">  oldid = dt_styles_get_id_by_name(name);</a>
<a name="ln337">  if(oldid == 0) return;</a>
<a name="ln338"> </a>
<a name="ln339">  /* create the style header */</a>
<a name="ln340">  if(!dt_styles_create_style_header(newname, description)) return;</a>
<a name="ln341"> </a>
<a name="ln342">  if((id = dt_styles_get_id_by_name(newname)) != 0)</a>
<a name="ln343">  {</a>
<a name="ln344">    if(filter)</a>
<a name="ln345">    {</a>
<a name="ln346">      GList *list = filter;</a>
<a name="ln347">      char tmp[64];</a>
<a name="ln348">      char include[2048] = { 0 };</a>
<a name="ln349">      g_strlcat(include, &quot;num IN (&quot;, sizeof(include));</a>
<a name="ln350">      do</a>
<a name="ln351">      {</a>
<a name="ln352">        if(list != g_list_first(list)) g_strlcat(include, &quot;,&quot;, sizeof(include));</a>
<a name="ln353">        snprintf(tmp, sizeof(tmp), &quot;%d&quot;, GPOINTER_TO_INT(list-&gt;data));</a>
<a name="ln354">        g_strlcat(include, tmp, sizeof(include));</a>
<a name="ln355">      } while((list = g_list_next(list)));</a>
<a name="ln356">      g_strlcat(include, &quot;)&quot;, sizeof(include));</a>
<a name="ln357">      char query[4096] = { 0 };</a>
<a name="ln358"> </a>
<a name="ln359">      snprintf(query, sizeof(query), &quot;INSERT INTO data.style_items &quot;</a>
<a name="ln360">                                     &quot;(styleid,num,module,operation,op_params,enabled,blendop_params,blendop_&quot;</a>
<a name="ln361">                                     &quot;version,multi_priority,multi_name,iop_order) SELECT ?1, &quot;</a>
<a name="ln362">                                     &quot;num,module,operation,op_params,enabled,blendop_params,blendop_version,&quot;</a>
<a name="ln363">                                     &quot;multi_priority,multi_name,iop_order FROM data.style_items WHERE styleid=?2 AND %s&quot;,</a>
<a name="ln364">               include);</a>
<a name="ln365">      DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), query, -1, &amp;stmt, NULL);</a>
<a name="ln366">    }</a>
<a name="ln367">    else</a>
<a name="ln368">      DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln369">                                  &quot;INSERT INTO data.style_items &quot;</a>
<a name="ln370">                                  &quot;(styleid,num,module,operation,op_params,enabled,blendop_params,blendop_&quot;</a>
<a name="ln371">                                  &quot;version,multi_priority,multi_name,iop_order) SELECT ?1, &quot;</a>
<a name="ln372">                                  &quot;num,module,operation,op_params,enabled,blendop_params,blendop_version,&quot;</a>
<a name="ln373">                                  &quot;multi_priority,multi_name,iop_order FROM data.style_items WHERE styleid=?2&quot;,</a>
<a name="ln374">                                  -1, &amp;stmt, NULL);</a>
<a name="ln375">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, id);</a>
<a name="ln376">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 2, oldid);</a>
<a name="ln377">    sqlite3_step(stmt);</a>
<a name="ln378">    sqlite3_finalize(stmt);</a>
<a name="ln379"> </a>
<a name="ln380">    /* insert items from imgid if defined */</a>
<a name="ln381"> </a>
<a name="ln382">    _dt_style_update_from_image(id, imgid, filter, update);</a>
<a name="ln383"> </a>
<a name="ln384">    _dt_style_cleanup_multi_instance(id);</a>
<a name="ln385"> </a>
<a name="ln386">    /* backup style to disk */</a>
<a name="ln387">    char stylesdir[PATH_MAX] = { 0 };</a>
<a name="ln388">    dt_loc_get_user_config_dir(stylesdir, sizeof(stylesdir));</a>
<a name="ln389">    g_strlcat(stylesdir, &quot;/styles&quot;, sizeof(stylesdir));</a>
<a name="ln390">    g_mkdir_with_parents(stylesdir, 00755);</a>
<a name="ln391"> </a>
<a name="ln392">    dt_styles_save_to_file(newname, stylesdir, FALSE);</a>
<a name="ln393"> </a>
<a name="ln394">    char tmp_accel[1024];</a>
<a name="ln395">    gchar *tmp_name = g_strdup(newname); // freed by _destroy_style_shortcut_callback</a>
<a name="ln396">    snprintf(tmp_accel, sizeof(tmp_accel), C_(&quot;accel&quot;, &quot;styles/apply %s&quot;), newname);</a>
<a name="ln397">    dt_accel_register_global(tmp_accel, 0, 0);</a>
<a name="ln398">    GClosure *closure;</a>
<a name="ln399">    closure = g_cclosure_new(G_CALLBACK(_apply_style_shortcut_callback), tmp_name,</a>
<a name="ln400">                             _destroy_style_shortcut_callback);</a>
<a name="ln401">    dt_accel_connect_global(tmp_accel, closure);</a>
<a name="ln402">    dt_control_log(_(&quot;style named '%s' successfully created&quot;), newname);</a>
<a name="ln403">    dt_control_signal_raise(darktable.signals, DT_SIGNAL_STYLE_CHANGED);</a>
<a name="ln404">  }</a>
<a name="ln405">}</a>
<a name="ln406"> </a>
<a name="ln407">gboolean dt_styles_create_from_image(const char *name, const char *description, int32_t imgid, GList *filter)</a>
<a name="ln408">{</a>
<a name="ln409">  int id = 0;</a>
<a name="ln410">  sqlite3_stmt *stmt;</a>
<a name="ln411"> </a>
<a name="ln412">  /* first create the style header */</a>
<a name="ln413">  if(!dt_styles_create_style_header(name, description)) return FALSE;</a>
<a name="ln414"> </a>
<a name="ln415">  if((id = dt_styles_get_id_by_name(name)) != 0)</a>
<a name="ln416">  {</a>
<a name="ln417">    /* create the style_items from source image history stack */</a>
<a name="ln418">    if(filter)</a>
<a name="ln419">    {</a>
<a name="ln420">      GList *list = filter;</a>
<a name="ln421">      char tmp[64];</a>
<a name="ln422">      char include[2048] = { 0 };</a>
<a name="ln423">      g_strlcat(include, &quot;num IN (&quot;, sizeof(include));</a>
<a name="ln424">      do</a>
<a name="ln425">      {</a>
<a name="ln426">        if(list != g_list_first(list)) g_strlcat(include, &quot;,&quot;, sizeof(include));</a>
<a name="ln427">        snprintf(tmp, sizeof(tmp), &quot;%d&quot;, GPOINTER_TO_INT(list-&gt;data));</a>
<a name="ln428">        g_strlcat(include, tmp, sizeof(include));</a>
<a name="ln429">      } while((list = g_list_next(list)));</a>
<a name="ln430">      g_strlcat(include, &quot;)&quot;, sizeof(include));</a>
<a name="ln431">      char query[4096] = { 0 };</a>
<a name="ln432">      snprintf(query, sizeof(query), &quot;INSERT INTO data.style_items &quot;</a>
<a name="ln433">                                     &quot;(styleid,num,module,operation,op_params,enabled,blendop_params,blendop_&quot;</a>
<a name="ln434">                                     &quot;version,multi_priority,multi_name,iop_order) SELECT ?1, &quot;</a>
<a name="ln435">                                     &quot;num,module,operation,op_params,enabled,blendop_params,blendop_version,&quot;</a>
<a name="ln436">                                     &quot;multi_priority,multi_name,iop_order FROM main.history WHERE imgid=?2 AND %s&quot;,</a>
<a name="ln437">               include);</a>
<a name="ln438">      DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), query, -1, &amp;stmt, NULL);</a>
<a name="ln439">    }</a>
<a name="ln440">    else</a>
<a name="ln441">      DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln442">                                  &quot;INSERT INTO data.style_items &quot;</a>
<a name="ln443">                                  &quot;(styleid,num,module,operation,op_params,enabled,blendop_params,blendop_&quot;</a>
<a name="ln444">                                  &quot;version,multi_priority,multi_name,iop_order) SELECT ?1, &quot;</a>
<a name="ln445">                                  &quot;num,module,operation,op_params,enabled,blendop_params,blendop_version,&quot;</a>
<a name="ln446">                                  &quot;multi_priority,multi_name,iop_order FROM main.history WHERE imgid=?2&quot;,</a>
<a name="ln447">                                  -1, &amp;stmt, NULL);</a>
<a name="ln448">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, id);</a>
<a name="ln449">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 2, imgid);</a>
<a name="ln450">    sqlite3_step(stmt);</a>
<a name="ln451">    sqlite3_finalize(stmt);</a>
<a name="ln452"> </a>
<a name="ln453">    _dt_style_cleanup_multi_instance(id);</a>
<a name="ln454"> </a>
<a name="ln455">    /* backup style to disk */</a>
<a name="ln456">    char stylesdir[PATH_MAX] = { 0 };</a>
<a name="ln457">    dt_loc_get_user_config_dir(stylesdir, sizeof(stylesdir));</a>
<a name="ln458">    g_strlcat(stylesdir, &quot;/styles&quot;, sizeof(stylesdir));</a>
<a name="ln459">    g_mkdir_with_parents(stylesdir, 00755);</a>
<a name="ln460"> </a>
<a name="ln461">    dt_styles_save_to_file(name, stylesdir, FALSE);</a>
<a name="ln462"> </a>
<a name="ln463">    char tmp_accel[1024];</a>
<a name="ln464">    gchar *tmp_name = g_strdup(name); // freed by _destroy_style_shortcut_callback</a>
<a name="ln465">    snprintf(tmp_accel, sizeof(tmp_accel), C_(&quot;accel&quot;, &quot;styles/apply %s&quot;), name);</a>
<a name="ln466">    dt_accel_register_global(tmp_accel, 0, 0);</a>
<a name="ln467">    GClosure *closure;</a>
<a name="ln468">    closure = g_cclosure_new(G_CALLBACK(_apply_style_shortcut_callback), tmp_name,</a>
<a name="ln469">                             _destroy_style_shortcut_callback);</a>
<a name="ln470">    dt_accel_connect_global(tmp_accel, closure);</a>
<a name="ln471">    dt_control_signal_raise(darktable.signals, DT_SIGNAL_STYLE_CHANGED);</a>
<a name="ln472">    return TRUE;</a>
<a name="ln473">  }</a>
<a name="ln474">  return FALSE;</a>
<a name="ln475">}</a>
<a name="ln476"> </a>
<a name="ln477">void dt_styles_apply_to_selection(const char *name, gboolean duplicate)</a>
<a name="ln478">{</a>
<a name="ln479">  gboolean selected = FALSE;</a>
<a name="ln480"> </a>
<a name="ln481">  /* write current history changes so nothing gets lost, do that only in the darkroom as there is nothing to</a>
<a name="ln482">     be</a>
<a name="ln483">     save when in the lighttable (and it would write over current history stack) */</a>
<a name="ln484">  const dt_view_t *cv = dt_view_manager_get_current_view(darktable.view_manager);</a>
<a name="ln485">  if(cv-&gt;view((dt_view_t *)cv) == DT_VIEW_DARKROOM) dt_dev_write_history(darktable.develop);</a>
<a name="ln486"> </a>
<a name="ln487">  /* for each selected image apply style */</a>
<a name="ln488">  sqlite3_stmt *stmt;</a>
<a name="ln489">  dt_undo_start_group(darktable.undo, DT_UNDO_LT_HISTORY);</a>
<a name="ln490">  DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), &quot;SELECT imgid FROM main.selected_images&quot;,</a>
<a name="ln491">                              -1, &amp;stmt, NULL);</a>
<a name="ln492">  while(sqlite3_step(stmt) == SQLITE_ROW)</a>
<a name="ln493">  {</a>
<a name="ln494">    const int imgid = sqlite3_column_int(stmt, 0);</a>
<a name="ln495">    dt_styles_apply_to_image(name, duplicate, imgid);</a>
<a name="ln496">    selected = TRUE;</a>
<a name="ln497">  }</a>
<a name="ln498">  sqlite3_finalize(stmt);</a>
<a name="ln499">  dt_undo_end_group(darktable.undo);</a>
<a name="ln500"> </a>
<a name="ln501">  if(!selected) dt_control_log(_(&quot;no image selected!&quot;));</a>
<a name="ln502">}</a>
<a name="ln503"> </a>
<a name="ln504">void dt_styles_create_from_selection()</a>
<a name="ln505">{</a>
<a name="ln506">  gboolean selected = FALSE;</a>
<a name="ln507">  /* for each selected create style */</a>
<a name="ln508">  sqlite3_stmt *stmt;</a>
<a name="ln509">  DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), &quot;SELECT imgid FROM main.selected_images&quot;,</a>
<a name="ln510">                              -1, &amp;stmt, NULL);</a>
<a name="ln511">  while(sqlite3_step(stmt) == SQLITE_ROW)</a>
<a name="ln512">  {</a>
<a name="ln513">    int imgid = sqlite3_column_int(stmt, 0);</a>
<a name="ln514">    dt_gui_styles_dialog_new(imgid);</a>
<a name="ln515">    selected = TRUE;</a>
<a name="ln516">  }</a>
<a name="ln517">  sqlite3_finalize(stmt);</a>
<a name="ln518"> </a>
<a name="ln519">  if(!selected) dt_control_log(_(&quot;no image selected!&quot;));</a>
<a name="ln520">}</a>
<a name="ln521"> </a>
<a name="ln522">// returns the first module on modules_list with operation = op_name</a>
<a name="ln523">static dt_iop_module_t *_search_list_iop_by_op(GList *modules_list, const char *op_name)</a>
<a name="ln524">{</a>
<a name="ln525">  dt_iop_module_t *mod_ret = NULL;</a>
<a name="ln526">  GList *modules = g_list_first(modules_list);</a>
<a name="ln527">  while(modules)</a>
<a name="ln528">  {</a>
<a name="ln529">    dt_iop_module_t *mod = (dt_iop_module_t *)(modules-&gt;data);</a>
<a name="ln530"> </a>
<a name="ln531">    if(strcmp(mod-&gt;op, op_name) == 0)</a>
<a name="ln532">    {</a>
<a name="ln533">      mod_ret = mod;</a>
<a name="ln534">      break;</a>
<a name="ln535">    }</a>
<a name="ln536">    modules = g_list_next(modules);</a>
<a name="ln537">  }</a>
<a name="ln538">  return mod_ret;</a>
<a name="ln539">}</a>
<a name="ln540"> </a>
<a name="ln541">// returns a new multi_priority number for op_name</a>
<a name="ln542">static int _get_new_iop_multi_priority(dt_develop_t *dev, const char *op_name)</a>
<a name="ln543">{</a>
<a name="ln544">  int multi_priority_new = -1;</a>
<a name="ln545">  GList *modules = g_list_first(dev-&gt;iop);</a>
<a name="ln546">  while(modules)</a>
<a name="ln547">  {</a>
<a name="ln548">    dt_iop_module_t *mod = (dt_iop_module_t *)(modules-&gt;data);</a>
<a name="ln549"> </a>
<a name="ln550">    if(strcmp(mod-&gt;op, op_name) == 0)</a>
<a name="ln551">    {</a>
<a name="ln552">      multi_priority_new = MAX(multi_priority_new, mod-&gt;multi_priority);</a>
<a name="ln553">    }</a>
<a name="ln554">    modules = g_list_next(modules);</a>
<a name="ln555">  }</a>
<a name="ln556">  return (multi_priority_new + 1);</a>
<a name="ln557">}</a>
<a name="ln558"> </a>
<a name="ln559">void dt_styles_apply_style_item(dt_develop_t *dev, dt_style_item_t *style_item, GList **modules_used,</a>
<a name="ln560">                                const int append)</a>
<a name="ln561">{</a>
<a name="ln562">  // get any instance of the same operation so we can copy it</a>
<a name="ln563">  dt_iop_module_t *mod_src = _search_list_iop_by_op(dev-&gt;iop, style_item-&gt;operation);</a>
<a name="ln564">  if(mod_src)</a>
<a name="ln565">  {</a>
<a name="ln566">    dt_iop_module_t *module = (dt_iop_module_t *)calloc(1, sizeof(dt_iop_module_t));</a>
<a name="ln567">    if(dt_iop_load_module(module, mod_src-&gt;so, dev))</a>
<a name="ln568">    {</a>
<a name="ln569">      module = NULL;</a>
<a name="ln570">      fprintf(stderr, &quot;[dt_styles_apply_style_item] can't load module %s %s\n&quot;, style_item-&gt;operation,</a>
<a name="ln571">              style_item-&gt;multi_name);</a>
<a name="ln572">    }</a>
<a name="ln573">    else</a>
<a name="ln574">    {</a>
<a name="ln575">      int do_merge = 1;</a>
<a name="ln576"> </a>
<a name="ln577">      module-&gt;instance = mod_src-&gt;instance;</a>
<a name="ln578">      module-&gt;multi_priority = _get_new_iop_multi_priority(dev, mod_src-&gt;op);</a>
<a name="ln579">      module-&gt;iop_order = style_item-&gt;iop_order;</a>
<a name="ln580"> </a>
<a name="ln581">      module-&gt;enabled = style_item-&gt;enabled;</a>
<a name="ln582">      snprintf(module-&gt;multi_name, sizeof(module-&gt;multi_name), &quot;%s&quot;, style_item-&gt;multi_name);</a>
<a name="ln583"> </a>
<a name="ln584">      // TODO: this is copied from dt_dev_read_history_ext(), maybe do a helper with this?</a>
<a name="ln585">      if(style_item-&gt;blendop_params &amp;&amp; (style_item-&gt;blendop_version == dt_develop_blend_version())</a>
<a name="ln586">         &amp;&amp; (style_item-&gt;blendop_params_size == sizeof(dt_develop_blend_params_t)))</a>
<a name="ln587">      {</a>
<a name="ln588">        memcpy(module-&gt;blend_params, style_item-&gt;blendop_params, sizeof(dt_develop_blend_params_t));</a>
<a name="ln589">      }</a>
<a name="ln590">      else if(style_item-&gt;blendop_params</a>
<a name="ln591">              &amp;&amp; dt_develop_blend_legacy_params(module, style_item-&gt;blendop_params, style_item-&gt;blendop_version,</a>
<a name="ln592">                  module-&gt;blend_params, dt_develop_blend_version(), style_item-&gt;blendop_params_size) == 0)</a>
<a name="ln593">      {</a>
<a name="ln594">        // do nothing</a>
<a name="ln595">      }</a>
<a name="ln596">      else</a>
<a name="ln597">      {</a>
<a name="ln598">        memcpy(module-&gt;blend_params, module-&gt;default_blendop_params, sizeof(dt_develop_blend_params_t));</a>
<a name="ln599">      }</a>
<a name="ln600"> </a>
<a name="ln601">      if(module-&gt;version() != style_item-&gt;module_version || module-&gt;params_size != style_item-&gt;params_size</a>
<a name="ln602">         || strcmp(style_item-&gt;operation, module-&gt;op))</a>
<a name="ln603">      {</a>
<a name="ln604">        if(!module-&gt;legacy_params</a>
<a name="ln605">           || module-&gt;legacy_params(module, style_item-&gt;params, labs(style_item-&gt;module_version),</a>
<a name="ln606">                                          module-&gt;params, labs(module-&gt;version())))</a>
<a name="ln607">        {</a>
<a name="ln608">          fprintf(stderr, &quot;[dt_styles_apply_style_item] module `%s' version mismatch: history is %d, dt %d.\n&quot;,</a>
<a name="ln609">                  module-&gt;op, style_item-&gt;module_version, module-&gt;version());</a>
<a name="ln610">          dt_control_log(_(&quot;module `%s' version mismatch: %d != %d&quot;), module-&gt;op,</a>
<a name="ln611">                         module-&gt;version(), style_item-&gt;module_version);</a>
<a name="ln612"> </a>
<a name="ln613">          do_merge = 0;</a>
<a name="ln614">        }</a>
<a name="ln615">        else</a>
<a name="ln616">        {</a>
<a name="ln617">          if(!strcmp(module-&gt;op, &quot;spots&quot;) &amp;&amp; style_item-&gt;module_version == 1)</a>
<a name="ln618">          {</a>
<a name="ln619">            // FIXME: not sure how to handle this here...</a>
<a name="ln620">            // quick and dirty hack to handle spot removal legacy_params</a>
<a name="ln621">            /* memcpy(module-&gt;blend_params, module-&gt;blend_params, sizeof(dt_develop_blend_params_t));</a>
<a name="ln622">            memcpy(module-&gt;blend_params, module-&gt;default_blendop_params,</a>
<a name="ln623">                   sizeof(dt_develop_blend_params_t)); */</a>
<a name="ln624">          }</a>
<a name="ln625">        }</a>
<a name="ln626"> </a>
<a name="ln627">        /*</a>
<a name="ln628">         * Fix for flip iop: previously it was not always needed, but it might be</a>
<a name="ln629">         * in history stack as &quot;orientation (off)&quot;, but now we always want it</a>
<a name="ln630">         * by default, so if it is disabled, enable it, and replace params with</a>
<a name="ln631">         * default_params. if user want to, he can disable it.</a>
<a name="ln632">         */</a>
<a name="ln633">        if(!strcmp(module-&gt;op, &quot;flip&quot;) &amp;&amp; module-&gt;enabled == 0 &amp;&amp; labs(style_item-&gt;module_version) == 1)</a>
<a name="ln634">        {</a>
<a name="ln635">          memcpy(module-&gt;params, module-&gt;default_params, module-&gt;params_size);</a>
<a name="ln636">          module-&gt;enabled = 1;</a>
<a name="ln637">        }</a>
<a name="ln638">      }</a>
<a name="ln639">      else</a>
<a name="ln640">      {</a>
<a name="ln641">        memcpy(module-&gt;params, style_item-&gt;params, module-&gt;params_size);</a>
<a name="ln642">      }</a>
<a name="ln643"> </a>
<a name="ln644">      if(do_merge)</a>
<a name="ln645">        dt_history_merge_module_into_history(dev, NULL, module, modules_used, append);</a>
<a name="ln646">    }</a>
<a name="ln647">    if(module)</a>
<a name="ln648">    {</a>
<a name="ln649">      dt_iop_cleanup_module(module);</a>
<a name="ln650">      free(module);</a>
<a name="ln651">    }</a>
<a name="ln652">  }</a>
<a name="ln653">}</a>
<a name="ln654"> </a>
<a name="ln655">void dt_styles_apply_to_image(const char *name, gboolean duplicate, int32_t imgid)</a>
<a name="ln656">{</a>
<a name="ln657">  int id = 0;</a>
<a name="ln658">  sqlite3_stmt *stmt;</a>
<a name="ln659">  int32_t newimgid;</a>
<a name="ln660"> </a>
<a name="ln661">  if((id = dt_styles_get_id_by_name(name)) != 0)</a>
<a name="ln662">  {</a>
<a name="ln663">    /* check if we should make a duplicate before applying style */</a>
<a name="ln664">    if(duplicate)</a>
<a name="ln665">    {</a>
<a name="ln666">      newimgid = dt_image_duplicate(imgid);</a>
<a name="ln667">      if(newimgid != -1) dt_history_copy_and_paste_on_image(imgid, newimgid, FALSE, NULL);</a>
<a name="ln668">    }</a>
<a name="ln669">    else</a>
<a name="ln670">      newimgid = imgid;</a>
<a name="ln671"> </a>
<a name="ln672">    // now deal with the history</a>
<a name="ln673">    GList *modules_used = NULL;</a>
<a name="ln674"> </a>
<a name="ln675">    dt_develop_t _dev_dest = { 0 };</a>
<a name="ln676"> </a>
<a name="ln677">    dt_develop_t *dev_dest = &amp;_dev_dest;</a>
<a name="ln678"> </a>
<a name="ln679">    dt_dev_init(dev_dest, FALSE);</a>
<a name="ln680"> </a>
<a name="ln681">    dev_dest-&gt;iop = dt_iop_load_modules_ext(dev_dest, TRUE);</a>
<a name="ln682"> </a>
<a name="ln683">    dt_dev_read_history_ext(dev_dest, newimgid, TRUE);</a>
<a name="ln684"> </a>
<a name="ln685">    dt_ioppr_check_iop_order(dev_dest, newimgid, &quot;dt_styles_apply_to_image &quot;);</a>
<a name="ln686"> </a>
<a name="ln687">    dt_dev_pop_history_items_ext(dev_dest, dev_dest-&gt;history_end);</a>
<a name="ln688"> </a>
<a name="ln689">    dt_ioppr_check_iop_order(dev_dest, newimgid, &quot;dt_styles_apply_to_image 1&quot;);</a>
<a name="ln690"> </a>
<a name="ln691">    // go through all entries in style</a>
<a name="ln692">    DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln693">                                &quot;SELECT num, module, operation, op_params, enabled, &quot;</a>
<a name="ln694">                                &quot;blendop_params, blendop_version, multi_priority, multi_name, iop_order &quot;</a>
<a name="ln695">                                &quot;FROM data.style_items WHERE styleid=?1 &quot;</a>
<a name="ln696">                                &quot;ORDER BY num&quot;,</a>
<a name="ln697">                                -1, &amp;stmt, NULL);</a>
<a name="ln698">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, id);</a>
<a name="ln699">    while(sqlite3_step(stmt) == SQLITE_ROW)</a>
<a name="ln700">    {</a>
<a name="ln701">      dt_style_item_t style_item = { 0 };</a>
<a name="ln702"> </a>
<a name="ln703">      style_item.num = sqlite3_column_int(stmt, 0);</a>
<a name="ln704">      style_item.selimg_num = 0;</a>
<a name="ln705">      style_item.enabled = sqlite3_column_int(stmt, 4);</a>
<a name="ln706">      style_item.multi_priority = sqlite3_column_int(stmt, 7);</a>
<a name="ln707">      style_item.name = NULL;</a>
<a name="ln708">      style_item.operation = (char *)sqlite3_column_text(stmt, 2);</a>
<a name="ln709">      style_item.multi_name = (char *)sqlite3_column_text(stmt, 8);</a>
<a name="ln710">      style_item.module_version = sqlite3_column_int(stmt, 1);</a>
<a name="ln711">      style_item.blendop_version = sqlite3_column_int(stmt, 6);</a>
<a name="ln712">      style_item.params = (void *)sqlite3_column_blob(stmt, 3);</a>
<a name="ln713">      style_item.blendop_params = (void *)sqlite3_column_blob(stmt, 5);</a>
<a name="ln714">      style_item.params_size = sqlite3_column_bytes(stmt, 3);</a>
<a name="ln715">      style_item.blendop_params_size = sqlite3_column_bytes(stmt, 5);</a>
<a name="ln716">      style_item.iop_order = sqlite3_column_double(stmt, 9);</a>
<a name="ln717"> </a>
<a name="ln718">      dt_styles_apply_style_item(dev_dest, &amp;style_item, &amp;modules_used, FALSE);</a>
<a name="ln719">    }</a>
<a name="ln720">    sqlite3_finalize(stmt);</a>
<a name="ln721"> </a>
<a name="ln722">    dt_ioppr_check_iop_order(dev_dest, newimgid, &quot;dt_styles_apply_to_image 2&quot;);</a>
<a name="ln723"> </a>
<a name="ln724">    dt_undo_lt_history_t *hist = dt_history_snapshot_item_init();</a>
<a name="ln725">    hist-&gt;imgid = newimgid;</a>
<a name="ln726">    dt_history_snapshot_undo_create(hist-&gt;imgid, &amp;hist-&gt;before, &amp;hist-&gt;before_history_end);</a>
<a name="ln727"> </a>
<a name="ln728">    // write history and forms to db</a>
<a name="ln729">    dt_dev_write_history_ext(dev_dest, newimgid);</a>
<a name="ln730"> </a>
<a name="ln731">    dt_history_snapshot_undo_create(hist-&gt;imgid, &amp;hist-&gt;after, &amp;hist-&gt;after_history_end);</a>
<a name="ln732">    dt_undo_start_group(darktable.undo, DT_UNDO_LT_HISTORY);</a>
<a name="ln733">    dt_undo_record(darktable.undo, NULL, DT_UNDO_LT_HISTORY, (dt_undo_data_t)hist,</a>
<a name="ln734">                   dt_history_snapshot_undo_pop, dt_history_snapshot_undo_lt_history_data_free);</a>
<a name="ln735">    dt_undo_end_group(darktable.undo);</a>
<a name="ln736"> </a>
<a name="ln737">    dt_dev_cleanup(dev_dest);</a>
<a name="ln738"> </a>
<a name="ln739">    g_list_free(modules_used);</a>
<a name="ln740"> </a>
<a name="ln741">    /* add tag */</a>
<a name="ln742">    guint tagid = 0;</a>
<a name="ln743">    gchar ntag[512] = { 0 };</a>
<a name="ln744">    g_snprintf(ntag, sizeof(ntag), &quot;darktable|style|%s&quot;, name);</a>
<a name="ln745">    if(dt_tag_new(ntag, &amp;tagid)) dt_tag_attach_from_gui(tagid, newimgid);</a>
<a name="ln746">    if(dt_tag_new(&quot;darktable|changed&quot;, &amp;tagid)) dt_tag_attach_from_gui(tagid, newimgid);</a>
<a name="ln747"> </a>
<a name="ln748">    /* if current image in develop reload history */</a>
<a name="ln749">    if(dt_dev_is_current_image(darktable.develop, newimgid))</a>
<a name="ln750">    {</a>
<a name="ln751">      dt_dev_reload_history_items(darktable.develop);</a>
<a name="ln752">      dt_dev_modulegroups_set(darktable.develop, dt_dev_modulegroups_get(darktable.develop));</a>
<a name="ln753">    }</a>
<a name="ln754"> </a>
<a name="ln755">    /* update xmp file */</a>
<a name="ln756">    dt_image_synch_xmp(newimgid);</a>
<a name="ln757"> </a>
<a name="ln758">    /* remove old obsolete thumbnails */</a>
<a name="ln759">    dt_mipmap_cache_remove(darktable.mipmap_cache, newimgid);</a>
<a name="ln760">    dt_image_reset_final_size(newimgid);</a>
<a name="ln761"> </a>
<a name="ln762">    /* update the aspect ratio. recompute only if really needed for performance reasons */</a>
<a name="ln763">    if(darktable.collection-&gt;params.sort == DT_COLLECTION_SORT_ASPECT_RATIO)</a>
<a name="ln764">      dt_image_set_aspect_ratio(newimgid);</a>
<a name="ln765">    else</a>
<a name="ln766">      dt_image_reset_aspect_ratio(newimgid);</a>
<a name="ln767"> </a>
<a name="ln768">    /* if we have created a duplicate, reset collected images */</a>
<a name="ln769">    if(duplicate) dt_control_signal_raise(darktable.signals, DT_SIGNAL_COLLECTION_CHANGED);</a>
<a name="ln770"> </a>
<a name="ln771">    /* redraw center view to update visible mipmaps */</a>
<a name="ln772">    dt_control_queue_redraw_center();</a>
<a name="ln773">  }</a>
<a name="ln774">}</a>
<a name="ln775"> </a>
<a name="ln776">void dt_styles_delete_by_name(const char *name)</a>
<a name="ln777">{</a>
<a name="ln778">  int id = 0;</a>
<a name="ln779">  if((id = dt_styles_get_id_by_name(name)) != 0)</a>
<a name="ln780">  {</a>
<a name="ln781">    /* delete the style */</a>
<a name="ln782">    sqlite3_stmt *stmt;</a>
<a name="ln783">    DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), &quot;DELETE FROM data.styles WHERE id = ?1&quot;, -1, &amp;stmt,</a>
<a name="ln784">                                NULL);</a>
<a name="ln785">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, id);</a>
<a name="ln786">    sqlite3_step(stmt);</a>
<a name="ln787">    sqlite3_finalize(stmt);</a>
<a name="ln788"> </a>
<a name="ln789">    /* delete style_items belonging to style */</a>
<a name="ln790">    DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), &quot;DELETE FROM data.style_items WHERE styleid = ?1&quot;,</a>
<a name="ln791">                                -1, &amp;stmt, NULL);</a>
<a name="ln792">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, id);</a>
<a name="ln793">    sqlite3_step(stmt);</a>
<a name="ln794">    sqlite3_finalize(stmt);</a>
<a name="ln795"> </a>
<a name="ln796">    char tmp_accel[1024];</a>
<a name="ln797">    snprintf(tmp_accel, sizeof(tmp_accel), C_(&quot;accel&quot;, &quot;styles/apply %s&quot;), name);</a>
<a name="ln798">    dt_accel_deregister_global(tmp_accel);</a>
<a name="ln799">    dt_control_signal_raise(darktable.signals, DT_SIGNAL_STYLE_CHANGED);</a>
<a name="ln800">  }</a>
<a name="ln801">}</a>
<a name="ln802"> </a>
<a name="ln803">GList *dt_styles_get_item_list(const char *name, gboolean params, int imgid)</a>
<a name="ln804">{</a>
<a name="ln805">  GList *result = NULL;</a>
<a name="ln806">  sqlite3_stmt *stmt;</a>
<a name="ln807">  int id = 0;</a>
<a name="ln808">  if((id = dt_styles_get_id_by_name(name)) != 0)</a>
<a name="ln809">  {</a>
<a name="ln810">    if(params)</a>
<a name="ln811">      DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln812">                                  &quot;SELECT num, multi_priority, module, operation, enabled, op_params, blendop_params, &quot;</a>
<a name="ln813">                                  &quot;multi_name, iop_order FROM data.style_items WHERE styleid=?1 ORDER BY num DESC&quot;,</a>
<a name="ln814">                                  -1, &amp;stmt, NULL);</a>
<a name="ln815">    else if(imgid != -1)</a>
<a name="ln816">    {</a>
<a name="ln817">      // get all items from the style</a>
<a name="ln818">      //    UNION</a>
<a name="ln819">      // get all items from history, not in the style : select only the last operation, that is max(num)</a>
<a name="ln820">      DT_DEBUG_SQLITE3_PREPARE_V2(</a>
<a name="ln821">          dt_database_get(darktable.db),</a>
<a name="ln822">          &quot;SELECT num, multi_priority, module, operation, enabled, (SELECT MAX(num) FROM main.history WHERE imgid=?2 &quot;</a>
<a name="ln823">          &quot;AND operation=data.style_items.operation GROUP BY multi_priority),0,multi_name,iop_order FROM data.style_items WHERE &quot;</a>
<a name="ln824">          &quot;styleid=?1 UNION SELECT -1,main.history.multi_priority,main.history.module,main.history.operation,main.history.enabled, &quot;</a>
<a name="ln825">          &quot;main.history.num,0,multi_name,iop_order FROM main.history WHERE imgid=?2 AND main.history.enabled=1 AND &quot;</a>
<a name="ln826">          &quot;(main.history.operation NOT IN (SELECT operation FROM data.style_items WHERE styleid=?1) OR &quot;</a>
<a name="ln827">          &quot;(main.history.op_params NOT IN (SELECT op_params FROM data.style_items WHERE styleid=?1 AND &quot;</a>
<a name="ln828">          &quot;operation=main.history.operation)) OR (main.history.blendop_params NOT IN (SELECT blendop_params FROM &quot;</a>
<a name="ln829">          &quot;data.style_items WHERE styleid=?1 AND operation=main.history.operation))) GROUP BY operation HAVING &quot;</a>
<a name="ln830">          &quot;MAX(num) ORDER BY num DESC&quot;, -1, &amp;stmt, NULL);</a>
<a name="ln831">      DT_DEBUG_SQLITE3_BIND_INT(stmt, 2, imgid);</a>
<a name="ln832">    }</a>
<a name="ln833">    else</a>
<a name="ln834">      DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), &quot;SELECT num, multi_priority, module, operation, &quot;</a>
<a name="ln835">                                                                 &quot;enabled, 0, 0, multi_name, iop_order FROM data.style_items WHERE &quot;</a>
<a name="ln836">                                                                 &quot;styleid=?1 ORDER BY num DESC&quot;,</a>
<a name="ln837">                                  -1, &amp;stmt, NULL);</a>
<a name="ln838"> </a>
<a name="ln839">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, id);</a>
<a name="ln840">    while(sqlite3_step(stmt) == SQLITE_ROW)</a>
<a name="ln841">    {</a>
<a name="ln842">      if(strcmp((const char*)sqlite3_column_text(stmt, 3), &quot;mask_manager&quot;) == 0) continue;</a>
<a name="ln843"> </a>
<a name="ln844">      // name of current item of style</a>
<a name="ln845">      char iname[512] = { 0 };</a>
<a name="ln846">      dt_style_item_t *item = calloc(1, sizeof(dt_style_item_t));</a>
<a name="ln847"> </a>
<a name="ln848">      if(sqlite3_column_type(stmt, 0) == SQLITE_NULL)</a>
<a name="ln849">        item-&gt;num = -1;</a>
<a name="ln850">      else</a>
<a name="ln851">        item-&gt;num = sqlite3_column_int(stmt, 0);</a>
<a name="ln852"> </a>
<a name="ln853">      item-&gt;multi_priority = sqlite3_column_int(stmt, 1);</a>
<a name="ln854"> </a>
<a name="ln855">      item-&gt;selimg_num = -1;</a>
<a name="ln856">      item-&gt;module_version = sqlite3_column_int(stmt, 2);</a>
<a name="ln857"> </a>
<a name="ln858">      item-&gt;enabled = sqlite3_column_int(stmt, 4);</a>
<a name="ln859"> </a>
<a name="ln860">      if(params)</a>
<a name="ln861">      {</a>
<a name="ln862">        // when we get the parameters we do not want to get the operation localized as this</a>
<a name="ln863">        // is used to compare against the internal module name.</a>
<a name="ln864">        const char *multi_name = (const char *)sqlite3_column_text(stmt, 7);</a>
<a name="ln865"> </a>
<a name="ln866">        if(!(multi_name &amp;&amp; *multi_name))</a>
<a name="ln867">          g_snprintf(iname, sizeof(iname), &quot;%s&quot;, sqlite3_column_text(stmt, 3));</a>
<a name="ln868">        else</a>
<a name="ln869">          g_snprintf(iname, sizeof(iname), &quot;%s %s&quot;, sqlite3_column_text(stmt, 3), multi_name);</a>
<a name="ln870"> </a>
<a name="ln871">        const unsigned char *op_blob = sqlite3_column_blob(stmt, 5);</a>
<a name="ln872">        const int32_t op_len = sqlite3_column_bytes(stmt, 5);</a>
<a name="ln873">        const unsigned char *bop_blob = sqlite3_column_blob(stmt, 6);</a>
<a name="ln874">        const int32_t bop_len = sqlite3_column_bytes(stmt, 6);</a>
<a name="ln875"> </a>
<a name="ln876">        item-&gt;params = malloc(op_len);</a>
<a name="ln877">        item-&gt;params_size = op_len;</a>
<a name="ln878">        memcpy(item-&gt;params, op_blob, op_len);</a>
<a name="ln879"> </a>
<a name="ln880">        item-&gt;blendop_params = malloc(bop_len);</a>
<a name="ln881">        item-&gt;blendop_params_size = bop_len;</a>
<a name="ln882">        memcpy(item-&gt;blendop_params, bop_blob, bop_len);</a>
<a name="ln883">      }</a>
<a name="ln884">      else</a>
<a name="ln885">      {</a>
<a name="ln886">        const char *multi_name = (const char *)sqlite3_column_text(stmt, 7);</a>
<a name="ln887">        gboolean has_multi_name = FALSE;</a>
<a name="ln888"> </a>
<a name="ln889">        if(multi_name &amp;&amp; *multi_name &amp;&amp; strcmp(multi_name, &quot;0&quot;) != 0) has_multi_name = TRUE;</a>
<a name="ln890"> </a>
<a name="ln891">        if(has_multi_name)</a>
<a name="ln892">          g_snprintf(iname, sizeof(iname), &quot;%s %s (%s)&quot;,</a>
<a name="ln893">                     dt_iop_get_localized_name((gchar *)sqlite3_column_text(stmt, 3)), multi_name,</a>
<a name="ln894">                     (sqlite3_column_int(stmt, 4) != 0) ? _(&quot;on&quot;) : _(&quot;off&quot;));</a>
<a name="ln895">        else</a>
<a name="ln896">          g_snprintf(iname, sizeof(iname), &quot;%s (%s)&quot;,</a>
<a name="ln897">                     dt_iop_get_localized_name((gchar *)sqlite3_column_text(stmt, 3)),</a>
<a name="ln898">                     (sqlite3_column_int(stmt, 4) != 0) ? _(&quot;on&quot;) : _(&quot;off&quot;));</a>
<a name="ln899"> </a>
<a name="ln900">        item-&gt;params = NULL;</a>
<a name="ln901">        item-&gt;blendop_params = NULL;</a>
<a name="ln902">        item-&gt;params_size = 0;</a>
<a name="ln903">        item-&gt;blendop_params_size = 0;</a>
<a name="ln904">        if(imgid != -1 &amp;&amp; sqlite3_column_type(stmt, 5) != SQLITE_NULL)</a>
<a name="ln905">          item-&gt;selimg_num = sqlite3_column_int(stmt, 5);</a>
<a name="ln906">      }</a>
<a name="ln907">      item-&gt;name = g_strdup(iname);</a>
<a name="ln908">      item-&gt;operation = g_strdup((char *)sqlite3_column_text(stmt, 3));</a>
<a name="ln909">      item-&gt;multi_name = g_strdup((char *)sqlite3_column_text(stmt, 7));</a>
<a name="ln910">      item-&gt;iop_order = sqlite3_column_double(stmt, 8);</a>
<a name="ln911">      result = g_list_append(result, item);</a>
<a name="ln912">    }</a>
<a name="ln913">    sqlite3_finalize(stmt);</a>
<a name="ln914">  }</a>
<a name="ln915">  return result;</a>
<a name="ln916">}</a>
<a name="ln917"> </a>
<a name="ln918">char *dt_styles_get_item_list_as_string(const char *name)</a>
<a name="ln919">{</a>
<a name="ln920">  GList *items = dt_styles_get_item_list(name, FALSE, -1);</a>
<a name="ln921">  if(items == NULL) return NULL;</a>
<a name="ln922"> </a>
<a name="ln923">  GList *names = NULL;</a>
<a name="ln924">  do</a>
<a name="ln925">  {</a>
<a name="ln926">    dt_style_item_t *item = (dt_style_item_t *)items-&gt;data;</a>
<a name="ln927">    names = g_list_append(names, g_strdup(item-&gt;name));</a>
<a name="ln928">  } while((items = g_list_next(items)));</a>
<a name="ln929"> </a>
<a name="ln930">  char *result = dt_util_glist_to_str(&quot;\n&quot;, names);</a>
<a name="ln931">  g_list_free_full(names, g_free);</a>
<a name="ln932">  g_list_free_full(items, dt_style_item_free);</a>
<a name="ln933">  return result;</a>
<a name="ln934">}</a>
<a name="ln935"> </a>
<a name="ln936">GList *dt_styles_get_list(const char *filter)</a>
<a name="ln937">{</a>
<a name="ln938">  char filterstring[512] = { 0 };</a>
<a name="ln939">  sqlite3_stmt *stmt;</a>
<a name="ln940">  snprintf(filterstring, sizeof(filterstring), &quot;%%%s%%&quot;, filter);</a>
<a name="ln941">  DT_DEBUG_SQLITE3_PREPARE_V2(</a>
<a name="ln942">      dt_database_get(darktable.db),</a>
<a name="ln943">      &quot;SELECT name, description FROM data.styles WHERE name LIKE ?1 OR description LIKE ?1 ORDER BY name&quot;, -1,</a>
<a name="ln944">      &amp;stmt, NULL);</a>
<a name="ln945">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 1, filterstring, -1, SQLITE_TRANSIENT);</a>
<a name="ln946">  GList *result = NULL;</a>
<a name="ln947">  while(sqlite3_step(stmt) == SQLITE_ROW)</a>
<a name="ln948">  {</a>
<a name="ln949">    const char *name = (const char *)sqlite3_column_text(stmt, 0);</a>
<a name="ln950">    const char *description = (const char *)sqlite3_column_text(stmt, 1);</a>
<a name="ln951">    dt_style_t *s = g_malloc(sizeof(dt_style_t));</a>
<a name="ln952">    s-&gt;name = g_strdup(name);</a>
<a name="ln953">    s-&gt;description = g_strdup(description);</a>
<a name="ln954">    result = g_list_append(result, s);</a>
<a name="ln955">  }</a>
<a name="ln956">  sqlite3_finalize(stmt);</a>
<a name="ln957">  return result;</a>
<a name="ln958">}</a>
<a name="ln959"> </a>
<a name="ln960">static char *dt_style_encode(sqlite3_stmt *stmt, int row)</a>
<a name="ln961">{</a>
<a name="ln962">  const int32_t len = sqlite3_column_bytes(stmt, row);</a>
<a name="ln963">  char *vparams = dt_exif_xmp_encode((const unsigned char *)sqlite3_column_blob(stmt, row), len, NULL);</a>
<a name="ln964">  return vparams;</a>
<a name="ln965">}</a>
<a name="ln966"> </a>
<a name="ln967">void dt_styles_save_to_file(const char *style_name, const char *filedir, gboolean overwrite)</a>
<a name="ln968">{</a>
<a name="ln969">  int rc = 0;</a>
<a name="ln970">  char stylename[520];</a>
<a name="ln971">  sqlite3_stmt *stmt;</a>
<a name="ln972"> </a>
<a name="ln973">  // generate filename based on name of style</a>
<a name="ln974">  // convert all characters to underscore which are not allowed in filenames</a>
<a name="ln975">  char *filename = g_strdup(style_name);</a>
<a name="ln976">  snprintf(stylename, sizeof(stylename), &quot;%s/%s.dtstyle&quot;, filedir, g_strdelimit(filename, &quot;/&lt;&gt;:\&quot;\\|*?[]&quot;, '_'));</a>
<a name="ln977">  g_free(filename);</a>
<a name="ln978"> </a>
<a name="ln979">  // check if file exists</a>
<a name="ln980">  if(g_file_test(stylename, G_FILE_TEST_EXISTS) == TRUE)</a>
<a name="ln981">  {</a>
<a name="ln982">    if(overwrite)</a>
<a name="ln983">    {</a>
<a name="ln984">      if(g_unlink(stylename))</a>
<a name="ln985">      {</a>
<a name="ln986">        dt_control_log(_(&quot;failed to overwrite style file for %s&quot;), style_name);</a>
<a name="ln987">        return;</a>
<a name="ln988">      }</a>
<a name="ln989">    }</a>
<a name="ln990">    else</a>
<a name="ln991">    {</a>
<a name="ln992">      dt_control_log(_(&quot;style file for %s exists&quot;), style_name);</a>
<a name="ln993">      return;</a>
<a name="ln994">    }</a>
<a name="ln995">  }</a>
<a name="ln996"> </a>
<a name="ln997">  if(!dt_styles_exists(style_name)) return;</a>
<a name="ln998"> </a>
<a name="ln999">  xmlTextWriterPtr writer = xmlNewTextWriterFilename(stylename, 0);</a>
<a name="ln1000">  if(writer == NULL)</a>
<a name="ln1001">  {</a>
<a name="ln1002">    fprintf(stderr, &quot;[dt_styles_save_to_file] Error creating the xml writer\n, path: %s&quot;, stylename);</a>
<a name="ln1003">    return;</a>
<a name="ln1004">  }</a>
<a name="ln1005">  rc = xmlTextWriterStartDocument(writer, NULL, &quot;UTF-8&quot;, NULL);</a>
<a name="ln1006">  if(rc &lt; 0)</a>
<a name="ln1007">  {</a>
<a name="ln1008">    fprintf(stderr, &quot;[dt_styles_save_to_file]: Error on encoding setting&quot;);</a>
<a name="ln1009">    return;</a>
<a name="ln1010">  }</a>
<a name="ln1011">  xmlTextWriterStartElement(writer, BAD_CAST &quot;darktable_style&quot;);</a>
<a name="ln1012">  xmlTextWriterWriteAttribute(writer, BAD_CAST &quot;version&quot;, BAD_CAST &quot;1.0&quot;);</a>
<a name="ln1013"> </a>
<a name="ln1014">  xmlTextWriterStartElement(writer, BAD_CAST &quot;info&quot;);</a>
<a name="ln1015">  xmlTextWriterWriteFormatElement(writer, BAD_CAST &quot;name&quot;, &quot;%s&quot;, style_name);</a>
<a name="ln1016">  xmlTextWriterWriteFormatElement(writer, BAD_CAST &quot;description&quot;, &quot;%s&quot;, dt_styles_get_description(style_name));</a>
<a name="ln1017">  xmlTextWriterEndElement(writer);</a>
<a name="ln1018"> </a>
<a name="ln1019">  xmlTextWriterStartElement(writer, BAD_CAST &quot;style&quot;);</a>
<a name="ln1020">  DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), &quot;SELECT num,module,operation,op_params,enabled,&quot;</a>
<a name="ln1021">                                                             &quot;blendop_params,blendop_version,multi_priority,&quot;</a>
<a name="ln1022">                                                             &quot;multi_name,iop_order FROM data.style_items WHERE styleid =?1&quot;,</a>
<a name="ln1023">                              -1, &amp;stmt, NULL);</a>
<a name="ln1024">  DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, dt_styles_get_id_by_name(style_name));</a>
<a name="ln1025">  while(sqlite3_step(stmt) == SQLITE_ROW)</a>
<a name="ln1026">  {</a>
<a name="ln1027">    xmlTextWriterStartElement(writer, BAD_CAST &quot;plugin&quot;);</a>
<a name="ln1028">    xmlTextWriterWriteFormatElement(writer, BAD_CAST &quot;num&quot;, &quot;%d&quot;, sqlite3_column_int(stmt, 0));</a>
<a name="ln1029">    xmlTextWriterWriteFormatElement(writer, BAD_CAST &quot;module&quot;, &quot;%d&quot;, sqlite3_column_int(stmt, 1));</a>
<a name="ln1030">    xmlTextWriterWriteFormatElement(writer, BAD_CAST &quot;operation&quot;, &quot;%s&quot;, sqlite3_column_text(stmt, 2));</a>
<a name="ln1031">    xmlTextWriterWriteFormatElement(writer, BAD_CAST &quot;op_params&quot;, &quot;%s&quot;, dt_style_encode(stmt, 3));</a>
<a name="ln1032">    xmlTextWriterWriteFormatElement(writer, BAD_CAST &quot;enabled&quot;, &quot;%d&quot;, sqlite3_column_int(stmt, 4));</a>
<a name="ln1033">    xmlTextWriterWriteFormatElement(writer, BAD_CAST &quot;blendop_params&quot;, &quot;%s&quot;, dt_style_encode(stmt, 5));</a>
<a name="ln1034">    xmlTextWriterWriteFormatElement(writer, BAD_CAST &quot;blendop_version&quot;, &quot;%d&quot;, sqlite3_column_int(stmt, 6));</a>
<a name="ln1035">    xmlTextWriterWriteFormatElement(writer, BAD_CAST &quot;multi_priority&quot;, &quot;%d&quot;, sqlite3_column_int(stmt, 7));</a>
<a name="ln1036">    xmlTextWriterWriteFormatElement(writer, BAD_CAST &quot;multi_name&quot;, &quot;%s&quot;, sqlite3_column_text(stmt, 8));</a>
<a name="ln1037">    xmlTextWriterWriteFormatElement(writer, BAD_CAST &quot;iop_order&quot;, &quot;%f&quot;, sqlite3_column_double(stmt, 9));</a>
<a name="ln1038">    xmlTextWriterEndElement(writer);</a>
<a name="ln1039">  }</a>
<a name="ln1040">  sqlite3_finalize(stmt);</a>
<a name="ln1041">  xmlTextWriterEndDocument(writer);</a>
<a name="ln1042">  xmlFreeTextWriter(writer);</a>
<a name="ln1043">}</a>
<a name="ln1044"> </a>
<a name="ln1045">static StyleData *dt_styles_style_data_new()</a>
<a name="ln1046">{</a>
<a name="ln1047">  StyleInfoData *info = g_new0(StyleInfoData, 1);</a>
<a name="ln1048">  info-&gt;name = g_string_new(&quot;&quot;);</a>
<a name="ln1049">  info-&gt;description = g_string_new(&quot;&quot;);</a>
<a name="ln1050"> </a>
<a name="ln1051">  StyleData *data = g_new0(StyleData, 1);</a>
<a name="ln1052">  data-&gt;info = info;</a>
<a name="ln1053">  data-&gt;in_plugin = FALSE;</a>
<a name="ln1054">  data-&gt;plugins = NULL;</a>
<a name="ln1055"> </a>
<a name="ln1056">  return data;</a>
<a name="ln1057">}</a>
<a name="ln1058"> </a>
<a name="ln1059">static StylePluginData *dt_styles_style_plugin_new()</a>
<a name="ln1060">{</a>
<a name="ln1061">  StylePluginData *plugin = g_new0(StylePluginData, 1);</a>
<a name="ln1062">  plugin-&gt;operation = g_string_new(&quot;&quot;);</a>
<a name="ln1063">  plugin-&gt;op_params = g_string_new(&quot;&quot;);</a>
<a name="ln1064">  plugin-&gt;blendop_params = g_string_new(&quot;&quot;);</a>
<a name="ln1065">  plugin-&gt;multi_name = g_string_new(&quot;&quot;);</a>
<a name="ln1066">  plugin-&gt;iop_order = -1.0;</a>
<a name="ln1067">  return plugin;</a>
<a name="ln1068">}</a>
<a name="ln1069"> </a>
<a name="ln1070">static void dt_styles_style_data_free(StyleData *style, gboolean free_segments)</a>
<a name="ln1071">{</a>
<a name="ln1072">  g_string_free(style-&gt;info-&gt;name, free_segments);</a>
<a name="ln1073">  g_string_free(style-&gt;info-&gt;description, free_segments);</a>
<a name="ln1074">  g_list_free(style-&gt;plugins);</a>
<a name="ln1075">  g_free(style);</a>
<a name="ln1076">}</a>
<a name="ln1077"> </a>
<a name="ln1078">static void dt_styles_start_tag_handler(GMarkupParseContext *context, const gchar *element_name,</a>
<a name="ln1079">                                        const gchar **attribute_names, const gchar **attribute_values,</a>
<a name="ln1080">                                        gpointer user_data, GError **error)</a>
<a name="ln1081">{</a>
<a name="ln1082">  StyleData *style = user_data;</a>
<a name="ln1083">  const gchar *elt = g_markup_parse_context_get_element(context);</a>
<a name="ln1084"> </a>
<a name="ln1085">  // We need to append the contents of any subtags to the content field</a>
<a name="ln1086">  // for this we need to know when we are inside the note-content tag</a>
<a name="ln1087">  if(g_ascii_strcasecmp(elt, &quot;plugin&quot;) == 0)</a>
<a name="ln1088">  {</a>
<a name="ln1089">    style-&gt;in_plugin = TRUE;</a>
<a name="ln1090">    style-&gt;plugins = g_list_prepend(style-&gt;plugins, dt_styles_style_plugin_new());</a>
<a name="ln1091">  }</a>
<a name="ln1092">}</a>
<a name="ln1093"> </a>
<a name="ln1094">static void dt_styles_end_tag_handler(GMarkupParseContext *context, const gchar *element_name,</a>
<a name="ln1095">                                      gpointer user_data, GError **error)</a>
<a name="ln1096">{</a>
<a name="ln1097">  StyleData *style = user_data;</a>
<a name="ln1098">  const gchar *elt = g_markup_parse_context_get_element(context);</a>
<a name="ln1099"> </a>
<a name="ln1100">  // We need to append the contents of any subtags to the content field</a>
<a name="ln1101">  // for this we need to know when we are inside the note-content tag</a>
<a name="ln1102">  if(g_ascii_strcasecmp(elt, &quot;plugin&quot;) == 0)</a>
<a name="ln1103">  {</a>
<a name="ln1104">    style-&gt;in_plugin = FALSE;</a>
<a name="ln1105">  }</a>
<a name="ln1106">}</a>
<a name="ln1107"> </a>
<a name="ln1108">static void dt_styles_style_text_handler(GMarkupParseContext *context, const gchar *text, gsize text_len,</a>
<a name="ln1109">                                         gpointer user_data, GError **error)</a>
<a name="ln1110">{</a>
<a name="ln1111"> </a>
<a name="ln1112">  StyleData *style = user_data;</a>
<a name="ln1113">  const gchar *elt = g_markup_parse_context_get_element(context);</a>
<a name="ln1114"> </a>
<a name="ln1115">  if(g_ascii_strcasecmp(elt, &quot;name&quot;) == 0)</a>
<a name="ln1116">  {</a>
<a name="ln1117">    g_string_append_len(style-&gt;info-&gt;name, text, text_len);</a>
<a name="ln1118">  }</a>
<a name="ln1119">  else if(g_ascii_strcasecmp(elt, &quot;description&quot;) == 0)</a>
<a name="ln1120">  {</a>
<a name="ln1121">    g_string_append_len(style-&gt;info-&gt;description, text, text_len);</a>
<a name="ln1122">  }</a>
<a name="ln1123">  else if(style-&gt;in_plugin)</a>
<a name="ln1124">  {</a>
<a name="ln1125">    StylePluginData *plug = g_list_first(style-&gt;plugins)-&gt;data;</a>
<a name="ln1126">    if(g_ascii_strcasecmp(elt, &quot;operation&quot;) == 0)</a>
<a name="ln1127">    {</a>
<a name="ln1128">      g_string_append_len(plug-&gt;operation, text, text_len);</a>
<a name="ln1129">    }</a>
<a name="ln1130">    else if(g_ascii_strcasecmp(elt, &quot;op_params&quot;) == 0)</a>
<a name="ln1131">    {</a>
<a name="ln1132">      g_string_append_len(plug-&gt;op_params, text, text_len);</a>
<a name="ln1133">    }</a>
<a name="ln1134">    else if(g_ascii_strcasecmp(elt, &quot;blendop_params&quot;) == 0)</a>
<a name="ln1135">    {</a>
<a name="ln1136">      g_string_append_len(plug-&gt;blendop_params, text, text_len);</a>
<a name="ln1137">    }</a>
<a name="ln1138">    else if(g_ascii_strcasecmp(elt, &quot;blendop_version&quot;) == 0)</a>
<a name="ln1139">    {</a>
<a name="ln1140">      plug-&gt;blendop_version = atoi(text);</a>
<a name="ln1141">    }</a>
<a name="ln1142">    else if(g_ascii_strcasecmp(elt, &quot;multi_priority&quot;) == 0)</a>
<a name="ln1143">    {</a>
<a name="ln1144">      plug-&gt;multi_priority = atoi(text);</a>
<a name="ln1145">    }</a>
<a name="ln1146">    else if(g_ascii_strcasecmp(elt, &quot;multi_name&quot;) == 0)</a>
<a name="ln1147">    {</a>
<a name="ln1148">      g_string_append_len(plug-&gt;multi_name, text, text_len);</a>
<a name="ln1149">    }</a>
<a name="ln1150">    else if(g_ascii_strcasecmp(elt, &quot;num&quot;) == 0)</a>
<a name="ln1151">    {</a>
<a name="ln1152">      plug-&gt;num = atoi(text);</a>
<a name="ln1153">    }</a>
<a name="ln1154">    else if(g_ascii_strcasecmp(elt, &quot;module&quot;) == 0)</a>
<a name="ln1155">    {</a>
<a name="ln1156">      plug-&gt;module = atoi(text);</a>
<a name="ln1157">    }</a>
<a name="ln1158">    else if(g_ascii_strcasecmp(elt, &quot;enabled&quot;) == 0)</a>
<a name="ln1159">    {</a>
<a name="ln1160">      plug-&gt;enabled = atoi(text);</a>
<a name="ln1161">    }</a>
<a name="ln1162">    else if(g_ascii_strcasecmp(elt, &quot;iop_order&quot;) == 0)</a>
<a name="ln1163">    {</a>
<a name="ln1164">      plug-&gt;iop_order = atof(text);</a>
<a name="ln1165">    }</a>
<a name="ln1166">  }</a>
<a name="ln1167">}</a>
<a name="ln1168"> </a>
<a name="ln1169">static GMarkupParser dt_style_parser = {</a>
<a name="ln1170">  dt_styles_start_tag_handler,  // Start element handler</a>
<a name="ln1171">  dt_styles_end_tag_handler,    // End element handler</a>
<a name="ln1172">  dt_styles_style_text_handler, // Text element handler</a>
<a name="ln1173">  NULL,                         // Passthrough handler</a>
<a name="ln1174">  NULL                          // Error handler</a>
<a name="ln1175">};</a>
<a name="ln1176"> </a>
<a name="ln1177">static void dt_style_plugin_save(StylePluginData *plugin, gpointer styleId)</a>
<a name="ln1178">{</a>
<a name="ln1179">  int id = GPOINTER_TO_INT(styleId);</a>
<a name="ln1180">  sqlite3_stmt *stmt;</a>
<a name="ln1181">  DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln1182">                              &quot;INSERT INTO data.style_items &quot;</a>
<a name="ln1183">                              &quot;(styleid,num,module,operation,op_params,enabled,blendop_params,blendop_&quot;</a>
<a name="ln1184">                              &quot;version,multi_priority,multi_name,iop_order) VALUES (?1,?2,?3,?4,?5,?6,?7,?8,?9,?10,?11)&quot;,</a>
<a name="ln1185">                              -1, &amp;stmt, NULL);</a>
<a name="ln1186">  DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, id);</a>
<a name="ln1187">  DT_DEBUG_SQLITE3_BIND_INT(stmt, 2, plugin-&gt;num);</a>
<a name="ln1188">  DT_DEBUG_SQLITE3_BIND_INT(stmt, 3, plugin-&gt;module);</a>
<a name="ln1189">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 4, plugin-&gt;operation-&gt;str, plugin-&gt;operation-&gt;len, SQLITE_TRANSIENT);</a>
<a name="ln1190">  //</a>
<a name="ln1191">  const char *param_c = plugin-&gt;op_params-&gt;str;</a>
<a name="ln1192">  const int param_c_len = strlen(param_c);</a>
<a name="ln1193">  int params_len = 0;</a>
<a name="ln1194">  unsigned char *params = dt_exif_xmp_decode(param_c, param_c_len, &amp;params_len);</a>
<a name="ln1195">  DT_DEBUG_SQLITE3_BIND_BLOB(stmt, 5, params, params_len, SQLITE_TRANSIENT);</a>
<a name="ln1196">  //</a>
<a name="ln1197">  DT_DEBUG_SQLITE3_BIND_INT(stmt, 6, plugin-&gt;enabled);</a>
<a name="ln1198"> </a>
<a name="ln1199">  /* decode and store blendop params */</a>
<a name="ln1200">  int blendop_params_len = 0;</a>
<a name="ln1201">  unsigned char *blendop_params = dt_exif_xmp_decode(</a>
<a name="ln1202">      plugin-&gt;blendop_params-&gt;str, strlen(plugin-&gt;blendop_params-&gt;str), &amp;blendop_params_len);</a>
<a name="ln1203">  DT_DEBUG_SQLITE3_BIND_BLOB(stmt, 7, blendop_params, blendop_params_len, SQLITE_TRANSIENT);</a>
<a name="ln1204"> </a>
<a name="ln1205">  DT_DEBUG_SQLITE3_BIND_INT(stmt, 8, plugin-&gt;blendop_version);</a>
<a name="ln1206"> </a>
<a name="ln1207">  DT_DEBUG_SQLITE3_BIND_INT(stmt, 9, plugin-&gt;multi_priority);</a>
<a name="ln1208">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 10, plugin-&gt;multi_name-&gt;str, plugin-&gt;multi_name-&gt;len, SQLITE_TRANSIENT);</a>
<a name="ln1209">  DT_DEBUG_SQLITE3_BIND_DOUBLE(stmt, 11, plugin-&gt;iop_order);</a>
<a name="ln1210"> </a>
<a name="ln1211">  sqlite3_step(stmt);</a>
<a name="ln1212">  sqlite3_finalize(stmt);</a>
<a name="ln1213">  free(params);</a>
<a name="ln1214">}</a>
<a name="ln1215"> </a>
<a name="ln1216">static int _style_get_min_num(GList *style_plugins, const char *op)</a>
<a name="ln1217">{</a>
<a name="ln1218">  int min_num = INT_MAX;</a>
<a name="ln1219"> </a>
<a name="ln1220">  GList *plugins = g_list_first(style_plugins);</a>
<a name="ln1221">  while(plugins)</a>
<a name="ln1222">  {</a>
<a name="ln1223">    StylePluginData *plugin = (StylePluginData*)plugins-&gt;data;</a>
<a name="ln1224"> </a>
<a name="ln1225">    if(strcmp(plugin-&gt;operation-&gt;str, op) == 0)</a>
<a name="ln1226">      min_num = MIN(min_num, plugin-&gt;num);</a>
<a name="ln1227"> </a>
<a name="ln1228">    plugins = g_list_next(plugins);</a>
<a name="ln1229">  }</a>
<a name="ln1230"> </a>
<a name="ln1231">  if(min_num == INT_MAX)</a>
<a name="ln1232">    min_num = 0;</a>
<a name="ln1233"> </a>
<a name="ln1234">  return min_num;</a>
<a name="ln1235">}</a>
<a name="ln1236"> </a>
<a name="ln1237">static void _style_rebuild_iop_order(GList *style_plugins, const int id)</a>
<a name="ln1238">{</a>
<a name="ln1239">  // check if any entry has a missing iop_order</a>
<a name="ln1240">  GList *plugins = g_list_first(style_plugins);</a>
<a name="ln1241">  while(plugins)</a>
<a name="ln1242">  {</a>
<a name="ln1243">    StylePluginData *plugin = (StylePluginData*)plugins-&gt;data;</a>
<a name="ln1244"> </a>
<a name="ln1245">    if(plugin-&gt;iop_order &lt;= 0.0)</a>
<a name="ln1246">    {</a>
<a name="ln1247">      plugin-&gt;iop_order = dt_ioppr_get_iop_order(darktable.iop_order_list, plugin-&gt;operation-&gt;str) +</a>
<a name="ln1248">                            (plugin-&gt;num - _style_get_min_num(style_plugins, plugin-&gt;operation-&gt;str)) / 1000.0;</a>
<a name="ln1249">    }</a>
<a name="ln1250"> </a>
<a name="ln1251">    plugins = g_list_next(plugins);</a>
<a name="ln1252">  }</a>
<a name="ln1253"> </a>
<a name="ln1254">}</a>
<a name="ln1255"> </a>
<a name="ln1256">static void dt_style_save(StyleData *style)</a>
<a name="ln1257">{</a>
<a name="ln1258">  int id = 0;</a>
<a name="ln1259">  if(style == NULL) return;</a>
<a name="ln1260"> </a>
<a name="ln1261">  /* first create the style header */</a>
<a name="ln1262">  if(!dt_styles_create_style_header(style-&gt;info-&gt;name-&gt;str, style-&gt;info-&gt;description-&gt;str)) return;</a>
<a name="ln1263"> </a>
<a name="ln1264">  if((id = dt_styles_get_id_by_name(style-&gt;info-&gt;name-&gt;str)) != 0)</a>
<a name="ln1265">  {</a>
<a name="ln1266">    _style_rebuild_iop_order(style-&gt;plugins, id);</a>
<a name="ln1267"> </a>
<a name="ln1268">    g_list_foreach(style-&gt;plugins, (GFunc)dt_style_plugin_save, GINT_TO_POINTER(id));</a>
<a name="ln1269">    dt_control_log(_(&quot;style %s was successfully imported&quot;), style-&gt;info-&gt;name-&gt;str);</a>
<a name="ln1270">  }</a>
<a name="ln1271">}</a>
<a name="ln1272"> </a>
<a name="ln1273">void dt_styles_import_from_file(const char *style_path)</a>
<a name="ln1274">{</a>
<a name="ln1275">  FILE *style_file;</a>
<a name="ln1276">  StyleData *style;</a>
<a name="ln1277">  GMarkupParseContext *parser;</a>
<a name="ln1278">  gchar buf[1024];</a>
<a name="ln1279">  size_t num_read;</a>
<a name="ln1280"> </a>
<a name="ln1281">  style = dt_styles_style_data_new();</a>
<a name="ln1282">  parser = g_markup_parse_context_new(&amp;dt_style_parser, 0, style, NULL);</a>
<a name="ln1283"> </a>
<a name="ln1284">  if((style_file = g_fopen(style_path, &quot;r&quot;)))</a>
<a name="ln1285">  {</a>
<a name="ln1286"> </a>
<a name="ln1287">    while(!feof(style_file))</a>
<a name="ln1288">    {</a>
<a name="ln1289">      num_read = fread(buf, sizeof(gchar), sizeof(buf), style_file);</a>
<a name="ln1290"> </a>
<a name="ln1291">      if(num_read == 0)</a>
<a name="ln1292">      {</a>
<a name="ln1293">        break;</a>
<a name="ln1294">      }</a>
<a name="ln1295">      else if(num_read == -1)</a>
<a name="ln1296">      {</a>
<a name="ln1297">        // FIXME: ferror?</a>
<a name="ln1298">        // ERROR !</a>
<a name="ln1299">        break;</a>
<a name="ln1300">      }</a>
<a name="ln1301"> </a>
<a name="ln1302">      if(!g_markup_parse_context_parse(parser, buf, num_read, NULL))</a>
<a name="ln1303">      {</a>
<a name="ln1304">        g_markup_parse_context_free(parser);</a>
<a name="ln1305">        dt_styles_style_data_free(style, TRUE);</a>
<a name="ln1306">        fclose(style_file);</a>
<a name="ln1307">        return;</a>
<a name="ln1308">      }</a>
<a name="ln1309">    }</a>
<a name="ln1310">  }</a>
<a name="ln1311">  else</a>
<a name="ln1312">  {</a>
<a name="ln1313">    // Failed to open file, clean up.</a>
<a name="ln1314">    g_markup_parse_context_free(parser);</a>
<a name="ln1315">    dt_styles_style_data_free(style, TRUE);</a>
<a name="ln1316">    return;</a>
<a name="ln1317">  }</a>
<a name="ln1318"> </a>
<a name="ln1319">  if(!g_markup_parse_context_end_parse(parser, NULL))</a>
<a name="ln1320">  {</a>
<a name="ln1321">    g_markup_parse_context_free(parser);</a>
<a name="ln1322">    dt_styles_style_data_free(style, TRUE);</a>
<a name="ln1323">    fclose(style_file);</a>
<a name="ln1324">    return;</a>
<a name="ln1325">  }</a>
<a name="ln1326">  g_markup_parse_context_free(parser);</a>
<a name="ln1327">  // save data</a>
<a name="ln1328">  dt_style_save(style);</a>
<a name="ln1329">  //</a>
<a name="ln1330">  dt_styles_style_data_free(style, TRUE);</a>
<a name="ln1331">  fclose(style_file);</a>
<a name="ln1332"> </a>
<a name="ln1333">  dt_control_signal_raise(darktable.signals, DT_SIGNAL_STYLE_CHANGED);</a>
<a name="ln1334">}</a>
<a name="ln1335"> </a>
<a name="ln1336">gchar *dt_styles_get_description(const char *name)</a>
<a name="ln1337">{</a>
<a name="ln1338">  sqlite3_stmt *stmt;</a>
<a name="ln1339">  int id = 0;</a>
<a name="ln1340">  gchar *description = NULL;</a>
<a name="ln1341">  if((id = dt_styles_get_id_by_name(name)) != 0)</a>
<a name="ln1342">  {</a>
<a name="ln1343">    DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), &quot;SELECT description FROM data.styles WHERE id=?1&quot;,</a>
<a name="ln1344">                                -1, &amp;stmt, NULL);</a>
<a name="ln1345">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, id);</a>
<a name="ln1346">    sqlite3_step(stmt);</a>
<a name="ln1347">    description = (char *)sqlite3_column_text(stmt, 0);</a>
<a name="ln1348">    if(description) description = g_strdup(description);</a>
<a name="ln1349">    sqlite3_finalize(stmt);</a>
<a name="ln1350">  }</a>
<a name="ln1351">  return description;</a>
<a name="ln1352">}</a>
<a name="ln1353"> </a>
<a name="ln1354">static int32_t dt_styles_get_id_by_name(const char *name)</a>
<a name="ln1355">{</a>
<a name="ln1356">  int id = 0;</a>
<a name="ln1357">  sqlite3_stmt *stmt;</a>
<a name="ln1358">  DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln1359">                              &quot;SELECT id FROM data.styles WHERE name=?1 ORDER BY id DESC LIMIT 1&quot;, -1, &amp;stmt,</a>
<a name="ln1360">                              NULL);</a>
<a name="ln1361">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 1, name, -1, SQLITE_TRANSIENT);</a>
<a name="ln1362">  if(sqlite3_step(stmt) == SQLITE_ROW)</a>
<a name="ln1363">  {</a>
<a name="ln1364">    id = sqlite3_column_int(stmt, 0);</a>
<a name="ln1365">  }</a>
<a name="ln1366">  sqlite3_finalize(stmt);</a>
<a name="ln1367">  return id;</a>
<a name="ln1368">}</a>
<a name="ln1369"> </a>
<a name="ln1370">void init_styles_key_accels()</a>
<a name="ln1371">{</a>
<a name="ln1372">  GList *result = dt_styles_get_list(&quot;&quot;);</a>
<a name="ln1373">  if(result)</a>
<a name="ln1374">  {</a>
<a name="ln1375">    do</a>
<a name="ln1376">    {</a>
<a name="ln1377">      dt_style_t *style = (dt_style_t *)result-&gt;data;</a>
<a name="ln1378">      char tmp_accel[1024];</a>
<a name="ln1379">      snprintf(tmp_accel, sizeof(tmp_accel), C_(&quot;accel&quot;, &quot;styles/apply %s&quot;), style-&gt;name);</a>
<a name="ln1380">      dt_accel_register_global(tmp_accel, 0, 0);</a>
<a name="ln1381">    } while((result = g_list_next(result)) != NULL);</a>
<a name="ln1382">    g_list_free_full(result, dt_style_free);</a>
<a name="ln1383">  }</a>
<a name="ln1384">}</a>
<a name="ln1385"> </a>
<a name="ln1386">void connect_styles_key_accels()</a>
<a name="ln1387">{</a>
<a name="ln1388">  GList *result = dt_styles_get_list(&quot;&quot;);</a>
<a name="ln1389">  if(result)</a>
<a name="ln1390">  {</a>
<a name="ln1391">    do</a>
<a name="ln1392">    {</a>
<a name="ln1393">      GClosure *closure;</a>
<a name="ln1394">      dt_style_t *style = (dt_style_t *)result-&gt;data;</a>
<a name="ln1395">      closure = g_cclosure_new(G_CALLBACK(_apply_style_shortcut_callback), g_strdup(style-&gt;name),</a>
<a name="ln1396">                               _destroy_style_shortcut_callback);</a>
<a name="ln1397">      char tmp_accel[1024];</a>
<a name="ln1398">      snprintf(tmp_accel, sizeof(tmp_accel), C_(&quot;accel&quot;, &quot;styles/apply %s&quot;), style-&gt;name);</a>
<a name="ln1399">      dt_accel_connect_global(tmp_accel, closure);</a>
<a name="ln1400">    } while((result = g_list_next(result)) != NULL);</a>
<a name="ln1401">    g_list_free_full(result, dt_style_free);</a>
<a name="ln1402">  }</a>
<a name="ln1403">}</a>
<a name="ln1404"> </a>
<a name="ln1405">dt_style_t *dt_styles_get_by_name(const char *name)</a>
<a name="ln1406">{</a>
<a name="ln1407">  sqlite3_stmt *stmt;</a>
<a name="ln1408">  DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln1409">                              &quot;SELECT name, description FROM data.styles WHERE name = ?1&quot;, -1, &amp;stmt, NULL);</a>
<a name="ln1410">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 1, name, -1, SQLITE_STATIC);</a>
<a name="ln1411">  if(sqlite3_step(stmt) == SQLITE_ROW)</a>
<a name="ln1412">  {</a>
<a name="ln1413">    const char *style_name = (const char *)sqlite3_column_text(stmt, 0);</a>
<a name="ln1414">    const char *description = (const char *)sqlite3_column_text(stmt, 1);</a>
<a name="ln1415">    dt_style_t *s = g_malloc(sizeof(dt_style_t));</a>
<a name="ln1416">    s-&gt;name = g_strdup(style_name);</a>
<a name="ln1417">    s-&gt;description = g_strdup(description);</a>
<a name="ln1418">    sqlite3_finalize(stmt);</a>
<a name="ln1419">    return s;</a>
<a name="ln1420">  }</a>
<a name="ln1421">  else</a>
<a name="ln1422">  {</a>
<a name="ln1423"> </a>
<a name="ln1424">    sqlite3_finalize(stmt);</a>
<a name="ln1425">    return NULL;</a>
<a name="ln1426">  }</a>
<a name="ln1427">}</a>
<a name="ln1428">// modelines: These editor modelines have been set for all relevant files by tools/update_modelines.sh</a>
<a name="ln1429">// vim: shiftwidth=2 expandtab tabstop=2 cindent</a>
<a name="ln1430">// kate: tab-indents: off; indent-width 2; replace-tabs on; indent-mode cstyle; remove-trailing-spaces modified;</a>

</code></pre>
<div class="balloon" rel="155"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v522/" target="_blank">V522</a> There might be dereferencing of a potential null pointer 'd'. Check lines: 155, 144.</p></div>
<div class="balloon" rel="178"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v575/" target="_blank">V575</a> The null pointer is passed into 'g_list_free_full' function. Inspect the first argument.</p></div>
<div class="balloon" rel="577"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v522/" target="_blank">V522</a> There might be dereferencing of a potential null pointer 'module'. Check lines: 577, 566.</p></div>
<div class="balloon" rel="849"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v522/" target="_blank">V522</a> There might be dereferencing of a potential null pointer 'item'. Check lines: 849, 846.</p></div>
<div class="balloon" rel="878"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v575/" target="_blank">V575</a> The potential null pointer is passed into 'memcpy' function. Inspect the first argument. Check lines: 878, 876.</p></div>
<div class="balloon" rel="882"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v575/" target="_blank">V575</a> The potential null pointer is passed into 'memcpy' function. Inspect the first argument. Check lines: 882, 880.</p></div>
<div class="balloon" rel="932"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v575/" target="_blank">V575</a> The null pointer is passed into 'g_list_free_full' function. Inspect the first argument.</p></div>
<div class="balloon" rel="1295"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v547/" target="_blank">V547</a> Expression 'num_read == - 1' is always false.</p></div>
<div class="balloon" rel="1382"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v575/" target="_blank">V575</a> The null pointer is passed into 'g_list_free_full' function. Inspect the first argument.</p></div>
<div class="balloon" rel="1401"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v575/" target="_blank">V575</a> The null pointer is passed into 'g_list_free_full' function. Inspect the first argument.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
