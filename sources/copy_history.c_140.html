
<html>
<head>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>
<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2">    This file is part of darktable,</a>
<a name="ln3">    copyright (c) 2009--2010 johannes hanika.</a>
<a name="ln4"> </a>
<a name="ln5">    darktable is free software: you can redistribute it and/or modify</a>
<a name="ln6">    it under the terms of the GNU General Public License as published by</a>
<a name="ln7">    the Free Software Foundation, either version 3 of the License, or</a>
<a name="ln8">    (at your option) any later version.</a>
<a name="ln9"> </a>
<a name="ln10">    darktable is distributed in the hope that it will be useful,</a>
<a name="ln11">    but WITHOUT ANY WARRANTY; without even the implied warranty of</a>
<a name="ln12">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</a>
<a name="ln13">    GNU General Public License for more details.</a>
<a name="ln14"> </a>
<a name="ln15">    You should have received a copy of the GNU General Public License</a>
<a name="ln16">    along with darktable.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</a>
<a name="ln17">*/</a>
<a name="ln18">#include &quot;bauhaus/bauhaus.h&quot;</a>
<a name="ln19">#include &quot;common/collection.h&quot;</a>
<a name="ln20">#include &quot;common/darktable.h&quot;</a>
<a name="ln21">#include &quot;common/debug.h&quot;</a>
<a name="ln22">#include &quot;common/history.h&quot;</a>
<a name="ln23">#include &quot;control/conf.h&quot;</a>
<a name="ln24">#include &quot;control/control.h&quot;</a>
<a name="ln25">#include &quot;control/jobs.h&quot;</a>
<a name="ln26">#include &quot;dtgtk/button.h&quot;</a>
<a name="ln27">#include &quot;gui/accelerators.h&quot;</a>
<a name="ln28">#include &quot;gui/gtk.h&quot;</a>
<a name="ln29">#include &quot;gui/hist_dialog.h&quot;</a>
<a name="ln30">#include &quot;libs/lib.h&quot;</a>
<a name="ln31">#include &quot;libs/lib_api.h&quot;</a>
<a name="ln32">#ifdef GDK_WINDOWING_QUARTZ</a>
<a name="ln33">#include &quot;osx/osx.h&quot;</a>
<a name="ln34">#endif</a>
<a name="ln35">#include &lt;gdk/gdkkeysyms.h&gt;</a>
<a name="ln36">#include &lt;gtk/gtk.h&gt;</a>
<a name="ln37">#include &lt;stdlib.h&gt;</a>
<a name="ln38"> </a>
<a name="ln39">DT_MODULE(1)</a>
<a name="ln40"> </a>
<a name="ln41">typedef struct dt_lib_copy_history_t</a>
<a name="ln42">{</a>
<a name="ln43">  int32_t imageid;</a>
<a name="ln44">  GtkWidget *pastemode;</a>
<a name="ln45">  GtkButton *paste, *paste_parts;</a>
<a name="ln46">  GtkWidget *copy_button, *delete_button, *load_button, *write_button;</a>
<a name="ln47">  GtkWidget *copy_parts_button;</a>
<a name="ln48">  GtkButton *compress_button;</a>
<a name="ln49"> </a>
<a name="ln50">  dt_gui_hist_dialog_t dg;</a>
<a name="ln51">} dt_lib_copy_history_t;</a>
<a name="ln52"> </a>
<a name="ln53">const char *name(dt_lib_module_t *self)</a>
<a name="ln54">{</a>
<a name="ln55">  return _(&quot;history stack&quot;);</a>
<a name="ln56">}</a>
<a name="ln57"> </a>
<a name="ln58">const char **views(dt_lib_module_t *self)</a>
<a name="ln59">{</a>
<a name="ln60">  static const char *v[] = {&quot;lighttable&quot;, NULL};</a>
<a name="ln61">  return v;</a>
<a name="ln62">}</a>
<a name="ln63"> </a>
<a name="ln64">uint32_t container(dt_lib_module_t *self)</a>
<a name="ln65">{</a>
<a name="ln66">  return DT_UI_CONTAINER_PANEL_RIGHT_CENTER;</a>
<a name="ln67">}</a>
<a name="ln68"> </a>
<a name="ln69">static void write_button_clicked(GtkWidget *widget, dt_lib_module_t *self)</a>
<a name="ln70">{</a>
<a name="ln71">  dt_control_write_sidecar_files();</a>
<a name="ln72">}</a>
<a name="ln73"> </a>
<a name="ln74">static void load_button_clicked(GtkWidget *widget, dt_lib_module_t *self)</a>
<a name="ln75">{</a>
<a name="ln76">  GtkWidget *win = dt_ui_main_window(darktable.gui-&gt;ui);</a>
<a name="ln77">  GtkWidget *filechooser = gtk_file_chooser_dialog_new(</a>
<a name="ln78">      _(&quot;open sidecar file&quot;), GTK_WINDOW(win), GTK_FILE_CHOOSER_ACTION_OPEN, _(&quot;_cancel&quot;),</a>
<a name="ln79">      GTK_RESPONSE_CANCEL, _(&quot;_open&quot;), GTK_RESPONSE_ACCEPT, (char *)NULL);</a>
<a name="ln80">#ifdef GDK_WINDOWING_QUARTZ</a>
<a name="ln81">  dt_osx_disallow_fullscreen(filechooser);</a>
<a name="ln82">#endif</a>
<a name="ln83"> </a>
<a name="ln84">  GtkFileFilter *filter;</a>
<a name="ln85">  filter = GTK_FILE_FILTER(gtk_file_filter_new());</a>
<a name="ln86">  gtk_file_filter_add_pattern(filter, &quot;*.xmp&quot;);</a>
<a name="ln87">  gtk_file_filter_add_pattern(filter, &quot;*.XMP&quot;);</a>
<a name="ln88">  gtk_file_filter_set_name(filter, _(&quot;XMP sidecar files&quot;));</a>
<a name="ln89">  gtk_file_chooser_add_filter(GTK_FILE_CHOOSER(filechooser), filter);</a>
<a name="ln90"> </a>
<a name="ln91">  filter = GTK_FILE_FILTER(gtk_file_filter_new());</a>
<a name="ln92">  gtk_file_filter_add_pattern(filter, &quot;*&quot;);</a>
<a name="ln93">  gtk_file_filter_set_name(filter, _(&quot;all files&quot;));</a>
<a name="ln94">  gtk_file_chooser_add_filter(GTK_FILE_CHOOSER(filechooser), filter);</a>
<a name="ln95"> </a>
<a name="ln96">  if(gtk_dialog_run(GTK_DIALOG(filechooser)) == GTK_RESPONSE_ACCEPT)</a>
<a name="ln97">  {</a>
<a name="ln98">    char *dtfilename;</a>
<a name="ln99">    dtfilename = gtk_file_chooser_get_filename(GTK_FILE_CHOOSER(filechooser));</a>
<a name="ln100"> </a>
<a name="ln101">    if(dt_history_load_and_apply_on_selection(dtfilename) != 0)</a>
<a name="ln102">    {</a>
<a name="ln103">      GtkWidget *dialog</a>
<a name="ln104">          = gtk_message_dialog_new(GTK_WINDOW(win), GTK_DIALOG_DESTROY_WITH_PARENT, GTK_MESSAGE_ERROR,</a>
<a name="ln105">                                   GTK_BUTTONS_CLOSE, _(&quot;error loading file '%s'&quot;), dtfilename);</a>
<a name="ln106">#ifdef GDK_WINDOWING_QUARTZ</a>
<a name="ln107">      dt_osx_disallow_fullscreen(dialog);</a>
<a name="ln108">#endif</a>
<a name="ln109">      gtk_dialog_run(GTK_DIALOG(dialog));</a>
<a name="ln110">      gtk_widget_destroy(dialog);</a>
<a name="ln111">    }</a>
<a name="ln112"> </a>
<a name="ln113">    g_free(dtfilename);</a>
<a name="ln114">  }</a>
<a name="ln115">  gtk_widget_destroy(filechooser);</a>
<a name="ln116">  gtk_widget_queue_draw(dt_ui_center(darktable.gui-&gt;ui));</a>
<a name="ln117">}</a>
<a name="ln118"> </a>
<a name="ln119">static int get_selected_image(void)</a>
<a name="ln120">{</a>
<a name="ln121">  int imgid;</a>
<a name="ln122"> </a>
<a name="ln123">  /* get imageid for source if history past */</a>
<a name="ln124">  sqlite3_stmt *stmt;</a>
<a name="ln125">  DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), &quot;SELECT imgid FROM main.selected_images&quot;,</a>
<a name="ln126">                              -1, &amp;stmt, NULL);</a>
<a name="ln127">  if(sqlite3_step(stmt) == SQLITE_ROW)</a>
<a name="ln128">  {</a>
<a name="ln129">    /* copy history of first image in selection */</a>
<a name="ln130">    imgid = sqlite3_column_int(stmt, 0);</a>
<a name="ln131">    // dt_control_log(_(&quot;history of first image in selection copied&quot;));</a>
<a name="ln132">  }</a>
<a name="ln133">  else</a>
<a name="ln134">  {</a>
<a name="ln135">    /* no selection is used, use mouse over id */</a>
<a name="ln136">    imgid = dt_control_get_mouse_over_id();</a>
<a name="ln137">  }</a>
<a name="ln138">  sqlite3_finalize(stmt);</a>
<a name="ln139"> </a>
<a name="ln140">  return imgid;</a>
<a name="ln141">}</a>
<a name="ln142"> </a>
<a name="ln143">static void copy_button_clicked(GtkWidget *widget, gpointer user_data)</a>
<a name="ln144">{</a>
<a name="ln145">  dt_lib_module_t *self = (dt_lib_module_t *)user_data;</a>
<a name="ln146">  dt_lib_copy_history_t *d = (dt_lib_copy_history_t *)self-&gt;data;</a>
<a name="ln147"> </a>
<a name="ln148">  d-&gt;imageid = get_selected_image();</a>
<a name="ln149"> </a>
<a name="ln150">  if(d-&gt;imageid &gt; 0)</a>
<a name="ln151">  {</a>
<a name="ln152">    d-&gt;dg.selops = NULL;</a>
<a name="ln153">    d-&gt;dg.copied_imageid = d-&gt;imageid;</a>
<a name="ln154"> </a>
<a name="ln155">    gtk_widget_set_sensitive(GTK_WIDGET(d-&gt;paste), TRUE);</a>
<a name="ln156">    gtk_widget_set_sensitive(GTK_WIDGET(d-&gt;paste_parts), TRUE);</a>
<a name="ln157">  }</a>
<a name="ln158">}</a>
<a name="ln159"> </a>
<a name="ln160">static void compress_button_clicked(GtkWidget *widget, gpointer user_data)</a>
<a name="ln161">{</a>
<a name="ln162">  // Get the list of selected images</a>
<a name="ln163">  sqlite3_stmt *stmt;</a>
<a name="ln164">  DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), &quot;SELECT imgid FROM main.selected_images&quot;,</a>
<a name="ln165">                              -1, &amp;stmt, NULL);</a>
<a name="ln166"> </a>
<a name="ln167">  while(sqlite3_step(stmt) == SQLITE_ROW)</a>
<a name="ln168">  {</a>
<a name="ln169">    // get imgid of selected image</a>
<a name="ln170">    int32_t dest_imgid = sqlite3_column_int(stmt, 0);</a>
<a name="ln171"> </a>
<a name="ln172">    // make sure the right history is in there:</a>
<a name="ln173">    dt_dev_write_history(darktable.develop);</a>
<a name="ln174"> </a>
<a name="ln175">    // compress history and remove disabled modules - adapted from libs/history.c</a>
<a name="ln176">    sqlite3_stmt *stmt_local;</a>
<a name="ln177">    DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), &quot;DELETE FROM main.history WHERE imgid = ?1 AND num &quot;</a>
<a name="ln178">                                                               &quot;NOT IN (SELECT MAX(num) FROM main.history WHERE &quot;</a>
<a name="ln179">                                                               &quot;imgid = ?1 AND enabled = 1 GROUP BY operation, &quot;</a>
<a name="ln180">                                                               &quot;multi_priority)&quot;, -1, &amp;stmt_local, NULL);</a>
<a name="ln181">    DT_DEBUG_SQLITE3_BIND_INT(stmt_local, 1, dest_imgid);</a>
<a name="ln182">    sqlite3_step(stmt_local);</a>
<a name="ln183">    sqlite3_finalize(stmt_local);</a>
<a name="ln184"> </a>
<a name="ln185">    // delete all mask_manager entries - copied from libs/history.c</a>
<a name="ln186">    int masks_count = 0;</a>
<a name="ln187">    char op_mask_manager[20] = {0};</a>
<a name="ln188">    g_strlcpy(op_mask_manager, &quot;mask_manager&quot;, sizeof(op_mask_manager));</a>
<a name="ln189"> </a>
<a name="ln190">    DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), &quot;DELETE FROM main.history WHERE imgid = ?1 AND operation = ?2&quot;, -1, &amp;stmt_local, NULL);</a>
<a name="ln191">    DT_DEBUG_SQLITE3_BIND_INT(stmt_local, 1, dest_imgid);</a>
<a name="ln192">    DT_DEBUG_SQLITE3_BIND_TEXT(stmt_local, 2, op_mask_manager, -1, SQLITE_TRANSIENT);</a>
<a name="ln193">    sqlite3_step(stmt_local);</a>
<a name="ln194">    sqlite3_finalize(stmt_local);</a>
<a name="ln195"> </a>
<a name="ln196">    // if there's masks create a mask manage entry</a>
<a name="ln197">    DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln198">                                &quot;SELECT COUNT(*) FROM main.masks_history WHERE imgid = ?1&quot;,</a>
<a name="ln199">                                -1, &amp;stmt_local, NULL);</a>
<a name="ln200">    DT_DEBUG_SQLITE3_BIND_INT(stmt_local, 1, dest_imgid);</a>
<a name="ln201">    if(sqlite3_step(stmt_local) == SQLITE_ROW) masks_count = sqlite3_column_int(stmt_local, 0);</a>
<a name="ln202">    sqlite3_finalize(stmt_local);</a>
<a name="ln203"> </a>
<a name="ln204">    if(masks_count &gt; 0)</a>
<a name="ln205">    {</a>
<a name="ln206">      // set the masks history as first entry</a>
<a name="ln207">      DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), &quot;UPDATE main.masks_history SET num = 0 WHERE imgid = ?1&quot;, -1, &amp;stmt_local, NULL);</a>
<a name="ln208">      DT_DEBUG_SQLITE3_BIND_INT(stmt_local, 1, dest_imgid);</a>
<a name="ln209">      sqlite3_step(stmt_local);</a>
<a name="ln210">      sqlite3_finalize(stmt_local);</a>
<a name="ln211"> </a>
<a name="ln212">      // make room for mask manager history entry</a>
<a name="ln213">      DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), &quot;UPDATE main.history SET num=num+1 WHERE imgid = ?1&quot;,</a>
<a name="ln214">          -1, &amp;stmt_local, NULL);</a>
<a name="ln215">      DT_DEBUG_SQLITE3_BIND_INT(stmt_local, 1, dest_imgid);</a>
<a name="ln216">      sqlite3_step(stmt_local);</a>
<a name="ln217">      sqlite3_finalize(stmt_local);</a>
<a name="ln218"> </a>
<a name="ln219">      // update history end</a>
<a name="ln220">      DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), &quot;UPDATE main.images SET history_end = history_end+1 WHERE id = ?1&quot;,</a>
<a name="ln221">          -1, &amp;stmt_local, NULL);</a>
<a name="ln222">      DT_DEBUG_SQLITE3_BIND_INT(stmt_local, 1, dest_imgid);</a>
<a name="ln223">      sqlite3_step(stmt_local);</a>
<a name="ln224">      sqlite3_finalize(stmt_local);</a>
<a name="ln225"> </a>
<a name="ln226">      const double iop_order = dt_ioppr_get_iop_order(darktable.develop-&gt;iop_order_list, op_mask_manager);</a>
<a name="ln227"> </a>
<a name="ln228">      // create a mask manager entry in history as first entry</a>
<a name="ln229">      DT_DEBUG_SQLITE3_PREPARE_V2(</a>
<a name="ln230">          dt_database_get(darktable.db),</a>
<a name="ln231">          &quot;INSERT INTO main.history (imgid, num, operation, op_params, module, enabled, &quot;</a>
<a name="ln232">               &quot;blendop_params, blendop_version, multi_priority, multi_name, iop_order) &quot;</a>
<a name="ln233">          &quot;VALUES(?1, 0, ?2, NULL, 1, 0, NULL, 0, 0, '', ?3)&quot;,</a>
<a name="ln234">          -1, &amp;stmt_local, NULL);</a>
<a name="ln235">      DT_DEBUG_SQLITE3_BIND_INT(stmt_local, 1, dest_imgid);</a>
<a name="ln236">      DT_DEBUG_SQLITE3_BIND_TEXT(stmt_local, 2, op_mask_manager, -1, SQLITE_TRANSIENT);</a>
<a name="ln237">      DT_DEBUG_SQLITE3_BIND_DOUBLE(stmt_local, 3, iop_order);</a>
<a name="ln238">      sqlite3_step(stmt_local);</a>
<a name="ln239">      sqlite3_finalize(stmt_local);</a>
<a name="ln240">    }</a>
<a name="ln241"> </a>
<a name="ln242">    /* if current image in develop reload history */</a>
<a name="ln243">    if(dt_dev_is_current_image(darktable.develop, dest_imgid))</a>
<a name="ln244">    {</a>
<a name="ln245">      dt_dev_reload_history_items(darktable.develop);</a>
<a name="ln246">      dt_dev_write_history(darktable.develop);</a>
<a name="ln247">      dt_dev_modulegroups_set(darktable.develop, dt_dev_modulegroups_get(darktable.develop));</a>
<a name="ln248">    }</a>
<a name="ln249"> </a>
<a name="ln250">    // Update XMP files</a>
<a name="ln251">    dt_image_synch_xmp(dest_imgid);</a>
<a name="ln252">  }</a>
<a name="ln253"> </a>
<a name="ln254">  sqlite3_finalize(stmt);</a>
<a name="ln255"> </a>
<a name="ln256">  dt_control_queue_redraw_center();</a>
<a name="ln257">}</a>
<a name="ln258"> </a>
<a name="ln259">static void copy_parts_button_clicked(GtkWidget *widget, gpointer user_data)</a>
<a name="ln260">{</a>
<a name="ln261">  dt_lib_module_t *self = (dt_lib_module_t *)user_data;</a>
<a name="ln262">  dt_lib_copy_history_t *d = (dt_lib_copy_history_t *)self-&gt;data;</a>
<a name="ln263"> </a>
<a name="ln264">  d-&gt;imageid = get_selected_image();</a>
<a name="ln265"> </a>
<a name="ln266">  if(d-&gt;imageid &gt; 0)</a>
<a name="ln267">  {</a>
<a name="ln268">    d-&gt;dg.copied_imageid = d-&gt;imageid;</a>
<a name="ln269"> </a>
<a name="ln270">    // launch dialog to select the ops to copy</a>
<a name="ln271">    int res = dt_gui_hist_dialog_new(&amp;(d-&gt;dg), d-&gt;imageid, TRUE);</a>
<a name="ln272"> </a>
<a name="ln273">    if(res != GTK_RESPONSE_CANCEL &amp;&amp; d-&gt;dg.selops)</a>
<a name="ln274">    {</a>
<a name="ln275">      gtk_widget_set_sensitive(GTK_WIDGET(d-&gt;paste), TRUE);</a>
<a name="ln276">      gtk_widget_set_sensitive(GTK_WIDGET(d-&gt;paste_parts), TRUE);</a>
<a name="ln277">    }</a>
<a name="ln278">  }</a>
<a name="ln279">}</a>
<a name="ln280"> </a>
<a name="ln281">static void delete_button_clicked(GtkWidget *widget, gpointer user_data)</a>
<a name="ln282">{</a>
<a name="ln283">  gint res = GTK_RESPONSE_YES;</a>
<a name="ln284"> </a>
<a name="ln285">  if(dt_conf_get_bool(&quot;ask_before_delete&quot;))</a>
<a name="ln286">  {</a>
<a name="ln287">    const GtkWidget *win = dt_ui_main_window(darktable.gui-&gt;ui);</a>
<a name="ln288"> </a>
<a name="ln289">    int number;</a>
<a name="ln290">    if (dt_view_get_image_to_act_on() != -1)</a>
<a name="ln291">      number = 1;</a>
<a name="ln292">    else</a>
<a name="ln293">      number = dt_collection_get_selected_count(darktable.collection);</a>
<a name="ln294"> </a>
<a name="ln295">    if (number == 0) return;</a>
<a name="ln296"> </a>
<a name="ln297">    GtkWidget *dialog = gtk_message_dialog_new(</a>
<a name="ln298">        GTK_WINDOW(win), GTK_DIALOG_DESTROY_WITH_PARENT, GTK_MESSAGE_QUESTION, GTK_BUTTONS_YES_NO,</a>
<a name="ln299">        ngettext(&quot;do you really want to clear history of %d selected image?&quot;,</a>
<a name="ln300">                 &quot;do you really want to clear history of %d selected images?&quot;, number), number);</a>
<a name="ln301">#ifdef GDK_WINDOWING_QUARTZ</a>
<a name="ln302">    dt_osx_disallow_fullscreen(dialog);</a>
<a name="ln303">#endif</a>
<a name="ln304"> </a>
<a name="ln305">    gtk_window_set_title(GTK_WINDOW(dialog), _(&quot;delete images' history?&quot;));</a>
<a name="ln306">    res = gtk_dialog_run(GTK_DIALOG(dialog));</a>
<a name="ln307">    gtk_widget_destroy(dialog);</a>
<a name="ln308">  }</a>
<a name="ln309"> </a>
<a name="ln310">  if(res == GTK_RESPONSE_YES)</a>
<a name="ln311">  {</a>
<a name="ln312">    dt_history_delete_on_selection();</a>
<a name="ln313">    dt_control_queue_redraw_center();</a>
<a name="ln314">  }</a>
<a name="ln315">}</a>
<a name="ln316"> </a>
<a name="ln317">static void paste_button_clicked(GtkWidget *widget, gpointer user_data)</a>
<a name="ln318">{</a>
<a name="ln319"> </a>
<a name="ln320">  dt_lib_module_t *self = (dt_lib_module_t *)user_data;</a>
<a name="ln321">  dt_lib_copy_history_t *d = (dt_lib_copy_history_t *)self-&gt;data;</a>
<a name="ln322"> </a>
<a name="ln323">  /* get past mode and store, overwrite / merge */</a>
<a name="ln324">  int mode = dt_bauhaus_combobox_get(d-&gt;pastemode);</a>
<a name="ln325">  dt_conf_set_int(&quot;plugins/lighttable/copy_history/pastemode&quot;, mode);</a>
<a name="ln326"> </a>
<a name="ln327">  /* copy history from d-&gt;imageid and past onto selection */</a>
<a name="ln328">  if(dt_history_copy_and_paste_on_selection(d-&gt;imageid, (mode == 0) ? TRUE : FALSE, d-&gt;dg.selops) != 0)</a>
<a name="ln329">  {</a>
<a name="ln330">    /* no selection is used, use mouse over id */</a>
<a name="ln331">    int32_t mouse_over_id = dt_control_get_mouse_over_id();</a>
<a name="ln332">    if(mouse_over_id &lt;= 0) return;</a>
<a name="ln333"> </a>
<a name="ln334">    dt_history_copy_and_paste_on_image(d-&gt;imageid, mouse_over_id, (mode == 0) ? TRUE : FALSE, d-&gt;dg.selops);</a>
<a name="ln335">  }</a>
<a name="ln336"> </a>
<a name="ln337">  /* redraw */</a>
<a name="ln338">  dt_control_queue_redraw_center();</a>
<a name="ln339">}</a>
<a name="ln340"> </a>
<a name="ln341">static void paste_parts_button_clicked(GtkWidget *widget, gpointer user_data)</a>
<a name="ln342">{</a>
<a name="ln343">  dt_lib_module_t *self = (dt_lib_module_t *)user_data;</a>
<a name="ln344">  dt_lib_copy_history_t *d = (dt_lib_copy_history_t *)self-&gt;data;</a>
<a name="ln345"> </a>
<a name="ln346">  // launch dialog to select the ops to paste</a>
<a name="ln347">  if(dt_gui_hist_dialog_new(&amp;(d-&gt;dg), d-&gt;dg.copied_imageid, FALSE) == GTK_RESPONSE_OK)</a>
<a name="ln348">    paste_button_clicked(widget, user_data);</a>
<a name="ln349">}</a>
<a name="ln350"> </a>
<a name="ln351">static void pastemode_combobox_changed(GtkWidget *widget, gpointer user_data)</a>
<a name="ln352">{</a>
<a name="ln353">  int mode = dt_bauhaus_combobox_get(widget);</a>
<a name="ln354">  dt_conf_set_int(&quot;plugins/lighttable/copy_history/pastemode&quot;, mode);</a>
<a name="ln355">}</a>
<a name="ln356"> </a>
<a name="ln357">void gui_reset(dt_lib_module_t *self)</a>
<a name="ln358">{</a>
<a name="ln359">  dt_lib_copy_history_t *d = (dt_lib_copy_history_t *)self-&gt;data;</a>
<a name="ln360">  d-&gt;imageid = -1;</a>
<a name="ln361">  gtk_widget_set_sensitive(GTK_WIDGET(d-&gt;paste), FALSE);</a>
<a name="ln362">}</a>
<a name="ln363"> </a>
<a name="ln364">int position()</a>
<a name="ln365">{</a>
<a name="ln366">  return 600;</a>
<a name="ln367">}</a>
<a name="ln368"> </a>
<a name="ln369">#define ellipsize_button(button) gtk_label_set_ellipsize(GTK_LABEL(gtk_bin_get_child(GTK_BIN(button))), PANGO_ELLIPSIZE_END);</a>
<a name="ln370">void gui_init(dt_lib_module_t *self)</a>
<a name="ln371">{</a>
<a name="ln372">  dt_lib_copy_history_t *d = (dt_lib_copy_history_t *)malloc(sizeof(dt_lib_copy_history_t));</a>
<a name="ln373">  self-&gt;data = (void *)d;</a>
<a name="ln374">  self-&gt;widget = gtk_grid_new();</a>
<a name="ln375">  GtkGrid *grid = GTK_GRID(self-&gt;widget);</a>
<a name="ln376">  dt_gui_add_help_link(self-&gt;widget, dt_get_help_url(self-&gt;plugin_name));</a>
<a name="ln377">  gtk_grid_set_column_homogeneous(grid, TRUE);</a>
<a name="ln378">  int line = 0;</a>
<a name="ln379">  d-&gt;imageid = -1;</a>
<a name="ln380">  dt_gui_hist_dialog_init(&amp;d-&gt;dg);</a>
<a name="ln381"> </a>
<a name="ln382"> </a>
<a name="ln383">  GtkWidget *copy_parts = gtk_button_new_with_label(_(&quot;copy&quot;));</a>
<a name="ln384">  ellipsize_button(copy_parts);</a>
<a name="ln385">  d-&gt;copy_parts_button = copy_parts;</a>
<a name="ln386">  gtk_widget_set_tooltip_text(copy_parts, _(&quot;copy part history stack of\nfirst selected image&quot;));</a>
<a name="ln387">  dt_gui_add_help_link(copy_parts, &quot;history_stack.html#history_stack_usage&quot;);</a>
<a name="ln388">  gtk_grid_attach(grid, copy_parts, 0, line, 3, 1);</a>
<a name="ln389"> </a>
<a name="ln390">  GtkWidget *copy = gtk_button_new_with_label(_(&quot;copy all&quot;));</a>
<a name="ln391">  ellipsize_button(copy);</a>
<a name="ln392">  d-&gt;copy_button = copy;</a>
<a name="ln393">  gtk_widget_set_tooltip_text(copy, _(&quot;copy history stack of\nfirst selected image&quot;));</a>
<a name="ln394">  dt_gui_add_help_link(copy, &quot;history_stack.html#history_stack_usage&quot;);</a>
<a name="ln395">  gtk_grid_attach(grid, copy, 3, line++, 3, 1);</a>
<a name="ln396"> </a>
<a name="ln397"> </a>
<a name="ln398">  d-&gt;paste_parts = GTK_BUTTON(gtk_button_new_with_label(_(&quot;paste&quot;)));</a>
<a name="ln399">  ellipsize_button(d-&gt;paste_parts);</a>
<a name="ln400">  gtk_widget_set_tooltip_text(GTK_WIDGET(d-&gt;paste_parts), _(&quot;paste part history stack to\nall selected images&quot;));</a>
<a name="ln401">  dt_gui_add_help_link(GTK_WIDGET(d-&gt;paste_parts), &quot;history_stack.html#history_stack_usage&quot;);</a>
<a name="ln402">  gtk_widget_set_sensitive(GTK_WIDGET(d-&gt;paste_parts), FALSE);</a>
<a name="ln403">  gtk_grid_attach(grid, GTK_WIDGET(d-&gt;paste_parts), 0, line, 3, 1);</a>
<a name="ln404"> </a>
<a name="ln405">  d-&gt;paste = GTK_BUTTON(gtk_button_new_with_label(_(&quot;paste all&quot;)));</a>
<a name="ln406">  ellipsize_button(d-&gt;paste);</a>
<a name="ln407">  gtk_widget_set_tooltip_text(GTK_WIDGET(d-&gt;paste), _(&quot;paste history stack to\nall selected images&quot;));</a>
<a name="ln408">  dt_gui_add_help_link(GTK_WIDGET(d-&gt;paste), &quot;history_stack.html#history_stack_usage&quot;);</a>
<a name="ln409">  gtk_widget_set_sensitive(GTK_WIDGET(d-&gt;paste), FALSE);</a>
<a name="ln410">  gtk_grid_attach(grid, GTK_WIDGET(d-&gt;paste), 3, line++, 3, 1);</a>
<a name="ln411"> </a>
<a name="ln412">  d-&gt;compress_button = GTK_BUTTON(gtk_button_new_with_label(_(&quot;compress history&quot;)));</a>
<a name="ln413">  ellipsize_button(d-&gt;compress_button);</a>
<a name="ln414">  gtk_widget_set_tooltip_text(GTK_WIDGET(d-&gt;compress_button), _(&quot;compress history stack of\nall selected images&quot;));</a>
<a name="ln415">  gtk_grid_attach(grid, GTK_WIDGET(d-&gt;compress_button), 0, line, 3, 1);</a>
<a name="ln416"> </a>
<a name="ln417">  GtkWidget *delete = gtk_button_new_with_label(_(&quot;discard history&quot;));</a>
<a name="ln418">  ellipsize_button(delete);</a>
<a name="ln419">  d-&gt;delete_button = delete;</a>
<a name="ln420">  gtk_widget_set_tooltip_text(delete, _(&quot;discard history stack of\nall selected images&quot;));</a>
<a name="ln421">  dt_gui_add_help_link(delete, &quot;history_stack.html#history_stack_usage&quot;);</a>
<a name="ln422">  gtk_grid_attach(grid, delete, 3, line++, 3, 1);</a>
<a name="ln423"> </a>
<a name="ln424">  d-&gt;pastemode = dt_bauhaus_combobox_new(NULL);</a>
<a name="ln425">  dt_bauhaus_widget_set_label(d-&gt;pastemode, NULL, _(&quot;mode&quot;));</a>
<a name="ln426">  dt_bauhaus_combobox_add(d-&gt;pastemode, _(&quot;append&quot;));</a>
<a name="ln427">  dt_bauhaus_combobox_add(d-&gt;pastemode, _(&quot;overwrite&quot;));</a>
<a name="ln428">  gtk_widget_set_tooltip_text(d-&gt;pastemode, _(&quot;how to handle existing history&quot;));</a>
<a name="ln429">  dt_gui_add_help_link(d-&gt;pastemode, &quot;history_stack.html#history_stack_usage&quot;);</a>
<a name="ln430">  gtk_grid_attach(grid, d-&gt;pastemode, 0, line++, 6, 1);</a>
<a name="ln431">  dt_bauhaus_combobox_set(d-&gt;pastemode, dt_conf_get_int(&quot;plugins/lighttable/copy_history/pastemode&quot;));</a>
<a name="ln432"> </a>
<a name="ln433"> </a>
<a name="ln434">  GtkWidget *loadbutton = gtk_button_new_with_label(_(&quot;load sidecar file&quot;));</a>
<a name="ln435">  ellipsize_button(loadbutton);</a>
<a name="ln436">  d-&gt;load_button = loadbutton;</a>
<a name="ln437">  gtk_widget_set_tooltip_text(loadbutton, _(&quot;open an XMP sidecar file\nand apply it to selected images&quot;));</a>
<a name="ln438">  dt_gui_add_help_link(loadbutton, &quot;history_stack.html#history_stack_usage&quot;);</a>
<a name="ln439">  gtk_grid_attach(grid, loadbutton, 0, line, 3, 1);</a>
<a name="ln440"> </a>
<a name="ln441">  GtkWidget *button = gtk_button_new_with_label(_(&quot;write sidecar files&quot;));</a>
<a name="ln442">  ellipsize_button(button);</a>
<a name="ln443">  d-&gt;write_button = button;</a>
<a name="ln444">  gtk_widget_set_tooltip_text(button, _(&quot;write history stack and tags to XMP sidecar files&quot;));</a>
<a name="ln445">  dt_gui_add_help_link(button, &quot;history_stack.html#history_stack_usage&quot;);</a>
<a name="ln446">  gtk_grid_attach(grid, button, 3, line, 3, 1);</a>
<a name="ln447">  g_signal_connect(G_OBJECT(button), &quot;clicked&quot;, G_CALLBACK(write_button_clicked), (gpointer)self);</a>
<a name="ln448"> </a>
<a name="ln449"> </a>
<a name="ln450">  g_signal_connect(G_OBJECT(copy), &quot;clicked&quot;, G_CALLBACK(copy_button_clicked), (gpointer)self);</a>
<a name="ln451">  g_signal_connect(G_OBJECT(copy_parts), &quot;clicked&quot;, G_CALLBACK(copy_parts_button_clicked), (gpointer)self);</a>
<a name="ln452">  g_signal_connect(G_OBJECT(d-&gt;compress_button), &quot;clicked&quot;, G_CALLBACK(compress_button_clicked), (gpointer)self);</a>
<a name="ln453">  g_signal_connect(G_OBJECT(delete), &quot;clicked&quot;, G_CALLBACK(delete_button_clicked), (gpointer)self);</a>
<a name="ln454">  g_signal_connect(G_OBJECT(d-&gt;paste_parts), &quot;clicked&quot;, G_CALLBACK(paste_parts_button_clicked), (gpointer)self);</a>
<a name="ln455">  g_signal_connect(G_OBJECT(d-&gt;paste), &quot;clicked&quot;, G_CALLBACK(paste_button_clicked), (gpointer)self);</a>
<a name="ln456">  g_signal_connect(G_OBJECT(loadbutton), &quot;clicked&quot;, G_CALLBACK(load_button_clicked), (gpointer)self);</a>
<a name="ln457">  g_signal_connect(G_OBJECT(d-&gt;pastemode), &quot;value-changed&quot;, G_CALLBACK(pastemode_combobox_changed), (gpointer)self);</a>
<a name="ln458">}</a>
<a name="ln459">#undef ellipsize_button</a>
<a name="ln460"> </a>
<a name="ln461">void gui_cleanup(dt_lib_module_t *self)</a>
<a name="ln462">{</a>
<a name="ln463">  free(self-&gt;data);</a>
<a name="ln464">  self-&gt;data = NULL;</a>
<a name="ln465">}</a>
<a name="ln466"> </a>
<a name="ln467">void init_key_accels(dt_lib_module_t *self)</a>
<a name="ln468">{</a>
<a name="ln469">  dt_accel_register_lib(self, NC_(&quot;accel&quot;, &quot;copy all&quot;), GDK_KEY_c, GDK_CONTROL_MASK);</a>
<a name="ln470">  dt_accel_register_lib(self, NC_(&quot;accel&quot;, &quot;copy&quot;), GDK_KEY_c, GDK_CONTROL_MASK | GDK_SHIFT_MASK);</a>
<a name="ln471">  dt_accel_register_lib(self, NC_(&quot;accel&quot;, &quot;compress history&quot;), 0, 0);</a>
<a name="ln472">  dt_accel_register_lib(self, NC_(&quot;accel&quot;, &quot;discard history&quot;), 0, 0);</a>
<a name="ln473">  dt_accel_register_lib(self, NC_(&quot;accel&quot;, &quot;paste all&quot;), GDK_KEY_v, GDK_CONTROL_MASK);</a>
<a name="ln474">  dt_accel_register_lib(self, NC_(&quot;accel&quot;, &quot;paste&quot;), GDK_KEY_v, GDK_CONTROL_MASK | GDK_SHIFT_MASK);</a>
<a name="ln475">  dt_accel_register_lib(self, NC_(&quot;accel&quot;, &quot;load sidecar files&quot;), 0, 0);</a>
<a name="ln476">  dt_accel_register_lib(self, NC_(&quot;accel&quot;, &quot;write sidecar files&quot;), 0, 0);</a>
<a name="ln477">}</a>
<a name="ln478"> </a>
<a name="ln479">void connect_key_accels(dt_lib_module_t *self)</a>
<a name="ln480">{</a>
<a name="ln481">  dt_lib_copy_history_t *d = (dt_lib_copy_history_t *)self-&gt;data;</a>
<a name="ln482"> </a>
<a name="ln483">  dt_accel_connect_button_lib(self, &quot;copy all&quot;, GTK_WIDGET(d-&gt;copy_button));</a>
<a name="ln484">  dt_accel_connect_button_lib(self, &quot;copy&quot;, GTK_WIDGET(d-&gt;copy_parts_button));</a>
<a name="ln485">  dt_accel_connect_button_lib(self, &quot;discard&quot;, GTK_WIDGET(d-&gt;delete_button));</a>
<a name="ln486">  dt_accel_connect_button_lib(self, &quot;compress&quot;, GTK_WIDGET(d-&gt;compress_button));</a>
<a name="ln487">  dt_accel_connect_button_lib(self, &quot;paste all&quot;, GTK_WIDGET(d-&gt;paste));</a>
<a name="ln488">  dt_accel_connect_button_lib(self, &quot;paste&quot;, GTK_WIDGET(d-&gt;paste_parts));</a>
<a name="ln489">  dt_accel_connect_button_lib(self, &quot;load sidecar files&quot;, GTK_WIDGET(d-&gt;load_button));</a>
<a name="ln490">  dt_accel_connect_button_lib(self, &quot;write sidecar files&quot;, GTK_WIDGET(d-&gt;write_button));</a>
<a name="ln491">}</a>
<a name="ln492">// modelines: These editor modelines have been set for all relevant files by tools/update_modelines.sh</a>
<a name="ln493">// vim: shiftwidth=2 expandtab tabstop=2 cindent</a>
<a name="ln494">// kate: tab-indents: off; indent-width 2; replace-tabs on; indent-mode cstyle; remove-trailing-spaces modified;</a>

</code></pre>
<div class="balloon" rel="379"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v522/" target="_blank">V522</a> There might be dereferencing of a potential null pointer 'd'. Check lines: 379, 372.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
