
<html>
<head>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>
<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2"> *    This file is part of darktable,</a>
<a name="ln3"> *    copyright (c) 2012-2015 tobias ellinghaus.</a>
<a name="ln4"> *</a>
<a name="ln5"> *    darktable is free software: you can redistribute it and/or modify</a>
<a name="ln6"> *    it under the terms of the GNU General Public License as published by</a>
<a name="ln7"> *    the Free Software Foundation, either version 3 of the License, or</a>
<a name="ln8"> *    (at your option) any later version.</a>
<a name="ln9"> *</a>
<a name="ln10"> *    darktable is distributed in the hope that it will be useful,</a>
<a name="ln11"> *    but WITHOUT ANY WARRANTY; without even the implied warranty of</a>
<a name="ln12"> *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</a>
<a name="ln13"> *    GNU General Public License for more details.</a>
<a name="ln14"> *</a>
<a name="ln15"> *    You should have received a copy of the GNU General Public License</a>
<a name="ln16"> *    along with darktable.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</a>
<a name="ln17"> */</a>
<a name="ln18"> </a>
<a name="ln19">#include &lt;glib.h&gt;</a>
<a name="ln20"> </a>
<a name="ln21">#include &quot;bauhaus/bauhaus.h&quot;</a>
<a name="ln22">#include &quot;common/darktable.h&quot;</a>
<a name="ln23">#include &quot;gui/guides.h&quot;</a>
<a name="ln24"> </a>
<a name="ln25">typedef struct dt_QRect_t</a>
<a name="ln26">{</a>
<a name="ln27">  float left, top, right, bottom, width, height;</a>
<a name="ln28">} dt_QRect_t;</a>
<a name="ln29"> </a>
<a name="ln30">static void dt_guides_q_rect(dt_QRect_t *R1, float left, float top, float width, float height)</a>
<a name="ln31">{</a>
<a name="ln32">  R1-&gt;left = left;</a>
<a name="ln33">  R1-&gt;top = top;</a>
<a name="ln34">  R1-&gt;right = left + width;</a>
<a name="ln35">  R1-&gt;bottom = top + height;</a>
<a name="ln36">  R1-&gt;width = width;</a>
<a name="ln37">  R1-&gt;height = height;</a>
<a name="ln38">}</a>
<a name="ln39"> </a>
<a name="ln40"> </a>
<a name="ln41">static void dt_guides_draw_simple_grid(cairo_t *cr, const float x, const float y, const float w,</a>
<a name="ln42">                                       const float h, float zoom_scale)</a>
<a name="ln43">{</a>
<a name="ln44">  float right = x + w;</a>
<a name="ln45">  float bottom = y + h;</a>
<a name="ln46">  // cairo_set_operator(cr, CAIRO_OPERATOR_XOR);</a>
<a name="ln47">  cairo_set_line_width(cr, 1.0 / zoom_scale);</a>
<a name="ln48">  cairo_set_source_rgb(cr, .2, .2, .2);</a>
<a name="ln49">  dt_draw_grid(cr, 3, x, y, right, bottom);</a>
<a name="ln50">  cairo_translate(cr, 1.0 / zoom_scale, 1.0 / zoom_scale);</a>
<a name="ln51">  cairo_set_source_rgb(cr, .8, .8, .8);</a>
<a name="ln52">  dt_draw_grid(cr, 3, x, y, right, bottom);</a>
<a name="ln53">  cairo_set_source_rgba(cr, .8, .8, .8, 0.5);</a>
<a name="ln54">  double dashes = 5.0 / zoom_scale;</a>
<a name="ln55">  cairo_set_dash(cr, &amp;dashes, 1, 0);</a>
<a name="ln56">  dt_draw_grid(cr, 9, x, y, right, bottom);</a>
<a name="ln57">}</a>
<a name="ln58"> </a>
<a name="ln59"> </a>
<a name="ln60">static void dt_guides_draw_diagonal_method(cairo_t *cr, const float x, const float y, const float w, const float h)</a>
<a name="ln61">{</a>
<a name="ln62">  if(w &gt; h)</a>
<a name="ln63">  {</a>
<a name="ln64">    dt_draw_line(cr, x, y, x + h, y + h);</a>
<a name="ln65">    dt_draw_line(cr, x, y + h, x + h, y);</a>
<a name="ln66">    dt_draw_line(cr, x + w - h, y, x + w, y + h);</a>
<a name="ln67">    dt_draw_line(cr, x + w - h, y + h, x + w, y);</a>
<a name="ln68">  }</a>
<a name="ln69">  else</a>
<a name="ln70">  {</a>
<a name="ln71">    dt_draw_line(cr, x, y, x + w, y + w);</a>
<a name="ln72">    dt_draw_line(cr, x, y + w, x + w, y);</a>
<a name="ln73">    dt_draw_line(cr, x, y + h - w, x + w, y + h);</a>
<a name="ln74">    dt_draw_line(cr, x, y + h, x + w, y + h - w);</a>
<a name="ln75">  }</a>
<a name="ln76">}</a>
<a name="ln77"> </a>
<a name="ln78"> </a>
<a name="ln79">static void dt_guides_draw_rules_of_thirds(cairo_t *cr, const float left, const float top,</a>
<a name="ln80">                                           const float width, const float height)</a>
<a name="ln81">{</a>
<a name="ln82">  const float right = left + width, bottom = top + height;</a>
<a name="ln83">  const float x_3 = width / 3.0, y_3 = height / 3.0;</a>
<a name="ln84"> </a>
<a name="ln85">  dt_draw_line(cr, left + x_3, top, left + x_3, bottom);</a>
<a name="ln86">  dt_draw_line(cr, left + 2 * x_3, top, left + 2 * x_3, bottom);</a>
<a name="ln87"> </a>
<a name="ln88">  dt_draw_line(cr, left, top + y_3, right, top + y_3);</a>
<a name="ln89">  dt_draw_line(cr, left, top + 2 * y_3, right, top + 2 * y_3);</a>
<a name="ln90">}</a>
<a name="ln91"> </a>
<a name="ln92"> </a>
<a name="ln93">static void dt_guides_draw_harmonious_triangles(cairo_t *cr, const float left, const float top, const float width,</a>
<a name="ln94">                                                const float height/*, const float dst*/)</a>
<a name="ln95">{</a>
<a name="ln96">  int dst = (int)((height * cos(atan(width / height)) / (cos(atan(height / width)))));</a>
<a name="ln97"> </a>
<a name="ln98">  dt_draw_line(cr, -width / 2, -height / 2, width / 2, height / 2);</a>
<a name="ln99">  dt_draw_line(cr, -width / 2 + dst, -height / 2, -width / 2, height / 2);</a>
<a name="ln100">  dt_draw_line(cr, width / 2, -height / 2, width / 2 - dst, height / 2);</a>
<a name="ln101">}</a>
<a name="ln102"> </a>
<a name="ln103"> </a>
<a name="ln104">#define PERSPECTIVE_LINES 16</a>
<a name="ln105">static void dt_guides_draw_perspective(cairo_t *cr, const float x, const float y, const float w, const float h)</a>
<a name="ln106">{</a>
<a name="ln107">  const float rotation_step = 2.0 / PERSPECTIVE_LINES,</a>
<a name="ln108">              line_length = w * w + h * h; // no need for sqrt or *0.25, this is inside a cairo_clip anyway</a>
<a name="ln109"> </a>
<a name="ln110">  cairo_save(cr);</a>
<a name="ln111">  for(int i = 0; i &lt; PERSPECTIVE_LINES; i++)</a>
<a name="ln112">  {</a>
<a name="ln113">    cairo_save(cr);</a>
<a name="ln114">    cairo_rotate(cr, -M_PI * rotation_step * i);</a>
<a name="ln115">    dt_draw_line(cr, 0, 0, line_length, 0);</a>
<a name="ln116">    cairo_restore(cr);</a>
<a name="ln117">  }</a>
<a name="ln118">  cairo_restore(cr);</a>
<a name="ln119">}</a>
<a name="ln120">#undef PERSPECTIVE_LINES</a>
<a name="ln121"> </a>
<a name="ln122"> </a>
<a name="ln123">#define X_LINES 49</a>
<a name="ln124">#define Y_LINES 33</a>
<a name="ln125">#define CROSSES 6</a>
<a name="ln126">static void dt_guides_draw_metering(cairo_t *cr, const float x, const float y, const float w, const float h)</a>
<a name="ln127">{</a>
<a name="ln128">  const float x_step = w / (X_LINES - 1), y_step = h / (Y_LINES - 1), length_short = MIN(w, h) * 0.02,</a>
<a name="ln129">              length_middle = length_short * 1.5,</a>
<a name="ln130">              length_long = length_middle * 1.5; // these are effectively * 2!</a>
<a name="ln131"> </a>
<a name="ln132">  cairo_save(cr);</a>
<a name="ln133">  cairo_translate(cr, x, y);</a>
<a name="ln134"> </a>
<a name="ln135">  // along x axis</a>
<a name="ln136">  cairo_save(cr);</a>
<a name="ln137">  cairo_translate(cr, 0, h * 0.5);</a>
<a name="ln138">  for(int i = 0; i &lt; X_LINES; i++)</a>
<a name="ln139">    if(i % 4 != 0)</a>
<a name="ln140">      dt_draw_line(cr, i * x_step, -length_short, i * x_step, length_short); // short lines</a>
<a name="ln141">    else if(i % 12 != 0)</a>
<a name="ln142">      dt_draw_line(cr, i * x_step, -length_middle, i * x_step, length_middle); // medium lines</a>
<a name="ln143">    else if(i != X_LINES / 2)</a>
<a name="ln144">      dt_draw_line(cr, i * x_step, -length_long, i * x_step, length_long); // long lines</a>
<a name="ln145">    else</a>
<a name="ln146">      dt_draw_line(cr, i * x_step, -h * 0.5, i * x_step, h * 0.5); // middle line</a>
<a name="ln147">  cairo_restore(cr);</a>
<a name="ln148"> </a>
<a name="ln149">  // along y axis</a>
<a name="ln150">  cairo_save(cr);</a>
<a name="ln151">  cairo_translate(cr, w * 0.5, 0);</a>
<a name="ln152">  for(int i = 0; i &lt; Y_LINES; i++)</a>
<a name="ln153">    if((i - 4) % 4 != 0)</a>
<a name="ln154">      dt_draw_line(cr, -length_short, i * y_step, length_short, i * y_step); // short lines</a>
<a name="ln155">    else if(i == Y_LINES / 2)</a>
<a name="ln156">      dt_draw_line(cr, -w * 0.5, i * y_step, w * 0.5, i * y_step); // middle line</a>
<a name="ln157">    else if((i - 4) % 12 != 0)</a>
<a name="ln158">      dt_draw_line(cr, -length_middle, i * y_step, length_middle, i * y_step); // medium lines</a>
<a name="ln159">    else</a>
<a name="ln160">      dt_draw_line(cr, -length_long, i * y_step, length_long, i * y_step); // long lines</a>
<a name="ln161">  cairo_restore(cr);</a>
<a name="ln162"> </a>
<a name="ln163">  // small crosses</a>
<a name="ln164">  const float length_cross = length_short * .5, cross_x_step = w / CROSSES, cross_y_step = h / CROSSES;</a>
<a name="ln165">  for(int cx = 1; cx &lt; CROSSES; cx++)</a>
<a name="ln166">    for(int cy = 1; cy &lt; CROSSES; cy++)</a>
<a name="ln167">      if(cx != CROSSES / 2 &amp;&amp; cy != CROSSES / 2)</a>
<a name="ln168">      {</a>
<a name="ln169">        float _x = cx * cross_x_step, _y = cy * cross_y_step;</a>
<a name="ln170">        dt_draw_line(cr, _x - length_cross, _y, _x + length_cross, _y);</a>
<a name="ln171">        dt_draw_line(cr, _x, _y - length_cross, _x, _y + length_cross);</a>
<a name="ln172">      }</a>
<a name="ln173">  cairo_restore(cr);</a>
<a name="ln174">}</a>
<a name="ln175">#undef X_LINES</a>
<a name="ln176">#undef y_LINES</a>
<a name="ln177">#undef CROSSES</a>
<a name="ln178"> </a>
<a name="ln179">#define RADIANS(degrees) ((degrees) * (M_PI / 180.))</a>
<a name="ln180">static void dt_guides_draw_golden_mean(cairo_t *cr, dt_QRect_t *R1, dt_QRect_t *R2, dt_QRect_t *R3, dt_QRect_t *R4,</a>
<a name="ln181">                                       dt_QRect_t *R5, dt_QRect_t *R6, dt_QRect_t *R7, gboolean goldenSection,</a>
<a name="ln182">                                       gboolean goldenTriangle, gboolean goldenSpiralSection, gboolean goldenSpiral)</a>
<a name="ln183">{</a>
<a name="ln184">  // Drawing Golden sections.</a>
<a name="ln185">  if(goldenSection)</a>
<a name="ln186">  {</a>
<a name="ln187">    // horizontal lines:</a>
<a name="ln188">    dt_draw_line(cr, R1-&gt;left, R2-&gt;top, R2-&gt;right, R2-&gt;top);</a>
<a name="ln189">    dt_draw_line(cr, R1-&gt;left, R1-&gt;top + R2-&gt;height, R2-&gt;right, R1-&gt;top + R2-&gt;height);</a>
<a name="ln190"> </a>
<a name="ln191">    // vertical lines:</a>
<a name="ln192">    dt_draw_line(cr, R1-&gt;right, R1-&gt;top, R1-&gt;right, R1-&gt;bottom);</a>
<a name="ln193">    dt_draw_line(cr, R1-&gt;left + R2-&gt;width, R1-&gt;top, R1-&gt;left + R2-&gt;width, R1-&gt;bottom);</a>
<a name="ln194">  }</a>
<a name="ln195"> </a>
<a name="ln196">  // Drawing Golden triangle guides.</a>
<a name="ln197">  if(goldenTriangle)</a>
<a name="ln198">  {</a>
<a name="ln199">    dt_draw_line(cr, R1-&gt;left, R1-&gt;bottom, R2-&gt;right, R1-&gt;top);</a>
<a name="ln200">    dt_draw_line(cr, R1-&gt;left, R1-&gt;top, R2-&gt;right - R1-&gt;width, R1-&gt;bottom);</a>
<a name="ln201">    dt_draw_line(cr, R1-&gt;left + R1-&gt;width, R1-&gt;top, R2-&gt;right, R1-&gt;bottom);</a>
<a name="ln202">  }</a>
<a name="ln203"> </a>
<a name="ln204">  // Drawing Golden spiral sections.</a>
<a name="ln205">  if(goldenSpiralSection)</a>
<a name="ln206">  {</a>
<a name="ln207">    dt_draw_line(cr, R1-&gt;right, R1-&gt;top, R1-&gt;right, R1-&gt;bottom);</a>
<a name="ln208">    dt_draw_line(cr, R2-&gt;left, R2-&gt;top, R2-&gt;right, R2-&gt;top);</a>
<a name="ln209">    dt_draw_line(cr, R3-&gt;left, R3-&gt;top, R3-&gt;left, R3-&gt;bottom);</a>
<a name="ln210">    dt_draw_line(cr, R4-&gt;left, R4-&gt;bottom, R4-&gt;right, R4-&gt;bottom);</a>
<a name="ln211">    dt_draw_line(cr, R5-&gt;right, R5-&gt;top, R5-&gt;right, R5-&gt;bottom);</a>
<a name="ln212">    dt_draw_line(cr, R6-&gt;left, R6-&gt;top, R6-&gt;right, R6-&gt;top);</a>
<a name="ln213">    dt_draw_line(cr, R7-&gt;left, R7-&gt;top, R7-&gt;left, R7-&gt;bottom);</a>
<a name="ln214">  }</a>
<a name="ln215"> </a>
<a name="ln216">  // Drawing Golden Spiral.</a>
<a name="ln217">  if(goldenSpiral)</a>
<a name="ln218">  {</a>
<a name="ln219">    cairo_save(cr);</a>
<a name="ln220">    cairo_new_sub_path(cr);</a>
<a name="ln221">    cairo_scale(cr, R1-&gt;width / R1-&gt;height, 1);</a>
<a name="ln222">    cairo_arc(cr, R1-&gt;right / R1-&gt;width * R1-&gt;height, R1-&gt;top, R1-&gt;height, RADIANS(90), RADIANS(180));</a>
<a name="ln223">    cairo_restore(cr);</a>
<a name="ln224"> </a>
<a name="ln225">    cairo_save(cr);</a>
<a name="ln226">    cairo_new_sub_path(cr);</a>
<a name="ln227">    cairo_scale(cr, R2-&gt;width / R2-&gt;height, 1);</a>
<a name="ln228">    cairo_arc(cr, R2-&gt;left / R2-&gt;width * R2-&gt;height, R2-&gt;top, R2-&gt;height, RADIANS(0), RADIANS(90));</a>
<a name="ln229">    cairo_restore(cr);</a>
<a name="ln230"> </a>
<a name="ln231">    cairo_save(cr);</a>
<a name="ln232">    cairo_new_sub_path(cr);</a>
<a name="ln233">    cairo_scale(cr, R3-&gt;width / R3-&gt;height, 1);</a>
<a name="ln234">    cairo_arc(cr, R3-&gt;left / R3-&gt;width * R3-&gt;height, R3-&gt;bottom, R3-&gt;height, RADIANS(270), RADIANS(360));</a>
<a name="ln235">    cairo_restore(cr);</a>
<a name="ln236"> </a>
<a name="ln237">    cairo_save(cr);</a>
<a name="ln238">    cairo_new_sub_path(cr);</a>
<a name="ln239">    cairo_scale(cr, 1, R4-&gt;height / R4-&gt;width);</a>
<a name="ln240">    cairo_arc(cr, R4-&gt;right, R4-&gt;bottom / R4-&gt;height * R4-&gt;width, R4-&gt;width, RADIANS(180), RADIANS(270));</a>
<a name="ln241">    cairo_restore(cr);</a>
<a name="ln242"> </a>
<a name="ln243">    cairo_save(cr);</a>
<a name="ln244">    cairo_new_sub_path(cr);</a>
<a name="ln245">    cairo_scale(cr, 1, R5-&gt;height / R5-&gt;width);</a>
<a name="ln246">    cairo_arc(cr, R5-&gt;right, R5-&gt;top / R5-&gt;height * R5-&gt;width, R5-&gt;width, RADIANS(90), RADIANS(180));</a>
<a name="ln247">    cairo_restore(cr);</a>
<a name="ln248"> </a>
<a name="ln249">    cairo_save(cr);</a>
<a name="ln250">    cairo_new_sub_path(cr);</a>
<a name="ln251">    cairo_scale(cr, 1, R6-&gt;height / R6-&gt;width);</a>
<a name="ln252">    cairo_arc(cr, R6-&gt;left, R6-&gt;top / R6-&gt;height * R6-&gt;width, R6-&gt;width, RADIANS(0), RADIANS(90));</a>
<a name="ln253">    cairo_restore(cr);</a>
<a name="ln254"> </a>
<a name="ln255">    cairo_save(cr);</a>
<a name="ln256">    cairo_new_sub_path(cr);</a>
<a name="ln257">    cairo_scale(cr, R7-&gt;width / R7-&gt;height, 1);</a>
<a name="ln258">    cairo_arc(cr, R7-&gt;left / R7-&gt;width * R7-&gt;height, R7-&gt;bottom, R7-&gt;height, RADIANS(270), RADIANS(360));</a>
<a name="ln259">    cairo_restore(cr);</a>
<a name="ln260"> </a>
<a name="ln261">    cairo_save(cr);</a>
<a name="ln262">    cairo_new_sub_path(cr);</a>
<a name="ln263">    cairo_scale(cr, (R6-&gt;width - R7-&gt;width) / R7-&gt;height, 1);</a>
<a name="ln264">    cairo_arc(cr, R7-&gt;left / (R6-&gt;width - R7-&gt;width) * R7-&gt;height, R7-&gt;bottom, R7-&gt;height, RADIANS(210),</a>
<a name="ln265">              RADIANS(270));</a>
<a name="ln266">    cairo_restore(cr);</a>
<a name="ln267">  }</a>
<a name="ln268">}</a>
<a name="ln269">#undef RADIANS</a>
<a name="ln270"> </a>
<a name="ln271"> </a>
<a name="ln272">///////// wrappers for the guides system</a>
<a name="ln273"> </a>
<a name="ln274">typedef struct _golden_mean_t</a>
<a name="ln275">{</a>
<a name="ln276">  int which;</a>
<a name="ln277">  gboolean golden_section;</a>
<a name="ln278">  gboolean golden_triangle;</a>
<a name="ln279">  gboolean golden_spiral_section;</a>
<a name="ln280">  gboolean golden_spiral;</a>
<a name="ln281">} _golden_mean_t;</a>
<a name="ln282"> </a>
<a name="ln283">static void _guides_draw_grid(cairo_t *cr, const float x, const float y,</a>
<a name="ln284">                              const float w, const float h,</a>
<a name="ln285">                              const float zoom_scale, void *user_data)</a>
<a name="ln286">{</a>
<a name="ln287">  dt_guides_draw_simple_grid(cr, x, y, w, h, zoom_scale);</a>
<a name="ln288">}</a>
<a name="ln289">static void _guides_draw_rules_of_thirds(cairo_t *cr, const float x, const float y,</a>
<a name="ln290">                                         const float w, const float h,</a>
<a name="ln291">                                         const float zoom_scale, void *user_data)</a>
<a name="ln292">{</a>
<a name="ln293">  dt_guides_draw_rules_of_thirds(cr, x, y, w, h);</a>
<a name="ln294">}</a>
<a name="ln295">static void _guides_draw_metering(cairo_t *cr, const float x, const float y,</a>
<a name="ln296">                                  const float w, const float h,</a>
<a name="ln297">                                  const float zoom_scale, void *user_data)</a>
<a name="ln298">{</a>
<a name="ln299">  dt_guides_draw_metering(cr, x, y, w, h);</a>
<a name="ln300">}</a>
<a name="ln301">static void _guides_draw_perspective(cairo_t *cr, const float x, const float y,</a>
<a name="ln302">                                     const float w, const float h,</a>
<a name="ln303">                                     const float zoom_scale, void *user_data)</a>
<a name="ln304">{</a>
<a name="ln305">  dt_guides_draw_perspective(cr, x, y, w, h);</a>
<a name="ln306">}</a>
<a name="ln307">static void _guides_draw_diagonal_method(cairo_t *cr, const float x, const float y,</a>
<a name="ln308">                                         const float w, const float h,</a>
<a name="ln309">                                         const float zoom_scale, void *user_data)</a>
<a name="ln310">{</a>
<a name="ln311">  dt_guides_draw_diagonal_method(cr, x, y, w, h);</a>
<a name="ln312">}</a>
<a name="ln313">static void _guides_draw_harmonious_triangles(cairo_t *cr, const float x, const float y,</a>
<a name="ln314">                                              const float w, const float h,</a>
<a name="ln315">                                              const float zoom_scale, void *user_data)</a>
<a name="ln316">{</a>
<a name="ln317">  dt_guides_draw_harmonious_triangles(cr, x, y, w, h);</a>
<a name="ln318">}</a>
<a name="ln319">static void _guides_draw_golden_mean(cairo_t *cr, const float x, const float y,</a>
<a name="ln320">                                     const float w, const float h,</a>
<a name="ln321">                                     const float zoom_scale, void *user_data)</a>
<a name="ln322">{</a>
<a name="ln323">  _golden_mean_t *d = (_golden_mean_t *)user_data;</a>
<a name="ln324"> </a>
<a name="ln325">  // lengths for the golden mean and half the sizes of the region:</a>
<a name="ln326">  float w_g = w * INVPHI;</a>
<a name="ln327">  float h_g = h * INVPHI;</a>
<a name="ln328">  float w_2 = w / 2;</a>
<a name="ln329">  float h_2 = h / 2;</a>
<a name="ln330"> </a>
<a name="ln331">  dt_QRect_t R1, R2, R3, R4, R5, R6, R7;</a>
<a name="ln332">  dt_guides_q_rect(&amp;R1, -w_2, -h_2, w_g, h);</a>
<a name="ln333"> </a>
<a name="ln334">  // w - 2*w_2 corrects for one-pixel difference</a>
<a name="ln335">  // so that R2.right() is really at the right end of the region</a>
<a name="ln336">  dt_guides_q_rect(&amp;R2, w_g - w_2, h_2 - h_g, w - w_g + 1 - (w - 2 * w_2), h_g);</a>
<a name="ln337">  dt_guides_q_rect(&amp;R3, w_2 - R2.width * INVPHI, -h_2, R2.width * INVPHI, h - R2.height);</a>
<a name="ln338">  dt_guides_q_rect(&amp;R4, R2.left, R1.top, R3.left - R2.left, R3.height * INVPHI);</a>
<a name="ln339">  dt_guides_q_rect(&amp;R5, R4.left, R4.bottom, R4.width * INVPHI, R3.height - R4.height);</a>
<a name="ln340">  dt_guides_q_rect(&amp;R6, R5.left + R5.width, R5.bottom - R5.height * INVPHI, R3.left - R5.right,</a>
<a name="ln341">                   R5.height * INVPHI);</a>
<a name="ln342">  dt_guides_q_rect(&amp;R7, R6.right - R6.width * INVPHI, R4.bottom, R6.width * INVPHI, R5.height - R6.height);</a>
<a name="ln343"> </a>
<a name="ln344">  dt_guides_draw_golden_mean(cr, &amp;R1, &amp;R2, &amp;R3, &amp;R4, &amp;R5, &amp;R6, &amp;R7, d-&gt;golden_section, d-&gt;golden_triangle,</a>
<a name="ln345">                             d-&gt;golden_spiral_section, d-&gt;golden_spiral);</a>
<a name="ln346">}</a>
<a name="ln347">static inline void _golden_mean_set_data(_golden_mean_t *data, int which)</a>
<a name="ln348">{</a>
<a name="ln349">  data-&gt;which = which;</a>
<a name="ln350">  data-&gt;golden_section = which == 0 || which == 3;</a>
<a name="ln351">  data-&gt;golden_triangle = 0;</a>
<a name="ln352">  data-&gt;golden_spiral_section = which == 1 || which == 3;</a>
<a name="ln353">  data-&gt;golden_spiral = which == 2 || which == 3;</a>
<a name="ln354">}</a>
<a name="ln355">static void _golden_mean_changed(GtkWidget *combo, _golden_mean_t *user_data)</a>
<a name="ln356">{</a>
<a name="ln357">  int which = dt_bauhaus_combobox_get(combo);</a>
<a name="ln358"> </a>
<a name="ln359">  // remember setting</a>
<a name="ln360">  dt_conf_set_int(&quot;plugins/darkroom/clipping/golden_extras&quot;, which);</a>
<a name="ln361"> </a>
<a name="ln362">  _golden_mean_set_data(user_data, which);</a>
<a name="ln363"> </a>
<a name="ln364">  dt_control_queue_redraw_center();</a>
<a name="ln365">}</a>
<a name="ln366">static GtkWidget *_guides_gui_golden_mean(dt_iop_module_t *self, void *user_data)</a>
<a name="ln367">{</a>
<a name="ln368">  _golden_mean_t *data = (_golden_mean_t *)user_data;</a>
<a name="ln369">  GtkWidget *golden_extras = dt_bauhaus_combobox_new(self);</a>
<a name="ln370">  dt_bauhaus_widget_set_label(golden_extras, NULL, _(&quot;extra&quot;));</a>
<a name="ln371">  dt_bauhaus_combobox_add(golden_extras, _(&quot;golden sections&quot;));</a>
<a name="ln372">  dt_bauhaus_combobox_add(golden_extras, _(&quot;golden spiral sections&quot;));</a>
<a name="ln373">  dt_bauhaus_combobox_add(golden_extras, _(&quot;golden spiral&quot;));</a>
<a name="ln374">  dt_bauhaus_combobox_add(golden_extras, _(&quot;all&quot;));</a>
<a name="ln375">  gtk_widget_set_tooltip_text(golden_extras, _(&quot;show some extra guides&quot;));</a>
<a name="ln376">  dt_bauhaus_combobox_set(golden_extras, data-&gt;which);</a>
<a name="ln377">  g_signal_connect(G_OBJECT(golden_extras), &quot;value-changed&quot;, G_CALLBACK(_golden_mean_changed), user_data);</a>
<a name="ln378"> </a>
<a name="ln379">  return golden_extras;</a>
<a name="ln380">}</a>
<a name="ln381"> </a>
<a name="ln382"> </a>
<a name="ln383">static void _guides_add_guide(GList **list, const char *name,</a>
<a name="ln384">                              dt_guides_draw_callback draw,</a>
<a name="ln385">                              dt_guides_widget_callback widget,</a>
<a name="ln386">                              void *user_data, GDestroyNotify free)</a>
<a name="ln387">{</a>
<a name="ln388">  dt_guides_t *guide = (dt_guides_t *)malloc(sizeof(dt_guides_t));</a>
<a name="ln389">  g_strlcpy(guide-&gt;name, name, sizeof(guide-&gt;name));</a>
<a name="ln390">  guide-&gt;draw = draw;</a>
<a name="ln391">  guide-&gt;widget = widget;</a>
<a name="ln392">  guide-&gt;user_data = user_data;</a>
<a name="ln393">  guide-&gt;free = free;</a>
<a name="ln394">  *list = g_list_append(*list, guide);</a>
<a name="ln395">}</a>
<a name="ln396"> </a>
<a name="ln397">void dt_guides_add_guide(const char *name, dt_guides_draw_callback draw, dt_guides_widget_callback widget, void *user_data, GDestroyNotify free)</a>
<a name="ln398">{</a>
<a name="ln399">  _guides_add_guide(&amp;darktable.guides, name, draw, widget, user_data, free);</a>
<a name="ln400">}</a>
<a name="ln401"> </a>
<a name="ln402">GList *dt_guides_init()</a>
<a name="ln403">{</a>
<a name="ln404">  GList *guides = NULL;</a>
<a name="ln405"> </a>
<a name="ln406"> </a>
<a name="ln407">  _guides_add_guide(&amp;guides, _(&quot;grid&quot;), _guides_draw_grid, NULL, NULL, NULL); // TODO: make the number of lines configurable with a slider?</a>
<a name="ln408">  _guides_add_guide(&amp;guides, _(&quot;rules of thirds&quot;), _guides_draw_rules_of_thirds, NULL, NULL, NULL);</a>
<a name="ln409">  _guides_add_guide(&amp;guides, _(&quot;metering&quot;), _guides_draw_metering, NULL, NULL, NULL);</a>
<a name="ln410">  _guides_add_guide(&amp;guides, _(&quot;perspective&quot;), _guides_draw_perspective, NULL, NULL, NULL); // TODO: make the number of lines configurable with a slider?</a>
<a name="ln411">  _guides_add_guide(&amp;guides, _(&quot;diagonal method&quot;), _guides_draw_diagonal_method, NULL, NULL, NULL);</a>
<a name="ln412">  _guides_add_guide(&amp;guides, _(&quot;harmonious triangles&quot;), _guides_draw_harmonious_triangles, NULL, NULL, NULL);</a>
<a name="ln413">  {</a>
<a name="ln414">    _golden_mean_t *user_data = (_golden_mean_t *)malloc(sizeof(_golden_mean_t));</a>
<a name="ln415">    _golden_mean_set_data(user_data, dt_conf_get_int(&quot;plugins/darkroom/clipping/golden_extras&quot;));</a>
<a name="ln416">    _guides_add_guide(&amp;guides, _(&quot;golden mean&quot;), _guides_draw_golden_mean, _guides_gui_golden_mean, user_data, free);</a>
<a name="ln417">  }</a>
<a name="ln418"> </a>
<a name="ln419">  return guides;</a>
<a name="ln420">}</a>
<a name="ln421"> </a>
<a name="ln422">static void free_guide(void *data)</a>
<a name="ln423">{</a>
<a name="ln424">  dt_guides_t *guide = (dt_guides_t *)data;</a>
<a name="ln425">  if(guide-&gt;free) guide-&gt;free(guide-&gt;user_data);</a>
<a name="ln426">  free(guide);</a>
<a name="ln427">}</a>
<a name="ln428"> </a>
<a name="ln429">void dt_guides_cleanup(GList *guides)</a>
<a name="ln430">{</a>
<a name="ln431">  g_list_free_full(guides, free_guide);</a>
<a name="ln432">}</a>
<a name="ln433"> </a>
<a name="ln434">// modelines: These editor modelines have been set for all relevant files by tools/update_modelines.sh</a>
<a name="ln435">// vim: shiftwidth=2 expandtab tabstop=2 cindent</a>
<a name="ln436">// kate: tab-indents: off; indent-width 2; replace-tabs on; indent-mode cstyle; remove-trailing-spaces modified;</a>

</code></pre>
<div class="balloon" rel="96"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v592/" target="_blank">V592</a> The expression was enclosed by parentheses twice: ((expression)). One pair of parentheses is unnecessary or misprint is present.</p></div>
<div class="balloon" rel="389"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v522/" target="_blank">V522</a> There might be dereferencing of a potential null pointer 'guide'. Check lines: 389, 388.</p></div>
<div class="balloon" rel="349"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v522/" target="_blank">V522</a> Dereferencing of the null pointer 'data' might take place. The potential null pointer is passed into '_golden_mean_set_data' function. Inspect the first argument. Check lines: 349, 415, 414.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
