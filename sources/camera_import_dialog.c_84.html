
<html>
<head>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>
<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2">    This file is part of darktable,</a>
<a name="ln3">    copyright (c) 2010--2014 henrik andersson.</a>
<a name="ln4"> </a>
<a name="ln5">    darktable is free software: you can redistribute it and/or modify</a>
<a name="ln6">    it under the terms of the GNU General Public License as published by</a>
<a name="ln7">    the Free Software Foundation, either version 3 of the License, or</a>
<a name="ln8">    (at your option) any later version.</a>
<a name="ln9"> </a>
<a name="ln10">    darktable is distributed in the hope that it will be useful,</a>
<a name="ln11">    but WITHOUT ANY WARRANTY; without even the implied warranty of</a>
<a name="ln12">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</a>
<a name="ln13">    GNU General Public License for more details.</a>
<a name="ln14"> </a>
<a name="ln15">    You should have received a copy of the GNU General Public License</a>
<a name="ln16">    along with darktable.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</a>
<a name="ln17">*/</a>
<a name="ln18"> </a>
<a name="ln19">#include &quot;gui/camera_import_dialog.h&quot;</a>
<a name="ln20">#include &quot;common/camera_control.h&quot;</a>
<a name="ln21">#include &quot;common/darktable.h&quot;</a>
<a name="ln22">#include &quot;common/debug.h&quot;</a>
<a name="ln23">#include &quot;common/exif.h&quot;</a>
<a name="ln24">#include &quot;common/utility.h&quot;</a>
<a name="ln25">#include &quot;common/variables.h&quot;</a>
<a name="ln26">#include &quot;control/conf.h&quot;</a>
<a name="ln27">#include &quot;control/control.h&quot;</a>
<a name="ln28">#include &quot;control/jobs.h&quot;</a>
<a name="ln29">#include &quot;develop/develop.h&quot;</a>
<a name="ln30">#include &quot;dtgtk/button.h&quot;</a>
<a name="ln31">#ifdef GDK_WINDOWING_QUARTZ</a>
<a name="ln32">#include &quot;osx/osx.h&quot;</a>
<a name="ln33">#endif</a>
<a name="ln34"> </a>
<a name="ln35">#include &lt;time.h&gt;</a>
<a name="ln36"> </a>
<a name="ln37">#ifdef _WIN32</a>
<a name="ln38">//MSVCRT does not have strptime implemented</a>
<a name="ln39">#include &quot;win/strptime.h&quot;</a>
<a name="ln40">#endif</a>
<a name="ln41">/*</a>
<a name="ln42"> </a>
<a name="ln43">  g_object_ref(model); // Make sure the model stays with us after the tree view unrefs it</a>
<a name="ln44"> </a>
<a name="ln45">  gtk_tree_view_set_model(GTK_TREE_VIEW(view), NULL); // Detach model from view</a>
<a name="ln46"> </a>
<a name="ln47">  ... insert a couple of thousand rows ...</a>
<a name="ln48"> </a>
<a name="ln49">  gtk_tree_view_set_model(GTK_TREE_VIEW(view), model); // Re-attach model to view</a>
<a name="ln50"> </a>
<a name="ln51">  g_object_unref(model);</a>
<a name="ln52"> </a>
<a name="ln53">*/</a>
<a name="ln54"> </a>
<a name="ln55"> </a>
<a name="ln56">typedef struct _camera_gconf_widget_t</a>
<a name="ln57">{</a>
<a name="ln58">  GtkWidget *widget;</a>
<a name="ln59">  GtkWidget *entry;</a>
<a name="ln60">  gchar *value;</a>
<a name="ln61">  struct _camera_import_dialog_t *dialog;</a>
<a name="ln62">} _camera_gconf_widget_t;</a>
<a name="ln63"> </a>
<a name="ln64">typedef struct _camera_import_dialog_t</a>
<a name="ln65">{</a>
<a name="ln66">  GtkWidget *dialog;</a>
<a name="ln67"> </a>
<a name="ln68">  GtkWidget *notebook;</a>
<a name="ln69"> </a>
<a name="ln70">  struct</a>
<a name="ln71">  {</a>
<a name="ln72">    GtkWidget *page;</a>
<a name="ln73">    _camera_gconf_widget_t *jobname;</a>
<a name="ln74">    GtkWidget *treeview;</a>
<a name="ln75">    GtkWidget *info;</a>
<a name="ln76">  } import;</a>
<a name="ln77"> </a>
<a name="ln78">  struct</a>
<a name="ln79">  {</a>
<a name="ln80">    GtkWidget *page;</a>
<a name="ln81"> </a>
<a name="ln82">    /** Group of general import settings */</a>
<a name="ln83">    struct</a>
<a name="ln84">    {</a>
<a name="ln85">      GtkWidget *ignore_jpeg;</a>
<a name="ln86">      GtkWidget *date_override;</a>
<a name="ln87">      GtkWidget *date_entry;</a>
<a name="ln88">      GtkWidget *apply_metadata;</a>
<a name="ln89">      GtkWidget *presets;</a>
<a name="ln90">      GtkWidget *creator;</a>
<a name="ln91">      GtkWidget *publisher;</a>
<a name="ln92">      GtkWidget *rights;</a>
<a name="ln93">      GtkWidget *tags;</a>
<a name="ln94">    } general;</a>
<a name="ln95"> </a>
<a name="ln96">  } settings;</a>
<a name="ln97"> </a>
<a name="ln98">  GtkListStore *store;</a>
<a name="ln99">  dt_job_t *preview_job;</a>
<a name="ln100">  dt_camera_import_dialog_param_t *params;</a>
<a name="ln101">} _camera_import_dialog_t;</a>
<a name="ln102"> </a>
<a name="ln103">enum</a>
<a name="ln104">{</a>
<a name="ln105">  NAME_COLUMN,</a>
<a name="ln106">  CREATOR_COLUMN,</a>
<a name="ln107">  PUBLISHER_COLUMN,</a>
<a name="ln108">  RIGHTS_COLUMN,</a>
<a name="ln109">  N_COLUMNS</a>
<a name="ln110">};</a>
<a name="ln111"> </a>
<a name="ln112">static void _check_button_callback(GtkWidget *cb, gpointer user_data)</a>
<a name="ln113">{</a>
<a name="ln114"> </a>
<a name="ln115">  _camera_import_dialog_t *cid = (_camera_import_dialog_t *)user_data;</a>
<a name="ln116"> </a>
<a name="ln117">  if(cb == cid-&gt;settings.general.ignore_jpeg)</a>
<a name="ln118">  {</a>
<a name="ln119">    dt_conf_set_bool(&quot;ui_last/import_ignore_jpegs&quot;,</a>
<a name="ln120">                     gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(cid-&gt;settings.general.ignore_jpeg)));</a>
<a name="ln121">  }</a>
<a name="ln122">  else if(cb == cid-&gt;settings.general.date_override)</a>
<a name="ln123">  {</a>
<a name="ln124">    // Enable/disable the date entry widget</a>
<a name="ln125">    gtk_widget_set_sensitive(cid-&gt;settings.general.date_entry, gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(</a>
<a name="ln126">                                                                   cid-&gt;settings.general.date_override)));</a>
<a name="ln127">  }</a>
<a name="ln128">}</a>
<a name="ln129"> </a>
<a name="ln130">static void _camera_import_set_metadata(_camera_import_dialog_t *data)</a>
<a name="ln131">{</a>
<a name="ln132">  dt_conf_set_string(&quot;ui_last/import_last_creator&quot;, gtk_entry_get_text(GTK_ENTRY(data-&gt;settings.general.creator)));</a>
<a name="ln133">  dt_conf_set_string(&quot;ui_last/import_last_publisher&quot;, gtk_entry_get_text(GTK_ENTRY(data-&gt;settings.general.publisher)));</a>
<a name="ln134">  dt_conf_set_string(&quot;ui_last/import_last_rights&quot;, gtk_entry_get_text(GTK_ENTRY(data-&gt;settings.general.rights)));</a>
<a name="ln135">  dt_conf_set_string(&quot;ui_last/import_last_tags&quot;, gtk_entry_get_text(GTK_ENTRY(data-&gt;settings.general.tags)));</a>
<a name="ln136">}</a>
<a name="ln137"> </a>
<a name="ln138">static void _gcw_store_callback(GtkDarktableButton *button, gpointer user_data)</a>
<a name="ln139">{</a>
<a name="ln140">  _camera_gconf_widget_t *gcw = (_camera_gconf_widget_t *)user_data;</a>
<a name="ln141">  gchar *configstring = g_object_get_data(G_OBJECT(gcw-&gt;widget), &quot;gconf:string&quot;);</a>
<a name="ln142">  const gchar *newvalue = gtk_entry_get_text(GTK_ENTRY(gcw-&gt;entry));</a>
<a name="ln143">  if(newvalue &amp;&amp; *newvalue)</a>
<a name="ln144">  {</a>
<a name="ln145">    dt_conf_set_string(configstring, newvalue);</a>
<a name="ln146">    g_free(gcw-&gt;value);</a>
<a name="ln147">    gcw-&gt;value = g_strdup(newvalue);</a>
<a name="ln148">  }</a>
<a name="ln149">}</a>
<a name="ln150"> </a>
<a name="ln151">static void _gcw_reset_callback(GtkDarktableButton *button, gpointer user_data)</a>
<a name="ln152">{</a>
<a name="ln153">  _camera_gconf_widget_t *gcw = (_camera_gconf_widget_t *)user_data;</a>
<a name="ln154">  gchar *configstring = g_object_get_data(G_OBJECT(gcw-&gt;widget), &quot;gconf:string&quot;);</a>
<a name="ln155">  gchar *value = dt_conf_get_string(configstring);</a>
<a name="ln156">  if(value)</a>
<a name="ln157">  {</a>
<a name="ln158">    gtk_entry_set_text(GTK_ENTRY(gcw-&gt;entry), value);</a>
<a name="ln159">    g_free(gcw-&gt;value);</a>
<a name="ln160">    gcw-&gt;value = value;</a>
<a name="ln161">  }</a>
<a name="ln162">}</a>
<a name="ln163"> </a>
<a name="ln164">static void _entry_text_changed(_camera_gconf_widget_t *gcw, GtkEntryBuffer *entrybuffer)</a>
<a name="ln165">{</a>
<a name="ln166">  const gchar *value = gtk_entry_buffer_get_text(entrybuffer);</a>
<a name="ln167">  g_free(gcw-&gt;value);</a>
<a name="ln168">  gcw-&gt;value = g_strdup(value);</a>
<a name="ln169">}</a>
<a name="ln170"> </a>
<a name="ln171">static void entry_dt_callback(GtkEntryBuffer *entrybuffer, guint a1, guint a2, gpointer user_data)</a>
<a name="ln172">{</a>
<a name="ln173">  _entry_text_changed((_camera_gconf_widget_t *)user_data, entrybuffer);</a>
<a name="ln174">}</a>
<a name="ln175"> </a>
<a name="ln176">static void entry_it_callback(GtkEntryBuffer *entrybuffer, guint a1, gchar *a2, guint a3, gpointer user_data)</a>
<a name="ln177">{</a>
<a name="ln178">  _entry_text_changed((_camera_gconf_widget_t *)user_data, entrybuffer);</a>
<a name="ln179">}</a>
<a name="ln180"> </a>
<a name="ln181">static void _camera_import_metadata_changed(GtkWidget *widget, gpointer user_data)</a>
<a name="ln182">{</a>
<a name="ln183">  _camera_import_dialog_t *data = (_camera_import_dialog_t *)user_data;</a>
<a name="ln184">  gtk_combo_box_set_active(GTK_COMBO_BOX(data-&gt;settings.general.presets), -1);</a>
<a name="ln185">  _camera_import_set_metadata(data);</a>
<a name="ln186">}</a>
<a name="ln187"> </a>
<a name="ln188">static void _camera_import_apply_metadata_toggled(GtkWidget *widget, gpointer user_data)</a>
<a name="ln189">{</a>
<a name="ln190">  const gboolean is_active = gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(widget));</a>
<a name="ln191">  GtkWidget *grid = GTK_WIDGET(user_data);</a>
<a name="ln192">  gtk_widget_set_sensitive(grid, is_active);</a>
<a name="ln193">  dt_conf_set_bool(&quot;ui_last/import_apply_metadata&quot;, is_active);</a>
<a name="ln194">}</a>
<a name="ln195"> </a>
<a name="ln196">static void _camera_import_presets_changed(GtkWidget *widget, _camera_import_dialog_t *data)</a>
<a name="ln197">{</a>
<a name="ln198">  GtkTreeIter iter;</a>
<a name="ln199"> </a>
<a name="ln200">  if(gtk_combo_box_get_active_iter(GTK_COMBO_BOX(widget), &amp;iter) == TRUE)</a>
<a name="ln201">  {</a>
<a name="ln202">    GtkTreeModel *model = gtk_combo_box_get_model(GTK_COMBO_BOX(widget));</a>
<a name="ln203">    GValue value = {</a>
<a name="ln204">      0,</a>
<a name="ln205">    };</a>
<a name="ln206">    gchar *sv;</a>
<a name="ln207"> </a>
<a name="ln208">    gtk_tree_model_get_value(model, &amp;iter, CREATOR_COLUMN, &amp;value);</a>
<a name="ln209">    if((sv = (gchar *)g_value_get_string(&amp;value)) != NULL &amp;&amp; sv[0] != '\0')</a>
<a name="ln210">    {</a>
<a name="ln211">      g_signal_handlers_block_by_func(data-&gt;settings.general.creator, _camera_import_metadata_changed, data);</a>
<a name="ln212">      gtk_entry_set_text(GTK_ENTRY(data-&gt;settings.general.creator), sv);</a>
<a name="ln213">      g_signal_handlers_unblock_by_func(data-&gt;settings.general.creator, _camera_import_metadata_changed, data);</a>
<a name="ln214">    }</a>
<a name="ln215">    g_value_unset(&amp;value);</a>
<a name="ln216"> </a>
<a name="ln217">    gtk_tree_model_get_value(model, &amp;iter, PUBLISHER_COLUMN, &amp;value);</a>
<a name="ln218">    if((sv = (gchar *)g_value_get_string(&amp;value)) != NULL &amp;&amp; sv[0] != '\0')</a>
<a name="ln219">    {</a>
<a name="ln220">      g_signal_handlers_block_by_func(data-&gt;settings.general.publisher, _camera_import_metadata_changed, data);</a>
<a name="ln221">      gtk_entry_set_text(GTK_ENTRY(data-&gt;settings.general.publisher), sv);</a>
<a name="ln222">      g_signal_handlers_unblock_by_func(data-&gt;settings.general.publisher, _camera_import_metadata_changed, data);</a>
<a name="ln223">    }</a>
<a name="ln224">    g_value_unset(&amp;value);</a>
<a name="ln225"> </a>
<a name="ln226">    gtk_tree_model_get_value(model, &amp;iter, RIGHTS_COLUMN, &amp;value);</a>
<a name="ln227">    if((sv = (gchar *)g_value_get_string(&amp;value)) != NULL &amp;&amp; sv[0] != '\0')</a>
<a name="ln228">    {</a>
<a name="ln229">      g_signal_handlers_block_by_func(data-&gt;settings.general.rights,  _camera_import_metadata_changed, data);</a>
<a name="ln230">      gtk_entry_set_text(GTK_ENTRY(data-&gt;settings.general.rights), sv);</a>
<a name="ln231">      g_signal_handlers_unblock_by_func(data-&gt;settings.general.rights, _camera_import_metadata_changed, data);</a>
<a name="ln232">    }</a>
<a name="ln233">    g_value_unset(&amp;value);</a>
<a name="ln234">  }</a>
<a name="ln235"> </a>
<a name="ln236">  _camera_import_set_metadata(data);</a>
<a name="ln237">}</a>
<a name="ln238"> </a>
<a name="ln239">/** Creates a gconf widget. */</a>
<a name="ln240">static _camera_gconf_widget_t *_camera_import_gconf_widget(_camera_import_dialog_t *dlg, gchar *label,</a>
<a name="ln241">                                                           gchar *confstring)</a>
<a name="ln242">{</a>
<a name="ln243">  _camera_gconf_widget_t *gcw = calloc(1, sizeof(_camera_gconf_widget_t));</a>
<a name="ln244">  GtkWidget *vbox, *hbox;</a>
<a name="ln245">  gcw-&gt;widget = vbox = GTK_WIDGET(gtk_box_new(GTK_ORIENTATION_VERTICAL, 0));</a>
<a name="ln246">  hbox = GTK_WIDGET(gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0));</a>
<a name="ln247">  g_object_set_data(G_OBJECT(vbox), &quot;gconf:string&quot;, confstring);</a>
<a name="ln248">  gcw-&gt;dialog = dlg;</a>
<a name="ln249"> </a>
<a name="ln250">  gcw-&gt;entry = gtk_entry_new();</a>
<a name="ln251">  char *value = dt_conf_get_string(confstring);</a>
<a name="ln252">  if(value)</a>
<a name="ln253">  {</a>
<a name="ln254">    gtk_entry_set_text(GTK_ENTRY(gcw-&gt;entry), value);</a>
<a name="ln255">    g_free(gcw-&gt;value);</a>
<a name="ln256">    gcw-&gt;value = value;</a>
<a name="ln257">  }</a>
<a name="ln258"> </a>
<a name="ln259">  gtk_box_pack_start(GTK_BOX(hbox), GTK_WIDGET(gcw-&gt;entry), TRUE, TRUE, 0);</a>
<a name="ln260"> </a>
<a name="ln261">  GtkWidget *button = dtgtk_button_new(dtgtk_cairo_paint_store, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln262">  gtk_widget_set_tooltip_text(button, _(&quot;store value as default&quot;));</a>
<a name="ln263">  gtk_box_pack_start(GTK_BOX(hbox), button, FALSE, FALSE, 0);</a>
<a name="ln264">  g_signal_connect(G_OBJECT(button), &quot;clicked&quot;, G_CALLBACK(_gcw_store_callback), gcw);</a>
<a name="ln265"> </a>
<a name="ln266">  button = dtgtk_button_new(dtgtk_cairo_paint_reset, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln267">  gtk_widget_set_tooltip_text(button, _(&quot;reset value to default&quot;));</a>
<a name="ln268">  gtk_box_pack_start(GTK_BOX(hbox), button, FALSE, FALSE, 0);</a>
<a name="ln269">  g_signal_connect(G_OBJECT(button), &quot;clicked&quot;, G_CALLBACK(_gcw_reset_callback), gcw);</a>
<a name="ln270"> </a>
<a name="ln271">  GtkWidget *l = gtk_label_new(label);</a>
<a name="ln272">  gtk_widget_set_halign(l, GTK_ALIGN_START);</a>
<a name="ln273">  gtk_box_pack_start(GTK_BOX(vbox), l, FALSE, FALSE, 0);</a>
<a name="ln274"> </a>
<a name="ln275">  gtk_box_pack_start(GTK_BOX(vbox), GTK_WIDGET(hbox), FALSE, FALSE, 0);</a>
<a name="ln276"> </a>
<a name="ln277">  g_signal_connect(G_OBJECT(gtk_entry_get_buffer(GTK_ENTRY(gcw-&gt;entry))), &quot;inserted-text&quot;,</a>
<a name="ln278">                   G_CALLBACK(entry_it_callback), gcw);</a>
<a name="ln279">  g_signal_connect(G_OBJECT(gtk_entry_get_buffer(GTK_ENTRY(gcw-&gt;entry))), &quot;deleted-text&quot;,</a>
<a name="ln280">                   G_CALLBACK(entry_dt_callback), gcw);</a>
<a name="ln281"> </a>
<a name="ln282">  return gcw;</a>
<a name="ln283">}</a>
<a name="ln284"> </a>
<a name="ln285">static void _camera_import_dialog_new(_camera_import_dialog_t *data)</a>
<a name="ln286">{</a>
<a name="ln287">  data-&gt;dialog = gtk_dialog_new_with_buttons(_(&quot;import images from camera&quot;), NULL, GTK_DIALOG_MODAL,</a>
<a name="ln288">                                             _(&quot;cancel&quot;), GTK_RESPONSE_NONE, C_(&quot;camera import&quot;, &quot;import&quot;),</a>
<a name="ln289">                                             GTK_RESPONSE_ACCEPT, NULL);</a>
<a name="ln290">#ifdef GDK_WINDOWING_QUARTZ</a>
<a name="ln291">  dt_osx_disallow_fullscreen(data-&gt;dialog);</a>
<a name="ln292">#endif</a>
<a name="ln293">  gtk_window_set_default_size(GTK_WINDOW(data-&gt;dialog), 100, 600);</a>
<a name="ln294">  gtk_window_set_transient_for(GTK_WINDOW(data-&gt;dialog), GTK_WINDOW(dt_ui_main_window(darktable.gui-&gt;ui)));</a>
<a name="ln295">  GtkWidget *content = gtk_dialog_get_content_area(GTK_DIALOG(data-&gt;dialog));</a>
<a name="ln296"> </a>
<a name="ln297">  // List - setup store</a>
<a name="ln298">  data-&gt;store = gtk_list_store_new(2, GDK_TYPE_PIXBUF, G_TYPE_STRING);</a>
<a name="ln299"> </a>
<a name="ln300">  // IMPORT PAGE</a>
<a name="ln301">  data-&gt;import.page = gtk_box_new(GTK_ORIENTATION_VERTICAL, 0);</a>
<a name="ln302"> </a>
<a name="ln303">  // Top info</a>
<a name="ln304">  data-&gt;import.info = gtk_label_new(_(&quot;please wait while prefetching thumbnails of images from camera...&quot;));</a>
<a name="ln305">  gtk_label_set_single_line_mode(GTK_LABEL(data-&gt;import.info), FALSE);</a>
<a name="ln306">  gtk_widget_set_halign(data-&gt;import.info, GTK_ALIGN_START);</a>
<a name="ln307">  gtk_box_pack_start(GTK_BOX(data-&gt;import.page), data-&gt;import.info, FALSE, FALSE, 0);</a>
<a name="ln308"> </a>
<a name="ln309">  // jobcode</a>
<a name="ln310">  data-&gt;import.jobname</a>
<a name="ln311">      = _camera_import_gconf_widget(data, _(&quot;jobcode&quot;), &quot;plugins/capture/camera/import/jobcode&quot;);</a>
<a name="ln312">  gtk_box_pack_start(GTK_BOX(data-&gt;import.page), GTK_WIDGET(data-&gt;import.jobname-&gt;widget), FALSE, FALSE, 0);</a>
<a name="ln313"> </a>
<a name="ln314"> </a>
<a name="ln315">  // Create the treview with list model data store</a>
<a name="ln316">  data-&gt;import.treeview = gtk_scrolled_window_new(NULL, NULL);</a>
<a name="ln317">  gtk_scrolled_window_set_policy(GTK_SCROLLED_WINDOW(data-&gt;import.treeview), GTK_POLICY_NEVER,</a>
<a name="ln318">                                 GTK_POLICY_ALWAYS);</a>
<a name="ln319"> </a>
<a name="ln320">  gtk_container_add(GTK_CONTAINER(data-&gt;import.treeview), gtk_tree_view_new());</a>
<a name="ln321">  GtkTreeView *treeview = GTK_TREE_VIEW(gtk_bin_get_child(GTK_BIN(data-&gt;import.treeview)));</a>
<a name="ln322"> </a>
<a name="ln323">  GtkCellRenderer *renderer = gtk_cell_renderer_pixbuf_new();</a>
<a name="ln324">  GtkTreeViewColumn *column</a>
<a name="ln325">      = gtk_tree_view_column_new_with_attributes(_(&quot;thumbnail&quot;), renderer, &quot;pixbuf&quot;, 0, (char *)NULL);</a>
<a name="ln326">  gtk_tree_view_append_column(treeview, column);</a>
<a name="ln327"> </a>
<a name="ln328">  renderer = gtk_cell_renderer_text_new();</a>
<a name="ln329">  column = gtk_tree_view_column_new_with_attributes(_(&quot;storage file&quot;), renderer, &quot;text&quot;, 1, (char *)NULL);</a>
<a name="ln330">  gtk_tree_view_append_column(treeview, column);</a>
<a name="ln331">  gtk_tree_view_column_set_expand(column, TRUE);</a>
<a name="ln332"> </a>
<a name="ln333"> </a>
<a name="ln334">  GtkTreeSelection *selection = gtk_tree_view_get_selection(treeview);</a>
<a name="ln335">  gtk_tree_selection_set_mode(selection, GTK_SELECTION_MULTIPLE);</a>
<a name="ln336"> </a>
<a name="ln337">  gtk_tree_view_set_model(treeview, GTK_TREE_MODEL(data-&gt;store));</a>
<a name="ln338">  gtk_tree_view_set_headers_visible(treeview, FALSE);</a>
<a name="ln339"> </a>
<a name="ln340">  gtk_box_pack_start(GTK_BOX(data-&gt;import.page), data-&gt;import.treeview, TRUE, TRUE, 0);</a>
<a name="ln341"> </a>
<a name="ln342"> </a>
<a name="ln343">  // SETTINGS PAGE</a>
<a name="ln344">  data-&gt;settings.page = gtk_box_new(GTK_ORIENTATION_VERTICAL, 0);</a>
<a name="ln345"> </a>
<a name="ln346">  // general settings</a>
<a name="ln347">  gtk_box_pack_start(GTK_BOX(data-&gt;settings.page), gtk_label_new(_(&quot;general&quot;)), FALSE, FALSE, 0);</a>
<a name="ln348"> </a>
<a name="ln349">  // ignoring of jpegs. hack while we don't handle raw+jpeg in the same directories.</a>
<a name="ln350">  data-&gt;settings.general.ignore_jpeg = gtk_check_button_new_with_label(_(&quot;ignore JPEG files&quot;));</a>
<a name="ln351">  gtk_widget_set_tooltip_text(data-&gt;settings.general.ignore_jpeg,</a>
<a name="ln352">               _(&quot;do not load files with an extension of .jpg or .jpeg. this can be useful when there are &quot;</a>
<a name="ln353">                 &quot;raw+JPEG in a directory.&quot;));</a>
<a name="ln354">  gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(data-&gt;settings.general.ignore_jpeg),</a>
<a name="ln355">                               dt_conf_get_bool(&quot;ui_last/import_ignore_jpegs&quot;));</a>
<a name="ln356">  gtk_box_pack_start(GTK_BOX(data-&gt;settings.page), data-&gt;settings.general.ignore_jpeg, FALSE, FALSE, 0);</a>
<a name="ln357">  g_signal_connect(G_OBJECT(data-&gt;settings.general.ignore_jpeg), &quot;clicked&quot;,</a>
<a name="ln358">                   G_CALLBACK(_check_button_callback), data);</a>
<a name="ln359"> </a>
<a name="ln360">  // default metadata</a>
<a name="ln361">  data-&gt;settings.general.apply_metadata = gtk_check_button_new_with_label(_(&quot;apply metadata on import&quot;));</a>
<a name="ln362">  gtk_widget_set_tooltip_text(data-&gt;settings.general.apply_metadata, _(&quot;apply some metadata to all newly imported images.&quot;));</a>
<a name="ln363">  gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(data-&gt;settings.general.apply_metadata),</a>
<a name="ln364">                               dt_conf_get_bool(&quot;ui_last/import_apply_metadata&quot;));</a>
<a name="ln365">  gtk_box_pack_start(GTK_BOX(data-&gt;settings.page), data-&gt;settings.general.apply_metadata, FALSE, FALSE, 0);</a>
<a name="ln366"> </a>
<a name="ln367">  GValue value = {</a>
<a name="ln368">    0,</a>
<a name="ln369">  };</a>
<a name="ln370">  g_value_init(&amp;value, G_TYPE_INT);</a>
<a name="ln371">  gtk_widget_style_get_property(data-&gt;settings.general.apply_metadata, &quot;indicator-size&quot;, &amp;value);</a>
<a name="ln372">  gtk_widget_style_get_property(data-&gt;settings.general.apply_metadata, &quot;indicator-spacing&quot;, &amp;value);</a>
<a name="ln373">  g_value_unset(&amp;value);</a>
<a name="ln374"> </a>
<a name="ln375">  GtkWidget *grid = gtk_grid_new();</a>
<a name="ln376">  gtk_box_pack_start(GTK_BOX(data-&gt;settings.page), grid, FALSE, FALSE, 0);</a>
<a name="ln377"> </a>
<a name="ln378">  data-&gt;settings.general.creator = gtk_entry_new();</a>
<a name="ln379">  gtk_widget_set_size_request(data-&gt;settings.general.creator, DT_PIXEL_APPLY_DPI(300), -1);</a>
<a name="ln380">  gchar *str = dt_conf_get_string(&quot;ui_last/import_last_creator&quot;);</a>
<a name="ln381">  gtk_entry_set_text(GTK_ENTRY(data-&gt;settings.general.creator), str);</a>
<a name="ln382">  g_free(str);</a>
<a name="ln383"> </a>
<a name="ln384">  data-&gt;settings.general.publisher = gtk_entry_new();</a>
<a name="ln385">  str = dt_conf_get_string(&quot;ui_last/import_last_publisher&quot;);</a>
<a name="ln386">  gtk_entry_set_text(GTK_ENTRY(data-&gt;settings.general.publisher), str);</a>
<a name="ln387">  g_free(str);</a>
<a name="ln388"> </a>
<a name="ln389">  data-&gt;settings.general.rights = gtk_entry_new();</a>
<a name="ln390">  str = dt_conf_get_string(&quot;ui_last/import_last_rights&quot;);</a>
<a name="ln391">  gtk_entry_set_text(GTK_ENTRY(data-&gt;settings.general.rights), str);</a>
<a name="ln392">  g_free(str);</a>
<a name="ln393"> </a>
<a name="ln394">  data-&gt;settings.general.tags = gtk_entry_new();</a>
<a name="ln395">  str = dt_conf_get_string(&quot;ui_last/import_last_tags&quot;);</a>
<a name="ln396">  gtk_widget_set_tooltip_text(data-&gt;settings.general.tags, _(&quot;comma separated list of tags&quot;));</a>
<a name="ln397">  gtk_entry_set_text(GTK_ENTRY(data-&gt;settings.general.tags), str);</a>
<a name="ln398">  g_free(str);</a>
<a name="ln399"> </a>
<a name="ln400">  // presets from the metadata plugin</a>
<a name="ln401">  GtkTreeIter iter;</a>
<a name="ln402">  GtkListStore *model = gtk_list_store_new(N_COLUMNS, G_TYPE_STRING /*name*/, G_TYPE_STRING /*creator*/,</a>
<a name="ln403">                                           G_TYPE_STRING /*publisher*/, G_TYPE_STRING /*rights*/);</a>
<a name="ln404"> </a>
<a name="ln405">  data-&gt;settings.general.presets = gtk_combo_box_new_with_model(GTK_TREE_MODEL(model));</a>
<a name="ln406">  renderer = gtk_cell_renderer_text_new();</a>
<a name="ln407">  gtk_cell_layout_pack_start(GTK_CELL_LAYOUT(data-&gt;settings.general.presets), renderer, FALSE);</a>
<a name="ln408">  gtk_cell_layout_set_attributes(GTK_CELL_LAYOUT(data-&gt;settings.general.presets), renderer, &quot;text&quot;, NAME_COLUMN, NULL);</a>
<a name="ln409"> </a>
<a name="ln410">  sqlite3_stmt *stmt;</a>
<a name="ln411">  DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln412">                              &quot;SELECT name, op_params FROM data.presets WHERE operation = \&quot;metadata\&quot;&quot;, -1, &amp;stmt,</a>
<a name="ln413">                              NULL);</a>
<a name="ln414">  while(sqlite3_step(stmt) == SQLITE_ROW)</a>
<a name="ln415">  {</a>
<a name="ln416">    void *op_params = (void *)sqlite3_column_blob(stmt, 1);</a>
<a name="ln417">    int32_t op_params_size = sqlite3_column_bytes(stmt, 1);</a>
<a name="ln418"> </a>
<a name="ln419">    char *buf = (char *)op_params;</a>
<a name="ln420">    char *title_str = buf;</a>
<a name="ln421">    buf += strlen(title_str) + 1;</a>
<a name="ln422">    char *description_str = buf;</a>
<a name="ln423">    buf += strlen(description_str) + 1;</a>
<a name="ln424">    char *rights_str = buf;</a>
<a name="ln425">    buf += strlen(rights_str) + 1;</a>
<a name="ln426">    char *creator_str = buf;</a>
<a name="ln427">    buf += strlen(creator_str) + 1;</a>
<a name="ln428">    char *publisher_str = buf;</a>
<a name="ln429"> </a>
<a name="ln430">    if(op_params_size</a>
<a name="ln431">       == strlen(title_str) + strlen(description_str) + strlen(rights_str) + strlen(creator_str)</a>
<a name="ln432">              + strlen(publisher_str) + 5)</a>
<a name="ln433">    {</a>
<a name="ln434">      gtk_list_store_append(model, &amp;iter);</a>
<a name="ln435">      gtk_list_store_set(model, &amp;iter, NAME_COLUMN, (char *)sqlite3_column_text(stmt, 0), CREATOR_COLUMN,</a>
<a name="ln436">                         creator_str, PUBLISHER_COLUMN, publisher_str, RIGHTS_COLUMN, rights_str, -1);</a>
<a name="ln437">    }</a>
<a name="ln438">  }</a>
<a name="ln439">  sqlite3_finalize(stmt);</a>
<a name="ln440"> </a>
<a name="ln441">  g_object_unref(model);</a>
<a name="ln442"> </a>
<a name="ln443">  int line = 0;</a>
<a name="ln444"> </a>
<a name="ln445">  GtkWidget *label = gtk_label_new(_(&quot;preset&quot;));</a>
<a name="ln446">  gtk_widget_set_halign(label, GTK_ALIGN_START);</a>
<a name="ln447">  gtk_grid_attach(GTK_GRID(grid), label, 0, line++, 1, 1);</a>
<a name="ln448">  gtk_grid_attach_next_to(GTK_GRID(grid), data-&gt;settings.general.presets, label, GTK_POS_RIGHT, 1, 1);</a>
<a name="ln449"> </a>
<a name="ln450">  label = gtk_label_new(_(&quot;creator&quot;));</a>
<a name="ln451">  gtk_widget_set_halign(label, GTK_ALIGN_START);</a>
<a name="ln452">  gtk_grid_attach(GTK_GRID(grid), label, 0, line++, 1, 1);</a>
<a name="ln453">  gtk_grid_attach_next_to(GTK_GRID(grid), data-&gt;settings.general.creator, label, GTK_POS_RIGHT, 1, 1);</a>
<a name="ln454"> </a>
<a name="ln455">  label = gtk_label_new(_(&quot;publisher&quot;));</a>
<a name="ln456">  gtk_widget_set_halign(label, GTK_ALIGN_START);</a>
<a name="ln457">  gtk_grid_attach(GTK_GRID(grid), label, 0, line++, 1, 1);</a>
<a name="ln458">  gtk_grid_attach_next_to(GTK_GRID(grid), data-&gt;settings.general.publisher, label, GTK_POS_RIGHT, 1, 1);</a>
<a name="ln459"> </a>
<a name="ln460">  label = gtk_label_new(_(&quot;rights&quot;));</a>
<a name="ln461">  gtk_widget_set_halign(label, GTK_ALIGN_START);</a>
<a name="ln462">  gtk_grid_attach(GTK_GRID(grid), label, 0, line++, 1, 1);</a>
<a name="ln463">  gtk_grid_attach_next_to(GTK_GRID(grid), data-&gt;settings.general.rights, label, GTK_POS_RIGHT, 1, 1);</a>
<a name="ln464"> </a>
<a name="ln465">  label = gtk_label_new(_(&quot;tags&quot;));</a>
<a name="ln466">  gtk_widget_set_halign(label, GTK_ALIGN_START);</a>
<a name="ln467">  gtk_grid_attach(GTK_GRID(grid), label, 0, line, 1, 1);</a>
<a name="ln468">  gtk_grid_attach_next_to(GTK_GRID(grid), data-&gt;settings.general.tags, label, GTK_POS_RIGHT, 1, 1);</a>
<a name="ln469"> </a>
<a name="ln470">  g_signal_connect(data-&gt;settings.general.apply_metadata, &quot;toggled&quot;,</a>
<a name="ln471">                   G_CALLBACK(_camera_import_apply_metadata_toggled), grid);</a>
<a name="ln472"> </a>
<a name="ln473">  _camera_import_apply_metadata_toggled(data-&gt;settings.general.apply_metadata, grid);</a>
<a name="ln474"> </a>
<a name="ln475">  g_signal_connect(data-&gt;settings.general.presets, &quot;changed&quot;,</a>
<a name="ln476">                   G_CALLBACK(_camera_import_presets_changed), data);</a>
<a name="ln477">  g_signal_connect(GTK_ENTRY(data-&gt;settings.general.creator), &quot;changed&quot;,</a>
<a name="ln478">                   G_CALLBACK(_camera_import_metadata_changed), data);</a>
<a name="ln479">  g_signal_connect(GTK_ENTRY(data-&gt;settings.general.publisher), &quot;changed&quot;,</a>
<a name="ln480">                   G_CALLBACK(_camera_import_metadata_changed), data);</a>
<a name="ln481">  g_signal_connect(GTK_ENTRY(data-&gt;settings.general.rights), &quot;changed&quot;,</a>
<a name="ln482">                   G_CALLBACK(_camera_import_metadata_changed), data);</a>
<a name="ln483">  g_signal_connect(GTK_ENTRY(data-&gt;settings.general.tags), &quot;changed&quot;,</a>
<a name="ln484">                   G_CALLBACK(_camera_import_metadata_changed), data);</a>
<a name="ln485"> </a>
<a name="ln486">  // today's date</a>
<a name="ln487"> </a>
<a name="ln488">  GtkWidget *hbox = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0);</a>
<a name="ln489">  data-&gt;settings.general.date_override = gtk_check_button_new_with_label(_(&quot;override today's date&quot;));</a>
<a name="ln490">  gtk_box_pack_start(GTK_BOX(hbox), data-&gt;settings.general.date_override, FALSE, FALSE, 0);</a>
<a name="ln491">  gtk_widget_set_tooltip_text(data-&gt;settings.general.date_override,</a>
<a name="ln492">               _(&quot;check this, if you want to override the timestamp used when expanding variables:\n$(YEAR), &quot;</a>
<a name="ln493">                 &quot;$(MONTH), $(DAY),\n$(HOUR), $(MINUTE), $(SECONDS)&quot;));</a>
<a name="ln494"> </a>
<a name="ln495">  data-&gt;settings.general.date_entry = gtk_entry_new();</a>
<a name="ln496">  gtk_widget_set_sensitive(data-&gt;settings.general.date_entry, gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(</a>
<a name="ln497">                                                                  data-&gt;settings.general.date_override)));</a>
<a name="ln498">  gtk_box_pack_start(GTK_BOX(hbox), data-&gt;settings.general.date_entry, TRUE, TRUE, 0);</a>
<a name="ln499"> </a>
<a name="ln500">  g_signal_connect(G_OBJECT(data-&gt;settings.general.date_override), &quot;clicked&quot;,</a>
<a name="ln501">                   G_CALLBACK(_check_button_callback), data);</a>
<a name="ln502"> </a>
<a name="ln503">  gtk_box_pack_start(GTK_BOX(data-&gt;settings.page), hbox, FALSE, FALSE, 0);</a>
<a name="ln504"> </a>
<a name="ln505"> </a>
<a name="ln506">  // THE NOTEBOOK</a>
<a name="ln507">  data-&gt;notebook = gtk_notebook_new();</a>
<a name="ln508">  gtk_notebook_append_page(GTK_NOTEBOOK(data-&gt;notebook), data-&gt;import.page, gtk_label_new(_(&quot;images&quot;)));</a>
<a name="ln509">  gtk_notebook_append_page(GTK_NOTEBOOK(data-&gt;notebook), data-&gt;settings.page, gtk_label_new(_(&quot;settings&quot;)));</a>
<a name="ln510"> </a>
<a name="ln511">  // end</a>
<a name="ln512">  gtk_box_pack_start(GTK_BOX(content), data-&gt;notebook, TRUE, TRUE, 0);</a>
<a name="ln513">  // gtk_widget_set_size_request(content, DT_PIXEL_APPLY_DPI(400), DT_PIXEL_APPLY_DPI(400));</a>
<a name="ln514">}</a>
<a name="ln515"> </a>
<a name="ln516">typedef struct _image_filename_t</a>
<a name="ln517">{</a>
<a name="ln518">  char *file_info;</a>
<a name="ln519">  GdkPixbuf *thumb;</a>
<a name="ln520">  GtkListStore *store;</a>
<a name="ln521">} _image_filename_t;</a>
<a name="ln522"> </a>
<a name="ln523">static gboolean _camera_storage_image_filename_gui_thread(gpointer user_data)</a>
<a name="ln524">{</a>
<a name="ln525">  _image_filename_t *params = (_image_filename_t *)user_data;</a>
<a name="ln526"> </a>
<a name="ln527">  GtkTreeIter iter;</a>
<a name="ln528"> </a>
<a name="ln529">  gtk_list_store_append(params-&gt;store, &amp;iter);</a>
<a name="ln530">  gtk_list_store_set(params-&gt;store, &amp;iter, 0, params-&gt;thumb, 1, params-&gt;file_info, -1);</a>
<a name="ln531"> </a>
<a name="ln532">  if(params-&gt;thumb) g_object_ref(params-&gt;thumb);</a>
<a name="ln533">  free(params-&gt;file_info);</a>
<a name="ln534">  free(params);</a>
<a name="ln535">  return FALSE;</a>
<a name="ln536">}</a>
<a name="ln537"> </a>
<a name="ln538">static int _camera_storage_image_filename(const dt_camera_t *camera, const char *filename,</a>
<a name="ln539">                                          CameraFile *preview, CameraFile *exif, void *user_data)</a>
<a name="ln540">{</a>
<a name="ln541">  _camera_import_dialog_t *data = (_camera_import_dialog_t *)user_data;</a>
<a name="ln542">  const char *img;</a>
<a name="ln543">  unsigned long size;</a>
<a name="ln544">  GdkPixbuf *pixbuf = NULL;</a>
<a name="ln545">  GdkPixbuf *thumb = NULL;</a>
<a name="ln546"> </a>
<a name="ln547">  /* stop fetching previews if job is cancelled */</a>
<a name="ln548">  if(data-&gt;preview_job &amp;&amp; dt_control_job_get_state(data-&gt;preview_job) == DT_JOB_STATE_CANCELLED) return 0;</a>
<a name="ln549"> </a>
<a name="ln550">  char exif_info[1024] = { 0 };</a>
<a name="ln551"> </a>
<a name="ln552">  if(preview)</a>
<a name="ln553">  {</a>
<a name="ln554">    gp_file_get_data_and_size(preview, &amp;img, &amp;size);</a>
<a name="ln555">    if(size &gt; 0)</a>
<a name="ln556">    {</a>
<a name="ln557">      // we got preview image data lets create a pixbuf from image blob</a>
<a name="ln558">      GError *err = NULL;</a>
<a name="ln559">      GInputStream *stream;</a>
<a name="ln560">      if((stream = g_memory_input_stream_new_from_data(img, size, NULL)) != NULL)</a>
<a name="ln561">        pixbuf = gdk_pixbuf_new_from_stream(stream, NULL, &amp;err);</a>
<a name="ln562">    }</a>
<a name="ln563"> </a>
<a name="ln564">    if(pixbuf)</a>
<a name="ln565">    {</a>
<a name="ln566">      // Scale pixbuf to a thumbnail</a>
<a name="ln567">      double sw = gdk_pixbuf_get_width(pixbuf);</a>
<a name="ln568">      double scale = 75.0 / gdk_pixbuf_get_height(pixbuf);</a>
<a name="ln569">      thumb = gdk_pixbuf_scale_simple(pixbuf, sw * scale, 75, GDK_INTERP_BILINEAR);</a>
<a name="ln570">    }</a>
<a name="ln571">  }</a>
<a name="ln572"> </a>
<a name="ln573">#if 0</a>
<a name="ln574">  // libgphoto only supports fetching exif in jpegs, not raw</a>
<a name="ln575">  char buffer[1024]= {0};</a>
<a name="ln576">  if ( exif )</a>
<a name="ln577">  {</a>
<a name="ln578">    const char *exif_data;</a>
<a name="ln579">    char *value=NULL;</a>
<a name="ln580">    gp_file_get_data_and_size(exif, &amp;exif_data, &amp;size);</a>
<a name="ln581">    if( size &gt; 0 )</a>
<a name="ln582">    {</a>
<a name="ln583">      void *exif=dt_exif_data_new((uint8_t *)exif_data,size);</a>
<a name="ln584">      if( (value=g_strdup( dt_exif_data_get_value(exif,&quot;Exif.Photo.ExposureTime&quot;,buffer,1024) ) ) != NULL);</a>
<a name="ln585">      snprintf(exif_info, sizeof(exif_info), &quot;exposure: %s\n&quot;, value);</a>
<a name="ln586">    }</a>
<a name="ln587">    else fprintf(stderr,&quot;No exifdata read\n&quot;);</a>
<a name="ln588">  }</a>
<a name="ln589">#endif</a>
<a name="ln590"> </a>
<a name="ln591">  _image_filename_t *params = (_image_filename_t *)malloc(sizeof(_image_filename_t));</a>
<a name="ln592">  if(!params)</a>
<a name="ln593">  {</a>
<a name="ln594">    if(pixbuf) g_object_unref(pixbuf);</a>
<a name="ln595">    if(thumb) g_object_unref(thumb);</a>
<a name="ln596">    return 0;</a>
<a name="ln597">  }</a>
<a name="ln598"> </a>
<a name="ln599">  // filename\n 1/60 f/2.8 24mm iso 160</a>
<a name="ln600">  params-&gt;file_info = g_strdup_printf(&quot;%s%c%s&quot;, filename, *exif_info ? '\n' : '\0',</a>
<a name="ln601">                                      *exif_info ? exif_info : &quot;&quot;);</a>
<a name="ln602">  params-&gt;thumb = thumb;</a>
<a name="ln603">  params-&gt;store = data-&gt;store;</a>
<a name="ln604">  g_main_context_invoke(NULL, _camera_storage_image_filename_gui_thread, params);</a>
<a name="ln605"> </a>
<a name="ln606">  if(pixbuf) g_object_unref(pixbuf);</a>
<a name="ln607"> </a>
<a name="ln608">  return 1;</a>
<a name="ln609">}</a>
<a name="ln610"> </a>
<a name="ln611">static void _camera_import_dialog_free(_camera_import_dialog_t *data)</a>
<a name="ln612">{</a>
<a name="ln613">  gtk_list_store_clear(data-&gt;store);</a>
<a name="ln614">  g_object_unref(data-&gt;store);</a>
<a name="ln615">}</a>
<a name="ln616"> </a>
<a name="ln617">static void _control_status(dt_camctl_status_t status, void *user_data)</a>
<a name="ln618">{</a>
<a name="ln619">  _camera_import_dialog_t *data = (_camera_import_dialog_t *)user_data;</a>
<a name="ln620">  switch(status)</a>
<a name="ln621">  {</a>
<a name="ln622">    case CAMERA_CONTROL_BUSY:</a>
<a name="ln623">    {</a>
<a name="ln624">      gtk_dialog_set_response_sensitive(GTK_DIALOG(data-&gt;dialog), GTK_RESPONSE_ACCEPT, FALSE);</a>
<a name="ln625">      gtk_dialog_set_response_sensitive(GTK_DIALOG(data-&gt;dialog), GTK_RESPONSE_NONE, FALSE);</a>
<a name="ln626">    }</a>
<a name="ln627">    break;</a>
<a name="ln628">    case CAMERA_CONTROL_AVAILABLE:</a>
<a name="ln629">    {</a>
<a name="ln630">      gtk_dialog_set_response_sensitive(GTK_DIALOG(data-&gt;dialog), GTK_RESPONSE_ACCEPT, TRUE);</a>
<a name="ln631">      gtk_dialog_set_response_sensitive(GTK_DIALOG(data-&gt;dialog), GTK_RESPONSE_NONE, TRUE);</a>
<a name="ln632">    }</a>
<a name="ln633">    break;</a>
<a name="ln634">  }</a>
<a name="ln635">}</a>
<a name="ln636"> </a>
<a name="ln637">static void _preview_job_state_changed(dt_job_t *job, dt_job_state_t state)</a>
<a name="ln638">{</a>
<a name="ln639">  _camera_import_dialog_t *data = dt_camera_previews_job_get_data(job);</a>
<a name="ln640">  /* store job reference if needed for cancellation */</a>
<a name="ln641">  if(state == DT_JOB_STATE_RUNNING)</a>
<a name="ln642">    data-&gt;preview_job = job;</a>
<a name="ln643">  else if(state == DT_JOB_STATE_FINISHED)</a>
<a name="ln644">    data-&gt;preview_job = NULL;</a>
<a name="ln645">}</a>
<a name="ln646"> </a>
<a name="ln647">static gboolean _dialog_close(GtkWidget *window, GdkEvent *event, gpointer user_data)</a>
<a name="ln648">{</a>
<a name="ln649">  _camera_import_dialog_t *data = (_camera_import_dialog_t *)user_data;</a>
<a name="ln650"> </a>
<a name="ln651">  if(data-&gt;preview_job)</a>
<a name="ln652">  {</a>
<a name="ln653">    /* cancel preview fetching job */</a>
<a name="ln654">    dt_control_job_cancel(data-&gt;preview_job);</a>
<a name="ln655"> </a>
<a name="ln656">    /* wait for job execution to signal finished */</a>
<a name="ln657">    dt_control_job_wait(data-&gt;preview_job);</a>
<a name="ln658">  }</a>
<a name="ln659">  return FALSE;</a>
<a name="ln660">}</a>
<a name="ln661"> </a>
<a name="ln662">static time_t parse_date_time(const char *date_time_text)</a>
<a name="ln663">{</a>
<a name="ln664">  struct tm t;</a>
<a name="ln665">  memset(&amp;t, 0, sizeof(t));</a>
<a name="ln666"> </a>
<a name="ln667">  const char *end = NULL;</a>
<a name="ln668">  if((end = strptime(date_time_text, &quot;%Y-%m-%dT%T&quot;, &amp;t)) &amp;&amp; *end == 0) return mktime(&amp;t);</a>
<a name="ln669">  if((end = strptime(date_time_text, &quot;%Y-%m-%d&quot;, &amp;t)) &amp;&amp; *end == 0) return mktime(&amp;t);</a>
<a name="ln670"> </a>
<a name="ln671">  return 0;</a>
<a name="ln672">}</a>
<a name="ln673"> </a>
<a name="ln674">static void _camera_import_dialog_run(_camera_import_dialog_t *data)</a>
<a name="ln675">{</a>
<a name="ln676">  gtk_widget_show_all(data-&gt;dialog);</a>
<a name="ln677"> </a>
<a name="ln678">  // Populate store</a>
<a name="ln679"> </a>
<a name="ln680">  // Setup a listener for previews of all files on camera</a>
<a name="ln681">  // then initiate fetch of all previews from camera</a>
<a name="ln682">  if(data-&gt;params-&gt;camera != NULL)</a>
<a name="ln683">  {</a>
<a name="ln684">    /* setup a camctl listener */</a>
<a name="ln685">    dt_camctl_listener_t listener = { 0 };</a>
<a name="ln686">    listener.data = data;</a>
<a name="ln687">    listener.control_status = _control_status;</a>
<a name="ln688">    listener.camera_storage_image_filename = _camera_storage_image_filename;</a>
<a name="ln689"> </a>
<a name="ln690">    dt_job_t *job</a>
<a name="ln691">        = dt_camera_get_previews_job_create(data-&gt;params-&gt;camera, &amp;listener, CAMCTL_IMAGE_PREVIEW_DATA, data);</a>
<a name="ln692">    if(job)</a>
<a name="ln693">    {</a>
<a name="ln694">      dt_control_job_set_state_callback(job, _preview_job_state_changed);</a>
<a name="ln695">      dt_control_add_job(darktable.control, DT_JOB_QUEUE_SYSTEM_FG, job);</a>
<a name="ln696">    }</a>
<a name="ln697">  }</a>
<a name="ln698">  else</a>
<a name="ln699">    return;</a>
<a name="ln700"> </a>
<a name="ln701">  // Lets run dialog</a>
<a name="ln702">  gtk_label_set_text(GTK_LABEL(data-&gt;import.info),</a>
<a name="ln703">                     _(&quot;select the images from the list below that you want to import into a new filmroll&quot;));</a>
<a name="ln704">  gboolean all_good = FALSE;</a>
<a name="ln705">  g_signal_connect(G_OBJECT(data-&gt;dialog), &quot;delete-event&quot;, G_CALLBACK(_dialog_close), data);</a>
<a name="ln706">  while(!all_good)</a>
<a name="ln707">  {</a>
<a name="ln708">    gint result = gtk_dialog_run(GTK_DIALOG(data-&gt;dialog));</a>
<a name="ln709">    if(result == GTK_RESPONSE_ACCEPT)</a>
<a name="ln710">    {</a>
<a name="ln711">      GtkTreeIter iter;</a>
<a name="ln712">      all_good = TRUE;</a>
<a name="ln713">      GtkTreeSelection *selection</a>
<a name="ln714">          = gtk_tree_view_get_selection(GTK_TREE_VIEW(gtk_bin_get_child(GTK_BIN(data-&gt;import.treeview))));</a>
<a name="ln715">      // Now build up result from store into GList **result</a>
<a name="ln716">      g_list_free(data-&gt;params-&gt;result);</a>
<a name="ln717">      data-&gt;params-&gt;result = NULL;</a>
<a name="ln718">      GtkTreeModel *model = GTK_TREE_MODEL(data-&gt;store);</a>
<a name="ln719">      GList *sp = gtk_tree_selection_get_selected_rows(selection, &amp;model);</a>
<a name="ln720">      if(sp)</a>
<a name="ln721">      {</a>
<a name="ln722">        do</a>
<a name="ln723">        {</a>
<a name="ln724">          GValue value = {</a>
<a name="ln725">            0,</a>
<a name="ln726">          };</a>
<a name="ln727">          gtk_tree_model_get_iter(GTK_TREE_MODEL(data-&gt;store), &amp;iter, (GtkTreePath *)sp-&gt;data);</a>
<a name="ln728">          gtk_tree_model_get_value(GTK_TREE_MODEL(data-&gt;store), &amp;iter, 1, &amp;value);</a>
<a name="ln729">          if(G_VALUE_HOLDS_STRING(&amp;value))</a>
<a name="ln730">            data-&gt;params-&gt;result = g_list_append(data-&gt;params-&gt;result, g_strdup(g_value_get_string(&amp;value)));</a>
<a name="ln731">          g_value_unset(&amp;value);</a>
<a name="ln732">        } while((sp = g_list_next(sp)));</a>
<a name="ln733">      }</a>
<a name="ln734"> </a>
<a name="ln735">      /* get jobcode from import dialog */</a>
<a name="ln736">      data-&gt;params-&gt;jobcode = data-&gt;import.jobname-&gt;value;</a>
<a name="ln737"> </a>
<a name="ln738">      /* get time override if used */</a>
<a name="ln739">      data-&gt;params-&gt;time_override = 0;</a>
<a name="ln740">      if(gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(data-&gt;settings.general.date_override)))</a>
<a name="ln741">        data-&gt;params-&gt;time_override</a>
<a name="ln742">            = parse_date_time(gtk_entry_get_text(GTK_ENTRY(data-&gt;settings.general.date_entry)));</a>
<a name="ln743"> </a>
<a name="ln744">      if(data-&gt;params-&gt;jobcode == NULL || data-&gt;params-&gt;jobcode[0] == '\0')</a>
<a name="ln745">      {</a>
<a name="ln746">        g_free(data-&gt;params-&gt;jobcode); // might just be a string of length 0</a>
<a name="ln747">        data-&gt;params-&gt;jobcode = dt_conf_get_string(&quot;plugins/capture/camera/import/jobcode&quot;);</a>
<a name="ln748">      }</a>
<a name="ln749">      else if(gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(data-&gt;settings.general.date_override))</a>
<a name="ln750">              &amp;&amp; data-&gt;params-&gt;time_override == 0)</a>
<a name="ln751">      {</a>
<a name="ln752">        GtkWidget *dialog</a>
<a name="ln753">            = gtk_message_dialog_new(NULL, GTK_DIALOG_DESTROY_WITH_PARENT, GTK_MESSAGE_ERROR, GTK_BUTTONS_OK,</a>
<a name="ln754">                                     _(&quot;please use YYYY-MM-DD format for date override&quot;));</a>
<a name="ln755">#ifdef GDK_WINDOWING_QUARTZ</a>
<a name="ln756">        dt_osx_disallow_fullscreen(dialog);</a>
<a name="ln757">#endif</a>
<a name="ln758">        g_signal_connect_swapped(dialog, &quot;response&quot;, G_CALLBACK(gtk_widget_destroy), dialog);</a>
<a name="ln759">        gtk_dialog_run(GTK_DIALOG(dialog));</a>
<a name="ln760">        all_good = FALSE;</a>
<a name="ln761">      }</a>
<a name="ln762">    }</a>
<a name="ln763">    else</a>
<a name="ln764">    {</a>
<a name="ln765">      data-&gt;params-&gt;result = NULL;</a>
<a name="ln766">      all_good = TRUE;</a>
<a name="ln767">    }</a>
<a name="ln768">  }</a>
<a name="ln769"> </a>
<a name="ln770">  // Destroy and quit</a>
<a name="ln771">  gtk_widget_destroy(data-&gt;dialog);</a>
<a name="ln772">}</a>
<a name="ln773"> </a>
<a name="ln774">void dt_camera_import_dialog_new(dt_camera_import_dialog_param_t *params)</a>
<a name="ln775">{</a>
<a name="ln776">  _camera_import_dialog_t data;</a>
<a name="ln777">  memset(&amp;data, 0, sizeof(_camera_import_dialog_t)); // needed to initialize pointers to null</a>
<a name="ln778">  data.params = params;</a>
<a name="ln779">  _camera_import_dialog_new(&amp;data);</a>
<a name="ln780">  _camera_import_dialog_run(&amp;data);</a>
<a name="ln781">  _camera_import_dialog_free(&amp;data);</a>
<a name="ln782">}</a>
<a name="ln783"> </a>
<a name="ln784">// modelines: These editor modelines have been set for all relevant files by tools/update_modelines.sh</a>
<a name="ln785">// vim: shiftwidth=2 expandtab tabstop=2 cindent</a>
<a name="ln786">// kate: tab-indents: off; indent-width 2; replace-tabs on; indent-mode cstyle; remove-trailing-spaces modified;</a>

</code></pre>
<div class="balloon" rel="245"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v522/" target="_blank">V522</a> There might be dereferencing of a potential null pointer 'gcw'. Check lines: 245, 243.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
