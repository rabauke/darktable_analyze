
<html>
<head>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>
<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2">    This file is part of darktable,</a>
<a name="ln3">    copyright (c) 2009--2010 johannes hanika.</a>
<a name="ln4"> </a>
<a name="ln5">    darktable is free software: you can redistribute it and/or modify</a>
<a name="ln6">    it under the terms of the GNU General Public License as published by</a>
<a name="ln7">    the Free Software Foundation, either version 3 of the License, or</a>
<a name="ln8">    (at your option) any later version.</a>
<a name="ln9"> </a>
<a name="ln10">    darktable is distributed in the hope that it will be useful,</a>
<a name="ln11">    but WITHOUT ANY WARRANTY; without even the implied warranty of</a>
<a name="ln12">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</a>
<a name="ln13">    GNU General Public License for more details.</a>
<a name="ln14"> </a>
<a name="ln15">    You should have received a copy of the GNU General Public License</a>
<a name="ln16">    along with darktable.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</a>
<a name="ln17">*/</a>
<a name="ln18"> </a>
<a name="ln19">#include &quot;common/imageio_module.h&quot;</a>
<a name="ln20">#include &quot;common/darktable.h&quot;</a>
<a name="ln21">#include &quot;common/imageio.h&quot;</a>
<a name="ln22">#include &quot;control/conf.h&quot;</a>
<a name="ln23">#include &quot;control/control.h&quot;</a>
<a name="ln24">#include &quot;control/signal.h&quot;</a>
<a name="ln25">#include &lt;stdlib.h&gt;</a>
<a name="ln26">static gint dt_imageio_sort_modules_storage(gconstpointer a, gconstpointer b)</a>
<a name="ln27">{</a>
<a name="ln28">  const dt_imageio_module_storage_t *am = (const dt_imageio_module_storage_t *)a;</a>
<a name="ln29">  const dt_imageio_module_storage_t *bm = (const dt_imageio_module_storage_t *)b;</a>
<a name="ln30">  return strcmp(am-&gt;name(am), bm-&gt;name(bm));</a>
<a name="ln31">}</a>
<a name="ln32"> </a>
<a name="ln33">static gint dt_imageio_sort_modules_format(gconstpointer a, gconstpointer b)</a>
<a name="ln34">{</a>
<a name="ln35">  const dt_imageio_module_format_t *am = (const dt_imageio_module_format_t *)a;</a>
<a name="ln36">  const dt_imageio_module_format_t *bm = (const dt_imageio_module_format_t *)b;</a>
<a name="ln37">  return strcmp(am-&gt;name(), bm-&gt;name());</a>
<a name="ln38">}</a>
<a name="ln39"> </a>
<a name="ln40">/** Default implementation of dimension module function, used if format module does not implement dimension()</a>
<a name="ln41"> */</a>
<a name="ln42">static int _default_format_dimension(dt_imageio_module_format_t *module, dt_imageio_module_data_t *data,</a>
<a name="ln43">                                     uint32_t *width, uint32_t *height)</a>
<a name="ln44">{</a>
<a name="ln45">  // assume no limits</a>
<a name="ln46">  *width = 0;</a>
<a name="ln47">  *height = 0;</a>
<a name="ln48">  return 0;</a>
<a name="ln49">}</a>
<a name="ln50">/** Default implementation of flags, used if format module does not implement flags() */</a>
<a name="ln51">static int _default_format_flags(dt_imageio_module_data_t *data)</a>
<a name="ln52">{</a>
<a name="ln53">  return 0;</a>
<a name="ln54">}</a>
<a name="ln55">/** Default implementation of levels, used if format module does not implement levels() */</a>
<a name="ln56">static int _default_format_levels(dt_imageio_module_data_t *data)</a>
<a name="ln57">{</a>
<a name="ln58">  return IMAGEIO_RGB | IMAGEIO_INT8;</a>
<a name="ln59">}</a>
<a name="ln60">/** Default implementation of gui_init function (a NOP), used when no gui is existing. this is easier than</a>
<a name="ln61"> * checking for that case all over the place */</a>
<a name="ln62">static void _default_format_gui_init(struct dt_imageio_module_format_t *self)</a>
<a name="ln63">{</a>
<a name="ln64">}</a>
<a name="ln65"> </a>
<a name="ln66">static int dt_imageio_load_module_format(dt_imageio_module_format_t *module, const char *libname,</a>
<a name="ln67">                                         const char *plugin_name)</a>
<a name="ln68">{</a>
<a name="ln69">  module-&gt;widget = NULL;</a>
<a name="ln70">  module-&gt;parameter_lua_type = LUAA_INVALID_TYPE;</a>
<a name="ln71">  g_strlcpy(module-&gt;plugin_name, plugin_name, sizeof(module-&gt;plugin_name));</a>
<a name="ln72">  dt_print(DT_DEBUG_CONTROL, &quot;[imageio_load_module] loading format module `%s' from %s\n&quot;, plugin_name, libname);</a>
<a name="ln73">  module-&gt;module = g_module_open(libname, G_MODULE_BIND_LAZY | G_MODULE_BIND_LOCAL);</a>
<a name="ln74">  if(!module-&gt;module) goto error;</a>
<a name="ln75">  int (*version)();</a>
<a name="ln76">  if(!g_module_symbol(module-&gt;module, &quot;dt_module_dt_version&quot;, (gpointer) &amp; (version))) goto error;</a>
<a name="ln77">  if(version() != dt_version())</a>
<a name="ln78">  {</a>
<a name="ln79">    fprintf(</a>
<a name="ln80">        stderr,</a>
<a name="ln81">        &quot;[imageio_load_module] `%s' is compiled for another version of dt (module %d (%s) != dt %d (%s)) !\n&quot;,</a>
<a name="ln82">        libname, abs(version()), version() &lt; 0 ? &quot;debug&quot; : &quot;opt&quot;, abs(dt_version()),</a>
<a name="ln83">        dt_version() &lt; 0 ? &quot;debug&quot; : &quot;opt&quot;);</a>
<a name="ln84">    goto error;</a>
<a name="ln85">  }</a>
<a name="ln86">  if(!g_module_symbol(module-&gt;module, &quot;dt_module_mod_version&quot;, (gpointer) &amp; (module-&gt;version))) goto error;</a>
<a name="ln87">  if(!g_module_symbol(module-&gt;module, &quot;name&quot;, (gpointer) &amp; (module-&gt;name))) goto error;</a>
<a name="ln88">  if(!g_module_symbol(module-&gt;module, &quot;init&quot;, (gpointer) &amp; (module-&gt;init))) goto error;</a>
<a name="ln89">  if(!g_module_symbol(module-&gt;module, &quot;cleanup&quot;, (gpointer) &amp; (module-&gt;cleanup))) goto error;</a>
<a name="ln90">  if(!g_module_symbol(module-&gt;module, &quot;gui_reset&quot;, (gpointer) &amp; (module-&gt;gui_reset))) goto error;</a>
<a name="ln91">  if(darktable.gui)</a>
<a name="ln92">  {</a>
<a name="ln93">    if(!g_module_symbol(module-&gt;module, &quot;gui_init&quot;, (gpointer) &amp; (module-&gt;gui_init))) goto error;</a>
<a name="ln94">  }</a>
<a name="ln95">  else</a>
<a name="ln96">  {</a>
<a name="ln97">    module-&gt;gui_init = _default_format_gui_init;</a>
<a name="ln98">  }</a>
<a name="ln99">  if(!g_module_symbol(module-&gt;module, &quot;gui_cleanup&quot;, (gpointer) &amp; (module-&gt;gui_cleanup))) goto error;</a>
<a name="ln100"> </a>
<a name="ln101">  if(!g_module_symbol(module-&gt;module, &quot;mime&quot;, (gpointer) &amp; (module-&gt;mime))) goto error;</a>
<a name="ln102">  if(!g_module_symbol(module-&gt;module, &quot;extension&quot;, (gpointer) &amp; (module-&gt;extension))) goto error;</a>
<a name="ln103">  if(!g_module_symbol(module-&gt;module, &quot;dimension&quot;, (gpointer) &amp; (module-&gt;dimension)))</a>
<a name="ln104">    module-&gt;dimension = _default_format_dimension;</a>
<a name="ln105">  if(!g_module_symbol(module-&gt;module, &quot;legacy_params&quot;, (gpointer) &amp; (module-&gt;legacy_params)))</a>
<a name="ln106">    module-&gt;legacy_params = NULL;</a>
<a name="ln107">  if(!g_module_symbol(module-&gt;module, &quot;params_size&quot;, (gpointer) &amp; (module-&gt;params_size))) goto error;</a>
<a name="ln108">  if(!g_module_symbol(module-&gt;module, &quot;get_params&quot;, (gpointer) &amp; (module-&gt;get_params))) goto error;</a>
<a name="ln109">  if(!g_module_symbol(module-&gt;module, &quot;free_params&quot;, (gpointer) &amp; (module-&gt;free_params))) goto error;</a>
<a name="ln110">  if(!g_module_symbol(module-&gt;module, &quot;set_params&quot;, (gpointer) &amp; (module-&gt;set_params))) goto error;</a>
<a name="ln111">  if(!g_module_symbol(module-&gt;module, &quot;write_image&quot;, (gpointer) &amp; (module-&gt;write_image))) goto error;</a>
<a name="ln112">  if(!g_module_symbol(module-&gt;module, &quot;bpp&quot;, (gpointer) &amp; (module-&gt;bpp))) goto error;</a>
<a name="ln113">  if(!g_module_symbol(module-&gt;module, &quot;flags&quot;, (gpointer) &amp; (module-&gt;flags)))</a>
<a name="ln114">    module-&gt;flags = _default_format_flags;</a>
<a name="ln115">  if(!g_module_symbol(module-&gt;module, &quot;levels&quot;, (gpointer) &amp; (module-&gt;levels)))</a>
<a name="ln116">    module-&gt;levels = _default_format_levels;</a>
<a name="ln117">  if(!g_module_symbol(module-&gt;module, &quot;read_image&quot;, (gpointer) &amp; (module-&gt;read_image)))</a>
<a name="ln118">    module-&gt;read_image = NULL;</a>
<a name="ln119"> </a>
<a name="ln120">#ifdef USE_LUA</a>
<a name="ln121">  {</a>
<a name="ln122">    char pseudo_type_name[1024];</a>
<a name="ln123">    snprintf(pseudo_type_name, sizeof(pseudo_type_name), &quot;dt_imageio_module_format_data_%s&quot;,</a>
<a name="ln124">             module-&gt;plugin_name);</a>
<a name="ln125">    luaA_Type my_type</a>
<a name="ln126">        = luaA_type_add(darktable.lua_state.state, pseudo_type_name, module-&gt;params_size(module));</a>
<a name="ln127">    module-&gt;parameter_lua_type = dt_lua_init_type_type(darktable.lua_state.state, my_type);</a>
<a name="ln128">    luaA_struct_type(darktable.lua_state.state, my_type);</a>
<a name="ln129">    dt_lua_register_format_type(darktable.lua_state.state, module, my_type);</a>
<a name="ln130">#endif</a>
<a name="ln131">    module-&gt;init(module);</a>
<a name="ln132">#ifdef USE_LUA</a>
<a name="ln133">    lua_pushcfunction(darktable.lua_state.state, dt_lua_type_member_luaautoc);</a>
<a name="ln134">    dt_lua_type_register_struct_type(darktable.lua_state.state, my_type);</a>
<a name="ln135">  }</a>
<a name="ln136">#endif</a>
<a name="ln137"> </a>
<a name="ln138">  return 0;</a>
<a name="ln139">error:</a>
<a name="ln140">  fprintf(stderr, &quot;[imageio_load_module] failed to open format `%s': %s\n&quot;, plugin_name, g_module_error());</a>
<a name="ln141">  if(module-&gt;module) g_module_close(module-&gt;module);</a>
<a name="ln142">  return 1;</a>
<a name="ln143">}</a>
<a name="ln144"> </a>
<a name="ln145"> </a>
<a name="ln146">static int dt_imageio_load_modules_format(dt_imageio_t *iio)</a>
<a name="ln147">{</a>
<a name="ln148">  iio-&gt;plugins_format = NULL;</a>
<a name="ln149">  GList *res = NULL;</a>
<a name="ln150">  dt_imageio_module_format_t *module;</a>
<a name="ln151">  char plugindir[PATH_MAX] = { 0 }, plugin_name[256];</a>
<a name="ln152">  const gchar *d_name;</a>
<a name="ln153">  dt_loc_get_plugindir(plugindir, sizeof(plugindir));</a>
<a name="ln154">  g_strlcat(plugindir, &quot;/plugins/imageio/format&quot;, sizeof(plugindir));</a>
<a name="ln155">  GDir *dir = g_dir_open(plugindir, 0, NULL);</a>
<a name="ln156">  if(!dir) return 1;</a>
<a name="ln157">  const int name_offset = strlen(SHARED_MODULE_PREFIX),</a>
<a name="ln158">            name_end = strlen(SHARED_MODULE_PREFIX) + strlen(SHARED_MODULE_SUFFIX);</a>
<a name="ln159">  while((d_name = g_dir_read_name(dir)))</a>
<a name="ln160">  {</a>
<a name="ln161">    // get lib*.so</a>
<a name="ln162">    if(!g_str_has_prefix(d_name, SHARED_MODULE_PREFIX)) continue;</a>
<a name="ln163">    if(!g_str_has_suffix(d_name, SHARED_MODULE_SUFFIX)) continue;</a>
<a name="ln164">    strncpy(plugin_name, d_name + name_offset, strlen(d_name) - name_end);</a>
<a name="ln165">    plugin_name[strlen(d_name) - name_end] = '\0';</a>
<a name="ln166">    module = (dt_imageio_module_format_t *)malloc(sizeof(dt_imageio_module_format_t));</a>
<a name="ln167">    gchar *libname = g_module_build_path(plugindir, (const gchar *)plugin_name);</a>
<a name="ln168">    if(dt_imageio_load_module_format(module, libname, plugin_name))</a>
<a name="ln169">    {</a>
<a name="ln170">      free(module);</a>
<a name="ln171">      continue;</a>
<a name="ln172">    }</a>
<a name="ln173">    module-&gt;gui_data = NULL;</a>
<a name="ln174">    module-&gt;gui_init(module);</a>
<a name="ln175">    if(module-&gt;widget) g_object_ref(module-&gt;widget);</a>
<a name="ln176">    g_free(libname);</a>
<a name="ln177">    res = g_list_insert_sorted(res, module, dt_imageio_sort_modules_format);</a>
<a name="ln178">  }</a>
<a name="ln179">  g_dir_close(dir);</a>
<a name="ln180">  iio-&gt;plugins_format = res;</a>
<a name="ln181">  return 0;</a>
<a name="ln182">}</a>
<a name="ln183"> </a>
<a name="ln184">/** Default implementation of supported function, used if storage modules not implements supported() */</a>
<a name="ln185">static int _default_supported(struct dt_imageio_module_storage_t *self,</a>
<a name="ln186">                              struct dt_imageio_module_format_t *format)</a>
<a name="ln187">{</a>
<a name="ln188">  return 1;</a>
<a name="ln189">}</a>
<a name="ln190">/** Default implementation of dimension module function, used if storage modules does not implements</a>
<a name="ln191"> * dimension() */</a>
<a name="ln192">static int _default_storage_dimension(struct dt_imageio_module_storage_t *self, dt_imageio_module_data_t *data,</a>
<a name="ln193">                                      uint32_t *width, uint32_t *height)</a>
<a name="ln194">{</a>
<a name="ln195">  return 0;</a>
<a name="ln196">}</a>
<a name="ln197">/** a NOP for when a default should do nothing */</a>
<a name="ln198">static void _default_storage_nop(struct dt_imageio_module_storage_t *self)</a>
<a name="ln199">{</a>
<a name="ln200">}</a>
<a name="ln201"> </a>
<a name="ln202">static int dt_imageio_load_module_storage(dt_imageio_module_storage_t *module, const char *libname,</a>
<a name="ln203">                                          const char *plugin_name)</a>
<a name="ln204">{</a>
<a name="ln205">  module-&gt;widget = NULL;</a>
<a name="ln206">  module-&gt;parameter_lua_type = LUAA_INVALID_TYPE;</a>
<a name="ln207">  g_strlcpy(module-&gt;plugin_name, plugin_name, sizeof(module-&gt;plugin_name));</a>
<a name="ln208">  dt_print(DT_DEBUG_CONTROL, &quot;[imageio_load_module] loading storage module `%s' from %s\n&quot;, plugin_name, libname);</a>
<a name="ln209">  module-&gt;module = g_module_open(libname, G_MODULE_BIND_LAZY | G_MODULE_BIND_LOCAL);</a>
<a name="ln210">  if(!module-&gt;module) goto error;</a>
<a name="ln211">  int (*version)();</a>
<a name="ln212">  if(!g_module_symbol(module-&gt;module, &quot;dt_module_dt_version&quot;, (gpointer) &amp; (version))) goto error;</a>
<a name="ln213">  if(version() != dt_version())</a>
<a name="ln214">  {</a>
<a name="ln215">    fprintf(</a>
<a name="ln216">        stderr,</a>
<a name="ln217">        &quot;[imageio_load_module] `%s' is compiled for another version of dt (module %d (%s) != dt %d (%s)) !\n&quot;,</a>
<a name="ln218">        libname, abs(version()), version() &lt; 0 ? &quot;debug&quot; : &quot;opt&quot;, abs(dt_version()),</a>
<a name="ln219">        dt_version() &lt; 0 ? &quot;debug&quot; : &quot;opt&quot;);</a>
<a name="ln220">    goto error;</a>
<a name="ln221">  }</a>
<a name="ln222">  if(!g_module_symbol(module-&gt;module, &quot;dt_module_mod_version&quot;, (gpointer) &amp; (module-&gt;version))) goto error;</a>
<a name="ln223">  if(!g_module_symbol(module-&gt;module, &quot;name&quot;, (gpointer) &amp; (module-&gt;name))) goto error;</a>
<a name="ln224">  if(!g_module_symbol(module-&gt;module, &quot;gui_reset&quot;, (gpointer) &amp; (module-&gt;gui_reset))) goto error;</a>
<a name="ln225">  if(darktable.gui)</a>
<a name="ln226">  {</a>
<a name="ln227">    if(!g_module_symbol(module-&gt;module, &quot;gui_init&quot;, (gpointer) &amp; (module-&gt;gui_init))) goto error;</a>
<a name="ln228">  }</a>
<a name="ln229">  else</a>
<a name="ln230">  {</a>
<a name="ln231">    module-&gt;gui_init = _default_storage_nop;</a>
<a name="ln232">  }</a>
<a name="ln233">  if(!g_module_symbol(module-&gt;module, &quot;gui_cleanup&quot;, (gpointer) &amp; (module-&gt;gui_cleanup))) goto error;</a>
<a name="ln234">  if(!g_module_symbol(module-&gt;module, &quot;init&quot;, (gpointer) &amp; (module-&gt;init))) goto error;</a>
<a name="ln235"> </a>
<a name="ln236">  if(!g_module_symbol(module-&gt;module, &quot;store&quot;, (gpointer) &amp; (module-&gt;store))) goto error;</a>
<a name="ln237">  if(!g_module_symbol(module-&gt;module, &quot;legacy_params&quot;, (gpointer) &amp; (module-&gt;legacy_params)))</a>
<a name="ln238">    module-&gt;legacy_params = NULL;</a>
<a name="ln239">  if(!g_module_symbol(module-&gt;module, &quot;params_size&quot;, (gpointer) &amp; (module-&gt;params_size))) goto error;</a>
<a name="ln240">  if(!g_module_symbol(module-&gt;module, &quot;get_params&quot;, (gpointer) &amp; (module-&gt;get_params))) goto error;</a>
<a name="ln241">  if(!g_module_symbol(module-&gt;module, &quot;free_params&quot;, (gpointer) &amp; (module-&gt;free_params))) goto error;</a>
<a name="ln242">  if(!g_module_symbol(module-&gt;module, &quot;initialize_store&quot;, (gpointer) &amp; (module-&gt;initialize_store)))</a>
<a name="ln243">    module-&gt;initialize_store = NULL;</a>
<a name="ln244">  if(!g_module_symbol(module-&gt;module, &quot;finalize_store&quot;, (gpointer) &amp; (module-&gt;finalize_store)))</a>
<a name="ln245">    module-&gt;finalize_store = NULL;</a>
<a name="ln246">  if(!g_module_symbol(module-&gt;module, &quot;set_params&quot;, (gpointer) &amp; (module-&gt;set_params))) goto error;</a>
<a name="ln247"> </a>
<a name="ln248">  if(!g_module_symbol(module-&gt;module, &quot;supported&quot;, (gpointer) &amp; (module-&gt;supported)))</a>
<a name="ln249">    module-&gt;supported = _default_supported;</a>
<a name="ln250">  if(!g_module_symbol(module-&gt;module, &quot;dimension&quot;, (gpointer) &amp; (module-&gt;dimension)))</a>
<a name="ln251">    module-&gt;dimension = _default_storage_dimension;</a>
<a name="ln252">  if(!g_module_symbol(module-&gt;module, &quot;recommended_dimension&quot;, (gpointer) &amp; (module-&gt;recommended_dimension)))</a>
<a name="ln253">    module-&gt;recommended_dimension = _default_storage_dimension;</a>
<a name="ln254">  if(!g_module_symbol(module-&gt;module, &quot;export_dispatched&quot;, (gpointer) &amp; (module-&gt;export_dispatched)))</a>
<a name="ln255">    module-&gt;export_dispatched = _default_storage_nop;</a>
<a name="ln256">  if(!g_module_symbol(module-&gt;module, &quot;ask_user_confirmation&quot;, (gpointer) &amp; (module-&gt;ask_user_confirmation)))</a>
<a name="ln257">    module-&gt;ask_user_confirmation = NULL;</a>
<a name="ln258">#ifdef USE_LUA</a>
<a name="ln259">  {</a>
<a name="ln260">    char pseudo_type_name[1024];</a>
<a name="ln261">    snprintf(pseudo_type_name, sizeof(pseudo_type_name), &quot;dt_imageio_module_storage_data_%s&quot;,</a>
<a name="ln262">             module-&gt;plugin_name);</a>
<a name="ln263">    luaA_Type my_type</a>
<a name="ln264">        = luaA_type_add(darktable.lua_state.state, pseudo_type_name, module-&gt;params_size(module));</a>
<a name="ln265">    module-&gt;parameter_lua_type = dt_lua_init_type_type(darktable.lua_state.state, my_type);</a>
<a name="ln266">    luaA_struct_type(darktable.lua_state.state, my_type);</a>
<a name="ln267">    dt_lua_register_storage_type(darktable.lua_state.state, module, my_type);</a>
<a name="ln268">#endif</a>
<a name="ln269">    module-&gt;init(module);</a>
<a name="ln270">#ifdef USE_LUA</a>
<a name="ln271">    lua_pushcfunction(darktable.lua_state.state, dt_lua_type_member_luaautoc);</a>
<a name="ln272">    dt_lua_type_register_struct_type(darktable.lua_state.state, my_type);</a>
<a name="ln273">  }</a>
<a name="ln274">#endif</a>
<a name="ln275"> </a>
<a name="ln276">  return 0;</a>
<a name="ln277">error:</a>
<a name="ln278">  fprintf(stderr, &quot;[imageio_load_module] failed to open storage `%s': %s\n&quot;, plugin_name, g_module_error());</a>
<a name="ln279">  if(module-&gt;module) g_module_close(module-&gt;module);</a>
<a name="ln280">  return 1;</a>
<a name="ln281">}</a>
<a name="ln282"> </a>
<a name="ln283">static int dt_imageio_load_modules_storage(dt_imageio_t *iio)</a>
<a name="ln284">{</a>
<a name="ln285">  iio-&gt;plugins_storage = NULL;</a>
<a name="ln286">  dt_imageio_module_storage_t *module;</a>
<a name="ln287">  char plugindir[PATH_MAX] = { 0 }, plugin_name[256];</a>
<a name="ln288">  const gchar *d_name;</a>
<a name="ln289">  dt_loc_get_plugindir(plugindir, sizeof(plugindir));</a>
<a name="ln290">  g_strlcat(plugindir, &quot;/plugins/imageio/storage&quot;, sizeof(plugindir));</a>
<a name="ln291">  GDir *dir = g_dir_open(plugindir, 0, NULL);</a>
<a name="ln292">  if(!dir) return 1;</a>
<a name="ln293">  const int name_offset = strlen(SHARED_MODULE_PREFIX),</a>
<a name="ln294">            name_end = strlen(SHARED_MODULE_PREFIX) + strlen(SHARED_MODULE_SUFFIX);</a>
<a name="ln295">  while((d_name = g_dir_read_name(dir)))</a>
<a name="ln296">  {</a>
<a name="ln297">    // get lib*.so</a>
<a name="ln298">    if(!g_str_has_prefix(d_name, SHARED_MODULE_PREFIX)) continue;</a>
<a name="ln299">    if(!g_str_has_suffix(d_name, SHARED_MODULE_SUFFIX)) continue;</a>
<a name="ln300">    strncpy(plugin_name, d_name + name_offset, strlen(d_name) - name_end);</a>
<a name="ln301">    plugin_name[strlen(d_name) - name_end] = '\0';</a>
<a name="ln302">    module = (dt_imageio_module_storage_t *)malloc(sizeof(dt_imageio_module_storage_t));</a>
<a name="ln303">    gchar *libname = g_module_build_path(plugindir, (const gchar *)plugin_name);</a>
<a name="ln304">    if(dt_imageio_load_module_storage(module, libname, plugin_name))</a>
<a name="ln305">    {</a>
<a name="ln306">      free(module);</a>
<a name="ln307">      continue;</a>
<a name="ln308">    }</a>
<a name="ln309">    module-&gt;gui_data = NULL;</a>
<a name="ln310">    module-&gt;gui_init(module);</a>
<a name="ln311">    if(module-&gt;widget) g_object_ref(module-&gt;widget);</a>
<a name="ln312">    g_free(libname);</a>
<a name="ln313">    dt_imageio_insert_storage(module);</a>
<a name="ln314">  }</a>
<a name="ln315">  g_dir_close(dir);</a>
<a name="ln316">  return 0;</a>
<a name="ln317">}</a>
<a name="ln318"> </a>
<a name="ln319">void dt_imageio_init(dt_imageio_t *iio)</a>
<a name="ln320">{</a>
<a name="ln321">  iio-&gt;plugins_format = NULL;</a>
<a name="ln322">  iio-&gt;plugins_storage = NULL;</a>
<a name="ln323"> </a>
<a name="ln324">  dt_imageio_load_modules_format(iio);</a>
<a name="ln325">  dt_imageio_load_modules_storage(iio);</a>
<a name="ln326">}</a>
<a name="ln327"> </a>
<a name="ln328">void dt_imageio_cleanup(dt_imageio_t *iio)</a>
<a name="ln329">{</a>
<a name="ln330">  while(iio-&gt;plugins_format)</a>
<a name="ln331">  {</a>
<a name="ln332">    dt_imageio_module_format_t *module = (dt_imageio_module_format_t *)(iio-&gt;plugins_format-&gt;data);</a>
<a name="ln333">    module-&gt;gui_cleanup(module);</a>
<a name="ln334">    module-&gt;cleanup(module);</a>
<a name="ln335">    if(module-&gt;widget) g_object_unref(module-&gt;widget);</a>
<a name="ln336">    if(module-&gt;module) g_module_close(module-&gt;module);</a>
<a name="ln337">    free(module);</a>
<a name="ln338">    iio-&gt;plugins_format = g_list_delete_link(iio-&gt;plugins_format, iio-&gt;plugins_format);</a>
<a name="ln339">  }</a>
<a name="ln340">  while(iio-&gt;plugins_storage)</a>
<a name="ln341">  {</a>
<a name="ln342">    dt_imageio_module_storage_t *module = (dt_imageio_module_storage_t *)(iio-&gt;plugins_storage-&gt;data);</a>
<a name="ln343">    module-&gt;gui_cleanup(module);</a>
<a name="ln344">    if(module-&gt;widget) g_object_unref(module-&gt;widget);</a>
<a name="ln345">    if(module-&gt;module) g_module_close(module-&gt;module);</a>
<a name="ln346">    free(module);</a>
<a name="ln347">    iio-&gt;plugins_storage = g_list_delete_link(iio-&gt;plugins_storage, iio-&gt;plugins_storage);</a>
<a name="ln348">  }</a>
<a name="ln349">}</a>
<a name="ln350"> </a>
<a name="ln351">dt_imageio_module_format_t *dt_imageio_get_format()</a>
<a name="ln352">{</a>
<a name="ln353">  dt_imageio_t *iio = darktable.imageio;</a>
<a name="ln354">  gchar *format_name = dt_conf_get_string(&quot;plugins/lighttable/export/format_name&quot;);</a>
<a name="ln355">  dt_imageio_module_format_t *format = dt_imageio_get_format_by_name(format_name);</a>
<a name="ln356">  g_free(format_name);</a>
<a name="ln357">  // if the format from the config isn't available default to jpeg, if that's not available either just use</a>
<a name="ln358">  // the first we have</a>
<a name="ln359">  if(!format) format = dt_imageio_get_format_by_name(&quot;jpeg&quot;);</a>
<a name="ln360">  if(!format) format = iio-&gt;plugins_format-&gt;data;</a>
<a name="ln361">  return format;</a>
<a name="ln362">}</a>
<a name="ln363"> </a>
<a name="ln364">dt_imageio_module_storage_t *dt_imageio_get_storage()</a>
<a name="ln365">{</a>
<a name="ln366">  dt_imageio_t *iio = darktable.imageio;</a>
<a name="ln367">  gchar *storage_name = dt_conf_get_string(&quot;plugins/lighttable/export/storage_name&quot;);</a>
<a name="ln368">  dt_imageio_module_storage_t *storage = dt_imageio_get_storage_by_name(storage_name);</a>
<a name="ln369">  g_free(storage_name);</a>
<a name="ln370">  // if the storage from the config isn't available default to disk, if that's not available either just use</a>
<a name="ln371">  // the first we have</a>
<a name="ln372">  if(!storage) storage = dt_imageio_get_storage_by_name(&quot;disk&quot;);</a>
<a name="ln373">  if(!storage) storage = iio-&gt;plugins_storage-&gt;data;</a>
<a name="ln374">  return storage;</a>
<a name="ln375">}</a>
<a name="ln376"> </a>
<a name="ln377">dt_imageio_module_format_t *dt_imageio_get_format_by_name(const char *name)</a>
<a name="ln378">{</a>
<a name="ln379">  dt_imageio_t *iio = darktable.imageio;</a>
<a name="ln380">  GList *it = iio-&gt;plugins_format;</a>
<a name="ln381">  if(!name) return NULL;</a>
<a name="ln382">  while(it)</a>
<a name="ln383">  {</a>
<a name="ln384">    dt_imageio_module_format_t *module = (dt_imageio_module_format_t *)it-&gt;data;</a>
<a name="ln385">    if(!strcmp(module-&gt;plugin_name, name)) return module;</a>
<a name="ln386">    it = g_list_next(it);</a>
<a name="ln387">  }</a>
<a name="ln388">  return NULL;</a>
<a name="ln389">}</a>
<a name="ln390"> </a>
<a name="ln391">dt_imageio_module_storage_t *dt_imageio_get_storage_by_name(const char *name)</a>
<a name="ln392">{</a>
<a name="ln393">  dt_imageio_t *iio = darktable.imageio;</a>
<a name="ln394">  GList *it = iio-&gt;plugins_storage;</a>
<a name="ln395">  if(!name) return NULL;</a>
<a name="ln396">  while(it)</a>
<a name="ln397">  {</a>
<a name="ln398">    dt_imageio_module_storage_t *module = (dt_imageio_module_storage_t *)it-&gt;data;</a>
<a name="ln399">    if(!strcmp(module-&gt;plugin_name, name)) return module;</a>
<a name="ln400">    it = g_list_next(it);</a>
<a name="ln401">  }</a>
<a name="ln402">  return NULL;</a>
<a name="ln403">}</a>
<a name="ln404"> </a>
<a name="ln405">dt_imageio_module_format_t *dt_imageio_get_format_by_index(int index)</a>
<a name="ln406">{</a>
<a name="ln407">  dt_imageio_t *iio = darktable.imageio;</a>
<a name="ln408">  GList *it = g_list_nth(iio-&gt;plugins_format, index);</a>
<a name="ln409">  if(!it) it = iio-&gt;plugins_format;</a>
<a name="ln410">  return (dt_imageio_module_format_t *)it-&gt;data;</a>
<a name="ln411">}</a>
<a name="ln412"> </a>
<a name="ln413">dt_imageio_module_storage_t *dt_imageio_get_storage_by_index(int index)</a>
<a name="ln414">{</a>
<a name="ln415">  dt_imageio_t *iio = darktable.imageio;</a>
<a name="ln416">  GList *it = g_list_nth(iio-&gt;plugins_storage, index);</a>
<a name="ln417">  if(!it) it = iio-&gt;plugins_storage;</a>
<a name="ln418">  return (dt_imageio_module_storage_t *)it-&gt;data;</a>
<a name="ln419">}</a>
<a name="ln420"> </a>
<a name="ln421">int dt_imageio_get_index_of_format(dt_imageio_module_format_t *format)</a>
<a name="ln422">{</a>
<a name="ln423">  dt_imageio_t *iio = darktable.imageio;</a>
<a name="ln424">  return g_list_index(iio-&gt;plugins_format, format);</a>
<a name="ln425">}</a>
<a name="ln426">int dt_imageio_get_index_of_storage(dt_imageio_module_storage_t *storage)</a>
<a name="ln427">{</a>
<a name="ln428">  dt_imageio_t *iio = darktable.imageio;</a>
<a name="ln429">  return g_list_index(iio-&gt;plugins_storage, storage);</a>
<a name="ln430">}</a>
<a name="ln431"> </a>
<a name="ln432">void dt_imageio_insert_storage(dt_imageio_module_storage_t *storage)</a>
<a name="ln433">{</a>
<a name="ln434">  darktable.imageio-&gt;plugins_storage</a>
<a name="ln435">      = g_list_insert_sorted(darktable.imageio-&gt;plugins_storage, storage, dt_imageio_sort_modules_storage);</a>
<a name="ln436">  dt_control_signal_raise(darktable.signals, DT_SIGNAL_IMAGEIO_STORAGE_CHANGE);</a>
<a name="ln437">}</a>
<a name="ln438"> </a>
<a name="ln439">// modelines: These editor modelines have been set for all relevant files by tools/update_modelines.sh</a>
<a name="ln440">// vim: shiftwidth=2 expandtab tabstop=2 cindent</a>
<a name="ln441">// kate: tab-indents: off; indent-width 2; replace-tabs on; indent-mode cstyle; remove-trailing-spaces modified;</a>

</code></pre>
<div class="balloon" rel="69"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v522/" target="_blank">V522</a> Dereferencing of the null pointer 'module' might take place. The potential null pointer is passed into 'dt_imageio_load_module_format' function. Inspect the first argument. Check lines: 69, 168, 166.</p></div>
<div class="balloon" rel="205"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v522/" target="_blank">V522</a> Dereferencing of the null pointer 'module' might take place. The potential null pointer is passed into 'dt_imageio_load_module_storage' function. Inspect the first argument. Check lines: 205, 304, 302.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
