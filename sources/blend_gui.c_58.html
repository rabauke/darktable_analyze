
<html>
<head>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>
<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2">    This file is part of darktable,</a>
<a name="ln3">    copyright (c) 2009--2012 johannes hanika.</a>
<a name="ln4">    copyright (c) 2011 Henrik Andersson.</a>
<a name="ln5">    copyright (c) 2012--2013 Ulrich Pegelow</a>
<a name="ln6"> </a>
<a name="ln7">    darktable is free software: you can redistribute it and/or modify</a>
<a name="ln8">    it under the terms of the GNU General Public License as published by</a>
<a name="ln9">    the Free Software Foundation, either version 3 of the License, or</a>
<a name="ln10">    (at your option) any later version.</a>
<a name="ln11"> </a>
<a name="ln12">    darktable is distributed in the hope that it will be useful,</a>
<a name="ln13">    but WITHOUT ANY WARRANTY; without even the implied warranty of</a>
<a name="ln14">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</a>
<a name="ln15">    GNU General Public License for more details.</a>
<a name="ln16"> </a>
<a name="ln17">    You should have received a copy of the GNU General Public License</a>
<a name="ln18">    along with darktable.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</a>
<a name="ln19">*/</a>
<a name="ln20">#include &quot;bauhaus/bauhaus.h&quot;</a>
<a name="ln21">#include &quot;common/debug.h&quot;</a>
<a name="ln22">#include &quot;common/dtpthread.h&quot;</a>
<a name="ln23">#include &quot;common/opencl.h&quot;</a>
<a name="ln24">#include &quot;control/control.h&quot;</a>
<a name="ln25">#include &quot;develop/blend.h&quot;</a>
<a name="ln26">#include &quot;develop/develop.h&quot;</a>
<a name="ln27">#include &quot;develop/imageop.h&quot;</a>
<a name="ln28">#include &quot;develop/masks.h&quot;</a>
<a name="ln29">#include &quot;develop/tiling.h&quot;</a>
<a name="ln30">#include &quot;dtgtk/button.h&quot;</a>
<a name="ln31">#include &quot;dtgtk/gradientslider.h&quot;</a>
<a name="ln32">#include &quot;gui/accelerators.h&quot;</a>
<a name="ln33">#include &quot;gui/gtk.h&quot;</a>
<a name="ln34">#include &quot;gui/presets.h&quot;</a>
<a name="ln35"> </a>
<a name="ln36">#include &lt;assert.h&gt;</a>
<a name="ln37">#include &lt;gmodule.h&gt;</a>
<a name="ln38">#include &lt;math.h&gt;</a>
<a name="ln39">#include &lt;stdlib.h&gt;</a>
<a name="ln40">#include &lt;string.h&gt;</a>
<a name="ln41">#include &lt;strings.h&gt;</a>
<a name="ln42"> </a>
<a name="ln43">#define CLAMP_RANGE(x, y, z) (CLAMP(x, y, z))</a>
<a name="ln44">#define NEUTRAL_GRAY 0.5</a>
<a name="ln45"> </a>
<a name="ln46">typedef enum _iop_gui_blendif_channel_t</a>
<a name="ln47">{</a>
<a name="ln48">  ch_L = 0,</a>
<a name="ln49">  ch_a = 1,</a>
<a name="ln50">  ch_b = 2,</a>
<a name="ln51">  ch_gray = 0,</a>
<a name="ln52">  ch_red = 1,</a>
<a name="ln53">  ch_green = 2,</a>
<a name="ln54">  ch_blue = 3,</a>
<a name="ln55">  ch_max = 4</a>
<a name="ln56">} _iop_gui_blendif_channel_t;</a>
<a name="ln57"> </a>
<a name="ln58"> </a>
<a name="ln59"> </a>
<a name="ln60">static const dt_iop_gui_blendif_colorstop_t _gradient_L[]</a>
<a name="ln61">    = { { 0.0f, { 0, 0, 0, 1.0 } },</a>
<a name="ln62">        { 0.5f, { NEUTRAL_GRAY / 2, NEUTRAL_GRAY / 2, NEUTRAL_GRAY / 2, 1.0 } },</a>
<a name="ln63">        { 1.0f, { NEUTRAL_GRAY, NEUTRAL_GRAY, NEUTRAL_GRAY, 1.0 } } };</a>
<a name="ln64"> </a>
<a name="ln65">static const dt_iop_gui_blendif_colorstop_t _gradient_a[]</a>
<a name="ln66">    = { { 0.0f, { 0, 0.34 * NEUTRAL_GRAY * 2, 0.27 * NEUTRAL_GRAY * 2, 1.0 } },</a>
<a name="ln67">        { 0.5f, { NEUTRAL_GRAY, NEUTRAL_GRAY, NEUTRAL_GRAY, 1.0 } },</a>
<a name="ln68">        { 1.0f, { 0.53 * NEUTRAL_GRAY * 2, 0.08 * NEUTRAL_GRAY * 2, 0.28 * NEUTRAL_GRAY * 2, 1.0 } } };</a>
<a name="ln69"> </a>
<a name="ln70">static const dt_iop_gui_blendif_colorstop_t _gradient_b[]</a>
<a name="ln71">    = { { 0.0f, { 0, 0.27 * NEUTRAL_GRAY * 2, 0.58 * NEUTRAL_GRAY * 2, 1.0 } },</a>
<a name="ln72">        { 0.5f, { NEUTRAL_GRAY, NEUTRAL_GRAY, NEUTRAL_GRAY, 1.0 } },</a>
<a name="ln73">        { 1.0f, { 0.81 * NEUTRAL_GRAY * 2, 0.66 * NEUTRAL_GRAY * 2, 0, 1.0 } } };</a>
<a name="ln74"> </a>
<a name="ln75">static const dt_iop_gui_blendif_colorstop_t _gradient_gray[]</a>
<a name="ln76">    = { { 0.0f, { 0, 0, 0, 1.0 } },</a>
<a name="ln77">        { 0.5f, { NEUTRAL_GRAY / 2, NEUTRAL_GRAY / 2, NEUTRAL_GRAY / 2, 1.0 } },</a>
<a name="ln78">        { 1.0f, { NEUTRAL_GRAY, NEUTRAL_GRAY, NEUTRAL_GRAY, 1.0 } } };</a>
<a name="ln79"> </a>
<a name="ln80">static const dt_iop_gui_blendif_colorstop_t _gradient_red[] = { { 0.0f, { 0, 0, 0, 1.0 } },</a>
<a name="ln81">                                                                { 0.5f, { NEUTRAL_GRAY / 2, 0, 0, 1.0 } },</a>
<a name="ln82">                                                                { 1.0f, { NEUTRAL_GRAY, 0, 0, 1.0 } } };</a>
<a name="ln83"> </a>
<a name="ln84">static const dt_iop_gui_blendif_colorstop_t _gradient_green[] = { { 0.0f, { 0, 0, 0, 1.0 } },</a>
<a name="ln85">                                                                  { 0.5f, { 0, NEUTRAL_GRAY / 2, 0, 1.0 } },</a>
<a name="ln86">                                                                  { 1.0f, { 0, NEUTRAL_GRAY, 0, 1.0 } } };</a>
<a name="ln87"> </a>
<a name="ln88">static const dt_iop_gui_blendif_colorstop_t _gradient_blue[] = { { 0.0f, { 0, 0, 0, 1.0 } },</a>
<a name="ln89">                                                                 { 0.5f, { 0, 0, NEUTRAL_GRAY / 2, 1.0 } },</a>
<a name="ln90">                                                                 { 1.0f, { 0, 0, NEUTRAL_GRAY, 1.0 } } };</a>
<a name="ln91"> </a>
<a name="ln92">static const dt_iop_gui_blendif_colorstop_t _gradient_chroma[]</a>
<a name="ln93">    = { { 0.0f, { NEUTRAL_GRAY, NEUTRAL_GRAY, NEUTRAL_GRAY, 1.0 } },</a>
<a name="ln94">        { 0.5f, { NEUTRAL_GRAY, NEUTRAL_GRAY / 2, NEUTRAL_GRAY, 1.0 } },</a>
<a name="ln95">        { 1.0f, { NEUTRAL_GRAY, 0, NEUTRAL_GRAY, 1.0 } } };</a>
<a name="ln96"> </a>
<a name="ln97">static const dt_iop_gui_blendif_colorstop_t _gradient_hue[] = {</a>
<a name="ln98">  { 0.0f, { 1.00f * 1.5f * NEUTRAL_GRAY, 0.68f * 1.5f * NEUTRAL_GRAY, 0.78f * 1.5f * NEUTRAL_GRAY, 1.0 } },</a>
<a name="ln99">  { 0.166f, { 0.95f * 1.5f * NEUTRAL_GRAY, 0.73f * 1.5f * NEUTRAL_GRAY, 0.56f * 1.5f * NEUTRAL_GRAY, 1.0 } },</a>
<a name="ln100">  { 0.333f, { 0.71f * 1.5f * NEUTRAL_GRAY, 0.81f * 1.5f * NEUTRAL_GRAY, 0.55f * 1.5f * NEUTRAL_GRAY, 1.0 } },</a>
<a name="ln101">  { 0.500f, { 0.45f * 1.5f * NEUTRAL_GRAY, 0.85f * 1.5f * NEUTRAL_GRAY, 0.77f * 1.5f * NEUTRAL_GRAY, 1.0 } },</a>
<a name="ln102">  { 0.666f, { 0.49f * 1.5f * NEUTRAL_GRAY, 0.82f * 1.5f * NEUTRAL_GRAY, 1.00f * 1.5f * NEUTRAL_GRAY, 1.0 } },</a>
<a name="ln103">  { 0.833f, { 0.82f * 1.5f * NEUTRAL_GRAY, 0.74f * 1.5f * NEUTRAL_GRAY, 1.00f * 1.5f * NEUTRAL_GRAY, 1.0 } },</a>
<a name="ln104">  { 1.0f, { 1.00f * 1.5f * NEUTRAL_GRAY, 0.68f * 1.5f * NEUTRAL_GRAY, 0.78f * 1.5f * NEUTRAL_GRAY, 1.0 } }</a>
<a name="ln105">};</a>
<a name="ln106"> </a>
<a name="ln107">static const dt_iop_gui_blendif_colorstop_t _gradient_HUE[]</a>
<a name="ln108">    = { { 0.0f, { NEUTRAL_GRAY, 0, 0, 1.0 } },</a>
<a name="ln109">        { 0.166f, { NEUTRAL_GRAY, NEUTRAL_GRAY, 0, 1.0 } },</a>
<a name="ln110">        { 0.332f, { 0, NEUTRAL_GRAY, 0, 1.0 } },</a>
<a name="ln111">        { 0.498f, { 0, NEUTRAL_GRAY, NEUTRAL_GRAY, 1.0 } },</a>
<a name="ln112">        { 0.664f, { 0, 0, NEUTRAL_GRAY, 1.0 } },</a>
<a name="ln113">        { 0.830f, { NEUTRAL_GRAY, 0, NEUTRAL_GRAY, 1.0 } },</a>
<a name="ln114">        { 1.0f, { NEUTRAL_GRAY, 0, 0, 1.0 } } };</a>
<a name="ln115"> </a>
<a name="ln116"> </a>
<a name="ln117">static inline void _RGB_2_HSL(const float *RGB, float *HSL)</a>
<a name="ln118">{</a>
<a name="ln119">  float H, S, L;</a>
<a name="ln120"> </a>
<a name="ln121">  float R = RGB[0];</a>
<a name="ln122">  float G = RGB[1];</a>
<a name="ln123">  float B = RGB[2];</a>
<a name="ln124"> </a>
<a name="ln125">  float var_Min = fminf(R, fminf(G, B));</a>
<a name="ln126">  float var_Max = fmaxf(R, fmaxf(G, B));</a>
<a name="ln127">  float del_Max = var_Max - var_Min;</a>
<a name="ln128"> </a>
<a name="ln129">  L = (var_Max + var_Min) / 2.0f;</a>
<a name="ln130"> </a>
<a name="ln131">  if(del_Max == 0.0f)</a>
<a name="ln132">  {</a>
<a name="ln133">    H = 0.0f;</a>
<a name="ln134">    S = 0.0f;</a>
<a name="ln135">  }</a>
<a name="ln136">  else</a>
<a name="ln137">  {</a>
<a name="ln138">    if(L &lt; 0.5f)</a>
<a name="ln139">      S = del_Max / (var_Max + var_Min);</a>
<a name="ln140">    else</a>
<a name="ln141">      S = del_Max / (2.0f - var_Max - var_Min);</a>
<a name="ln142"> </a>
<a name="ln143">    float del_R = (((var_Max - R) / 6.0f) + (del_Max / 2.0f)) / del_Max;</a>
<a name="ln144">    float del_G = (((var_Max - G) / 6.0f) + (del_Max / 2.0f)) / del_Max;</a>
<a name="ln145">    float del_B = (((var_Max - B) / 6.0f) + (del_Max / 2.0f)) / del_Max;</a>
<a name="ln146"> </a>
<a name="ln147">    if(R == var_Max)</a>
<a name="ln148">      H = del_B - del_G;</a>
<a name="ln149">    else if(G == var_Max)</a>
<a name="ln150">      H = (1.0f / 3.0f) + del_R - del_B;</a>
<a name="ln151">    else if(B == var_Max)</a>
<a name="ln152">      H = (2.0f / 3.0f) + del_G - del_R;</a>
<a name="ln153">    else</a>
<a name="ln154">      H = 0.0f; // make GCC happy</a>
<a name="ln155"> </a>
<a name="ln156">    if(H &lt; 0.0f) H += 1.0f;</a>
<a name="ln157">    if(H &gt; 1.0f) H -= 1.0f;</a>
<a name="ln158">  }</a>
<a name="ln159"> </a>
<a name="ln160">  HSL[0] = H;</a>
<a name="ln161">  HSL[1] = S;</a>
<a name="ln162">  HSL[2] = L;</a>
<a name="ln163">}</a>
<a name="ln164"> </a>
<a name="ln165"> </a>
<a name="ln166">static inline void _Lab_2_LCH(const float *Lab, float *LCH)</a>
<a name="ln167">{</a>
<a name="ln168">  float var_H = atan2f(Lab[2], Lab[1]);</a>
<a name="ln169"> </a>
<a name="ln170">  if(var_H &gt; 0.0f)</a>
<a name="ln171">    var_H = var_H / (2.0f * M_PI);</a>
<a name="ln172">  else</a>
<a name="ln173">    var_H = 1.0f - fabs(var_H) / (2.0f * M_PI);</a>
<a name="ln174"> </a>
<a name="ln175">  LCH[0] = Lab[0];</a>
<a name="ln176">  LCH[1] = sqrtf(Lab[1] * Lab[1] + Lab[2] * Lab[2]);</a>
<a name="ln177">  LCH[2] = var_H;</a>
<a name="ln178">}</a>
<a name="ln179"> </a>
<a name="ln180"> </a>
<a name="ln181">static void _blendif_scale(dt_iop_colorspace_type_t cst, const float *in, float *out)</a>
<a name="ln182">{</a>
<a name="ln183">  float temp[4];</a>
<a name="ln184"> </a>
<a name="ln185">  switch(cst)</a>
<a name="ln186">  {</a>
<a name="ln187">    case iop_cs_Lab:</a>
<a name="ln188">      _Lab_2_LCH(in, temp);</a>
<a name="ln189">      out[0] = CLAMP_RANGE(in[0] / 100.0f, 0.0f, 1.0f);</a>
<a name="ln190">      out[1] = CLAMP_RANGE((in[1] + 128.0f) / 256.0f, 0.0f, 1.0f);</a>
<a name="ln191">      out[2] = CLAMP_RANGE((in[2] + 128.0f) / 256.0f, 0.0f, 1.0f);</a>
<a name="ln192">      out[3] = CLAMP_RANGE(temp[1] / (128.0f * sqrtf(2.0f)), 0.0f, 1.0f);</a>
<a name="ln193">      out[4] = CLAMP_RANGE(temp[2], 0.0f, 1.0f);</a>
<a name="ln194">      out[5] = out[6] = out[7] = -1;</a>
<a name="ln195">      break;</a>
<a name="ln196">    case iop_cs_rgb:</a>
<a name="ln197">      _RGB_2_HSL(in, temp);</a>
<a name="ln198">      out[0] = CLAMP_RANGE(0.3f * in[0] + 0.59f * in[1] + 0.11f * in[2], 0.0f, 1.0f);</a>
<a name="ln199">      out[1] = CLAMP_RANGE(in[0], 0.0f, 1.0f);</a>
<a name="ln200">      out[2] = CLAMP_RANGE(in[1], 0.0f, 1.0f);</a>
<a name="ln201">      out[3] = CLAMP_RANGE(in[2], 0.0f, 1.0f);</a>
<a name="ln202">      out[4] = CLAMP_RANGE(temp[0], 0.0f, 1.0f);</a>
<a name="ln203">      out[5] = CLAMP_RANGE(temp[1], 0.0f, 1.0f);</a>
<a name="ln204">      out[6] = CLAMP_RANGE(temp[2], 0.0f, 1.0f);</a>
<a name="ln205">      out[7] = -1;</a>
<a name="ln206">      break;</a>
<a name="ln207">    default:</a>
<a name="ln208">      out[0] = out[1] = out[2] = out[3] = out[4] = out[5] = out[6] = out[7] = -1.0f;</a>
<a name="ln209">  }</a>
<a name="ln210">}</a>
<a name="ln211"> </a>
<a name="ln212">static void _blendif_cook(dt_iop_colorspace_type_t cst, const float *in, float *out)</a>
<a name="ln213">{</a>
<a name="ln214">  float temp[4];</a>
<a name="ln215"> </a>
<a name="ln216">  switch(cst)</a>
<a name="ln217">  {</a>
<a name="ln218">    case iop_cs_Lab:</a>
<a name="ln219">      _Lab_2_LCH(in, temp);</a>
<a name="ln220">      out[0] = in[0];</a>
<a name="ln221">      out[1] = in[1];</a>
<a name="ln222">      out[2] = in[2];</a>
<a name="ln223">      out[3] = temp[1] / (128.0f * sqrtf(2.0f)) * 100.0f;</a>
<a name="ln224">      out[4] = temp[2] * 360.0f;</a>
<a name="ln225">      out[5] = out[6] = out[7] = -1;</a>
<a name="ln226">      break;</a>
<a name="ln227">    case iop_cs_rgb:</a>
<a name="ln228">      _RGB_2_HSL(in, temp);</a>
<a name="ln229">      out[0] = (0.3f * in[0] + 0.59f * in[1] + 0.11f * in[2]) * 255.0f;</a>
<a name="ln230">      out[1] = in[0] * 255.0f;</a>
<a name="ln231">      out[2] = in[1] * 255.0f;</a>
<a name="ln232">      out[3] = in[2] * 255.0f;</a>
<a name="ln233">      out[4] = temp[0] * 360.0f;</a>
<a name="ln234">      out[5] = temp[1] * 100.0f;</a>
<a name="ln235">      out[6] = temp[2] * 100.0f;</a>
<a name="ln236">      out[7] = -1;</a>
<a name="ln237">      break;</a>
<a name="ln238">    default:</a>
<a name="ln239">      out[0] = out[1] = out[2] = out[3] = out[4] = out[5] = out[6] = out[7] = -1.0f;</a>
<a name="ln240">  }</a>
<a name="ln241">}</a>
<a name="ln242"> </a>
<a name="ln243"> </a>
<a name="ln244">static void _blendif_scale_print_L(float value, char *string, int n)</a>
<a name="ln245">{</a>
<a name="ln246">  snprintf(string, n, &quot;%-4.0f&quot;, value * 100.0f);</a>
<a name="ln247">}</a>
<a name="ln248"> </a>
<a name="ln249">static void _blendif_scale_print_ab(float value, char *string, int n)</a>
<a name="ln250">{</a>
<a name="ln251">  snprintf(string, n, &quot;%-4.0f&quot;, value * 256.0f - 128.0f);</a>
<a name="ln252">}</a>
<a name="ln253"> </a>
<a name="ln254">static void _blendif_scale_print_rgb(float value, char *string, int n)</a>
<a name="ln255">{</a>
<a name="ln256">  snprintf(string, n, &quot;%-4.0f&quot;, value * 255.0f);</a>
<a name="ln257">}</a>
<a name="ln258"> </a>
<a name="ln259">static void _blendif_scale_print_hue(float value, char *string, int n)</a>
<a name="ln260">{</a>
<a name="ln261">  snprintf(string, n, &quot;%-4.0f&quot;, value * 360.0f);</a>
<a name="ln262">}</a>
<a name="ln263"> </a>
<a name="ln264">static void _blendif_scale_print_default(float value, char *string, int n)</a>
<a name="ln265">{</a>
<a name="ln266">  snprintf(string, n, &quot;%-4.0f&quot;, value * 100.0f);</a>
<a name="ln267">}</a>
<a name="ln268"> </a>
<a name="ln269">static void _blendop_masks_mode_callback(GtkWidget *combo, dt_iop_gui_blend_data_t *data)</a>
<a name="ln270">{</a>
<a name="ln271">  const unsigned int mask_mode = GPOINTER_TO_UINT(</a>
<a name="ln272">      g_list_nth_data(data-&gt;masks_modes, dt_bauhaus_combobox_get(data-&gt;masks_modes_combo)));</a>
<a name="ln273"> </a>
<a name="ln274">  data-&gt;module-&gt;blend_params-&gt;mask_mode = mask_mode;</a>
<a name="ln275"> </a>
<a name="ln276">  if(mask_mode &amp; DEVELOP_MASK_ENABLED)</a>
<a name="ln277">  {</a>
<a name="ln278">    gtk_widget_show(GTK_WIDGET(data-&gt;top_box));</a>
<a name="ln279">  }</a>
<a name="ln280">  else</a>
<a name="ln281">  {</a>
<a name="ln282">    gtk_widget_hide(GTK_WIDGET(data-&gt;top_box));</a>
<a name="ln283">  }</a>
<a name="ln284"> </a>
<a name="ln285">  dt_iop_set_mask_mode(data-&gt;module, mask_mode);</a>
<a name="ln286"> </a>
<a name="ln287">  if((mask_mode &amp; DEVELOP_MASK_ENABLED)</a>
<a name="ln288">     &amp;&amp; ((data-&gt;masks_inited &amp;&amp; (mask_mode &amp; DEVELOP_MASK_MASK))</a>
<a name="ln289">         || (data-&gt;blendif_inited &amp;&amp; (mask_mode &amp; DEVELOP_MASK_CONDITIONAL))))</a>
<a name="ln290">  {</a>
<a name="ln291">    if(data-&gt;blendif_inited &amp;&amp; (mask_mode &amp; DEVELOP_MASK_CONDITIONAL))</a>
<a name="ln292">    {</a>
<a name="ln293">      dt_bauhaus_combobox_set(data-&gt;masks_combine_combo,</a>
<a name="ln294">                              g_list_index(data-&gt;masks_combine,</a>
<a name="ln295">                                           GUINT_TO_POINTER(data-&gt;module-&gt;blend_params-&gt;mask_combine</a>
<a name="ln296">                                                            &amp; (DEVELOP_COMBINE_INV | DEVELOP_COMBINE_INCL))));</a>
<a name="ln297">      gtk_widget_hide(GTK_WIDGET(data-&gt;masks_invert_combo));</a>
<a name="ln298">      gtk_widget_show(GTK_WIDGET(data-&gt;masks_combine_combo));</a>
<a name="ln299">    }</a>
<a name="ln300">    else</a>
<a name="ln301">    {</a>
<a name="ln302">      dt_bauhaus_combobox_set(</a>
<a name="ln303">          data-&gt;masks_invert_combo,</a>
<a name="ln304">          g_list_index(data-&gt;masks_invert,</a>
<a name="ln305">                       GUINT_TO_POINTER(data-&gt;module-&gt;blend_params-&gt;mask_combine &amp; DEVELOP_COMBINE_INV)));</a>
<a name="ln306">      gtk_widget_show(GTK_WIDGET(data-&gt;masks_invert_combo));</a>
<a name="ln307">      gtk_widget_hide(GTK_WIDGET(data-&gt;masks_combine_combo));</a>
<a name="ln308">    }</a>
<a name="ln309"> </a>
<a name="ln310">    /*</a>
<a name="ln311">     * if this iop is operating in raw space, it has only 1 channel per pixel,</a>
<a name="ln312">     * thus there is no alpha channel where we would normally store mask</a>
<a name="ln313">     * that would get displayed if following button have been pressed.</a>
<a name="ln314">     *</a>
<a name="ln315">     * TODO: revisit if/once there semi-raw iops (e.g temperature) with blending</a>
<a name="ln316">     */</a>
<a name="ln317">    if(dt_iop_module_colorspace(data-&gt;module) == iop_cs_RAW)</a>
<a name="ln318">    {</a>
<a name="ln319">      data-&gt;module-&gt;request_mask_display = DT_DEV_PIXELPIPE_DISPLAY_NONE;</a>
<a name="ln320">      dtgtk_button_set_active(DTGTK_BUTTON(data-&gt;showmask), 0);</a>
<a name="ln321">      gtk_widget_hide(GTK_WIDGET(data-&gt;showmask));</a>
<a name="ln322"> </a>
<a name="ln323">      // disable also guided-filters on RAW based color space</a>
<a name="ln324">      gtk_widget_set_sensitive(data-&gt;masks_feathering_guide_combo, 0);</a>
<a name="ln325">      gtk_widget_hide(GTK_WIDGET(data-&gt;masks_feathering_guide_combo));</a>
<a name="ln326">      gtk_widget_set_sensitive(data-&gt;feathering_radius_slider, 0);</a>
<a name="ln327">      gtk_widget_hide(GTK_WIDGET(data-&gt;feathering_radius_slider));</a>
<a name="ln328">      gtk_widget_set_sensitive(data-&gt;brightness_slider, 0);</a>
<a name="ln329">      gtk_widget_hide(GTK_WIDGET(data-&gt;brightness_slider));</a>
<a name="ln330">      gtk_widget_set_sensitive(data-&gt;contrast_slider, 0);</a>
<a name="ln331">      gtk_widget_hide(GTK_WIDGET(data-&gt;contrast_slider));</a>
<a name="ln332">    }</a>
<a name="ln333">    else</a>
<a name="ln334">    {</a>
<a name="ln335">      gtk_widget_show(GTK_WIDGET(data-&gt;showmask));</a>
<a name="ln336">    }</a>
<a name="ln337"> </a>
<a name="ln338">    gtk_widget_show(GTK_WIDGET(data-&gt;bottom_box));</a>
<a name="ln339">  }</a>
<a name="ln340">  else</a>
<a name="ln341">  {</a>
<a name="ln342">    data-&gt;module-&gt;request_mask_display = DT_DEV_PIXELPIPE_DISPLAY_NONE;</a>
<a name="ln343">    dtgtk_button_set_active(DTGTK_BUTTON(data-&gt;showmask), 0);</a>
<a name="ln344">    data-&gt;module-&gt;suppress_mask = 0;</a>
<a name="ln345">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(data-&gt;suppress), 0);</a>
<a name="ln346"> </a>
<a name="ln347">    gtk_widget_hide(GTK_WIDGET(data-&gt;bottom_box));</a>
<a name="ln348">  }</a>
<a name="ln349"> </a>
<a name="ln350">  if(data-&gt;masks_inited &amp;&amp; (mask_mode &amp; DEVELOP_MASK_MASK))</a>
<a name="ln351">  {</a>
<a name="ln352">    gtk_widget_show(GTK_WIDGET(data-&gt;masks_box));</a>
<a name="ln353">  }</a>
<a name="ln354">  else if(data-&gt;masks_inited)</a>
<a name="ln355">  {</a>
<a name="ln356">    dt_masks_set_edit_mode(data-&gt;module, DT_MASKS_EDIT_OFF);</a>
<a name="ln357">    gtk_widget_hide(GTK_WIDGET(data-&gt;masks_box));</a>
<a name="ln358">  }</a>
<a name="ln359">  else</a>
<a name="ln360">  {</a>
<a name="ln361">    gtk_widget_hide(GTK_WIDGET(data-&gt;masks_box));</a>
<a name="ln362">  }</a>
<a name="ln363"> </a>
<a name="ln364">  if(data-&gt;raster_inited &amp;&amp; (mask_mode &amp; DEVELOP_MASK_RASTER))</a>
<a name="ln365">  {</a>
<a name="ln366">    gtk_widget_show(GTK_WIDGET(data-&gt;raster_box));</a>
<a name="ln367">  }</a>
<a name="ln368">  else if(data-&gt;raster_inited)</a>
<a name="ln369">  {</a>
<a name="ln370">//     dt_masks_set_edit_mode(data-&gt;module, DT_MASKS_EDIT_OFF);</a>
<a name="ln371">    gtk_widget_hide(GTK_WIDGET(data-&gt;raster_box));</a>
<a name="ln372">  }</a>
<a name="ln373">  else</a>
<a name="ln374">  {</a>
<a name="ln375">    gtk_widget_hide(GTK_WIDGET(data-&gt;raster_box));</a>
<a name="ln376">  }</a>
<a name="ln377"> </a>
<a name="ln378">  if(data-&gt;blendif_inited &amp;&amp; (mask_mode &amp; DEVELOP_MASK_CONDITIONAL))</a>
<a name="ln379">  {</a>
<a name="ln380">    gtk_widget_show(GTK_WIDGET(data-&gt;blendif_box));</a>
<a name="ln381">  }</a>
<a name="ln382">  else if(data-&gt;blendif_inited)</a>
<a name="ln383">  {</a>
<a name="ln384">    /* switch off color picker - only if it was requested by blendif */</a>
<a name="ln385">    if(data-&gt;module-&gt;request_color_pick == DT_REQUEST_COLORPICK_BLEND)</a>
<a name="ln386">    {</a>
<a name="ln387">      data-&gt;module-&gt;request_color_pick = DT_REQUEST_COLORPICK_OFF;</a>
<a name="ln388">      gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(data-&gt;colorpicker), 0);</a>
<a name="ln389">    }</a>
<a name="ln390"> </a>
<a name="ln391">    gtk_widget_hide(GTK_WIDGET(data-&gt;blendif_box));</a>
<a name="ln392">  }</a>
<a name="ln393">  else</a>
<a name="ln394">  {</a>
<a name="ln395">    gtk_widget_hide(GTK_WIDGET(data-&gt;blendif_box));</a>
<a name="ln396">  }</a>
<a name="ln397"> </a>
<a name="ln398">  dt_dev_add_history_item(darktable.develop, data-&gt;module, TRUE);</a>
<a name="ln399">}</a>
<a name="ln400"> </a>
<a name="ln401"> </a>
<a name="ln402">static void _blendop_blend_mode_callback(GtkWidget *combo, dt_iop_gui_blend_data_t *data)</a>
<a name="ln403">{</a>
<a name="ln404">  data-&gt;module-&gt;blend_params-&gt;blend_mode = GPOINTER_TO_UINT(</a>
<a name="ln405">      g_list_nth_data(data-&gt;blend_modes, dt_bauhaus_combobox_get(data-&gt;blend_modes_combo)));</a>
<a name="ln406">  dt_dev_add_history_item(darktable.develop, data-&gt;module, TRUE);</a>
<a name="ln407">}</a>
<a name="ln408"> </a>
<a name="ln409">static void _blendop_masks_combine_callback(GtkWidget *combo, dt_iop_gui_blend_data_t *data)</a>
<a name="ln410">{</a>
<a name="ln411">  const unsigned combine = GPOINTER_TO_UINT(</a>
<a name="ln412">      g_list_nth_data(data-&gt;masks_combine, dt_bauhaus_combobox_get(data-&gt;masks_combine_combo)));</a>
<a name="ln413">  data-&gt;module-&gt;blend_params-&gt;mask_combine &amp;= ~(DEVELOP_COMBINE_INV | DEVELOP_COMBINE_INCL);</a>
<a name="ln414">  data-&gt;module-&gt;blend_params-&gt;mask_combine |= combine;</a>
<a name="ln415">  dt_dev_add_history_item(darktable.develop, data-&gt;module, TRUE);</a>
<a name="ln416">}</a>
<a name="ln417"> </a>
<a name="ln418">static void _blendop_masks_invert_callback(GtkWidget *combo, dt_iop_gui_blend_data_t *data)</a>
<a name="ln419">{</a>
<a name="ln420">  unsigned int invert = GPOINTER_TO_UINT(g_list_nth_data(data-&gt;masks_invert,</a>
<a name="ln421">                                                         dt_bauhaus_combobox_get(data-&gt;masks_invert_combo)))</a>
<a name="ln422">                        &amp; DEVELOP_COMBINE_INV;</a>
<a name="ln423">  if(invert)</a>
<a name="ln424">    data-&gt;module-&gt;blend_params-&gt;mask_combine |= DEVELOP_COMBINE_INV;</a>
<a name="ln425">  else</a>
<a name="ln426">    data-&gt;module-&gt;blend_params-&gt;mask_combine &amp;= ~DEVELOP_COMBINE_INV;</a>
<a name="ln427">  dt_dev_add_history_item(darktable.develop, data-&gt;module, TRUE);</a>
<a name="ln428">}</a>
<a name="ln429"> </a>
<a name="ln430">static void _blendop_opacity_callback(GtkWidget *slider, dt_iop_gui_blend_data_t *data)</a>
<a name="ln431">{</a>
<a name="ln432">  data-&gt;module-&gt;blend_params-&gt;opacity = dt_bauhaus_slider_get(slider);</a>
<a name="ln433">  dt_dev_add_history_item(darktable.develop, data-&gt;module, TRUE);</a>
<a name="ln434">}</a>
<a name="ln435"> </a>
<a name="ln436">static void _blendop_blendif_feathering_radius_callback(GtkWidget *slider, dt_iop_gui_blend_data_t *data)</a>
<a name="ln437">{</a>
<a name="ln438">  data-&gt;module-&gt;blend_params-&gt;feathering_radius = dt_bauhaus_slider_get(slider);</a>
<a name="ln439">  dt_dev_add_history_item(darktable.develop, data-&gt;module, TRUE);</a>
<a name="ln440">}</a>
<a name="ln441"> </a>
<a name="ln442">static void _blendop_masks_feathering_guide_callback(GtkWidget *combo, dt_iop_gui_blend_data_t *data)</a>
<a name="ln443">{</a>
<a name="ln444">  data-&gt;module-&gt;blend_params-&gt;feathering_guide = GPOINTER_TO_UINT(</a>
<a name="ln445">      g_list_nth_data(data-&gt;masks_feathering_guide, dt_bauhaus_combobox_get(data-&gt;masks_feathering_guide_combo)));</a>
<a name="ln446">  dt_dev_add_history_item(darktable.develop, data-&gt;module, TRUE);</a>
<a name="ln447">}</a>
<a name="ln448"> </a>
<a name="ln449">static void _blendop_blendif_blur_radius_callback(GtkWidget *slider, dt_iop_gui_blend_data_t *data)</a>
<a name="ln450">{</a>
<a name="ln451">  data-&gt;module-&gt;blend_params-&gt;blur_radius = dt_bauhaus_slider_get(slider);</a>
<a name="ln452">  dt_dev_add_history_item(darktable.develop, data-&gt;module, TRUE);</a>
<a name="ln453">}</a>
<a name="ln454"> </a>
<a name="ln455">static void _blendop_blendif_brightness_callback(GtkWidget *slider, dt_iop_gui_blend_data_t *data)</a>
<a name="ln456">{</a>
<a name="ln457">  data-&gt;module-&gt;blend_params-&gt;brightness = dt_bauhaus_slider_get(slider);</a>
<a name="ln458">  dt_dev_add_history_item(darktable.develop, data-&gt;module, TRUE);</a>
<a name="ln459">}</a>
<a name="ln460"> </a>
<a name="ln461">static void _blendop_blendif_contrast_callback(GtkWidget *slider, dt_iop_gui_blend_data_t *data)</a>
<a name="ln462">{</a>
<a name="ln463">  data-&gt;module-&gt;blend_params-&gt;contrast = dt_bauhaus_slider_get(slider);</a>
<a name="ln464">  dt_dev_add_history_item(darktable.develop, data-&gt;module, TRUE);</a>
<a name="ln465">}</a>
<a name="ln466"> </a>
<a name="ln467">static void _blendop_blendif_upper_callback(GtkDarktableGradientSlider *slider, dt_iop_gui_blend_data_t *data)</a>
<a name="ln468">{</a>
<a name="ln469">  if(darktable.gui-&gt;reset) return;</a>
<a name="ln470">  dt_develop_blend_params_t *bp = data-&gt;module-&gt;blend_params;</a>
<a name="ln471"> </a>
<a name="ln472">  int tab = data-&gt;tab;</a>
<a name="ln473">  int ch = data-&gt;channels[tab][1];</a>
<a name="ln474"> </a>
<a name="ln475">  float *parameters = &amp;(bp-&gt;blendif_parameters[4 * ch]);</a>
<a name="ln476"> </a>
<a name="ln477">  for(int k = 0; k &lt; 4; k++) parameters[k] = dtgtk_gradient_slider_multivalue_get_value(slider, k);</a>
<a name="ln478"> </a>
<a name="ln479">  for(int k = 0; k &lt; 4; k++)</a>
<a name="ln480">  {</a>
<a name="ln481">    char text[256];</a>
<a name="ln482">    (data-&gt;scale_print[tab])(parameters[k], text, sizeof(text));</a>
<a name="ln483">    gtk_label_set_text(data-&gt;upper_label[k], text);</a>
<a name="ln484">  }</a>
<a name="ln485"> </a>
<a name="ln486">  /** de-activate processing of this channel if maximum span is selected */</a>
<a name="ln487">  if(parameters[1] == 0.0f &amp;&amp; parameters[2] == 1.0f)</a>
<a name="ln488">    bp-&gt;blendif &amp;= ~(1 &lt;&lt; ch);</a>
<a name="ln489">  else</a>
<a name="ln490">    bp-&gt;blendif |= (1 &lt;&lt; ch);</a>
<a name="ln491"> </a>
<a name="ln492">  dt_dev_add_history_item(darktable.develop, data-&gt;module, TRUE);</a>
<a name="ln493">}</a>
<a name="ln494"> </a>
<a name="ln495"> </a>
<a name="ln496">static void _blendop_blendif_lower_callback(GtkDarktableGradientSlider *slider, dt_iop_gui_blend_data_t *data)</a>
<a name="ln497">{</a>
<a name="ln498">  if(darktable.gui-&gt;reset) return;</a>
<a name="ln499">  dt_develop_blend_params_t *bp = data-&gt;module-&gt;blend_params;</a>
<a name="ln500"> </a>
<a name="ln501">  int tab = data-&gt;tab;</a>
<a name="ln502">  int ch = data-&gt;channels[tab][0];</a>
<a name="ln503"> </a>
<a name="ln504">  float *parameters = &amp;(bp-&gt;blendif_parameters[4 * ch]);</a>
<a name="ln505"> </a>
<a name="ln506">  for(int k = 0; k &lt; 4; k++) parameters[k] = dtgtk_gradient_slider_multivalue_get_value(slider, k);</a>
<a name="ln507"> </a>
<a name="ln508">  for(int k = 0; k &lt; 4; k++)</a>
<a name="ln509">  {</a>
<a name="ln510">    char text[256];</a>
<a name="ln511">    (data-&gt;scale_print[tab])(parameters[k], text, sizeof(text));</a>
<a name="ln512">    gtk_label_set_text(data-&gt;lower_label[k], text);</a>
<a name="ln513">  }</a>
<a name="ln514"> </a>
<a name="ln515">  /** de-activate processing of this channel if maximum span is selected */</a>
<a name="ln516">  if(parameters[1] == 0.0f &amp;&amp; parameters[2] == 1.0f)</a>
<a name="ln517">    bp-&gt;blendif &amp;= ~(1 &lt;&lt; ch);</a>
<a name="ln518">  else</a>
<a name="ln519">    bp-&gt;blendif |= (1 &lt;&lt; ch);</a>
<a name="ln520"> </a>
<a name="ln521">  dt_dev_add_history_item(darktable.develop, data-&gt;module, TRUE);</a>
<a name="ln522">}</a>
<a name="ln523"> </a>
<a name="ln524"> </a>
<a name="ln525">static void _blendop_blendif_polarity_callback(GtkToggleButton *togglebutton, dt_iop_gui_blend_data_t *data)</a>
<a name="ln526">{</a>
<a name="ln527">  int active = gtk_toggle_button_get_active(togglebutton);</a>
<a name="ln528">  if(darktable.gui-&gt;reset) return;</a>
<a name="ln529">  dt_develop_blend_params_t *bp = data-&gt;module-&gt;blend_params;</a>
<a name="ln530"> </a>
<a name="ln531">  int tab = data-&gt;tab;</a>
<a name="ln532">  int ch = GTK_WIDGET(togglebutton) == data-&gt;lower_polarity ? data-&gt;channels[tab][0] : data-&gt;channels[tab][1];</a>
<a name="ln533">  GtkDarktableGradientSlider *slider = GTK_WIDGET(togglebutton) == data-&gt;lower_polarity ? data-&gt;lower_slider</a>
<a name="ln534">                                                                                        : data-&gt;upper_slider;</a>
<a name="ln535"> </a>
<a name="ln536">  if(!active)</a>
<a name="ln537">    bp-&gt;blendif |= (1 &lt;&lt; (ch + 16));</a>
<a name="ln538">  else</a>
<a name="ln539">    bp-&gt;blendif &amp;= ~(1 &lt;&lt; (ch + 16));</a>
<a name="ln540"> </a>
<a name="ln541">  dtgtk_gradient_slider_multivalue_set_marker(</a>
<a name="ln542">      slider, active ? GRADIENT_SLIDER_MARKER_LOWER_OPEN_BIG : GRADIENT_SLIDER_MARKER_UPPER_OPEN_BIG, 0);</a>
<a name="ln543">  dtgtk_gradient_slider_multivalue_set_marker(</a>
<a name="ln544">      slider, active ? GRADIENT_SLIDER_MARKER_UPPER_FILLED_BIG : GRADIENT_SLIDER_MARKER_LOWER_FILLED_BIG, 1);</a>
<a name="ln545">  dtgtk_gradient_slider_multivalue_set_marker(</a>
<a name="ln546">      slider, active ? GRADIENT_SLIDER_MARKER_UPPER_FILLED_BIG : GRADIENT_SLIDER_MARKER_LOWER_FILLED_BIG, 2);</a>
<a name="ln547">  dtgtk_gradient_slider_multivalue_set_marker(</a>
<a name="ln548">      slider, active ? GRADIENT_SLIDER_MARKER_LOWER_OPEN_BIG : GRADIENT_SLIDER_MARKER_UPPER_OPEN_BIG, 3);</a>
<a name="ln549"> </a>
<a name="ln550">  dt_dev_add_history_item(darktable.develop, data-&gt;module, TRUE);</a>
<a name="ln551">}</a>
<a name="ln552"> </a>
<a name="ln553"> </a>
<a name="ln554">static void _blendop_blendif_tab_switch(GtkNotebook *notebook, GtkWidget *page, guint page_num,</a>
<a name="ln555">                                        dt_iop_gui_blend_data_t *data)</a>
<a name="ln556">{</a>
<a name="ln557">  data-&gt;tab = page_num;</a>
<a name="ln558">  dt_iop_gui_update_blendif(data-&gt;module);</a>
<a name="ln559">}</a>
<a name="ln560"> </a>
<a name="ln561"> </a>
<a name="ln562">static void _blendop_blendif_pick_toggled(GtkToggleButton *togglebutton, dt_iop_module_t *module)</a>
<a name="ln563">{</a>
<a name="ln564">  if(darktable.gui-&gt;reset) return;</a>
<a name="ln565"> </a>
<a name="ln566">  /* if module itself already requested color pick don't tamper with it. A module color picker takes</a>
<a name="ln567">   * precedence. */</a>
<a name="ln568">  if(module-&gt;request_color_pick == DT_REQUEST_COLORPICK_MODULE)</a>
<a name="ln569">  {</a>
<a name="ln570">    gtk_toggle_button_set_active(togglebutton, 0);</a>
<a name="ln571">    return;</a>
<a name="ln572">  }</a>
<a name="ln573"> </a>
<a name="ln574">  module-&gt;request_color_pick</a>
<a name="ln575">      = (gtk_toggle_button_get_active(togglebutton) ? DT_REQUEST_COLORPICK_BLEND : DT_REQUEST_COLORPICK_OFF);</a>
<a name="ln576"> </a>
<a name="ln577">  /* set the area sample size */</a>
<a name="ln578">  if(module-&gt;request_color_pick != DT_REQUEST_COLORPICK_OFF)</a>
<a name="ln579">  {</a>
<a name="ln580">    dt_lib_colorpicker_set_point(darktable.lib, 0.5, 0.5);</a>
<a name="ln581">    dt_dev_reprocess_all(module-&gt;dev);</a>
<a name="ln582">  }</a>
<a name="ln583">  else</a>
<a name="ln584">    dt_control_queue_redraw();</a>
<a name="ln585"> </a>
<a name="ln586">  if(module-&gt;off) gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(module-&gt;off), 1);</a>
<a name="ln587">  dt_iop_request_focus(module);</a>
<a name="ln588">}</a>
<a name="ln589"> </a>
<a name="ln590">static void _blendop_blendif_showmask_clicked(GtkWidget *button, GdkEventButton *event, dt_iop_module_t *module)</a>
<a name="ln591">{</a>
<a name="ln592">  if(darktable.gui-&gt;reset) return;</a>
<a name="ln593"> </a>
<a name="ln594">  // if blendif is bypassed don't allow to set this button on</a>
<a name="ln595">  if(module-&gt;bypass_blendif)</a>
<a name="ln596">  {</a>
<a name="ln597">    dt_control_log(_(&quot;display mask is currently disabled by another module&quot;));</a>
<a name="ln598"> </a>
<a name="ln599">    if(darktable.gui-&gt;reset) return;</a>
<a name="ln600">    const int reset = darktable.gui-&gt;reset;</a>
<a name="ln601">    darktable.gui-&gt;reset = 1;</a>
<a name="ln602">    dtgtk_button_set_active(DTGTK_BUTTON(button), FALSE);</a>
<a name="ln603">    darktable.gui-&gt;reset = reset;</a>
<a name="ln604">    return;</a>
<a name="ln605">  }</a>
<a name="ln606"> </a>
<a name="ln607">  if(event-&gt;button == 1)</a>
<a name="ln608">  {</a>
<a name="ln609">    const int has_mask_display = module-&gt;request_mask_display &amp; (DT_DEV_PIXELPIPE_DISPLAY_MASK | DT_DEV_PIXELPIPE_DISPLAY_CHANNEL);</a>
<a name="ln610"> </a>
<a name="ln611">    module-&gt;request_mask_display &amp;= ~(DT_DEV_PIXELPIPE_DISPLAY_MASK | DT_DEV_PIXELPIPE_DISPLAY_CHANNEL | DT_DEV_PIXELPIPE_DISPLAY_ANY);</a>
<a name="ln612"> </a>
<a name="ln613">    GdkModifierType modifiers = gtk_accelerator_get_default_mod_mask();</a>
<a name="ln614">    if((event-&gt;state &amp; modifiers) == (GDK_CONTROL_MASK | GDK_SHIFT_MASK))</a>
<a name="ln615">      module-&gt;request_mask_display |= (DT_DEV_PIXELPIPE_DISPLAY_MASK | DT_DEV_PIXELPIPE_DISPLAY_CHANNEL);</a>
<a name="ln616">    else if((event-&gt;state &amp; modifiers) == GDK_SHIFT_MASK)</a>
<a name="ln617">      module-&gt;request_mask_display |= DT_DEV_PIXELPIPE_DISPLAY_CHANNEL;</a>
<a name="ln618">    else if((event-&gt;state &amp; modifiers) == GDK_CONTROL_MASK)</a>
<a name="ln619">      module-&gt;request_mask_display |= DT_DEV_PIXELPIPE_DISPLAY_MASK;</a>
<a name="ln620">    else</a>
<a name="ln621">      module-&gt;request_mask_display |= (has_mask_display ? 0 : DT_DEV_PIXELPIPE_DISPLAY_MASK);</a>
<a name="ln622"> </a>
<a name="ln623">    if(module-&gt;request_mask_display &amp; (DT_DEV_PIXELPIPE_DISPLAY_MASK | DT_DEV_PIXELPIPE_DISPLAY_CHANNEL))</a>
<a name="ln624">      dtgtk_button_set_active(DTGTK_BUTTON(button), 1);</a>
<a name="ln625">    else</a>
<a name="ln626">      dtgtk_button_set_active(DTGTK_BUTTON(button), 0);</a>
<a name="ln627"> </a>
<a name="ln628"> </a>
<a name="ln629">    if(module-&gt;off) gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(module-&gt;off), 1);</a>
<a name="ln630"> </a>
<a name="ln631">    dt_iop_request_focus(module);</a>
<a name="ln632">    dt_dev_reprocess_all(module-&gt;dev);</a>
<a name="ln633">  }</a>
<a name="ln634">}</a>
<a name="ln635"> </a>
<a name="ln636">static void _blendop_blendif_suppress_toggled(GtkToggleButton *togglebutton, dt_iop_module_t *module)</a>
<a name="ln637">{</a>
<a name="ln638">  module-&gt;suppress_mask = gtk_toggle_button_get_active(togglebutton);</a>
<a name="ln639">  if(darktable.gui-&gt;reset) return;</a>
<a name="ln640"> </a>
<a name="ln641">  if(module-&gt;off) gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(module-&gt;off), 1);</a>
<a name="ln642">  dt_iop_request_focus(module);</a>
<a name="ln643"> </a>
<a name="ln644">  dt_dev_reprocess_all(module-&gt;dev);</a>
<a name="ln645">}</a>
<a name="ln646"> </a>
<a name="ln647">static void _blendop_blendif_reset(GtkButton *button, dt_iop_module_t *module)</a>
<a name="ln648">{</a>
<a name="ln649">  module-&gt;blend_params-&gt;blendif = module-&gt;default_blendop_params-&gt;blendif;</a>
<a name="ln650">  memcpy(module-&gt;blend_params-&gt;blendif_parameters, module-&gt;default_blendop_params-&gt;blendif_parameters,</a>
<a name="ln651">         4 * DEVELOP_BLENDIF_SIZE * sizeof(float));</a>
<a name="ln652"> </a>
<a name="ln653">  dt_iop_gui_update_blendif(module);</a>
<a name="ln654">  dt_dev_add_history_item(darktable.develop, module, TRUE);</a>
<a name="ln655">}</a>
<a name="ln656"> </a>
<a name="ln657">static void _blendop_blendif_invert(GtkButton *button, dt_iop_module_t *module)</a>
<a name="ln658">{</a>
<a name="ln659">  if(darktable.gui-&gt;reset) return;</a>
<a name="ln660"> </a>
<a name="ln661">  dt_iop_gui_blend_data_t *data = module-&gt;blend_data;</a>
<a name="ln662"> </a>
<a name="ln663">  unsigned int toggle_mask = 0;</a>
<a name="ln664"> </a>
<a name="ln665">  switch(data-&gt;csp)</a>
<a name="ln666">  {</a>
<a name="ln667">    case iop_cs_Lab:</a>
<a name="ln668">      toggle_mask = DEVELOP_BLENDIF_Lab_MASK &lt;&lt; 16;</a>
<a name="ln669">      break;</a>
<a name="ln670"> </a>
<a name="ln671">    case iop_cs_rgb:</a>
<a name="ln672">      toggle_mask = DEVELOP_BLENDIF_RGB_MASK &lt;&lt; 16;</a>
<a name="ln673">      break;</a>
<a name="ln674"> </a>
<a name="ln675">    case iop_cs_RAW:</a>
<a name="ln676">      toggle_mask = 0;</a>
<a name="ln677">      break;</a>
<a name="ln678">  }</a>
<a name="ln679"> </a>
<a name="ln680">  module-&gt;blend_params-&gt;blendif ^= toggle_mask;</a>
<a name="ln681">  module-&gt;blend_params-&gt;mask_combine ^= DEVELOP_COMBINE_MASKS_POS;</a>
<a name="ln682">  module-&gt;blend_params-&gt;mask_combine ^= DEVELOP_COMBINE_INCL;</a>
<a name="ln683">  dt_iop_gui_update_blending(module);</a>
<a name="ln684">  dt_dev_add_history_item(darktable.develop, module, TRUE);</a>
<a name="ln685">}</a>
<a name="ln686"> </a>
<a name="ln687">static int _blendop_masks_add_path(GtkWidget *widget, GdkEventButton *event, dt_iop_module_t *self)</a>
<a name="ln688">{</a>
<a name="ln689">  if(darktable.gui-&gt;reset) return FALSE;</a>
<a name="ln690">  dt_iop_gui_blend_data_t *bd = (dt_iop_gui_blend_data_t *)self-&gt;blend_data;</a>
<a name="ln691"> </a>
<a name="ln692">  if(event-&gt;button == 1)</a>
<a name="ln693">  {</a>
<a name="ln694">    // we want to be sure that the iop has focus</a>
<a name="ln695">    dt_iop_request_focus(self);</a>
<a name="ln696">    self-&gt;request_color_pick = DT_REQUEST_COLORPICK_OFF;</a>
<a name="ln697">    bd-&gt;masks_shown = DT_MASKS_EDIT_FULL;</a>
<a name="ln698">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_edit), TRUE);</a>
<a name="ln699">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(widget), TRUE);</a>
<a name="ln700">    // we create the new form</a>
<a name="ln701">    dt_masks_form_t *form = dt_masks_create(DT_MASKS_PATH);</a>
<a name="ln702">    dt_masks_change_form_gui(form);</a>
<a name="ln703">    darktable.develop-&gt;form_gui-&gt;creation = TRUE;</a>
<a name="ln704">    darktable.develop-&gt;form_gui-&gt;creation_module = self;</a>
<a name="ln705">    dt_control_queue_redraw_center();</a>
<a name="ln706">    return TRUE;</a>
<a name="ln707">  }</a>
<a name="ln708"> </a>
<a name="ln709">  return FALSE;</a>
<a name="ln710">}</a>
<a name="ln711"> </a>
<a name="ln712">static int _blendop_masks_add_circle(GtkWidget *widget, GdkEventButton *event, dt_iop_module_t *self)</a>
<a name="ln713">{</a>
<a name="ln714">  if(darktable.gui-&gt;reset) return FALSE;</a>
<a name="ln715">  dt_iop_gui_blend_data_t *bd = (dt_iop_gui_blend_data_t *)self-&gt;blend_data;</a>
<a name="ln716"> </a>
<a name="ln717">  if(event-&gt;button == 1)</a>
<a name="ln718">  {</a>
<a name="ln719">    // we want to be sure that the iop has focus</a>
<a name="ln720">    dt_iop_request_focus(self);</a>
<a name="ln721">    self-&gt;request_color_pick = DT_REQUEST_COLORPICK_OFF;</a>
<a name="ln722">    bd-&gt;masks_shown = DT_MASKS_EDIT_FULL;</a>
<a name="ln723">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_edit), TRUE);</a>
<a name="ln724">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(widget), TRUE);</a>
<a name="ln725">    // we create the new form</a>
<a name="ln726">    dt_masks_form_t *spot = dt_masks_create(DT_MASKS_CIRCLE);</a>
<a name="ln727">    dt_masks_change_form_gui(spot);</a>
<a name="ln728">    darktable.develop-&gt;form_gui-&gt;creation = TRUE;</a>
<a name="ln729">    darktable.develop-&gt;form_gui-&gt;creation_module = self;</a>
<a name="ln730">    dt_control_queue_redraw_center();</a>
<a name="ln731">    return TRUE;</a>
<a name="ln732">  }</a>
<a name="ln733"> </a>
<a name="ln734">  return FALSE;</a>
<a name="ln735">}</a>
<a name="ln736"> </a>
<a name="ln737">static int _blendop_masks_add_ellipse(GtkWidget *widget, GdkEventButton *event, dt_iop_module_t *self)</a>
<a name="ln738">{</a>
<a name="ln739">  if(darktable.gui-&gt;reset) return FALSE;</a>
<a name="ln740">  dt_iop_gui_blend_data_t *bd = (dt_iop_gui_blend_data_t *)self-&gt;blend_data;</a>
<a name="ln741"> </a>
<a name="ln742">  if(event-&gt;button == 1)</a>
<a name="ln743">  {</a>
<a name="ln744">    // we want to be sure that the iop has focus</a>
<a name="ln745">    dt_iop_request_focus(self);</a>
<a name="ln746">    self-&gt;request_color_pick = DT_REQUEST_COLORPICK_OFF;</a>
<a name="ln747">    bd-&gt;masks_shown = DT_MASKS_EDIT_FULL;</a>
<a name="ln748">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_edit), TRUE);</a>
<a name="ln749">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(widget), TRUE);</a>
<a name="ln750">    // we create the new form</a>
<a name="ln751">    dt_masks_form_t *spot = dt_masks_create(DT_MASKS_ELLIPSE);</a>
<a name="ln752">    dt_masks_change_form_gui(spot);</a>
<a name="ln753">    darktable.develop-&gt;form_gui-&gt;creation = TRUE;</a>
<a name="ln754">    darktable.develop-&gt;form_gui-&gt;creation_module = self;</a>
<a name="ln755">    dt_control_queue_redraw_center();</a>
<a name="ln756">    return TRUE;</a>
<a name="ln757">  }</a>
<a name="ln758"> </a>
<a name="ln759">  return FALSE;</a>
<a name="ln760">}</a>
<a name="ln761"> </a>
<a name="ln762">static int _blendop_masks_add_brush(GtkWidget *widget, GdkEventButton *event, dt_iop_module_t *self)</a>
<a name="ln763">{</a>
<a name="ln764">  if(darktable.gui-&gt;reset) return FALSE;</a>
<a name="ln765">  dt_iop_gui_blend_data_t *bd = (dt_iop_gui_blend_data_t *)self-&gt;blend_data;</a>
<a name="ln766"> </a>
<a name="ln767">  if(event-&gt;button == 1)</a>
<a name="ln768">  {</a>
<a name="ln769">    // we want to be sure that the iop has focus</a>
<a name="ln770">    dt_iop_request_focus(self);</a>
<a name="ln771">    self-&gt;request_color_pick = DT_REQUEST_COLORPICK_OFF;</a>
<a name="ln772">    bd-&gt;masks_shown = DT_MASKS_EDIT_FULL;</a>
<a name="ln773">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_edit), TRUE);</a>
<a name="ln774">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(widget), TRUE);</a>
<a name="ln775">    // we create the new form</a>
<a name="ln776">    dt_masks_form_t *form = dt_masks_create(DT_MASKS_BRUSH);</a>
<a name="ln777">    dt_masks_change_form_gui(form);</a>
<a name="ln778">    darktable.develop-&gt;form_gui-&gt;creation = TRUE;</a>
<a name="ln779">    darktable.develop-&gt;form_gui-&gt;creation_module = self;</a>
<a name="ln780">    dt_control_queue_redraw_center();</a>
<a name="ln781">    return TRUE;</a>
<a name="ln782">  }</a>
<a name="ln783"> </a>
<a name="ln784">  return FALSE;</a>
<a name="ln785">}</a>
<a name="ln786"> </a>
<a name="ln787">static int _blendop_masks_add_gradient(GtkWidget *widget, GdkEventButton *event, dt_iop_module_t *self)</a>
<a name="ln788">{</a>
<a name="ln789">  if(darktable.gui-&gt;reset) return FALSE;</a>
<a name="ln790">  dt_iop_gui_blend_data_t *bd = (dt_iop_gui_blend_data_t *)self-&gt;blend_data;</a>
<a name="ln791"> </a>
<a name="ln792">  if(event-&gt;button == 1)</a>
<a name="ln793">  {</a>
<a name="ln794">    // we want to be sure that the iop has focus</a>
<a name="ln795">    dt_iop_request_focus(self);</a>
<a name="ln796">    self-&gt;request_color_pick = DT_REQUEST_COLORPICK_OFF;</a>
<a name="ln797">    bd-&gt;masks_shown = DT_MASKS_EDIT_FULL;</a>
<a name="ln798">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_edit), TRUE);</a>
<a name="ln799">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(widget), TRUE);</a>
<a name="ln800">    // we create the new form</a>
<a name="ln801">    dt_masks_form_t *spot = dt_masks_create(DT_MASKS_GRADIENT);</a>
<a name="ln802">    dt_masks_change_form_gui(spot);</a>
<a name="ln803">    darktable.develop-&gt;form_gui-&gt;creation = TRUE;</a>
<a name="ln804">    darktable.develop-&gt;form_gui-&gt;creation_module = self;</a>
<a name="ln805">    dt_control_queue_redraw_center();</a>
<a name="ln806">    return TRUE;</a>
<a name="ln807">  }</a>
<a name="ln808"> </a>
<a name="ln809">  return FALSE;</a>
<a name="ln810">}</a>
<a name="ln811"> </a>
<a name="ln812"> </a>
<a name="ln813">static int _blendop_masks_show_and_edit(GtkWidget *widget, GdkEventButton *event, dt_iop_module_t *self)</a>
<a name="ln814">{</a>
<a name="ln815">  if(darktable.gui-&gt;reset) return FALSE;</a>
<a name="ln816">  dt_iop_gui_blend_data_t *bd = (dt_iop_gui_blend_data_t *)self-&gt;blend_data;</a>
<a name="ln817"> </a>
<a name="ln818">  if(event-&gt;button == 1)</a>
<a name="ln819">  {</a>
<a name="ln820">    darktable.gui-&gt;reset = 1;</a>
<a name="ln821"> </a>
<a name="ln822">    dt_iop_request_focus(self);</a>
<a name="ln823">    self-&gt;request_color_pick = DT_REQUEST_COLORPICK_OFF;</a>
<a name="ln824"> </a>
<a name="ln825">    dt_masks_form_t *grp = dt_masks_get_from_id(darktable.develop, self-&gt;blend_params-&gt;mask_id);</a>
<a name="ln826">    if(grp &amp;&amp; (grp-&gt;type &amp; DT_MASKS_GROUP) &amp;&amp; g_list_length(grp-&gt;points) &gt; 0)</a>
<a name="ln827">    {</a>
<a name="ln828">      const int control_button_pressed = event-&gt;state &amp; GDK_CONTROL_MASK;</a>
<a name="ln829"> </a>
<a name="ln830">      switch(bd-&gt;masks_shown)</a>
<a name="ln831">      {</a>
<a name="ln832">        case DT_MASKS_EDIT_FULL:</a>
<a name="ln833">          bd-&gt;masks_shown = control_button_pressed ? DT_MASKS_EDIT_RESTRICTED : DT_MASKS_EDIT_OFF;</a>
<a name="ln834">          break;</a>
<a name="ln835"> </a>
<a name="ln836">        case DT_MASKS_EDIT_RESTRICTED:</a>
<a name="ln837">          bd-&gt;masks_shown = !control_button_pressed ? DT_MASKS_EDIT_FULL : DT_MASKS_EDIT_OFF;</a>
<a name="ln838">          break;</a>
<a name="ln839"> </a>
<a name="ln840">        default:</a>
<a name="ln841">        case DT_MASKS_EDIT_OFF:</a>
<a name="ln842">          bd-&gt;masks_shown = control_button_pressed ? DT_MASKS_EDIT_RESTRICTED : DT_MASKS_EDIT_FULL;</a>
<a name="ln843">      }</a>
<a name="ln844">    }</a>
<a name="ln845">    else</a>
<a name="ln846">      bd-&gt;masks_shown = DT_MASKS_EDIT_OFF;</a>
<a name="ln847"> </a>
<a name="ln848">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_edit), bd-&gt;masks_shown != DT_MASKS_EDIT_OFF);</a>
<a name="ln849">    dt_masks_set_edit_mode(self, bd-&gt;masks_shown);</a>
<a name="ln850"> </a>
<a name="ln851">    darktable.gui-&gt;reset = 0;</a>
<a name="ln852"> </a>
<a name="ln853">    return TRUE;</a>
<a name="ln854">  }</a>
<a name="ln855"> </a>
<a name="ln856">  return FALSE;</a>
<a name="ln857">}</a>
<a name="ln858"> </a>
<a name="ln859">static void _blendop_masks_polarity_callback(GtkToggleButton *togglebutton, dt_iop_module_t *self)</a>
<a name="ln860">{</a>
<a name="ln861">  if(darktable.gui-&gt;reset) return;</a>
<a name="ln862"> </a>
<a name="ln863">  int active = gtk_toggle_button_get_active(togglebutton);</a>
<a name="ln864">  dt_develop_blend_params_t *bp = (dt_develop_blend_params_t *)self-&gt;blend_params;</a>
<a name="ln865"> </a>
<a name="ln866">  if(active)</a>
<a name="ln867">    bp-&gt;mask_combine |= DEVELOP_COMBINE_MASKS_POS;</a>
<a name="ln868">  else</a>
<a name="ln869">    bp-&gt;mask_combine &amp;= ~DEVELOP_COMBINE_MASKS_POS;</a>
<a name="ln870"> </a>
<a name="ln871">  dt_dev_add_history_item(darktable.develop, self, TRUE);</a>
<a name="ln872">}</a>
<a name="ln873"> </a>
<a name="ln874">static gboolean _blendop_blendif_draw(GtkWidget *widget, cairo_t *cr, dt_iop_module_t *module)</a>
<a name="ln875">{</a>
<a name="ln876">  if(darktable.gui-&gt;reset) return FALSE;</a>
<a name="ln877"> </a>
<a name="ln878">  dt_iop_gui_blend_data_t *data = module-&gt;blend_data;</a>
<a name="ln879"> </a>
<a name="ln880">  float picker_mean[8], picker_min[8], picker_max[8];</a>
<a name="ln881">  float cooked[8];</a>
<a name="ln882">  float *raw_mean, *raw_min, *raw_max;</a>
<a name="ln883">  char text[256];</a>
<a name="ln884">  GtkLabel *label;</a>
<a name="ln885"> </a>
<a name="ln886">  if(widget == GTK_WIDGET(data-&gt;lower_slider))</a>
<a name="ln887">  {</a>
<a name="ln888">    raw_mean = module-&gt;picked_color;</a>
<a name="ln889">    raw_min = module-&gt;picked_color_min;</a>
<a name="ln890">    raw_max = module-&gt;picked_color_max;</a>
<a name="ln891">    label = data-&gt;lower_picker_label;</a>
<a name="ln892">  }</a>
<a name="ln893">  else</a>
<a name="ln894">  {</a>
<a name="ln895">    raw_mean = module-&gt;picked_output_color;</a>
<a name="ln896">    raw_min = module-&gt;picked_output_color_min;</a>
<a name="ln897">    raw_max = module-&gt;picked_output_color_max;</a>
<a name="ln898">    label = data-&gt;upper_picker_label;</a>
<a name="ln899">  }</a>
<a name="ln900"> </a>
<a name="ln901">  darktable.gui-&gt;reset = 1;</a>
<a name="ln902">  if((module-&gt;request_color_pick == DT_REQUEST_COLORPICK_BLEND) &amp;&amp; (raw_min[0] != INFINITY))</a>
<a name="ln903">  {</a>
<a name="ln904">    _blendif_scale(data-&gt;csp, raw_mean, picker_mean);</a>
<a name="ln905">    _blendif_scale(data-&gt;csp, raw_min, picker_min);</a>
<a name="ln906">    _blendif_scale(data-&gt;csp, raw_max, picker_max);</a>
<a name="ln907">    _blendif_cook(data-&gt;csp, raw_mean, cooked);</a>
<a name="ln908"> </a>
<a name="ln909">    if(data-&gt;channels[data-&gt;tab][0] &gt;= 8) // min and max make no sense for HSL and LCh</a>
<a name="ln910">      picker_min[data-&gt;tab] = picker_max[data-&gt;tab] = picker_mean[data-&gt;tab];</a>
<a name="ln911"> </a>
<a name="ln912">    snprintf(text, sizeof(text), &quot;(%.1f)&quot;, cooked[data-&gt;tab]);</a>
<a name="ln913"> </a>
<a name="ln914">    dtgtk_gradient_slider_multivalue_set_picker_meanminmax(</a>
<a name="ln915">        DTGTK_GRADIENT_SLIDER(widget), picker_mean[data-&gt;tab], picker_min[data-&gt;tab], picker_max[data-&gt;tab]);</a>
<a name="ln916">    gtk_label_set_text(label, text);</a>
<a name="ln917">  }</a>
<a name="ln918">  else</a>
<a name="ln919">  {</a>
<a name="ln920">    dtgtk_gradient_slider_multivalue_set_picker(DTGTK_GRADIENT_SLIDER(widget), NAN);</a>
<a name="ln921">    gtk_label_set_text(label, &quot;&quot;);</a>
<a name="ln922">  }</a>
<a name="ln923"> </a>
<a name="ln924">  gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(data-&gt;colorpicker),</a>
<a name="ln925">                               (module-&gt;request_color_pick == DT_REQUEST_COLORPICK_BLEND ? 1 : 0));</a>
<a name="ln926"> </a>
<a name="ln927">  darktable.gui-&gt;reset = 0;</a>
<a name="ln928"> </a>
<a name="ln929">  return FALSE;</a>
<a name="ln930">}</a>
<a name="ln931"> </a>
<a name="ln932">// magic mode: if mouse curser enters a gradient slider with shift and/or control pressed we</a>
<a name="ln933">// enter channel display and/or mask display mode</a>
<a name="ln934">static gboolean _blendop_blendif_enter(GtkWidget *widget, GdkEventCrossing *event, dt_iop_module_t *module)</a>
<a name="ln935">{</a>
<a name="ln936">  if(darktable.gui-&gt;reset) return FALSE;</a>
<a name="ln937">  dt_iop_gui_blend_data_t *data = module-&gt;blend_data;</a>
<a name="ln938"> </a>
<a name="ln939">  dt_pthread_mutex_lock(&amp;data-&gt;lock);</a>
<a name="ln940">  if(data-&gt;timeout_handle)</a>
<a name="ln941">  {</a>
<a name="ln942">    // purge any remaining timeout handlers</a>
<a name="ln943">    g_source_remove(data-&gt;timeout_handle);</a>
<a name="ln944">    data-&gt;timeout_handle = 0;</a>
<a name="ln945">  }</a>
<a name="ln946">  else</a>
<a name="ln947">  {</a>
<a name="ln948">    // save request_mask_display to restore later</a>
<a name="ln949">    data-&gt;save_for_leave = module-&gt;request_mask_display;</a>
<a name="ln950">  }</a>
<a name="ln951">  dt_pthread_mutex_unlock(&amp;data-&gt;lock);</a>
<a name="ln952"> </a>
<a name="ln953">  dt_dev_pixelpipe_display_mask_t new_request_mask_display = module-&gt;request_mask_display;</a>
<a name="ln954"> </a>
<a name="ln955">  // depending on shift modifiers we activate channel and/or mask display</a>
<a name="ln956">  GdkModifierType modifiers = gtk_accelerator_get_default_mod_mask();</a>
<a name="ln957">  if((event-&gt;state &amp; modifiers) == (GDK_SHIFT_MASK | GDK_CONTROL_MASK))</a>
<a name="ln958">  {</a>
<a name="ln959">    new_request_mask_display |= (DT_DEV_PIXELPIPE_DISPLAY_MASK | DT_DEV_PIXELPIPE_DISPLAY_CHANNEL);</a>
<a name="ln960">  }</a>
<a name="ln961">  else if((event-&gt;state &amp; modifiers) == GDK_SHIFT_MASK)</a>
<a name="ln962">  {</a>
<a name="ln963">    new_request_mask_display |= DT_DEV_PIXELPIPE_DISPLAY_CHANNEL;</a>
<a name="ln964">  }</a>
<a name="ln965">  else if((event-&gt;state &amp; modifiers) == GDK_CONTROL_MASK)</a>
<a name="ln966">  {</a>
<a name="ln967">    new_request_mask_display |= DT_DEV_PIXELPIPE_DISPLAY_MASK;</a>
<a name="ln968">  }</a>
<a name="ln969"> </a>
<a name="ln970">  // in case user requests channel display: get the cannel</a>
<a name="ln971">  if(new_request_mask_display &amp; DT_DEV_PIXELPIPE_DISPLAY_CHANNEL)</a>
<a name="ln972">  {</a>
<a name="ln973">    int tab = data-&gt;tab;</a>
<a name="ln974">    int inout = (widget == GTK_WIDGET(data-&gt;lower_slider)) ? 0 : 1;</a>
<a name="ln975">    dt_dev_pixelpipe_display_mask_t channel = data-&gt;display_channel[tab][inout];</a>
<a name="ln976"> </a>
<a name="ln977">    new_request_mask_display &amp;= ~DT_DEV_PIXELPIPE_DISPLAY_ANY;</a>
<a name="ln978">    new_request_mask_display |= channel;</a>
<a name="ln979">  }</a>
<a name="ln980"> </a>
<a name="ln981">  // only if something has changed: reprocess center view</a>
<a name="ln982">  if(new_request_mask_display != module-&gt;request_mask_display)</a>
<a name="ln983">  {</a>
<a name="ln984">    module-&gt;request_mask_display = new_request_mask_display;</a>
<a name="ln985">    dt_dev_reprocess_all(module-&gt;dev);</a>
<a name="ln986">  }</a>
<a name="ln987"> </a>
<a name="ln988">  return TRUE;</a>
<a name="ln989">}</a>
<a name="ln990"> </a>
<a name="ln991">// handler for delayed mask/channel display mode switch-off</a>
<a name="ln992">static gboolean _blendop_blendif_leave_delayed(gpointer data)</a>
<a name="ln993">{</a>
<a name="ln994">  dt_iop_module_t *module = (dt_iop_module_t *)data;</a>
<a name="ln995">  dt_iop_gui_blend_data_t *bd = module-&gt;blend_data;</a>
<a name="ln996"> </a>
<a name="ln997">  dt_pthread_mutex_lock(&amp;bd-&gt;lock);</a>
<a name="ln998">  // restore saved request_mask_display and reprocess image</a>
<a name="ln999">  if(bd-&gt;timeout_handle &amp;&amp; (module-&gt;request_mask_display != bd-&gt;save_for_leave))</a>
<a name="ln1000">  {</a>
<a name="ln1001">    module-&gt;request_mask_display = bd-&gt;save_for_leave;</a>
<a name="ln1002">    dt_dev_reprocess_all(module-&gt;dev);</a>
<a name="ln1003">  }</a>
<a name="ln1004"> </a>
<a name="ln1005">  bd-&gt;timeout_handle = 0;</a>
<a name="ln1006">  dt_pthread_mutex_unlock(&amp;bd-&gt;lock);</a>
<a name="ln1007"> </a>
<a name="ln1008">  // return FALSE and thereby terminate the handler</a>
<a name="ln1009">  return FALSE;</a>
<a name="ln1010">}</a>
<a name="ln1011"> </a>
<a name="ln1012">// de-activate magic mode when leaving the gradient slider</a>
<a name="ln1013">static gboolean _blendop_blendif_leave(GtkWidget *widget, GdkEventCrossing *event, dt_iop_module_t *module)</a>
<a name="ln1014">{</a>
<a name="ln1015">  if(darktable.gui-&gt;reset) return FALSE;</a>
<a name="ln1016">  dt_iop_gui_blend_data_t *data = module-&gt;blend_data;</a>
<a name="ln1017"> </a>
<a name="ln1018">  if(module-&gt;request_mask_display &amp; (DT_DEV_PIXELPIPE_DISPLAY_MASK | DT_DEV_PIXELPIPE_DISPLAY_CHANNEL))</a>
<a name="ln1019">  {</a>
<a name="ln1020">    // do not immediately switch-off mask/channel display in case user leaves gradient only briefly.</a>
<a name="ln1021">    // instead we activate a handler function that gets triggered after some timeout</a>
<a name="ln1022">    dt_pthread_mutex_lock(&amp;data-&gt;lock);</a>
<a name="ln1023">    if(!data-&gt;timeout_handle &amp;&amp; (module-&gt;request_mask_display != data-&gt;save_for_leave))</a>
<a name="ln1024">      data-&gt;timeout_handle = g_timeout_add(1000, _blendop_blendif_leave_delayed, module);</a>
<a name="ln1025">    dt_pthread_mutex_unlock(&amp;data-&gt;lock);</a>
<a name="ln1026">  }</a>
<a name="ln1027"> </a>
<a name="ln1028">  return TRUE;</a>
<a name="ln1029">}</a>
<a name="ln1030"> </a>
<a name="ln1031"> </a>
<a name="ln1032">void dt_iop_gui_update_blendif(dt_iop_module_t *module)</a>
<a name="ln1033">{</a>
<a name="ln1034">  dt_iop_gui_blend_data_t *data = module-&gt;blend_data;</a>
<a name="ln1035">  dt_develop_blend_params_t *bp = module-&gt;blend_params;</a>
<a name="ln1036">  dt_develop_blend_params_t *dp = module-&gt;default_blendop_params;</a>
<a name="ln1037"> </a>
<a name="ln1038">  if(!data || !data-&gt;blendif_support || !data-&gt;blendif_inited) return;</a>
<a name="ln1039"> </a>
<a name="ln1040">  dt_pthread_mutex_lock(&amp;data-&gt;lock);</a>
<a name="ln1041">  if(data-&gt;timeout_handle)</a>
<a name="ln1042">  {</a>
<a name="ln1043">    g_source_remove(data-&gt;timeout_handle);</a>
<a name="ln1044">    data-&gt;timeout_handle = 0;</a>
<a name="ln1045">    if(module-&gt;request_mask_display != data-&gt;save_for_leave)</a>
<a name="ln1046">    {</a>
<a name="ln1047">      module-&gt;request_mask_display = data-&gt;save_for_leave;</a>
<a name="ln1048">      dt_dev_reprocess_all(module-&gt;dev);</a>
<a name="ln1049">    }</a>
<a name="ln1050">  }</a>
<a name="ln1051">  dt_pthread_mutex_unlock(&amp;data-&gt;lock);</a>
<a name="ln1052"> </a>
<a name="ln1053">  int tab = data-&gt;tab;</a>
<a name="ln1054">  int in_ch = data-&gt;channels[tab][0];</a>
<a name="ln1055">  int out_ch = data-&gt;channels[tab][1];</a>
<a name="ln1056"> </a>
<a name="ln1057">  float *iparameters = &amp;(bp-&gt;blendif_parameters[4 * in_ch]);</a>
<a name="ln1058">  float *oparameters = &amp;(bp-&gt;blendif_parameters[4 * out_ch]);</a>
<a name="ln1059">  float *idefaults = &amp;(dp-&gt;blendif_parameters[4 * in_ch]);</a>
<a name="ln1060">  float *odefaults = &amp;(dp-&gt;blendif_parameters[4 * out_ch]);</a>
<a name="ln1061"> </a>
<a name="ln1062">  int ipolarity = !(bp-&gt;blendif &amp; (1 &lt;&lt; (in_ch + 16)));</a>
<a name="ln1063">  int opolarity = !(bp-&gt;blendif &amp; (1 &lt;&lt; (out_ch + 16)));</a>
<a name="ln1064">  char text[256];</a>
<a name="ln1065"> </a>
<a name="ln1066">  int reset = darktable.gui-&gt;reset;</a>
<a name="ln1067">  darktable.gui-&gt;reset = 1;</a>
<a name="ln1068"> </a>
<a name="ln1069">  gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(data-&gt;lower_polarity), ipolarity);</a>
<a name="ln1070">  gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(data-&gt;upper_polarity), opolarity);</a>
<a name="ln1071"> </a>
<a name="ln1072">  dtgtk_gradient_slider_multivalue_set_marker(</a>
<a name="ln1073">      data-&gt;lower_slider,</a>
<a name="ln1074">      ipolarity ? GRADIENT_SLIDER_MARKER_LOWER_OPEN_BIG : GRADIENT_SLIDER_MARKER_UPPER_OPEN_BIG, 0);</a>
<a name="ln1075">  dtgtk_gradient_slider_multivalue_set_marker(</a>
<a name="ln1076">      data-&gt;lower_slider,</a>
<a name="ln1077">      ipolarity ? GRADIENT_SLIDER_MARKER_UPPER_FILLED_BIG : GRADIENT_SLIDER_MARKER_LOWER_FILLED_BIG, 1);</a>
<a name="ln1078">  dtgtk_gradient_slider_multivalue_set_marker(</a>
<a name="ln1079">      data-&gt;lower_slider,</a>
<a name="ln1080">      ipolarity ? GRADIENT_SLIDER_MARKER_UPPER_FILLED_BIG : GRADIENT_SLIDER_MARKER_LOWER_FILLED_BIG, 2);</a>
<a name="ln1081">  dtgtk_gradient_slider_multivalue_set_marker(</a>
<a name="ln1082">      data-&gt;lower_slider,</a>
<a name="ln1083">      ipolarity ? GRADIENT_SLIDER_MARKER_LOWER_OPEN_BIG : GRADIENT_SLIDER_MARKER_UPPER_OPEN_BIG, 3);</a>
<a name="ln1084"> </a>
<a name="ln1085">  dtgtk_gradient_slider_multivalue_set_marker(</a>
<a name="ln1086">      data-&gt;upper_slider,</a>
<a name="ln1087">      opolarity ? GRADIENT_SLIDER_MARKER_LOWER_OPEN_BIG : GRADIENT_SLIDER_MARKER_UPPER_OPEN_BIG, 0);</a>
<a name="ln1088">  dtgtk_gradient_slider_multivalue_set_marker(</a>
<a name="ln1089">      data-&gt;upper_slider,</a>
<a name="ln1090">      opolarity ? GRADIENT_SLIDER_MARKER_UPPER_FILLED_BIG : GRADIENT_SLIDER_MARKER_LOWER_FILLED_BIG, 1);</a>
<a name="ln1091">  dtgtk_gradient_slider_multivalue_set_marker(</a>
<a name="ln1092">      data-&gt;upper_slider,</a>
<a name="ln1093">      opolarity ? GRADIENT_SLIDER_MARKER_UPPER_FILLED_BIG : GRADIENT_SLIDER_MARKER_LOWER_FILLED_BIG, 2);</a>
<a name="ln1094">  dtgtk_gradient_slider_multivalue_set_marker(</a>
<a name="ln1095">      data-&gt;upper_slider,</a>
<a name="ln1096">      opolarity ? GRADIENT_SLIDER_MARKER_LOWER_OPEN_BIG : GRADIENT_SLIDER_MARKER_UPPER_OPEN_BIG, 3);</a>
<a name="ln1097"> </a>
<a name="ln1098">  for(int k = 0; k &lt; 4; k++)</a>
<a name="ln1099">  {</a>
<a name="ln1100">    dtgtk_gradient_slider_multivalue_set_value(data-&gt;lower_slider, iparameters[k], k);</a>
<a name="ln1101">    dtgtk_gradient_slider_multivalue_set_value(data-&gt;upper_slider, oparameters[k], k);</a>
<a name="ln1102">    dtgtk_gradient_slider_multivalue_set_resetvalue(data-&gt;lower_slider, idefaults[k], k);</a>
<a name="ln1103">    dtgtk_gradient_slider_multivalue_set_resetvalue(data-&gt;upper_slider, odefaults[k], k);</a>
<a name="ln1104">  }</a>
<a name="ln1105"> </a>
<a name="ln1106">  for(int k = 0; k &lt; 4; k++)</a>
<a name="ln1107">  {</a>
<a name="ln1108">    (data-&gt;scale_print[tab])(iparameters[k], text, sizeof(text));</a>
<a name="ln1109">    gtk_label_set_text(data-&gt;lower_label[k], text);</a>
<a name="ln1110">    (data-&gt;scale_print[tab])(oparameters[k], text, sizeof(text));</a>
<a name="ln1111">    gtk_label_set_text(data-&gt;upper_label[k], text);</a>
<a name="ln1112">  }</a>
<a name="ln1113"> </a>
<a name="ln1114">  dtgtk_gradient_slider_multivalue_clear_stops(data-&gt;lower_slider);</a>
<a name="ln1115">  dtgtk_gradient_slider_multivalue_clear_stops(data-&gt;upper_slider);</a>
<a name="ln1116"> </a>
<a name="ln1117">  for(int k = 0; k &lt; data-&gt;numberstops[tab]; k++)</a>
<a name="ln1118">  {</a>
<a name="ln1119">    dtgtk_gradient_slider_multivalue_set_stop(data-&gt;lower_slider, (data-&gt;colorstops[tab])[k].stoppoint,</a>
<a name="ln1120">                                              (data-&gt;colorstops[tab])[k].color);</a>
<a name="ln1121">    dtgtk_gradient_slider_multivalue_set_stop(data-&gt;upper_slider, (data-&gt;colorstops[tab])[k].stoppoint,</a>
<a name="ln1122">                                              (data-&gt;colorstops[tab])[k].color);</a>
<a name="ln1123">  }</a>
<a name="ln1124"> </a>
<a name="ln1125">  dtgtk_gradient_slider_multivalue_set_increment(data-&gt;lower_slider, data-&gt;increments[tab]);</a>
<a name="ln1126">  dtgtk_gradient_slider_multivalue_set_increment(data-&gt;upper_slider, data-&gt;increments[tab]);</a>
<a name="ln1127"> </a>
<a name="ln1128">  darktable.gui-&gt;reset = reset;</a>
<a name="ln1129">}</a>
<a name="ln1130"> </a>
<a name="ln1131"> </a>
<a name="ln1132">void dt_iop_gui_init_blendif(GtkBox *blendw, dt_iop_module_t *module)</a>
<a name="ln1133">{</a>
<a name="ln1134">  dt_iop_gui_blend_data_t *bd = (dt_iop_gui_blend_data_t *)module-&gt;blend_data;</a>
<a name="ln1135"> </a>
<a name="ln1136">  bd-&gt;blendif_box = GTK_BOX(gtk_box_new(GTK_ORIENTATION_VERTICAL, DT_BAUHAUS_SPACE));</a>
<a name="ln1137">  // add event box so that one can click into the area to get help for parametric masks</a>
<a name="ln1138">  GtkWidget* event_box = gtk_event_box_new();</a>
<a name="ln1139">  dt_gui_add_help_link(GTK_WIDGET(event_box), &quot;parametric_mask.html&quot;);</a>
<a name="ln1140">  gtk_container_add(GTK_CONTAINER(blendw), event_box);</a>
<a name="ln1141"> </a>
<a name="ln1142">  /* create and add blendif support if module supports it */</a>
<a name="ln1143">  if(bd-&gt;blendif_support)</a>
<a name="ln1144">  {</a>
<a name="ln1145">    char *Lab_labels[] = { &quot;  L  &quot;, &quot;  a  &quot;, &quot;  b  &quot;, &quot; C &quot;, &quot; h &quot; };</a>
<a name="ln1146">    char *Lab_tooltips[]</a>
<a name="ln1147">        = { _(&quot;sliders for L channel&quot;), _(&quot;sliders for a channel&quot;), _(&quot;sliders for b channel&quot;),</a>
<a name="ln1148">            _(&quot;sliders for chroma channel (of LCh)&quot;), _(&quot;sliders for hue channel (of LCh)&quot;) };</a>
<a name="ln1149">    char *rgb_labels[] = { _(&quot; g &quot;), _(&quot; R &quot;), _(&quot; G &quot;), _(&quot; B &quot;), _(&quot; H &quot;), _(&quot; S &quot;), _(&quot; L &quot;) };</a>
<a name="ln1150">    char *rgb_tooltips[]</a>
<a name="ln1151">        = { _(&quot;sliders for gray value&quot;), _(&quot;sliders for red channel&quot;), _(&quot;sliders for green channel&quot;),</a>
<a name="ln1152">            _(&quot;sliders for blue channel&quot;), _(&quot;sliders for hue channel (of HSL)&quot;),</a>
<a name="ln1153">            _(&quot;sliders for chroma channel (of HSL)&quot;), _(&quot;sliders for value channel (of HSL)&quot;) };</a>
<a name="ln1154"> </a>
<a name="ln1155">    char *ttinput = _(&quot;adjustment based on input received by this module:\n* range defined by upper markers: &quot;</a>
<a name="ln1156">                      &quot;blend fully\n* range defined by lower markers: do not blend at all\n* range between &quot;</a>
<a name="ln1157">                      &quot;adjacent upper/lower markers: blend gradually&quot;);</a>
<a name="ln1158"> </a>
<a name="ln1159">    char *ttoutput = _(&quot;adjustment based on unblended output of this module:\n* range defined by upper &quot;</a>
<a name="ln1160">                       &quot;markers: blend fully\n* range defined by lower markers: do not blend at all\n* range &quot;</a>
<a name="ln1161">                       &quot;between adjacent upper/lower markers: blend gradually&quot;);</a>
<a name="ln1162"> </a>
<a name="ln1163">    bd-&gt;tab = 0;</a>
<a name="ln1164">    const int bs = DT_PIXEL_APPLY_DPI(14);</a>
<a name="ln1165"> </a>
<a name="ln1166">    int maxchannels = 0;</a>
<a name="ln1167">    char **labels = NULL;</a>
<a name="ln1168">    char **tooltips = NULL;</a>
<a name="ln1169"> </a>
<a name="ln1170">    switch(bd-&gt;csp)</a>
<a name="ln1171">    {</a>
<a name="ln1172">      case iop_cs_Lab:</a>
<a name="ln1173">        maxchannels = 5;</a>
<a name="ln1174">        labels = Lab_labels;</a>
<a name="ln1175">        tooltips = Lab_tooltips;</a>
<a name="ln1176">        bd-&gt;scale_print[0] = _blendif_scale_print_L;</a>
<a name="ln1177">        bd-&gt;scale_print[1] = _blendif_scale_print_ab;</a>
<a name="ln1178">        bd-&gt;scale_print[2] = _blendif_scale_print_ab;</a>
<a name="ln1179">        bd-&gt;scale_print[3] = _blendif_scale_print_default;</a>
<a name="ln1180">        bd-&gt;scale_print[4] = _blendif_scale_print_hue;</a>
<a name="ln1181">        bd-&gt;increments[0] = 1.0f / 100.0f;</a>
<a name="ln1182">        bd-&gt;increments[1] = 1.0f / 256.0f;</a>
<a name="ln1183">        bd-&gt;increments[2] = 1.0f / 256.0f;</a>
<a name="ln1184">        bd-&gt;increments[3] = 1.0f / 100.0f;</a>
<a name="ln1185">        bd-&gt;increments[4] = 1.0f / 360.0f;</a>
<a name="ln1186">        bd-&gt;channels[0][0] = DEVELOP_BLENDIF_L_in;</a>
<a name="ln1187">        bd-&gt;channels[0][1] = DEVELOP_BLENDIF_L_out;</a>
<a name="ln1188">        bd-&gt;channels[1][0] = DEVELOP_BLENDIF_A_in;</a>
<a name="ln1189">        bd-&gt;channels[1][1] = DEVELOP_BLENDIF_A_out;</a>
<a name="ln1190">        bd-&gt;channels[2][0] = DEVELOP_BLENDIF_B_in;</a>
<a name="ln1191">        bd-&gt;channels[2][1] = DEVELOP_BLENDIF_B_out;</a>
<a name="ln1192">        bd-&gt;channels[3][0] = DEVELOP_BLENDIF_C_in;</a>
<a name="ln1193">        bd-&gt;channels[3][1] = DEVELOP_BLENDIF_C_out;</a>
<a name="ln1194">        bd-&gt;channels[4][0] = DEVELOP_BLENDIF_h_in;</a>
<a name="ln1195">        bd-&gt;channels[4][1] = DEVELOP_BLENDIF_h_out;</a>
<a name="ln1196">        bd-&gt;display_channel[0][0] = DT_DEV_PIXELPIPE_DISPLAY_L;</a>
<a name="ln1197">        bd-&gt;display_channel[0][1] = DT_DEV_PIXELPIPE_DISPLAY_L | DT_DEV_PIXELPIPE_DISPLAY_OUTPUT;</a>
<a name="ln1198">        bd-&gt;display_channel[1][0] = DT_DEV_PIXELPIPE_DISPLAY_a;</a>
<a name="ln1199">        bd-&gt;display_channel[1][1] = DT_DEV_PIXELPIPE_DISPLAY_a | DT_DEV_PIXELPIPE_DISPLAY_OUTPUT;</a>
<a name="ln1200">        bd-&gt;display_channel[2][0] = DT_DEV_PIXELPIPE_DISPLAY_b;</a>
<a name="ln1201">        bd-&gt;display_channel[2][1] = DT_DEV_PIXELPIPE_DISPLAY_b | DT_DEV_PIXELPIPE_DISPLAY_OUTPUT;</a>
<a name="ln1202">        bd-&gt;display_channel[3][0] = DT_DEV_PIXELPIPE_DISPLAY_LCH_C;</a>
<a name="ln1203">        bd-&gt;display_channel[3][1] = DT_DEV_PIXELPIPE_DISPLAY_LCH_C | DT_DEV_PIXELPIPE_DISPLAY_OUTPUT;</a>
<a name="ln1204">        bd-&gt;display_channel[4][0] = DT_DEV_PIXELPIPE_DISPLAY_LCH_h;</a>
<a name="ln1205">        bd-&gt;display_channel[4][1] = DT_DEV_PIXELPIPE_DISPLAY_LCH_h | DT_DEV_PIXELPIPE_DISPLAY_OUTPUT;</a>
<a name="ln1206">        bd-&gt;colorstops[0] = _gradient_L;</a>
<a name="ln1207">        bd-&gt;numberstops[0] = sizeof(_gradient_L) / sizeof(dt_iop_gui_blendif_colorstop_t);</a>
<a name="ln1208">        bd-&gt;colorstops[1] = _gradient_a;</a>
<a name="ln1209">        bd-&gt;numberstops[1] = sizeof(_gradient_a) / sizeof(dt_iop_gui_blendif_colorstop_t);</a>
<a name="ln1210">        bd-&gt;colorstops[2] = _gradient_b;</a>
<a name="ln1211">        bd-&gt;numberstops[2] = sizeof(_gradient_b) / sizeof(dt_iop_gui_blendif_colorstop_t);</a>
<a name="ln1212">        bd-&gt;colorstops[3] = _gradient_chroma;</a>
<a name="ln1213">        bd-&gt;numberstops[3] = sizeof(_gradient_chroma) / sizeof(dt_iop_gui_blendif_colorstop_t);</a>
<a name="ln1214">        bd-&gt;colorstops[4] = _gradient_hue;</a>
<a name="ln1215">        bd-&gt;numberstops[4] = sizeof(_gradient_hue) / sizeof(dt_iop_gui_blendif_colorstop_t);</a>
<a name="ln1216">        break;</a>
<a name="ln1217">      case iop_cs_rgb:</a>
<a name="ln1218">        maxchannels = 7;</a>
<a name="ln1219">        labels = rgb_labels;</a>
<a name="ln1220">        tooltips = rgb_tooltips;</a>
<a name="ln1221">        bd-&gt;scale_print[0] = _blendif_scale_print_rgb;</a>
<a name="ln1222">        bd-&gt;scale_print[1] = _blendif_scale_print_rgb;</a>
<a name="ln1223">        bd-&gt;scale_print[2] = _blendif_scale_print_rgb;</a>
<a name="ln1224">        bd-&gt;scale_print[3] = _blendif_scale_print_rgb;</a>
<a name="ln1225">        bd-&gt;scale_print[4] = _blendif_scale_print_hue;</a>
<a name="ln1226">        bd-&gt;scale_print[5] = _blendif_scale_print_default;</a>
<a name="ln1227">        bd-&gt;scale_print[6] = _blendif_scale_print_L;</a>
<a name="ln1228">        bd-&gt;increments[0] = 1.0f / 255.0f;</a>
<a name="ln1229">        bd-&gt;increments[1] = 1.0f / 255.0f;</a>
<a name="ln1230">        bd-&gt;increments[2] = 1.0f / 255.0f;</a>
<a name="ln1231">        bd-&gt;increments[3] = 1.0f / 255.0f;</a>
<a name="ln1232">        bd-&gt;increments[4] = 1.0f / 360.0f;</a>
<a name="ln1233">        bd-&gt;increments[5] = 1.0f / 100.0f;</a>
<a name="ln1234">        bd-&gt;increments[6] = 1.0f / 100.0f;</a>
<a name="ln1235">        bd-&gt;channels[0][0] = DEVELOP_BLENDIF_GRAY_in;</a>
<a name="ln1236">        bd-&gt;channels[0][1] = DEVELOP_BLENDIF_GRAY_out;</a>
<a name="ln1237">        bd-&gt;channels[1][0] = DEVELOP_BLENDIF_RED_in;</a>
<a name="ln1238">        bd-&gt;channels[1][1] = DEVELOP_BLENDIF_RED_out;</a>
<a name="ln1239">        bd-&gt;channels[2][0] = DEVELOP_BLENDIF_GREEN_in;</a>
<a name="ln1240">        bd-&gt;channels[2][1] = DEVELOP_BLENDIF_GREEN_out;</a>
<a name="ln1241">        bd-&gt;channels[3][0] = DEVELOP_BLENDIF_BLUE_in;</a>
<a name="ln1242">        bd-&gt;channels[3][1] = DEVELOP_BLENDIF_BLUE_out;</a>
<a name="ln1243">        bd-&gt;channels[4][0] = DEVELOP_BLENDIF_H_in;</a>
<a name="ln1244">        bd-&gt;channels[4][1] = DEVELOP_BLENDIF_H_out;</a>
<a name="ln1245">        bd-&gt;channels[5][0] = DEVELOP_BLENDIF_S_in;</a>
<a name="ln1246">        bd-&gt;channels[5][1] = DEVELOP_BLENDIF_S_out;</a>
<a name="ln1247">        bd-&gt;channels[6][0] = DEVELOP_BLENDIF_l_in;</a>
<a name="ln1248">        bd-&gt;channels[6][1] = DEVELOP_BLENDIF_l_out;</a>
<a name="ln1249">        bd-&gt;display_channel[0][0] = DT_DEV_PIXELPIPE_DISPLAY_GRAY;</a>
<a name="ln1250">        bd-&gt;display_channel[0][1] = DT_DEV_PIXELPIPE_DISPLAY_GRAY | DT_DEV_PIXELPIPE_DISPLAY_OUTPUT;</a>
<a name="ln1251">        bd-&gt;display_channel[1][0] = DT_DEV_PIXELPIPE_DISPLAY_R;</a>
<a name="ln1252">        bd-&gt;display_channel[1][1] = DT_DEV_PIXELPIPE_DISPLAY_R | DT_DEV_PIXELPIPE_DISPLAY_OUTPUT;</a>
<a name="ln1253">        bd-&gt;display_channel[2][0] = DT_DEV_PIXELPIPE_DISPLAY_G;</a>
<a name="ln1254">        bd-&gt;display_channel[2][1] = DT_DEV_PIXELPIPE_DISPLAY_G | DT_DEV_PIXELPIPE_DISPLAY_OUTPUT;</a>
<a name="ln1255">        bd-&gt;display_channel[3][0] = DT_DEV_PIXELPIPE_DISPLAY_B;</a>
<a name="ln1256">        bd-&gt;display_channel[3][1] = DT_DEV_PIXELPIPE_DISPLAY_B | DT_DEV_PIXELPIPE_DISPLAY_OUTPUT;</a>
<a name="ln1257">        bd-&gt;display_channel[4][0] = DT_DEV_PIXELPIPE_DISPLAY_HSL_H;</a>
<a name="ln1258">        bd-&gt;display_channel[4][1] = DT_DEV_PIXELPIPE_DISPLAY_HSL_H | DT_DEV_PIXELPIPE_DISPLAY_OUTPUT;</a>
<a name="ln1259">        bd-&gt;display_channel[5][0] = DT_DEV_PIXELPIPE_DISPLAY_HSL_S;</a>
<a name="ln1260">        bd-&gt;display_channel[5][1] = DT_DEV_PIXELPIPE_DISPLAY_HSL_S | DT_DEV_PIXELPIPE_DISPLAY_OUTPUT;</a>
<a name="ln1261">        bd-&gt;display_channel[6][0] = DT_DEV_PIXELPIPE_DISPLAY_HSL_l;</a>
<a name="ln1262">        bd-&gt;display_channel[6][1] = DT_DEV_PIXELPIPE_DISPLAY_HSL_l | DT_DEV_PIXELPIPE_DISPLAY_OUTPUT;</a>
<a name="ln1263">        bd-&gt;colorstops[0] = _gradient_gray;</a>
<a name="ln1264">        bd-&gt;numberstops[0] = sizeof(_gradient_gray) / sizeof(dt_iop_gui_blendif_colorstop_t);</a>
<a name="ln1265">        bd-&gt;colorstops[1] = _gradient_red;</a>
<a name="ln1266">        bd-&gt;numberstops[1] = sizeof(_gradient_red) / sizeof(dt_iop_gui_blendif_colorstop_t);</a>
<a name="ln1267">        bd-&gt;colorstops[2] = _gradient_green;</a>
<a name="ln1268">        bd-&gt;numberstops[2] = sizeof(_gradient_green) / sizeof(dt_iop_gui_blendif_colorstop_t);</a>
<a name="ln1269">        bd-&gt;colorstops[3] = _gradient_blue;</a>
<a name="ln1270">        bd-&gt;numberstops[3] = sizeof(_gradient_blue) / sizeof(dt_iop_gui_blendif_colorstop_t);</a>
<a name="ln1271">        bd-&gt;colorstops[4] = _gradient_HUE;</a>
<a name="ln1272">        bd-&gt;numberstops[4] = sizeof(_gradient_HUE) / sizeof(dt_iop_gui_blendif_colorstop_t);</a>
<a name="ln1273">        bd-&gt;colorstops[5] = _gradient_chroma;</a>
<a name="ln1274">        bd-&gt;numberstops[5] = sizeof(_gradient_chroma) / sizeof(dt_iop_gui_blendif_colorstop_t);</a>
<a name="ln1275">        bd-&gt;colorstops[6] = _gradient_gray;</a>
<a name="ln1276">        bd-&gt;numberstops[6] = sizeof(_gradient_gray) / sizeof(dt_iop_gui_blendif_colorstop_t);</a>
<a name="ln1277">        break;</a>
<a name="ln1278">      default:</a>
<a name="ln1279">        assert(FALSE); // blendif not supported for RAW, which is already caught upstream; we should not get</a>
<a name="ln1280">                       // here</a>
<a name="ln1281">    }</a>
<a name="ln1282"> </a>
<a name="ln1283">    GtkWidget *uplabel = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0);</a>
<a name="ln1284">    GtkWidget *lowlabel = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0);</a>
<a name="ln1285">    GtkWidget *upslider = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, DT_PIXEL_APPLY_DPI(5));</a>
<a name="ln1286">    GtkWidget *lowslider = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, DT_PIXEL_APPLY_DPI(5));</a>
<a name="ln1287">    GtkWidget *notebook = gtk_box_new(GTK_ORIENTATION_VERTICAL, 0);</a>
<a name="ln1288">    GtkWidget *header = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, DT_PIXEL_APPLY_DPI(5));</a>
<a name="ln1289"> </a>
<a name="ln1290">    bd-&gt;channel_tabs = GTK_NOTEBOOK(gtk_notebook_new());</a>
<a name="ln1291"> </a>
<a name="ln1292">    for(int ch = 0; ch &lt; maxchannels; ch++)</a>
<a name="ln1293">    {</a>
<a name="ln1294">      gtk_notebook_append_page(GTK_NOTEBOOK(bd-&gt;channel_tabs),</a>
<a name="ln1295">                               GTK_WIDGET(gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0)),</a>
<a name="ln1296">                               gtk_label_new(labels[ch]));</a>
<a name="ln1297">      gtk_widget_set_tooltip_text(gtk_notebook_get_tab_label(bd-&gt;channel_tabs,</a>
<a name="ln1298">                                                             gtk_notebook_get_nth_page(bd-&gt;channel_tabs, -1)),</a>
<a name="ln1299">                                  tooltips[ch]);</a>
<a name="ln1300">    }</a>
<a name="ln1301"> </a>
<a name="ln1302">    gtk_widget_show_all(GTK_WIDGET(gtk_notebook_get_nth_page(bd-&gt;channel_tabs, bd-&gt;tab)));</a>
<a name="ln1303">    gtk_notebook_set_current_page(GTK_NOTEBOOK(bd-&gt;channel_tabs), bd-&gt;tab);</a>
<a name="ln1304">    gtk_notebook_set_scrollable(bd-&gt;channel_tabs, TRUE);</a>
<a name="ln1305"> </a>
<a name="ln1306">    gtk_box_pack_start(GTK_BOX(notebook), GTK_WIDGET(bd-&gt;channel_tabs), FALSE, FALSE, 0);</a>
<a name="ln1307"> </a>
<a name="ln1308">    bd-&gt;colorpicker</a>
<a name="ln1309">        = dtgtk_togglebutton_new(dtgtk_cairo_paint_colorpicker, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln1310">    gtk_widget_set_tooltip_text(bd-&gt;colorpicker, _(&quot;pick GUI color from image&quot;));</a>
<a name="ln1311">    gtk_widget_set_size_request(GTK_WIDGET(bd-&gt;colorpicker), bs, bs);</a>
<a name="ln1312"> </a>
<a name="ln1313">    GtkWidget *res = dtgtk_button_new(dtgtk_cairo_paint_reset, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln1314">    gtk_widget_set_tooltip_text(res, _(&quot;reset blend mask settings&quot;));</a>
<a name="ln1315">    gtk_widget_set_size_request(res, bs, bs);</a>
<a name="ln1316"> </a>
<a name="ln1317">    GtkWidget *inv = dtgtk_button_new(dtgtk_cairo_paint_invert, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln1318">    gtk_widget_set_tooltip_text(inv, _(&quot;invert all channel's polarities&quot;));</a>
<a name="ln1319">    gtk_widget_set_size_request(inv, bs, bs);</a>
<a name="ln1320"> </a>
<a name="ln1321">    gtk_box_pack_start(GTK_BOX(header), GTK_WIDGET(notebook), TRUE, TRUE, 0);</a>
<a name="ln1322">    gtk_box_pack_end(GTK_BOX(header), GTK_WIDGET(res), FALSE, FALSE, 0);</a>
<a name="ln1323">    gtk_box_pack_end(GTK_BOX(header), GTK_WIDGET(inv), FALSE, FALSE, 0);</a>
<a name="ln1324">    gtk_box_pack_end(GTK_BOX(header), GTK_WIDGET(bd-&gt;colorpicker), FALSE, FALSE, 0);</a>
<a name="ln1325"> </a>
<a name="ln1326">    bd-&gt;lower_slider = DTGTK_GRADIENT_SLIDER_MULTIVALUE(dtgtk_gradient_slider_multivalue_new(4));</a>
<a name="ln1327">    bd-&gt;upper_slider = DTGTK_GRADIENT_SLIDER_MULTIVALUE(dtgtk_gradient_slider_multivalue_new(4));</a>
<a name="ln1328"> </a>
<a name="ln1329">    bd-&gt;lower_polarity</a>
<a name="ln1330">        = dtgtk_togglebutton_new(dtgtk_cairo_paint_plusminus, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln1331">    gtk_widget_set_tooltip_text(bd-&gt;lower_polarity, _(&quot;toggle polarity. best seen by enabling 'display mask'&quot;));</a>
<a name="ln1332"> </a>
<a name="ln1333">    bd-&gt;upper_polarity</a>
<a name="ln1334">        = dtgtk_togglebutton_new(dtgtk_cairo_paint_plusminus, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln1335">    gtk_widget_set_tooltip_text(bd-&gt;upper_polarity, _(&quot;toggle polarity. best seen by enabling 'display mask'&quot;));</a>
<a name="ln1336"> </a>
<a name="ln1337">    gtk_box_pack_start(GTK_BOX(upslider), GTK_WIDGET(bd-&gt;upper_slider), TRUE, TRUE, 0);</a>
<a name="ln1338">    gtk_box_pack_end(GTK_BOX(upslider), GTK_WIDGET(bd-&gt;upper_polarity), FALSE, FALSE, 0);</a>
<a name="ln1339"> </a>
<a name="ln1340">    gtk_box_pack_start(GTK_BOX(lowslider), GTK_WIDGET(bd-&gt;lower_slider), TRUE, TRUE, 0);</a>
<a name="ln1341">    gtk_box_pack_end(GTK_BOX(lowslider), GTK_WIDGET(bd-&gt;lower_polarity), FALSE, FALSE, 0);</a>
<a name="ln1342"> </a>
<a name="ln1343"> </a>
<a name="ln1344">    GtkWidget *output = gtk_label_new(_(&quot;output&quot;));</a>
<a name="ln1345">    bd-&gt;upper_picker_label = GTK_LABEL(gtk_label_new(&quot;&quot;));</a>
<a name="ln1346">    gtk_box_pack_start(GTK_BOX(uplabel), GTK_WIDGET(output), FALSE, FALSE, 0);</a>
<a name="ln1347">    gtk_box_pack_start(GTK_BOX(uplabel), GTK_WIDGET(bd-&gt;upper_picker_label), TRUE, TRUE, 0);</a>
<a name="ln1348">    for(int k = 0; k &lt; 4; k++)</a>
<a name="ln1349">    {</a>
<a name="ln1350">      bd-&gt;upper_label[k] = GTK_LABEL(gtk_label_new(NULL));</a>
<a name="ln1351">      gtk_label_set_width_chars(bd-&gt;upper_label[k], 5);</a>
<a name="ln1352">      gtk_box_pack_start(GTK_BOX(uplabel), GTK_WIDGET(bd-&gt;upper_label[k]), FALSE, FALSE, 0);</a>
<a name="ln1353">    }</a>
<a name="ln1354"> </a>
<a name="ln1355">    GtkWidget *input = gtk_label_new(_(&quot;input&quot;));</a>
<a name="ln1356">    bd-&gt;lower_picker_label = GTK_LABEL(gtk_label_new(&quot;&quot;));</a>
<a name="ln1357">    gtk_box_pack_start(GTK_BOX(lowlabel), GTK_WIDGET(input), FALSE, FALSE, 0);</a>
<a name="ln1358">    gtk_box_pack_start(GTK_BOX(lowlabel), GTK_WIDGET(bd-&gt;lower_picker_label), TRUE, TRUE, 0);</a>
<a name="ln1359">    for(int k = 0; k &lt; 4; k++)</a>
<a name="ln1360">    {</a>
<a name="ln1361">      bd-&gt;lower_label[k] = GTK_LABEL(gtk_label_new(NULL));</a>
<a name="ln1362">      gtk_label_set_width_chars(bd-&gt;lower_label[k], 5);</a>
<a name="ln1363">      gtk_box_pack_start(GTK_BOX(lowlabel), GTK_WIDGET(bd-&gt;lower_label[k]), FALSE, FALSE, 0);</a>
<a name="ln1364">    }</a>
<a name="ln1365"> </a>
<a name="ln1366">    gtk_widget_set_tooltip_text(GTK_WIDGET(bd-&gt;lower_slider), _(&quot;double click to reset&quot;));</a>
<a name="ln1367">    gtk_widget_set_tooltip_text(GTK_WIDGET(bd-&gt;upper_slider), _(&quot;double click to reset&quot;));</a>
<a name="ln1368">    gtk_widget_set_tooltip_text(output, ttoutput);</a>
<a name="ln1369">    gtk_widget_set_tooltip_text(input, ttinput);</a>
<a name="ln1370"> </a>
<a name="ln1371">    g_signal_connect(G_OBJECT(bd-&gt;lower_slider), &quot;draw&quot;, G_CALLBACK(_blendop_blendif_draw), module);</a>
<a name="ln1372"> </a>
<a name="ln1373">    g_signal_connect(G_OBJECT(bd-&gt;upper_slider), &quot;draw&quot;, G_CALLBACK(_blendop_blendif_draw), module);</a>
<a name="ln1374"> </a>
<a name="ln1375">    g_signal_connect(G_OBJECT(bd-&gt;channel_tabs), &quot;switch_page&quot;, G_CALLBACK(_blendop_blendif_tab_switch), bd);</a>
<a name="ln1376"> </a>
<a name="ln1377">    g_signal_connect(G_OBJECT(bd-&gt;upper_slider), &quot;value-changed&quot;, G_CALLBACK(_blendop_blendif_upper_callback),</a>
<a name="ln1378">                     bd);</a>
<a name="ln1379"> </a>
<a name="ln1380">    g_signal_connect(G_OBJECT(bd-&gt;lower_slider), &quot;value-changed&quot;, G_CALLBACK(_blendop_blendif_lower_callback),</a>
<a name="ln1381">                     bd);</a>
<a name="ln1382"> </a>
<a name="ln1383">    g_signal_connect(G_OBJECT(bd-&gt;lower_slider), &quot;leave-notify-event&quot;, G_CALLBACK(_blendop_blendif_leave), module);</a>
<a name="ln1384"> </a>
<a name="ln1385">    g_signal_connect(G_OBJECT(bd-&gt;upper_slider), &quot;leave-notify-event&quot;, G_CALLBACK(_blendop_blendif_leave), module);</a>
<a name="ln1386"> </a>
<a name="ln1387">    g_signal_connect(G_OBJECT(bd-&gt;lower_slider), &quot;enter-notify-event&quot;, G_CALLBACK(_blendop_blendif_enter), module);</a>
<a name="ln1388"> </a>
<a name="ln1389">    g_signal_connect(G_OBJECT(bd-&gt;upper_slider), &quot;enter-notify-event&quot;, G_CALLBACK(_blendop_blendif_enter), module);</a>
<a name="ln1390"> </a>
<a name="ln1391">    g_signal_connect(G_OBJECT(bd-&gt;colorpicker), &quot;toggled&quot;, G_CALLBACK(_blendop_blendif_pick_toggled), module);</a>
<a name="ln1392"> </a>
<a name="ln1393">    g_signal_connect(G_OBJECT(res), &quot;clicked&quot;, G_CALLBACK(_blendop_blendif_reset), module);</a>
<a name="ln1394"> </a>
<a name="ln1395">    g_signal_connect(G_OBJECT(inv), &quot;clicked&quot;, G_CALLBACK(_blendop_blendif_invert), module);</a>
<a name="ln1396"> </a>
<a name="ln1397">    g_signal_connect(G_OBJECT(bd-&gt;lower_polarity), &quot;toggled&quot;, G_CALLBACK(_blendop_blendif_polarity_callback),</a>
<a name="ln1398">                     bd);</a>
<a name="ln1399"> </a>
<a name="ln1400">    g_signal_connect(G_OBJECT(bd-&gt;upper_polarity), &quot;toggled&quot;, G_CALLBACK(_blendop_blendif_polarity_callback),</a>
<a name="ln1401">                     bd);</a>
<a name="ln1402"> </a>
<a name="ln1403">    gtk_box_pack_start(GTK_BOX(bd-&gt;blendif_box), dt_ui_section_label_new(_(&quot;parametric mask&quot;)), TRUE, TRUE, 0);</a>
<a name="ln1404">    gtk_box_pack_start(GTK_BOX(bd-&gt;blendif_box), GTK_WIDGET(header), TRUE, FALSE, 0);</a>
<a name="ln1405">    gtk_box_pack_start(GTK_BOX(bd-&gt;blendif_box), GTK_WIDGET(uplabel), TRUE, FALSE, 0);</a>
<a name="ln1406">    gtk_box_pack_start(GTK_BOX(bd-&gt;blendif_box), GTK_WIDGET(upslider), TRUE, FALSE, 0);</a>
<a name="ln1407">    gtk_box_pack_start(GTK_BOX(bd-&gt;blendif_box), GTK_WIDGET(lowlabel), TRUE, FALSE, 0);</a>
<a name="ln1408">    gtk_box_pack_start(GTK_BOX(bd-&gt;blendif_box), GTK_WIDGET(lowslider), TRUE, FALSE, 0);</a>
<a name="ln1409"> </a>
<a name="ln1410">    bd-&gt;blendif_inited = 1;</a>
<a name="ln1411">  }</a>
<a name="ln1412"> </a>
<a name="ln1413">  gtk_container_add(GTK_CONTAINER(event_box), GTK_WIDGET(bd-&gt;blendif_box));</a>
<a name="ln1414">}</a>
<a name="ln1415"> </a>
<a name="ln1416">void dt_iop_gui_update_masks(dt_iop_module_t *module)</a>
<a name="ln1417">{</a>
<a name="ln1418">  dt_iop_gui_blend_data_t *bd = (dt_iop_gui_blend_data_t *)module-&gt;blend_data;</a>
<a name="ln1419">  dt_develop_blend_params_t *bp = module-&gt;blend_params;</a>
<a name="ln1420"> </a>
<a name="ln1421">  if(!bd || !bd-&gt;masks_support || !bd-&gt;masks_inited) return;</a>
<a name="ln1422"> </a>
<a name="ln1423">  /* update masks state */</a>
<a name="ln1424">  dt_masks_form_t *grp = dt_masks_get_from_id(darktable.develop, module-&gt;blend_params-&gt;mask_id);</a>
<a name="ln1425">  dt_bauhaus_combobox_clear(bd-&gt;masks_combo);</a>
<a name="ln1426">  if(grp &amp;&amp; (grp-&gt;type &amp; DT_MASKS_GROUP) &amp;&amp; g_list_length(grp-&gt;points) &gt; 0)</a>
<a name="ln1427">  {</a>
<a name="ln1428">    char txt[512];</a>
<a name="ln1429">    guint n = g_list_length(grp-&gt;points);</a>
<a name="ln1430">    snprintf(txt, sizeof(txt), ngettext(&quot;%d shape used&quot;, &quot;%d shapes used&quot;, n), n);</a>
<a name="ln1431">    dt_bauhaus_combobox_add(bd-&gt;masks_combo, txt);</a>
<a name="ln1432">  }</a>
<a name="ln1433">  else</a>
<a name="ln1434">  {</a>
<a name="ln1435">    dt_bauhaus_combobox_add(bd-&gt;masks_combo, _(&quot;no mask used&quot;));</a>
<a name="ln1436">    bd-&gt;masks_shown = DT_MASKS_EDIT_OFF;</a>
<a name="ln1437">    // reset the gui</a>
<a name="ln1438">    dt_masks_set_edit_mode(module, DT_MASKS_EDIT_OFF);</a>
<a name="ln1439">  }</a>
<a name="ln1440">  dt_bauhaus_combobox_set(bd-&gt;masks_combo, 0);</a>
<a name="ln1441"> </a>
<a name="ln1442">  gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_edit), bd-&gt;masks_shown != DT_MASKS_EDIT_OFF);</a>
<a name="ln1443">  gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_polarity),</a>
<a name="ln1444">                               bp-&gt;mask_combine &amp; DEVELOP_COMBINE_MASKS_POS);</a>
<a name="ln1445"> </a>
<a name="ln1446">  // update buttons status</a>
<a name="ln1447">  int b1 = 0, b2 = 0, b3 = 0, b4 = 0, b5 = 0;</a>
<a name="ln1448">  if(module-&gt;dev-&gt;form_gui &amp;&amp; module-&gt;dev-&gt;form_visible &amp;&amp; module-&gt;dev-&gt;form_gui-&gt;creation</a>
<a name="ln1449">     &amp;&amp; module-&gt;dev-&gt;form_gui-&gt;creation_module == module)</a>
<a name="ln1450">  {</a>
<a name="ln1451">    if(module-&gt;dev-&gt;form_visible-&gt;type &amp; DT_MASKS_CIRCLE)</a>
<a name="ln1452">      b1 = 1;</a>
<a name="ln1453">    else if(module-&gt;dev-&gt;form_visible-&gt;type &amp; DT_MASKS_PATH)</a>
<a name="ln1454">      b2 = 1;</a>
<a name="ln1455">    else if(module-&gt;dev-&gt;form_visible-&gt;type &amp; DT_MASKS_GRADIENT)</a>
<a name="ln1456">      b3 = 1;</a>
<a name="ln1457">    else if(module-&gt;dev-&gt;form_visible-&gt;type &amp; DT_MASKS_ELLIPSE)</a>
<a name="ln1458">      b4 = 1;</a>
<a name="ln1459">    else if(module-&gt;dev-&gt;form_visible-&gt;type &amp; DT_MASKS_BRUSH)</a>
<a name="ln1460">      b5 = 1;</a>
<a name="ln1461">  }</a>
<a name="ln1462">  gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_circle), b1);</a>
<a name="ln1463">  gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_path), b2);</a>
<a name="ln1464">  gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_gradient), b3);</a>
<a name="ln1465">  gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_ellipse), b4);</a>
<a name="ln1466">  gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_brush), b5);</a>
<a name="ln1467">}</a>
<a name="ln1468"> </a>
<a name="ln1469">void dt_iop_gui_init_masks(GtkBox *blendw, dt_iop_module_t *module)</a>
<a name="ln1470">{</a>
<a name="ln1471">  dt_iop_gui_blend_data_t *bd = (dt_iop_gui_blend_data_t *)module-&gt;blend_data;</a>
<a name="ln1472"> </a>
<a name="ln1473">  bd-&gt;masks_box = GTK_BOX(gtk_box_new(GTK_ORIENTATION_VERTICAL, DT_BAUHAUS_SPACE));</a>
<a name="ln1474">  // add event box so that one can click into the area to get help for drawn masks</a>
<a name="ln1475">  GtkWidget* event_box = gtk_event_box_new();</a>
<a name="ln1476">  dt_gui_add_help_link(GTK_WIDGET(event_box), &quot;drawn_mask.html&quot;);</a>
<a name="ln1477">  gtk_container_add(GTK_CONTAINER(blendw), event_box);</a>
<a name="ln1478"> </a>
<a name="ln1479">  /* create and add masks support if module supports it */</a>
<a name="ln1480">  if(bd-&gt;masks_support)</a>
<a name="ln1481">  {</a>
<a name="ln1482">    const int bs = DT_PIXEL_APPLY_DPI(14);</a>
<a name="ln1483"> </a>
<a name="ln1484">    bd-&gt;masks_combo_ids = NULL;</a>
<a name="ln1485">    bd-&gt;masks_shown = DT_MASKS_EDIT_OFF;</a>
<a name="ln1486"> </a>
<a name="ln1487">    GtkWidget *hbox = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0);</a>
<a name="ln1488">    GtkWidget *abox = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0);</a>
<a name="ln1489"> </a>
<a name="ln1490">    bd-&gt;masks_combo = dt_bauhaus_combobox_new(module);</a>
<a name="ln1491">    dt_bauhaus_widget_set_label(bd-&gt;masks_combo, _(&quot;blend&quot;), _(&quot;drawn mask&quot;));</a>
<a name="ln1492">    dt_bauhaus_combobox_add(bd-&gt;masks_combo, _(&quot;no mask used&quot;));</a>
<a name="ln1493">    dt_bauhaus_combobox_set(bd-&gt;masks_combo, 0);</a>
<a name="ln1494">    g_signal_connect(G_OBJECT(bd-&gt;masks_combo), &quot;value-changed&quot;,</a>
<a name="ln1495">                     G_CALLBACK(dt_masks_iop_value_changed_callback), module);</a>
<a name="ln1496">    dt_bauhaus_combobox_add_populate_fct(bd-&gt;masks_combo, dt_masks_iop_combo_populate);</a>
<a name="ln1497">    gtk_box_pack_start(GTK_BOX(hbox), bd-&gt;masks_combo, TRUE, TRUE, 0);</a>
<a name="ln1498"> </a>
<a name="ln1499">    bd-&gt;masks_edit</a>
<a name="ln1500">        = dtgtk_togglebutton_new(dtgtk_cairo_paint_masks_eye, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln1501">    g_signal_connect(G_OBJECT(bd-&gt;masks_edit), &quot;button-press-event&quot;, G_CALLBACK(_blendop_masks_show_and_edit),</a>
<a name="ln1502">                     module);</a>
<a name="ln1503">    gtk_widget_set_tooltip_text(bd-&gt;masks_edit, _(&quot;show and edit mask elements&quot;));</a>
<a name="ln1504">    gtk_widget_set_size_request(GTK_WIDGET(bd-&gt;masks_edit), bs, bs);</a>
<a name="ln1505">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_edit), FALSE);</a>
<a name="ln1506">    gtk_box_pack_start(GTK_BOX(hbox), bd-&gt;masks_edit, FALSE, FALSE, 0);</a>
<a name="ln1507"> </a>
<a name="ln1508">    bd-&gt;masks_polarity</a>
<a name="ln1509">        = dtgtk_togglebutton_new(dtgtk_cairo_paint_plusminus, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln1510">    gtk_widget_set_tooltip_text(bd-&gt;masks_polarity, _(&quot;toggle polarity of drawn mask&quot;));</a>
<a name="ln1511">    g_signal_connect(G_OBJECT(bd-&gt;masks_polarity), &quot;toggled&quot;, G_CALLBACK(_blendop_masks_polarity_callback),</a>
<a name="ln1512">                     module);</a>
<a name="ln1513">    gtk_widget_set_size_request(GTK_WIDGET(bd-&gt;masks_polarity), bs, bs);</a>
<a name="ln1514">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_polarity), FALSE);</a>
<a name="ln1515">    gtk_box_pack_start(GTK_BOX(hbox), bd-&gt;masks_polarity, FALSE, FALSE, 0);</a>
<a name="ln1516"> </a>
<a name="ln1517">    bd-&gt;masks_gradient</a>
<a name="ln1518">        = dtgtk_togglebutton_new(dtgtk_cairo_paint_masks_gradient, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln1519">    g_signal_connect(G_OBJECT(bd-&gt;masks_gradient), &quot;button-press-event&quot;,</a>
<a name="ln1520">                     G_CALLBACK(_blendop_masks_add_gradient), module);</a>
<a name="ln1521">    gtk_widget_set_tooltip_text(bd-&gt;masks_gradient, _(&quot;add gradient&quot;));</a>
<a name="ln1522">    gtk_widget_set_size_request(GTK_WIDGET(bd-&gt;masks_gradient), bs, bs);</a>
<a name="ln1523">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_gradient), FALSE);</a>
<a name="ln1524">    gtk_box_pack_end(GTK_BOX(abox), bd-&gt;masks_gradient, FALSE, FALSE, 0);</a>
<a name="ln1525"> </a>
<a name="ln1526">    bd-&gt;masks_path</a>
<a name="ln1527">        = dtgtk_togglebutton_new(dtgtk_cairo_paint_masks_path, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln1528">    g_signal_connect(G_OBJECT(bd-&gt;masks_path), &quot;button-press-event&quot;, G_CALLBACK(_blendop_masks_add_path),</a>
<a name="ln1529">                     module);</a>
<a name="ln1530">    gtk_widget_set_tooltip_text(bd-&gt;masks_path, _(&quot;add path&quot;));</a>
<a name="ln1531">    gtk_widget_set_size_request(GTK_WIDGET(bd-&gt;masks_path), bs, bs);</a>
<a name="ln1532">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_path), FALSE);</a>
<a name="ln1533">    gtk_box_pack_end(GTK_BOX(abox), bd-&gt;masks_path, FALSE, FALSE, bs);</a>
<a name="ln1534"> </a>
<a name="ln1535">    bd-&gt;masks_ellipse</a>
<a name="ln1536">        = dtgtk_togglebutton_new(dtgtk_cairo_paint_masks_ellipse, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln1537">    g_signal_connect(G_OBJECT(bd-&gt;masks_ellipse), &quot;button-press-event&quot;,</a>
<a name="ln1538">                     G_CALLBACK(_blendop_masks_add_ellipse), module);</a>
<a name="ln1539">    gtk_widget_set_tooltip_text(bd-&gt;masks_ellipse, _(&quot;add ellipse&quot;));</a>
<a name="ln1540">    gtk_widget_set_size_request(GTK_WIDGET(bd-&gt;masks_ellipse), bs, bs);</a>
<a name="ln1541">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_ellipse), FALSE);</a>
<a name="ln1542">    gtk_box_pack_end(GTK_BOX(abox), bd-&gt;masks_ellipse, FALSE, FALSE, 0);</a>
<a name="ln1543"> </a>
<a name="ln1544">    bd-&gt;masks_circle</a>
<a name="ln1545">        = dtgtk_togglebutton_new(dtgtk_cairo_paint_masks_circle, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln1546">    g_signal_connect(G_OBJECT(bd-&gt;masks_circle), &quot;button-press-event&quot;, G_CALLBACK(_blendop_masks_add_circle),</a>
<a name="ln1547">                     module);</a>
<a name="ln1548">    gtk_widget_set_tooltip_text(bd-&gt;masks_circle, _(&quot;add circle&quot;));</a>
<a name="ln1549">    gtk_widget_set_size_request(GTK_WIDGET(bd-&gt;masks_circle), bs, bs);</a>
<a name="ln1550">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_circle), FALSE);</a>
<a name="ln1551">    gtk_box_pack_end(GTK_BOX(abox), bd-&gt;masks_circle, FALSE, FALSE, bs);</a>
<a name="ln1552"> </a>
<a name="ln1553">    bd-&gt;masks_brush</a>
<a name="ln1554">        = dtgtk_togglebutton_new(dtgtk_cairo_paint_masks_brush, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln1555">    g_signal_connect(G_OBJECT(bd-&gt;masks_brush), &quot;button-press-event&quot;, G_CALLBACK(_blendop_masks_add_brush),</a>
<a name="ln1556">                     module);</a>
<a name="ln1557">    gtk_widget_set_tooltip_text(bd-&gt;masks_brush, _(&quot;add brush&quot;));</a>
<a name="ln1558">    gtk_widget_set_size_request(GTK_WIDGET(bd-&gt;masks_brush), bs, bs);</a>
<a name="ln1559">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_brush), FALSE);</a>
<a name="ln1560">    gtk_box_pack_end(GTK_BOX(abox), bd-&gt;masks_brush, FALSE, FALSE, 0);</a>
<a name="ln1561"> </a>
<a name="ln1562"> </a>
<a name="ln1563">    gtk_box_pack_start(GTK_BOX(bd-&gt;masks_box), dt_ui_section_label_new(_(&quot;drawn mask&quot;)), TRUE, TRUE, 0);</a>
<a name="ln1564">    gtk_box_pack_start(GTK_BOX(bd-&gt;masks_box), GTK_WIDGET(hbox), TRUE, TRUE, 0);</a>
<a name="ln1565">    gtk_box_pack_start(GTK_BOX(bd-&gt;masks_box), GTK_WIDGET(abox), TRUE, TRUE, 0);</a>
<a name="ln1566"> </a>
<a name="ln1567">    bd-&gt;masks_inited = 1;</a>
<a name="ln1568">  }</a>
<a name="ln1569">  gtk_container_add(GTK_CONTAINER(event_box), GTK_WIDGET(bd-&gt;masks_box));</a>
<a name="ln1570">}</a>
<a name="ln1571"> </a>
<a name="ln1572">typedef struct raster_combo_entry_t</a>
<a name="ln1573">{</a>
<a name="ln1574">  dt_iop_module_t *module;</a>
<a name="ln1575">  int id;</a>
<a name="ln1576">} raster_combo_entry_t;</a>
<a name="ln1577"> </a>
<a name="ln1578">static void _raster_combo_populate(GtkWidget *w, struct dt_iop_module_t **m)</a>
<a name="ln1579">{</a>
<a name="ln1580">  dt_iop_module_t *module = *m;</a>
<a name="ln1581">  dt_iop_request_focus(module);</a>
<a name="ln1582"> </a>
<a name="ln1583">  dt_bauhaus_combobox_clear(w);</a>
<a name="ln1584"> </a>
<a name="ln1585">  raster_combo_entry_t *entry = (raster_combo_entry_t *)malloc(sizeof(raster_combo_entry_t));</a>
<a name="ln1586">  entry-&gt;module = NULL;</a>
<a name="ln1587">  entry-&gt;id = 0;</a>
<a name="ln1588">  dt_bauhaus_combobox_add_full(w, _(&quot;no mask used&quot;), DT_BAUHAUS_COMBOBOX_ALIGN_RIGHT, entry, free);</a>
<a name="ln1589"> </a>
<a name="ln1590">  int i = 1;</a>
<a name="ln1591"> </a>
<a name="ln1592">  for(GList* iter = darktable.develop-&gt;iop; iter; iter = g_list_next(iter))</a>
<a name="ln1593">  {</a>
<a name="ln1594">    dt_iop_module_t *iop = (dt_iop_module_t *)iter-&gt;data;</a>
<a name="ln1595">    if(iop == module)</a>
<a name="ln1596">      break;</a>
<a name="ln1597"> </a>
<a name="ln1598">    GHashTableIter masks_iter;</a>
<a name="ln1599">    gpointer key, value;</a>
<a name="ln1600"> </a>
<a name="ln1601">    g_hash_table_iter_init(&amp;masks_iter, iop-&gt;raster_mask.source.masks);</a>
<a name="ln1602">    while(g_hash_table_iter_next(&amp;masks_iter, &amp;key, &amp;value))</a>
<a name="ln1603">    {</a>
<a name="ln1604">      const int id = GPOINTER_TO_INT(key);</a>
<a name="ln1605">      const char *modulename = (char *)value;</a>
<a name="ln1606">      entry = (raster_combo_entry_t *)malloc(sizeof(raster_combo_entry_t));</a>
<a name="ln1607">      entry-&gt;module = iop;</a>
<a name="ln1608">      entry-&gt;id = id;</a>
<a name="ln1609">      dt_bauhaus_combobox_add_full(w, modulename, DT_BAUHAUS_COMBOBOX_ALIGN_RIGHT, entry, free);</a>
<a name="ln1610">      if(iop == module-&gt;raster_mask.sink.source &amp;&amp; module-&gt;raster_mask.sink.id == id)</a>
<a name="ln1611">        dt_bauhaus_combobox_set(w, i);</a>
<a name="ln1612">      i++;</a>
<a name="ln1613">    }</a>
<a name="ln1614">  }</a>
<a name="ln1615">}</a>
<a name="ln1616"> </a>
<a name="ln1617">static void _raster_value_changed_callback(GtkWidget *widget, struct dt_iop_module_t *module)</a>
<a name="ln1618">{</a>
<a name="ln1619">  raster_combo_entry_t *entry = dt_bauhaus_combobox_get_data(widget);</a>
<a name="ln1620"> </a>
<a name="ln1621">  // nothing to do</a>
<a name="ln1622">  if(entry-&gt;module == module-&gt;raster_mask.sink.source &amp;&amp; entry-&gt;id == module-&gt;raster_mask.sink.id)</a>
<a name="ln1623">    return;</a>
<a name="ln1624"> </a>
<a name="ln1625">  if(module-&gt;raster_mask.sink.source)</a>
<a name="ln1626">  {</a>
<a name="ln1627">    // we no longer use this one</a>
<a name="ln1628">    g_hash_table_remove(module-&gt;raster_mask.sink.source-&gt;raster_mask.source.users, module);</a>
<a name="ln1629">  }</a>
<a name="ln1630"> </a>
<a name="ln1631">  module-&gt;raster_mask.sink.source = entry-&gt;module;</a>
<a name="ln1632">  module-&gt;raster_mask.sink.id = entry-&gt;id;</a>
<a name="ln1633"> </a>
<a name="ln1634">  gboolean reprocess = FALSE;</a>
<a name="ln1635"> </a>
<a name="ln1636">  if(entry-&gt;module)</a>
<a name="ln1637">  {</a>
<a name="ln1638">    reprocess = dt_iop_is_raster_mask_used(entry-&gt;module, 0) == FALSE;</a>
<a name="ln1639">    g_hash_table_add(entry-&gt;module-&gt;raster_mask.source.users, module);</a>
<a name="ln1640"> </a>
<a name="ln1641">    // update blend_params!</a>
<a name="ln1642">    memcpy(module-&gt;blend_params-&gt;raster_mask_source, entry-&gt;module-&gt;op, sizeof(module-&gt;blend_params-&gt;raster_mask_source));</a>
<a name="ln1643">    module-&gt;blend_params-&gt;raster_mask_instance = entry-&gt;module-&gt;multi_priority;</a>
<a name="ln1644">    module-&gt;blend_params-&gt;raster_mask_id = entry-&gt;id;</a>
<a name="ln1645">  }</a>
<a name="ln1646">  else</a>
<a name="ln1647">  {</a>
<a name="ln1648">    memset(module-&gt;blend_params-&gt;raster_mask_source, 0, sizeof(module-&gt;blend_params-&gt;raster_mask_source));</a>
<a name="ln1649">    module-&gt;blend_params-&gt;raster_mask_instance = 0;</a>
<a name="ln1650">    module-&gt;blend_params-&gt;raster_mask_id = 0;</a>
<a name="ln1651">  }</a>
<a name="ln1652"> </a>
<a name="ln1653">  dt_dev_add_history_item(module-&gt;dev, module, TRUE);</a>
<a name="ln1654"> </a>
<a name="ln1655">  if(reprocess)</a>
<a name="ln1656">    dt_dev_reprocess_all(module-&gt;dev);</a>
<a name="ln1657">}</a>
<a name="ln1658"> </a>
<a name="ln1659">void dt_iop_gui_update_raster(dt_iop_module_t *module)</a>
<a name="ln1660">{</a>
<a name="ln1661">  dt_iop_gui_blend_data_t *bd = (dt_iop_gui_blend_data_t *)module-&gt;blend_data;</a>
<a name="ln1662">  dt_develop_blend_params_t *bp = module-&gt;blend_params;</a>
<a name="ln1663"> </a>
<a name="ln1664">  if(!bd || !bd-&gt;masks_support || !bd-&gt;raster_inited) return;</a>
<a name="ln1665"> </a>
<a name="ln1666">  gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;raster_polarity), bp-&gt;raster_mask_invert);</a>
<a name="ln1667"> </a>
<a name="ln1668">  _raster_combo_populate(bd-&gt;raster_combo, &amp;module);</a>
<a name="ln1669">}</a>
<a name="ln1670"> </a>
<a name="ln1671">static void _raster_polarity_callback(GtkToggleButton *togglebutton, dt_iop_module_t *self)</a>
<a name="ln1672">{</a>
<a name="ln1673">  if(darktable.gui-&gt;reset) return;</a>
<a name="ln1674"> </a>
<a name="ln1675">  dt_develop_blend_params_t *bp = (dt_develop_blend_params_t *)self-&gt;blend_params;</a>
<a name="ln1676"> </a>
<a name="ln1677">  bp-&gt;raster_mask_invert = gtk_toggle_button_get_active(togglebutton);</a>
<a name="ln1678"> </a>
<a name="ln1679">  dt_dev_add_history_item(darktable.develop, self, TRUE);</a>
<a name="ln1680">}</a>
<a name="ln1681"> </a>
<a name="ln1682">void dt_iop_gui_init_raster(GtkBox *blendw, dt_iop_module_t *module)</a>
<a name="ln1683">{</a>
<a name="ln1684">  dt_iop_gui_blend_data_t *bd = (dt_iop_gui_blend_data_t *)module-&gt;blend_data;</a>
<a name="ln1685"> </a>
<a name="ln1686">  bd-&gt;raster_box = GTK_BOX(gtk_box_new(GTK_ORIENTATION_VERTICAL, DT_BAUHAUS_SPACE));</a>
<a name="ln1687">  // add event box so that one can click into the area to get help for drawn masks</a>
<a name="ln1688">  GtkWidget* event_box = gtk_event_box_new();</a>
<a name="ln1689">//  dt_gui_add_help_link(GTK_WIDGET(event_box), &quot;raster_mask.html&quot;);</a>
<a name="ln1690">  gtk_container_add(GTK_CONTAINER(blendw), event_box);</a>
<a name="ln1691"> </a>
<a name="ln1692">  /* create and add raster support if module supports it (it's coupled to masks at the moment) */</a>
<a name="ln1693">  if(bd-&gt;masks_support)</a>
<a name="ln1694">  {</a>
<a name="ln1695">    const int bs = DT_PIXEL_APPLY_DPI(14);</a>
<a name="ln1696"> </a>
<a name="ln1697">    GtkWidget *hbox = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0);</a>
<a name="ln1698"> </a>
<a name="ln1699">    bd-&gt;raster_combo = dt_bauhaus_combobox_new(module);</a>
<a name="ln1700">    dt_bauhaus_widget_set_label(bd-&gt;raster_combo, _(&quot;blend&quot;), _(&quot;raster mask&quot;));</a>
<a name="ln1701">    dt_bauhaus_combobox_add(bd-&gt;raster_combo, _(&quot;no mask used&quot;));</a>
<a name="ln1702">    dt_bauhaus_combobox_set(bd-&gt;raster_combo, 0);</a>
<a name="ln1703">    g_signal_connect(G_OBJECT(bd-&gt;raster_combo), &quot;value-changed&quot;,</a>
<a name="ln1704">                     G_CALLBACK(_raster_value_changed_callback), module);</a>
<a name="ln1705">    dt_bauhaus_combobox_add_populate_fct(bd-&gt;raster_combo, _raster_combo_populate);</a>
<a name="ln1706">    gtk_box_pack_start(GTK_BOX(hbox), bd-&gt;raster_combo, TRUE, TRUE, 0);</a>
<a name="ln1707"> </a>
<a name="ln1708">    bd-&gt;raster_polarity = dtgtk_togglebutton_new(dtgtk_cairo_paint_plusminus, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER,</a>
<a name="ln1709">                                                 NULL);</a>
<a name="ln1710">    gtk_widget_set_tooltip_text(bd-&gt;raster_polarity, _(&quot;toggle polarity of raster mask&quot;));</a>
<a name="ln1711">    g_signal_connect(G_OBJECT(bd-&gt;raster_polarity), &quot;toggled&quot;, G_CALLBACK(_raster_polarity_callback), module);</a>
<a name="ln1712">    gtk_widget_set_size_request(GTK_WIDGET(bd-&gt;raster_polarity), bs, bs);</a>
<a name="ln1713">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;raster_polarity), FALSE);</a>
<a name="ln1714">    gtk_box_pack_start(GTK_BOX(hbox), bd-&gt;raster_polarity, FALSE, FALSE, 0);</a>
<a name="ln1715"> </a>
<a name="ln1716">    gtk_box_pack_start(GTK_BOX(bd-&gt;raster_box), GTK_WIDGET(hbox), TRUE, TRUE, 0);</a>
<a name="ln1717"> </a>
<a name="ln1718">    bd-&gt;raster_inited = 1;</a>
<a name="ln1719">  }</a>
<a name="ln1720">  gtk_container_add(GTK_CONTAINER(event_box), GTK_WIDGET(bd-&gt;raster_box));</a>
<a name="ln1721">}</a>
<a name="ln1722"> </a>
<a name="ln1723">void dt_iop_gui_cleanup_blending(dt_iop_module_t *module)</a>
<a name="ln1724">{</a>
<a name="ln1725">  if(!module-&gt;blend_data) return;</a>
<a name="ln1726">  dt_iop_gui_blend_data_t *bd = (dt_iop_gui_blend_data_t *)module-&gt;blend_data;</a>
<a name="ln1727"> </a>
<a name="ln1728">  dt_pthread_mutex_lock(&amp;bd-&gt;lock);</a>
<a name="ln1729">  if(bd-&gt;timeout_handle)</a>
<a name="ln1730">    g_source_remove(bd-&gt;timeout_handle);</a>
<a name="ln1731"> </a>
<a name="ln1732">  g_list_free(bd-&gt;blend_modes);</a>
<a name="ln1733">  g_list_free(bd-&gt;masks_modes);</a>
<a name="ln1734">  g_list_free(bd-&gt;masks_combine);</a>
<a name="ln1735">  g_list_free(bd-&gt;masks_invert);</a>
<a name="ln1736">  g_list_free(bd-&gt;masks_feathering_guide);</a>
<a name="ln1737">  g_list_free_full(bd-&gt;blend_modes_all, g_free);</a>
<a name="ln1738">  free(bd-&gt;masks_combo_ids);</a>
<a name="ln1739">  dt_pthread_mutex_unlock(&amp;bd-&gt;lock);</a>
<a name="ln1740">  dt_pthread_mutex_destroy(&amp;bd-&gt;lock);</a>
<a name="ln1741"> </a>
<a name="ln1742">  memset(module-&gt;blend_data, 0, sizeof(dt_iop_gui_blend_data_t));</a>
<a name="ln1743"> </a>
<a name="ln1744">  g_free(module-&gt;blend_data);</a>
<a name="ln1745">  module-&gt;blend_data = NULL;</a>
<a name="ln1746">}</a>
<a name="ln1747"> </a>
<a name="ln1748"> </a>
<a name="ln1749">void dt_iop_gui_update_blending(dt_iop_module_t *module)</a>
<a name="ln1750">{</a>
<a name="ln1751">  dt_iop_gui_blend_data_t *bd = (dt_iop_gui_blend_data_t *)module-&gt;blend_data;</a>
<a name="ln1752"> </a>
<a name="ln1753">  if(!(module-&gt;flags() &amp; IOP_FLAGS_SUPPORTS_BLENDING) || !bd || !bd-&gt;blend_inited) return;</a>
<a name="ln1754"> </a>
<a name="ln1755">  int reset = darktable.gui-&gt;reset;</a>
<a name="ln1756">  darktable.gui-&gt;reset = 1;</a>
<a name="ln1757"> </a>
<a name="ln1758">  dt_bauhaus_combobox_set(bd-&gt;masks_modes_combo,</a>
<a name="ln1759">                          g_list_index(bd-&gt;masks_modes, GUINT_TO_POINTER(module-&gt;blend_params-&gt;mask_mode)));</a>
<a name="ln1760"> </a>
<a name="ln1761">  /* special handling of deprecated blend modes */</a>
<a name="ln1762">  int blend_mode_number = g_list_index(bd-&gt;blend_modes, GUINT_TO_POINTER(module-&gt;blend_params-&gt;blend_mode));</a>
<a name="ln1763">  if(blend_mode_number &lt; 0)</a>
<a name="ln1764">  {</a>
<a name="ln1765">    GList *complete_list = bd-&gt;blend_modes_all;</a>
<a name="ln1766"> </a>
<a name="ln1767">    while(complete_list)</a>
<a name="ln1768">    {</a>
<a name="ln1769">      dt_iop_blend_mode_t *bm = (dt_iop_blend_mode_t *)complete_list-&gt;data;</a>
<a name="ln1770">      if(bm-&gt;mode == module-&gt;blend_params-&gt;blend_mode)</a>
<a name="ln1771">      {</a>
<a name="ln1772">        dt_bauhaus_combobox_add(bd-&gt;blend_modes_combo, bm-&gt;name);</a>
<a name="ln1773">        bd-&gt;blend_modes = g_list_append(bd-&gt;blend_modes, GUINT_TO_POINTER(bm-&gt;mode));</a>
<a name="ln1774">        break;</a>
<a name="ln1775">      }</a>
<a name="ln1776">      complete_list = g_list_next(complete_list);</a>
<a name="ln1777">    }</a>
<a name="ln1778"> </a>
<a name="ln1779">    if(complete_list)</a>
<a name="ln1780">    {</a>
<a name="ln1781">      /* found it and added it to combobox, now find entry number */</a>
<a name="ln1782">      blend_mode_number = g_list_index(bd-&gt;blend_modes, GUINT_TO_POINTER(module-&gt;blend_params-&gt;blend_mode));</a>
<a name="ln1783">    }</a>
<a name="ln1784">    else</a>
<a name="ln1785">    {</a>
<a name="ln1786">      /* should never happen: unknown blend mode */</a>
<a name="ln1787">      dt_control_log(&quot;unknown blend mode '%d' in module '%s'&quot;, module-&gt;blend_params-&gt;blend_mode, module-&gt;op);</a>
<a name="ln1788">      blend_mode_number = 0;</a>
<a name="ln1789">    }</a>
<a name="ln1790">  }</a>
<a name="ln1791"> </a>
<a name="ln1792">  dt_bauhaus_combobox_set(bd-&gt;blend_modes_combo, blend_mode_number);</a>
<a name="ln1793"> </a>
<a name="ln1794">  dt_bauhaus_combobox_set(</a>
<a name="ln1795">      bd-&gt;masks_combine_combo,</a>
<a name="ln1796">      g_list_index(bd-&gt;masks_combine, GUINT_TO_POINTER(module-&gt;blend_params-&gt;mask_combine</a>
<a name="ln1797">                                                       &amp; (DEVELOP_COMBINE_INV | DEVELOP_COMBINE_INCL))));</a>
<a name="ln1798">  dt_bauhaus_combobox_set(bd-&gt;masks_invert_combo,</a>
<a name="ln1799">                          g_list_index(bd-&gt;masks_invert, GUINT_TO_POINTER(module-&gt;blend_params-&gt;mask_combine</a>
<a name="ln1800">                                                                          &amp; DEVELOP_COMBINE_INV)));</a>
<a name="ln1801">  dt_bauhaus_slider_set(bd-&gt;opacity_slider, module-&gt;blend_params-&gt;opacity);</a>
<a name="ln1802">  dt_bauhaus_combobox_set(</a>
<a name="ln1803">      bd-&gt;masks_feathering_guide_combo,</a>
<a name="ln1804">      g_list_index(bd-&gt;masks_feathering_guide, GUINT_TO_POINTER(module-&gt;blend_params-&gt;feathering_guide)));</a>
<a name="ln1805">  dt_bauhaus_slider_set(bd-&gt;feathering_radius_slider, module-&gt;blend_params-&gt;feathering_radius);</a>
<a name="ln1806">  dt_bauhaus_slider_set(bd-&gt;blur_radius_slider, module-&gt;blend_params-&gt;blur_radius);</a>
<a name="ln1807">  dt_bauhaus_slider_set(bd-&gt;brightness_slider, module-&gt;blend_params-&gt;brightness);</a>
<a name="ln1808">  dt_bauhaus_slider_set(bd-&gt;contrast_slider, module-&gt;blend_params-&gt;contrast);</a>
<a name="ln1809"> </a>
<a name="ln1810">  dt_iop_gui_update_blendif(module);</a>
<a name="ln1811">  dt_iop_gui_update_masks(module);</a>
<a name="ln1812">  dt_iop_gui_update_raster(module);</a>
<a name="ln1813"> </a>
<a name="ln1814">  /* now show hide controls as required */</a>
<a name="ln1815">  const unsigned int mask_mode = module-&gt;blend_params-&gt;mask_mode;</a>
<a name="ln1816"> </a>
<a name="ln1817">  if(mask_mode &amp; DEVELOP_MASK_ENABLED)</a>
<a name="ln1818">  {</a>
<a name="ln1819">    gtk_widget_show(GTK_WIDGET(bd-&gt;top_box));</a>
<a name="ln1820">  }</a>
<a name="ln1821">  else</a>
<a name="ln1822">  {</a>
<a name="ln1823">    gtk_widget_hide(GTK_WIDGET(bd-&gt;top_box));</a>
<a name="ln1824">  }</a>
<a name="ln1825"> </a>
<a name="ln1826">  if((mask_mode &amp; DEVELOP_MASK_ENABLED) &amp;&amp; ((bd-&gt;masks_inited &amp;&amp; (mask_mode &amp; DEVELOP_MASK_MASK))</a>
<a name="ln1827">                                            || (bd-&gt;blendif_inited &amp;&amp; (mask_mode &amp; DEVELOP_MASK_CONDITIONAL))))</a>
<a name="ln1828">  {</a>
<a name="ln1829">    if(bd-&gt;blendif_inited &amp;&amp; (mask_mode &amp; DEVELOP_MASK_CONDITIONAL))</a>
<a name="ln1830">    {</a>
<a name="ln1831">      gtk_widget_hide(GTK_WIDGET(bd-&gt;masks_invert_combo));</a>
<a name="ln1832">      gtk_widget_show(GTK_WIDGET(bd-&gt;masks_combine_combo));</a>
<a name="ln1833">    }</a>
<a name="ln1834">    else</a>
<a name="ln1835">    {</a>
<a name="ln1836">      gtk_widget_show(GTK_WIDGET(bd-&gt;masks_invert_combo));</a>
<a name="ln1837">      gtk_widget_hide(GTK_WIDGET(bd-&gt;masks_combine_combo));</a>
<a name="ln1838">    }</a>
<a name="ln1839"> </a>
<a name="ln1840">    /*</a>
<a name="ln1841">     * if this iop is operating in raw space, it has only 1 channel per pixel,</a>
<a name="ln1842">     * thus there is no alpha channel where we would normally store mask</a>
<a name="ln1843">     * that would get displayed if following button have been pressed.</a>
<a name="ln1844">     *</a>
<a name="ln1845">     * TODO: revisit if/once there semi-raw iops (e.g temperature) with blending</a>
<a name="ln1846">     */</a>
<a name="ln1847">    if(dt_iop_module_colorspace(module) == iop_cs_RAW)</a>
<a name="ln1848">    {</a>
<a name="ln1849">      module-&gt;request_mask_display = DT_DEV_PIXELPIPE_DISPLAY_NONE;</a>
<a name="ln1850">      dtgtk_button_set_active(DTGTK_BUTTON(bd-&gt;showmask), 0);</a>
<a name="ln1851">      gtk_widget_hide(GTK_WIDGET(bd-&gt;showmask));</a>
<a name="ln1852">    }</a>
<a name="ln1853">    else</a>
<a name="ln1854">    {</a>
<a name="ln1855">      gtk_widget_show(GTK_WIDGET(bd-&gt;showmask));</a>
<a name="ln1856">    }</a>
<a name="ln1857"> </a>
<a name="ln1858">    gtk_widget_show(GTK_WIDGET(bd-&gt;bottom_box));</a>
<a name="ln1859">  }</a>
<a name="ln1860">  else</a>
<a name="ln1861">  {</a>
<a name="ln1862">    module-&gt;request_mask_display = DT_DEV_PIXELPIPE_DISPLAY_NONE;</a>
<a name="ln1863">    dtgtk_button_set_active(DTGTK_BUTTON(bd-&gt;showmask), 0);</a>
<a name="ln1864">    module-&gt;suppress_mask = 0;</a>
<a name="ln1865">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;suppress), 0);</a>
<a name="ln1866"> </a>
<a name="ln1867">    gtk_widget_hide(GTK_WIDGET(bd-&gt;bottom_box));</a>
<a name="ln1868">  }</a>
<a name="ln1869"> </a>
<a name="ln1870"> </a>
<a name="ln1871">  if(bd-&gt;masks_inited &amp;&amp; (mask_mode &amp; DEVELOP_MASK_MASK))</a>
<a name="ln1872">  {</a>
<a name="ln1873">    gtk_widget_show(GTK_WIDGET(bd-&gt;masks_box));</a>
<a name="ln1874">  }</a>
<a name="ln1875">  else if(bd-&gt;masks_inited)</a>
<a name="ln1876">  {</a>
<a name="ln1877">    dt_masks_set_edit_mode(module, DT_MASKS_EDIT_OFF);</a>
<a name="ln1878"> </a>
<a name="ln1879">    gtk_widget_hide(GTK_WIDGET(bd-&gt;masks_box));</a>
<a name="ln1880">  }</a>
<a name="ln1881">  else</a>
<a name="ln1882">  {</a>
<a name="ln1883">    gtk_widget_hide(GTK_WIDGET(bd-&gt;masks_box));</a>
<a name="ln1884">  }</a>
<a name="ln1885"> </a>
<a name="ln1886">  if(bd-&gt;raster_inited &amp;&amp; (mask_mode &amp; DEVELOP_MASK_RASTER))</a>
<a name="ln1887">  {</a>
<a name="ln1888">    gtk_widget_show(GTK_WIDGET(bd-&gt;raster_box));</a>
<a name="ln1889">  }</a>
<a name="ln1890">  else if(bd-&gt;raster_inited)</a>
<a name="ln1891">  {</a>
<a name="ln1892">//     dt_masks_set_edit_mode(module, DT_MASKS_EDIT_OFF);</a>
<a name="ln1893"> </a>
<a name="ln1894">    gtk_widget_hide(GTK_WIDGET(bd-&gt;raster_box));</a>
<a name="ln1895">  }</a>
<a name="ln1896">  else</a>
<a name="ln1897">  {</a>
<a name="ln1898">    gtk_widget_hide(GTK_WIDGET(bd-&gt;raster_box));</a>
<a name="ln1899">  }</a>
<a name="ln1900"> </a>
<a name="ln1901">  if(bd-&gt;blendif_inited &amp;&amp; (mask_mode &amp; DEVELOP_MASK_CONDITIONAL))</a>
<a name="ln1902">  {</a>
<a name="ln1903">    gtk_widget_show(GTK_WIDGET(bd-&gt;blendif_box));</a>
<a name="ln1904">  }</a>
<a name="ln1905">  else if(bd-&gt;blendif_inited)</a>
<a name="ln1906">  {</a>
<a name="ln1907">    /* switch off color picker if it was requested by blendif */</a>
<a name="ln1908">    if(module-&gt;request_color_pick == DT_REQUEST_COLORPICK_BLEND)</a>
<a name="ln1909">    {</a>
<a name="ln1910">      module-&gt;request_color_pick = DT_REQUEST_COLORPICK_OFF;</a>
<a name="ln1911">      gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;colorpicker), 0);</a>
<a name="ln1912">    }</a>
<a name="ln1913"> </a>
<a name="ln1914">    gtk_widget_hide(GTK_WIDGET(bd-&gt;blendif_box));</a>
<a name="ln1915">  }</a>
<a name="ln1916">  else</a>
<a name="ln1917">  {</a>
<a name="ln1918">    gtk_widget_hide(GTK_WIDGET(bd-&gt;blendif_box));</a>
<a name="ln1919">  }</a>
<a name="ln1920"> </a>
<a name="ln1921">  darktable.gui-&gt;reset = reset;</a>
<a name="ln1922">}</a>
<a name="ln1923"> </a>
<a name="ln1924">static void _collect_blend_modes(GList **list, const char *name, unsigned int mode)</a>
<a name="ln1925">{</a>
<a name="ln1926">  dt_iop_blend_mode_t *bm;</a>
<a name="ln1927">  bm = g_malloc(sizeof(dt_iop_blend_mode_t));</a>
<a name="ln1928">  g_strlcpy(bm-&gt;name, name, sizeof(bm-&gt;name));</a>
<a name="ln1929">  bm-&gt;mode = mode;</a>
<a name="ln1930">  *list = g_list_append(*list, bm);</a>
<a name="ln1931">}</a>
<a name="ln1932"> </a>
<a name="ln1933"> </a>
<a name="ln1934">static void _add_blendmode_combo(GList **list, GtkWidget *combobox, GList *complete, unsigned int mode)</a>
<a name="ln1935">{</a>
<a name="ln1936">  GList *all = complete;</a>
<a name="ln1937"> </a>
<a name="ln1938">  while(all)</a>
<a name="ln1939">  {</a>
<a name="ln1940">    dt_iop_blend_mode_t *bm = (dt_iop_blend_mode_t *)all-&gt;data;</a>
<a name="ln1941">    if(bm-&gt;mode == mode)</a>
<a name="ln1942">    {</a>
<a name="ln1943">      dt_bauhaus_combobox_add(combobox, bm-&gt;name);</a>
<a name="ln1944">      *list = g_list_append(*list, GUINT_TO_POINTER(bm-&gt;mode));</a>
<a name="ln1945">      break;</a>
<a name="ln1946">    }</a>
<a name="ln1947">    all = g_list_next(all);</a>
<a name="ln1948">  }</a>
<a name="ln1949">}</a>
<a name="ln1950"> </a>
<a name="ln1951"> </a>
<a name="ln1952">void dt_iop_gui_init_blending(GtkWidget *iopw, dt_iop_module_t *module)</a>
<a name="ln1953">{</a>
<a name="ln1954">  /* create and add blend mode if module supports it */</a>
<a name="ln1955">  if(module-&gt;flags() &amp; IOP_FLAGS_SUPPORTS_BLENDING)</a>
<a name="ln1956">  {</a>
<a name="ln1957">    const int bs = DT_PIXEL_APPLY_DPI(14);</a>
<a name="ln1958"> </a>
<a name="ln1959">    module-&gt;blend_data = g_malloc0(sizeof(dt_iop_gui_blend_data_t));</a>
<a name="ln1960">    dt_iop_gui_blend_data_t *bd = (dt_iop_gui_blend_data_t *)module-&gt;blend_data;</a>
<a name="ln1961"> </a>
<a name="ln1962">    bd-&gt;iopw = iopw;</a>
<a name="ln1963">    bd-&gt;module = module;</a>
<a name="ln1964">    bd-&gt;csp = dt_iop_module_colorspace(module);</a>
<a name="ln1965">    bd-&gt;blendif_support = (bd-&gt;csp == iop_cs_Lab || bd-&gt;csp == iop_cs_rgb);</a>
<a name="ln1966">    bd-&gt;masks_support = !(module-&gt;flags() &amp; IOP_FLAGS_NO_MASKS);</a>
<a name="ln1967"> </a>
<a name="ln1968">    bd-&gt;masks_modes = NULL;</a>
<a name="ln1969">    bd-&gt;blend_modes = NULL;</a>
<a name="ln1970">    bd-&gt;masks_combine = NULL;</a>
<a name="ln1971">    bd-&gt;masks_invert = NULL;</a>
<a name="ln1972">    bd-&gt;blend_modes_all = NULL;</a>
<a name="ln1973"> </a>
<a name="ln1974">    dt_pthread_mutex_init(&amp;bd-&gt;lock, NULL);</a>
<a name="ln1975">    dt_pthread_mutex_lock(&amp;bd-&gt;lock);</a>
<a name="ln1976">    bd-&gt;timeout_handle = 0;</a>
<a name="ln1977">    bd-&gt;save_for_leave = 0;</a>
<a name="ln1978">    dt_pthread_mutex_unlock(&amp;bd-&gt;lock);</a>
<a name="ln1979"> </a>
<a name="ln1980"> </a>
<a name="ln1981">    /** generate a list of all available blend modes */</a>
<a name="ln1982">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;normal&quot;), DEVELOP_BLEND_NORMAL2);</a>
<a name="ln1983">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;normal bounded&quot;), DEVELOP_BLEND_BOUNDED);</a>
<a name="ln1984">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;lighten&quot;), DEVELOP_BLEND_LIGHTEN);</a>
<a name="ln1985">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;darken&quot;), DEVELOP_BLEND_DARKEN);</a>
<a name="ln1986">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;multiply&quot;), DEVELOP_BLEND_MULTIPLY);</a>
<a name="ln1987">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;average&quot;), DEVELOP_BLEND_AVERAGE);</a>
<a name="ln1988">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;addition&quot;), DEVELOP_BLEND_ADD);</a>
<a name="ln1989">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;subtract&quot;), DEVELOP_BLEND_SUBSTRACT);</a>
<a name="ln1990">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;difference&quot;), DEVELOP_BLEND_DIFFERENCE2);</a>
<a name="ln1991">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;screen&quot;), DEVELOP_BLEND_SCREEN);</a>
<a name="ln1992">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;overlay&quot;), DEVELOP_BLEND_OVERLAY);</a>
<a name="ln1993">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;softlight&quot;), DEVELOP_BLEND_SOFTLIGHT);</a>
<a name="ln1994">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;hardlight&quot;), DEVELOP_BLEND_HARDLIGHT);</a>
<a name="ln1995">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;vividlight&quot;), DEVELOP_BLEND_VIVIDLIGHT);</a>
<a name="ln1996">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;linearlight&quot;), DEVELOP_BLEND_LINEARLIGHT);</a>
<a name="ln1997">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;pinlight&quot;), DEVELOP_BLEND_PINLIGHT);</a>
<a name="ln1998">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;lightness&quot;), DEVELOP_BLEND_LIGHTNESS);</a>
<a name="ln1999">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;chroma&quot;), DEVELOP_BLEND_CHROMA);</a>
<a name="ln2000">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;hue&quot;), DEVELOP_BLEND_HUE);</a>
<a name="ln2001">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;color&quot;), DEVELOP_BLEND_COLOR);</a>
<a name="ln2002">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;coloradjustment&quot;),</a>
<a name="ln2003">                         DEVELOP_BLEND_COLORADJUST);</a>
<a name="ln2004">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;Lab lightness&quot;),</a>
<a name="ln2005">                         DEVELOP_BLEND_LAB_LIGHTNESS);</a>
<a name="ln2006">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;Lab color&quot;), DEVELOP_BLEND_LAB_COLOR);</a>
<a name="ln2007">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;Lab L-channel&quot;),</a>
<a name="ln2008">                         DEVELOP_BLEND_LAB_L);</a>
<a name="ln2009">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;Lab a-channel&quot;),</a>
<a name="ln2010">                         DEVELOP_BLEND_LAB_A);</a>
<a name="ln2011">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;Lab b-channel&quot;),</a>
<a name="ln2012">                         DEVELOP_BLEND_LAB_B);</a>
<a name="ln2013">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;HSV lightness&quot;),</a>
<a name="ln2014">                         DEVELOP_BLEND_HSV_LIGHTNESS);</a>
<a name="ln2015">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;HSV color&quot;), DEVELOP_BLEND_HSV_COLOR);</a>
<a name="ln2016">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;RGB red channel&quot;),</a>
<a name="ln2017">                         DEVELOP_BLEND_RGB_R);</a>
<a name="ln2018">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;RGB green channel&quot;),</a>
<a name="ln2019">                         DEVELOP_BLEND_RGB_G);</a>
<a name="ln2020">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;RGB blue channel&quot;),</a>
<a name="ln2021">                         DEVELOP_BLEND_RGB_B);</a>
<a name="ln2022"> </a>
<a name="ln2023">    /** deprecated blend modes: make them available as legacy history stacks might want them */</a>
<a name="ln2024">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;difference (deprecated)&quot;),</a>
<a name="ln2025">                         DEVELOP_BLEND_DIFFERENCE);</a>
<a name="ln2026">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;inverse (deprecated)&quot;),</a>
<a name="ln2027">                         DEVELOP_BLEND_INVERSE);</a>
<a name="ln2028">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;normal (deprecated)&quot;), DEVELOP_BLEND_NORMAL);</a>
<a name="ln2029">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;unbounded (deprecated)&quot;),</a>
<a name="ln2030">                         DEVELOP_BLEND_UNBOUNDED);</a>
<a name="ln2031"> </a>
<a name="ln2032"> </a>
<a name="ln2033">    bd-&gt;masks_modes_combo = dt_bauhaus_combobox_new(module);</a>
<a name="ln2034">    dt_bauhaus_widget_set_label(bd-&gt;masks_modes_combo, _(&quot;blend&quot;), _(&quot;blend&quot;));</a>
<a name="ln2035"> </a>
<a name="ln2036">    dt_bauhaus_combobox_add(bd-&gt;masks_modes_combo, _(&quot;off&quot;));</a>
<a name="ln2037">    bd-&gt;masks_modes = g_list_append(bd-&gt;masks_modes, GUINT_TO_POINTER(DEVELOP_MASK_DISABLED));</a>
<a name="ln2038"> </a>
<a name="ln2039">    dt_bauhaus_combobox_add(bd-&gt;masks_modes_combo, _(&quot;uniformly&quot;));</a>
<a name="ln2040">    bd-&gt;masks_modes = g_list_append(bd-&gt;masks_modes, GUINT_TO_POINTER(DEVELOP_MASK_ENABLED));</a>
<a name="ln2041"> </a>
<a name="ln2042">    if(bd-&gt;masks_support)</a>
<a name="ln2043">    {</a>
<a name="ln2044">      dt_bauhaus_combobox_add(bd-&gt;masks_modes_combo, _(&quot;drawn mask&quot;));</a>
<a name="ln2045">      bd-&gt;masks_modes</a>
<a name="ln2046">          = g_list_append(bd-&gt;masks_modes, GUINT_TO_POINTER(DEVELOP_MASK_ENABLED | DEVELOP_MASK_MASK));</a>
<a name="ln2047">    }</a>
<a name="ln2048"> </a>
<a name="ln2049">    if(bd-&gt;blendif_support)</a>
<a name="ln2050">    {</a>
<a name="ln2051">      dt_bauhaus_combobox_add(bd-&gt;masks_modes_combo, _(&quot;parametric mask&quot;));</a>
<a name="ln2052">      bd-&gt;masks_modes</a>
<a name="ln2053">          = g_list_append(bd-&gt;masks_modes, GUINT_TO_POINTER(DEVELOP_MASK_ENABLED | DEVELOP_MASK_CONDITIONAL));</a>
<a name="ln2054">    }</a>
<a name="ln2055"> </a>
<a name="ln2056">    if(bd-&gt;blendif_support &amp;&amp; bd-&gt;masks_support)</a>
<a name="ln2057">    {</a>
<a name="ln2058">      dt_bauhaus_combobox_add(bd-&gt;masks_modes_combo, _(&quot;drawn &amp; parametric mask&quot;));</a>
<a name="ln2059">      bd-&gt;masks_modes</a>
<a name="ln2060">          = g_list_append(bd-&gt;masks_modes, GUINT_TO_POINTER(DEVELOP_MASK_ENABLED | DEVELOP_MASK_MASK_CONDITIONAL));</a>
<a name="ln2061">    }</a>
<a name="ln2062"> </a>
<a name="ln2063">    if(bd-&gt;masks_support)</a>
<a name="ln2064">    {</a>
<a name="ln2065">      dt_bauhaus_combobox_add(bd-&gt;masks_modes_combo, _(&quot;raster mask&quot;));</a>
<a name="ln2066">      bd-&gt;masks_modes</a>
<a name="ln2067">          = g_list_append(bd-&gt;masks_modes, GUINT_TO_POINTER(DEVELOP_MASK_ENABLED | DEVELOP_MASK_RASTER));</a>
<a name="ln2068">    }</a>
<a name="ln2069"> </a>
<a name="ln2070">    dt_bauhaus_combobox_set(bd-&gt;masks_modes_combo, 0);</a>
<a name="ln2071">    gtk_widget_set_tooltip_text(bd-&gt;masks_modes_combo,_(&quot;activate blending: uniformly, with drawn mask, with &quot;</a>
<a name="ln2072">                                                        &quot;parametric mask, or combination of both&quot;));</a>
<a name="ln2073">    g_signal_connect(G_OBJECT(bd-&gt;masks_modes_combo), &quot;value-changed&quot;,</a>
<a name="ln2074">                     G_CALLBACK(_blendop_masks_mode_callback), bd);</a>
<a name="ln2075">    dt_gui_add_help_link(GTK_WIDGET(bd-&gt;masks_modes_combo), &quot;blending.html&quot;);</a>
<a name="ln2076"> </a>
<a name="ln2077">    bd-&gt;blend_modes_combo = dt_bauhaus_combobox_new(module);</a>
<a name="ln2078">    dt_bauhaus_widget_set_label(bd-&gt;blend_modes_combo, _(&quot;blend&quot;), _(&quot;blend mode&quot;));</a>
<a name="ln2079">    gtk_widget_set_tooltip_text(bd-&gt;blend_modes_combo, _(&quot;choose blending mode&quot;));</a>
<a name="ln2080"> </a>
<a name="ln2081">    /** populate combobox depending on the color space this module acts in */</a>
<a name="ln2082">    switch(bd-&gt;csp)</a>
<a name="ln2083">    {</a>
<a name="ln2084">      case iop_cs_Lab:</a>
<a name="ln2085">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2086">                             DEVELOP_BLEND_NORMAL2);</a>
<a name="ln2087">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2088">                             DEVELOP_BLEND_BOUNDED);</a>
<a name="ln2089">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2090">                             DEVELOP_BLEND_LIGHTEN);</a>
<a name="ln2091">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2092">                             DEVELOP_BLEND_DARKEN);</a>
<a name="ln2093">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2094">                             DEVELOP_BLEND_MULTIPLY);</a>
<a name="ln2095">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2096">                             DEVELOP_BLEND_AVERAGE);</a>
<a name="ln2097">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2098">                             DEVELOP_BLEND_ADD);</a>
<a name="ln2099">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2100">                             DEVELOP_BLEND_SUBSTRACT);</a>
<a name="ln2101">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2102">                             DEVELOP_BLEND_DIFFERENCE2);</a>
<a name="ln2103">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2104">                             DEVELOP_BLEND_SCREEN);</a>
<a name="ln2105">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2106">                             DEVELOP_BLEND_OVERLAY);</a>
<a name="ln2107">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2108">                             DEVELOP_BLEND_SOFTLIGHT);</a>
<a name="ln2109">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2110">                             DEVELOP_BLEND_HARDLIGHT);</a>
<a name="ln2111">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2112">                             DEVELOP_BLEND_VIVIDLIGHT);</a>
<a name="ln2113">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2114">                             DEVELOP_BLEND_LINEARLIGHT);</a>
<a name="ln2115">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2116">                             DEVELOP_BLEND_PINLIGHT);</a>
<a name="ln2117">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2118">                             DEVELOP_BLEND_LAB_LIGHTNESS);</a>
<a name="ln2119">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2120">                             DEVELOP_BLEND_LAB_A);</a>
<a name="ln2121">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2122">                             DEVELOP_BLEND_LAB_B);</a>
<a name="ln2123">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2124">                             DEVELOP_BLEND_LAB_COLOR);</a>
<a name="ln2125">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2126">                             DEVELOP_BLEND_LIGHTNESS);</a>
<a name="ln2127">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2128">                             DEVELOP_BLEND_CHROMA);</a>
<a name="ln2129">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2130">                             DEVELOP_BLEND_HUE);</a>
<a name="ln2131">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2132">                             DEVELOP_BLEND_COLOR);</a>
<a name="ln2133">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2134">                             DEVELOP_BLEND_COLORADJUST);</a>
<a name="ln2135">        break;</a>
<a name="ln2136"> </a>
<a name="ln2137">      case iop_cs_rgb:</a>
<a name="ln2138">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2139">                             DEVELOP_BLEND_NORMAL2);</a>
<a name="ln2140">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2141">                             DEVELOP_BLEND_BOUNDED);</a>
<a name="ln2142">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2143">                             DEVELOP_BLEND_LIGHTEN);</a>
<a name="ln2144">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2145">                             DEVELOP_BLEND_DARKEN);</a>
<a name="ln2146">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2147">                             DEVELOP_BLEND_MULTIPLY);</a>
<a name="ln2148">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2149">                             DEVELOP_BLEND_AVERAGE);</a>
<a name="ln2150">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2151">                             DEVELOP_BLEND_ADD);</a>
<a name="ln2152">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2153">                             DEVELOP_BLEND_SUBSTRACT);</a>
<a name="ln2154">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2155">                             DEVELOP_BLEND_DIFFERENCE2);</a>
<a name="ln2156">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2157">                             DEVELOP_BLEND_SCREEN);</a>
<a name="ln2158">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2159">                             DEVELOP_BLEND_OVERLAY);</a>
<a name="ln2160">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2161">                             DEVELOP_BLEND_SOFTLIGHT);</a>
<a name="ln2162">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2163">                             DEVELOP_BLEND_HARDLIGHT);</a>
<a name="ln2164">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2165">                             DEVELOP_BLEND_VIVIDLIGHT);</a>
<a name="ln2166">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2167">                             DEVELOP_BLEND_LINEARLIGHT);</a>
<a name="ln2168">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2169">                             DEVELOP_BLEND_PINLIGHT);</a>
<a name="ln2170">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2171">                             DEVELOP_BLEND_HSV_LIGHTNESS);</a>
<a name="ln2172">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2173">                             DEVELOP_BLEND_HSV_COLOR);</a>
<a name="ln2174">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2175">                             DEVELOP_BLEND_RGB_R);</a>
<a name="ln2176">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2177">                             DEVELOP_BLEND_RGB_G);</a>
<a name="ln2178">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2179">                             DEVELOP_BLEND_RGB_B);</a>
<a name="ln2180">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2181">                             DEVELOP_BLEND_LIGHTNESS);</a>
<a name="ln2182">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2183">                             DEVELOP_BLEND_CHROMA);</a>
<a name="ln2184">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2185">                             DEVELOP_BLEND_HUE);</a>
<a name="ln2186">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2187">                             DEVELOP_BLEND_COLOR);</a>
<a name="ln2188">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2189">                             DEVELOP_BLEND_COLORADJUST);</a>
<a name="ln2190">        break;</a>
<a name="ln2191"> </a>
<a name="ln2192">      case iop_cs_RAW:</a>
<a name="ln2193">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2194">                             DEVELOP_BLEND_NORMAL2);</a>
<a name="ln2195">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2196">                             DEVELOP_BLEND_BOUNDED);</a>
<a name="ln2197">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2198">                             DEVELOP_BLEND_LIGHTEN);</a>
<a name="ln2199">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2200">                             DEVELOP_BLEND_DARKEN);</a>
<a name="ln2201">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2202">                             DEVELOP_BLEND_MULTIPLY);</a>
<a name="ln2203">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2204">                             DEVELOP_BLEND_AVERAGE);</a>
<a name="ln2205">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2206">                             DEVELOP_BLEND_ADD);</a>
<a name="ln2207">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2208">                             DEVELOP_BLEND_SUBSTRACT);</a>
<a name="ln2209">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2210">                             DEVELOP_BLEND_DIFFERENCE2);</a>
<a name="ln2211">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2212">                             DEVELOP_BLEND_SCREEN);</a>
<a name="ln2213">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2214">                             DEVELOP_BLEND_OVERLAY);</a>
<a name="ln2215">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2216">                             DEVELOP_BLEND_SOFTLIGHT);</a>
<a name="ln2217">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2218">                             DEVELOP_BLEND_HARDLIGHT);</a>
<a name="ln2219">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2220">                             DEVELOP_BLEND_VIVIDLIGHT);</a>
<a name="ln2221">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2222">                             DEVELOP_BLEND_LINEARLIGHT);</a>
<a name="ln2223">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2224">                             DEVELOP_BLEND_PINLIGHT);</a>
<a name="ln2225">        break;</a>
<a name="ln2226">    }</a>
<a name="ln2227"> </a>
<a name="ln2228"> </a>
<a name="ln2229">    dt_bauhaus_combobox_set(bd-&gt;blend_modes_combo, 0);</a>
<a name="ln2230">    g_signal_connect(G_OBJECT(bd-&gt;blend_modes_combo), &quot;value-changed&quot;,</a>
<a name="ln2231">                     G_CALLBACK(_blendop_blend_mode_callback), bd);</a>
<a name="ln2232">    dt_gui_add_help_link(GTK_WIDGET(bd-&gt;blend_modes_combo), &quot;blending_operators.html&quot;);</a>
<a name="ln2233"> </a>
<a name="ln2234"> </a>
<a name="ln2235">    bd-&gt;opacity_slider = dt_bauhaus_slider_new_with_range(module, 0.0, 100.0, 1, 100.0, 0);</a>
<a name="ln2236">    dt_bauhaus_widget_set_label(bd-&gt;opacity_slider, _(&quot;blend&quot;), _(&quot;opacity&quot;));</a>
<a name="ln2237">    dt_bauhaus_slider_set_format(bd-&gt;opacity_slider, &quot;%.0f%%&quot;);</a>
<a name="ln2238">    module-&gt;fusion_slider = bd-&gt;opacity_slider;</a>
<a name="ln2239">    gtk_widget_set_tooltip_text(bd-&gt;opacity_slider, _(&quot;set the opacity of the blending&quot;));</a>
<a name="ln2240">    g_signal_connect(G_OBJECT(bd-&gt;opacity_slider), &quot;value-changed&quot;, G_CALLBACK(_blendop_opacity_callback), bd);</a>
<a name="ln2241"> </a>
<a name="ln2242"> </a>
<a name="ln2243">    bd-&gt;masks_combine_combo = dt_bauhaus_combobox_new(module);</a>
<a name="ln2244">    dt_bauhaus_widget_set_label(bd-&gt;masks_combine_combo, _(&quot;blend&quot;), _(&quot;combine masks&quot;));</a>
<a name="ln2245"> </a>
<a name="ln2246">    dt_bauhaus_combobox_add(bd-&gt;masks_combine_combo, _(&quot;exclusive&quot;));</a>
<a name="ln2247">    bd-&gt;masks_combine = g_list_append(bd-&gt;masks_combine, GUINT_TO_POINTER(DEVELOP_COMBINE_NORM_EXCL));</a>
<a name="ln2248"> </a>
<a name="ln2249">    dt_bauhaus_combobox_add(bd-&gt;masks_combine_combo, _(&quot;inclusive&quot;));</a>
<a name="ln2250">    bd-&gt;masks_combine = g_list_append(bd-&gt;masks_combine, GUINT_TO_POINTER(DEVELOP_COMBINE_NORM_INCL));</a>
<a name="ln2251"> </a>
<a name="ln2252">    dt_bauhaus_combobox_add(bd-&gt;masks_combine_combo, _(&quot;exclusive &amp; inverted&quot;));</a>
<a name="ln2253">    bd-&gt;masks_combine = g_list_append(bd-&gt;masks_combine, GUINT_TO_POINTER(DEVELOP_COMBINE_INV_EXCL));</a>
<a name="ln2254"> </a>
<a name="ln2255">    dt_bauhaus_combobox_add(bd-&gt;masks_combine_combo, _(&quot;inclusive &amp; inverted&quot;));</a>
<a name="ln2256">    bd-&gt;masks_combine = g_list_append(bd-&gt;masks_combine, GUINT_TO_POINTER(DEVELOP_COMBINE_INV_INCL));</a>
<a name="ln2257"> </a>
<a name="ln2258">    dt_bauhaus_combobox_set(bd-&gt;masks_combine_combo, 0);</a>
<a name="ln2259">    gtk_widget_set_tooltip_text(bd-&gt;masks_combine_combo,</a>
<a name="ln2260">                                _(&quot;how to combine individual drawn mask and different channels of parametric mask&quot;));</a>
<a name="ln2261">    g_signal_connect(G_OBJECT(bd-&gt;masks_combine_combo), &quot;value-changed&quot;,</a>
<a name="ln2262">                     G_CALLBACK(_blendop_masks_combine_callback), bd);</a>
<a name="ln2263"> </a>
<a name="ln2264"> </a>
<a name="ln2265">    bd-&gt;masks_invert_combo = dt_bauhaus_combobox_new(module);</a>
<a name="ln2266">    dt_bauhaus_widget_set_label(bd-&gt;masks_invert_combo, _(&quot;blend&quot;), _(&quot;invert mask&quot;));</a>
<a name="ln2267"> </a>
<a name="ln2268">    dt_bauhaus_combobox_add(bd-&gt;masks_invert_combo, _(&quot;off&quot;));</a>
<a name="ln2269">    bd-&gt;masks_invert = g_list_append(bd-&gt;masks_invert, GUINT_TO_POINTER(DEVELOP_COMBINE_NORM));</a>
<a name="ln2270"> </a>
<a name="ln2271">    dt_bauhaus_combobox_add(bd-&gt;masks_invert_combo, _(&quot;on&quot;));</a>
<a name="ln2272">    bd-&gt;masks_invert = g_list_append(bd-&gt;masks_invert, GUINT_TO_POINTER(DEVELOP_COMBINE_INV));</a>
<a name="ln2273"> </a>
<a name="ln2274">    dt_bauhaus_combobox_set(bd-&gt;masks_invert_combo, 0);</a>
<a name="ln2275">    gtk_widget_set_tooltip_text(bd-&gt;masks_invert_combo, _(&quot;apply mask in normal or inverted mode&quot;));</a>
<a name="ln2276">    g_signal_connect(G_OBJECT(bd-&gt;masks_invert_combo), &quot;value-changed&quot;,</a>
<a name="ln2277">                     G_CALLBACK(_blendop_masks_invert_callback), bd);</a>
<a name="ln2278"> </a>
<a name="ln2279"> </a>
<a name="ln2280">    bd-&gt;masks_feathering_guide_combo = dt_bauhaus_combobox_new(module);</a>
<a name="ln2281">    dt_bauhaus_widget_set_label(bd-&gt;masks_feathering_guide_combo, _(&quot;feathering guide&quot;), _(&quot;feathering guide&quot;));</a>
<a name="ln2282"> </a>
<a name="ln2283">    dt_bauhaus_combobox_add(bd-&gt;masks_feathering_guide_combo, _(&quot;output image&quot;));</a>
<a name="ln2284">    bd-&gt;masks_feathering_guide</a>
<a name="ln2285">        = g_list_append(bd-&gt;masks_feathering_guide, GUINT_TO_POINTER(DEVELOP_MASK_GUIDE_OUT));</a>
<a name="ln2286"> </a>
<a name="ln2287">    dt_bauhaus_combobox_add(bd-&gt;masks_feathering_guide_combo, _(&quot;input image&quot;));</a>
<a name="ln2288">    bd-&gt;masks_feathering_guide</a>
<a name="ln2289">        = g_list_append(bd-&gt;masks_feathering_guide, GUINT_TO_POINTER(DEVELOP_MASK_GUIDE_IN));</a>
<a name="ln2290"> </a>
<a name="ln2291">    dt_bauhaus_combobox_set(bd-&gt;masks_feathering_guide_combo, 0);</a>
<a name="ln2292">    gtk_widget_set_tooltip_text(bd-&gt;masks_feathering_guide_combo,</a>
<a name="ln2293">                                _(&quot;choose to guide mask by input or output image&quot;));</a>
<a name="ln2294">    g_signal_connect(G_OBJECT(bd-&gt;masks_feathering_guide_combo), &quot;value-changed&quot;,</a>
<a name="ln2295">                     G_CALLBACK(_blendop_masks_feathering_guide_callback), bd);</a>
<a name="ln2296"> </a>
<a name="ln2297"> </a>
<a name="ln2298">    bd-&gt;feathering_radius_slider = dt_bauhaus_slider_new_with_range(module, 0.0, 250.0, 0.1, 0.0, 1);</a>
<a name="ln2299">    dt_bauhaus_widget_set_label(bd-&gt;feathering_radius_slider, _(&quot;blend&quot;), _(&quot;feathering radius&quot;));</a>
<a name="ln2300">    dt_bauhaus_slider_set_format(bd-&gt;feathering_radius_slider, &quot;%.1f&quot;);</a>
<a name="ln2301">    gtk_widget_set_tooltip_text(bd-&gt;feathering_radius_slider, _(&quot;spatial radius of feathering&quot;));</a>
<a name="ln2302">    g_signal_connect(G_OBJECT(bd-&gt;feathering_radius_slider), &quot;value-changed&quot;,</a>
<a name="ln2303">                     G_CALLBACK(_blendop_blendif_feathering_radius_callback), bd);</a>
<a name="ln2304"> </a>
<a name="ln2305"> </a>
<a name="ln2306">    bd-&gt;blur_radius_slider = dt_bauhaus_slider_new_with_range(module, 0.0, 100.0, 0.1, 0.0, 1);</a>
<a name="ln2307">    dt_bauhaus_widget_set_label(bd-&gt;blur_radius_slider, _(&quot;blend&quot;), _(&quot;mask blur&quot;));</a>
<a name="ln2308">    dt_bauhaus_slider_set_format(bd-&gt;blur_radius_slider, &quot;%.1f&quot;);</a>
<a name="ln2309">    gtk_widget_set_tooltip_text(bd-&gt;blur_radius_slider, _(&quot;radius for gaussian blur of blend mask&quot;));</a>
<a name="ln2310">    g_signal_connect(G_OBJECT(bd-&gt;blur_radius_slider), &quot;value-changed&quot;,</a>
<a name="ln2311">                     G_CALLBACK(_blendop_blendif_blur_radius_callback), bd);</a>
<a name="ln2312"> </a>
<a name="ln2313"> </a>
<a name="ln2314">    bd-&gt;brightness_slider = dt_bauhaus_slider_new_with_range(module, -1.0, 1.0, 0.01, 0.0, 2);</a>
<a name="ln2315">    dt_bauhaus_widget_set_label(bd-&gt;brightness_slider, _(&quot;blend&quot;), _(&quot;mask opacity&quot;));</a>
<a name="ln2316">    dt_bauhaus_slider_set_format(bd-&gt;brightness_slider, &quot;%.2f&quot;);</a>
<a name="ln2317">    gtk_widget_set_tooltip_text(bd-&gt;brightness_slider, _(&quot;shifts and tilts the tone curve of the blend mask to adjust its &quot;</a>
<a name="ln2318">                                                         &quot;brightness without affecting fully transparent/fully opaque &quot;</a>
<a name="ln2319">                                                         &quot;regions&quot;));</a>
<a name="ln2320">    g_signal_connect(G_OBJECT(bd-&gt;brightness_slider), &quot;value-changed&quot;,</a>
<a name="ln2321">                     G_CALLBACK(_blendop_blendif_brightness_callback), bd);</a>
<a name="ln2322"> </a>
<a name="ln2323"> </a>
<a name="ln2324">    bd-&gt;contrast_slider = dt_bauhaus_slider_new_with_range(module, -1.0, 1.0, 0.01, 0.0, 2);</a>
<a name="ln2325">    dt_bauhaus_widget_set_label(bd-&gt;contrast_slider, _(&quot;blend&quot;), _(&quot;mask contrast&quot;));</a>
<a name="ln2326">    dt_bauhaus_slider_set_format(bd-&gt;contrast_slider, &quot;%.2f&quot;);</a>
<a name="ln2327">    gtk_widget_set_tooltip_text(bd-&gt;contrast_slider, _(&quot;gives the tone curve of the blend mask an s-like shape to &quot;</a>
<a name="ln2328">                                                       &quot;adjust its contrast&quot;));</a>
<a name="ln2329">    g_signal_connect(G_OBJECT(bd-&gt;contrast_slider), &quot;value-changed&quot;,</a>
<a name="ln2330">                     G_CALLBACK(_blendop_blendif_contrast_callback), bd);</a>
<a name="ln2331"> </a>
<a name="ln2332"> </a>
<a name="ln2333">    bd-&gt;showmask = dtgtk_button_new(dtgtk_cairo_paint_showmask, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln2334">    gtk_widget_set_tooltip_text(bd-&gt;showmask, _(&quot;display mask and/or color channel. ctrl-click to display mask, &quot;</a>
<a name="ln2335">                                                &quot;shift-click to display channel. hover over parametric mask slider to &quot;</a>
<a name="ln2336">                                                &quot;select channel for display&quot;));</a>
<a name="ln2337">    gtk_widget_set_size_request(GTK_WIDGET(bd-&gt;showmask), bs, bs);</a>
<a name="ln2338">    g_signal_connect(G_OBJECT(bd-&gt;showmask), &quot;button-press-event&quot;, G_CALLBACK(_blendop_blendif_showmask_clicked), module);</a>
<a name="ln2339">    gtk_widget_set_name(bd-&gt;showmask, &quot;show_mask_button&quot;);</a>
<a name="ln2340"> </a>
<a name="ln2341">    bd-&gt;suppress</a>
<a name="ln2342">        = dtgtk_togglebutton_new(dtgtk_cairo_paint_eye_toggle, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln2343">    gtk_widget_set_tooltip_text(bd-&gt;suppress, _(&quot;temporarily switch off blend mask. only for module in focus&quot;));</a>
<a name="ln2344">    gtk_widget_set_size_request(GTK_WIDGET(bd-&gt;suppress), bs, bs);</a>
<a name="ln2345">    g_signal_connect(G_OBJECT(bd-&gt;suppress), &quot;toggled&quot;, G_CALLBACK(_blendop_blendif_suppress_toggled), module);</a>
<a name="ln2346"> </a>
<a name="ln2347">    GtkWidget *box = gtk_box_new(GTK_ORIENTATION_VERTICAL, DT_BAUHAUS_SPACE);</a>
<a name="ln2348">    gtk_box_pack_start(GTK_BOX(iopw), GTK_WIDGET(box), TRUE, TRUE, 0);</a>
<a name="ln2349"> </a>
<a name="ln2350">    gtk_box_pack_start(GTK_BOX(box), dt_ui_section_label_new(_(&quot;blend options&quot;)), TRUE, TRUE, 0);</a>
<a name="ln2351">    gtk_box_pack_start(GTK_BOX(box), GTK_WIDGET(bd-&gt;masks_modes_combo), TRUE, TRUE, 0);</a>
<a name="ln2352"> </a>
<a name="ln2353">    bd-&gt;top_box = GTK_BOX(gtk_box_new(GTK_ORIENTATION_VERTICAL, DT_BAUHAUS_SPACE));</a>
<a name="ln2354">    gtk_box_pack_start(GTK_BOX(bd-&gt;top_box), bd-&gt;blend_modes_combo, TRUE, TRUE, 0);</a>
<a name="ln2355">    gtk_box_pack_start(GTK_BOX(bd-&gt;top_box), bd-&gt;opacity_slider, TRUE, TRUE, 0);</a>
<a name="ln2356">    gtk_box_pack_start(GTK_BOX(box), GTK_WIDGET(bd-&gt;top_box), TRUE, TRUE, 0);</a>
<a name="ln2357"> </a>
<a name="ln2358">    dt_iop_gui_init_masks(GTK_BOX(iopw), module);</a>
<a name="ln2359">    dt_iop_gui_init_raster(GTK_BOX(iopw), module);</a>
<a name="ln2360">    dt_iop_gui_init_blendif(GTK_BOX(iopw), module);</a>
<a name="ln2361"> </a>
<a name="ln2362">    GtkWidget *hbox = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 4*DT_BAUHAUS_SPACE);</a>
<a name="ln2363">    gtk_box_pack_end(GTK_BOX(hbox), GTK_WIDGET(bd-&gt;showmask), FALSE, FALSE, 0);</a>
<a name="ln2364">    gtk_box_pack_end(GTK_BOX(hbox), GTK_WIDGET(bd-&gt;suppress), FALSE, FALSE, 0);</a>
<a name="ln2365">    bd-&gt;bottom_box = GTK_BOX(gtk_box_new(GTK_ORIENTATION_VERTICAL, DT_BAUHAUS_SPACE));</a>
<a name="ln2366">    gtk_box_pack_start(GTK_BOX(bd-&gt;bottom_box), GTK_WIDGET(bd-&gt;masks_combine_combo), TRUE, TRUE, 0);</a>
<a name="ln2367">    gtk_box_pack_start(GTK_BOX(bd-&gt;bottom_box), GTK_WIDGET(bd-&gt;masks_invert_combo), TRUE, TRUE, 0);</a>
<a name="ln2368">    gtk_box_pack_start(GTK_BOX(bd-&gt;bottom_box), dt_ui_section_label_new(_(&quot;mask refinement&quot;)), TRUE, TRUE, 0);</a>
<a name="ln2369">    gtk_box_pack_start(GTK_BOX(bd-&gt;bottom_box), bd-&gt;masks_feathering_guide_combo, TRUE, TRUE, 0);</a>
<a name="ln2370">    gtk_box_pack_start(GTK_BOX(bd-&gt;bottom_box), bd-&gt;feathering_radius_slider, TRUE, TRUE, 0);</a>
<a name="ln2371">    gtk_box_pack_start(GTK_BOX(bd-&gt;bottom_box), bd-&gt;blur_radius_slider, TRUE, TRUE, 0);</a>
<a name="ln2372">    gtk_box_pack_start(GTK_BOX(bd-&gt;bottom_box), bd-&gt;brightness_slider, TRUE, TRUE, 0);</a>
<a name="ln2373">    gtk_box_pack_start(GTK_BOX(bd-&gt;bottom_box), bd-&gt;contrast_slider, TRUE, TRUE, 0);</a>
<a name="ln2374">    gtk_box_pack_start(GTK_BOX(bd-&gt;bottom_box), hbox, TRUE, TRUE, 0);</a>
<a name="ln2375">    gtk_box_pack_start(GTK_BOX(iopw), GTK_WIDGET(bd-&gt;bottom_box), TRUE, TRUE, 0);</a>
<a name="ln2376">    dt_gui_add_help_link(GTK_WIDGET(bd-&gt;bottom_box), &quot;combined_masks.html&quot;);</a>
<a name="ln2377"> </a>
<a name="ln2378">    bd-&gt;blend_inited = 1;</a>
<a name="ln2379">    gtk_widget_queue_draw(GTK_WIDGET(iopw));</a>
<a name="ln2380">    dt_iop_gui_update_blending(module);</a>
<a name="ln2381">  }</a>
<a name="ln2382">}</a>
<a name="ln2383"> </a>
<a name="ln2384">// modelines: These editor modelines have been set for all relevant files by tools/update_modelines.sh</a>
<a name="ln2385">// vim: shiftwidth=2 expandtab tabstop=2 cindent</a>
<a name="ln2386">// kate: tab-indents: off; indent-width 2; replace-tabs on; indent-mode cstyle; remove-trailing-spaces modified;</a>

</code></pre>
<div class="balloon" rel="1586"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v522/" target="_blank">V522</a> There might be dereferencing of a potential null pointer 'entry'. Check lines: 1586, 1585.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
