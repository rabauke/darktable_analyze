
<html>
<head>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>
<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2">    This file is part of darktable,</a>
<a name="ln3">    copyright (c) 2010 tobias ellinghaus.</a>
<a name="ln4"> </a>
<a name="ln5">    darktable is free software: you can redistribute it and/or modify</a>
<a name="ln6">    it under the terms of the GNU General Public License as published by</a>
<a name="ln7">    the Free Software Foundation, either version 3 of the License, or</a>
<a name="ln8">    (at your option) any later version.</a>
<a name="ln9"> </a>
<a name="ln10">    darktable is distributed in the hope that it will be useful,</a>
<a name="ln11">    but WITHOUT ANY WARRANTY; without even the implied warranty of</a>
<a name="ln12">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</a>
<a name="ln13">    GNU General Public License for more details.</a>
<a name="ln14"> </a>
<a name="ln15">    You should have received a copy of the GNU General Public License</a>
<a name="ln16">    along with darktable.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</a>
<a name="ln17">*/</a>
<a name="ln18"> </a>
<a name="ln19">#include &quot;common/metadata.h&quot;</a>
<a name="ln20">#include &quot;common/debug.h&quot;</a>
<a name="ln21"> </a>
<a name="ln22">#include &lt;stdlib.h&gt;</a>
<a name="ln23"> </a>
<a name="ln24">static void dt_metadata_set_xmp(int id, const char *key, const char *value)</a>
<a name="ln25">{</a>
<a name="ln26">  sqlite3_stmt *stmt;</a>
<a name="ln27"> </a>
<a name="ln28">  int keyid = dt_metadata_get_keyid(key);</a>
<a name="ln29">  if(keyid == -1) // unknown key</a>
<a name="ln30">    return;</a>
<a name="ln31"> </a>
<a name="ln32">  if(id == -1)</a>
<a name="ln33">  {</a>
<a name="ln34">    DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln35">                                &quot;DELETE FROM main.meta_data WHERE id IN (SELECT imgid FROM main.selected_images) &quot;</a>
<a name="ln36">                                &quot;AND key = ?1&quot;,</a>
<a name="ln37">                                -1, &amp;stmt, NULL);</a>
<a name="ln38">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, keyid);</a>
<a name="ln39">    sqlite3_step(stmt);</a>
<a name="ln40">    sqlite3_finalize(stmt);</a>
<a name="ln41"> </a>
<a name="ln42">    if(value != NULL &amp;&amp; value[0] != '\0')</a>
<a name="ln43">    {</a>
<a name="ln44">      DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln45">                                  &quot;INSERT INTO main.meta_data (id, key, value) SELECT imgid, ?1, ?2 FROM &quot;</a>
<a name="ln46">                                  &quot;main.selected_images&quot;,</a>
<a name="ln47">                                  -1, &amp;stmt, NULL);</a>
<a name="ln48">      DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, keyid);</a>
<a name="ln49">      DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 2, value, -1, SQLITE_TRANSIENT);</a>
<a name="ln50">      sqlite3_step(stmt);</a>
<a name="ln51">      sqlite3_finalize(stmt);</a>
<a name="ln52">    }</a>
<a name="ln53">  }</a>
<a name="ln54">  else</a>
<a name="ln55">  {</a>
<a name="ln56">    DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln57">                                &quot;DELETE FROM main.meta_data WHERE id = ?1 AND key = ?2&quot;, -1, &amp;stmt, NULL);</a>
<a name="ln58">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, id);</a>
<a name="ln59">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 2, keyid);</a>
<a name="ln60">    sqlite3_step(stmt);</a>
<a name="ln61">    sqlite3_finalize(stmt);</a>
<a name="ln62"> </a>
<a name="ln63">    if(value != NULL &amp;&amp; value[0] != '\0')</a>
<a name="ln64">    {</a>
<a name="ln65">      DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln66">                                  &quot;INSERT INTO main.meta_data (id, key, value) VALUES (?1, ?2, ?3)&quot;, -1, &amp;stmt,</a>
<a name="ln67">                                  NULL);</a>
<a name="ln68">      DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, id);</a>
<a name="ln69">      DT_DEBUG_SQLITE3_BIND_INT(stmt, 2, keyid);</a>
<a name="ln70">      DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 3, value, -1, SQLITE_TRANSIENT);</a>
<a name="ln71">      sqlite3_step(stmt);</a>
<a name="ln72">      sqlite3_finalize(stmt);</a>
<a name="ln73">    }</a>
<a name="ln74">  }</a>
<a name="ln75">}</a>
<a name="ln76"> </a>
<a name="ln77">static void dt_metadata_set_exif(int id, const char *key, const char *value)</a>
<a name="ln78">{</a>
<a name="ln79">} // TODO Is this useful at all?</a>
<a name="ln80"> </a>
<a name="ln81">static GList *dt_metadata_get_xmp(int id, const char *key, uint32_t *count)</a>
<a name="ln82">{</a>
<a name="ln83">  GList *result = NULL;</a>
<a name="ln84">  sqlite3_stmt *stmt;</a>
<a name="ln85">  uint32_t local_count = 0;</a>
<a name="ln86"> </a>
<a name="ln87">  int keyid = dt_metadata_get_keyid(key);</a>
<a name="ln88">  // key not found in db. Maybe it's one of our &quot;special&quot; keys (rating, tags and colorlabels)?</a>
<a name="ln89">  if(keyid == -1)</a>
<a name="ln90">  {</a>
<a name="ln91">    if(strncmp(key, &quot;Xmp.xmp.Rating&quot;, 14) == 0)</a>
<a name="ln92">    {</a>
<a name="ln93">      if(id == -1)</a>
<a name="ln94">      {</a>
<a name="ln95">        DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), &quot;SELECT flags FROM main.images WHERE id IN &quot;</a>
<a name="ln96">                                                                   &quot;(SELECT imgid FROM main.selected_images)&quot;,</a>
<a name="ln97">                                    -1, &amp;stmt, NULL);</a>
<a name="ln98">      }</a>
<a name="ln99">      else // single image under mouse cursor</a>
<a name="ln100">      {</a>
<a name="ln101">        DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), &quot;SELECT flags FROM main.images WHERE id = ?1&quot;,</a>
<a name="ln102">                                    -1, &amp;stmt, NULL);</a>
<a name="ln103">        DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, id);</a>
<a name="ln104">      }</a>
<a name="ln105">      while(sqlite3_step(stmt) == SQLITE_ROW)</a>
<a name="ln106">      {</a>
<a name="ln107">        local_count++;</a>
<a name="ln108">        int stars = sqlite3_column_int(stmt, 0);</a>
<a name="ln109">        stars = (stars &amp; 0x7) - 1;</a>
<a name="ln110">        result = g_list_append(result, GINT_TO_POINTER(stars));</a>
<a name="ln111">      }</a>
<a name="ln112">      sqlite3_finalize(stmt);</a>
<a name="ln113">    }</a>
<a name="ln114">    else if(strncmp(key, &quot;Xmp.dc.subject&quot;, 14) == 0)</a>
<a name="ln115">    {</a>
<a name="ln116">      if(id == -1)</a>
<a name="ln117">      {</a>
<a name="ln118">        DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln119">                                    &quot;SELECT name FROM data.tags t JOIN main.tagged_images i ON &quot;</a>
<a name="ln120">                                    &quot;i.tagid = t.id WHERE imgid IN &quot;</a>
<a name="ln121">                                    &quot;(SELECT imgid FROM main.selected_images)&quot;,</a>
<a name="ln122">                                    -1, &amp;stmt, NULL);</a>
<a name="ln123">      }</a>
<a name="ln124">      else // single image under mouse cursor</a>
<a name="ln125">      {</a>
<a name="ln126">        DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln127">                                    &quot;SELECT name FROM data.tags t JOIN main.tagged_images i ON &quot;</a>
<a name="ln128">                                    &quot;i.tagid = t.id WHERE imgid = ?1&quot;,</a>
<a name="ln129">                                    -1, &amp;stmt, NULL);</a>
<a name="ln130">        DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, id);</a>
<a name="ln131">      }</a>
<a name="ln132">      while(sqlite3_step(stmt) == SQLITE_ROW)</a>
<a name="ln133">      {</a>
<a name="ln134">        local_count++;</a>
<a name="ln135">        result = g_list_append(result, g_strdup((char *)sqlite3_column_text(stmt, 0)));</a>
<a name="ln136">      }</a>
<a name="ln137">      sqlite3_finalize(stmt);</a>
<a name="ln138">    }</a>
<a name="ln139">    else if(strncmp(key, &quot;Xmp.darktable.colorlabels&quot;, 25) == 0)</a>
<a name="ln140">    {</a>
<a name="ln141">      if(id == -1)</a>
<a name="ln142">      {</a>
<a name="ln143">        DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln144">                                    &quot;SELECT color FROM main.color_labels WHERE imgid IN &quot;</a>
<a name="ln145">                                    &quot;(SELECT imgid FROM main.selected_images)&quot;,</a>
<a name="ln146">                                    -1, &amp;stmt, NULL);</a>
<a name="ln147">      }</a>
<a name="ln148">      else // single image under mouse cursor</a>
<a name="ln149">      {</a>
<a name="ln150">        DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln151">                                    &quot;SELECT color FROM main.color_labels WHERE imgid=?1 ORDER BY color&quot;,</a>
<a name="ln152">                                    -1, &amp;stmt, NULL);</a>
<a name="ln153">        DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, id);</a>
<a name="ln154">      }</a>
<a name="ln155">      while(sqlite3_step(stmt) == SQLITE_ROW)</a>
<a name="ln156">      {</a>
<a name="ln157">        local_count++;</a>
<a name="ln158">        result = g_list_append(result, GINT_TO_POINTER(sqlite3_column_int(stmt, 0)));</a>
<a name="ln159">      }</a>
<a name="ln160">      sqlite3_finalize(stmt);</a>
<a name="ln161">    }</a>
<a name="ln162">    if(count != NULL) *count = local_count;</a>
<a name="ln163">    return result;</a>
<a name="ln164">  }</a>
<a name="ln165"> </a>
<a name="ln166">  // So we got this far -- it has to be a generic key-value entry from meta_data</a>
<a name="ln167">  if(id == -1)</a>
<a name="ln168">  {</a>
<a name="ln169">    DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln170">                                &quot;SELECT value FROM main.meta_data WHERE id IN &quot;</a>
<a name="ln171">                                &quot;(SELECT imgid FROM main.selected_images) AND key = ?1 ORDER BY value&quot;,</a>
<a name="ln172">                                -1, &amp;stmt, NULL);</a>
<a name="ln173">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, keyid);</a>
<a name="ln174">  }</a>
<a name="ln175">  else // single image under mouse cursor</a>
<a name="ln176">  {</a>
<a name="ln177">    DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln178">                                &quot;SELECT value FROM main.meta_data WHERE id = ?1 AND key = ?2 ORDER BY value&quot;, -1,</a>
<a name="ln179">                                &amp;stmt, NULL);</a>
<a name="ln180">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, id);</a>
<a name="ln181">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 2, keyid);</a>
<a name="ln182">  }</a>
<a name="ln183">  while(sqlite3_step(stmt) == SQLITE_ROW)</a>
<a name="ln184">  {</a>
<a name="ln185">    local_count++;</a>
<a name="ln186">    result = g_list_append(result, g_strdup((char *)sqlite3_column_text(stmt, 0)));</a>
<a name="ln187">  }</a>
<a name="ln188">  sqlite3_finalize(stmt);</a>
<a name="ln189">  if(count != NULL) *count = local_count;</a>
<a name="ln190">  return result;</a>
<a name="ln191">}</a>
<a name="ln192"> </a>
<a name="ln193">/*</a>
<a name="ln194">  Dear Mister Dijkstra,</a>
<a name="ln195">  I hereby make a formal apology for using goto statements in the following</a>
<a name="ln196">  function. While I am fully aware that I will rot in the deepest hells for</a>
<a name="ln197">  this ultimate sin and that I'm not worth to be called a &quot;programmer&quot; from</a>
<a name="ln198">  now on, I have one excuse to bring up: I never did so before, and this way</a>
<a name="ln199">  the code gets a lot smaller and less repetitive. And since you are dead</a>
<a name="ln200">  while I am not (yet) I will stick with my gotos.</a>
<a name="ln201">  See you in hell</a>
<a name="ln202">  houz</a>
<a name="ln203">*/</a>
<a name="ln204">static GList *dt_metadata_get_exif(int id, const char *key, uint32_t *count)</a>
<a name="ln205">{</a>
<a name="ln206">  GList *result = NULL;</a>
<a name="ln207">  sqlite3_stmt *stmt;</a>
<a name="ln208">  uint32_t local_count = 0;</a>
<a name="ln209"> </a>
<a name="ln210">  // the doubles</a>
<a name="ln211">  if(strncmp(key, &quot;Exif.Photo.ExposureTime&quot;, 23) == 0)</a>
<a name="ln212">  {</a>
<a name="ln213">    if(id == -1)</a>
<a name="ln214">    {</a>
<a name="ln215">      DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), &quot;SELECT exposure FROM main.images WHERE id IN &quot;</a>
<a name="ln216">                                                                 &quot;(SELECT imgid FROM main.selected_images)&quot;,</a>
<a name="ln217">                                  -1, &amp;stmt, NULL);</a>
<a name="ln218">    }</a>
<a name="ln219">    else // single image under mouse cursor</a>
<a name="ln220">    {</a>
<a name="ln221">      DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), &quot;SELECT exposure FROM main.images WHERE id = ?1&quot;,</a>
<a name="ln222">                                  -1, &amp;stmt, NULL);</a>
<a name="ln223">      DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, id);</a>
<a name="ln224">    }</a>
<a name="ln225">  }</a>
<a name="ln226">  else if(strncmp(key, &quot;Exif.Photo.ApertureValue&quot;, 24) == 0)</a>
<a name="ln227">  {</a>
<a name="ln228">    if(id == -1)</a>
<a name="ln229">    {</a>
<a name="ln230">      DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), &quot;SELECT aperture FROM main.images WHERE id IN &quot;</a>
<a name="ln231">                                                                 &quot;(SELECT imgid FROM main.selected_images)&quot;,</a>
<a name="ln232">                                  -1, &amp;stmt, NULL);</a>
<a name="ln233">    }</a>
<a name="ln234">    else // single image under mouse cursor</a>
<a name="ln235">    {</a>
<a name="ln236">      DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), &quot;SELECT aperture FROM main.images WHERE id = ?1&quot;,</a>
<a name="ln237">                                  -1, &amp;stmt, NULL);</a>
<a name="ln238">      DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, id);</a>
<a name="ln239">    }</a>
<a name="ln240">  }</a>
<a name="ln241">  else if(strncmp(key, &quot;Exif.Photo.ISOSpeedRatings&quot;, 26) == 0)</a>
<a name="ln242">  {</a>
<a name="ln243">    if(id == -1)</a>
<a name="ln244">    {</a>
<a name="ln245">      DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln246">                                  &quot;SELECT iso FROM main.images WHERE id IN &quot;</a>
<a name="ln247">                                  &quot;(SELECT imgid FROM main.selected_images)&quot;, -1, &amp;stmt, NULL);</a>
<a name="ln248">    }</a>
<a name="ln249">    else // single image under mouse cursor</a>
<a name="ln250">    {</a>
<a name="ln251">      DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), &quot;SELECT iso FROM main.images WHERE id = ?1&quot;, -1,</a>
<a name="ln252">                                  &amp;stmt, NULL);</a>
<a name="ln253">      DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, id);</a>
<a name="ln254">    }</a>
<a name="ln255">  }</a>
<a name="ln256">  else if(strncmp(key, &quot;Exif.Photo.FocalLength&quot;, 22) == 0)</a>
<a name="ln257">  {</a>
<a name="ln258">    if(id == -1)</a>
<a name="ln259">    {</a>
<a name="ln260">      DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln261">                                  &quot;SELECT focal_length FROM main.images WHERE id IN &quot;</a>
<a name="ln262">                                  &quot;(SELECT imgid FROM main.selected_images)&quot;,</a>
<a name="ln263">                                  -1, &amp;stmt, NULL);</a>
<a name="ln264">    }</a>
<a name="ln265">    else // single image under mouse cursor</a>
<a name="ln266">    {</a>
<a name="ln267">      DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln268">                                  &quot;SELECT focal_length FROM main.images WHERE id = ?1&quot;, -1, &amp;stmt, NULL);</a>
<a name="ln269">      DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, id);</a>
<a name="ln270">    }</a>
<a name="ln271">  }</a>
<a name="ln272">  else</a>
<a name="ln273">  {</a>
<a name="ln274"> </a>
<a name="ln275">    // the strings</a>
<a name="ln276">    if(strncmp(key, &quot;Exif.Photo.DateTimeOriginal&quot;, 27) == 0)</a>
<a name="ln277">    {</a>
<a name="ln278">      if(id == -1)</a>
<a name="ln279">      {</a>
<a name="ln280">        DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln281">                                    &quot;SELECT datetime_taken FROM main.images WHERE id IN &quot;</a>
<a name="ln282">                                    &quot;(SELECT imgid FROM main.selected_images)&quot;,</a>
<a name="ln283">                                    -1, &amp;stmt, NULL);</a>
<a name="ln284">      }</a>
<a name="ln285">      else // single image under mouse cursor</a>
<a name="ln286">      {</a>
<a name="ln287">        DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln288">                                    &quot;SELECT datetime_taken FROM main.images WHERE id = ?1&quot;, -1, &amp;stmt, NULL);</a>
<a name="ln289">        DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, id);</a>
<a name="ln290">      }</a>
<a name="ln291">    }</a>
<a name="ln292">    else if(strncmp(key, &quot;Exif.Image.Make&quot;, 15) == 0)</a>
<a name="ln293">    {</a>
<a name="ln294">      if(id == -1)</a>
<a name="ln295">      {</a>
<a name="ln296">        DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), &quot;SELECT maker FROM main.images WHERE id IN &quot;</a>
<a name="ln297">                                                                   &quot;(SELECT imgid FROM main.selected_images)&quot;,</a>
<a name="ln298">                                    -1, &amp;stmt, NULL);</a>
<a name="ln299">      }</a>
<a name="ln300">      else // single image under mouse cursor</a>
<a name="ln301">      {</a>
<a name="ln302">        DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), &quot;SELECT maker FROM main.images WHERE id = ?1&quot;,</a>
<a name="ln303">                                    -1, &amp;stmt, NULL);</a>
<a name="ln304">        DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, id);</a>
<a name="ln305">      }</a>
<a name="ln306">    }</a>
<a name="ln307">    else if(strncmp(key, &quot;Exif.Image.Model&quot;, 16) == 0)</a>
<a name="ln308">    {</a>
<a name="ln309">      if(id == -1)</a>
<a name="ln310">      {</a>
<a name="ln311">        DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), &quot;SELECT model FROM main.images WHERE id IN &quot;</a>
<a name="ln312">                                                                   &quot;(SELECT imgid FROM main.selected_images)&quot;,</a>
<a name="ln313">                                    -1, &amp;stmt, NULL);</a>
<a name="ln314">      }</a>
<a name="ln315">      else // single image under mouse cursor</a>
<a name="ln316">      {</a>
<a name="ln317">        DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), &quot;SELECT model FROM main.images WHERE id = ?1&quot;,</a>
<a name="ln318">                                    -1, &amp;stmt, NULL);</a>
<a name="ln319">        DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, id);</a>
<a name="ln320">      }</a>
<a name="ln321">    }</a>
<a name="ln322">    else</a>
<a name="ln323">    {</a>
<a name="ln324">      goto END;</a>
<a name="ln325">    }</a>
<a name="ln326">    while(sqlite3_step(stmt) == SQLITE_ROW)</a>
<a name="ln327">    {</a>
<a name="ln328">      local_count++;</a>
<a name="ln329">      result = g_list_append(result, g_strdup((char *)sqlite3_column_text(stmt, 0)));</a>
<a name="ln330">    }</a>
<a name="ln331">    sqlite3_finalize(stmt);</a>
<a name="ln332">    goto END;</a>
<a name="ln333">  }</a>
<a name="ln334"> </a>
<a name="ln335">  // the double queries</a>
<a name="ln336">  while(sqlite3_step(stmt) == SQLITE_ROW)</a>
<a name="ln337">  {</a>
<a name="ln338">    local_count++;</a>
<a name="ln339">    double *tmp = (double *)malloc(sizeof(double));</a>
<a name="ln340">    *tmp = sqlite3_column_double(stmt, 0);</a>
<a name="ln341">    result = g_list_append(result, tmp);</a>
<a name="ln342">  }</a>
<a name="ln343">  sqlite3_finalize(stmt);</a>
<a name="ln344"> </a>
<a name="ln345">END:</a>
<a name="ln346">  if(count != NULL) *count = local_count;</a>
<a name="ln347">  return result;</a>
<a name="ln348">}</a>
<a name="ln349"> </a>
<a name="ln350">// for everything which doesn't fit anywhere else (our made up stuff)</a>
<a name="ln351">static GList *dt_metadata_get_dt(int id, const char *key, uint32_t *count)</a>
<a name="ln352">{</a>
<a name="ln353">  GList *result = NULL;</a>
<a name="ln354">  sqlite3_stmt *stmt;</a>
<a name="ln355">  uint32_t local_count = 0;</a>
<a name="ln356"> </a>
<a name="ln357">  if(strncmp(key, &quot;darktable.Lens&quot;, 14) == 0)</a>
<a name="ln358">  {</a>
<a name="ln359">    if(id == -1)</a>
<a name="ln360">    {</a>
<a name="ln361">      DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), &quot;SELECT lens FROM main.images WHERE id IN &quot;</a>
<a name="ln362">                                                                 &quot;(SELECT imgid FROM main.selected_images)&quot;,</a>
<a name="ln363">                                  -1, &amp;stmt, NULL);</a>
<a name="ln364">    }</a>
<a name="ln365">    else // single image under mouse cursor</a>
<a name="ln366">    {</a>
<a name="ln367">      DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), &quot;SELECT lens FROM main.images WHERE id = ?1&quot;, -1,</a>
<a name="ln368">                                  &amp;stmt, NULL);</a>
<a name="ln369">      DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, id);</a>
<a name="ln370">    }</a>
<a name="ln371">    while(sqlite3_step(stmt) == SQLITE_ROW)</a>
<a name="ln372">    {</a>
<a name="ln373">      local_count++;</a>
<a name="ln374">      result = g_list_append(result, g_strdup((char *)sqlite3_column_text(stmt, 0)));</a>
<a name="ln375">    }</a>
<a name="ln376">    sqlite3_finalize(stmt);</a>
<a name="ln377">  }</a>
<a name="ln378">  else if(strncmp(key, &quot;darktable.Name&quot;, 14) == 0)</a>
<a name="ln379">  {</a>
<a name="ln380">    result = g_list_append(result, g_strdup(PACKAGE_NAME));</a>
<a name="ln381">    local_count = 1;</a>
<a name="ln382">  }</a>
<a name="ln383">  else if(strncmp(key, &quot;darktable.Version&quot;, 17) == 0)</a>
<a name="ln384">  {</a>
<a name="ln385">    result = g_list_append(result, g_strdup(darktable_package_version));</a>
<a name="ln386">    local_count = 1;</a>
<a name="ln387">  }</a>
<a name="ln388">  if(count != NULL) *count = local_count;</a>
<a name="ln389">  return result;</a>
<a name="ln390">}</a>
<a name="ln391"> </a>
<a name="ln392">void dt_metadata_set(int id, const char *key, const char *value)</a>
<a name="ln393">{</a>
<a name="ln394">  if(!key) return;</a>
<a name="ln395"> </a>
<a name="ln396">  char *v = NULL;</a>
<a name="ln397">  char *c = NULL;</a>
<a name="ln398"> </a>
<a name="ln399">  // strip whitespace from start &amp; end</a>
<a name="ln400">  if(value)</a>
<a name="ln401">  {</a>
<a name="ln402">    v = g_strdup(value);</a>
<a name="ln403">    c = v + strlen(v) - 1;</a>
<a name="ln404">    while(c &gt;= v &amp;&amp; *c == ' ') *c-- = '\0';</a>
<a name="ln405">    c = v;</a>
<a name="ln406">    while(*c == ' ') c++;</a>
<a name="ln407">  }</a>
<a name="ln408"> </a>
<a name="ln409">  if(strncmp(key, &quot;Xmp.&quot;, 4) == 0)</a>
<a name="ln410">    dt_metadata_set_xmp(id, key, c);</a>
<a name="ln411">  else if(strncmp(key, &quot;Exif.&quot;, 5) == 0)</a>
<a name="ln412">    dt_metadata_set_exif(id, key, c);</a>
<a name="ln413"> </a>
<a name="ln414">  g_free(v);</a>
<a name="ln415">}</a>
<a name="ln416"> </a>
<a name="ln417">GList *dt_metadata_get(int id, const char *key, uint32_t *count)</a>
<a name="ln418">{</a>
<a name="ln419">  if(strncmp(key, &quot;Xmp.&quot;, 4) == 0) return dt_metadata_get_xmp(id, key, count);</a>
<a name="ln420">  if(strncmp(key, &quot;Exif.&quot;, 5) == 0) return dt_metadata_get_exif(id, key, count);</a>
<a name="ln421">  if(strncmp(key, &quot;darktable.&quot;, 10) == 0) return dt_metadata_get_dt(id, key, count);</a>
<a name="ln422">  return NULL;</a>
<a name="ln423">}</a>
<a name="ln424"> </a>
<a name="ln425">// TODO: Also clear exif data? I don't think it makes sense.</a>
<a name="ln426">void dt_metadata_clear(int id)</a>
<a name="ln427">{</a>
<a name="ln428">  if(id == -1)</a>
<a name="ln429">  {</a>
<a name="ln430">    DT_DEBUG_SQLITE3_EXEC(dt_database_get(darktable.db), &quot;DELETE FROM main.meta_data WHERE id IN &quot;</a>
<a name="ln431">                                                         &quot;(SELECT imgid FROM main.selected_images)&quot;,</a>
<a name="ln432">                          NULL, NULL, NULL);</a>
<a name="ln433">  }</a>
<a name="ln434">  else</a>
<a name="ln435">  {</a>
<a name="ln436">    sqlite3_stmt *stmt;</a>
<a name="ln437">    DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), &quot;DELETE FROM main.meta_data WHERE id = ?1&quot;, -1,</a>
<a name="ln438">                                &amp;stmt, NULL);</a>
<a name="ln439">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, id);</a>
<a name="ln440">    sqlite3_step(stmt);</a>
<a name="ln441">    sqlite3_finalize(stmt);</a>
<a name="ln442">  }</a>
<a name="ln443">}</a>
<a name="ln444"> </a>
<a name="ln445">// modelines: These editor modelines have been set for all relevant files by tools/update_modelines.sh</a>
<a name="ln446">// vim: shiftwidth=2 expandtab tabstop=2 cindent</a>
<a name="ln447">// kate: tab-indents: off; indent-width 2; replace-tabs on; indent-mode cstyle; remove-trailing-spaces modified;</a>

</code></pre>
<div class="balloon" rel="29"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v547/" target="_blank">V547</a> Expression 'keyid == - 1' is always false.</p></div>
<div class="balloon" rel="89"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v547/" target="_blank">V547</a> Expression 'keyid == - 1' is always false.</p></div>
<div class="balloon" rel="340"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v522/" target="_blank">V522</a> There might be dereferencing of a potential null pointer 'tmp'. Check lines: 340, 339.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
