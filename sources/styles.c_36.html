
<html>
<head>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>
<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2">    This file is part of darktable,</a>
<a name="ln3">    copyright (c) 2010-2011 henrik andersson.</a>
<a name="ln4"> </a>
<a name="ln5">    darktable is free software: you can redistribute it and/or modify</a>
<a name="ln6">    it under the terms of the GNU General Public License as published by</a>
<a name="ln7">    the Free Software Foundation, either version 3 of the License, or</a>
<a name="ln8">    (at your option) any later version.</a>
<a name="ln9"> </a>
<a name="ln10">    darktable is distributed in the hope that it will be useful,</a>
<a name="ln11">    but WITHOUT ANY WARRANTY; without even the implied warranty of</a>
<a name="ln12">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</a>
<a name="ln13">    GNU General Public License for more details.</a>
<a name="ln14"> </a>
<a name="ln15">    You should have received a copy of the GNU General Public License</a>
<a name="ln16">    along with darktable.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</a>
<a name="ln17">*/</a>
<a name="ln18"> </a>
<a name="ln19">#include &quot;common/styles.h&quot;</a>
<a name="ln20">#include &quot;common/darktable.h&quot;</a>
<a name="ln21">#include &quot;common/debug.h&quot;</a>
<a name="ln22">#include &quot;common/exif.h&quot;</a>
<a name="ln23">#include &quot;common/file_location.h&quot;</a>
<a name="ln24">#include &quot;common/history.h&quot;</a>
<a name="ln25">#include &quot;common/image_cache.h&quot;</a>
<a name="ln26">#include &quot;common/imageio.h&quot;</a>
<a name="ln27">#include &quot;common/tags.h&quot;</a>
<a name="ln28">#include &quot;control/control.h&quot;</a>
<a name="ln29">#include &quot;develop/develop.h&quot;</a>
<a name="ln30"> </a>
<a name="ln31">#include &quot;gui/accelerators.h&quot;</a>
<a name="ln32">#include &quot;gui/styles.h&quot;</a>
<a name="ln33">#include &lt;libxml/encoding.h&gt;</a>
<a name="ln34">#include &lt;libxml/xmlwriter.h&gt;</a>
<a name="ln35"> </a>
<a name="ln36">#include &lt;glib.h&gt;</a>
<a name="ln37">#include &lt;stdio.h&gt;</a>
<a name="ln38">#include &lt;string.h&gt;</a>
<a name="ln39"> </a>
<a name="ln40">typedef struct</a>
<a name="ln41">{</a>
<a name="ln42">  GString *name;</a>
<a name="ln43">  GString *description;</a>
<a name="ln44">} StyleInfoData;</a>
<a name="ln45"> </a>
<a name="ln46">typedef struct</a>
<a name="ln47">{</a>
<a name="ln48">  int num;</a>
<a name="ln49">  int module;</a>
<a name="ln50">  GString *operation;</a>
<a name="ln51">  GString *op_params;</a>
<a name="ln52">  GString *blendop_params;</a>
<a name="ln53">  int blendop_version;</a>
<a name="ln54">  int multi_priority;</a>
<a name="ln55">  GString *multi_name;</a>
<a name="ln56">  int enabled;</a>
<a name="ln57">} StylePluginData;</a>
<a name="ln58"> </a>
<a name="ln59">typedef struct</a>
<a name="ln60">{</a>
<a name="ln61">  StyleInfoData *info;</a>
<a name="ln62">  GList *plugins;</a>
<a name="ln63">  gboolean in_plugin;</a>
<a name="ln64">} StyleData;</a>
<a name="ln65"> </a>
<a name="ln66">void dt_style_free(gpointer data)</a>
<a name="ln67">{</a>
<a name="ln68">  dt_style_t *style = (dt_style_t *)data;</a>
<a name="ln69">  g_free(style-&gt;name);</a>
<a name="ln70">  g_free(style-&gt;description);</a>
<a name="ln71">  style-&gt;name = NULL;</a>
<a name="ln72">  style-&gt;description = NULL;</a>
<a name="ln73">  g_free(style);</a>
<a name="ln74">}</a>
<a name="ln75"> </a>
<a name="ln76">void dt_style_item_free(gpointer data)</a>
<a name="ln77">{</a>
<a name="ln78">  dt_style_item_t *item = (dt_style_item_t *)data;</a>
<a name="ln79">  g_free(item-&gt;name);</a>
<a name="ln80">  g_free(item-&gt;operation);</a>
<a name="ln81">  free(item-&gt;params);</a>
<a name="ln82">  free(item-&gt;blendop_params);</a>
<a name="ln83">  item-&gt;name = NULL;</a>
<a name="ln84">  item-&gt;operation = NULL;</a>
<a name="ln85">  item-&gt;params = NULL;</a>
<a name="ln86">  item-&gt;blendop_params = NULL;</a>
<a name="ln87">  free(item);</a>
<a name="ln88">}</a>
<a name="ln89"> </a>
<a name="ln90">static gboolean _apply_style_shortcut_callback(GtkAccelGroup *accel_group, GObject *acceleratable,</a>
<a name="ln91">                                               guint keyval, GdkModifierType modifier, gpointer data)</a>
<a name="ln92">{</a>
<a name="ln93">  dt_styles_apply_to_selection(data, 0);</a>
<a name="ln94">  return TRUE;</a>
<a name="ln95">}</a>
<a name="ln96"> </a>
<a name="ln97">static void _destroy_style_shortcut_callback(gpointer data, GClosure *closure)</a>
<a name="ln98">{</a>
<a name="ln99">  g_free(data);</a>
<a name="ln100">}</a>
<a name="ln101"> </a>
<a name="ln102">static int32_t dt_styles_get_id_by_name(const char *name);</a>
<a name="ln103"> </a>
<a name="ln104">gboolean dt_styles_exists(const char *name)</a>
<a name="ln105">{</a>
<a name="ln106">  return (dt_styles_get_id_by_name(name)) != 0 ? TRUE : FALSE;</a>
<a name="ln107">}</a>
<a name="ln108"> </a>
<a name="ln109">static void _dt_style_cleanup_multi_instance(int id)</a>
<a name="ln110">{</a>
<a name="ln111">  sqlite3_stmt *stmt;</a>
<a name="ln112">  GList *list = NULL;</a>
<a name="ln113">  struct _data</a>
<a name="ln114">  {</a>
<a name="ln115">    int rowid;</a>
<a name="ln116">    int mi;</a>
<a name="ln117">  };</a>
<a name="ln118">  char last_operation[128] = { 0 };</a>
<a name="ln119">  int last_mi = 0;</a>
<a name="ln120"> </a>
<a name="ln121">  /* let's clean-up the style multi-instance. What we want to do is have a unique multi_priority value for</a>
<a name="ln122">     each iop.</a>
<a name="ln123">     Furthermore this value must start to 0 and increment one by one for each multi-instance of the same</a>
<a name="ln124">     module. On</a>
<a name="ln125">     SQLite there is no notion of ROW_NUMBER, so we use rather resource consuming SQL statement, but as a</a>
<a name="ln126">     style has</a>
<a name="ln127">     never a huge number of items that's not a real issue. */</a>
<a name="ln128"> </a>
<a name="ln129">  /* 1. read all data for the style and record multi_instance value. */</a>
<a name="ln130"> </a>
<a name="ln131">  DT_DEBUG_SQLITE3_PREPARE_V2(</a>
<a name="ln132">      dt_database_get(darktable.db),</a>
<a name="ln133">      &quot;SELECT rowid,operation FROM data.style_items WHERE styleid=?1 ORDER BY operation, multi_priority ASC&quot;, -1,</a>
<a name="ln134">      &amp;stmt, NULL);</a>
<a name="ln135">  DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, id);</a>
<a name="ln136"> </a>
<a name="ln137">  while(sqlite3_step(stmt) == SQLITE_ROW)</a>
<a name="ln138">  {</a>
<a name="ln139">    struct _data *d = malloc(sizeof(struct _data));</a>
<a name="ln140">    const char *operation = (const char *)sqlite3_column_text(stmt, 1);</a>
<a name="ln141"> </a>
<a name="ln142">    if(strncmp(last_operation, operation, 128) != 0)</a>
<a name="ln143">    {</a>
<a name="ln144">      last_mi = 0;</a>
<a name="ln145">      g_strlcpy(last_operation, operation, sizeof(last_operation));</a>
<a name="ln146">    }</a>
<a name="ln147">    else</a>
<a name="ln148">      last_mi++;</a>
<a name="ln149"> </a>
<a name="ln150">    d-&gt;rowid = sqlite3_column_int(stmt, 0);</a>
<a name="ln151">    d-&gt;mi = last_mi;</a>
<a name="ln152">    list = g_list_append(list, d);</a>
<a name="ln153">  }</a>
<a name="ln154">  sqlite3_finalize(stmt);</a>
<a name="ln155"> </a>
<a name="ln156">  /* 2. now update all multi_instance values previously recorded */</a>
<a name="ln157"> </a>
<a name="ln158">  list = g_list_first(list);</a>
<a name="ln159">  while(list)</a>
<a name="ln160">  {</a>
<a name="ln161">    struct _data *d = (struct _data *)list-&gt;data;</a>
<a name="ln162"> </a>
<a name="ln163">    DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln164">                                &quot;UPDATE data.style_items SET multi_priority=?1 WHERE rowid=?2&quot;, -1, &amp;stmt, NULL);</a>
<a name="ln165">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, d-&gt;mi);</a>
<a name="ln166">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 2, d-&gt;rowid);</a>
<a name="ln167">    sqlite3_step(stmt);</a>
<a name="ln168">    sqlite3_finalize(stmt);</a>
<a name="ln169"> </a>
<a name="ln170">    list = g_list_next(list);</a>
<a name="ln171">  }</a>
<a name="ln172"> </a>
<a name="ln173">  g_list_free_full(list, free);</a>
<a name="ln174">}</a>
<a name="ln175"> </a>
<a name="ln176">static gboolean dt_styles_create_style_header(const char *name, const char *description)</a>
<a name="ln177">{</a>
<a name="ln178">  sqlite3_stmt *stmt;</a>
<a name="ln179">  if(dt_styles_get_id_by_name(name) != 0)</a>
<a name="ln180">  {</a>
<a name="ln181">    dt_control_log(_(&quot;style with name '%s' already exists&quot;), name);</a>
<a name="ln182">    return FALSE;</a>
<a name="ln183">  }</a>
<a name="ln184">  /* first create the style header */</a>
<a name="ln185">  DT_DEBUG_SQLITE3_PREPARE_V2(</a>
<a name="ln186">      dt_database_get(darktable.db),</a>
<a name="ln187">      &quot;INSERT INTO data.styles (name,description,id) VALUES &quot;</a>
<a name="ln188">      &quot;(?1,?2,(SELECT COALESCE(MAX(id),0)+1 FROM data.styles))&quot;, -1, &amp;stmt, NULL);</a>
<a name="ln189">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 1, name, -1, SQLITE_STATIC);</a>
<a name="ln190">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 2, description, -1, SQLITE_STATIC);</a>
<a name="ln191">  sqlite3_step(stmt);</a>
<a name="ln192">  sqlite3_finalize(stmt);</a>
<a name="ln193">  return TRUE;</a>
<a name="ln194">}</a>
<a name="ln195"> </a>
<a name="ln196">static void _dt_style_update_from_image(int id, int imgid, GList *filter, GList *update)</a>
<a name="ln197">{</a>
<a name="ln198">  if(update &amp;&amp; imgid != -1)</a>
<a name="ln199">  {</a>
<a name="ln200">    GList *list = filter;</a>
<a name="ln201">    GList *upd = update;</a>
<a name="ln202">    char query[4096] = { 0 };</a>
<a name="ln203">    char tmp[500];</a>
<a name="ln204">    char *fields[] = { &quot;op_params&quot;,       &quot;module&quot;,         &quot;enabled&quot;,    &quot;blendop_params&quot;,</a>
<a name="ln205">                       &quot;blendop_version&quot;, &quot;multi_priority&quot;, &quot;multi_name&quot;, 0 };</a>
<a name="ln206">    do</a>
<a name="ln207">    {</a>
<a name="ln208">      query[0] = '\0';</a>
<a name="ln209"> </a>
<a name="ln210">      // included and update set, we then need to update the corresponding style item</a>
<a name="ln211">      if(GPOINTER_TO_INT(upd-&gt;data) != -1 &amp;&amp; GPOINTER_TO_INT(list-&gt;data) != -1)</a>
<a name="ln212">      {</a>
<a name="ln213">        g_strlcpy(query, &quot;UPDATE data.style_items SET &quot;, sizeof(query));</a>
<a name="ln214"> </a>
<a name="ln215">        for(int k = 0; fields[k]; k++)</a>
<a name="ln216">        {</a>
<a name="ln217">          if(k != 0) g_strlcat(query, &quot;,&quot;, sizeof(query));</a>
<a name="ln218">          snprintf(tmp, sizeof(tmp), &quot;%s=(SELECT %s FROM main.history WHERE imgid=%d AND num=%d)&quot;, fields[k],</a>
<a name="ln219">                   fields[k], imgid, GPOINTER_TO_INT(upd-&gt;data));</a>
<a name="ln220">          g_strlcat(query, tmp, sizeof(query));</a>
<a name="ln221">        }</a>
<a name="ln222">        snprintf(tmp, sizeof(tmp), &quot; WHERE styleid=%d AND data.style_items.num=%d&quot;, id,</a>
<a name="ln223">                 GPOINTER_TO_INT(list-&gt;data));</a>
<a name="ln224">        g_strlcat(query, tmp, sizeof(query));</a>
<a name="ln225">      }</a>
<a name="ln226">      // update only, so we want to insert the new style item</a>
<a name="ln227">      else if(GPOINTER_TO_INT(upd-&gt;data) != -1)</a>
<a name="ln228">        snprintf(query, sizeof(query), &quot;INSERT INTO data.style_items &quot;</a>
<a name="ln229">                                       &quot;(styleid,num,module,operation,op_params,enabled,blendop_params,&quot;</a>
<a name="ln230">                                       &quot;blendop_version,multi_priority,multi_name) SELECT %d,(SELECT num+1 &quot;</a>
<a name="ln231">                                       &quot;FROM data.style_items WHERE styleid=%d ORDER BY num DESC LIMIT 1), &quot;</a>
<a name="ln232">                                       &quot;module,operation,op_params,enabled,blendop_params,blendop_version,&quot;</a>
<a name="ln233">                                       &quot;multi_priority,multi_name FROM main.history WHERE imgid=%d AND num=%d&quot;,</a>
<a name="ln234">                 id, id, imgid, GPOINTER_TO_INT(upd-&gt;data));</a>
<a name="ln235"> </a>
<a name="ln236">      if(*query) DT_DEBUG_SQLITE3_EXEC(dt_database_get(darktable.db), query, NULL, NULL, NULL);</a>
<a name="ln237"> </a>
<a name="ln238">      list = g_list_next(list);</a>
<a name="ln239">      upd = g_list_next(upd);</a>
<a name="ln240">    } while(list);</a>
<a name="ln241">  }</a>
<a name="ln242">}</a>
<a name="ln243"> </a>
<a name="ln244">void dt_styles_update(const char *name, const char *newname, const char *newdescription, GList *filter,</a>
<a name="ln245">                      int imgid, GList *update)</a>
<a name="ln246">{</a>
<a name="ln247">  sqlite3_stmt *stmt;</a>
<a name="ln248">  int id = 0;</a>
<a name="ln249">  gchar *desc = NULL;</a>
<a name="ln250"> </a>
<a name="ln251">  id = dt_styles_get_id_by_name(name);</a>
<a name="ln252">  if(id == 0) return;</a>
<a name="ln253"> </a>
<a name="ln254">  desc = dt_styles_get_description(name);</a>
<a name="ln255"> </a>
<a name="ln256">  if((g_strcmp0(name, newname)) || (g_strcmp0(desc, newdescription)))</a>
<a name="ln257">  {</a>
<a name="ln258">    DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln259">                                &quot;UPDATE data.styles SET name=?1, description=?2 WHERE id=?3&quot;, -1, &amp;stmt, NULL);</a>
<a name="ln260">    DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 1, newname, -1, SQLITE_STATIC);</a>
<a name="ln261">    DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 2, newdescription, -1, SQLITE_STATIC);</a>
<a name="ln262">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 3, id);</a>
<a name="ln263">    sqlite3_step(stmt);</a>
<a name="ln264">    sqlite3_finalize(stmt);</a>
<a name="ln265">  }</a>
<a name="ln266"> </a>
<a name="ln267">  if(filter)</a>
<a name="ln268">  {</a>
<a name="ln269">    GList *list = filter;</a>
<a name="ln270">    char tmp[64];</a>
<a name="ln271">    char include[2048] = { 0 };</a>
<a name="ln272">    g_strlcat(include, &quot;num NOT IN (&quot;, sizeof(include));</a>
<a name="ln273">    do</a>
<a name="ln274">    {</a>
<a name="ln275">      if(list != g_list_first(list)) g_strlcat(include, &quot;,&quot;, sizeof(include));</a>
<a name="ln276">      snprintf(tmp, sizeof(tmp), &quot;%d&quot;, GPOINTER_TO_INT(list-&gt;data));</a>
<a name="ln277">      g_strlcat(include, tmp, sizeof(include));</a>
<a name="ln278">    } while((list = g_list_next(list)));</a>
<a name="ln279">    g_strlcat(include, &quot;)&quot;, sizeof(include));</a>
<a name="ln280"> </a>
<a name="ln281">    char query[4096] = { 0 };</a>
<a name="ln282">    snprintf(query, sizeof(query), &quot;DELETE FROM data.style_items WHERE styleid=?1 AND %s&quot;, include);</a>
<a name="ln283">    DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), query, -1, &amp;stmt, NULL);</a>
<a name="ln284">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, id);</a>
<a name="ln285">    sqlite3_step(stmt);</a>
<a name="ln286">    sqlite3_finalize(stmt);</a>
<a name="ln287">  }</a>
<a name="ln288"> </a>
<a name="ln289">  _dt_style_update_from_image(id, imgid, filter, update);</a>
<a name="ln290"> </a>
<a name="ln291">  _dt_style_cleanup_multi_instance(id);</a>
<a name="ln292"> </a>
<a name="ln293">  /* backup style to disk */</a>
<a name="ln294">  char stylesdir[PATH_MAX] = { 0 };</a>
<a name="ln295">  dt_loc_get_user_config_dir(stylesdir, sizeof(stylesdir));</a>
<a name="ln296">  g_strlcat(stylesdir, &quot;/styles&quot;, sizeof(stylesdir));</a>
<a name="ln297">  g_mkdir_with_parents(stylesdir, 00755);</a>
<a name="ln298"> </a>
<a name="ln299">  dt_styles_save_to_file(newname, stylesdir, TRUE);</a>
<a name="ln300"> </a>
<a name="ln301">  /* delete old accelerator and create a new one */</a>
<a name="ln302">  // TODO: should better use dt_accel_rename_global() to keep the old accel_key untouched, but it seems to be</a>
<a name="ln303">  // buggy</a>
<a name="ln304">  if(g_strcmp0(name, newname))</a>
<a name="ln305">  {</a>
<a name="ln306">    char tmp_accel[1024];</a>
<a name="ln307">    snprintf(tmp_accel, sizeof(tmp_accel), C_(&quot;accel&quot;, &quot;styles/apply %s&quot;), name);</a>
<a name="ln308">    dt_accel_deregister_global(tmp_accel);</a>
<a name="ln309"> </a>
<a name="ln310">    gchar *tmp_name = g_strdup(newname); // freed by _destroy_style_shortcut_callback</a>
<a name="ln311">    snprintf(tmp_accel, sizeof(tmp_accel), C_(&quot;accel&quot;, &quot;styles/apply %s&quot;), newname);</a>
<a name="ln312">    dt_accel_register_global(tmp_accel, 0, 0);</a>
<a name="ln313">    GClosure *closure;</a>
<a name="ln314">    closure = g_cclosure_new(G_CALLBACK(_apply_style_shortcut_callback), tmp_name,</a>
<a name="ln315">                             _destroy_style_shortcut_callback);</a>
<a name="ln316">    dt_accel_connect_global(tmp_accel, closure);</a>
<a name="ln317">  }</a>
<a name="ln318"> </a>
<a name="ln319">  dt_control_signal_raise(darktable.signals, DT_SIGNAL_STYLE_CHANGED);</a>
<a name="ln320"> </a>
<a name="ln321">  g_free(desc);</a>
<a name="ln322">}</a>
<a name="ln323"> </a>
<a name="ln324">void dt_styles_create_from_style(const char *name, const char *newname, const char *description,</a>
<a name="ln325">                                 GList *filter, int imgid, GList *update)</a>
<a name="ln326">{</a>
<a name="ln327">  sqlite3_stmt *stmt;</a>
<a name="ln328">  int id = 0;</a>
<a name="ln329">  int oldid = 0;</a>
<a name="ln330"> </a>
<a name="ln331">  oldid = dt_styles_get_id_by_name(name);</a>
<a name="ln332">  if(oldid == 0) return;</a>
<a name="ln333"> </a>
<a name="ln334">  /* create the style header */</a>
<a name="ln335">  if(!dt_styles_create_style_header(newname, description)) return;</a>
<a name="ln336"> </a>
<a name="ln337">  if((id = dt_styles_get_id_by_name(newname)) != 0)</a>
<a name="ln338">  {</a>
<a name="ln339">    if(filter)</a>
<a name="ln340">    {</a>
<a name="ln341">      GList *list = filter;</a>
<a name="ln342">      char tmp[64];</a>
<a name="ln343">      char include[2048] = { 0 };</a>
<a name="ln344">      g_strlcat(include, &quot;num IN (&quot;, sizeof(include));</a>
<a name="ln345">      do</a>
<a name="ln346">      {</a>
<a name="ln347">        if(list != g_list_first(list)) g_strlcat(include, &quot;,&quot;, sizeof(include));</a>
<a name="ln348">        snprintf(tmp, sizeof(tmp), &quot;%d&quot;, GPOINTER_TO_INT(list-&gt;data));</a>
<a name="ln349">        g_strlcat(include, tmp, sizeof(include));</a>
<a name="ln350">      } while((list = g_list_next(list)));</a>
<a name="ln351">      g_strlcat(include, &quot;)&quot;, sizeof(include));</a>
<a name="ln352">      char query[4096] = { 0 };</a>
<a name="ln353"> </a>
<a name="ln354">      snprintf(query, sizeof(query), &quot;INSERT INTO data.style_items &quot;</a>
<a name="ln355">                                     &quot;(styleid,num,module,operation,op_params,enabled,blendop_params,blendop_&quot;</a>
<a name="ln356">                                     &quot;version,multi_priority,multi_name) SELECT ?1, &quot;</a>
<a name="ln357">                                     &quot;num,module,operation,op_params,enabled,blendop_params,blendop_version,&quot;</a>
<a name="ln358">                                     &quot;multi_priority,multi_name FROM data.style_items WHERE styleid=?2 AND %s&quot;,</a>
<a name="ln359">               include);</a>
<a name="ln360">      DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), query, -1, &amp;stmt, NULL);</a>
<a name="ln361">    }</a>
<a name="ln362">    else</a>
<a name="ln363">      DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln364">                                  &quot;INSERT INTO data.style_items &quot;</a>
<a name="ln365">                                  &quot;(styleid,num,module,operation,op_params,enabled,blendop_params,blendop_&quot;</a>
<a name="ln366">                                  &quot;version,multi_priority,multi_name) SELECT ?1, &quot;</a>
<a name="ln367">                                  &quot;num,module,operation,op_params,enabled,blendop_params,blendop_version,&quot;</a>
<a name="ln368">                                  &quot;multi_priority,multi_name FROM data.style_items WHERE styleid=?2&quot;,</a>
<a name="ln369">                                  -1, &amp;stmt, NULL);</a>
<a name="ln370">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, id);</a>
<a name="ln371">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 2, oldid);</a>
<a name="ln372">    sqlite3_step(stmt);</a>
<a name="ln373">    sqlite3_finalize(stmt);</a>
<a name="ln374"> </a>
<a name="ln375">    /* insert items from imgid if defined */</a>
<a name="ln376"> </a>
<a name="ln377">    _dt_style_update_from_image(id, imgid, filter, update);</a>
<a name="ln378"> </a>
<a name="ln379">    _dt_style_cleanup_multi_instance(id);</a>
<a name="ln380"> </a>
<a name="ln381">    /* backup style to disk */</a>
<a name="ln382">    char stylesdir[PATH_MAX] = { 0 };</a>
<a name="ln383">    dt_loc_get_user_config_dir(stylesdir, sizeof(stylesdir));</a>
<a name="ln384">    g_strlcat(stylesdir, &quot;/styles&quot;, sizeof(stylesdir));</a>
<a name="ln385">    g_mkdir_with_parents(stylesdir, 00755);</a>
<a name="ln386"> </a>
<a name="ln387">    dt_styles_save_to_file(newname, stylesdir, FALSE);</a>
<a name="ln388"> </a>
<a name="ln389">    char tmp_accel[1024];</a>
<a name="ln390">    gchar *tmp_name = g_strdup(newname); // freed by _destroy_style_shortcut_callback</a>
<a name="ln391">    snprintf(tmp_accel, sizeof(tmp_accel), C_(&quot;accel&quot;, &quot;styles/apply %s&quot;), newname);</a>
<a name="ln392">    dt_accel_register_global(tmp_accel, 0, 0);</a>
<a name="ln393">    GClosure *closure;</a>
<a name="ln394">    closure = g_cclosure_new(G_CALLBACK(_apply_style_shortcut_callback), tmp_name,</a>
<a name="ln395">                             _destroy_style_shortcut_callback);</a>
<a name="ln396">    dt_accel_connect_global(tmp_accel, closure);</a>
<a name="ln397">    dt_control_log(_(&quot;style named '%s' successfully created&quot;), newname);</a>
<a name="ln398">    dt_control_signal_raise(darktable.signals, DT_SIGNAL_STYLE_CHANGED);</a>
<a name="ln399">  }</a>
<a name="ln400">}</a>
<a name="ln401"> </a>
<a name="ln402">gboolean dt_styles_create_from_image(const char *name, const char *description, int32_t imgid, GList *filter)</a>
<a name="ln403">{</a>
<a name="ln404">  int id = 0;</a>
<a name="ln405">  sqlite3_stmt *stmt;</a>
<a name="ln406"> </a>
<a name="ln407">  /* first create the style header */</a>
<a name="ln408">  if(!dt_styles_create_style_header(name, description)) return FALSE;</a>
<a name="ln409"> </a>
<a name="ln410">  if((id = dt_styles_get_id_by_name(name)) != 0)</a>
<a name="ln411">  {</a>
<a name="ln412">    /* create the style_items from source image history stack */</a>
<a name="ln413">    if(filter)</a>
<a name="ln414">    {</a>
<a name="ln415">      GList *list = filter;</a>
<a name="ln416">      char tmp[64];</a>
<a name="ln417">      char include[2048] = { 0 };</a>
<a name="ln418">      g_strlcat(include, &quot;num IN (&quot;, sizeof(include));</a>
<a name="ln419">      do</a>
<a name="ln420">      {</a>
<a name="ln421">        if(list != g_list_first(list)) g_strlcat(include, &quot;,&quot;, sizeof(include));</a>
<a name="ln422">        snprintf(tmp, sizeof(tmp), &quot;%d&quot;, GPOINTER_TO_INT(list-&gt;data));</a>
<a name="ln423">        g_strlcat(include, tmp, sizeof(include));</a>
<a name="ln424">      } while((list = g_list_next(list)));</a>
<a name="ln425">      g_strlcat(include, &quot;)&quot;, sizeof(include));</a>
<a name="ln426">      char query[4096] = { 0 };</a>
<a name="ln427">      snprintf(query, sizeof(query), &quot;INSERT INTO data.style_items &quot;</a>
<a name="ln428">                                     &quot;(styleid,num,module,operation,op_params,enabled,blendop_params,blendop_&quot;</a>
<a name="ln429">                                     &quot;version,multi_priority,multi_name) SELECT ?1, &quot;</a>
<a name="ln430">                                     &quot;num,module,operation,op_params,enabled,blendop_params,blendop_version,&quot;</a>
<a name="ln431">                                     &quot;multi_priority,multi_name FROM main.history WHERE imgid=?2 AND %s&quot;,</a>
<a name="ln432">               include);</a>
<a name="ln433">      DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), query, -1, &amp;stmt, NULL);</a>
<a name="ln434">    }</a>
<a name="ln435">    else</a>
<a name="ln436">      DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln437">                                  &quot;INSERT INTO data.style_items &quot;</a>
<a name="ln438">                                  &quot;(styleid,num,module,operation,op_params,enabled,blendop_params,blendop_&quot;</a>
<a name="ln439">                                  &quot;version,multi_priority,multi_name) SELECT ?1, &quot;</a>
<a name="ln440">                                  &quot;num,module,operation,op_params,enabled,blendop_params,blendop_version,&quot;</a>
<a name="ln441">                                  &quot;multi_priority,multi_name FROM main.history WHERE imgid=?2&quot;,</a>
<a name="ln442">                                  -1, &amp;stmt, NULL);</a>
<a name="ln443">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, id);</a>
<a name="ln444">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 2, imgid);</a>
<a name="ln445">    sqlite3_step(stmt);</a>
<a name="ln446">    sqlite3_finalize(stmt);</a>
<a name="ln447"> </a>
<a name="ln448">    _dt_style_cleanup_multi_instance(id);</a>
<a name="ln449"> </a>
<a name="ln450">    /* backup style to disk */</a>
<a name="ln451">    char stylesdir[PATH_MAX] = { 0 };</a>
<a name="ln452">    dt_loc_get_user_config_dir(stylesdir, sizeof(stylesdir));</a>
<a name="ln453">    g_strlcat(stylesdir, &quot;/styles&quot;, sizeof(stylesdir));</a>
<a name="ln454">    g_mkdir_with_parents(stylesdir, 00755);</a>
<a name="ln455"> </a>
<a name="ln456">    dt_styles_save_to_file(name, stylesdir, FALSE);</a>
<a name="ln457"> </a>
<a name="ln458">    char tmp_accel[1024];</a>
<a name="ln459">    gchar *tmp_name = g_strdup(name); // freed by _destroy_style_shortcut_callback</a>
<a name="ln460">    snprintf(tmp_accel, sizeof(tmp_accel), C_(&quot;accel&quot;, &quot;styles/apply %s&quot;), name);</a>
<a name="ln461">    dt_accel_register_global(tmp_accel, 0, 0);</a>
<a name="ln462">    GClosure *closure;</a>
<a name="ln463">    closure = g_cclosure_new(G_CALLBACK(_apply_style_shortcut_callback), tmp_name,</a>
<a name="ln464">                             _destroy_style_shortcut_callback);</a>
<a name="ln465">    dt_accel_connect_global(tmp_accel, closure);</a>
<a name="ln466">    dt_control_signal_raise(darktable.signals, DT_SIGNAL_STYLE_CHANGED);</a>
<a name="ln467">    return TRUE;</a>
<a name="ln468">  }</a>
<a name="ln469">  return FALSE;</a>
<a name="ln470">}</a>
<a name="ln471"> </a>
<a name="ln472">void dt_styles_apply_to_selection(const char *name, gboolean duplicate)</a>
<a name="ln473">{</a>
<a name="ln474">  gboolean selected = FALSE;</a>
<a name="ln475"> </a>
<a name="ln476">  /* write current history changes so nothing gets lost, do that only in the darkroom as there is nothing to</a>
<a name="ln477">     be</a>
<a name="ln478">     save when in the lighttable (and it would write over current history stack) */</a>
<a name="ln479">  const dt_view_t *cv = dt_view_manager_get_current_view(darktable.view_manager);</a>
<a name="ln480">  if(cv-&gt;view((dt_view_t *)cv) == DT_VIEW_DARKROOM) dt_dev_write_history(darktable.develop);</a>
<a name="ln481"> </a>
<a name="ln482">  /* for each selected image apply style */</a>
<a name="ln483">  sqlite3_stmt *stmt;</a>
<a name="ln484">  DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), &quot;SELECT imgid FROM main.selected_images&quot;,</a>
<a name="ln485">                              -1, &amp;stmt, NULL);</a>
<a name="ln486">  while(sqlite3_step(stmt) == SQLITE_ROW)</a>
<a name="ln487">  {</a>
<a name="ln488">    int imgid = sqlite3_column_int(stmt, 0);</a>
<a name="ln489">    dt_styles_apply_to_image(name, duplicate, imgid);</a>
<a name="ln490">    selected = TRUE;</a>
<a name="ln491">  }</a>
<a name="ln492">  sqlite3_finalize(stmt);</a>
<a name="ln493"> </a>
<a name="ln494">  if(!selected) dt_control_log(_(&quot;no image selected!&quot;));</a>
<a name="ln495">}</a>
<a name="ln496"> </a>
<a name="ln497">void dt_styles_create_from_selection()</a>
<a name="ln498">{</a>
<a name="ln499">  gboolean selected = FALSE;</a>
<a name="ln500">  /* for each selected create style */</a>
<a name="ln501">  sqlite3_stmt *stmt;</a>
<a name="ln502">  DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), &quot;SELECT imgid FROM main.selected_images&quot;,</a>
<a name="ln503">                              -1, &amp;stmt, NULL);</a>
<a name="ln504">  while(sqlite3_step(stmt) == SQLITE_ROW)</a>
<a name="ln505">  {</a>
<a name="ln506">    int imgid = sqlite3_column_int(stmt, 0);</a>
<a name="ln507">    dt_gui_styles_dialog_new(imgid);</a>
<a name="ln508">    selected = TRUE;</a>
<a name="ln509">  }</a>
<a name="ln510">  sqlite3_finalize(stmt);</a>
<a name="ln511"> </a>
<a name="ln512">  if(!selected) dt_control_log(_(&quot;no image selected!&quot;));</a>
<a name="ln513">}</a>
<a name="ln514"> </a>
<a name="ln515">void dt_styles_apply_to_image(const char *name, gboolean duplicate, int32_t imgid)</a>
<a name="ln516">{</a>
<a name="ln517">  int id = 0;</a>
<a name="ln518">  sqlite3_stmt *stmt;</a>
<a name="ln519">  int32_t newimgid;</a>
<a name="ln520"> </a>
<a name="ln521">  if((id = dt_styles_get_id_by_name(name)) != 0)</a>
<a name="ln522">  {</a>
<a name="ln523">    /* check if we should make a duplicate before applying style */</a>
<a name="ln524">    if(duplicate)</a>
<a name="ln525">    {</a>
<a name="ln526">      newimgid = dt_image_duplicate(imgid);</a>
<a name="ln527">      if(newimgid != -1) dt_history_copy_and_paste_on_image(imgid, newimgid, FALSE, NULL);</a>
<a name="ln528">    }</a>
<a name="ln529">    else</a>
<a name="ln530">      newimgid = imgid;</a>
<a name="ln531"> </a>
<a name="ln532">    /* merge onto history stack, let's find history offest in destination image */</a>
<a name="ln533">    /* first trim the stack to get rid of whatever is above the selected entry */</a>
<a name="ln534">    DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln535">                                &quot;DELETE FROM main.history WHERE imgid = ?1 AND num &gt;= (SELECT history_end &quot;</a>
<a name="ln536">                                &quot;FROM main.images WHERE id = imgid)&quot;, -1, &amp;stmt, NULL);</a>
<a name="ln537">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, newimgid);</a>
<a name="ln538">    sqlite3_step(stmt);</a>
<a name="ln539">    sqlite3_finalize(stmt);</a>
<a name="ln540"> </a>
<a name="ln541">    /* in sqlite ROWID starts at 1, while our num column starts at 0 */</a>
<a name="ln542">    int32_t offs = -1;</a>
<a name="ln543">    DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln544">                                &quot;SELECT IFNULL(MAX(num), -1) FROM main.history WHERE imgid = ?1&quot;, -1, &amp;stmt, NULL);</a>
<a name="ln545">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, newimgid);</a>
<a name="ln546">    if(sqlite3_step(stmt) == SQLITE_ROW) offs = sqlite3_column_int(stmt, 0);</a>
<a name="ln547">    sqlite3_finalize(stmt);</a>
<a name="ln548"> </a>
<a name="ln549">    /* delete all items from the temp styles_items, this table is used only to get a ROWNUM of the results */</a>
<a name="ln550">    DT_DEBUG_SQLITE3_EXEC(dt_database_get(darktable.db), &quot;DELETE FROM memory.style_items&quot;, NULL, NULL, NULL);</a>
<a name="ln551"> </a>
<a name="ln552">    /* copy history items from styles onto temp table */</a>
<a name="ln553">    DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), &quot;INSERT INTO memory.style_items SELECT * FROM &quot;</a>
<a name="ln554">                                                               &quot;data.style_items WHERE styleid=?1 ORDER BY &quot;</a>
<a name="ln555">                                                               &quot;num DESC&quot;,</a>
<a name="ln556">                                -1, &amp;stmt, NULL);</a>
<a name="ln557">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, id);</a>
<a name="ln558">    sqlite3_step(stmt);</a>
<a name="ln559">    sqlite3_finalize(stmt);</a>
<a name="ln560"> </a>
<a name="ln561">    // rebuild multi-priority</a>
<a name="ln562">    if(!duplicate) dt_history_rebuild_multi_priority_merge(newimgid);</a>
<a name="ln563"> </a>
<a name="ln564">    /* copy the style items into the history */</a>
<a name="ln565">    DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln566">                                &quot;INSERT INTO main.history &quot;</a>
<a name="ln567">                                &quot;(imgid,num,module,operation,op_params,enabled,blendop_params,blendop_&quot;</a>
<a name="ln568">                                &quot;version,multi_priority,multi_name) SELECT &quot;</a>
<a name="ln569">                                &quot;?1,?2+rowid,module,operation,op_params,enabled,blendop_params,blendop_&quot;</a>
<a name="ln570">                                &quot;version,multi_priority,multi_name FROM memory.style_items&quot;,</a>
<a name="ln571">                                -1, &amp;stmt, NULL);</a>
<a name="ln572">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, newimgid);</a>
<a name="ln573">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 2, offs);</a>
<a name="ln574">    sqlite3_step(stmt);</a>
<a name="ln575">    sqlite3_finalize(stmt);</a>
<a name="ln576"> </a>
<a name="ln577">    /* always make the whole stack active */</a>
<a name="ln578">    DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln579">                                &quot;UPDATE main.images SET history_end = (SELECT MAX(num) + 1 FROM main.history &quot;</a>
<a name="ln580">                                &quot;WHERE imgid = ?1) WHERE id = ?1&quot;,</a>
<a name="ln581">                                -1, &amp;stmt, NULL);</a>
<a name="ln582">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, newimgid);</a>
<a name="ln583">    sqlite3_step(stmt);</a>
<a name="ln584">    sqlite3_finalize(stmt);</a>
<a name="ln585"> </a>
<a name="ln586">    /* add tag */</a>
<a name="ln587">    guint tagid = 0;</a>
<a name="ln588">    gchar ntag[512] = { 0 };</a>
<a name="ln589">    g_snprintf(ntag, sizeof(ntag), &quot;darktable|style|%s&quot;, name);</a>
<a name="ln590">    if(dt_tag_new(ntag, &amp;tagid)) dt_tag_attach(tagid, newimgid);</a>
<a name="ln591">    if(dt_tag_new(&quot;darktable|changed&quot;, &amp;tagid)) dt_tag_attach(tagid, newimgid);</a>
<a name="ln592"> </a>
<a name="ln593">    /* if current image in develop reload history */</a>
<a name="ln594">    if(dt_dev_is_current_image(darktable.develop, newimgid))</a>
<a name="ln595">    {</a>
<a name="ln596">      dt_dev_reload_history_items(darktable.develop);</a>
<a name="ln597">      dt_dev_modulegroups_set(darktable.develop, dt_dev_modulegroups_get(darktable.develop));</a>
<a name="ln598">    }</a>
<a name="ln599"> </a>
<a name="ln600">    /* update xmp file */</a>
<a name="ln601">    dt_image_synch_xmp(newimgid);</a>
<a name="ln602"> </a>
<a name="ln603">    /* remove old obsolete thumbnails */</a>
<a name="ln604">    dt_mipmap_cache_remove(darktable.mipmap_cache, newimgid);</a>
<a name="ln605"> </a>
<a name="ln606">    /* if we have created a duplicate, reset collected images */</a>
<a name="ln607">    if(duplicate) dt_control_signal_raise(darktable.signals, DT_SIGNAL_COLLECTION_CHANGED);</a>
<a name="ln608"> </a>
<a name="ln609">    /* redraw center view to update visible mipmaps */</a>
<a name="ln610">    dt_control_queue_redraw_center();</a>
<a name="ln611">  }</a>
<a name="ln612">}</a>
<a name="ln613"> </a>
<a name="ln614">void dt_styles_delete_by_name(const char *name)</a>
<a name="ln615">{</a>
<a name="ln616">  int id = 0;</a>
<a name="ln617">  if((id = dt_styles_get_id_by_name(name)) != 0)</a>
<a name="ln618">  {</a>
<a name="ln619">    /* delete the style */</a>
<a name="ln620">    sqlite3_stmt *stmt;</a>
<a name="ln621">    DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), &quot;DELETE FROM data.styles WHERE id = ?1&quot;, -1, &amp;stmt,</a>
<a name="ln622">                                NULL);</a>
<a name="ln623">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, id);</a>
<a name="ln624">    sqlite3_step(stmt);</a>
<a name="ln625">    sqlite3_finalize(stmt);</a>
<a name="ln626"> </a>
<a name="ln627">    /* delete style_items belonging to style */</a>
<a name="ln628">    DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), &quot;DELETE FROM data.style_items WHERE styleid = ?1&quot;,</a>
<a name="ln629">                                -1, &amp;stmt, NULL);</a>
<a name="ln630">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, id);</a>
<a name="ln631">    sqlite3_step(stmt);</a>
<a name="ln632">    sqlite3_finalize(stmt);</a>
<a name="ln633"> </a>
<a name="ln634">    char tmp_accel[1024];</a>
<a name="ln635">    snprintf(tmp_accel, sizeof(tmp_accel), C_(&quot;accel&quot;, &quot;styles/apply %s&quot;), name);</a>
<a name="ln636">    dt_accel_deregister_global(tmp_accel);</a>
<a name="ln637">    dt_control_signal_raise(darktable.signals, DT_SIGNAL_STYLE_CHANGED);</a>
<a name="ln638">  }</a>
<a name="ln639">}</a>
<a name="ln640"> </a>
<a name="ln641">GList *dt_styles_get_item_list(const char *name, gboolean params, int imgid)</a>
<a name="ln642">{</a>
<a name="ln643">  GList *result = NULL;</a>
<a name="ln644">  sqlite3_stmt *stmt;</a>
<a name="ln645">  int id = 0;</a>
<a name="ln646">  if((id = dt_styles_get_id_by_name(name)) != 0)</a>
<a name="ln647">  {</a>
<a name="ln648">    if(params)</a>
<a name="ln649">      DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln650">                                  &quot;SELECT num, multi_priority, module, operation, enabled, op_params, blendop_params, &quot;</a>
<a name="ln651">                                  &quot;multi_name FROM data.style_items WHERE styleid=?1 ORDER BY num DESC&quot;,</a>
<a name="ln652">                                  -1, &amp;stmt, NULL);</a>
<a name="ln653">    else if(imgid != -1)</a>
<a name="ln654">    {</a>
<a name="ln655">      // get all items from the style</a>
<a name="ln656">      //    UNION</a>
<a name="ln657">      // get all items from history, not in the style : select only the last operation, that is max(num)</a>
<a name="ln658">      DT_DEBUG_SQLITE3_PREPARE_V2(</a>
<a name="ln659">          dt_database_get(darktable.db),</a>
<a name="ln660">          &quot;SELECT num, multi_priority, module, operation, enabled, (SELECT MAX(num) FROM main.history WHERE imgid=?2 &quot;</a>
<a name="ln661">          &quot;AND operation=data.style_items.operation GROUP BY multi_priority),multi_name FROM data.style_items WHERE &quot;</a>
<a name="ln662">          &quot;styleid=?1 UNION SELECT -1,main.history.multi_priority,main.history.module,main.history.operation,main.history.enabled, &quot;</a>
<a name="ln663">          &quot;main.history.num,multi_name FROM main.history WHERE imgid=?2 AND main.history.enabled=1 AND &quot;</a>
<a name="ln664">          &quot;(main.history.operation NOT IN (SELECT operation FROM data.style_items WHERE styleid=?1) OR &quot;</a>
<a name="ln665">          &quot;(main.history.op_params NOT IN (SELECT op_params FROM data.style_items WHERE styleid=?1 AND &quot;</a>
<a name="ln666">          &quot;operation=main.history.operation)) OR (main.history.blendop_params NOT IN (SELECT blendop_params FROM &quot;</a>
<a name="ln667">          &quot;data.style_items WHERE styleid=?1 AND operation=main.history.operation))) GROUP BY operation HAVING &quot;</a>
<a name="ln668">          &quot;MAX(num) ORDER BY num DESC&quot;, -1, &amp;stmt, NULL);</a>
<a name="ln669">      DT_DEBUG_SQLITE3_BIND_INT(stmt, 2, imgid);</a>
<a name="ln670">    }</a>
<a name="ln671">    else</a>
<a name="ln672">      DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), &quot;SELECT num, multi_priority, module, operation, &quot;</a>
<a name="ln673">                                                                 &quot;enabled, 0, multi_name FROM data.style_items WHERE &quot;</a>
<a name="ln674">                                                                 &quot;styleid=?1 ORDER BY num DESC&quot;,</a>
<a name="ln675">                                  -1, &amp;stmt, NULL);</a>
<a name="ln676"> </a>
<a name="ln677">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, id);</a>
<a name="ln678">    while(sqlite3_step(stmt) == SQLITE_ROW)</a>
<a name="ln679">    {</a>
<a name="ln680">      // name of current item of style</a>
<a name="ln681">      char iname[512] = { 0 };</a>
<a name="ln682">      dt_style_item_t *item = calloc(1, sizeof(dt_style_item_t));</a>
<a name="ln683"> </a>
<a name="ln684">      if(sqlite3_column_type(stmt, 0) == SQLITE_NULL)</a>
<a name="ln685">        item-&gt;num = -1;</a>
<a name="ln686">      else</a>
<a name="ln687">        item-&gt;num = sqlite3_column_int(stmt, 0);</a>
<a name="ln688"> </a>
<a name="ln689">      item-&gt;multi_priority = sqlite3_column_int(stmt, 1);</a>
<a name="ln690"> </a>
<a name="ln691">      item-&gt;selimg_num = -1;</a>
<a name="ln692">      item-&gt;module_version = sqlite3_column_int(stmt, 2);</a>
<a name="ln693"> </a>
<a name="ln694">      item-&gt;enabled = sqlite3_column_int(stmt, 4);</a>
<a name="ln695"> </a>
<a name="ln696">      if(params)</a>
<a name="ln697">      {</a>
<a name="ln698">        // when we get the parameters we do not want to get the operation localized as this</a>
<a name="ln699">        // is used to compare against the internal module name.</a>
<a name="ln700">        const char *multi_name = (const char *)sqlite3_column_text(stmt, 7);</a>
<a name="ln701"> </a>
<a name="ln702">        if(!(multi_name &amp;&amp; *multi_name))</a>
<a name="ln703">          g_snprintf(iname, sizeof(iname), &quot;%s&quot;, sqlite3_column_text(stmt, 3));</a>
<a name="ln704">        else</a>
<a name="ln705">          g_snprintf(iname, sizeof(iname), &quot;%s %s&quot;, sqlite3_column_text(stmt, 3), multi_name);</a>
<a name="ln706"> </a>
<a name="ln707">        const unsigned char *op_blob = sqlite3_column_blob(stmt, 5);</a>
<a name="ln708">        const int32_t op_len = sqlite3_column_bytes(stmt, 5);</a>
<a name="ln709">        const unsigned char *bop_blob = sqlite3_column_blob(stmt, 6);</a>
<a name="ln710">        const int32_t bop_len = sqlite3_column_bytes(stmt, 6);</a>
<a name="ln711"> </a>
<a name="ln712">        item-&gt;params = malloc(op_len);</a>
<a name="ln713">        memcpy(item-&gt;params, op_blob, op_len);</a>
<a name="ln714"> </a>
<a name="ln715">        item-&gt;blendop_params = malloc(bop_len);</a>
<a name="ln716">        memcpy(item-&gt;blendop_params, bop_blob, bop_len);</a>
<a name="ln717">      }</a>
<a name="ln718">      else</a>
<a name="ln719">      {</a>
<a name="ln720">        const char *multi_name = (const char *)sqlite3_column_text(stmt, 6);</a>
<a name="ln721">        gboolean has_multi_name = FALSE;</a>
<a name="ln722"> </a>
<a name="ln723">        if(multi_name &amp;&amp; *multi_name &amp;&amp; strcmp(multi_name, &quot;0&quot;) != 0) has_multi_name = TRUE;</a>
<a name="ln724"> </a>
<a name="ln725">        if(has_multi_name)</a>
<a name="ln726">          g_snprintf(iname, sizeof(iname), &quot;%s %s (%s)&quot;,</a>
<a name="ln727">                     dt_iop_get_localized_name((gchar *)sqlite3_column_text(stmt, 3)), multi_name,</a>
<a name="ln728">                     (sqlite3_column_int(stmt, 4) != 0) ? _(&quot;on&quot;) : _(&quot;off&quot;));</a>
<a name="ln729">        else</a>
<a name="ln730">          g_snprintf(iname, sizeof(iname), &quot;%s (%s)&quot;,</a>
<a name="ln731">                     dt_iop_get_localized_name((gchar *)sqlite3_column_text(stmt, 3)),</a>
<a name="ln732">                     (sqlite3_column_int(stmt, 4) != 0) ? _(&quot;on&quot;) : _(&quot;off&quot;));</a>
<a name="ln733"> </a>
<a name="ln734">        item-&gt;params = NULL;</a>
<a name="ln735">        item-&gt;blendop_params = NULL;</a>
<a name="ln736">        if(imgid != -1 &amp;&amp; sqlite3_column_type(stmt, 5) != SQLITE_NULL)</a>
<a name="ln737">          item-&gt;selimg_num = sqlite3_column_int(stmt, 5);</a>
<a name="ln738">      }</a>
<a name="ln739">      item-&gt;name = g_strdup(iname);</a>
<a name="ln740">      item-&gt;operation = g_strdup((char *)sqlite3_column_text(stmt, 3));</a>
<a name="ln741">      result = g_list_append(result, item);</a>
<a name="ln742">    }</a>
<a name="ln743">    sqlite3_finalize(stmt);</a>
<a name="ln744">  }</a>
<a name="ln745">  return result;</a>
<a name="ln746">}</a>
<a name="ln747"> </a>
<a name="ln748">char *dt_styles_get_item_list_as_string(const char *name)</a>
<a name="ln749">{</a>
<a name="ln750">  GList *items = dt_styles_get_item_list(name, FALSE, -1);</a>
<a name="ln751">  if(items == NULL) return NULL;</a>
<a name="ln752"> </a>
<a name="ln753">  GList *names = NULL;</a>
<a name="ln754">  do</a>
<a name="ln755">  {</a>
<a name="ln756">    dt_style_item_t *item = (dt_style_item_t *)items-&gt;data;</a>
<a name="ln757">    names = g_list_append(names, g_strdup(item-&gt;name));</a>
<a name="ln758">  } while((items = g_list_next(items)));</a>
<a name="ln759"> </a>
<a name="ln760">  char *result = dt_util_glist_to_str(&quot;\n&quot;, names);</a>
<a name="ln761">  g_list_free_full(names, g_free);</a>
<a name="ln762">  g_list_free_full(items, dt_style_item_free);</a>
<a name="ln763">  return result;</a>
<a name="ln764">}</a>
<a name="ln765"> </a>
<a name="ln766">GList *dt_styles_get_list(const char *filter)</a>
<a name="ln767">{</a>
<a name="ln768">  char filterstring[512] = { 0 };</a>
<a name="ln769">  sqlite3_stmt *stmt;</a>
<a name="ln770">  snprintf(filterstring, sizeof(filterstring), &quot;%%%s%%&quot;, filter);</a>
<a name="ln771">  DT_DEBUG_SQLITE3_PREPARE_V2(</a>
<a name="ln772">      dt_database_get(darktable.db),</a>
<a name="ln773">      &quot;SELECT name, description FROM data.styles WHERE name LIKE ?1 OR description LIKE ?1 ORDER BY name&quot;, -1,</a>
<a name="ln774">      &amp;stmt, NULL);</a>
<a name="ln775">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 1, filterstring, -1, SQLITE_TRANSIENT);</a>
<a name="ln776">  GList *result = NULL;</a>
<a name="ln777">  while(sqlite3_step(stmt) == SQLITE_ROW)</a>
<a name="ln778">  {</a>
<a name="ln779">    const char *name = (const char *)sqlite3_column_text(stmt, 0);</a>
<a name="ln780">    const char *description = (const char *)sqlite3_column_text(stmt, 1);</a>
<a name="ln781">    dt_style_t *s = g_malloc(sizeof(dt_style_t));</a>
<a name="ln782">    s-&gt;name = g_strdup(name);</a>
<a name="ln783">    s-&gt;description = g_strdup(description);</a>
<a name="ln784">    result = g_list_append(result, s);</a>
<a name="ln785">  }</a>
<a name="ln786">  sqlite3_finalize(stmt);</a>
<a name="ln787">  return result;</a>
<a name="ln788">}</a>
<a name="ln789"> </a>
<a name="ln790">static char *dt_style_encode(sqlite3_stmt *stmt, int row)</a>
<a name="ln791">{</a>
<a name="ln792">  const int32_t len = sqlite3_column_bytes(stmt, row);</a>
<a name="ln793">  char *vparams = dt_exif_xmp_encode((const unsigned char *)sqlite3_column_blob(stmt, row), len, NULL);</a>
<a name="ln794">  return vparams;</a>
<a name="ln795">}</a>
<a name="ln796"> </a>
<a name="ln797">void dt_styles_save_to_file(const char *style_name, const char *filedir, gboolean overwrite)</a>
<a name="ln798">{</a>
<a name="ln799">  int rc = 0;</a>
<a name="ln800">  char stylename[520];</a>
<a name="ln801">  sqlite3_stmt *stmt;</a>
<a name="ln802"> </a>
<a name="ln803">  // generate filename based on name of style</a>
<a name="ln804">  // convert all characters to underscore which are not allowed in filenames</a>
<a name="ln805">  char *filename = g_strdup(style_name);</a>
<a name="ln806">  snprintf(stylename, sizeof(stylename), &quot;%s/%s.dtstyle&quot;, filedir, g_strdelimit(filename, &quot;/&lt;&gt;:\&quot;\\|*?[]&quot;, '_'));</a>
<a name="ln807">  g_free(filename);</a>
<a name="ln808"> </a>
<a name="ln809">  // check if file exists</a>
<a name="ln810">  if(g_file_test(stylename, G_FILE_TEST_EXISTS) == TRUE)</a>
<a name="ln811">  {</a>
<a name="ln812">    if(overwrite)</a>
<a name="ln813">    {</a>
<a name="ln814">      if(g_unlink(stylename))</a>
<a name="ln815">      {</a>
<a name="ln816">        dt_control_log(_(&quot;failed to overwrite style file for %s&quot;), style_name);</a>
<a name="ln817">        return;</a>
<a name="ln818">      }</a>
<a name="ln819">    }</a>
<a name="ln820">    else</a>
<a name="ln821">    {</a>
<a name="ln822">      dt_control_log(_(&quot;style file for %s exists&quot;), style_name);</a>
<a name="ln823">      return;</a>
<a name="ln824">    }</a>
<a name="ln825">  }</a>
<a name="ln826"> </a>
<a name="ln827">  if(!dt_styles_exists(style_name)) return;</a>
<a name="ln828"> </a>
<a name="ln829">  xmlTextWriterPtr writer = xmlNewTextWriterFilename(stylename, 0);</a>
<a name="ln830">  if(writer == NULL)</a>
<a name="ln831">  {</a>
<a name="ln832">    fprintf(stderr, &quot;[dt_styles_save_to_file] Error creating the xml writer\n, path: %s&quot;, stylename);</a>
<a name="ln833">    return;</a>
<a name="ln834">  }</a>
<a name="ln835">  rc = xmlTextWriterStartDocument(writer, NULL, &quot;UTF-8&quot;, NULL);</a>
<a name="ln836">  if(rc &lt; 0)</a>
<a name="ln837">  {</a>
<a name="ln838">    fprintf(stderr, &quot;[dt_styles_save_to_file]: Error on encoding setting&quot;);</a>
<a name="ln839">    return;</a>
<a name="ln840">  }</a>
<a name="ln841">  xmlTextWriterStartElement(writer, BAD_CAST &quot;darktable_style&quot;);</a>
<a name="ln842">  xmlTextWriterWriteAttribute(writer, BAD_CAST &quot;version&quot;, BAD_CAST &quot;1.0&quot;);</a>
<a name="ln843"> </a>
<a name="ln844">  xmlTextWriterStartElement(writer, BAD_CAST &quot;info&quot;);</a>
<a name="ln845">  xmlTextWriterWriteFormatElement(writer, BAD_CAST &quot;name&quot;, &quot;%s&quot;, style_name);</a>
<a name="ln846">  xmlTextWriterWriteFormatElement(writer, BAD_CAST &quot;description&quot;, &quot;%s&quot;, dt_styles_get_description(style_name));</a>
<a name="ln847">  xmlTextWriterEndElement(writer);</a>
<a name="ln848"> </a>
<a name="ln849">  xmlTextWriterStartElement(writer, BAD_CAST &quot;style&quot;);</a>
<a name="ln850">  DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), &quot;SELECT num,module,operation,op_params,enabled,&quot;</a>
<a name="ln851">                                                             &quot;blendop_params,blendop_version,multi_priority,&quot;</a>
<a name="ln852">                                                             &quot;multi_name FROM data.style_items WHERE styleid =?1&quot;,</a>
<a name="ln853">                              -1, &amp;stmt, NULL);</a>
<a name="ln854">  DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, dt_styles_get_id_by_name(style_name));</a>
<a name="ln855">  while(sqlite3_step(stmt) == SQLITE_ROW)</a>
<a name="ln856">  {</a>
<a name="ln857">    xmlTextWriterStartElement(writer, BAD_CAST &quot;plugin&quot;);</a>
<a name="ln858">    xmlTextWriterWriteFormatElement(writer, BAD_CAST &quot;num&quot;, &quot;%d&quot;, sqlite3_column_int(stmt, 0));</a>
<a name="ln859">    xmlTextWriterWriteFormatElement(writer, BAD_CAST &quot;module&quot;, &quot;%d&quot;, sqlite3_column_int(stmt, 1));</a>
<a name="ln860">    xmlTextWriterWriteFormatElement(writer, BAD_CAST &quot;operation&quot;, &quot;%s&quot;, sqlite3_column_text(stmt, 2));</a>
<a name="ln861">    xmlTextWriterWriteFormatElement(writer, BAD_CAST &quot;op_params&quot;, &quot;%s&quot;, dt_style_encode(stmt, 3));</a>
<a name="ln862">    xmlTextWriterWriteFormatElement(writer, BAD_CAST &quot;enabled&quot;, &quot;%d&quot;, sqlite3_column_int(stmt, 4));</a>
<a name="ln863">    xmlTextWriterWriteFormatElement(writer, BAD_CAST &quot;blendop_params&quot;, &quot;%s&quot;, dt_style_encode(stmt, 5));</a>
<a name="ln864">    xmlTextWriterWriteFormatElement(writer, BAD_CAST &quot;blendop_version&quot;, &quot;%d&quot;, sqlite3_column_int(stmt, 6));</a>
<a name="ln865">    xmlTextWriterWriteFormatElement(writer, BAD_CAST &quot;multi_priority&quot;, &quot;%d&quot;, sqlite3_column_int(stmt, 7));</a>
<a name="ln866">    xmlTextWriterWriteFormatElement(writer, BAD_CAST &quot;multi_name&quot;, &quot;%s&quot;, sqlite3_column_text(stmt, 8));</a>
<a name="ln867">    xmlTextWriterEndElement(writer);</a>
<a name="ln868">  }</a>
<a name="ln869">  sqlite3_finalize(stmt);</a>
<a name="ln870">  xmlTextWriterEndDocument(writer);</a>
<a name="ln871">  xmlFreeTextWriter(writer);</a>
<a name="ln872">}</a>
<a name="ln873"> </a>
<a name="ln874">static StyleData *dt_styles_style_data_new()</a>
<a name="ln875">{</a>
<a name="ln876">  StyleInfoData *info = g_new0(StyleInfoData, 1);</a>
<a name="ln877">  info-&gt;name = g_string_new(&quot;&quot;);</a>
<a name="ln878">  info-&gt;description = g_string_new(&quot;&quot;);</a>
<a name="ln879"> </a>
<a name="ln880">  StyleData *data = g_new0(StyleData, 1);</a>
<a name="ln881">  data-&gt;info = info;</a>
<a name="ln882">  data-&gt;in_plugin = FALSE;</a>
<a name="ln883">  data-&gt;plugins = NULL;</a>
<a name="ln884"> </a>
<a name="ln885">  return data;</a>
<a name="ln886">}</a>
<a name="ln887"> </a>
<a name="ln888">static StylePluginData *dt_styles_style_plugin_new()</a>
<a name="ln889">{</a>
<a name="ln890">  StylePluginData *plugin = g_new0(StylePluginData, 1);</a>
<a name="ln891">  plugin-&gt;operation = g_string_new(&quot;&quot;);</a>
<a name="ln892">  plugin-&gt;op_params = g_string_new(&quot;&quot;);</a>
<a name="ln893">  plugin-&gt;blendop_params = g_string_new(&quot;&quot;);</a>
<a name="ln894">  plugin-&gt;multi_name = g_string_new(&quot;&quot;);</a>
<a name="ln895">  return plugin;</a>
<a name="ln896">}</a>
<a name="ln897"> </a>
<a name="ln898">static void dt_styles_style_data_free(StyleData *style, gboolean free_segments)</a>
<a name="ln899">{</a>
<a name="ln900">  g_string_free(style-&gt;info-&gt;name, free_segments);</a>
<a name="ln901">  g_string_free(style-&gt;info-&gt;description, free_segments);</a>
<a name="ln902">  g_list_free(style-&gt;plugins);</a>
<a name="ln903">  g_free(style);</a>
<a name="ln904">}</a>
<a name="ln905"> </a>
<a name="ln906">static void dt_styles_start_tag_handler(GMarkupParseContext *context, const gchar *element_name,</a>
<a name="ln907">                                        const gchar **attribute_names, const gchar **attribute_values,</a>
<a name="ln908">                                        gpointer user_data, GError **error)</a>
<a name="ln909">{</a>
<a name="ln910">  StyleData *style = user_data;</a>
<a name="ln911">  const gchar *elt = g_markup_parse_context_get_element(context);</a>
<a name="ln912"> </a>
<a name="ln913">  // We need to append the contents of any subtags to the content field</a>
<a name="ln914">  // for this we need to know when we are inside the note-content tag</a>
<a name="ln915">  if(g_ascii_strcasecmp(elt, &quot;plugin&quot;) == 0)</a>
<a name="ln916">  {</a>
<a name="ln917">    style-&gt;in_plugin = TRUE;</a>
<a name="ln918">    style-&gt;plugins = g_list_prepend(style-&gt;plugins, dt_styles_style_plugin_new());</a>
<a name="ln919">  }</a>
<a name="ln920">}</a>
<a name="ln921"> </a>
<a name="ln922">static void dt_styles_end_tag_handler(GMarkupParseContext *context, const gchar *element_name,</a>
<a name="ln923">                                      gpointer user_data, GError **error)</a>
<a name="ln924">{</a>
<a name="ln925">  StyleData *style = user_data;</a>
<a name="ln926">  const gchar *elt = g_markup_parse_context_get_element(context);</a>
<a name="ln927"> </a>
<a name="ln928">  // We need to append the contents of any subtags to the content field</a>
<a name="ln929">  // for this we need to know when we are inside the note-content tag</a>
<a name="ln930">  if(g_ascii_strcasecmp(elt, &quot;plugin&quot;) == 0)</a>
<a name="ln931">  {</a>
<a name="ln932">    style-&gt;in_plugin = FALSE;</a>
<a name="ln933">  }</a>
<a name="ln934">}</a>
<a name="ln935"> </a>
<a name="ln936">static void dt_styles_style_text_handler(GMarkupParseContext *context, const gchar *text, gsize text_len,</a>
<a name="ln937">                                         gpointer user_data, GError **error)</a>
<a name="ln938">{</a>
<a name="ln939"> </a>
<a name="ln940">  StyleData *style = user_data;</a>
<a name="ln941">  const gchar *elt = g_markup_parse_context_get_element(context);</a>
<a name="ln942"> </a>
<a name="ln943">  if(g_ascii_strcasecmp(elt, &quot;name&quot;) == 0)</a>
<a name="ln944">  {</a>
<a name="ln945">    g_string_append_len(style-&gt;info-&gt;name, text, text_len);</a>
<a name="ln946">  }</a>
<a name="ln947">  else if(g_ascii_strcasecmp(elt, &quot;description&quot;) == 0)</a>
<a name="ln948">  {</a>
<a name="ln949">    g_string_append_len(style-&gt;info-&gt;description, text, text_len);</a>
<a name="ln950">  }</a>
<a name="ln951">  else if(style-&gt;in_plugin)</a>
<a name="ln952">  {</a>
<a name="ln953">    StylePluginData *plug = g_list_first(style-&gt;plugins)-&gt;data;</a>
<a name="ln954">    if(g_ascii_strcasecmp(elt, &quot;operation&quot;) == 0)</a>
<a name="ln955">    {</a>
<a name="ln956">      g_string_append_len(plug-&gt;operation, text, text_len);</a>
<a name="ln957">    }</a>
<a name="ln958">    else if(g_ascii_strcasecmp(elt, &quot;op_params&quot;) == 0)</a>
<a name="ln959">    {</a>
<a name="ln960">      g_string_append_len(plug-&gt;op_params, text, text_len);</a>
<a name="ln961">    }</a>
<a name="ln962">    else if(g_ascii_strcasecmp(elt, &quot;blendop_params&quot;) == 0)</a>
<a name="ln963">    {</a>
<a name="ln964">      g_string_append_len(plug-&gt;blendop_params, text, text_len);</a>
<a name="ln965">    }</a>
<a name="ln966">    else if(g_ascii_strcasecmp(elt, &quot;blendop_version&quot;) == 0)</a>
<a name="ln967">    {</a>
<a name="ln968">      plug-&gt;blendop_version = atoi(text);</a>
<a name="ln969">    }</a>
<a name="ln970">    else if(g_ascii_strcasecmp(elt, &quot;multi_priority&quot;) == 0)</a>
<a name="ln971">    {</a>
<a name="ln972">      plug-&gt;multi_priority = atoi(text);</a>
<a name="ln973">    }</a>
<a name="ln974">    else if(g_ascii_strcasecmp(elt, &quot;multi_name&quot;) == 0)</a>
<a name="ln975">    {</a>
<a name="ln976">      g_string_append_len(plug-&gt;multi_name, text, text_len);</a>
<a name="ln977">    }</a>
<a name="ln978">    else if(g_ascii_strcasecmp(elt, &quot;num&quot;) == 0)</a>
<a name="ln979">    {</a>
<a name="ln980">      plug-&gt;num = atoi(text);</a>
<a name="ln981">    }</a>
<a name="ln982">    else if(g_ascii_strcasecmp(elt, &quot;module&quot;) == 0)</a>
<a name="ln983">    {</a>
<a name="ln984">      plug-&gt;module = atoi(text);</a>
<a name="ln985">    }</a>
<a name="ln986">    else if(g_ascii_strcasecmp(elt, &quot;enabled&quot;) == 0)</a>
<a name="ln987">    {</a>
<a name="ln988">      plug-&gt;enabled = atoi(text);</a>
<a name="ln989">    }</a>
<a name="ln990">  }</a>
<a name="ln991">}</a>
<a name="ln992"> </a>
<a name="ln993">static GMarkupParser dt_style_parser = {</a>
<a name="ln994">  dt_styles_start_tag_handler,  // Start element handler</a>
<a name="ln995">  dt_styles_end_tag_handler,    // End element handler</a>
<a name="ln996">  dt_styles_style_text_handler, // Text element handler</a>
<a name="ln997">  NULL,                         // Passthrough handler</a>
<a name="ln998">  NULL                          // Error handler</a>
<a name="ln999">};</a>
<a name="ln1000"> </a>
<a name="ln1001">static void dt_style_plugin_save(StylePluginData *plugin, gpointer styleId)</a>
<a name="ln1002">{</a>
<a name="ln1003">  int id = GPOINTER_TO_INT(styleId);</a>
<a name="ln1004">  sqlite3_stmt *stmt;</a>
<a name="ln1005">  DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln1006">                              &quot;INSERT INTO data.style_items &quot;</a>
<a name="ln1007">                              &quot;(styleid,num,module,operation,op_params,enabled,blendop_params,blendop_&quot;</a>
<a name="ln1008">                              &quot;version,multi_priority,multi_name) VALUES (?1,?2,?3,?4,?5,?6,?7,?8,?9,?10)&quot;,</a>
<a name="ln1009">                              -1, &amp;stmt, NULL);</a>
<a name="ln1010">  DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, id);</a>
<a name="ln1011">  DT_DEBUG_SQLITE3_BIND_INT(stmt, 2, plugin-&gt;num);</a>
<a name="ln1012">  DT_DEBUG_SQLITE3_BIND_INT(stmt, 3, plugin-&gt;module);</a>
<a name="ln1013">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 4, plugin-&gt;operation-&gt;str, plugin-&gt;operation-&gt;len, SQLITE_TRANSIENT);</a>
<a name="ln1014">  //</a>
<a name="ln1015">  const char *param_c = plugin-&gt;op_params-&gt;str;</a>
<a name="ln1016">  const int param_c_len = strlen(param_c);</a>
<a name="ln1017">  int params_len = 0;</a>
<a name="ln1018">  unsigned char *params = dt_exif_xmp_decode(param_c, param_c_len, &amp;params_len);</a>
<a name="ln1019">  DT_DEBUG_SQLITE3_BIND_BLOB(stmt, 5, params, params_len, SQLITE_TRANSIENT);</a>
<a name="ln1020">  //</a>
<a name="ln1021">  DT_DEBUG_SQLITE3_BIND_INT(stmt, 6, plugin-&gt;enabled);</a>
<a name="ln1022"> </a>
<a name="ln1023">  /* decode and store blendop params */</a>
<a name="ln1024">  int blendop_params_len = 0;</a>
<a name="ln1025">  unsigned char *blendop_params = dt_exif_xmp_decode(</a>
<a name="ln1026">      plugin-&gt;blendop_params-&gt;str, strlen(plugin-&gt;blendop_params-&gt;str), &amp;blendop_params_len);</a>
<a name="ln1027">  DT_DEBUG_SQLITE3_BIND_BLOB(stmt, 7, blendop_params, blendop_params_len, SQLITE_TRANSIENT);</a>
<a name="ln1028"> </a>
<a name="ln1029">  DT_DEBUG_SQLITE3_BIND_INT(stmt, 8, plugin-&gt;blendop_version);</a>
<a name="ln1030"> </a>
<a name="ln1031">  DT_DEBUG_SQLITE3_BIND_INT(stmt, 9, plugin-&gt;multi_priority);</a>
<a name="ln1032">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 10, plugin-&gt;multi_name-&gt;str, plugin-&gt;multi_name-&gt;len, SQLITE_TRANSIENT);</a>
<a name="ln1033"> </a>
<a name="ln1034">  sqlite3_step(stmt);</a>
<a name="ln1035">  sqlite3_finalize(stmt);</a>
<a name="ln1036">  free(params);</a>
<a name="ln1037">}</a>
<a name="ln1038"> </a>
<a name="ln1039">static void dt_style_save(StyleData *style)</a>
<a name="ln1040">{</a>
<a name="ln1041">  int id = 0;</a>
<a name="ln1042">  if(style == NULL) return;</a>
<a name="ln1043"> </a>
<a name="ln1044">  /* first create the style header */</a>
<a name="ln1045">  if(!dt_styles_create_style_header(style-&gt;info-&gt;name-&gt;str, style-&gt;info-&gt;description-&gt;str)) return;</a>
<a name="ln1046"> </a>
<a name="ln1047">  if((id = dt_styles_get_id_by_name(style-&gt;info-&gt;name-&gt;str)) != 0)</a>
<a name="ln1048">  {</a>
<a name="ln1049">    g_list_foreach(style-&gt;plugins, (GFunc)dt_style_plugin_save, GINT_TO_POINTER(id));</a>
<a name="ln1050">    dt_control_log(_(&quot;style %s was successfully imported&quot;), style-&gt;info-&gt;name-&gt;str);</a>
<a name="ln1051">  }</a>
<a name="ln1052">}</a>
<a name="ln1053"> </a>
<a name="ln1054">void dt_styles_import_from_file(const char *style_path)</a>
<a name="ln1055">{</a>
<a name="ln1056">  FILE *style_file;</a>
<a name="ln1057">  StyleData *style;</a>
<a name="ln1058">  GMarkupParseContext *parser;</a>
<a name="ln1059">  gchar buf[1024];</a>
<a name="ln1060">  size_t num_read;</a>
<a name="ln1061"> </a>
<a name="ln1062">  style = dt_styles_style_data_new();</a>
<a name="ln1063">  parser = g_markup_parse_context_new(&amp;dt_style_parser, 0, style, NULL);</a>
<a name="ln1064"> </a>
<a name="ln1065">  if((style_file = g_fopen(style_path, &quot;r&quot;)))</a>
<a name="ln1066">  {</a>
<a name="ln1067"> </a>
<a name="ln1068">    while(!feof(style_file))</a>
<a name="ln1069">    {</a>
<a name="ln1070">      num_read = fread(buf, sizeof(gchar), sizeof(buf), style_file);</a>
<a name="ln1071"> </a>
<a name="ln1072">      if(num_read == 0)</a>
<a name="ln1073">      {</a>
<a name="ln1074">        break;</a>
<a name="ln1075">      }</a>
<a name="ln1076">      else if(num_read == -1)</a>
<a name="ln1077">      {</a>
<a name="ln1078">        // FIXME: ferror?</a>
<a name="ln1079">        // ERROR !</a>
<a name="ln1080">        break;</a>
<a name="ln1081">      }</a>
<a name="ln1082"> </a>
<a name="ln1083">      if(!g_markup_parse_context_parse(parser, buf, num_read, NULL))</a>
<a name="ln1084">      {</a>
<a name="ln1085">        g_markup_parse_context_free(parser);</a>
<a name="ln1086">        dt_styles_style_data_free(style, TRUE);</a>
<a name="ln1087">        fclose(style_file);</a>
<a name="ln1088">        return;</a>
<a name="ln1089">      }</a>
<a name="ln1090">    }</a>
<a name="ln1091">  }</a>
<a name="ln1092">  else</a>
<a name="ln1093">  {</a>
<a name="ln1094">    // Failed to open file, clean up.</a>
<a name="ln1095">    g_markup_parse_context_free(parser);</a>
<a name="ln1096">    dt_styles_style_data_free(style, TRUE);</a>
<a name="ln1097">    return;</a>
<a name="ln1098">  }</a>
<a name="ln1099"> </a>
<a name="ln1100">  if(!g_markup_parse_context_end_parse(parser, NULL))</a>
<a name="ln1101">  {</a>
<a name="ln1102">    g_markup_parse_context_free(parser);</a>
<a name="ln1103">    dt_styles_style_data_free(style, TRUE);</a>
<a name="ln1104">    fclose(style_file);</a>
<a name="ln1105">    return;</a>
<a name="ln1106">  }</a>
<a name="ln1107">  g_markup_parse_context_free(parser);</a>
<a name="ln1108">  // save data</a>
<a name="ln1109">  dt_style_save(style);</a>
<a name="ln1110">  //</a>
<a name="ln1111">  dt_styles_style_data_free(style, TRUE);</a>
<a name="ln1112">  fclose(style_file);</a>
<a name="ln1113"> </a>
<a name="ln1114">  dt_control_signal_raise(darktable.signals, DT_SIGNAL_STYLE_CHANGED);</a>
<a name="ln1115">}</a>
<a name="ln1116"> </a>
<a name="ln1117">gchar *dt_styles_get_description(const char *name)</a>
<a name="ln1118">{</a>
<a name="ln1119">  sqlite3_stmt *stmt;</a>
<a name="ln1120">  int id = 0;</a>
<a name="ln1121">  gchar *description = NULL;</a>
<a name="ln1122">  if((id = dt_styles_get_id_by_name(name)) != 0)</a>
<a name="ln1123">  {</a>
<a name="ln1124">    DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), &quot;SELECT description FROM data.styles WHERE id=?1&quot;,</a>
<a name="ln1125">                                -1, &amp;stmt, NULL);</a>
<a name="ln1126">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, id);</a>
<a name="ln1127">    sqlite3_step(stmt);</a>
<a name="ln1128">    description = (char *)sqlite3_column_text(stmt, 0);</a>
<a name="ln1129">    if(description) description = g_strdup(description);</a>
<a name="ln1130">    sqlite3_finalize(stmt);</a>
<a name="ln1131">  }</a>
<a name="ln1132">  return description;</a>
<a name="ln1133">}</a>
<a name="ln1134"> </a>
<a name="ln1135">static int32_t dt_styles_get_id_by_name(const char *name)</a>
<a name="ln1136">{</a>
<a name="ln1137">  int id = 0;</a>
<a name="ln1138">  sqlite3_stmt *stmt;</a>
<a name="ln1139">  DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln1140">                              &quot;SELECT id FROM data.styles WHERE name=?1 ORDER BY id DESC LIMIT 1&quot;, -1, &amp;stmt,</a>
<a name="ln1141">                              NULL);</a>
<a name="ln1142">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 1, name, -1, SQLITE_TRANSIENT);</a>
<a name="ln1143">  if(sqlite3_step(stmt) == SQLITE_ROW)</a>
<a name="ln1144">  {</a>
<a name="ln1145">    id = sqlite3_column_int(stmt, 0);</a>
<a name="ln1146">  }</a>
<a name="ln1147">  sqlite3_finalize(stmt);</a>
<a name="ln1148">  return id;</a>
<a name="ln1149">}</a>
<a name="ln1150"> </a>
<a name="ln1151">void init_styles_key_accels()</a>
<a name="ln1152">{</a>
<a name="ln1153">  GList *result = dt_styles_get_list(&quot;&quot;);</a>
<a name="ln1154">  if(result)</a>
<a name="ln1155">  {</a>
<a name="ln1156">    do</a>
<a name="ln1157">    {</a>
<a name="ln1158">      dt_style_t *style = (dt_style_t *)result-&gt;data;</a>
<a name="ln1159">      char tmp_accel[1024];</a>
<a name="ln1160">      snprintf(tmp_accel, sizeof(tmp_accel), C_(&quot;accel&quot;, &quot;styles/apply %s&quot;), style-&gt;name);</a>
<a name="ln1161">      dt_accel_register_global(tmp_accel, 0, 0);</a>
<a name="ln1162">    } while((result = g_list_next(result)) != NULL);</a>
<a name="ln1163">    g_list_free_full(result, dt_style_free);</a>
<a name="ln1164">  }</a>
<a name="ln1165">}</a>
<a name="ln1166"> </a>
<a name="ln1167">void connect_styles_key_accels()</a>
<a name="ln1168">{</a>
<a name="ln1169">  GList *result = dt_styles_get_list(&quot;&quot;);</a>
<a name="ln1170">  if(result)</a>
<a name="ln1171">  {</a>
<a name="ln1172">    do</a>
<a name="ln1173">    {</a>
<a name="ln1174">      GClosure *closure;</a>
<a name="ln1175">      dt_style_t *style = (dt_style_t *)result-&gt;data;</a>
<a name="ln1176">      closure = g_cclosure_new(G_CALLBACK(_apply_style_shortcut_callback), g_strdup(style-&gt;name),</a>
<a name="ln1177">                               _destroy_style_shortcut_callback);</a>
<a name="ln1178">      char tmp_accel[1024];</a>
<a name="ln1179">      snprintf(tmp_accel, sizeof(tmp_accel), C_(&quot;accel&quot;, &quot;styles/apply %s&quot;), style-&gt;name);</a>
<a name="ln1180">      dt_accel_connect_global(tmp_accel, closure);</a>
<a name="ln1181">    } while((result = g_list_next(result)) != NULL);</a>
<a name="ln1182">    g_list_free_full(result, dt_style_free);</a>
<a name="ln1183">  }</a>
<a name="ln1184">}</a>
<a name="ln1185"> </a>
<a name="ln1186">dt_style_t *dt_styles_get_by_name(const char *name)</a>
<a name="ln1187">{</a>
<a name="ln1188">  sqlite3_stmt *stmt;</a>
<a name="ln1189">  DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln1190">                              &quot;SELECT name, description FROM data.styles WHERE name = ?1&quot;, -1, &amp;stmt, NULL);</a>
<a name="ln1191">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 1, name, -1, SQLITE_STATIC);</a>
<a name="ln1192">  if(sqlite3_step(stmt) == SQLITE_ROW)</a>
<a name="ln1193">  {</a>
<a name="ln1194">    const char *style_name = (const char *)sqlite3_column_text(stmt, 0);</a>
<a name="ln1195">    const char *description = (const char *)sqlite3_column_text(stmt, 1);</a>
<a name="ln1196">    dt_style_t *s = g_malloc(sizeof(dt_style_t));</a>
<a name="ln1197">    s-&gt;name = g_strdup(style_name);</a>
<a name="ln1198">    s-&gt;description = g_strdup(description);</a>
<a name="ln1199">    sqlite3_finalize(stmt);</a>
<a name="ln1200">    return s;</a>
<a name="ln1201">  }</a>
<a name="ln1202">  else</a>
<a name="ln1203">  {</a>
<a name="ln1204"> </a>
<a name="ln1205">    sqlite3_finalize(stmt);</a>
<a name="ln1206">    return NULL;</a>
<a name="ln1207">  }</a>
<a name="ln1208">}</a>
<a name="ln1209">// modelines: These editor modelines have been set for all relevant files by tools/update_modelines.sh</a>
<a name="ln1210">// vim: shiftwidth=2 expandtab tabstop=2 cindent</a>
<a name="ln1211">// kate: tab-indents: off; indent-width 2; replace-tabs on; indent-mode cstyle; remove-trailing-spaces modified;</a>

</code></pre>
<div class="balloon" rel="150"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v522/" target="_blank">V522</a> There might be dereferencing of a potential null pointer 'd'. Check lines: 150, 139.</p></div>
<div class="balloon" rel="173"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v575/" target="_blank">V575</a> The null pointer is passed into 'g_list_free_full' function. Inspect the first argument.</p></div>
<div class="balloon" rel="685"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v522/" target="_blank">V522</a> There might be dereferencing of a potential null pointer 'item'. Check lines: 685, 682.</p></div>
<div class="balloon" rel="713"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v575/" target="_blank">V575</a> The potential null pointer is passed into 'memcpy' function. Inspect the first argument. Check lines: 713, 712.</p></div>
<div class="balloon" rel="716"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v575/" target="_blank">V575</a> The potential null pointer is passed into 'memcpy' function. Inspect the first argument. Check lines: 716, 715.</p></div>
<div class="balloon" rel="762"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v575/" target="_blank">V575</a> The null pointer is passed into 'g_list_free_full' function. Inspect the first argument.</p></div>
<div class="balloon" rel="1076"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v547/" target="_blank">V547</a> Expression 'num_read == - 1' is always false.</p></div>
<div class="balloon" rel="1163"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v575/" target="_blank">V575</a> The null pointer is passed into 'g_list_free_full' function. Inspect the first argument.</p></div>
<div class="balloon" rel="1182"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v575/" target="_blank">V575</a> The null pointer is passed into 'g_list_free_full' function. Inspect the first argument.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
