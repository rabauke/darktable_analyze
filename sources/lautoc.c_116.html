
<html>
<head>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>
<pre><code class = "cpp">
<a name="ln1">#include &quot;lautoc.h&quot;</a>
<a name="ln2"> </a>
<a name="ln3">void luaA_open(lua_State* L) {</a>
<a name="ln4"> </a>
<a name="ln5">  lua_pushinteger(L, 0); lua_setfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;type_index&quot;);</a>
<a name="ln6">  lua_newtable(L); lua_setfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;type_ids&quot;);</a>
<a name="ln7">  lua_newtable(L); lua_setfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;type_names&quot;);</a>
<a name="ln8">  lua_newtable(L); lua_setfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;type_sizes&quot;);</a>
<a name="ln9">  </a>
<a name="ln10">  lua_newtable(L); lua_setfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;stack_push&quot;);</a>
<a name="ln11">  lua_newtable(L); lua_setfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;stack_to&quot;);</a>
<a name="ln12">  </a>
<a name="ln13">  lua_newtable(L); lua_setfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;structs&quot;);</a>
<a name="ln14">  lua_newtable(L); lua_setfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;structs_offset&quot;);</a>
<a name="ln15">  lua_newtable(L); lua_setfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;enums&quot;);</a>
<a name="ln16">  lua_newtable(L); lua_setfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;enums_sizes&quot;);</a>
<a name="ln17">  lua_newtable(L); lua_setfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;enums_values&quot;);</a>
<a name="ln18">  lua_newtable(L); lua_setfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;functions&quot;);</a>
<a name="ln19">  </a>
<a name="ln20">  lua_newuserdata(L, LUAA_RETURN_STACK_SIZE); lua_setfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;call_ret_stk&quot;);</a>
<a name="ln21">  lua_newuserdata(L, LUAA_ARGUMENT_STACK_SIZE); lua_setfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;call_arg_stk&quot;);</a>
<a name="ln22">  lua_pushinteger(L, 0); lua_setfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;call_ret_ptr&quot;);</a>
<a name="ln23">  lua_pushinteger(L, 0); lua_setfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;call_arg_ptr&quot;);</a>
<a name="ln24">  </a>
<a name="ln25">  // compiler does weird macro expansion with &quot;bool&quot; so no magic macro for you</a>
<a name="ln26">  luaA_conversion_type(L, luaA_type_add(L,&quot;bool&quot;,sizeof(bool)), luaA_push_bool, luaA_to_bool);</a>
<a name="ln27">  luaA_conversion_type(L, luaA_type_add(L,&quot;_Bool&quot;,sizeof(bool)), luaA_push_bool, luaA_to_bool);</a>
<a name="ln28">  luaA_conversion(L, char, luaA_push_char, luaA_to_char);</a>
<a name="ln29">  luaA_conversion(L, signed char, luaA_push_signed_char, luaA_to_signed_char);</a>
<a name="ln30">  luaA_conversion(L, unsigned char, luaA_push_unsigned_char, luaA_to_unsigned_char);</a>
<a name="ln31">  luaA_conversion(L, short, luaA_push_short, luaA_to_short);</a>
<a name="ln32">  luaA_conversion(L, unsigned short, luaA_push_unsigned_short, luaA_to_unsigned_short);</a>
<a name="ln33">  luaA_conversion(L, int, luaA_push_int, luaA_to_int);</a>
<a name="ln34">  luaA_conversion(L, unsigned int, luaA_push_unsigned_int, luaA_to_unsigned_int);</a>
<a name="ln35">  luaA_conversion(L, long, luaA_push_long, luaA_to_long);</a>
<a name="ln36">  luaA_conversion(L, unsigned long, luaA_push_unsigned_long, luaA_to_unsigned_long);</a>
<a name="ln37">  luaA_conversion(L, long long, luaA_push_long_long, luaA_to_long_long);</a>
<a name="ln38">  luaA_conversion(L, unsigned long long, luaA_push_unsigned_long_long, luaA_to_unsigned_long_long);</a>
<a name="ln39">  luaA_conversion(L, float, luaA_push_float, luaA_to_float);</a>
<a name="ln40">  luaA_conversion(L, double, luaA_push_double, luaA_to_double);</a>
<a name="ln41">  luaA_conversion(L, long double, luaA_push_long_double, luaA_to_long_double);</a>
<a name="ln42">  </a>
<a name="ln43">  luaA_conversion_push_type(L, luaA_type_add(L,&quot;const bool&quot;,sizeof(bool)), luaA_push_bool);</a>
<a name="ln44">  luaA_conversion_push_type(L, luaA_type_add(L,&quot;const _Bool&quot;,sizeof(bool)), luaA_push_bool);</a>
<a name="ln45">  luaA_conversion_push(L, const char, luaA_push_char);</a>
<a name="ln46">  luaA_conversion_push(L, const signed char, luaA_push_signed_char);</a>
<a name="ln47">  luaA_conversion_push(L, const unsigned char, luaA_push_unsigned_char);</a>
<a name="ln48">  luaA_conversion_push(L, const short, luaA_push_short);</a>
<a name="ln49">  luaA_conversion_push(L, const unsigned short, luaA_push_unsigned_short);</a>
<a name="ln50">  luaA_conversion_push(L, const int, luaA_push_int);</a>
<a name="ln51">  luaA_conversion_push(L, const unsigned int, luaA_push_unsigned_int);</a>
<a name="ln52">  luaA_conversion_push(L, const long, luaA_push_long);</a>
<a name="ln53">  luaA_conversion_push(L, const unsigned long, luaA_push_unsigned_long);</a>
<a name="ln54">  luaA_conversion_push(L, const long long, luaA_push_long_long);</a>
<a name="ln55">  luaA_conversion_push(L, const unsigned long long, luaA_push_unsigned_long_long);</a>
<a name="ln56">  luaA_conversion_push(L, const float, luaA_push_float);</a>
<a name="ln57">  luaA_conversion_push(L, const double, luaA_push_double);</a>
<a name="ln58">  luaA_conversion_push(L, const long double, luaA_push_long_double);</a>
<a name="ln59">  </a>
<a name="ln60">  luaA_conversion(L, char*, luaA_push_char_ptr, luaA_to_char_ptr);</a>
<a name="ln61">  luaA_conversion(L, const char*, luaA_push_const_char_ptr, luaA_to_const_char_ptr);</a>
<a name="ln62">  luaA_conversion(L, void*, luaA_push_void_ptr, luaA_to_void_ptr);</a>
<a name="ln63">  </a>
<a name="ln64">  luaA_conversion_push(L, void, luaA_push_void);</a>
<a name="ln65">  </a>
<a name="ln66">}</a>
<a name="ln67"> </a>
<a name="ln68">void luaA_close(lua_State* L) {</a>
<a name="ln69"> </a>
<a name="ln70">  lua_pushnil(L); lua_setfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;type_index&quot;);</a>
<a name="ln71">  lua_pushnil(L); lua_setfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;type_ids&quot;);</a>
<a name="ln72">  lua_pushnil(L); lua_setfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;type_names&quot;);</a>
<a name="ln73">  lua_pushnil(L); lua_setfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;type_sizes&quot;);</a>
<a name="ln74">  </a>
<a name="ln75">  lua_pushnil(L); lua_setfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;stack_push&quot;);</a>
<a name="ln76">  lua_pushnil(L); lua_setfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;stack_to&quot;);</a>
<a name="ln77">  </a>
<a name="ln78">  lua_pushnil(L); lua_setfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;structs&quot;);</a>
<a name="ln79">  lua_pushnil(L); lua_setfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;structs_offset&quot;);</a>
<a name="ln80">  lua_pushnil(L); lua_setfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;enums&quot;);</a>
<a name="ln81">  lua_pushnil(L); lua_setfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;enums_sizes&quot;);</a>
<a name="ln82">  lua_pushnil(L); lua_setfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;enums_values&quot;);</a>
<a name="ln83">  lua_pushnil(L); lua_setfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;functions&quot;);</a>
<a name="ln84">  </a>
<a name="ln85">  lua_pushnil(L); lua_setfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;call_ret_stk&quot;);</a>
<a name="ln86">  lua_pushnil(L); lua_setfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;call_arg_stk&quot;);</a>
<a name="ln87">  lua_pushnil(L); lua_setfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;call_ret_ptr&quot;);</a>
<a name="ln88">  lua_pushnil(L); lua_setfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;call_arg_ptr&quot;);</a>
<a name="ln89">  </a>
<a name="ln90">}</a>
<a name="ln91"> </a>
<a name="ln92">/*</a>
<a name="ln93">** Types</a>
<a name="ln94">*/</a>
<a name="ln95"> </a>
<a name="ln96">luaA_Type luaA_type_add(lua_State* L, const char* type, size_t size) {</a>
<a name="ln97">  </a>
<a name="ln98">  lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;type_ids&quot;);</a>
<a name="ln99">  lua_getfield(L, -1, type);</a>
<a name="ln100">  </a>
<a name="ln101">  if (lua_isnumber(L, -1)) {</a>
<a name="ln102">  </a>
<a name="ln103">    luaA_Type id = lua_tointeger(L, -1);</a>
<a name="ln104">    lua_pop(L, 2);</a>
<a name="ln105">    return id;</a>
<a name="ln106">  </a>
<a name="ln107">  } else {</a>
<a name="ln108">  </a>
<a name="ln109">    lua_pop(L, 2);</a>
<a name="ln110">    </a>
<a name="ln111">    lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;type_index&quot;);</a>
<a name="ln112">    </a>
<a name="ln113">    luaA_Type id = lua_tointeger(L, -1);</a>
<a name="ln114">    lua_pop(L, 1);</a>
<a name="ln115">    id++;</a>
<a name="ln116"> </a>
<a name="ln117">    lua_pushinteger(L, id);</a>
<a name="ln118">    lua_setfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;type_index&quot;);</a>
<a name="ln119">    </a>
<a name="ln120">    lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;type_ids&quot;);</a>
<a name="ln121">    lua_pushinteger(L, id);</a>
<a name="ln122">    lua_setfield(L, -2, type);</a>
<a name="ln123">    lua_pop(L, 1);</a>
<a name="ln124">    </a>
<a name="ln125">    lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;type_names&quot;);</a>
<a name="ln126">    lua_pushinteger(L, id);</a>
<a name="ln127">    lua_pushstring(L, type);</a>
<a name="ln128">    lua_settable(L, -3);</a>
<a name="ln129">    lua_pop(L, 1);</a>
<a name="ln130">    </a>
<a name="ln131">    lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;type_sizes&quot;);</a>
<a name="ln132">    lua_pushinteger(L, id);</a>
<a name="ln133">    lua_pushinteger(L, size);</a>
<a name="ln134">    lua_settable(L, -3);</a>
<a name="ln135">    lua_pop(L, 1);</a>
<a name="ln136">    </a>
<a name="ln137">    return id;</a>
<a name="ln138">    </a>
<a name="ln139">  }</a>
<a name="ln140">  </a>
<a name="ln141">}</a>
<a name="ln142"> </a>
<a name="ln143">luaA_Type luaA_type_find(lua_State* L, const char* type) {</a>
<a name="ln144">  </a>
<a name="ln145">  lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;type_ids&quot;);  </a>
<a name="ln146">  lua_getfield(L, -1, type);</a>
<a name="ln147">  </a>
<a name="ln148">  luaA_Type id = lua_isnil(L, -1) ? LUAA_INVALID_TYPE : lua_tointeger(L, -1);</a>
<a name="ln149">  lua_pop(L, 2);</a>
<a name="ln150">  </a>
<a name="ln151">  return id;</a>
<a name="ln152">}</a>
<a name="ln153"> </a>
<a name="ln154">const char* luaA_typename(lua_State* L, luaA_Type id) {</a>
<a name="ln155">  </a>
<a name="ln156">  lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;type_names&quot;);  </a>
<a name="ln157">  lua_pushinteger(L, id);</a>
<a name="ln158">  lua_gettable(L, -2);</a>
<a name="ln159">  </a>
<a name="ln160">  const char* type = lua_isnil(L, -1) ? &quot;LUAA_INVALID_TYPE&quot; : lua_tostring(L, -1);</a>
<a name="ln161">  lua_pop(L, 2);</a>
<a name="ln162">  </a>
<a name="ln163">  return type;</a>
<a name="ln164">}</a>
<a name="ln165"> </a>
<a name="ln166">size_t luaA_typesize(lua_State* L, luaA_Type id) {</a>
<a name="ln167"> </a>
<a name="ln168">  lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;type_sizes&quot;);  </a>
<a name="ln169">  lua_pushinteger(L, id);</a>
<a name="ln170">  lua_gettable(L, -2);</a>
<a name="ln171">  </a>
<a name="ln172">  size_t size = lua_isnil(L, -1) ? -1 : lua_tointeger(L, -1);</a>
<a name="ln173">  lua_pop(L, 2);</a>
<a name="ln174">  </a>
<a name="ln175">  return size;</a>
<a name="ln176">}</a>
<a name="ln177"> </a>
<a name="ln178">/*</a>
<a name="ln179">** Stack</a>
<a name="ln180">*/</a>
<a name="ln181"> </a>
<a name="ln182">int luaA_push_type(lua_State* L, luaA_Type type_id, const void* c_in) {</a>
<a name="ln183">  </a>
<a name="ln184">  lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;stack_push&quot;);</a>
<a name="ln185">  lua_pushinteger(L, type_id);</a>
<a name="ln186">  lua_gettable(L, -2);</a>
<a name="ln187">  </a>
<a name="ln188">  if (!lua_isnil(L, -1)) {</a>
<a name="ln189">    luaA_Pushfunc func = lua_touserdata(L, -1);</a>
<a name="ln190">    lua_pop(L, 2);</a>
<a name="ln191">    return func(L, type_id, c_in);</a>
<a name="ln192">  }</a>
<a name="ln193">  </a>
<a name="ln194">  lua_pop(L, 2);</a>
<a name="ln195">  </a>
<a name="ln196">  if (luaA_struct_registered_type(L, type_id)) {</a>
<a name="ln197">    return luaA_struct_push_type(L, type_id, c_in);</a>
<a name="ln198">  }</a>
<a name="ln199">  </a>
<a name="ln200">  if (luaA_enum_registered_type(L, type_id)) {</a>
<a name="ln201">    return luaA_enum_push_type(L, type_id, c_in);</a>
<a name="ln202">  }</a>
<a name="ln203">  </a>
<a name="ln204">  lua_pushfstring(L, &quot;luaA_push: conversion to Lua object from type '%s' not registered!&quot;, luaA_typename(L, type_id));</a>
<a name="ln205">  lua_error(L);</a>
<a name="ln206">  return 0;</a>
<a name="ln207">}</a>
<a name="ln208"> </a>
<a name="ln209">void luaA_to_type(lua_State* L, luaA_Type type_id, void* c_out, int index) {</a>
<a name="ln210">  </a>
<a name="ln211">  lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;stack_to&quot;);</a>
<a name="ln212">  lua_pushinteger(L, type_id);</a>
<a name="ln213">  lua_gettable(L, -2);</a>
<a name="ln214">  </a>
<a name="ln215">  if (!lua_isnil(L, -1)) {</a>
<a name="ln216">    luaA_Tofunc func = lua_touserdata(L, -1);</a>
<a name="ln217">    lua_pop(L, 2);</a>
<a name="ln218">    func(L, type_id, c_out, index);</a>
<a name="ln219">    return;</a>
<a name="ln220">  }</a>
<a name="ln221">  </a>
<a name="ln222">  lua_pop(L, 2);</a>
<a name="ln223">  </a>
<a name="ln224">  if (luaA_struct_registered_type(L, type_id)) {</a>
<a name="ln225">    luaA_struct_to_type(L, type_id, c_out, index);</a>
<a name="ln226">    return;</a>
<a name="ln227">  }</a>
<a name="ln228">  </a>
<a name="ln229">  if (luaA_enum_registered_type(L, type_id)) {</a>
<a name="ln230">    luaA_enum_to_type(L, type_id, c_out, index);</a>
<a name="ln231">    return;</a>
<a name="ln232">  }</a>
<a name="ln233">  </a>
<a name="ln234">  lua_pushfstring(L, &quot;luaA_to: conversion from Lua object to type '%s' not registered!&quot;, luaA_typename(L, type_id));</a>
<a name="ln235">  lua_error(L);  </a>
<a name="ln236">}</a>
<a name="ln237"> </a>
<a name="ln238">void luaA_conversion_type(lua_State* L, luaA_Type type_id, luaA_Pushfunc push_func, luaA_Tofunc to_func) {</a>
<a name="ln239">  luaA_conversion_push_type(L, type_id, push_func);</a>
<a name="ln240">  luaA_conversion_to_type(L, type_id, to_func);</a>
<a name="ln241">}</a>
<a name="ln242"> </a>
<a name="ln243">void luaA_conversion_push_type(lua_State* L, luaA_Type type_id, luaA_Pushfunc func) {</a>
<a name="ln244">  lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;stack_push&quot;);</a>
<a name="ln245">  lua_pushinteger(L, type_id);</a>
<a name="ln246">  lua_pushlightuserdata(L, func);</a>
<a name="ln247">  lua_settable(L, -3);</a>
<a name="ln248">  lua_pop(L, 1);</a>
<a name="ln249">}</a>
<a name="ln250"> </a>
<a name="ln251">void luaA_conversion_to_type(lua_State* L, luaA_Type type_id, luaA_Tofunc func) {</a>
<a name="ln252">  lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;stack_to&quot;);</a>
<a name="ln253">  lua_pushinteger(L, type_id);</a>
<a name="ln254">  lua_pushlightuserdata(L, func);</a>
<a name="ln255">  lua_settable(L, -3);</a>
<a name="ln256">  lua_pop(L, 1);</a>
<a name="ln257">}</a>
<a name="ln258"> </a>
<a name="ln259">int luaA_push_bool(lua_State* L, luaA_Type type_id, const void* c_in) {</a>
<a name="ln260">  lua_pushboolean(L, *(bool*)c_in);</a>
<a name="ln261">  return 1;</a>
<a name="ln262">}</a>
<a name="ln263"> </a>
<a name="ln264">void luaA_to_bool(lua_State* L, luaA_Type type_id,  void* c_out, int index) {</a>
<a name="ln265">  *(bool*)c_out = lua_toboolean(L, index);</a>
<a name="ln266">}</a>
<a name="ln267"> </a>
<a name="ln268">int luaA_push_char(lua_State* L, luaA_Type type_id, const void* c_in) {</a>
<a name="ln269">  lua_pushinteger(L, *(char*)c_in);</a>
<a name="ln270">  return 1;</a>
<a name="ln271">}</a>
<a name="ln272"> </a>
<a name="ln273">void luaA_to_char(lua_State* L, luaA_Type type_id,  void* c_out, int index) {</a>
<a name="ln274">  *(char*)c_out = lua_tointeger(L, index);</a>
<a name="ln275">}</a>
<a name="ln276"> </a>
<a name="ln277">int luaA_push_signed_char(lua_State* L, luaA_Type type_id, const void* c_in) {</a>
<a name="ln278">  lua_pushinteger(L, *(signed char*)c_in);</a>
<a name="ln279">  return 1;</a>
<a name="ln280">}</a>
<a name="ln281"> </a>
<a name="ln282">void luaA_to_signed_char(lua_State* L, luaA_Type type_id, void* c_out, int index) {</a>
<a name="ln283">  *(signed char*)c_out = lua_tointeger(L, index);</a>
<a name="ln284">}</a>
<a name="ln285"> </a>
<a name="ln286">int luaA_push_unsigned_char(lua_State* L, luaA_Type type_id, const void* c_in) {</a>
<a name="ln287">  lua_pushinteger(L, *(unsigned char*)c_in);</a>
<a name="ln288">  return 1;</a>
<a name="ln289">}</a>
<a name="ln290"> </a>
<a name="ln291">void luaA_to_unsigned_char(lua_State* L, luaA_Type type_id, void* c_out, int index) {</a>
<a name="ln292">  *(unsigned char*)c_out = lua_tointeger(L, index);</a>
<a name="ln293">}</a>
<a name="ln294"> </a>
<a name="ln295">int luaA_push_short(lua_State* L, luaA_Type type_id, const void* c_in) {</a>
<a name="ln296">  lua_pushinteger(L, *(short*)c_in);</a>
<a name="ln297">  return 1;</a>
<a name="ln298">}</a>
<a name="ln299"> </a>
<a name="ln300">void luaA_to_short(lua_State* L, luaA_Type type_id, void* c_out, int index) {</a>
<a name="ln301">  *(short*)c_out = lua_tointeger(L, index);</a>
<a name="ln302">}</a>
<a name="ln303"> </a>
<a name="ln304">int luaA_push_unsigned_short(lua_State* L, luaA_Type type_id, const void* c_in) {</a>
<a name="ln305">  lua_pushinteger(L, *(unsigned short*)c_in);</a>
<a name="ln306">  return 1;</a>
<a name="ln307">}</a>
<a name="ln308"> </a>
<a name="ln309">void luaA_to_unsigned_short(lua_State* L, luaA_Type type_id, void* c_out, int index) {</a>
<a name="ln310">  *(unsigned short*)c_out = lua_tointeger(L, index);</a>
<a name="ln311">}</a>
<a name="ln312"> </a>
<a name="ln313">int luaA_push_int(lua_State* L, luaA_Type type_id, const void* c_in) {</a>
<a name="ln314">  lua_pushinteger(L, *(int*)c_in);</a>
<a name="ln315">  return 1;</a>
<a name="ln316">}</a>
<a name="ln317"> </a>
<a name="ln318">void luaA_to_int(lua_State* L, luaA_Type type_id, void* c_out, int index) {</a>
<a name="ln319">  *(int*)c_out = lua_tointeger(L, index);</a>
<a name="ln320">}</a>
<a name="ln321"> </a>
<a name="ln322">int luaA_push_unsigned_int(lua_State* L, luaA_Type type_id, const void* c_in) {</a>
<a name="ln323">  lua_pushinteger(L, *(unsigned int*)c_in);</a>
<a name="ln324">  return 1;</a>
<a name="ln325">}</a>
<a name="ln326"> </a>
<a name="ln327">void luaA_to_unsigned_int(lua_State* L, luaA_Type type_id, void* c_out, int index) {</a>
<a name="ln328">  *(unsigned int*)c_out = lua_tointeger(L, index);</a>
<a name="ln329">}</a>
<a name="ln330"> </a>
<a name="ln331">int luaA_push_long(lua_State* L, luaA_Type type_id, const void* c_in) {</a>
<a name="ln332">  lua_pushinteger(L, *(long*)c_in);</a>
<a name="ln333">  return 1;</a>
<a name="ln334">}</a>
<a name="ln335"> </a>
<a name="ln336">void luaA_to_long(lua_State* L, luaA_Type type_id, void* c_out, int index) {</a>
<a name="ln337">  *(long*)c_out = lua_tointeger(L, index);</a>
<a name="ln338">}</a>
<a name="ln339"> </a>
<a name="ln340">int luaA_push_unsigned_long(lua_State* L, luaA_Type type_id, const void* c_in) {</a>
<a name="ln341">  lua_pushinteger(L, *(unsigned long*)c_in);</a>
<a name="ln342">  return 1;</a>
<a name="ln343">}</a>
<a name="ln344"> </a>
<a name="ln345">void luaA_to_unsigned_long(lua_State* L, luaA_Type type_id, void* c_out, int index) {</a>
<a name="ln346">  *(unsigned long*)c_out = lua_tointeger(L, index);</a>
<a name="ln347">}</a>
<a name="ln348"> </a>
<a name="ln349">int luaA_push_long_long(lua_State* L, luaA_Type type_id, const void* c_in) {</a>
<a name="ln350">  lua_pushinteger(L, *(long long*)c_in);</a>
<a name="ln351">  return 1;</a>
<a name="ln352">}</a>
<a name="ln353"> </a>
<a name="ln354">void luaA_to_long_long(lua_State* L, luaA_Type type_id, void* c_out, int index) {</a>
<a name="ln355">  *(long long*)c_out = lua_tointeger(L, index);</a>
<a name="ln356">}</a>
<a name="ln357"> </a>
<a name="ln358">int luaA_push_unsigned_long_long(lua_State* L, luaA_Type type_id, const void* c_in) {</a>
<a name="ln359">  lua_pushinteger(L, *(unsigned long long*)c_in);</a>
<a name="ln360">  return 1;</a>
<a name="ln361">}</a>
<a name="ln362"> </a>
<a name="ln363">void luaA_to_unsigned_long_long(lua_State* L, luaA_Type type_id, void* c_out, int index) {</a>
<a name="ln364">  *(unsigned long long*)c_out = lua_tointeger(L, index);</a>
<a name="ln365">}</a>
<a name="ln366"> </a>
<a name="ln367">int luaA_push_float(lua_State* L, luaA_Type type_id, const void* c_in) {</a>
<a name="ln368">  lua_pushnumber(L, *(float*)c_in);</a>
<a name="ln369">  return 1;</a>
<a name="ln370">}</a>
<a name="ln371"> </a>
<a name="ln372">void luaA_to_float(lua_State* L, luaA_Type type_id, void* c_out, int index) {</a>
<a name="ln373">  *(float*)c_out = lua_tonumber(L, index);</a>
<a name="ln374">}</a>
<a name="ln375"> </a>
<a name="ln376">int luaA_push_double(lua_State* L, luaA_Type type_id, const void* c_in) {</a>
<a name="ln377">  lua_pushnumber(L, *(double*)c_in);</a>
<a name="ln378">  return 1;</a>
<a name="ln379">}</a>
<a name="ln380"> </a>
<a name="ln381">void luaA_to_double(lua_State* L, luaA_Type type_id, void* c_out, int index) {</a>
<a name="ln382">  *(double*)c_out = lua_tonumber(L, index);</a>
<a name="ln383">}</a>
<a name="ln384"> </a>
<a name="ln385">int luaA_push_long_double(lua_State* L, luaA_Type type_id, const void* c_in) {</a>
<a name="ln386">  lua_pushnumber(L, *(long double*)c_in);</a>
<a name="ln387">  return 1;</a>
<a name="ln388">}</a>
<a name="ln389"> </a>
<a name="ln390">void luaA_to_long_double(lua_State* L, luaA_Type type_id, void* c_out, int index) {</a>
<a name="ln391">  *(long double*)c_out = lua_tonumber(L, index);</a>
<a name="ln392">}</a>
<a name="ln393"> </a>
<a name="ln394">int luaA_push_char_ptr(lua_State* L, luaA_Type type_id, const void* c_in) {</a>
<a name="ln395">  lua_pushstring(L, *(char**)c_in);</a>
<a name="ln396">  return 1;</a>
<a name="ln397">}</a>
<a name="ln398"> </a>
<a name="ln399">void luaA_to_char_ptr(lua_State* L, luaA_Type type_id, void* c_out, int index) {</a>
<a name="ln400">  *(char**)c_out = (char*)lua_tostring(L, index);</a>
<a name="ln401">}</a>
<a name="ln402"> </a>
<a name="ln403">int luaA_push_const_char_ptr(lua_State* L, luaA_Type type_id, const void* c_in) {</a>
<a name="ln404">  lua_pushstring(L, *(const char**)c_in);</a>
<a name="ln405">  return 1;</a>
<a name="ln406">}</a>
<a name="ln407"> </a>
<a name="ln408">void luaA_to_const_char_ptr(lua_State* L, luaA_Type type_id, void* c_out, int index) {</a>
<a name="ln409">  *(const char**)c_out = lua_tostring(L, index);</a>
<a name="ln410">}</a>
<a name="ln411"> </a>
<a name="ln412">int luaA_push_void_ptr(lua_State* L, luaA_Type type_id, const void* c_in) {</a>
<a name="ln413">  lua_pushlightuserdata(L, *(void**)c_in);</a>
<a name="ln414">  return 1;</a>
<a name="ln415">}</a>
<a name="ln416"> </a>
<a name="ln417">void luaA_to_void_ptr(lua_State* L, luaA_Type type_id, void* c_out, int index) {</a>
<a name="ln418">  *(void**)c_out = (void*)lua_touserdata(L, index);</a>
<a name="ln419">}</a>
<a name="ln420"> </a>
<a name="ln421">int luaA_push_void(lua_State* L, luaA_Type type_id, const void* c_in) {</a>
<a name="ln422">  lua_pushnil(L);</a>
<a name="ln423">  return 1;</a>
<a name="ln424">}</a>
<a name="ln425"> </a>
<a name="ln426">bool luaA_conversion_registered_type(lua_State* L, luaA_Type type_id) {</a>
<a name="ln427">  return (luaA_conversion_push_registered_type(L, type_id)</a>
<a name="ln428">       &amp;&amp; luaA_conversion_to_registered_type(L, type_id));</a>
<a name="ln429">}</a>
<a name="ln430"> </a>
<a name="ln431">bool luaA_conversion_push_registered_type(lua_State* L, luaA_Type type_id) {</a>
<a name="ln432"> </a>
<a name="ln433">  lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;stack_push&quot;);  </a>
<a name="ln434">  lua_pushinteger(L, type_id);</a>
<a name="ln435">  lua_gettable(L, -2);</a>
<a name="ln436">  </a>
<a name="ln437">  bool reg = !lua_isnil(L, -1);</a>
<a name="ln438">  lua_pop(L, 2);</a>
<a name="ln439">  </a>
<a name="ln440">  return reg;</a>
<a name="ln441">}</a>
<a name="ln442"> </a>
<a name="ln443">bool luaA_conversion_to_registered_type(lua_State* L, luaA_Type type_id) {</a>
<a name="ln444"> </a>
<a name="ln445">  lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;stack_to&quot;);  </a>
<a name="ln446">  lua_pushinteger(L, type_id);</a>
<a name="ln447">  lua_gettable(L, -2);</a>
<a name="ln448">  </a>
<a name="ln449">  bool reg = !lua_isnil(L, -1);</a>
<a name="ln450">  lua_pop(L, 2);</a>
<a name="ln451"> </a>
<a name="ln452">  return reg;</a>
<a name="ln453">}</a>
<a name="ln454"> </a>
<a name="ln455">/*</a>
<a name="ln456">** Structs</a>
<a name="ln457">*/</a>
<a name="ln458"> </a>
<a name="ln459">int luaA_struct_push_member_offset_type(lua_State* L, luaA_Type type, size_t offset, const void* c_in) {</a>
<a name="ln460">  </a>
<a name="ln461">  lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;structs_offset&quot;);</a>
<a name="ln462">  lua_pushinteger(L, type);</a>
<a name="ln463">  lua_gettable(L, -2);</a>
<a name="ln464">  </a>
<a name="ln465">  if (!lua_isnil(L, -1)) {</a>
<a name="ln466">    </a>
<a name="ln467">    lua_pushinteger(L, offset);</a>
<a name="ln468">    lua_gettable(L, -2);</a>
<a name="ln469">    </a>
<a name="ln470">    if (!lua_isnil(L, -1)) {</a>
<a name="ln471">      lua_getfield(L, -1, &quot;type&quot;);</a>
<a name="ln472">      luaA_Type stype = lua_tointeger(L, -1);</a>
<a name="ln473">      lua_pop(L, 4);</a>
<a name="ln474">      return luaA_push_type(L, stype, c_in + offset);</a>
<a name="ln475">    }</a>
<a name="ln476">    </a>
<a name="ln477">    lua_pop(L, 3);</a>
<a name="ln478">    lua_pushfstring(L, &quot;luaA_struct_push_member: Member offset '%d' not registered for struct '%s'!&quot;, offset, luaA_typename(L, type));</a>
<a name="ln479">    lua_error(L);</a>
<a name="ln480"> </a>
<a name="ln481">  }</a>
<a name="ln482">  </a>
<a name="ln483">  lua_pop(L, 2);</a>
<a name="ln484">  lua_pushfstring(L, &quot;luaA_struct_push_member: Struct '%s' not registered!&quot;, luaA_typename(L, type));</a>
<a name="ln485">  lua_error(L);</a>
<a name="ln486">  return 0;</a>
<a name="ln487">  </a>
<a name="ln488">}</a>
<a name="ln489"> </a>
<a name="ln490">int luaA_struct_push_member_name_type(lua_State* L, luaA_Type type, const char* member, const void* c_in) {</a>
<a name="ln491"> </a>
<a name="ln492">  lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;structs&quot;);</a>
<a name="ln493">  lua_pushinteger(L, type);</a>
<a name="ln494">  lua_gettable(L, -2);</a>
<a name="ln495">  </a>
<a name="ln496">  if (!lua_isnil(L, -1)) {</a>
<a name="ln497">    </a>
<a name="ln498">    lua_getfield(L, -1, member);</a>
<a name="ln499">    </a>
<a name="ln500">    if (!lua_isnil(L, -1)) {</a>
<a name="ln501">      lua_getfield(L, -1, &quot;type&quot;);</a>
<a name="ln502">      luaA_Type stype = lua_tointeger(L, -1);</a>
<a name="ln503">      lua_pop(L, 1);</a>
<a name="ln504">      lua_getfield(L, -1, &quot;offset&quot;);</a>
<a name="ln505">      size_t offset = lua_tointeger(L, -1);</a>
<a name="ln506">      lua_pop(L, 4);</a>
<a name="ln507">      return luaA_push_type(L, stype, c_in + offset);</a>
<a name="ln508">    }</a>
<a name="ln509">    </a>
<a name="ln510">    lua_pop(L, 3);</a>
<a name="ln511">    lua_pushfstring(L, &quot;luaA_struct_push_member: Member name '%s' not registered for struct '%s'!&quot;, member, luaA_typename(L, type));</a>
<a name="ln512">    lua_error(L);</a>
<a name="ln513"> </a>
<a name="ln514">  }</a>
<a name="ln515">  </a>
<a name="ln516">  lua_pop(L, 2);</a>
<a name="ln517">  lua_pushfstring(L, &quot;luaA_struct_push_member: Struct '%s' not registered!&quot;, luaA_typename(L, type));</a>
<a name="ln518">  lua_error(L);</a>
<a name="ln519">  return 0;</a>
<a name="ln520">}</a>
<a name="ln521"> </a>
<a name="ln522">void luaA_struct_to_member_offset_type(lua_State* L, luaA_Type type, size_t offset, void* c_out, int index) {</a>
<a name="ln523"> </a>
<a name="ln524">  lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;structs_offset&quot;);</a>
<a name="ln525">  lua_pushinteger(L, type);</a>
<a name="ln526">  lua_gettable(L, -2);</a>
<a name="ln527">  </a>
<a name="ln528">  if (!lua_isnil(L, -1)) {</a>
<a name="ln529">    </a>
<a name="ln530">    lua_pushinteger(L, offset);</a>
<a name="ln531">    lua_gettable(L, -2);</a>
<a name="ln532">    </a>
<a name="ln533">    if (!lua_isnil(L, -1)) {</a>
<a name="ln534">      lua_getfield(L, -1, &quot;type&quot;);</a>
<a name="ln535">      luaA_Type stype = lua_tointeger(L, -1);</a>
<a name="ln536">      lua_pop(L, 4);</a>
<a name="ln537">      luaA_to_type(L, stype, c_out + offset, index);</a>
<a name="ln538">      return;</a>
<a name="ln539">    }</a>
<a name="ln540">    </a>
<a name="ln541">    lua_pop(L, 3);</a>
<a name="ln542">    lua_pushfstring(L, &quot;luaA_struct_to_member: Member offset '%d' not registered for struct '%s'!&quot;, offset, luaA_typename(L, type));</a>
<a name="ln543">    lua_error(L);</a>
<a name="ln544"> </a>
<a name="ln545">  }</a>
<a name="ln546">  </a>
<a name="ln547">  lua_pop(L, 2);</a>
<a name="ln548">  lua_pushfstring(L, &quot;luaA_struct_to_member: Struct '%s' not registered!&quot;, luaA_typename(L, type));</a>
<a name="ln549">  lua_error(L);</a>
<a name="ln550">  </a>
<a name="ln551">}</a>
<a name="ln552"> </a>
<a name="ln553">void luaA_struct_to_member_name_type(lua_State* L, luaA_Type type, const char* member, void* c_out, int index) {</a>
<a name="ln554"> </a>
<a name="ln555">  lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;structs&quot;);</a>
<a name="ln556">  lua_pushinteger(L, type);</a>
<a name="ln557">  lua_gettable(L, -2);</a>
<a name="ln558">  </a>
<a name="ln559">  if (!lua_isnil(L, -1)) {</a>
<a name="ln560">    </a>
<a name="ln561">    lua_pushstring(L, member);</a>
<a name="ln562">    lua_gettable(L, -2);</a>
<a name="ln563">    </a>
<a name="ln564">    if (!lua_isnil(L, -1)) {</a>
<a name="ln565">      lua_getfield(L, -1, &quot;type&quot;);</a>
<a name="ln566">      luaA_Type stype = lua_tointeger(L, -1);</a>
<a name="ln567">      lua_pop(L, 1);</a>
<a name="ln568">      lua_getfield(L, -1, &quot;offset&quot;);</a>
<a name="ln569">      size_t offset = lua_tointeger(L, -1);</a>
<a name="ln570">      lua_pop(L, 4);</a>
<a name="ln571">      luaA_to_type(L, stype, c_out + offset, index);</a>
<a name="ln572">      return;</a>
<a name="ln573">    }</a>
<a name="ln574">    </a>
<a name="ln575">    lua_pop(L, 3);</a>
<a name="ln576">    lua_pushfstring(L, &quot;luaA_struct_to_member: Member name '%s' not registered for struct '%s'!&quot;, member, luaA_typename(L, type));</a>
<a name="ln577">    lua_error(L);</a>
<a name="ln578"> </a>
<a name="ln579">  }</a>
<a name="ln580">  </a>
<a name="ln581">  lua_pop(L, 2);</a>
<a name="ln582">  lua_pushfstring(L, &quot;luaA_struct_to_member: Struct '%s' not registered!&quot;, luaA_typename(L, type));</a>
<a name="ln583">  lua_error(L);</a>
<a name="ln584">  </a>
<a name="ln585">}</a>
<a name="ln586"> </a>
<a name="ln587">bool luaA_struct_has_member_offset_type(lua_State* L, luaA_Type type, size_t offset) {</a>
<a name="ln588"> </a>
<a name="ln589">  lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;structs_offset&quot;);</a>
<a name="ln590">  lua_pushinteger(L, type);</a>
<a name="ln591">  lua_gettable(L, -2);</a>
<a name="ln592">  </a>
<a name="ln593">  if (!lua_isnil(L, -1)) {</a>
<a name="ln594">    </a>
<a name="ln595">    lua_pushinteger(L, offset);</a>
<a name="ln596">    lua_gettable(L, -2);</a>
<a name="ln597">    </a>
<a name="ln598">    if (!lua_isnil(L, -1)) {</a>
<a name="ln599">      lua_pop(L, 3);</a>
<a name="ln600">      return true;</a>
<a name="ln601">    }</a>
<a name="ln602">    </a>
<a name="ln603">    lua_pop(L, 3);</a>
<a name="ln604">    return false;</a>
<a name="ln605"> </a>
<a name="ln606">  }</a>
<a name="ln607">  </a>
<a name="ln608">  lua_pop(L, 2);</a>
<a name="ln609">  lua_pushfstring(L, &quot;luaA_struct_has_member: Struct '%s' not registered!&quot;, luaA_typename(L, type));</a>
<a name="ln610">  lua_error(L);</a>
<a name="ln611">  return false;</a>
<a name="ln612">  </a>
<a name="ln613">}</a>
<a name="ln614"> </a>
<a name="ln615">bool luaA_struct_has_member_name_type(lua_State* L, luaA_Type type, const char* member) {</a>
<a name="ln616"> </a>
<a name="ln617">  lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;structs&quot;);</a>
<a name="ln618">  lua_pushinteger(L, type);</a>
<a name="ln619">  lua_gettable(L, -2);</a>
<a name="ln620">  </a>
<a name="ln621">  if (!lua_isnil(L, -1)) {</a>
<a name="ln622">    </a>
<a name="ln623">    lua_pushstring(L, member);</a>
<a name="ln624">    lua_gettable(L, -2);</a>
<a name="ln625">    </a>
<a name="ln626">    if (!lua_isnil(L, -1)) {</a>
<a name="ln627">      lua_pop(L, 3);</a>
<a name="ln628">      return true;</a>
<a name="ln629">    }</a>
<a name="ln630">    </a>
<a name="ln631">    lua_pop(L, 3);</a>
<a name="ln632">    return false;</a>
<a name="ln633"> </a>
<a name="ln634">  }</a>
<a name="ln635">  </a>
<a name="ln636">  lua_pop(L, 2);</a>
<a name="ln637">  lua_pushfstring(L, &quot;luaA_struct_has_member: Struct '%s' not registered!&quot;, luaA_typename(L, type));</a>
<a name="ln638">  lua_error(L);</a>
<a name="ln639">  return false;</a>
<a name="ln640">  </a>
<a name="ln641">}</a>
<a name="ln642"> </a>
<a name="ln643">luaA_Type luaA_struct_typeof_member_offset_type(lua_State* L, luaA_Type type,  size_t offset) {</a>
<a name="ln644"> </a>
<a name="ln645">  lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;structs_offset&quot;);</a>
<a name="ln646">  lua_pushinteger(L, type);</a>
<a name="ln647">  lua_gettable(L, -2);</a>
<a name="ln648">  </a>
<a name="ln649">  if (!lua_isnil(L, -1)) {</a>
<a name="ln650">    </a>
<a name="ln651">    lua_pushinteger(L, offset);</a>
<a name="ln652">    lua_gettable(L, -2);</a>
<a name="ln653">    </a>
<a name="ln654">    if (!lua_isnil(L, -1)) {</a>
<a name="ln655">      lua_getfield(L, -1, &quot;type&quot;);</a>
<a name="ln656">      luaA_Type stype = lua_tointeger(L, -1);</a>
<a name="ln657">      lua_pop(L, 4);</a>
<a name="ln658">      return stype;</a>
<a name="ln659">    }</a>
<a name="ln660">    </a>
<a name="ln661">    lua_pop(L, 3);</a>
<a name="ln662">    lua_pushfstring(L, &quot;luaA_struct_typeof_member: Member offset '%d' not registered for struct '%s'!&quot;, offset, luaA_typename(L, type));</a>
<a name="ln663">    lua_error(L);</a>
<a name="ln664"> </a>
<a name="ln665">  }</a>
<a name="ln666">  </a>
<a name="ln667">  lua_pop(L, 2);</a>
<a name="ln668">  lua_pushfstring(L, &quot;luaA_struct_typeof_member: Struct '%s' not registered!&quot;, luaA_typename(L, type));</a>
<a name="ln669">  lua_error(L);</a>
<a name="ln670">  return 0;</a>
<a name="ln671">  </a>
<a name="ln672">}</a>
<a name="ln673"> </a>
<a name="ln674">luaA_Type luaA_struct_typeof_member_name_type(lua_State* L, luaA_Type type,  const char* member) {</a>
<a name="ln675"> </a>
<a name="ln676">  lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;structs&quot;);</a>
<a name="ln677">  lua_pushinteger(L, type);</a>
<a name="ln678">  lua_gettable(L, -2);</a>
<a name="ln679">  </a>
<a name="ln680">  if (!lua_isnil(L, -1)) {</a>
<a name="ln681">    </a>
<a name="ln682">    lua_pushstring(L, member);</a>
<a name="ln683">    lua_gettable(L, -2);</a>
<a name="ln684">    </a>
<a name="ln685">    if (!lua_isnil(L, -1)) {</a>
<a name="ln686">      lua_getfield(L, -1, &quot;type&quot;);</a>
<a name="ln687">      luaA_Type t = lua_tointeger(L, -1);</a>
<a name="ln688">      lua_pop(L, 4);</a>
<a name="ln689">      return t;</a>
<a name="ln690">    }</a>
<a name="ln691">    </a>
<a name="ln692">    lua_pop(L, 3);</a>
<a name="ln693">    lua_pushfstring(L, &quot;luaA_struct_typeof_member: Member name '%s' not registered for struct '%s'!&quot;, member, luaA_typename(L, type));</a>
<a name="ln694">    lua_error(L);</a>
<a name="ln695"> </a>
<a name="ln696">  }</a>
<a name="ln697">  </a>
<a name="ln698">  lua_pop(L, 2);</a>
<a name="ln699">  lua_pushfstring(L, &quot;luaA_struct_typeof_member: Struct '%s' not registered!&quot;, luaA_typename(L, type));</a>
<a name="ln700">  lua_error(L);</a>
<a name="ln701">  return 0;</a>
<a name="ln702">  </a>
<a name="ln703">}</a>
<a name="ln704"> </a>
<a name="ln705">void luaA_struct_type(lua_State* L, luaA_Type type) {</a>
<a name="ln706">  lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;structs&quot;);</a>
<a name="ln707">  lua_pushinteger(L, type);</a>
<a name="ln708">  lua_newtable(L);</a>
<a name="ln709">  lua_settable(L, -3);</a>
<a name="ln710">  lua_pop(L, 1);</a>
<a name="ln711">  </a>
<a name="ln712">  lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;structs_offset&quot;);</a>
<a name="ln713">  lua_pushinteger(L, type);</a>
<a name="ln714">  lua_newtable(L);</a>
<a name="ln715">  lua_settable(L, -3);</a>
<a name="ln716">  lua_pop(L, 1);</a>
<a name="ln717">}</a>
<a name="ln718"> </a>
<a name="ln719">void luaA_struct_member_type(lua_State* L, luaA_Type type, const char* member, luaA_Type mtype, size_t offset) {</a>
<a name="ln720"> </a>
<a name="ln721">  lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;structs&quot;);</a>
<a name="ln722">  lua_pushinteger(L, type);</a>
<a name="ln723">  lua_gettable(L, -2);</a>
<a name="ln724">  </a>
<a name="ln725">  if (!lua_isnil(L, -1)) {</a>
<a name="ln726">    </a>
<a name="ln727">    lua_newtable(L);</a>
<a name="ln728">    </a>
<a name="ln729">    lua_pushinteger(L, mtype);  lua_setfield(L, -2, &quot;type&quot;);</a>
<a name="ln730">    lua_pushinteger(L, offset); lua_setfield(L, -2, &quot;offset&quot;);</a>
<a name="ln731">    lua_pushstring(L, member);  lua_setfield(L, -2, &quot;name&quot;);</a>
<a name="ln732">    </a>
<a name="ln733">    lua_setfield(L, -2, member);</a>
<a name="ln734">    </a>
<a name="ln735">    lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;structs_offset&quot;);</a>
<a name="ln736">    lua_pushinteger(L, type);</a>
<a name="ln737">    lua_gettable(L, -2);</a>
<a name="ln738"> </a>
<a name="ln739">    lua_pushinteger(L, offset);</a>
<a name="ln740">    lua_getfield(L, -4, member);</a>
<a name="ln741">    lua_settable(L, -3);</a>
<a name="ln742">    lua_pop(L, 4);</a>
<a name="ln743">    return;</a>
<a name="ln744">  }</a>
<a name="ln745">  </a>
<a name="ln746">  lua_pop(L, 2);</a>
<a name="ln747">  lua_pushfstring(L, &quot;luaA_struct_member: Struct '%s' not registered!&quot;, luaA_typename(L, type));</a>
<a name="ln748">  lua_error(L);</a>
<a name="ln749">}</a>
<a name="ln750"> </a>
<a name="ln751">bool luaA_struct_registered_type(lua_State* L, luaA_Type type) {</a>
<a name="ln752"> </a>
<a name="ln753">  lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;structs&quot;);</a>
<a name="ln754">  lua_pushinteger(L, type);</a>
<a name="ln755">  lua_gettable(L, -2);</a>
<a name="ln756">  </a>
<a name="ln757">  bool reg = !lua_isnil(L, -1);</a>
<a name="ln758">  lua_pop(L, 2);</a>
<a name="ln759">  </a>
<a name="ln760">  return reg;</a>
<a name="ln761">}</a>
<a name="ln762"> </a>
<a name="ln763">int luaA_struct_push_type(lua_State* L, luaA_Type type, const void* c_in) {</a>
<a name="ln764"> </a>
<a name="ln765">  lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;structs&quot;);</a>
<a name="ln766">  lua_pushinteger(L, type);</a>
<a name="ln767">  lua_gettable(L, -2);</a>
<a name="ln768"> </a>
<a name="ln769">  if (!lua_isnil(L, -1)) {</a>
<a name="ln770">    lua_remove(L, -2);    </a>
<a name="ln771">    lua_newtable(L);</a>
<a name="ln772"> </a>
<a name="ln773">    lua_pushnil(L);</a>
<a name="ln774">    while (lua_next(L, -3)) {</a>
<a name="ln775">      </a>
<a name="ln776">      if (lua_type(L, -2) == LUA_TSTRING) {</a>
<a name="ln777">        lua_getfield(L, -1, &quot;name&quot;);</a>
<a name="ln778">        const char* name = lua_tostring(L, -1);</a>
<a name="ln779">        lua_pop(L, 1);</a>
<a name="ln780">        int num = luaA_struct_push_member_name_type(L, type, name, c_in);</a>
<a name="ln781">        if (num &gt; 1) {</a>
<a name="ln782">          lua_pop(L, 5);</a>
<a name="ln783">          lua_pushfstring(L, &quot;luaA_struct_push: Conversion pushed %d values to stack,&quot;</a>
<a name="ln784">                             &quot; don't know how to include in struct!&quot;, num);</a>
<a name="ln785">          lua_error(L);</a>
<a name="ln786">        }</a>
<a name="ln787">        lua_remove(L, -2);</a>
<a name="ln788">        lua_pushvalue(L, -2);</a>
<a name="ln789">        lua_insert(L, -2);</a>
<a name="ln790">        lua_settable(L, -4);</a>
<a name="ln791">      } else {</a>
<a name="ln792">        lua_pop(L, 1);</a>
<a name="ln793">      }</a>
<a name="ln794"> </a>
<a name="ln795">    }</a>
<a name="ln796">    </a>
<a name="ln797">    lua_remove(L, -2);</a>
<a name="ln798">    return 1;</a>
<a name="ln799">  }</a>
<a name="ln800">  </a>
<a name="ln801">  lua_pop(L, 2);</a>
<a name="ln802">  lua_pushfstring(L, &quot;lua_struct_push: Struct '%s' not registered!&quot;, luaA_typename(L, type));</a>
<a name="ln803">  lua_error(L);</a>
<a name="ln804">  return 0;</a>
<a name="ln805">}</a>
<a name="ln806"> </a>
<a name="ln807">void luaA_struct_to_type(lua_State* L, luaA_Type type, void* c_out, int index) {</a>
<a name="ln808">  </a>
<a name="ln809">  lua_pushnil(L);</a>
<a name="ln810">  while (lua_next(L, index-1)) {</a>
<a name="ln811">    </a>
<a name="ln812">    if (lua_type(L, -2) == LUA_TSTRING) {</a>
<a name="ln813">      luaA_struct_to_member_name_type(L, type, lua_tostring(L, -2), c_out, -1);</a>
<a name="ln814">    }</a>
<a name="ln815">    </a>
<a name="ln816">    lua_pop(L, 1);</a>
<a name="ln817">  }</a>
<a name="ln818"> </a>
<a name="ln819">}</a>
<a name="ln820"> </a>
<a name="ln821">const char* luaA_struct_next_member_name_type(lua_State* L, luaA_Type type, const char* member) {</a>
<a name="ln822"> </a>
<a name="ln823">  lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;structs&quot;);</a>
<a name="ln824">  lua_pushinteger(L, type);</a>
<a name="ln825">  lua_gettable(L, -2);</a>
<a name="ln826">  </a>
<a name="ln827">  if(!lua_isnil(L,-1)) {</a>
<a name="ln828"> </a>
<a name="ln829">    if(!member) {</a>
<a name="ln830">      lua_pushnil(L);</a>
<a name="ln831">    } else {</a>
<a name="ln832">      lua_pushstring(L,member);</a>
<a name="ln833">    }</a>
<a name="ln834">    if(!lua_next(L,-2)) {</a>
<a name="ln835">      lua_pop(L,2);</a>
<a name="ln836">      return LUAA_INVALID_MEMBER_NAME;</a>
<a name="ln837">    }</a>
<a name="ln838">    const char* result = lua_tostring(L,-2);</a>
<a name="ln839">    lua_pop(L,4);</a>
<a name="ln840">    return result;</a>
<a name="ln841">  }</a>
<a name="ln842">  </a>
<a name="ln843">  lua_pop(L, 2);</a>
<a name="ln844">  lua_pushfstring(L, &quot;luaA_struct_next_member: Struct '%s' not registered!&quot;, luaA_typename(L, type));</a>
<a name="ln845">  lua_error(L);</a>
<a name="ln846">  return NULL;</a>
<a name="ln847">}</a>
<a name="ln848"> </a>
<a name="ln849">/*</a>
<a name="ln850">** Enums</a>
<a name="ln851">*/</a>
<a name="ln852"> </a>
<a name="ln853">int luaA_enum_push_type(lua_State *L, luaA_Type type, const void* value) {</a>
<a name="ln854">  </a>
<a name="ln855">  lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;enums_values&quot;);</a>
<a name="ln856">  lua_pushinteger(L, type);</a>
<a name="ln857">  lua_gettable(L, -2);</a>
<a name="ln858">  </a>
<a name="ln859">  if (!lua_isnil(L, -1)) {</a>
<a name="ln860">    </a>
<a name="ln861">    lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;enums_sizes&quot;);</a>
<a name="ln862">    lua_pushinteger(L, type);</a>
<a name="ln863">    lua_gettable(L, -2);</a>
<a name="ln864">    size_t size = lua_tointeger(L, -1);</a>
<a name="ln865">    lua_pop(L, 2);</a>
<a name="ln866">    </a>
<a name="ln867">    lua_Integer lvalue =0;</a>
<a name="ln868">    memcpy(&amp;lvalue, value, size);</a>
<a name="ln869">    </a>
<a name="ln870">    lua_pushinteger(L, lvalue);</a>
<a name="ln871">    lua_gettable(L, -2);</a>
<a name="ln872">    </a>
<a name="ln873">    if (!lua_isnil(L, -1)) {</a>
<a name="ln874">      lua_getfield(L, -1, &quot;name&quot;);</a>
<a name="ln875">      lua_remove(L, -2);</a>
<a name="ln876">      lua_remove(L, -2);</a>
<a name="ln877">      lua_remove(L, -2);</a>
<a name="ln878">      return 1;</a>
<a name="ln879">    }</a>
<a name="ln880">    </a>
<a name="ln881">    lua_pop(L, 3);</a>
<a name="ln882">    lua_pushfstring(L, &quot;luaA_enum_push: Enum '%s' value %d not registered!&quot;, luaA_typename(L, type), lvalue);</a>
<a name="ln883">    lua_error(L);</a>
<a name="ln884">    return 0;</a>
<a name="ln885">  }</a>
<a name="ln886">  </a>
<a name="ln887">  lua_pop(L, 2);</a>
<a name="ln888">  lua_pushfstring(L, &quot;luaA_enum_push: Enum '%s' not registered!&quot;, luaA_typename(L, type));</a>
<a name="ln889">  lua_error(L);</a>
<a name="ln890">  return 0;</a>
<a name="ln891">  </a>
<a name="ln892">}</a>
<a name="ln893"> </a>
<a name="ln894">void luaA_enum_to_type(lua_State* L, luaA_Type type, void* c_out, int index) {</a>
<a name="ln895"> </a>
<a name="ln896">  const char* name = lua_tostring(L, index);</a>
<a name="ln897">  </a>
<a name="ln898">  lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;enums&quot;);</a>
<a name="ln899">  lua_pushinteger(L, type);</a>
<a name="ln900">  lua_gettable(L, -2);</a>
<a name="ln901">  </a>
<a name="ln902">  if (!lua_isnil(L, -1)) {</a>
<a name="ln903">    </a>
<a name="ln904">    lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;enums_sizes&quot;);</a>
<a name="ln905">    lua_pushinteger(L, type);</a>
<a name="ln906">    lua_gettable(L, -2);</a>
<a name="ln907">    size_t size = lua_tointeger(L, -1);</a>
<a name="ln908">    lua_pop(L, 2);</a>
<a name="ln909">    </a>
<a name="ln910">    lua_pushstring(L, name);</a>
<a name="ln911">    lua_gettable(L, -2);</a>
<a name="ln912">    </a>
<a name="ln913">    if (!lua_isnil(L, -1)) {</a>
<a name="ln914">      lua_getfield(L, -1, &quot;value&quot;);</a>
<a name="ln915">      lua_Integer value = lua_tointeger(L, -1);</a>
<a name="ln916">      lua_pop(L, 4);</a>
<a name="ln917">      memcpy(c_out, &amp;value, size);</a>
<a name="ln918">      return;</a>
<a name="ln919">    }</a>
<a name="ln920">    </a>
<a name="ln921">    lua_pop(L, 3);</a>
<a name="ln922">    lua_pushfstring(L, &quot;luaA_enum_to: Enum '%s' field '%s' not registered!&quot;, luaA_typename(L, type), name);</a>
<a name="ln923">    lua_error(L);</a>
<a name="ln924">    return;</a>
<a name="ln925">  }</a>
<a name="ln926">  </a>
<a name="ln927">  lua_pop(L, 3);</a>
<a name="ln928">  lua_pushfstring(L, &quot;luaA_enum_to: Enum '%s' not registered!&quot;, luaA_typename(L, type));</a>
<a name="ln929">  lua_error(L);</a>
<a name="ln930">  return;</a>
<a name="ln931">}</a>
<a name="ln932"> </a>
<a name="ln933">bool luaA_enum_has_value_type(lua_State* L, luaA_Type type, const void* value) {</a>
<a name="ln934"> </a>
<a name="ln935">  lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;enums_values&quot;);</a>
<a name="ln936">  lua_pushinteger(L, type);</a>
<a name="ln937">  lua_gettable(L, -2);</a>
<a name="ln938">  </a>
<a name="ln939">  if (!lua_isnil(L, -1)) {</a>
<a name="ln940">    </a>
<a name="ln941">    lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;enums_sizes&quot;);</a>
<a name="ln942">    lua_pushinteger(L, type);</a>
<a name="ln943">    lua_gettable(L, -2);</a>
<a name="ln944">    size_t size = lua_tointeger(L, -1);</a>
<a name="ln945">    lua_pop(L, 2);</a>
<a name="ln946">    </a>
<a name="ln947">    lua_Integer lvalue = 0;</a>
<a name="ln948">    memcpy(&amp;lvalue, value, size);</a>
<a name="ln949">    </a>
<a name="ln950">    lua_pushinteger(L, lvalue);</a>
<a name="ln951">    lua_gettable(L, -2);</a>
<a name="ln952">    </a>
<a name="ln953">    if (lua_isnil(L, -1)) {</a>
<a name="ln954">      lua_pop(L, 3);</a>
<a name="ln955">      return false;</a>
<a name="ln956">    } else {</a>
<a name="ln957">      lua_pop(L, 3);</a>
<a name="ln958">      return true;</a>
<a name="ln959">    }</a>
<a name="ln960">    </a>
<a name="ln961">  }</a>
<a name="ln962">  </a>
<a name="ln963">  lua_pop(L, 2);</a>
<a name="ln964">  lua_pushfstring(L, &quot;luaA_enum_has_value: Enum '%s' not registered!&quot;, luaA_typename(L, type));</a>
<a name="ln965">  lua_error(L);</a>
<a name="ln966">  return false;</a>
<a name="ln967">}</a>
<a name="ln968"> </a>
<a name="ln969">bool luaA_enum_has_name_type(lua_State* L, luaA_Type type, const char* name) {</a>
<a name="ln970">  lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;enums&quot;);</a>
<a name="ln971">  lua_pushinteger(L, type);</a>
<a name="ln972">  lua_gettable(L, -2);</a>
<a name="ln973">  </a>
<a name="ln974">  if (!lua_isnil(L, -1)) {</a>
<a name="ln975">    </a>
<a name="ln976">    lua_getfield(L, -1, name);</a>
<a name="ln977">    </a>
<a name="ln978">    if (lua_isnil(L, -1)) {</a>
<a name="ln979">      lua_pop(L, 3);</a>
<a name="ln980">      return false;</a>
<a name="ln981">    } else {</a>
<a name="ln982">      lua_pop(L, 3);</a>
<a name="ln983">      return true;</a>
<a name="ln984">    }</a>
<a name="ln985">    </a>
<a name="ln986">  }</a>
<a name="ln987">  </a>
<a name="ln988">  lua_pop(L, 2);</a>
<a name="ln989">  lua_pushfstring(L, &quot;luaA_enum_has_name: Enum '%s' not registered!&quot;, luaA_typename(L, type));</a>
<a name="ln990">  lua_error(L);</a>
<a name="ln991">  return false;</a>
<a name="ln992">}</a>
<a name="ln993"> </a>
<a name="ln994">void luaA_enum_type(lua_State *L, luaA_Type type, size_t size) {</a>
<a name="ln995">  lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;enums&quot;);</a>
<a name="ln996">  lua_pushinteger(L, type);</a>
<a name="ln997">  lua_newtable(L);</a>
<a name="ln998">  lua_settable(L, -3);</a>
<a name="ln999">  lua_pop(L, 1);</a>
<a name="ln1000">  </a>
<a name="ln1001">  lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;enums_values&quot;);</a>
<a name="ln1002">  lua_pushinteger(L, type);</a>
<a name="ln1003">  lua_newtable(L);</a>
<a name="ln1004">  lua_settable(L, -3);</a>
<a name="ln1005">  lua_pop(L, 1);</a>
<a name="ln1006">  </a>
<a name="ln1007">  lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;enums_sizes&quot;);</a>
<a name="ln1008">  lua_pushinteger(L, type);</a>
<a name="ln1009">  lua_pushinteger(L, size);</a>
<a name="ln1010">  lua_settable(L, -3);</a>
<a name="ln1011">  lua_pop(L, 1);</a>
<a name="ln1012">}</a>
<a name="ln1013"> </a>
<a name="ln1014">void luaA_enum_value_type(lua_State *L, luaA_Type type, const void* value, const char* name) {</a>
<a name="ln1015">  </a>
<a name="ln1016">  lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;enums&quot;);</a>
<a name="ln1017">  lua_pushinteger(L, type);</a>
<a name="ln1018">  lua_gettable(L, -2);</a>
<a name="ln1019">  </a>
<a name="ln1020">  if (!lua_isnil(L, -1)) {</a>
<a name="ln1021">  </a>
<a name="ln1022">    lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;enums_sizes&quot;);</a>
<a name="ln1023">    lua_pushinteger(L, type);</a>
<a name="ln1024">    lua_gettable(L, -2);</a>
<a name="ln1025">    size_t size = lua_tointeger(L, -1);</a>
<a name="ln1026">    lua_pop(L, 2);</a>
<a name="ln1027">    </a>
<a name="ln1028">    lua_newtable(L);</a>
<a name="ln1029">    </a>
<a name="ln1030">    lua_Integer lvalue=0;</a>
<a name="ln1031">    memcpy(&amp;lvalue, value, size);</a>
<a name="ln1032">    </a>
<a name="ln1033">    lua_pushinteger(L, lvalue);</a>
<a name="ln1034">    lua_setfield(L, -2, &quot;value&quot;);</a>
<a name="ln1035">    </a>
<a name="ln1036">    lua_pushstring(L, name);</a>
<a name="ln1037">    lua_setfield(L, -2, &quot;name&quot;);</a>
<a name="ln1038">    </a>
<a name="ln1039">    lua_setfield(L, -2, name);</a>
<a name="ln1040"> </a>
<a name="ln1041">    lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;enums_values&quot;);</a>
<a name="ln1042">    lua_pushinteger(L, type);</a>
<a name="ln1043">    lua_gettable(L, -2);</a>
<a name="ln1044">    lua_pushinteger(L, lvalue);</a>
<a name="ln1045">    lua_getfield(L, -4, name);</a>
<a name="ln1046">    lua_settable(L, -3);</a>
<a name="ln1047">    </a>
<a name="ln1048">    lua_pop(L, 4);</a>
<a name="ln1049">    return;</a>
<a name="ln1050">    </a>
<a name="ln1051">  }</a>
<a name="ln1052">    </a>
<a name="ln1053">  lua_pop(L, 2);</a>
<a name="ln1054">  lua_pushfstring(L, &quot;luaA_enum_value: Enum '%s' not registered!&quot;, luaA_typename(L, type));</a>
<a name="ln1055">  lua_error(L);</a>
<a name="ln1056">}</a>
<a name="ln1057"> </a>
<a name="ln1058">bool luaA_enum_registered_type(lua_State *L, luaA_Type type){</a>
<a name="ln1059">  lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;enums&quot;);</a>
<a name="ln1060">  lua_pushinteger(L, type);</a>
<a name="ln1061">  lua_gettable(L, -2);</a>
<a name="ln1062">  bool reg = !lua_isnil(L, -1);</a>
<a name="ln1063">  lua_pop(L, 2);</a>
<a name="ln1064">  return reg;</a>
<a name="ln1065">}</a>
<a name="ln1066"> </a>
<a name="ln1067">const char* luaA_enum_next_value_name_type(lua_State* L, luaA_Type type, const char* member) {</a>
<a name="ln1068"> </a>
<a name="ln1069">  lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;enums&quot;);</a>
<a name="ln1070">  lua_pushinteger(L, type);</a>
<a name="ln1071">  lua_gettable(L, -2);</a>
<a name="ln1072">  </a>
<a name="ln1073">  if(!lua_isnil(L,-1)) {</a>
<a name="ln1074"> </a>
<a name="ln1075">    if(!member) {</a>
<a name="ln1076">      lua_pushnil(L);</a>
<a name="ln1077">    } else {</a>
<a name="ln1078">      lua_pushstring(L,member);</a>
<a name="ln1079">    }</a>
<a name="ln1080">    if(!lua_next(L,-2)) {</a>
<a name="ln1081">      lua_pop(L,2);</a>
<a name="ln1082">      return LUAA_INVALID_MEMBER_NAME;</a>
<a name="ln1083">    }</a>
<a name="ln1084">    const char* result = lua_tostring(L,-2);</a>
<a name="ln1085">    lua_pop(L,4);</a>
<a name="ln1086">    return result;</a>
<a name="ln1087">  }</a>
<a name="ln1088">  </a>
<a name="ln1089">  lua_pop(L, 2);</a>
<a name="ln1090">  lua_pushfstring(L, &quot;luaA_enum_next_enum_name_type: Enum '%s' not registered!&quot;, luaA_typename(L, type));</a>
<a name="ln1091">  lua_error(L);</a>
<a name="ln1092">  return NULL;</a>
<a name="ln1093">}</a>
<a name="ln1094"> </a>
<a name="ln1095">/*</a>
<a name="ln1096">** Functions</a>
<a name="ln1097">*/</a>
<a name="ln1098"> </a>
<a name="ln1099">static int luaA_call_entry(lua_State* L) {</a>
<a name="ln1100">  </a>
<a name="ln1101">  /* Get return size */</a>
<a name="ln1102">  </a>
<a name="ln1103">  lua_getfield(L, -1, &quot;ret_type&quot;);</a>
<a name="ln1104">  luaA_Type ret_type = lua_tointeger(L, -1);</a>
<a name="ln1105">  lua_pop(L, 1);</a>
<a name="ln1106">  </a>
<a name="ln1107">  size_t ret_size = luaA_typesize(L, ret_type);</a>
<a name="ln1108">  </a>
<a name="ln1109">  /* Get total arguments sizes */</a>
<a name="ln1110">  </a>
<a name="ln1111">  lua_getfield(L, -1, &quot;arg_types&quot;);</a>
<a name="ln1112">  </a>
<a name="ln1113">  size_t arg_size = 0;</a>
<a name="ln1114">  size_t arg_num  = lua_rawlen(L, -1);</a>
<a name="ln1115">  for (int i = 0; i &lt; arg_num; i++) {</a>
<a name="ln1116">    lua_pushinteger(L, i+1);</a>
<a name="ln1117">    lua_gettable(L, -2);</a>
<a name="ln1118">    luaA_Type arg_type = lua_tointeger(L, -1);</a>
<a name="ln1119">    lua_pop(L, 1);</a>
<a name="ln1120">    arg_size += luaA_typesize(L, arg_type);</a>
<a name="ln1121">  }</a>
<a name="ln1122">  </a>
<a name="ln1123">  lua_pop(L, 1);</a>
<a name="ln1124">  </a>
<a name="ln1125">  /* Test to see if using heap */</a>
<a name="ln1126">  </a>
<a name="ln1127">  lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;call_ret_stk&quot;);</a>
<a name="ln1128">  void* ret_stack = lua_touserdata(L, -1);</a>
<a name="ln1129">  lua_pop(L, 1);</a>
<a name="ln1130">  </a>
<a name="ln1131">  lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;call_arg_stk&quot;);</a>
<a name="ln1132">  void* arg_stack = lua_touserdata(L, -1);</a>
<a name="ln1133">  lua_pop(L, 1);</a>
<a name="ln1134">  </a>
<a name="ln1135">  lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;call_ret_ptr&quot;);</a>
<a name="ln1136">  lua_Integer ret_ptr = lua_tointeger(L, -1);</a>
<a name="ln1137">  lua_pop(L, 1);</a>
<a name="ln1138">  </a>
<a name="ln1139">  lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;call_arg_ptr&quot;);</a>
<a name="ln1140">  lua_Integer arg_ptr = lua_tointeger(L, -1);</a>
<a name="ln1141">  lua_pop(L, 1);</a>
<a name="ln1142"> </a>
<a name="ln1143">  void* ret_data = ret_stack + ret_ptr;</a>
<a name="ln1144">  void* arg_data = arg_stack + arg_ptr;</a>
<a name="ln1145">  </a>
<a name="ln1146">  /* If fixed allocation exhausted use heap instead */</a>
<a name="ln1147">  </a>
<a name="ln1148">  bool ret_heap = false;</a>
<a name="ln1149">  bool arg_heap = false;</a>
<a name="ln1150">  </a>
<a name="ln1151">  if (ret_ptr + ret_size &gt; LUAA_RETURN_STACK_SIZE) {</a>
<a name="ln1152">    ret_heap = true;</a>
<a name="ln1153">    ret_data = malloc(ret_size);</a>
<a name="ln1154">    if (ret_data == NULL) {</a>
<a name="ln1155">      lua_pushfstring(L, &quot;luaA_call: Out of memory!&quot;);</a>
<a name="ln1156">      lua_error(L);</a>
<a name="ln1157">      return 0;</a>
<a name="ln1158">    }</a>
<a name="ln1159">  }</a>
<a name="ln1160">  </a>
<a name="ln1161">  if (arg_ptr + arg_size &gt; LUAA_ARGUMENT_STACK_SIZE) {</a>
<a name="ln1162">    arg_heap = true;</a>
<a name="ln1163">    arg_data = malloc(arg_size);</a>
<a name="ln1164">    if (arg_data == NULL) {</a>
<a name="ln1165">      if (ret_heap) {</a>
<a name="ln1166">        free(ret_data);</a>
<a name="ln1167">      }</a>
<a name="ln1168">      lua_pushfstring(L, &quot;luaA_call: Out of memory!&quot;);</a>
<a name="ln1169">      lua_error(L);</a>
<a name="ln1170">      return 0;</a>
<a name="ln1171">    }</a>
<a name="ln1172">  }</a>
<a name="ln1173">  </a>
<a name="ln1174">  /* If not using heap update stack pointers */</a>
<a name="ln1175">  </a>
<a name="ln1176">  if (!ret_heap) {</a>
<a name="ln1177">    lua_pushinteger(L, ret_ptr + ret_size);</a>
<a name="ln1178">    lua_setfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;call_ret_ptr&quot;);</a>
<a name="ln1179">  }</a>
<a name="ln1180">  </a>
<a name="ln1181">  if (!arg_heap) {</a>
<a name="ln1182">    lua_pushinteger(L, arg_ptr + arg_size);</a>
<a name="ln1183">    lua_setfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;call_arg_ptr&quot;);</a>
<a name="ln1184">  }</a>
<a name="ln1185">  </a>
<a name="ln1186">  /* Pop args and place in memory */</a>
<a name="ln1187">  </a>
<a name="ln1188">  lua_getfield(L, -1, &quot;arg_types&quot;);</a>
<a name="ln1189"> </a>
<a name="ln1190">  void* arg_pos = arg_data;</a>
<a name="ln1191">  for (int i = 0; i &lt; arg_num; i++) {</a>
<a name="ln1192">    lua_pushinteger(L, i+1);</a>
<a name="ln1193">    lua_gettable(L, -2);</a>
<a name="ln1194">    luaA_Type arg_type = lua_tointeger(L, -1);</a>
<a name="ln1195">    lua_pop(L, 1);</a>
<a name="ln1196">    luaA_to_type(L, arg_type, arg_pos, -arg_num+i-2);</a>
<a name="ln1197">    arg_pos += luaA_typesize(L, arg_type);</a>
<a name="ln1198">  }</a>
<a name="ln1199">  </a>
<a name="ln1200">  lua_pop(L, 1);</a>
<a name="ln1201">  </a>
<a name="ln1202">  /* Pop arguments from stack */</a>
<a name="ln1203">  </a>
<a name="ln1204">  for (int i = 0; i &lt; arg_num; i++) {</a>
<a name="ln1205">    lua_remove(L, -2);  </a>
<a name="ln1206">  }</a>
<a name="ln1207">  </a>
<a name="ln1208">  /* Get Function Pointer and Call */</a>
<a name="ln1209">  </a>
<a name="ln1210">  lua_getfield(L, -1, &quot;auto_func&quot;);</a>
<a name="ln1211">  luaA_Func auto_func = lua_touserdata(L, -1);</a>
<a name="ln1212">  lua_pop(L, 2);</a>
<a name="ln1213">  </a>
<a name="ln1214">  auto_func(ret_data, arg_data);</a>
<a name="ln1215">  </a>
<a name="ln1216">  int count = luaA_push_type(L, ret_type, ret_data);</a>
<a name="ln1217">  </a>
<a name="ln1218">  /* Either free heap data or reduce stack pointers */</a>
<a name="ln1219">  </a>
<a name="ln1220">  if (!ret_heap) {</a>
<a name="ln1221">    lua_pushinteger(L, ret_ptr);</a>
<a name="ln1222">    lua_setfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;call_ret_ptr&quot;);</a>
<a name="ln1223">  } else {</a>
<a name="ln1224">    free(ret_data);</a>
<a name="ln1225">  }</a>
<a name="ln1226">  </a>
<a name="ln1227">  if (!arg_heap) {</a>
<a name="ln1228">    lua_pushinteger(L, arg_ptr);</a>
<a name="ln1229">    lua_setfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;argument_ptr&quot;);</a>
<a name="ln1230">  } else {</a>
<a name="ln1231">    free(arg_data); </a>
<a name="ln1232">  }</a>
<a name="ln1233">  </a>
<a name="ln1234">  return count;</a>
<a name="ln1235">}</a>
<a name="ln1236"> </a>
<a name="ln1237">int luaA_call(lua_State* L, void* func_ptr) {</a>
<a name="ln1238">  lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;functions&quot;);</a>
<a name="ln1239">  lua_pushlightuserdata(L, func_ptr);</a>
<a name="ln1240">  lua_gettable(L, -2);</a>
<a name="ln1241">  lua_remove(L, -2);</a>
<a name="ln1242">  </a>
<a name="ln1243">  if (!lua_isnil(L, -1)) { return luaA_call_entry(L); }</a>
<a name="ln1244">  </a>
<a name="ln1245">  lua_pop(L, 1);</a>
<a name="ln1246">  lua_pushfstring(L, &quot;luaA_call: Function with address '%p' is not registered!&quot;, func_ptr);</a>
<a name="ln1247">  lua_error(L);</a>
<a name="ln1248">  return 0;</a>
<a name="ln1249">}</a>
<a name="ln1250"> </a>
<a name="ln1251">int luaA_call_name(lua_State* L, const char* func_name) {</a>
<a name="ln1252">  lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;functions&quot;);</a>
<a name="ln1253">  lua_pushstring(L, func_name);</a>
<a name="ln1254">  lua_gettable(L, -2);</a>
<a name="ln1255">  lua_remove(L, -2);</a>
<a name="ln1256">  </a>
<a name="ln1257">  if (!lua_isnil(L, -1)) { return luaA_call_entry(L); }</a>
<a name="ln1258">  </a>
<a name="ln1259">  lua_pop(L, 1);</a>
<a name="ln1260">  lua_pushfstring(L, &quot;luaA_call_name: Function '%s' is not registered!&quot;, func_name);</a>
<a name="ln1261">  lua_error(L);</a>
<a name="ln1262">  return 0;</a>
<a name="ln1263">}</a>
<a name="ln1264"> </a>
<a name="ln1265">void luaA_function_register_type(lua_State* L, void* src_func, luaA_Func auto_func, const char* name, luaA_Type ret_t, int num_args, ...) {</a>
<a name="ln1266">  </a>
<a name="ln1267">  lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;functions&quot;);</a>
<a name="ln1268">  lua_pushstring(L, name);</a>
<a name="ln1269"> </a>
<a name="ln1270">  lua_newtable(L);</a>
<a name="ln1271">  </a>
<a name="ln1272">  lua_pushlightuserdata(L, src_func);  lua_setfield(L, -2, &quot;src_func&quot;);</a>
<a name="ln1273">  lua_pushlightuserdata(L, auto_func); lua_setfield(L, -2, &quot;auto_func&quot;);</a>
<a name="ln1274">  </a>
<a name="ln1275">  lua_pushinteger(L, ret_t);</a>
<a name="ln1276">  lua_setfield(L, -2, &quot;ret_type&quot;);</a>
<a name="ln1277">  </a>
<a name="ln1278">  lua_pushstring(L, &quot;arg_types&quot;);</a>
<a name="ln1279">  lua_newtable(L);</a>
<a name="ln1280">  </a>
<a name="ln1281">  va_list va;</a>
<a name="ln1282">  va_start(va, num_args);</a>
<a name="ln1283">  for (int i = 0; i &lt; num_args; i++) {</a>
<a name="ln1284">    lua_pushinteger(L, i+1);</a>
<a name="ln1285">    lua_pushinteger(L, va_arg(va, luaA_Type));</a>
<a name="ln1286">    lua_settable(L, -3);</a>
<a name="ln1287">  }</a>
<a name="ln1288">  va_end(va);</a>
<a name="ln1289">  </a>
<a name="ln1290">  lua_settable(L, -3);</a>
<a name="ln1291">  lua_settable(L, -3);</a>
<a name="ln1292">  lua_pop(L, 1);</a>
<a name="ln1293">  </a>
<a name="ln1294">  lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;functions&quot;);</a>
<a name="ln1295">  lua_pushlightuserdata(L, src_func);</a>
<a name="ln1296">  </a>
<a name="ln1297">  lua_getfield(L, LUA_REGISTRYINDEX, LUAA_REGISTRYPREFIX &quot;functions&quot;);</a>
<a name="ln1298">  lua_getfield(L, -1, name);</a>
<a name="ln1299">  lua_remove(L, -2);</a>
<a name="ln1300">  </a>
<a name="ln1301">  lua_settable(L, -3);</a>
<a name="ln1302">  lua_pop(L, 1);</a>
<a name="ln1303">  </a>
<a name="ln1304">}</a>

</code></pre>
<div class="balloon" rel="1170"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> The function was exited without releasing the 'ret_data' pointer. A memory leak is possible.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
