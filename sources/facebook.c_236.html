
<html>
<head>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>
<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2">    This file is part of darktable,</a>
<a name="ln3">    copyright (c) 2012 Pierre Lamot</a>
<a name="ln4">    copyright (c) 2015 tobias ellinghaus</a>
<a name="ln5"> </a>
<a name="ln6">    darktable is free software: you can redistribute it and/or modify</a>
<a name="ln7">    it under the terms of the GNU General Public License as published by</a>
<a name="ln8">    the Free Software Foundation, either version 3 of the License, or</a>
<a name="ln9">    (at your option) any later version.</a>
<a name="ln10"> </a>
<a name="ln11">    darktable is distributed in the hope that it will be useful,</a>
<a name="ln12">    but WITHOUT ANY WARRANTY; without even the implied warranty of</a>
<a name="ln13">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</a>
<a name="ln14">    GNU General Public License for more details.</a>
<a name="ln15"> </a>
<a name="ln16">    You should have received a copy of the GNU General Public License</a>
<a name="ln17">    along with darktable.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</a>
<a name="ln18">*/</a>
<a name="ln19"> </a>
<a name="ln20">#include &quot;common/darktable.h&quot;</a>
<a name="ln21">#include &quot;common/image.h&quot;</a>
<a name="ln22">#include &quot;common/image_cache.h&quot;</a>
<a name="ln23">#include &quot;common/imageio.h&quot;</a>
<a name="ln24">#include &quot;common/imageio_module.h&quot;</a>
<a name="ln25">#include &quot;common/metadata.h&quot;</a>
<a name="ln26">#include &quot;common/pwstorage/pwstorage.h&quot;</a>
<a name="ln27">#include &quot;common/tags.h&quot;</a>
<a name="ln28">#include &quot;control/conf.h&quot;</a>
<a name="ln29">#include &quot;control/control.h&quot;</a>
<a name="ln30">#include &quot;dtgtk/button.h&quot;</a>
<a name="ln31">#include &quot;gui/gtk.h&quot;</a>
<a name="ln32">#include &quot;imageio/storage/imageio_storage_api.h&quot;</a>
<a name="ln33">#ifdef GDK_WINDOWING_QUARTZ</a>
<a name="ln34">#include &quot;osx/osx.h&quot;</a>
<a name="ln35">#endif</a>
<a name="ln36">#include &lt;curl/curl.h&gt;</a>
<a name="ln37">#include &lt;json-glib/json-glib.h&gt;</a>
<a name="ln38">#include &lt;stdio.h&gt;</a>
<a name="ln39">#include &lt;stdlib.h&gt;</a>
<a name="ln40">#include &lt;unistd.h&gt;</a>
<a name="ln41"> </a>
<a name="ln42">#ifdef HAVE_HTTP_SERVER</a>
<a name="ln43">#include &quot;common/http_server.h&quot;</a>
<a name="ln44">static const int port_pool[] = { 8123, 9123, 10123, 11123 };</a>
<a name="ln45">static const int n_ports = sizeof(port_pool) / sizeof(port_pool[0]);</a>
<a name="ln46">#endif</a>
<a name="ln47"> </a>
<a name="ln48">DT_MODULE(1)</a>
<a name="ln49"> </a>
<a name="ln50">#define FB_CALLBACK_ID &quot;facebook&quot;</a>
<a name="ln51">#define FB_WS_BASE_URL &quot;https://www.facebook.com/&quot;</a>
<a name="ln52">#define FB_GRAPH_BASE_URL &quot;https://graph.facebook.com/v2.8/&quot;</a>
<a name="ln53">#define FB_API_KEY &quot;315766121847254&quot;</a>
<a name="ln54"> </a>
<a name="ln55">// facebook doesn't allow pictures bigger than FB_IMAGE_MAX_SIZExFB_IMAGE_MAX_SIZE px</a>
<a name="ln56">#define FB_IMAGE_MAX_SIZE 2048</a>
<a name="ln57"> </a>
<a name="ln58">#define MSGCOLOR_RED &quot;#e07f7f&quot;</a>
<a name="ln59">#define MSGCOLOR_GREEN &quot;#7fe07f&quot;</a>
<a name="ln60"> </a>
<a name="ln61">typedef enum ComboUserModel</a>
<a name="ln62">{</a>
<a name="ln63">  COMBO_USER_MODEL_NAME_COL = 0,</a>
<a name="ln64">  COMBO_USER_MODEL_TOKEN_COL,</a>
<a name="ln65">  COMBO_USER_MODEL_ID_COL,</a>
<a name="ln66">  COMBO_USER_MODEL_NB_COL</a>
<a name="ln67">} ComboUserModel;</a>
<a name="ln68"> </a>
<a name="ln69">typedef enum ComboAlbumModel</a>
<a name="ln70">{</a>
<a name="ln71">  COMBO_ALBUM_MODEL_NAME_COL = 0,</a>
<a name="ln72">  COMBO_ALBUM_MODEL_ID_COL,</a>
<a name="ln73">  COMBO_ALBUM_MODEL_NB_COL</a>
<a name="ln74">} ComboAlbumModel;</a>
<a name="ln75"> </a>
<a name="ln76">typedef enum ComboPrivacyModel</a>
<a name="ln77">{</a>
<a name="ln78">  COMBO_PRIVACY_MODEL_NAME_COL = 0,</a>
<a name="ln79">  COMBO_PRIVACY_MODEL_VAL_COL,</a>
<a name="ln80">  COMBO_PRIVACY_MODEL_NB_COL</a>
<a name="ln81">} ComboPrivacyModel;</a>
<a name="ln82"> </a>
<a name="ln83"> </a>
<a name="ln84">/*</a>
<a name="ln85"> * note: we don't support some kinds of privacy setting:</a>
<a name="ln86"> *  CUSTOM : no plan to do this one for the moment</a>
<a name="ln87"> *  NETWORKS_FRIENDS : this seems to be deprecated, it is currently impossible</a>
<a name="ln88"> *      to create a new network (https://www.facebook.com/help/networks)</a>
<a name="ln89"> */</a>
<a name="ln90">typedef enum FBAlbumPrivacyPolicy</a>
<a name="ln91">{</a>
<a name="ln92">  FBALBUM_PRIVACY_EVERYONE,</a>
<a name="ln93">  FBALBUM_PRIVACY_ALL_FRIENDS,</a>
<a name="ln94">  FBALBUM_PRIVACY_NETWORKS_FRIENDS, // not implemented</a>
<a name="ln95">  FBALBUM_PRIVACY_FRIENDS_OF_FRIENDS,</a>
<a name="ln96">  FBALBUM_PRIVACY_SELF,</a>
<a name="ln97">  FBALBUM_PRIVACY_CUSTOM // not implemented</a>
<a name="ln98">} FBAlbumPrivacyPolicy;</a>
<a name="ln99"> </a>
<a name="ln100"> </a>
<a name="ln101">/**</a>
<a name="ln102"> * Represents information about an album</a>
<a name="ln103"> */</a>
<a name="ln104">typedef struct FBAlbum</a>
<a name="ln105">{</a>
<a name="ln106">  gchar *id;</a>
<a name="ln107">  gchar *name;</a>
<a name="ln108">  FBAlbumPrivacyPolicy privacy;</a>
<a name="ln109">} FBAlbum;</a>
<a name="ln110"> </a>
<a name="ln111">static FBAlbum *fb_album_init()</a>
<a name="ln112">{</a>
<a name="ln113">  return (FBAlbum *)g_malloc0(sizeof(FBAlbum));</a>
<a name="ln114">}</a>
<a name="ln115"> </a>
<a name="ln116">static void fb_album_destroy(FBAlbum *album)</a>
<a name="ln117">{</a>
<a name="ln118">  if(album == NULL) return;</a>
<a name="ln119">  g_free(album-&gt;id);</a>
<a name="ln120">  g_free(album-&gt;name);</a>
<a name="ln121">  g_free(album);</a>
<a name="ln122">}</a>
<a name="ln123"> </a>
<a name="ln124">/**</a>
<a name="ln125"> * Represents information about an account</a>
<a name="ln126"> */</a>
<a name="ln127">typedef struct FBAccountInfo</a>
<a name="ln128">{</a>
<a name="ln129">  gchar *id;</a>
<a name="ln130">  gchar *readablename;</a>
<a name="ln131">  gchar *token;</a>
<a name="ln132">} FBAccountInfo;</a>
<a name="ln133"> </a>
<a name="ln134">static FBAccountInfo *fb_account_info_init()</a>
<a name="ln135">{</a>
<a name="ln136">  return (FBAccountInfo *)g_malloc0(sizeof(FBAccountInfo));</a>
<a name="ln137">}</a>
<a name="ln138"> </a>
<a name="ln139">static void fb_account_info_destroy(FBAccountInfo *account)</a>
<a name="ln140">{</a>
<a name="ln141">  if(account == NULL) return;</a>
<a name="ln142">  g_free(account-&gt;id);</a>
<a name="ln143">  g_free(account-&gt;readablename);</a>
<a name="ln144">  g_free(account-&gt;token);</a>
<a name="ln145">  g_free(account);</a>
<a name="ln146">}</a>
<a name="ln147"> </a>
<a name="ln148">typedef struct FBContext</a>
<a name="ln149">{</a>
<a name="ln150">  /// curl context</a>
<a name="ln151">  CURL *curl_ctx;</a>
<a name="ln152">  /// Json parser context</a>
<a name="ln153">  JsonParser *json_parser;</a>
<a name="ln154"> </a>
<a name="ln155">  GString *errmsg;</a>
<a name="ln156"> </a>
<a name="ln157">  /// authorization token</a>
<a name="ln158">  gchar *token;</a>
<a name="ln159"> </a>
<a name="ln160">  gchar *album_id;</a>
<a name="ln161">  char *album_title;</a>
<a name="ln162">  char *album_summary;</a>
<a name="ln163">  int album_permission;</a>
<a name="ln164">  gboolean new_album;</a>
<a name="ln165">} FBContext;</a>
<a name="ln166"> </a>
<a name="ln167">typedef struct dt_storage_facebook_gui_data_t</a>
<a name="ln168">{</a>
<a name="ln169">  // == ui elements ==</a>
<a name="ln170">  GtkLabel *label_status;</a>
<a name="ln171"> </a>
<a name="ln172">  GtkComboBox *comboBox_username;</a>
<a name="ln173">  GtkButton *button_login;</a>
<a name="ln174"> </a>
<a name="ln175">  GtkDarktableButton *dtbutton_refresh_album;</a>
<a name="ln176">  GtkComboBox *comboBox_album;</a>
<a name="ln177"> </a>
<a name="ln178">  //  == album creation section ==</a>
<a name="ln179">  GtkLabel *label_album_title;</a>
<a name="ln180">  GtkLabel *label_album_summary;</a>
<a name="ln181">  GtkLabel *label_album_privacy;</a>
<a name="ln182"> </a>
<a name="ln183">  GtkEntry *entry_album_title;</a>
<a name="ln184">  GtkEntry *entry_album_summary;</a>
<a name="ln185">  GtkComboBox *comboBox_privacy;</a>
<a name="ln186"> </a>
<a name="ln187">  GtkBox *hbox_album;</a>
<a name="ln188"> </a>
<a name="ln189">  // == context ==</a>
<a name="ln190">  gboolean connected;</a>
<a name="ln191">  FBContext *facebook_api;</a>
<a name="ln192"> </a>
<a name="ln193">  // == authentication dialog ==</a>
<a name="ln194">  GtkMessageDialog *auth_dialog;</a>
<a name="ln195">} dt_storage_facebook_gui_data_t;</a>
<a name="ln196"> </a>
<a name="ln197"> </a>
<a name="ln198">static FBContext *fb_api_init()</a>
<a name="ln199">{</a>
<a name="ln200">  FBContext *ctx = (FBContext *)g_malloc0(sizeof(FBContext));</a>
<a name="ln201">  ctx-&gt;curl_ctx = curl_easy_init();</a>
<a name="ln202">  ctx-&gt;errmsg = g_string_new(&quot;&quot;);</a>
<a name="ln203">  ctx-&gt;json_parser = json_parser_new();</a>
<a name="ln204">  return ctx;</a>
<a name="ln205">}</a>
<a name="ln206"> </a>
<a name="ln207"> </a>
<a name="ln208">static void fb_api_destroy(FBContext *ctx)</a>
<a name="ln209">{</a>
<a name="ln210">  if(ctx == NULL) return;</a>
<a name="ln211">  curl_easy_cleanup(ctx-&gt;curl_ctx);</a>
<a name="ln212">  g_free(ctx-&gt;token);</a>
<a name="ln213">  g_object_unref(ctx-&gt;json_parser);</a>
<a name="ln214">  g_string_free(ctx-&gt;errmsg, TRUE);</a>
<a name="ln215">  g_free(ctx);</a>
<a name="ln216">}</a>
<a name="ln217"> </a>
<a name="ln218"> </a>
<a name="ln219">typedef struct dt_storage_facebook_param_t</a>
<a name="ln220">{</a>
<a name="ln221">  gint64 hash;</a>
<a name="ln222">  FBContext *facebook_ctx;</a>
<a name="ln223">} dt_storage_facebook_param_t;</a>
<a name="ln224"> </a>
<a name="ln225"> </a>
<a name="ln226">//////////////////////////// curl requests related functions</a>
<a name="ln227"> </a>
<a name="ln228">/**</a>
<a name="ln229"> * extract the user token from the callback @a url</a>
<a name="ln230"> */</a>
<a name="ln231">static gchar *fb_extract_token_from_url(const gchar *url)</a>
<a name="ln232">{</a>
<a name="ln233">  g_return_val_if_fail((url != NULL), NULL);</a>
<a name="ln234">  if(!(g_str_has_prefix(url, &quot;http://localhost:8123/&quot; FB_CALLBACK_ID) == TRUE)) return NULL;</a>
<a name="ln235"> </a>
<a name="ln236">  char *authtoken = NULL;</a>
<a name="ln237"> </a>
<a name="ln238">  char **urlchunks = g_strsplit_set(url, &quot;#&amp;=&quot;, -1);</a>
<a name="ln239">  // starts at 1 to skip the url prefix, then values are in the form key=value</a>
<a name="ln240">  for(int i = 1; urlchunks[i] != NULL; i += 2)</a>
<a name="ln241">  {</a>
<a name="ln242">    if((g_strcmp0(urlchunks[i], &quot;access_token&quot;) == 0) &amp;&amp; (urlchunks[i + 1] != NULL))</a>
<a name="ln243">    {</a>
<a name="ln244">      authtoken = g_strdup(urlchunks[i + 1]);</a>
<a name="ln245">      break;</a>
<a name="ln246">    }</a>
<a name="ln247">    else if(g_strcmp0(urlchunks[i], &quot;error&quot;) == 0)</a>
<a name="ln248">    {</a>
<a name="ln249">      break;</a>
<a name="ln250">    }</a>
<a name="ln251">    if(urlchunks[i + 1] == NULL) // this shouldn't happens but we never know...</a>
<a name="ln252">    {</a>
<a name="ln253">      g_printerr(_(&quot;[facebook] unexpected URL format\n&quot;));</a>
<a name="ln254">      break;</a>
<a name="ln255">    }</a>
<a name="ln256">  }</a>
<a name="ln257">  g_strfreev(urlchunks);</a>
<a name="ln258">  return authtoken;</a>
<a name="ln259">}</a>
<a name="ln260"> </a>
<a name="ln261">static size_t curl_write_data_cb(void *ptr, size_t size, size_t nmemb, void *data)</a>
<a name="ln262">{</a>
<a name="ln263">  GString *string = (GString *)data;</a>
<a name="ln264">  g_string_append_len(string, ptr, size * nmemb);</a>
<a name="ln265">#ifdef FACEBOOK_EXTRA_VERBOSE</a>
<a name="ln266">  g_printf(&quot;server reply: %s\n&quot;, string-&gt;str);</a>
<a name="ln267">#endif</a>
<a name="ln268">  return size * nmemb;</a>
<a name="ln269">}</a>
<a name="ln270"> </a>
<a name="ln271">static JsonObject *fb_parse_response(FBContext *ctx, GString *response)</a>
<a name="ln272">{</a>
<a name="ln273">  GError *error;</a>
<a name="ln274">  const gboolean ret = json_parser_load_from_data(ctx-&gt;json_parser, response-&gt;str, response-&gt;len, &amp;error);</a>
<a name="ln275">  g_return_val_if_fail((ret), NULL);</a>
<a name="ln276"> </a>
<a name="ln277">  JsonNode *root = json_parser_get_root(ctx-&gt;json_parser);</a>
<a name="ln278">  // we should always have a dict</a>
<a name="ln279">  g_return_val_if_fail((json_node_get_node_type(root) == JSON_NODE_OBJECT), NULL);</a>
<a name="ln280"> </a>
<a name="ln281">  JsonObject *rootdict = json_node_get_object(root);</a>
<a name="ln282">  if(json_object_has_member(rootdict, &quot;error&quot;))</a>
<a name="ln283">  {</a>
<a name="ln284">    JsonObject *errorstruct = json_object_get_object_member(rootdict, &quot;error&quot;);</a>
<a name="ln285">    g_return_val_if_fail((errorstruct != NULL), NULL);</a>
<a name="ln286">    const gchar *errormessage = json_object_get_string_member(errorstruct, &quot;message&quot;);</a>
<a name="ln287">    g_return_val_if_fail((errormessage != NULL), NULL);</a>
<a name="ln288">    g_string_assign(ctx-&gt;errmsg, errormessage);</a>
<a name="ln289">    return NULL;</a>
<a name="ln290">  }</a>
<a name="ln291"> </a>
<a name="ln292">  return rootdict;</a>
<a name="ln293">}</a>
<a name="ln294"> </a>
<a name="ln295"> </a>
<a name="ln296">static void fb_query_get_add_url_arguments(const gchar *key, const gchar *value, GString *url)</a>
<a name="ln297">{</a>
<a name="ln298">  g_string_append(url, &quot;&amp;&quot;);</a>
<a name="ln299">  g_string_append(url, key);</a>
<a name="ln300">  g_string_append(url, &quot;=&quot;);</a>
<a name="ln301">  g_string_append(url, value);</a>
<a name="ln302">}</a>
<a name="ln303"> </a>
<a name="ln304">/**</a>
<a name="ln305"> * perform a GET request on facebook graph api</a>
<a name="ln306"> *</a>
<a name="ln307"> * @note use this one to read information (user info, existing albums, ...)</a>
<a name="ln308"> *</a>
<a name="ln309"> * @param ctx facebook context (token field must be set)</a>
<a name="ln310"> * @param method the method to call on the facebook graph API, the methods should not start with '/' example:</a>
<a name="ln311"> *&quot;me/albums&quot;</a>
<a name="ln312"> * @param args hashtable of the arguments to be added to the requests, must be in the form key (string) =</a>
<a name="ln313"> *value (string)</a>
<a name="ln314"> * @returns NULL if the request fails, or a JsonObject of the reply</a>
<a name="ln315"> */</a>
<a name="ln316">static JsonObject *fb_query_get(FBContext *ctx, const gchar *method, GHashTable *args)</a>
<a name="ln317">{</a>
<a name="ln318">  g_return_val_if_fail(ctx != NULL, NULL);</a>
<a name="ln319">  g_return_val_if_fail(ctx-&gt;token != NULL, NULL);</a>
<a name="ln320">  // build the query</a>
<a name="ln321">  GString *url = g_string_new(FB_GRAPH_BASE_URL);</a>
<a name="ln322">  g_string_append(url, method);</a>
<a name="ln323">  g_string_append(url, &quot;?access_token=&quot;);</a>
<a name="ln324">  g_string_append(url, ctx-&gt;token);</a>
<a name="ln325">  if(args != NULL) g_hash_table_foreach(args, (GHFunc)fb_query_get_add_url_arguments, url);</a>
<a name="ln326"> </a>
<a name="ln327">  // send the request</a>
<a name="ln328">  GString *response = g_string_new(&quot;&quot;);</a>
<a name="ln329">  curl_easy_reset(ctx-&gt;curl_ctx);</a>
<a name="ln330">  curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_URL, url-&gt;str);</a>
<a name="ln331">#ifdef FACEBOOK_EXTRA_VERBOSE</a>
<a name="ln332">  curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_VERBOSE, 2);</a>
<a name="ln333">#endif</a>
<a name="ln334">  curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_WRITEFUNCTION, curl_write_data_cb);</a>
<a name="ln335">  curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_SSL_VERIFYPEER, FALSE);</a>
<a name="ln336">  curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_WRITEDATA, response);</a>
<a name="ln337">  int res = curl_easy_perform(ctx-&gt;curl_ctx);</a>
<a name="ln338"> </a>
<a name="ln339">  if(res != CURLE_OK)</a>
<a name="ln340">  {</a>
<a name="ln341">    g_string_free(url, TRUE);</a>
<a name="ln342">    g_string_free(response, TRUE);</a>
<a name="ln343">    return NULL;</a>
<a name="ln344">  }</a>
<a name="ln345"> </a>
<a name="ln346">  // parse the response</a>
<a name="ln347">  JsonObject *respobj = fb_parse_response(ctx, response);</a>
<a name="ln348"> </a>
<a name="ln349">  g_string_free(response, TRUE);</a>
<a name="ln350">  g_string_free(url, TRUE);</a>
<a name="ln351">  return respobj;</a>
<a name="ln352">}</a>
<a name="ln353"> </a>
<a name="ln354">typedef struct</a>
<a name="ln355">{</a>
<a name="ln356">  struct curl_httppost *formpost;</a>
<a name="ln357">  struct curl_httppost *lastptr;</a>
<a name="ln358">} HttppostFormList;</a>
<a name="ln359"> </a>
<a name="ln360">static void fb_query_post_add_form_arguments(const gchar *key, const gchar *value, HttppostFormList *formlist)</a>
<a name="ln361">{</a>
<a name="ln362">  curl_formadd(&amp;(formlist-&gt;formpost), &amp;(formlist-&gt;lastptr), CURLFORM_COPYNAME, key, CURLFORM_COPYCONTENTS,</a>
<a name="ln363">               value, CURLFORM_END);</a>
<a name="ln364">}</a>
<a name="ln365"> </a>
<a name="ln366">static void fb_query_post_add_file_arguments(const gchar *key, const gchar *value, HttppostFormList *formlist)</a>
<a name="ln367">{</a>
<a name="ln368">  curl_formadd(&amp;(formlist-&gt;formpost), &amp;(formlist-&gt;lastptr), CURLFORM_COPYNAME, key, CURLFORM_COPYCONTENTS,</a>
<a name="ln369">               value, CURLFORM_END);</a>
<a name="ln370"> </a>
<a name="ln371">  curl_formadd(&amp;(formlist-&gt;formpost), &amp;(formlist-&gt;lastptr), CURLFORM_COPYNAME, key, CURLFORM_FILE, value,</a>
<a name="ln372">               CURLFORM_END);</a>
<a name="ln373">}</a>
<a name="ln374"> </a>
<a name="ln375">/**</a>
<a name="ln376"> * perform a POST request on facebook graph api</a>
<a name="ln377"> *</a>
<a name="ln378"> * @note use this one to create object (album, photos, ...)</a>
<a name="ln379"> *</a>
<a name="ln380"> * @param ctx facebook context (token field must be set)</a>
<a name="ln381"> * @param method the method to call on the facebook graph API, the methods should not start with '/' example:</a>
<a name="ln382"> *&quot;me/albums&quot;</a>
<a name="ln383"> * @param args hashtable of the arguments to be added to the requests, might be null if none</a>
<a name="ln384"> * @param files hashtable of the files to be send with the requests, might be null if none</a>
<a name="ln385"> * @returns NULL if the request fails, or a JsonObject of the reply</a>
<a name="ln386"> */</a>
<a name="ln387">static JsonObject *fb_query_post(FBContext *ctx, const gchar *method, GHashTable *args, GHashTable *files)</a>
<a name="ln388">{</a>
<a name="ln389">  g_return_val_if_fail(ctx != NULL, NULL);</a>
<a name="ln390">  g_return_val_if_fail(ctx-&gt;token != NULL, NULL);</a>
<a name="ln391"> </a>
<a name="ln392">  GString *url = g_string_new(FB_GRAPH_BASE_URL);</a>
<a name="ln393">  g_string_append(url, method);</a>
<a name="ln394"> </a>
<a name="ln395">  HttppostFormList formlist;</a>
<a name="ln396">  formlist.formpost = NULL;</a>
<a name="ln397">  formlist.lastptr = NULL;</a>
<a name="ln398"> </a>
<a name="ln399">  curl_formadd(&amp;(formlist.formpost), &amp;(formlist.lastptr), CURLFORM_COPYNAME, &quot;access_token&quot;,</a>
<a name="ln400">               CURLFORM_COPYCONTENTS, ctx-&gt;token, CURLFORM_END);</a>
<a name="ln401">  if(args != NULL) g_hash_table_foreach(args, (GHFunc)fb_query_post_add_form_arguments, &amp;formlist);</a>
<a name="ln402"> </a>
<a name="ln403">  if(files != NULL) g_hash_table_foreach(files, (GHFunc)fb_query_post_add_file_arguments, &amp;formlist);</a>
<a name="ln404"> </a>
<a name="ln405">  // send the requests</a>
<a name="ln406">  GString *response = g_string_new(&quot;&quot;);</a>
<a name="ln407">  curl_easy_reset(ctx-&gt;curl_ctx);</a>
<a name="ln408">  curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_URL, url-&gt;str);</a>
<a name="ln409">#ifdef FACEBOOK_EXTRA_VERBOSE</a>
<a name="ln410">  curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_VERBOSE, 2);</a>
<a name="ln411">#endif</a>
<a name="ln412">  curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_HTTPPOST, formlist.formpost);</a>
<a name="ln413">  curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_SSL_VERIFYPEER, FALSE);</a>
<a name="ln414">  curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_WRITEFUNCTION, curl_write_data_cb);</a>
<a name="ln415">  curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_WRITEDATA, response);</a>
<a name="ln416">  int res = curl_easy_perform(ctx-&gt;curl_ctx);</a>
<a name="ln417">  curl_formfree(formlist.formpost);</a>
<a name="ln418">  g_string_free(url, TRUE);</a>
<a name="ln419">  if(res != CURLE_OK) return NULL;</a>
<a name="ln420">  // parse the response</a>
<a name="ln421">  JsonObject *respobj = fb_parse_response(ctx, response);</a>
<a name="ln422">  g_string_free(response, TRUE);</a>
<a name="ln423">  return respobj;</a>
<a name="ln424">}</a>
<a name="ln425"> </a>
<a name="ln426">//////////////////////////// facebook api functions</a>
<a name="ln427"> </a>
<a name="ln428">/**</a>
<a name="ln429"> * @returns TRUE if the current token is valid</a>
<a name="ln430"> */</a>
<a name="ln431">static gboolean fb_test_auth_token(FBContext *ctx)</a>
<a name="ln432">{</a>
<a name="ln433">  JsonObject *obj = fb_query_get(ctx, &quot;me&quot;, NULL);</a>
<a name="ln434">  return obj != NULL;</a>
<a name="ln435">}</a>
<a name="ln436"> </a>
<a name="ln437">/**</a>
<a name="ln438"> * @return a GList of FBAlbums associated to the user</a>
<a name="ln439"> */</a>
<a name="ln440">static GList *fb_get_album_list(FBContext *ctx, gboolean *ok)</a>
<a name="ln441">{</a>
<a name="ln442">  if(!ok) return NULL;</a>
<a name="ln443"> </a>
<a name="ln444">  *ok = TRUE;</a>
<a name="ln445">  GList *album_list = NULL;</a>
<a name="ln446"> </a>
<a name="ln447">  GHashTable *args = g_hash_table_new((GHashFunc)g_str_hash, (GEqualFunc)g_str_equal);</a>
<a name="ln448">  g_hash_table_insert(args, &quot;fields&quot;, &quot;id,name,can_upload&quot;);</a>
<a name="ln449">  JsonObject *reply = fb_query_get(ctx, &quot;me/albums&quot;, args);</a>
<a name="ln450">  g_hash_table_destroy(args);</a>
<a name="ln451"> </a>
<a name="ln452">  if(reply == NULL) goto error;</a>
<a name="ln453"> </a>
<a name="ln454">  JsonArray *jsalbums = json_object_get_array_member(reply, &quot;data&quot;);</a>
<a name="ln455">  if(jsalbums == NULL) goto error;</a>
<a name="ln456"> </a>
<a name="ln457">  guint i;</a>
<a name="ln458">  for(i = 0; i &lt; json_array_get_length(jsalbums); i++)</a>
<a name="ln459">  {</a>
<a name="ln460">    JsonObject *obj = json_array_get_object_element(jsalbums, i);</a>
<a name="ln461">    if(obj == NULL) continue;</a>
<a name="ln462"> </a>
<a name="ln463">    JsonNode *canupload_node = json_object_get_member(obj, &quot;can_upload&quot;);</a>
<a name="ln464">    if(canupload_node == NULL || !json_node_get_boolean(canupload_node)) continue;</a>
<a name="ln465"> </a>
<a name="ln466">    FBAlbum *album = fb_album_init();</a>
<a name="ln467">    if(album == NULL) goto error;</a>
<a name="ln468"> </a>
<a name="ln469">    const char *id = json_object_get_string_member(obj, &quot;id&quot;);</a>
<a name="ln470">    const char *name = json_object_get_string_member(obj, &quot;name&quot;);</a>
<a name="ln471">    if(id == NULL || name == NULL)</a>
<a name="ln472">    {</a>
<a name="ln473">      fb_album_destroy(album);</a>
<a name="ln474">      goto error;</a>
<a name="ln475">    }</a>
<a name="ln476">    album-&gt;id = g_strdup(id);</a>
<a name="ln477">    album-&gt;name = g_strdup(name);</a>
<a name="ln478">    album_list = g_list_append(album_list, album);</a>
<a name="ln479">  }</a>
<a name="ln480">  return album_list;</a>
<a name="ln481"> </a>
<a name="ln482">error:</a>
<a name="ln483">  *ok = FALSE;</a>
<a name="ln484">  g_list_free_full(album_list, (GDestroyNotify)fb_album_destroy);</a>
<a name="ln485">  return NULL;</a>
<a name="ln486">}</a>
<a name="ln487"> </a>
<a name="ln488">/**</a>
<a name="ln489"> * @see https://developers.facebook.com/docs/reference/api/user/</a>
<a name="ln490"> * @return the id of the newly reacted</a>
<a name="ln491"> */</a>
<a name="ln492">static const gchar *fb_create_album(FBContext *ctx, gchar *name, gchar *summary, FBAlbumPrivacyPolicy privacy)</a>
<a name="ln493">{</a>
<a name="ln494">  GHashTable *args = g_hash_table_new((GHashFunc)g_str_hash, (GEqualFunc)g_str_equal);</a>
<a name="ln495">  g_hash_table_insert(args, &quot;name&quot;, name);</a>
<a name="ln496">  if(summary != NULL) g_hash_table_insert(args, &quot;message&quot;, summary);</a>
<a name="ln497">  switch(privacy)</a>
<a name="ln498">  {</a>
<a name="ln499">    case FBALBUM_PRIVACY_EVERYONE:</a>
<a name="ln500">      g_hash_table_insert(args, &quot;privacy&quot;, &quot;{\&quot;value\&quot;:\&quot;EVERYONE\&quot;}&quot;);</a>
<a name="ln501">      break;</a>
<a name="ln502">    case FBALBUM_PRIVACY_ALL_FRIENDS:</a>
<a name="ln503">      g_hash_table_insert(args, &quot;privacy&quot;, &quot;{\&quot;value\&quot;:\&quot;ALL_FRIENDS\&quot;}&quot;);</a>
<a name="ln504">      break;</a>
<a name="ln505">    case FBALBUM_PRIVACY_FRIENDS_OF_FRIENDS:</a>
<a name="ln506">      g_hash_table_insert(args, &quot;privacy&quot;, &quot;{\&quot;value\&quot;:\&quot;FRIENDS_OF_FRIENDS\&quot;}&quot;);</a>
<a name="ln507">      break;</a>
<a name="ln508">    case FBALBUM_PRIVACY_SELF:</a>
<a name="ln509">      g_hash_table_insert(args, &quot;privacy&quot;, &quot;{\&quot;value\&quot;:\&quot;SELF\&quot;}&quot;);</a>
<a name="ln510">      break;</a>
<a name="ln511">    default:</a>
<a name="ln512">      goto error;</a>
<a name="ln513">      break;</a>
<a name="ln514">  }</a>
<a name="ln515">  JsonObject *ref = fb_query_post(ctx, &quot;me/albums&quot;, args, NULL);</a>
<a name="ln516">  if(ref == NULL) goto error;</a>
<a name="ln517">  g_hash_table_destroy(args);</a>
<a name="ln518">  return json_object_get_string_member(ref, &quot;id&quot;);</a>
<a name="ln519"> </a>
<a name="ln520">error:</a>
<a name="ln521">  g_hash_table_destroy(args);</a>
<a name="ln522">  return NULL;</a>
<a name="ln523">}</a>
<a name="ln524"> </a>
<a name="ln525">/**</a>
<a name="ln526"> * @see https://developers.facebook.com/docs/reference/api/album/</a>
<a name="ln527"> * @return the id of the uploaded photo</a>
<a name="ln528"> */</a>
<a name="ln529">static const gchar *fb_upload_photo_to_album(FBContext *ctx, gchar *albumid, gchar *fpath, gchar *description)</a>
<a name="ln530">{</a>
<a name="ln531">  GString *method = g_string_new(albumid);</a>
<a name="ln532">  g_string_append(method, &quot;/photos&quot;);</a>
<a name="ln533"> </a>
<a name="ln534">  GHashTable *files = g_hash_table_new((GHashFunc)g_str_hash, (GEqualFunc)g_str_equal);</a>
<a name="ln535">  g_hash_table_insert(files, &quot;source&quot;, fpath);</a>
<a name="ln536"> </a>
<a name="ln537">  GHashTable *args = NULL;</a>
<a name="ln538">  if(description != NULL)</a>
<a name="ln539">  {</a>
<a name="ln540">    args = g_hash_table_new((GHashFunc)g_str_hash, (GEqualFunc)g_str_equal);</a>
<a name="ln541">    g_hash_table_insert(args, &quot;message&quot;, description);</a>
<a name="ln542">  }</a>
<a name="ln543"> </a>
<a name="ln544">  JsonObject *ref = fb_query_post(ctx, method-&gt;str, args, files);</a>
<a name="ln545">  g_string_free(method, TRUE);</a>
<a name="ln546"> </a>
<a name="ln547">  g_hash_table_destroy(files);</a>
<a name="ln548">  if(args != NULL)</a>
<a name="ln549">  {</a>
<a name="ln550">    g_hash_table_destroy(args);</a>
<a name="ln551">  }</a>
<a name="ln552">  if(ref == NULL) return NULL;</a>
<a name="ln553">  return json_object_get_string_member(ref, &quot;id&quot;);</a>
<a name="ln554">}</a>
<a name="ln555"> </a>
<a name="ln556">/**</a>
<a name="ln557"> * @see https://developers.facebook.com/docs/reference/api/user/</a>
<a name="ln558"> * @return basic information about the account</a>
<a name="ln559"> */</a>
<a name="ln560">static FBAccountInfo *fb_get_account_info(FBContext *ctx)</a>
<a name="ln561">{</a>
<a name="ln562">  JsonObject *obj = fb_query_get(ctx, &quot;me&quot;, NULL);</a>
<a name="ln563">  g_return_val_if_fail((obj != NULL), NULL);</a>
<a name="ln564">  const gchar *readablename = json_object_get_string_member(obj, &quot;name&quot;);</a>
<a name="ln565">  const gchar *user_id = json_object_get_string_member(obj, &quot;id&quot;);</a>
<a name="ln566">  g_return_val_if_fail(readablename != NULL &amp;&amp; user_id != NULL, NULL);</a>
<a name="ln567">  FBAccountInfo *accountinfo = fb_account_info_init();</a>
<a name="ln568">  accountinfo-&gt;id = g_strdup(user_id);</a>
<a name="ln569">  accountinfo-&gt;readablename = g_strdup(readablename);</a>
<a name="ln570">  accountinfo-&gt;token = g_strdup(ctx-&gt;token);</a>
<a name="ln571">  return accountinfo;</a>
<a name="ln572">}</a>
<a name="ln573"> </a>
<a name="ln574"> </a>
<a name="ln575">///////////////////////////////// UI functions</a>
<a name="ln576"> </a>
<a name="ln577">static gboolean combobox_separator(GtkTreeModel *model, GtkTreeIter *iter, gpointer data)</a>
<a name="ln578">{</a>
<a name="ln579">  GValue value = {</a>
<a name="ln580">    0,</a>
<a name="ln581">  };</a>
<a name="ln582">  gtk_tree_model_get_value(model, iter, 0, &amp;value);</a>
<a name="ln583">  gchar *v = NULL;</a>
<a name="ln584">  if(G_VALUE_HOLDS_STRING(&amp;value))</a>
<a name="ln585">  {</a>
<a name="ln586">    if((v = (gchar *)g_value_get_string(&amp;value)) != NULL &amp;&amp; *v == '\0') return TRUE;</a>
<a name="ln587">  }</a>
<a name="ln588">  g_value_unset(&amp;value);</a>
<a name="ln589">  return FALSE;</a>
<a name="ln590">}</a>
<a name="ln591"> </a>
<a name="ln592">/**</a>
<a name="ln593"> * @see https://developers.facebook.com/docs/authentication/</a>
<a name="ln594"> * @returns NULL if the user cancels the operation or a valid token</a>
<a name="ln595"> */</a>
<a name="ln596">static gboolean _open_browser(const char *callback_url)</a>
<a name="ln597">{</a>
<a name="ln598">  GError *error = NULL;</a>
<a name="ln599">  char *url = g_strdup_printf(FB_WS_BASE_URL &quot;dialog/oauth?&quot;</a>
<a name="ln600">                                             &quot;client_id=&quot; FB_API_KEY &quot;&amp;redirect_uri=%s&quot;</a>
<a name="ln601">                                             &quot;&amp;scope=user_photos,publish_actions&quot;</a>
<a name="ln602">                                             &quot;&amp;response_type=token&quot;,</a>
<a name="ln603">                              callback_url);</a>
<a name="ln604">  if(!gtk_show_uri(gdk_screen_get_default(), url, gtk_get_current_event_time(), &amp;error))</a>
<a name="ln605">  {</a>
<a name="ln606">    fprintf(stderr, &quot;[facebook] error opening browser: %s\n&quot;, error-&gt;message);</a>
<a name="ln607">    g_error_free(error);</a>
<a name="ln608">    g_free(url);</a>
<a name="ln609">    return FALSE;</a>
<a name="ln610">  }</a>
<a name="ln611">  g_free(url);</a>
<a name="ln612">  return TRUE;</a>
<a name="ln613">}</a>
<a name="ln614"> </a>
<a name="ln615">static gchar *facebook_get_user_auth_token_from_url(dt_storage_facebook_gui_data_t *ui)</a>
<a name="ln616">{</a>
<a name="ln617">  ///////////// open the authentication url in a browser. just use some port, we won't listen anyway</a>
<a name="ln618">  if(!_open_browser(&quot;http://localhost:8123/&quot; FB_CALLBACK_ID)) return NULL;</a>
<a name="ln619"> </a>
<a name="ln620">  ////////////// build &amp; show the validation dialog</a>
<a name="ln621">  gchar *text1 = _(&quot;step 1: a new window or tab of your browser should have been &quot;</a>
<a name="ln622">                   &quot;loaded. you have to login into your facebook account there &quot;</a>
<a name="ln623">                   &quot;and authorize darktable to upload photos before continuing.&quot;);</a>
<a name="ln624">  gchar *text2 = _(&quot;step 2: paste your browser URL and click the OK button once &quot;</a>
<a name="ln625">                   &quot;you are done.&quot;);</a>
<a name="ln626"> </a>
<a name="ln627">  GtkWidget *window = dt_ui_main_window(darktable.gui-&gt;ui);</a>
<a name="ln628">  GtkDialog *fb_auth_dialog = GTK_DIALOG(</a>
<a name="ln629">      gtk_message_dialog_new(GTK_WINDOW(window), GTK_DIALOG_DESTROY_WITH_PARENT, GTK_MESSAGE_QUESTION,</a>
<a name="ln630">                             GTK_BUTTONS_OK_CANCEL, _(&quot;facebook authentication&quot;)));</a>
<a name="ln631">#ifdef GDK_WINDOWING_QUARTZ</a>
<a name="ln632">  dt_osx_disallow_fullscreen(GTK_WIDGET(fb_auth_dialog));</a>
<a name="ln633">#endif</a>
<a name="ln634">  gtk_message_dialog_format_secondary_text(GTK_MESSAGE_DIALOG(fb_auth_dialog), &quot;%s\n\n%s&quot;, text1, text2);</a>
<a name="ln635"> </a>
<a name="ln636">  GtkWidget *entry = gtk_entry_new();</a>
<a name="ln637">  GtkWidget *hbox = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 5);</a>
<a name="ln638">  gtk_box_pack_start(GTK_BOX(hbox), GTK_WIDGET(gtk_label_new(_(&quot;URL:&quot;))), FALSE, FALSE, 0);</a>
<a name="ln639">  gtk_box_pack_start(GTK_BOX(hbox), GTK_WIDGET(entry), TRUE, TRUE, 0);</a>
<a name="ln640"> </a>
<a name="ln641">  GtkWidget *fbauthdialog_vbox = gtk_message_dialog_get_message_area(GTK_MESSAGE_DIALOG(fb_auth_dialog));</a>
<a name="ln642">  gtk_box_pack_end(GTK_BOX(fbauthdialog_vbox), hbox, TRUE, TRUE, 0);</a>
<a name="ln643"> </a>
<a name="ln644">  gtk_widget_show_all(GTK_WIDGET(fb_auth_dialog));</a>
<a name="ln645"> </a>
<a name="ln646">  ////////////// wait for the user to enter the validation URL</a>
<a name="ln647">  gint result;</a>
<a name="ln648">  gchar *token = NULL;</a>
<a name="ln649">  const char *replyurl;</a>
<a name="ln650">  while(TRUE)</a>
<a name="ln651">  {</a>
<a name="ln652">    result = gtk_dialog_run(GTK_DIALOG(fb_auth_dialog));</a>
<a name="ln653">    if(result == GTK_RESPONSE_CANCEL) break;</a>
<a name="ln654">    replyurl = gtk_entry_get_text(GTK_ENTRY(entry));</a>
<a name="ln655">    if(replyurl == NULL || g_strcmp0(replyurl, &quot;&quot;) == 0)</a>
<a name="ln656">    {</a>
<a name="ln657">      gtk_message_dialog_format_secondary_markup(GTK_MESSAGE_DIALOG(fb_auth_dialog),</a>
<a name="ln658">                                                 &quot;%s\n\n%s\n\n&lt;span foreground=\&quot;&quot; MSGCOLOR_RED</a>
<a name="ln659">                                                 &quot;\&quot; &gt;&lt;small&gt;%s&lt;/small&gt;&lt;/span&gt;&quot;,</a>
<a name="ln660">                                                 text1, text2, _(&quot;please enter the validation URL&quot;));</a>
<a name="ln661">      continue;</a>
<a name="ln662">    }</a>
<a name="ln663">    token = fb_extract_token_from_url(replyurl);</a>
<a name="ln664">    if(token != NULL) // we have a valid token</a>
<a name="ln665">      break;</a>
<a name="ln666">    else</a>
<a name="ln667">      gtk_message_dialog_format_secondary_markup(</a>
<a name="ln668">          GTK_MESSAGE_DIALOG(fb_auth_dialog),</a>
<a name="ln669">          &quot;%s\n\n%s%s\n\n&lt;span foreground=\&quot;&quot; MSGCOLOR_RED &quot;\&quot;&gt;&lt;small&gt;%s&lt;/small&gt;&lt;/span&gt;&quot;, text1, text2,</a>
<a name="ln670">          _(&quot;the given URL is not valid, it should look like: &quot;),</a>
<a name="ln671">          FB_WS_BASE_URL &quot;connect/login_success.html?...&quot;);</a>
<a name="ln672">  }</a>
<a name="ln673">  gtk_widget_destroy(GTK_WIDGET(fb_auth_dialog));</a>
<a name="ln674"> </a>
<a name="ln675">  return token;</a>
<a name="ln676">}</a>
<a name="ln677"> </a>
<a name="ln678">#ifdef HAVE_HTTP_SERVER</a>
<a name="ln679">static void ui_authenticate_finish(dt_storage_facebook_gui_data_t *ui, gboolean mustsaveaccount);</a>
<a name="ln680"> </a>
<a name="ln681">static gboolean _server_callback(GHashTable *query, gpointer user_data)</a>
<a name="ln682">{</a>
<a name="ln683">  dt_storage_facebook_gui_data_t *ui = (dt_storage_facebook_gui_data_t *)user_data;</a>
<a name="ln684"> </a>
<a name="ln685">  const char *access_token = g_hash_table_lookup(query, &quot;access_token&quot;);</a>
<a name="ln686"> </a>
<a name="ln687">  if(access_token)</a>
<a name="ln688">  {</a>
<a name="ln689">    // we got what we wanted</a>
<a name="ln690">    dt_print(DT_DEBUG_CONTROL, &quot;[facebook] got access_token `%s' from facebook redirect\n&quot;, access_token);</a>
<a name="ln691"> </a>
<a name="ln692">    // close the dialog</a>
<a name="ln693">    gtk_widget_destroy(GTK_WIDGET(ui-&gt;auth_dialog));</a>
<a name="ln694">    ui-&gt;auth_dialog = NULL;</a>
<a name="ln695"> </a>
<a name="ln696">    FBContext *ctx = ui-&gt;facebook_api;</a>
<a name="ln697">    ctx-&gt;token = g_strdup(access_token);</a>
<a name="ln698"> </a>
<a name="ln699">    ui_authenticate_finish(ui, TRUE);</a>
<a name="ln700"> </a>
<a name="ln701">    dt_control_log(_(&quot;authentication successful&quot;));</a>
<a name="ln702">    return TRUE;</a>
<a name="ln703">  }</a>
<a name="ln704"> </a>
<a name="ln705">  dt_control_log(_(&quot;authentication failed&quot;));</a>
<a name="ln706"> </a>
<a name="ln707">  return FALSE;</a>
<a name="ln708">}</a>
<a name="ln709"> </a>
<a name="ln710"> </a>
<a name="ln711">static gboolean facebook_get_user_auth_token_from_server(dt_storage_facebook_gui_data_t *ui)</a>
<a name="ln712">{</a>
<a name="ln713">  // create a dialog telling the user to login in the browser</a>
<a name="ln714">  GtkWidget *win = dt_ui_main_window(darktable.gui-&gt;ui);</a>
<a name="ln715"> </a>
<a name="ln716">  GtkWidget *dialog = gtk_message_dialog_new(</a>
<a name="ln717">      GTK_WINDOW(win), GTK_DIALOG_DESTROY_WITH_PARENT, GTK_MESSAGE_INFO, GTK_BUTTONS_CANCEL,</a>
<a name="ln718">      _(&quot;a new window or tab of your browser should have been &quot;</a>
<a name="ln719">        &quot;loaded. you have to login into your facebook account there &quot;</a>
<a name="ln720">        &quot;and authorize darktable to upload photos before continuing.&quot;));</a>
<a name="ln721">#ifdef GDK_WINDOWING_QUARTZ</a>
<a name="ln722">  dt_osx_disallow_fullscreen(dialog);</a>
<a name="ln723">#endif</a>
<a name="ln724"> </a>
<a name="ln725">  gtk_window_set_title(GTK_WINDOW(dialog), _(&quot;facebook authentication&quot;));</a>
<a name="ln726"> </a>
<a name="ln727">  ui-&gt;auth_dialog = GTK_MESSAGE_DIALOG(dialog);</a>
<a name="ln728"> </a>
<a name="ln729">  // create an http server</a>
<a name="ln730">  dt_http_server_t *server = dt_http_server_create(port_pool, n_ports, &quot;facebook&quot;, _server_callback, ui);</a>
<a name="ln731">  if(!server)</a>
<a name="ln732">  {</a>
<a name="ln733">    gtk_widget_destroy(dialog);</a>
<a name="ln734">    return FALSE;</a>
<a name="ln735">  }</a>
<a name="ln736"> </a>
<a name="ln737">  // open the browser</a>
<a name="ln738">  if(!_open_browser(server-&gt;url))</a>
<a name="ln739">  {</a>
<a name="ln740">    gtk_widget_destroy(dialog);</a>
<a name="ln741">    dt_http_server_kill(server);</a>
<a name="ln742">    return FALSE;</a>
<a name="ln743">  }</a>
<a name="ln744"> </a>
<a name="ln745">  // show the window</a>
<a name="ln746">  if(gtk_dialog_run(GTK_DIALOG(dialog)) == GTK_RESPONSE_CANCEL)</a>
<a name="ln747">  {</a>
<a name="ln748">    // if cancel button is clicked -&gt; kill the server</a>
<a name="ln749">    dt_http_server_kill(server);</a>
<a name="ln750">    gtk_widget_destroy(dialog);</a>
<a name="ln751">  }</a>
<a name="ln752"> </a>
<a name="ln753">  return TRUE;</a>
<a name="ln754">}</a>
<a name="ln755">#endif // HAVE_HTTP_SERVER</a>
<a name="ln756"> </a>
<a name="ln757">static void load_account_info_fill(gchar *key, gchar *value, GSList **accountlist)</a>
<a name="ln758">{</a>
<a name="ln759">  JsonParser *parser = json_parser_new();</a>
<a name="ln760">  json_parser_load_from_data(parser, value, strlen(value), NULL);</a>
<a name="ln761">  JsonNode *root = json_parser_get_root(parser);</a>
<a name="ln762"> </a>
<a name="ln763">  // root can be null while parsing the account info</a>
<a name="ln764">  if(root)</a>
<a name="ln765">  {</a>
<a name="ln766">    JsonObject *obj = json_node_get_object(root);</a>
<a name="ln767">    FBAccountInfo *info = fb_account_info_init();</a>
<a name="ln768">    info-&gt;id = g_strdup(key);</a>
<a name="ln769">    info-&gt;token = g_strdup(json_object_get_string_member(obj, &quot;token&quot;));</a>
<a name="ln770">    info-&gt;readablename = g_strdup(json_object_get_string_member(obj, &quot;name&quot;));</a>
<a name="ln771">    *accountlist = g_slist_prepend(*accountlist, info);</a>
<a name="ln772">  }</a>
<a name="ln773">  g_object_unref(parser);</a>
<a name="ln774">}</a>
<a name="ln775"> </a>
<a name="ln776">/**</a>
<a name="ln777"> * @return a GSList of saved FBAccountInfo</a>
<a name="ln778"> */</a>
<a name="ln779">static GSList *load_account_info()</a>
<a name="ln780">{</a>
<a name="ln781">  GSList *accountlist = NULL;</a>
<a name="ln782"> </a>
<a name="ln783">  GHashTable *table = dt_pwstorage_get(&quot;facebook&quot;);</a>
<a name="ln784">  g_hash_table_foreach(table, (GHFunc)load_account_info_fill, &amp;accountlist);</a>
<a name="ln785">  g_hash_table_destroy(table);</a>
<a name="ln786">  return accountlist;</a>
<a name="ln787">}</a>
<a name="ln788"> </a>
<a name="ln789">static void save_account_info(dt_storage_facebook_gui_data_t *ui, FBAccountInfo *accountinfo)</a>
<a name="ln790">{</a>
<a name="ln791">  FBContext *ctx = ui-&gt;facebook_api;</a>
<a name="ln792">  g_return_if_fail(ctx != NULL);</a>
<a name="ln793"> </a>
<a name="ln794">  /// serialize data;</a>
<a name="ln795">  JsonBuilder *builder = json_builder_new();</a>
<a name="ln796">  json_builder_begin_object(builder);</a>
<a name="ln797">  json_builder_set_member_name(builder, &quot;name&quot;);</a>
<a name="ln798">  json_builder_add_string_value(builder, accountinfo-&gt;readablename);</a>
<a name="ln799">  json_builder_set_member_name(builder, &quot;token&quot;);</a>
<a name="ln800">  json_builder_add_string_value(builder, accountinfo-&gt;token);</a>
<a name="ln801">  json_builder_end_object(builder);</a>
<a name="ln802"> </a>
<a name="ln803">  JsonNode *node = json_builder_get_root(builder);</a>
<a name="ln804">  JsonGenerator *generator = json_generator_new();</a>
<a name="ln805">  json_generator_set_root(generator, node);</a>
<a name="ln806">#if JSON_CHECK_VERSION(0, 14, 0)</a>
<a name="ln807">  json_generator_set_pretty(generator, FALSE);</a>
<a name="ln808">#endif</a>
<a name="ln809">  gchar *data = json_generator_to_data(generator, NULL);</a>
<a name="ln810"> </a>
<a name="ln811">  json_node_free(node);</a>
<a name="ln812">  g_object_unref(generator);</a>
<a name="ln813">  g_object_unref(builder);</a>
<a name="ln814"> </a>
<a name="ln815">  GHashTable *table = dt_pwstorage_get(&quot;facebook&quot;);</a>
<a name="ln816">  g_hash_table_insert(table, g_strdup(accountinfo-&gt;id), data);</a>
<a name="ln817">  dt_pwstorage_set(&quot;facebook&quot;, table);</a>
<a name="ln818"> </a>
<a name="ln819">  g_hash_table_destroy(table);</a>
<a name="ln820">}</a>
<a name="ln821"> </a>
<a name="ln822">static void remove_account_info(const gchar *accountid)</a>
<a name="ln823">{</a>
<a name="ln824">  GHashTable *table = dt_pwstorage_get(&quot;facebook&quot;);</a>
<a name="ln825">  g_hash_table_remove(table, accountid);</a>
<a name="ln826">  dt_pwstorage_set(&quot;facebook&quot;, table);</a>
<a name="ln827">  g_hash_table_destroy(table);</a>
<a name="ln828">}</a>
<a name="ln829"> </a>
<a name="ln830">static void ui_refresh_users_fill(FBAccountInfo *value, gpointer dataptr)</a>
<a name="ln831">{</a>
<a name="ln832">  GtkListStore *liststore = GTK_LIST_STORE(dataptr);</a>
<a name="ln833">  GtkTreeIter iter;</a>
<a name="ln834">  gtk_list_store_append(liststore, &amp;iter);</a>
<a name="ln835">  gtk_list_store_set(liststore, &amp;iter, COMBO_USER_MODEL_NAME_COL, value-&gt;readablename, COMBO_USER_MODEL_TOKEN_COL,</a>
<a name="ln836">                     value-&gt;token, COMBO_USER_MODEL_ID_COL, value-&gt;id, -1);</a>
<a name="ln837">}</a>
<a name="ln838"> </a>
<a name="ln839">static void ui_refresh_users(dt_storage_facebook_gui_data_t *ui)</a>
<a name="ln840">{</a>
<a name="ln841">  GSList *accountlist = load_account_info();</a>
<a name="ln842">  GtkListStore *list_store = GTK_LIST_STORE(gtk_combo_box_get_model(ui-&gt;comboBox_username));</a>
<a name="ln843">  GtkTreeIter iter;</a>
<a name="ln844"> </a>
<a name="ln845">  gtk_list_store_clear(list_store);</a>
<a name="ln846">  gtk_list_store_append(list_store, &amp;iter);</a>
<a name="ln847"> </a>
<a name="ln848">  int active_account = 0;</a>
<a name="ln849">  if(g_slist_length(accountlist) == 0)</a>
<a name="ln850">  {</a>
<a name="ln851">    gtk_list_store_set(list_store, &amp;iter, COMBO_USER_MODEL_NAME_COL, _(&quot;new account&quot;),</a>
<a name="ln852">                       COMBO_USER_MODEL_TOKEN_COL, NULL, COMBO_USER_MODEL_ID_COL, NULL, -1);</a>
<a name="ln853">  }</a>
<a name="ln854">  else</a>
<a name="ln855">  {</a>
<a name="ln856">    gtk_list_store_set(list_store, &amp;iter, COMBO_USER_MODEL_NAME_COL, _(&quot;other account&quot;),</a>
<a name="ln857">                       COMBO_USER_MODEL_TOKEN_COL, NULL, COMBO_USER_MODEL_ID_COL, NULL, -1);</a>
<a name="ln858">    gtk_list_store_append(list_store, &amp;iter);</a>
<a name="ln859">    gtk_list_store_set(list_store, &amp;iter, COMBO_USER_MODEL_NAME_COL, &quot;&quot;, COMBO_USER_MODEL_TOKEN_COL, NULL,</a>
<a name="ln860">                       COMBO_USER_MODEL_ID_COL, NULL, -1); // separator</a>
<a name="ln861">    active_account = 2;</a>
<a name="ln862">  }</a>
<a name="ln863"> </a>
<a name="ln864">  g_slist_foreach(accountlist, (GFunc)ui_refresh_users_fill, list_store);</a>
<a name="ln865">  gtk_combo_box_set_active(ui-&gt;comboBox_username, active_account);</a>
<a name="ln866"> </a>
<a name="ln867">  g_slist_free_full(accountlist, (GDestroyNotify)fb_account_info_destroy);</a>
<a name="ln868">  gtk_combo_box_set_row_separator_func(ui-&gt;comboBox_username, combobox_separator, ui-&gt;comboBox_username, NULL);</a>
<a name="ln869">}</a>
<a name="ln870"> </a>
<a name="ln871">static void ui_refresh_albums_fill(FBAlbum *album, GtkListStore *list_store)</a>
<a name="ln872">{</a>
<a name="ln873">  GtkTreeIter iter;</a>
<a name="ln874">  gtk_list_store_append(list_store, &amp;iter);</a>
<a name="ln875">  gtk_list_store_set(list_store, &amp;iter, COMBO_ALBUM_MODEL_NAME_COL, album-&gt;name, COMBO_ALBUM_MODEL_ID_COL,</a>
<a name="ln876">                     album-&gt;id, -1);</a>
<a name="ln877">}</a>
<a name="ln878"> </a>
<a name="ln879">static void ui_refresh_albums(dt_storage_facebook_gui_data_t *ui)</a>
<a name="ln880">{</a>
<a name="ln881">  gboolean getlistok;</a>
<a name="ln882">  GList *albumList = fb_get_album_list(ui-&gt;facebook_api, &amp;getlistok);</a>
<a name="ln883">  if(!getlistok)</a>
<a name="ln884">  {</a>
<a name="ln885">    dt_control_log(_(&quot;unable to retrieve the album list&quot;));</a>
<a name="ln886">    goto cleanup;</a>
<a name="ln887">  }</a>
<a name="ln888"> </a>
<a name="ln889">  GtkListStore *model_album = GTK_LIST_STORE(gtk_combo_box_get_model(ui-&gt;comboBox_album));</a>
<a name="ln890">  GtkTreeIter iter;</a>
<a name="ln891">  gtk_list_store_clear(model_album);</a>
<a name="ln892">  gtk_list_store_append(model_album, &amp;iter);</a>
<a name="ln893">  gtk_list_store_set(model_album, &amp;iter, COMBO_ALBUM_MODEL_NAME_COL, _(&quot;create new album&quot;),</a>
<a name="ln894">                     COMBO_ALBUM_MODEL_ID_COL, NULL, -1);</a>
<a name="ln895">  if(albumList != NULL)</a>
<a name="ln896">  {</a>
<a name="ln897">    gtk_list_store_append(model_album, &amp;iter);</a>
<a name="ln898">    gtk_list_store_set(model_album, &amp;iter, COMBO_ALBUM_MODEL_NAME_COL, &quot;&quot;, COMBO_ALBUM_MODEL_ID_COL, NULL,</a>
<a name="ln899">                       -1); // separator</a>
<a name="ln900">  }</a>
<a name="ln901">  g_list_foreach(albumList, (GFunc)ui_refresh_albums_fill, model_album);</a>
<a name="ln902"> </a>
<a name="ln903">  if(albumList != NULL)</a>
<a name="ln904">    gtk_combo_box_set_active(ui-&gt;comboBox_album, 2);</a>
<a name="ln905">  else</a>
<a name="ln906">    gtk_combo_box_set_active(ui-&gt;comboBox_album, 0);</a>
<a name="ln907"> </a>
<a name="ln908">  gtk_widget_show_all(GTK_WIDGET(ui-&gt;comboBox_album));</a>
<a name="ln909">  g_list_free_full(albumList, (GDestroyNotify)fb_album_destroy);</a>
<a name="ln910"> </a>
<a name="ln911">cleanup:</a>
<a name="ln912">  return;</a>
<a name="ln913">}</a>
<a name="ln914"> </a>
<a name="ln915">static void ui_authenticate_finish(dt_storage_facebook_gui_data_t *ui, gboolean mustsaveaccount)</a>
<a name="ln916">{</a>
<a name="ln917">  FBContext *ctx = ui-&gt;facebook_api;</a>
<a name="ln918"> </a>
<a name="ln919">  if(ctx-&gt;token == NULL) goto error;</a>
<a name="ln920"> </a>
<a name="ln921">  if(mustsaveaccount)</a>
<a name="ln922">  {</a>
<a name="ln923">    FBAccountInfo *accountinfo = fb_get_account_info(ui-&gt;facebook_api);</a>
<a name="ln924">    if(accountinfo == NULL) goto error;</a>
<a name="ln925">    save_account_info(ui, accountinfo);</a>
<a name="ln926"> </a>
<a name="ln927">    // add account to user list and select it</a>
<a name="ln928">    GtkListStore *model = GTK_LIST_STORE(gtk_combo_box_get_model(ui-&gt;comboBox_username));</a>
<a name="ln929">    GtkTreeIter iter;</a>
<a name="ln930">    gboolean r;</a>
<a name="ln931">    gchar *uid;</a>
<a name="ln932"> </a>
<a name="ln933">    gboolean updated = FALSE;</a>
<a name="ln934"> </a>
<a name="ln935">    for(r = gtk_tree_model_get_iter_first(GTK_TREE_MODEL(model), &amp;iter); r == TRUE;</a>
<a name="ln936">        r = gtk_tree_model_iter_next(GTK_TREE_MODEL(model), &amp;iter))</a>
<a name="ln937">    {</a>
<a name="ln938">      gtk_tree_model_get(GTK_TREE_MODEL(model), &amp;iter, COMBO_USER_MODEL_ID_COL, &amp;uid, -1);</a>
<a name="ln939"> </a>
<a name="ln940">      if(g_strcmp0(uid, accountinfo-&gt;id) == 0)</a>
<a name="ln941">      {</a>
<a name="ln942">        gtk_list_store_set(model, &amp;iter, COMBO_USER_MODEL_NAME_COL, accountinfo-&gt;readablename,</a>
<a name="ln943">                           COMBO_USER_MODEL_TOKEN_COL, accountinfo-&gt;token, -1);</a>
<a name="ln944">        updated = TRUE;</a>
<a name="ln945">        break;</a>
<a name="ln946">      }</a>
<a name="ln947">    }</a>
<a name="ln948"> </a>
<a name="ln949">    if(!updated)</a>
<a name="ln950">    {</a>
<a name="ln951">      gtk_list_store_append(model, &amp;iter);</a>
<a name="ln952">      gtk_list_store_set(model, &amp;iter, COMBO_USER_MODEL_NAME_COL, accountinfo-&gt;readablename,</a>
<a name="ln953">                         COMBO_USER_MODEL_TOKEN_COL, accountinfo-&gt;token, COMBO_USER_MODEL_ID_COL,</a>
<a name="ln954">                         accountinfo-&gt;id, -1);</a>
<a name="ln955">    }</a>
<a name="ln956">    gtk_combo_box_set_active_iter(ui-&gt;comboBox_username, &amp;iter);</a>
<a name="ln957">    // we have to re-set the current token here since ui_combo_username_changed is called</a>
<a name="ln958">    // on gtk_combo_box_set_active_iter (and thus is resetting the active token)</a>
<a name="ln959">    ctx-&gt;token = g_strdup(accountinfo-&gt;token);</a>
<a name="ln960">    fb_account_info_destroy(accountinfo);</a>
<a name="ln961">  }</a>
<a name="ln962"> </a>
<a name="ln963">  ui_refresh_albums(ui);</a>
<a name="ln964">  ui-&gt;connected = TRUE;</a>
<a name="ln965">  gtk_button_set_label(ui-&gt;button_login, _(&quot;logout&quot;));</a>
<a name="ln966">  gtk_widget_set_sensitive(GTK_WIDGET(ui-&gt;comboBox_album), TRUE);</a>
<a name="ln967"> </a>
<a name="ln968">  return;</a>
<a name="ln969"> </a>
<a name="ln970">error:</a>
<a name="ln971">  gtk_button_set_label(ui-&gt;button_login, _(&quot;login&quot;));</a>
<a name="ln972">  gtk_widget_set_sensitive(GTK_WIDGET(ui-&gt;comboBox_album), FALSE);</a>
<a name="ln973">}</a>
<a name="ln974"> </a>
<a name="ln975">static void ui_authenticate(dt_storage_facebook_gui_data_t *ui)</a>
<a name="ln976">{</a>
<a name="ln977">  if(ui-&gt;facebook_api == NULL)</a>
<a name="ln978">  {</a>
<a name="ln979">    ui-&gt;facebook_api = fb_api_init();</a>
<a name="ln980">  }</a>
<a name="ln981"> </a>
<a name="ln982">  FBContext *ctx = ui-&gt;facebook_api;</a>
<a name="ln983">  gboolean mustsaveaccount = FALSE;</a>
<a name="ln984"> </a>
<a name="ln985">  gchar *uiselectedaccounttoken = NULL;</a>
<a name="ln986">  GtkTreeIter iter;</a>
<a name="ln987">  gtk_combo_box_get_active_iter(ui-&gt;comboBox_username, &amp;iter);</a>
<a name="ln988">  GtkTreeModel *accountModel = gtk_combo_box_get_model(ui-&gt;comboBox_username);</a>
<a name="ln989">  gtk_tree_model_get(accountModel, &amp;iter, 1, &amp;uiselectedaccounttoken, -1);</a>
<a name="ln990"> </a>
<a name="ln991">  gtk_button_set_label(ui-&gt;button_login, _(&quot;login&quot;));</a>
<a name="ln992">  gtk_widget_set_sensitive(GTK_WIDGET(ui-&gt;comboBox_album), FALSE);</a>
<a name="ln993"> </a>
<a name="ln994">  g_free(ctx-&gt;token);</a>
<a name="ln995">  ctx-&gt;token = g_strdup(uiselectedaccounttoken);</a>
<a name="ln996">  // check selected token if we already have one</a>
<a name="ln997">  if(ctx-&gt;token != NULL &amp;&amp; !fb_test_auth_token(ctx))</a>
<a name="ln998">  {</a>
<a name="ln999">    g_free(ctx-&gt;token);</a>
<a name="ln1000">    ctx-&gt;token = NULL;</a>
<a name="ln1001">  }</a>
<a name="ln1002"> </a>
<a name="ln1003">  if(ctx-&gt;token == NULL)</a>
<a name="ln1004">  {</a>
<a name="ln1005">    mustsaveaccount = TRUE;</a>
<a name="ln1006"> </a>
<a name="ln1007">#ifdef HAVE_HTTP_SERVER</a>
<a name="ln1008">    // try to get the token from the callback URL</a>
<a name="ln1009">    if(facebook_get_user_auth_token_from_server(ui)) return;</a>
<a name="ln1010">#endif</a>
<a name="ln1011"> </a>
<a name="ln1012">    // if we reached this point we either have no http server support</a>
<a name="ln1013">    // or couldn't start it (no free port, ...)</a>
<a name="ln1014">    ctx-&gt;token = facebook_get_user_auth_token_from_url(ui); // ask user to log in</a>
<a name="ln1015">  }</a>
<a name="ln1016"> </a>
<a name="ln1017">  ui_authenticate_finish(ui, mustsaveaccount);</a>
<a name="ln1018">}</a>
<a name="ln1019"> </a>
<a name="ln1020"> </a>
<a name="ln1021">static void ui_login_clicked(GtkButton *button, gpointer data)</a>
<a name="ln1022">{</a>
<a name="ln1023">  dt_storage_facebook_gui_data_t *ui = (dt_storage_facebook_gui_data_t *)data;</a>
<a name="ln1024">  if(ui-&gt;connected == FALSE)</a>
<a name="ln1025">  {</a>
<a name="ln1026">    ui_authenticate(ui);</a>
<a name="ln1027">  }</a>
<a name="ln1028">  else // disconnect user</a>
<a name="ln1029">  {</a>
<a name="ln1030">    if(ui-&gt;facebook_api-&gt;token != NULL)</a>
<a name="ln1031">    {</a>
<a name="ln1032">      GtkTreeModel *model = gtk_combo_box_get_model(ui-&gt;comboBox_username);</a>
<a name="ln1033">      GtkTreeIter iter;</a>
<a name="ln1034">      gtk_combo_box_get_active_iter(ui-&gt;comboBox_username, &amp;iter);</a>
<a name="ln1035">      gchar *userid;</a>
<a name="ln1036">      gtk_tree_model_get(model, &amp;iter, COMBO_USER_MODEL_ID_COL, &amp;userid, -1);</a>
<a name="ln1037">      remove_account_info(userid);</a>
<a name="ln1038">      gtk_button_set_label(ui-&gt;button_login, _(&quot;login&quot;));</a>
<a name="ln1039">      gtk_widget_set_sensitive(GTK_WIDGET(ui-&gt;comboBox_album), FALSE);</a>
<a name="ln1040">      ui_refresh_users(ui);</a>
<a name="ln1041">      ui-&gt;connected = FALSE;</a>
<a name="ln1042">    }</a>
<a name="ln1043">  }</a>
<a name="ln1044">}</a>
<a name="ln1045"> </a>
<a name="ln1046"> </a>
<a name="ln1047">static void ui_reset_albums_creation(struct dt_storage_facebook_gui_data_t *ui)</a>
<a name="ln1048">{</a>
<a name="ln1049">  GtkListStore *model_album = GTK_LIST_STORE(gtk_combo_box_get_model(ui-&gt;comboBox_album));</a>
<a name="ln1050">  gtk_list_store_clear(model_album);</a>
<a name="ln1051">  gtk_entry_set_text(ui-&gt;entry_album_summary, &quot;&quot;);</a>
<a name="ln1052">  gtk_entry_set_text(ui-&gt;entry_album_title, &quot;&quot;);</a>
<a name="ln1053">  gtk_widget_hide(GTK_WIDGET(ui-&gt;hbox_album));</a>
<a name="ln1054">}</a>
<a name="ln1055"> </a>
<a name="ln1056">static void ui_combo_username_changed(GtkComboBox *combo, struct dt_storage_facebook_gui_data_t *ui)</a>
<a name="ln1057">{</a>
<a name="ln1058">  GtkTreeIter iter;</a>
<a name="ln1059">  gchar *token = NULL;</a>
<a name="ln1060">  if(!gtk_combo_box_get_active_iter(combo, &amp;iter)) return; // ie: list is empty while clearing the combo</a>
<a name="ln1061">  GtkTreeModel *model = gtk_combo_box_get_model(combo);</a>
<a name="ln1062">  gtk_tree_model_get(model, &amp;iter, 1, &amp;token, -1); // get the selected token</a>
<a name="ln1063">  ui-&gt;connected = FALSE;</a>
<a name="ln1064">  gtk_button_set_label(ui-&gt;button_login, _(&quot;login&quot;));</a>
<a name="ln1065">  g_free(ui-&gt;facebook_api-&gt;token);</a>
<a name="ln1066">  ui-&gt;facebook_api-&gt;token = NULL;</a>
<a name="ln1067">  ui_reset_albums_creation(ui);</a>
<a name="ln1068">}</a>
<a name="ln1069"> </a>
<a name="ln1070">static void ui_combo_album_changed(GtkComboBox *combo, gpointer data)</a>
<a name="ln1071">{</a>
<a name="ln1072">  dt_storage_facebook_gui_data_t *ui = (dt_storage_facebook_gui_data_t *)data;</a>
<a name="ln1073"> </a>
<a name="ln1074">  GtkTreeIter iter;</a>
<a name="ln1075">  gchar *albumid = NULL;</a>
<a name="ln1076">  if(gtk_combo_box_get_active_iter(combo, &amp;iter))</a>
<a name="ln1077">  {</a>
<a name="ln1078">    GtkTreeModel *model = gtk_combo_box_get_model(combo);</a>
<a name="ln1079">    gtk_tree_model_get(model, &amp;iter, 1, &amp;albumid, -1); // get the album id</a>
<a name="ln1080">  }</a>
<a name="ln1081"> </a>
<a name="ln1082">  if(albumid == NULL)</a>
<a name="ln1083">  {</a>
<a name="ln1084">    gtk_widget_set_no_show_all(GTK_WIDGET(ui-&gt;hbox_album), FALSE);</a>
<a name="ln1085">    gtk_widget_show_all(GTK_WIDGET(ui-&gt;hbox_album));</a>
<a name="ln1086">  }</a>
<a name="ln1087">  else</a>
<a name="ln1088">  {</a>
<a name="ln1089">    gtk_widget_set_no_show_all(GTK_WIDGET(ui-&gt;hbox_album), TRUE);</a>
<a name="ln1090">    gtk_widget_hide(GTK_WIDGET(ui-&gt;hbox_album));</a>
<a name="ln1091">  }</a>
<a name="ln1092">}</a>
<a name="ln1093"> </a>
<a name="ln1094">////////////////////////// darktable library interface</a>
<a name="ln1095"> </a>
<a name="ln1096">/* plugin name */</a>
<a name="ln1097">const char *name(const struct dt_imageio_module_storage_t *self)</a>
<a name="ln1098">{</a>
<a name="ln1099">  return _(&quot;facebook webalbum&quot;);</a>
<a name="ln1100">}</a>
<a name="ln1101"> </a>
<a name="ln1102">int recommended_dimension(struct dt_imageio_module_storage_t *self, dt_imageio_module_data_t *data,</a>
<a name="ln1103">                          uint32_t *width, uint32_t *height)</a>
<a name="ln1104">{</a>
<a name="ln1105">  *width = FB_IMAGE_MAX_SIZE;</a>
<a name="ln1106">  *height = FB_IMAGE_MAX_SIZE;</a>
<a name="ln1107">  return 1;</a>
<a name="ln1108">}</a>
<a name="ln1109"> </a>
<a name="ln1110">/* construct widget above */</a>
<a name="ln1111">void gui_init(struct dt_imageio_module_storage_t *self)</a>
<a name="ln1112">{</a>
<a name="ln1113">  self-&gt;gui_data = g_malloc0(sizeof(dt_storage_facebook_gui_data_t));</a>
<a name="ln1114">  dt_storage_facebook_gui_data_t *ui = self-&gt;gui_data;</a>
<a name="ln1115">  ui-&gt;facebook_api = fb_api_init();</a>
<a name="ln1116"> </a>
<a name="ln1117">  self-&gt;widget = gtk_box_new(GTK_ORIENTATION_VERTICAL, 0);</a>
<a name="ln1118"> </a>
<a name="ln1119">  // create labels</a>
<a name="ln1120">  ui-&gt;label_album_title = GTK_LABEL(gtk_label_new(_(&quot;title&quot;)));</a>
<a name="ln1121">  ui-&gt;label_album_summary = GTK_LABEL(gtk_label_new(_(&quot;summary&quot;)));</a>
<a name="ln1122">  ui-&gt;label_album_privacy = GTK_LABEL(gtk_label_new(_(&quot;privacy&quot;)));</a>
<a name="ln1123">  ui-&gt;label_status = GTK_LABEL(gtk_label_new(NULL));</a>
<a name="ln1124"> </a>
<a name="ln1125">  gtk_widget_set_halign(GTK_WIDGET(ui-&gt;label_album_title), GTK_ALIGN_START);</a>
<a name="ln1126">  gtk_widget_set_halign(GTK_WIDGET(ui-&gt;label_album_summary), GTK_ALIGN_START);</a>
<a name="ln1127">  gtk_widget_set_halign(GTK_WIDGET(ui-&gt;label_album_privacy), GTK_ALIGN_START);</a>
<a name="ln1128"> </a>
<a name="ln1129">  // create entries</a>
<a name="ln1130">  GtkListStore *model_username = gtk_list_store_new(COMBO_USER_MODEL_NB_COL, G_TYPE_STRING, G_TYPE_STRING,</a>
<a name="ln1131">                                                    G_TYPE_STRING); // text, token, id</a>
<a name="ln1132">  ui-&gt;comboBox_username = GTK_COMBO_BOX(gtk_combo_box_new_with_model(GTK_TREE_MODEL(model_username)));</a>
<a name="ln1133">  GtkCellRenderer *p_cell = gtk_cell_renderer_text_new();</a>
<a name="ln1134">  gtk_cell_layout_pack_start(GTK_CELL_LAYOUT(ui-&gt;comboBox_username), p_cell, FALSE);</a>
<a name="ln1135">  gtk_cell_layout_set_attributes(GTK_CELL_LAYOUT(ui-&gt;comboBox_username), p_cell, &quot;text&quot;, 0, NULL);</a>
<a name="ln1136"> </a>
<a name="ln1137">  ui-&gt;entry_album_title = GTK_ENTRY(gtk_entry_new());</a>
<a name="ln1138">  ui-&gt;entry_album_summary = GTK_ENTRY(gtk_entry_new());</a>
<a name="ln1139"> </a>
<a name="ln1140">  dt_gui_key_accel_block_on_focus_connect(GTK_WIDGET(ui-&gt;comboBox_username));</a>
<a name="ln1141">  dt_gui_key_accel_block_on_focus_connect(GTK_WIDGET(ui-&gt;entry_album_title));</a>
<a name="ln1142">  dt_gui_key_accel_block_on_focus_connect(GTK_WIDGET(ui-&gt;entry_album_summary));</a>
<a name="ln1143"> </a>
<a name="ln1144">  gtk_entry_set_width_chars(GTK_ENTRY(ui-&gt;entry_album_title), 0);</a>
<a name="ln1145">  gtk_entry_set_width_chars(GTK_ENTRY(ui-&gt;entry_album_summary), 0);</a>
<a name="ln1146"> </a>
<a name="ln1147"> </a>
<a name="ln1148">  // retrieve saved accounts</a>
<a name="ln1149">  ui_refresh_users(ui);</a>
<a name="ln1150"> </a>
<a name="ln1151">  //////// album list /////////</a>
<a name="ln1152">  GtkWidget *albumlist = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0);</a>
<a name="ln1153">  GtkListStore *model_album</a>
<a name="ln1154">      = gtk_list_store_new(COMBO_ALBUM_MODEL_NB_COL, G_TYPE_STRING, G_TYPE_STRING); // name, id</a>
<a name="ln1155">  ui-&gt;comboBox_album = GTK_COMBO_BOX(gtk_combo_box_new_with_model(GTK_TREE_MODEL(model_album)));</a>
<a name="ln1156">  p_cell = gtk_cell_renderer_text_new();</a>
<a name="ln1157">  gtk_cell_layout_pack_start(GTK_CELL_LAYOUT(ui-&gt;comboBox_album), p_cell, FALSE);</a>
<a name="ln1158">  gtk_cell_layout_set_attributes(GTK_CELL_LAYOUT(ui-&gt;comboBox_album), p_cell, &quot;text&quot;, 0, NULL);</a>
<a name="ln1159"> </a>
<a name="ln1160">  gtk_widget_set_sensitive(GTK_WIDGET(ui-&gt;comboBox_album), FALSE);</a>
<a name="ln1161">  gtk_combo_box_set_row_separator_func(ui-&gt;comboBox_album, combobox_separator, ui-&gt;comboBox_album, NULL);</a>
<a name="ln1162">  gtk_box_pack_start(GTK_BOX(albumlist), GTK_WIDGET(ui-&gt;comboBox_album), TRUE, TRUE, 0);</a>
<a name="ln1163"> </a>
<a name="ln1164">  ui-&gt;comboBox_privacy = GTK_COMBO_BOX(gtk_combo_box_text_new());</a>
<a name="ln1165">  GtkListStore *list_store = gtk_list_store_new(COMBO_ALBUM_MODEL_NB_COL, G_TYPE_STRING, G_TYPE_INT);</a>
<a name="ln1166">  GtkTreeIter iter;</a>
<a name="ln1167">  gtk_list_store_append(list_store, &amp;iter);</a>
<a name="ln1168">  gtk_list_store_set(list_store, &amp;iter, COMBO_PRIVACY_MODEL_NAME_COL, _(&quot;only me&quot;),</a>
<a name="ln1169">                     COMBO_PRIVACY_MODEL_VAL_COL, FBALBUM_PRIVACY_SELF, -1);</a>
<a name="ln1170">  gtk_list_store_append(list_store, &amp;iter);</a>
<a name="ln1171">  gtk_list_store_set(list_store, &amp;iter, COMBO_PRIVACY_MODEL_NAME_COL, _(&quot;friends&quot;),</a>
<a name="ln1172">                     COMBO_PRIVACY_MODEL_VAL_COL, FBALBUM_PRIVACY_ALL_FRIENDS, -1);</a>
<a name="ln1173">  gtk_list_store_append(list_store, &amp;iter);</a>
<a name="ln1174">  gtk_list_store_set(list_store, &amp;iter, COMBO_PRIVACY_MODEL_NAME_COL, _(&quot;public&quot;),</a>
<a name="ln1175">                     COMBO_PRIVACY_MODEL_VAL_COL, FBALBUM_PRIVACY_EVERYONE, -1);</a>
<a name="ln1176">  gtk_list_store_append(list_store, &amp;iter);</a>
<a name="ln1177">  gtk_list_store_set(list_store, &amp;iter, COMBO_PRIVACY_MODEL_NAME_COL, _(&quot;friends of friends&quot;),</a>
<a name="ln1178">                     COMBO_PRIVACY_MODEL_VAL_COL, FBALBUM_PRIVACY_FRIENDS_OF_FRIENDS, -1);</a>
<a name="ln1179"> </a>
<a name="ln1180">  gtk_combo_box_set_model(ui-&gt;comboBox_privacy, GTK_TREE_MODEL(list_store));</a>
<a name="ln1181"> </a>
<a name="ln1182">  gtk_combo_box_set_active(GTK_COMBO_BOX(ui-&gt;comboBox_privacy), 1); // Set default permission to private</a>
<a name="ln1183">  ui-&gt;button_login = GTK_BUTTON(gtk_button_new_with_label(_(&quot;login&quot;)));</a>
<a name="ln1184">  ui-&gt;connected = FALSE;</a>
<a name="ln1185"> </a>
<a name="ln1186">  // pack the ui</a>
<a name="ln1187">  ////the auth box</a>
<a name="ln1188">  GtkWidget *hbox_auth = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 5);</a>
<a name="ln1189">  GtkWidget *vbox_auth_labels = gtk_box_new(GTK_ORIENTATION_VERTICAL, 0);</a>
<a name="ln1190">  GtkWidget *vbox_auth_fields = gtk_box_new(GTK_ORIENTATION_VERTICAL, 0);</a>
<a name="ln1191">  gtk_box_pack_start(GTK_BOX(hbox_auth), vbox_auth_labels, FALSE, FALSE, 0);</a>
<a name="ln1192">  gtk_box_pack_start(GTK_BOX(hbox_auth), vbox_auth_fields, TRUE, TRUE, 0);</a>
<a name="ln1193">  gtk_box_pack_start(GTK_BOX(self-&gt;widget), GTK_WIDGET(hbox_auth), TRUE, FALSE, 2);</a>
<a name="ln1194">  gtk_box_pack_start(GTK_BOX(vbox_auth_fields), GTK_WIDGET(ui-&gt;comboBox_username), TRUE, FALSE, 2);</a>
<a name="ln1195"> </a>
<a name="ln1196">  gtk_box_pack_start(GTK_BOX(vbox_auth_labels), GTK_WIDGET(gtk_label_new(&quot;&quot;)), TRUE, TRUE, 2);</a>
<a name="ln1197">  gtk_box_pack_start(GTK_BOX(vbox_auth_fields), GTK_WIDGET(ui-&gt;button_login), TRUE, FALSE, 2);</a>
<a name="ln1198"> </a>
<a name="ln1199">  gtk_box_pack_start(GTK_BOX(vbox_auth_fields), GTK_WIDGET(albumlist), TRUE, FALSE, 2);</a>
<a name="ln1200"> </a>
<a name="ln1201">  ////the album creation box</a>
<a name="ln1202">  ui-&gt;hbox_album = GTK_BOX(gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 5));</a>
<a name="ln1203">  gtk_widget_set_no_show_all(GTK_WIDGET(ui-&gt;hbox_album), TRUE); // hide it by default</a>
<a name="ln1204">  GtkWidget *vbox_album_labels = gtk_box_new(GTK_ORIENTATION_VERTICAL, 0);</a>
<a name="ln1205">  GtkWidget *vbox_album_fields = gtk_box_new(GTK_ORIENTATION_VERTICAL, 0);</a>
<a name="ln1206">  gtk_box_pack_start(GTK_BOX(self-&gt;widget), GTK_WIDGET(ui-&gt;hbox_album), TRUE, FALSE, 5);</a>
<a name="ln1207">  gtk_box_pack_start(GTK_BOX(ui-&gt;hbox_album), vbox_album_labels, FALSE, FALSE, 0);</a>
<a name="ln1208">  gtk_box_pack_start(GTK_BOX(ui-&gt;hbox_album), vbox_album_fields, TRUE, TRUE, 0);</a>
<a name="ln1209">  gtk_box_pack_start(GTK_BOX(vbox_album_labels), GTK_WIDGET(ui-&gt;label_album_title), TRUE, TRUE, 0);</a>
<a name="ln1210">  gtk_box_pack_start(GTK_BOX(vbox_album_fields), GTK_WIDGET(ui-&gt;entry_album_title), TRUE, FALSE, 0);</a>
<a name="ln1211">  gtk_box_pack_start(GTK_BOX(vbox_album_labels), GTK_WIDGET(ui-&gt;label_album_summary), TRUE, TRUE, 0);</a>
<a name="ln1212">  gtk_box_pack_start(GTK_BOX(vbox_album_fields), GTK_WIDGET(ui-&gt;entry_album_summary), TRUE, FALSE, 0);</a>
<a name="ln1213">  gtk_box_pack_start(GTK_BOX(vbox_album_labels), GTK_WIDGET(ui-&gt;label_album_privacy), TRUE, TRUE, 0);</a>
<a name="ln1214">  gtk_box_pack_start(GTK_BOX(vbox_album_fields), GTK_WIDGET(ui-&gt;comboBox_privacy), TRUE, FALSE, 0);</a>
<a name="ln1215"> </a>
<a name="ln1216">  // connect buttons to signals</a>
<a name="ln1217">  g_signal_connect(G_OBJECT(ui-&gt;button_login), &quot;clicked&quot;, G_CALLBACK(ui_login_clicked), (gpointer)ui);</a>
<a name="ln1218">  g_signal_connect(G_OBJECT(ui-&gt;comboBox_username), &quot;changed&quot;, G_CALLBACK(ui_combo_username_changed),</a>
<a name="ln1219">                   (gpointer)ui);</a>
<a name="ln1220">  g_signal_connect(G_OBJECT(ui-&gt;comboBox_album), &quot;changed&quot;, G_CALLBACK(ui_combo_album_changed), (gpointer)ui);</a>
<a name="ln1221"> </a>
<a name="ln1222">  g_object_unref(model_username);</a>
<a name="ln1223">  g_object_unref(model_album);</a>
<a name="ln1224">  g_object_unref(list_store);</a>
<a name="ln1225">}</a>
<a name="ln1226"> </a>
<a name="ln1227">/* destroy resources */</a>
<a name="ln1228">void gui_cleanup(struct dt_imageio_module_storage_t *self)</a>
<a name="ln1229">{</a>
<a name="ln1230">  dt_storage_facebook_gui_data_t *ui = self-&gt;gui_data;</a>
<a name="ln1231">  dt_gui_key_accel_block_on_focus_disconnect(GTK_WIDGET(ui-&gt;comboBox_username));</a>
<a name="ln1232">  dt_gui_key_accel_block_on_focus_disconnect(GTK_WIDGET(ui-&gt;entry_album_title));</a>
<a name="ln1233">  dt_gui_key_accel_block_on_focus_disconnect(GTK_WIDGET(ui-&gt;entry_album_summary));</a>
<a name="ln1234">  if(ui-&gt;facebook_api != NULL) fb_api_destroy(ui-&gt;facebook_api);</a>
<a name="ln1235">  g_free(self-&gt;gui_data);</a>
<a name="ln1236">}</a>
<a name="ln1237"> </a>
<a name="ln1238">/* reset options to defaults */</a>
<a name="ln1239">void gui_reset(struct dt_imageio_module_storage_t *self)</a>
<a name="ln1240">{</a>
<a name="ln1241">  // TODO?</a>
<a name="ln1242">}</a>
<a name="ln1243"> </a>
<a name="ln1244">/* try and see if this format is supported? */</a>
<a name="ln1245">int supported(struct dt_imageio_module_storage_t *self, struct dt_imageio_module_format_t *format)</a>
<a name="ln1246">{</a>
<a name="ln1247">  if(strcmp(format-&gt;mime(NULL), &quot;image/jpeg&quot;) == 0)</a>
<a name="ln1248">    return 1;</a>
<a name="ln1249">  else if(strcmp(format-&gt;mime(NULL), &quot;image/png&quot;) == 0)</a>
<a name="ln1250">    return 1;</a>
<a name="ln1251">  return 0;</a>
<a name="ln1252">}</a>
<a name="ln1253"> </a>
<a name="ln1254">/* this actually does the work */</a>
<a name="ln1255">int store(dt_imageio_module_storage_t *self, struct dt_imageio_module_data_t *sdata, const int imgid,</a>
<a name="ln1256">          dt_imageio_module_format_t *format, dt_imageio_module_data_t *fdata, const int num, const int total,</a>
<a name="ln1257">          const gboolean high_quality, const gboolean upscale, dt_colorspaces_color_profile_type_t icc_type,</a>
<a name="ln1258">          const gchar *icc_filename, dt_iop_color_intent_t icc_intent)</a>
<a name="ln1259">{</a>
<a name="ln1260">  gint result = 1;</a>
<a name="ln1261">  dt_storage_facebook_param_t *p = (dt_storage_facebook_param_t *)sdata;</a>
<a name="ln1262"> </a>
<a name="ln1263">  const char *ext = format-&gt;extension(fdata);</a>
<a name="ln1264">  char fname[PATH_MAX] = { 0 };</a>
<a name="ln1265">  dt_loc_get_tmp_dir(fname, sizeof(fname));</a>
<a name="ln1266">  g_strlcat(fname, &quot;/darktable.XXXXXX.&quot;, sizeof(fname));</a>
<a name="ln1267">  g_strlcat(fname, ext, sizeof(fname));</a>
<a name="ln1268"> </a>
<a name="ln1269">  gint fd = g_mkstemp(fname);</a>
<a name="ln1270">  if(fd == -1)</a>
<a name="ln1271">  {</a>
<a name="ln1272">    dt_control_log(&quot;failed to create temporary image for facebook export&quot;);</a>
<a name="ln1273">    return 1;</a>
<a name="ln1274">  }</a>
<a name="ln1275">  close(fd);</a>
<a name="ln1276"> </a>
<a name="ln1277">  // get metadata</a>
<a name="ln1278">  const dt_image_t *img = dt_image_cache_get(darktable.image_cache, imgid, 'r');</a>
<a name="ln1279">  char *caption = NULL;</a>
<a name="ln1280">  GList *caption_list = NULL;</a>
<a name="ln1281"> </a>
<a name="ln1282">  caption_list = dt_metadata_get(img-&gt;id, &quot;Xmp.dc.title&quot;, NULL);</a>
<a name="ln1283">  if(caption_list != NULL)</a>
<a name="ln1284">  {</a>
<a name="ln1285">    caption = g_strdup(caption_list-&gt;data);</a>
<a name="ln1286">    g_list_free_full(caption_list, &amp;g_free);</a>
<a name="ln1287">  }</a>
<a name="ln1288">  else</a>
<a name="ln1289">  {</a>
<a name="ln1290">    caption_list = dt_metadata_get(img-&gt;id, &quot;Xmp.dc.description&quot;, NULL);</a>
<a name="ln1291">    if(caption_list != NULL)</a>
<a name="ln1292">    {</a>
<a name="ln1293">      caption = g_strdup(caption_list-&gt;data);</a>
<a name="ln1294">      g_list_free_full(caption_list, &amp;g_free);</a>
<a name="ln1295">    }</a>
<a name="ln1296">  }</a>
<a name="ln1297">  dt_image_cache_read_release(darktable.image_cache, img);</a>
<a name="ln1298"> </a>
<a name="ln1299">  // facebook doesn't allow pictures bigger than FB_IMAGE_MAX_SIZExFB_IMAGE_MAX_SIZE px</a>
<a name="ln1300">  if(fdata-&gt;max_height == 0 || fdata-&gt;max_height &gt; FB_IMAGE_MAX_SIZE) fdata-&gt;max_height = FB_IMAGE_MAX_SIZE;</a>
<a name="ln1301">  if(fdata-&gt;max_width == 0 || fdata-&gt;max_width &gt; FB_IMAGE_MAX_SIZE) fdata-&gt;max_width = FB_IMAGE_MAX_SIZE;</a>
<a name="ln1302"> </a>
<a name="ln1303">  if(dt_imageio_export(imgid, fname, format, fdata, high_quality, upscale, FALSE, icc_type, icc_filename, icc_intent,</a>
<a name="ln1304">                       self, sdata, num, total)</a>
<a name="ln1305">     != 0)</a>
<a name="ln1306">  {</a>
<a name="ln1307">    g_printerr(&quot;[facebook] could not export to file: `%s'!\n&quot;, fname);</a>
<a name="ln1308">    dt_control_log(_(&quot;could not export to file `%s'!&quot;), fname);</a>
<a name="ln1309">    result = 0;</a>
<a name="ln1310">    goto cleanup;</a>
<a name="ln1311">  }</a>
<a name="ln1312"> </a>
<a name="ln1313">  if(p-&gt;facebook_ctx-&gt;album_id == NULL)</a>
<a name="ln1314">  {</a>
<a name="ln1315">    if(p-&gt;facebook_ctx-&gt;album_title == NULL || strlen(p-&gt;facebook_ctx-&gt;album_title) == 0)</a>
<a name="ln1316">    {</a>
<a name="ln1317">      dt_control_log(_(&quot;unable to create album, no title provided&quot;));</a>
<a name="ln1318">      result = 0;</a>
<a name="ln1319">      goto cleanup;</a>
<a name="ln1320">    }</a>
<a name="ln1321">    const gchar *album_id</a>
<a name="ln1322">        = fb_create_album(p-&gt;facebook_ctx, p-&gt;facebook_ctx-&gt;album_title, p-&gt;facebook_ctx-&gt;album_summary,</a>
<a name="ln1323">                          p-&gt;facebook_ctx-&gt;album_permission);</a>
<a name="ln1324">    if(album_id == NULL)</a>
<a name="ln1325">    {</a>
<a name="ln1326">      dt_control_log(_(&quot;unable to create album&quot;));</a>
<a name="ln1327">      result = 0;</a>
<a name="ln1328">      goto cleanup;</a>
<a name="ln1329">    }</a>
<a name="ln1330">    p-&gt;facebook_ctx-&gt;album_id = g_strdup(album_id);</a>
<a name="ln1331">  }</a>
<a name="ln1332"> </a>
<a name="ln1333">  const char *photoid = fb_upload_photo_to_album(p-&gt;facebook_ctx, p-&gt;facebook_ctx-&gt;album_id, fname, caption);</a>
<a name="ln1334">  if(photoid == NULL)</a>
<a name="ln1335">  {</a>
<a name="ln1336">    dt_control_log(_(&quot;unable to export photo to webalbum&quot;));</a>
<a name="ln1337">    result = 0;</a>
<a name="ln1338">    goto cleanup;</a>
<a name="ln1339">  }</a>
<a name="ln1340"> </a>
<a name="ln1341">cleanup:</a>
<a name="ln1342">  g_unlink(fname);</a>
<a name="ln1343">  g_free(caption);</a>
<a name="ln1344"> </a>
<a name="ln1345">  if(result)</a>
<a name="ln1346">  {</a>
<a name="ln1347">    // this makes sense only if the export was successful</a>
<a name="ln1348">    dt_control_log(ngettext(&quot;%d/%d exported to facebook webalbum&quot;, &quot;%d/%d exported to facebook webalbum&quot;, num),</a>
<a name="ln1349">                   num, total);</a>
<a name="ln1350">  }</a>
<a name="ln1351">  return 0;</a>
<a name="ln1352">}</a>
<a name="ln1353"> </a>
<a name="ln1354">static gboolean _finalize_store(gpointer user_data)</a>
<a name="ln1355">{</a>
<a name="ln1356">  dt_storage_facebook_gui_data_t *ui = (dt_storage_facebook_gui_data_t *)user_data;</a>
<a name="ln1357">  ui_reset_albums_creation(ui);</a>
<a name="ln1358">  ui_refresh_albums(ui);</a>
<a name="ln1359"> </a>
<a name="ln1360">  return FALSE;</a>
<a name="ln1361">}</a>
<a name="ln1362"> </a>
<a name="ln1363">void finalize_store(struct dt_imageio_module_storage_t *self, dt_imageio_module_data_t *data)</a>
<a name="ln1364">{</a>
<a name="ln1365">  g_main_context_invoke(NULL, _finalize_store, self-&gt;gui_data);</a>
<a name="ln1366">}</a>
<a name="ln1367"> </a>
<a name="ln1368">size_t params_size(dt_imageio_module_storage_t *self)</a>
<a name="ln1369">{</a>
<a name="ln1370">  return sizeof(gint64);</a>
<a name="ln1371">}</a>
<a name="ln1372"> </a>
<a name="ln1373"> </a>
<a name="ln1374">void init(dt_imageio_module_storage_t *self)</a>
<a name="ln1375">{</a>
<a name="ln1376">}</a>
<a name="ln1377">void *get_params(struct dt_imageio_module_storage_t *self)</a>
<a name="ln1378">{</a>
<a name="ln1379">  dt_storage_facebook_gui_data_t *ui = (dt_storage_facebook_gui_data_t *)self-&gt;gui_data;</a>
<a name="ln1380">  if(!ui) return NULL; // gui not initialized, CLI mode</a>
<a name="ln1381">  if(ui-&gt;facebook_api == NULL || ui-&gt;facebook_api-&gt;token == NULL)</a>
<a name="ln1382">  {</a>
<a name="ln1383">    return NULL;</a>
<a name="ln1384">  }</a>
<a name="ln1385">  dt_storage_facebook_param_t *p</a>
<a name="ln1386">      = (dt_storage_facebook_param_t *)g_malloc0(sizeof(dt_storage_facebook_param_t));</a>
<a name="ln1387">  p-&gt;hash = 1;</a>
<a name="ln1388">  p-&gt;facebook_ctx = ui-&gt;facebook_api;</a>
<a name="ln1389">  int index = gtk_combo_box_get_active(ui-&gt;comboBox_album);</a>
<a name="ln1390">  if(index &lt; 0)</a>
<a name="ln1391">  {</a>
<a name="ln1392">    g_free(p);</a>
<a name="ln1393">    return NULL;</a>
<a name="ln1394">  }</a>
<a name="ln1395">  else if(index == 0)</a>
<a name="ln1396">  {</a>
<a name="ln1397">    p-&gt;facebook_ctx-&gt;album_id = NULL;</a>
<a name="ln1398">    p-&gt;facebook_ctx-&gt;album_title = g_strdup(gtk_entry_get_text(ui-&gt;entry_album_title));</a>
<a name="ln1399">    p-&gt;facebook_ctx-&gt;album_summary = g_strdup(gtk_entry_get_text(ui-&gt;entry_album_summary));</a>
<a name="ln1400">    GtkTreeModel *model = gtk_combo_box_get_model(ui-&gt;comboBox_privacy);</a>
<a name="ln1401">    GtkTreeIter iter;</a>
<a name="ln1402">    int permission = -1;</a>
<a name="ln1403">    gtk_combo_box_get_active_iter(ui-&gt;comboBox_privacy, &amp;iter);</a>
<a name="ln1404">    gtk_tree_model_get(model, &amp;iter, COMBO_PRIVACY_MODEL_VAL_COL, &amp;permission, -1);</a>
<a name="ln1405">    p-&gt;facebook_ctx-&gt;album_permission = permission;</a>
<a name="ln1406">  }</a>
<a name="ln1407">  else</a>
<a name="ln1408">  {</a>
<a name="ln1409">    GtkTreeModel *model = gtk_combo_box_get_model(ui-&gt;comboBox_album);</a>
<a name="ln1410">    GtkTreeIter iter;</a>
<a name="ln1411">    gchar *albumid = NULL;</a>
<a name="ln1412">    gtk_combo_box_get_active_iter(ui-&gt;comboBox_album, &amp;iter);</a>
<a name="ln1413">    gtk_tree_model_get(model, &amp;iter, COMBO_ALBUM_MODEL_ID_COL, &amp;albumid, -1);</a>
<a name="ln1414">    p-&gt;facebook_ctx-&gt;album_id = g_strdup(albumid);</a>
<a name="ln1415">  }</a>
<a name="ln1416"> </a>
<a name="ln1417">  // recreate a new context for further usages</a>
<a name="ln1418">  ui-&gt;facebook_api = fb_api_init();</a>
<a name="ln1419">  ui-&gt;facebook_api-&gt;token = g_strdup(p-&gt;facebook_ctx-&gt;token);</a>
<a name="ln1420">  return p;</a>
<a name="ln1421">}</a>
<a name="ln1422"> </a>
<a name="ln1423"> </a>
<a name="ln1424">void free_params(struct dt_imageio_module_storage_t *self, dt_imageio_module_data_t *data)</a>
<a name="ln1425">{</a>
<a name="ln1426">  if(!data) return;</a>
<a name="ln1427">  dt_storage_facebook_param_t *p = (dt_storage_facebook_param_t *)data;</a>
<a name="ln1428">  fb_api_destroy(p-&gt;facebook_ctx);</a>
<a name="ln1429">  g_free(p);</a>
<a name="ln1430">}</a>
<a name="ln1431"> </a>
<a name="ln1432">int set_params(struct dt_imageio_module_storage_t *self, const void *params, const int size)</a>
<a name="ln1433">{</a>
<a name="ln1434">  if(size != self-&gt;params_size(self)) return 1;</a>
<a name="ln1435">  // gui stuff not updated, as sensitive user data is not stored in the preset.</a>
<a name="ln1436">  // TODO: store name/hash in kwallet/etc module and get encrypted stuff from there!</a>
<a name="ln1437">  return 0;</a>
<a name="ln1438">}</a>
<a name="ln1439"> </a>
<a name="ln1440">// modelines: These editor modelines have been set for all relevant files by tools/update_modelines.sh</a>
<a name="ln1441">// vim: shiftwidth=2 expandtab tabstop=2 cindent</a>
<a name="ln1442">// kate: tab-indents: off; indent-width 2; replace-tabs on; indent-mode cstyle; remove-trailing-spaces modified;</a>

</code></pre>
<div class="balloon" rel="335"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v627/" target="_blank">V627</a> Consider inspecting the expression. The argument of sizeof() is the macro which expands to a number.</p></div>
<div class="balloon" rel="336"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v568/" target="_blank">V568</a> It's odd that 'sizeof()' operator evaluates the size of a pointer to a class, but not the size of the 'response' class object.</p></div>
<div class="balloon" rel="412"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v568/" target="_blank">V568</a> It's odd that 'sizeof()' operator evaluates the size of a pointer to a class, but not the size of the 'formlist.formpost' class object.</p></div>
<div class="balloon" rel="413"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v627/" target="_blank">V627</a> Consider inspecting the expression. The argument of sizeof() is the macro which expands to a number.</p></div>
<div class="balloon" rel="415"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v568/" target="_blank">V568</a> It's odd that 'sizeof()' operator evaluates the size of a pointer to a class, but not the size of the 'response' class object.</p></div>
<div class="balloon" rel="901"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1004/" target="_blank">V1004</a> The 'albumList' pointer was used unsafely after it was verified against nullptr. Check lines: 895, 901.</p></div>
<div class="balloon" rel="901"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v595/" target="_blank">V595</a> The 'albumList' pointer was utilized before it was verified against nullptr. Check lines: 901, 903.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
