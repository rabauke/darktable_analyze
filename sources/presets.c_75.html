
<html>
<head>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>
<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2">    This file is part of darktable,</a>
<a name="ln3">    copyright (c) 2009--2010 johannes hanika.</a>
<a name="ln4"> </a>
<a name="ln5">    darktable is free software: you can redistribute it and/or modify</a>
<a name="ln6">    it under the terms of the GNU General Public License as published by</a>
<a name="ln7">    the Free Software Foundation, either version 3 of the License, or</a>
<a name="ln8">    (at your option) any later version.</a>
<a name="ln9"> </a>
<a name="ln10">    darktable is distributed in the hope that it will be useful,</a>
<a name="ln11">    but WITHOUT ANY WARRANTY; without even the implied warranty of</a>
<a name="ln12">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</a>
<a name="ln13">    GNU General Public License for more details.</a>
<a name="ln14"> </a>
<a name="ln15">    You should have received a copy of the GNU General Public License</a>
<a name="ln16">    along with darktable.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</a>
<a name="ln17">*/</a>
<a name="ln18"> </a>
<a name="ln19">#ifdef HAVE_CONFIG_H</a>
<a name="ln20">#include &quot;config.h&quot;</a>
<a name="ln21">#endif</a>
<a name="ln22">#include &quot;bauhaus/bauhaus.h&quot;</a>
<a name="ln23">#include &quot;common/darktable.h&quot;</a>
<a name="ln24">#include &quot;common/debug.h&quot;</a>
<a name="ln25">#include &quot;develop/blend.h&quot;</a>
<a name="ln26">#include &quot;develop/develop.h&quot;</a>
<a name="ln27">#include &quot;gui/accelerators.h&quot;</a>
<a name="ln28">#include &quot;gui/gtk.h&quot;</a>
<a name="ln29">#include &quot;gui/presets.h&quot;</a>
<a name="ln30">#include &quot;libs/modulegroups.h&quot;</a>
<a name="ln31">#ifdef GDK_WINDOWING_QUARTZ</a>
<a name="ln32">#include &quot;osx/osx.h&quot;</a>
<a name="ln33">#endif</a>
<a name="ln34">#include &lt;assert.h&gt;</a>
<a name="ln35">#include &lt;stdlib.h&gt;</a>
<a name="ln36"> </a>
<a name="ln37"> </a>
<a name="ln38">static const int dt_gui_presets_exposure_value_cnt = 24;</a>
<a name="ln39">static const float dt_gui_presets_exposure_value[]</a>
<a name="ln40">    = { 0.,       1. / 8000, 1. / 4000, 1. / 2000, 1. / 1000, 1. / 1000, 1. / 500, 1. / 250,</a>
<a name="ln41">        1. / 125, 1. / 60,   1. / 30,   1. / 15,   1. / 15,   1. / 8,    1. / 4,   1. / 2,</a>
<a name="ln42">        1,        2,         4,         8,         15,        30,        60,       FLT_MAX };</a>
<a name="ln43">static const char *dt_gui_presets_exposure_value_str[]</a>
<a name="ln44">    = { &quot;0&quot;,     &quot;1/8000&quot;, &quot;1/4000&quot;, &quot;1/2000&quot;, &quot;1/1000&quot;, &quot;1/1000&quot;, &quot;1/500&quot;, &quot;1/250&quot;,</a>
<a name="ln45">        &quot;1/125&quot;, &quot;1/60&quot;,   &quot;1/30&quot;,   &quot;1/15&quot;,   &quot;1/15&quot;,   &quot;1/8&quot;,    &quot;1/4&quot;,   &quot;1/2&quot;,</a>
<a name="ln46">        &quot;1\&quot;&quot;,   &quot;2\&quot;&quot;,    &quot;4\&quot;&quot;,    &quot;8\&quot;&quot;,    &quot;15\&quot;&quot;,   &quot;30\&quot;&quot;,   &quot;60\&quot;&quot;,  &quot;+&quot; };</a>
<a name="ln47">static const int dt_gui_presets_aperture_value_cnt = 19;</a>
<a name="ln48">static const float dt_gui_presets_aperture_value[]</a>
<a name="ln49">    = { 0,    0.5,  0.7,  1.0,  1.4,  2.0,  2.8,  4.0,   5.6,    8.0,</a>
<a name="ln50">        11.0, 16.0, 22.0, 32.0, 45.0, 64.0, 90.0, 128.0, FLT_MAX };</a>
<a name="ln51">static const char *dt_gui_presets_aperture_value_str[]</a>
<a name="ln52">    = { &quot;f/0&quot;,  &quot;f/0.5&quot;, &quot;f/0.7&quot;, &quot;f/1.0&quot;, &quot;f/1.4&quot;, &quot;f/2&quot;,  &quot;f/2.8&quot;, &quot;f/4&quot;,   &quot;f/5.6&quot;, &quot;f/8&quot;,</a>
<a name="ln53">        &quot;f/11&quot;, &quot;f/16&quot;,  &quot;f/22&quot;,  &quot;f/32&quot;,  &quot;f/45&quot;,  &quot;f/64&quot;, &quot;f/90&quot;,  &quot;f/128&quot;, &quot;f/+&quot; };</a>
<a name="ln54"> </a>
<a name="ln55">// format string and corresponding flag stored into the database</a>
<a name="ln56">static const char *dt_gui_presets_format_value_str[3] = { N_(&quot;normal images&quot;),</a>
<a name="ln57">                                                          N_(&quot;raw&quot;),</a>
<a name="ln58">                                                          N_(&quot;HDR&quot;)};</a>
<a name="ln59">static const int dt_gui_presets_format_flag[3] = { FOR_LDR, FOR_RAW, FOR_HDR };</a>
<a name="ln60"> </a>
<a name="ln61">typedef struct dt_gui_presets_edit_dialog_t</a>
<a name="ln62">{</a>
<a name="ln63">  dt_iop_module_t *module;</a>
<a name="ln64">  GtkEntry *name, *description;</a>
<a name="ln65">  GtkCheckButton *autoapply, *filter;</a>
<a name="ln66">  GtkWidget *details;</a>
<a name="ln67">  GtkWidget *model, *maker, *lens;</a>
<a name="ln68">  GtkWidget *iso_min, *iso_max;</a>
<a name="ln69">  GtkWidget *exposure_min, *exposure_max;</a>
<a name="ln70">  GtkWidget *aperture_min, *aperture_max;</a>
<a name="ln71">  GtkWidget *focal_length_min, *focal_length_max;</a>
<a name="ln72">  gchar *original_name;</a>
<a name="ln73">  gint old_id;</a>
<a name="ln74">  GtkWidget *format_btn[3];</a>
<a name="ln75">} dt_gui_presets_edit_dialog_t;</a>
<a name="ln76"> </a>
<a name="ln77">// this is also called for non-gui applications linking to libdarktable!</a>
<a name="ln78">// so beware, don't use any darktable.gui stuff here .. (or change this behaviour in darktable.c)</a>
<a name="ln79">void dt_gui_presets_init()</a>
<a name="ln80">{</a>
<a name="ln81">  // remove auto generated presets from plugins, not the user included ones.</a>
<a name="ln82">  DT_DEBUG_SQLITE3_EXEC(dt_database_get(darktable.db), &quot;DELETE FROM data.presets WHERE writeprotect = 1&quot;, NULL,</a>
<a name="ln83">                        NULL, NULL);</a>
<a name="ln84">}</a>
<a name="ln85"> </a>
<a name="ln86">void dt_gui_presets_add_generic(const char *name, dt_dev_operation_t op, const int32_t version,</a>
<a name="ln87">                                const void *params, const int32_t params_size, const int32_t enabled)</a>
<a name="ln88">{</a>
<a name="ln89">  dt_develop_blend_params_t default_blendop_params</a>
<a name="ln90">      = { DEVELOP_MASK_DISABLED,</a>
<a name="ln91">          DEVELOP_BLEND_NORMAL2,</a>
<a name="ln92">          100.0f,</a>
<a name="ln93">          DEVELOP_COMBINE_NORM_EXCL,</a>
<a name="ln94">          0,</a>
<a name="ln95">          0,</a>
<a name="ln96">          0.0f,</a>
<a name="ln97">          DEVELOP_MASK_GUIDE_IN,</a>
<a name="ln98">          0.0f,</a>
<a name="ln99">          0.0f,</a>
<a name="ln100">          0.0f,</a>
<a name="ln101">          { 0, 0, 0, 0 },</a>
<a name="ln102">          { 0.0f, 0.0f, 1.0f, 1.0f, 0.0f, 0.0f, 1.0f, 1.0f, 0.0f, 0.0f, 1.0f, 1.0f, 0.0f, 0.0f, 1.0f, 1.0f,</a>
<a name="ln103">            0.0f, 0.0f, 1.0f, 1.0f, 0.0f, 0.0f, 1.0f, 1.0f, 0.0f, 0.0f, 1.0f, 1.0f, 0.0f, 0.0f, 1.0f, 1.0f,</a>
<a name="ln104">            0.0f, 0.0f, 1.0f, 1.0f, 0.0f, 0.0f, 1.0f, 1.0f, 0.0f, 0.0f, 1.0f, 1.0f, 0.0f, 0.0f, 1.0f, 1.0f,</a>
<a name="ln105">            0.0f, 0.0f, 1.0f, 1.0f, 0.0f, 0.0f, 1.0f, 1.0f, 0.0f, 0.0f, 1.0f, 1.0f, 0.0f, 0.0f, 1.0f, 1.0f },</a>
<a name="ln106">          { 0 }, 0, 0, FALSE };</a>
<a name="ln107">  dt_gui_presets_add_with_blendop(</a>
<a name="ln108">      name, op, version, params, params_size,</a>
<a name="ln109">      &amp;default_blendop_params, enabled);</a>
<a name="ln110">}</a>
<a name="ln111"> </a>
<a name="ln112"> </a>
<a name="ln113">void dt_gui_presets_add_with_blendop(</a>
<a name="ln114">    const char *name, dt_dev_operation_t op, const int32_t version,</a>
<a name="ln115">    const void *params, const int32_t params_size,</a>
<a name="ln116">    const void *blend_params, const int32_t enabled)</a>
<a name="ln117">{</a>
<a name="ln118">  sqlite3_stmt *stmt;</a>
<a name="ln119"> </a>
<a name="ln120">  DT_DEBUG_SQLITE3_PREPARE_V2(</a>
<a name="ln121">      dt_database_get(darktable.db),</a>
<a name="ln122">      &quot;INSERT OR REPLACE INTO data.presets (name, description, operation, op_version, op_params, enabled, &quot;</a>
<a name="ln123">      &quot;blendop_params, blendop_version, multi_priority, multi_name, model, maker, lens, &quot;</a>
<a name="ln124">      &quot;iso_min, iso_max, exposure_min, exposure_max, aperture_min, aperture_max, focal_length_min, &quot;</a>
<a name="ln125">      &quot;focal_length_max, &quot;</a>
<a name="ln126">      &quot;writeprotect, autoapply, filter, def, format) &quot;</a>
<a name="ln127">      &quot;VALUES (?1, '', ?2, ?3, ?4, ?5, ?6, ?7, 0, '', '%', '%', '%', 0, 340282346638528859812000000000000000000, &quot;</a>
<a name="ln128">      &quot;0, 10000000, 0, 100000000, 0, &quot;</a>
<a name="ln129">      &quot;1000, 1, 0, 0, 0, 0)&quot;,</a>
<a name="ln130">      -1, &amp;stmt, NULL);</a>
<a name="ln131">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 1, name, -1, SQLITE_TRANSIENT);</a>
<a name="ln132">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 2, op, -1, SQLITE_TRANSIENT);</a>
<a name="ln133">  DT_DEBUG_SQLITE3_BIND_INT(stmt, 3, version);</a>
<a name="ln134">  DT_DEBUG_SQLITE3_BIND_BLOB(stmt, 4, params, params_size, SQLITE_TRANSIENT);</a>
<a name="ln135">  DT_DEBUG_SQLITE3_BIND_INT(stmt, 5, enabled);</a>
<a name="ln136">  DT_DEBUG_SQLITE3_BIND_BLOB(stmt, 6, blend_params, sizeof(dt_develop_blend_params_t),</a>
<a name="ln137">                             SQLITE_TRANSIENT);</a>
<a name="ln138">  DT_DEBUG_SQLITE3_BIND_INT(stmt, 7, dt_develop_blend_version());</a>
<a name="ln139">  sqlite3_step(stmt);</a>
<a name="ln140">  sqlite3_finalize(stmt);</a>
<a name="ln141">}</a>
<a name="ln142"> </a>
<a name="ln143">static gchar *get_active_preset_name(dt_iop_module_t *module)</a>
<a name="ln144">{</a>
<a name="ln145">  sqlite3_stmt *stmt;</a>
<a name="ln146">  DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln147">                              &quot;SELECT name, op_params, blendop_params, enabled FROM data.presets WHERE &quot;</a>
<a name="ln148">                              &quot;operation=?1 AND op_version=?2 ORDER BY writeprotect DESC, LOWER(name), rowid&quot;,</a>
<a name="ln149">                              -1, &amp;stmt, NULL);</a>
<a name="ln150">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 1, module-&gt;op, -1, SQLITE_TRANSIENT);</a>
<a name="ln151">  DT_DEBUG_SQLITE3_BIND_INT(stmt, 2, module-&gt;version());</a>
<a name="ln152">  gchar *name = NULL;</a>
<a name="ln153">  // collect all presets for op from db</a>
<a name="ln154">  while(sqlite3_step(stmt) == SQLITE_ROW)</a>
<a name="ln155">  {</a>
<a name="ln156">    void *op_params = (void *)sqlite3_column_blob(stmt, 1);</a>
<a name="ln157">    int32_t op_params_size = sqlite3_column_bytes(stmt, 1);</a>
<a name="ln158">    void *blendop_params = (void *)sqlite3_column_blob(stmt, 2);</a>
<a name="ln159">    int32_t bl_params_size = sqlite3_column_bytes(stmt, 2);</a>
<a name="ln160">    int enabled = sqlite3_column_int(stmt, 3);</a>
<a name="ln161">    if(!memcmp(module-&gt;params, op_params, MIN(op_params_size, module-&gt;params_size))</a>
<a name="ln162">       &amp;&amp; !memcmp(module-&gt;blend_params, blendop_params,</a>
<a name="ln163">                  MIN(bl_params_size, sizeof(dt_develop_blend_params_t))) &amp;&amp; module-&gt;enabled == enabled)</a>
<a name="ln164">    {</a>
<a name="ln165">      name = g_strdup((char *)sqlite3_column_text(stmt, 0));</a>
<a name="ln166">      break;</a>
<a name="ln167">    }</a>
<a name="ln168">  }</a>
<a name="ln169">  sqlite3_finalize(stmt);</a>
<a name="ln170">  return name;</a>
<a name="ln171">}</a>
<a name="ln172"> </a>
<a name="ln173">static void menuitem_delete_preset(GtkMenuItem *menuitem, dt_iop_module_t *module)</a>
<a name="ln174">{</a>
<a name="ln175">  sqlite3_stmt *stmt;</a>
<a name="ln176">  gchar *name = get_active_preset_name(module);</a>
<a name="ln177">  if(name == NULL) return;</a>
<a name="ln178"> </a>
<a name="ln179">  GtkWidget *window = dt_ui_main_window(darktable.gui-&gt;ui);</a>
<a name="ln180">  GtkWidget *dialog</a>
<a name="ln181">      = gtk_message_dialog_new(GTK_WINDOW(window), GTK_DIALOG_DESTROY_WITH_PARENT, GTK_MESSAGE_QUESTION,</a>
<a name="ln182">                               GTK_BUTTONS_YES_NO, _(&quot;do you really want to delete the preset `%s'?&quot;), name);</a>
<a name="ln183">#ifdef GDK_WINDOWING_QUARTZ</a>
<a name="ln184">  dt_osx_disallow_fullscreen(dialog);</a>
<a name="ln185">#endif</a>
<a name="ln186">  gtk_window_set_title(GTK_WINDOW(dialog), _(&quot;delete preset?&quot;));</a>
<a name="ln187">  if(gtk_dialog_run(GTK_DIALOG(dialog)) == GTK_RESPONSE_YES)</a>
<a name="ln188">  {</a>
<a name="ln189">    char tmp_path[1024];</a>
<a name="ln190">    snprintf(tmp_path, sizeof(tmp_path), &quot;%s/%s&quot;, _(&quot;preset&quot;), name);</a>
<a name="ln191">    dt_accel_deregister_iop(module, tmp_path);</a>
<a name="ln192">    DT_DEBUG_SQLITE3_PREPARE_V2(</a>
<a name="ln193">        dt_database_get(darktable.db),</a>
<a name="ln194">        &quot;DELETE FROM data.presets WHERE name=?1 AND operation=?2 AND op_version=?3 AND writeprotect=0&quot;, -1, &amp;stmt,</a>
<a name="ln195">        NULL);</a>
<a name="ln196">    DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 1, name, -1, SQLITE_TRANSIENT);</a>
<a name="ln197">    DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 2, module-&gt;op, -1, SQLITE_TRANSIENT);</a>
<a name="ln198">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 3, module-&gt;version());</a>
<a name="ln199">    sqlite3_step(stmt);</a>
<a name="ln200">    sqlite3_finalize(stmt);</a>
<a name="ln201">  }</a>
<a name="ln202">  g_free(name);</a>
<a name="ln203">  gtk_widget_destroy(dialog);</a>
<a name="ln204">}</a>
<a name="ln205"> </a>
<a name="ln206">static void edit_preset_response(GtkDialog *dialog, gint response_id, dt_gui_presets_edit_dialog_t *g)</a>
<a name="ln207">{</a>
<a name="ln208">  gint is_new = 0;</a>
<a name="ln209"> </a>
<a name="ln210">  if(response_id == GTK_RESPONSE_ACCEPT)</a>
<a name="ln211">  {</a>
<a name="ln212">    sqlite3_stmt *stmt;</a>
<a name="ln213"> </a>
<a name="ln214">    const gchar *name = gtk_entry_get_text(g-&gt;name);</a>
<a name="ln215">    if(((g-&gt;old_id &gt;= 0) &amp;&amp; (strcmp(g-&gt;original_name, name) != 0)) || (g-&gt;old_id &lt; 0))</a>
<a name="ln216">    {</a>
<a name="ln217"> </a>
<a name="ln218">      if(strcmp(_(&quot;new preset&quot;), name) == 0 || !(name &amp;&amp; *name))</a>
<a name="ln219">      {</a>
<a name="ln220">        // show error dialog</a>
<a name="ln221">        GtkWidget *window = dt_ui_main_window(darktable.gui-&gt;ui);</a>
<a name="ln222">        GtkWidget *dlg_changename</a>
<a name="ln223">            = gtk_message_dialog_new(GTK_WINDOW(window), GTK_DIALOG_DESTROY_WITH_PARENT, GTK_MESSAGE_WARNING,</a>
<a name="ln224">                                     GTK_BUTTONS_OK, _(&quot;please give preset a name&quot;));</a>
<a name="ln225">#ifdef GDK_WINDOWING_QUARTZ</a>
<a name="ln226">        dt_osx_disallow_fullscreen(dlg_changename);</a>
<a name="ln227">#endif</a>
<a name="ln228"> </a>
<a name="ln229">        gtk_window_set_title(GTK_WINDOW(dlg_changename), _(&quot;unnamed preset&quot;));</a>
<a name="ln230"> </a>
<a name="ln231">        gtk_dialog_run(GTK_DIALOG(dlg_changename));</a>
<a name="ln232">        gtk_widget_destroy(dlg_changename);</a>
<a name="ln233">        return;</a>
<a name="ln234">      }</a>
<a name="ln235"> </a>
<a name="ln236">      // editing existing preset with different name or store new preset -&gt; check for a preset with the same</a>
<a name="ln237">      // name:</a>
<a name="ln238">      DT_DEBUG_SQLITE3_PREPARE_V2(</a>
<a name="ln239">          dt_database_get(darktable.db),</a>
<a name="ln240">          &quot;SELECT name FROM data.presets WHERE name = ?1 AND operation=?2 AND op_version=?3 LIMIT 1&quot;,</a>
<a name="ln241">          -1, &amp;stmt, NULL);</a>
<a name="ln242">      DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 1, name, -1, SQLITE_TRANSIENT);</a>
<a name="ln243">      DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 2, g-&gt;module-&gt;op, -1, SQLITE_TRANSIENT);</a>
<a name="ln244">      DT_DEBUG_SQLITE3_BIND_INT(stmt, 3, g-&gt;module-&gt;version());</a>
<a name="ln245"> </a>
<a name="ln246">      if(sqlite3_step(stmt) == SQLITE_ROW)</a>
<a name="ln247">      {</a>
<a name="ln248">        sqlite3_finalize(stmt);</a>
<a name="ln249"> </a>
<a name="ln250">        // show overwrite question dialog</a>
<a name="ln251">        GtkWidget *window = dt_ui_main_window(darktable.gui-&gt;ui);</a>
<a name="ln252">        GtkWidget *dlg_overwrite = gtk_message_dialog_new(</a>
<a name="ln253">            GTK_WINDOW(window), GTK_DIALOG_DESTROY_WITH_PARENT, GTK_MESSAGE_WARNING, GTK_BUTTONS_YES_NO,</a>
<a name="ln254">            _(&quot;preset `%s' already exists.\ndo you want to overwrite?&quot;), name);</a>
<a name="ln255">#ifdef GDK_WINDOWING_QUARTZ</a>
<a name="ln256">        dt_osx_disallow_fullscreen(dlg_overwrite);</a>
<a name="ln257">#endif</a>
<a name="ln258"> </a>
<a name="ln259">        gtk_window_set_title(GTK_WINDOW(dlg_overwrite), _(&quot;overwrite preset?&quot;));</a>
<a name="ln260"> </a>
<a name="ln261">        gint dlg_ret = gtk_dialog_run(GTK_DIALOG(dlg_overwrite));</a>
<a name="ln262">        gtk_widget_destroy(dlg_overwrite);</a>
<a name="ln263"> </a>
<a name="ln264">        // if result is BUTTON_NO exit without destroy dialog, to permit other name</a>
<a name="ln265">        if(dlg_ret == GTK_RESPONSE_NO) return;</a>
<a name="ln266">      }</a>
<a name="ln267">      else</a>
<a name="ln268">      {</a>
<a name="ln269">        is_new = 1;</a>
<a name="ln270">        sqlite3_finalize(stmt);</a>
<a name="ln271">      }</a>
<a name="ln272">    }</a>
<a name="ln273"> </a>
<a name="ln274">    if(g-&gt;old_id &gt;= 0)</a>
<a name="ln275">    {</a>
<a name="ln276">      // now delete old preset:</a>
<a name="ln277">      DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln278">                                  &quot;DELETE FROM data.presets WHERE name=?1 AND operation=?2 AND op_version=?3&quot;, -1,</a>
<a name="ln279">                                  &amp;stmt, NULL);</a>
<a name="ln280">      DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 1, g-&gt;original_name, -1, SQLITE_TRANSIENT);</a>
<a name="ln281">      DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 2, g-&gt;module-&gt;op, -1, SQLITE_TRANSIENT);</a>
<a name="ln282">      DT_DEBUG_SQLITE3_BIND_INT(stmt, 3, g-&gt;module-&gt;version());</a>
<a name="ln283"> </a>
<a name="ln284">      sqlite3_step(stmt);</a>
<a name="ln285">      sqlite3_finalize(stmt);</a>
<a name="ln286">    }</a>
<a name="ln287"> </a>
<a name="ln288">    if(is_new == 0)</a>
<a name="ln289">    {</a>
<a name="ln290">      // delete preset, so we can re-insert the new values:</a>
<a name="ln291">      DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln292">                                  &quot;DELETE FROM data.presets WHERE name=?1 AND operation=?2 AND op_version=?3&quot;, -1,</a>
<a name="ln293">                                  &amp;stmt, NULL);</a>
<a name="ln294">      DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 1, name, -1, SQLITE_TRANSIENT);</a>
<a name="ln295">      DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 2, g-&gt;module-&gt;op, -1, SQLITE_TRANSIENT);</a>
<a name="ln296">      DT_DEBUG_SQLITE3_BIND_INT(stmt, 3, g-&gt;module-&gt;version());</a>
<a name="ln297">      sqlite3_step(stmt);</a>
<a name="ln298">      sqlite3_finalize(stmt);</a>
<a name="ln299">    }</a>
<a name="ln300"> </a>
<a name="ln301">    // rename accelerators</a>
<a name="ln302">    char path[1024];</a>
<a name="ln303">    snprintf(path, sizeof(path), &quot;%s/%s&quot;, _(&quot;preset&quot;), g-&gt;original_name);</a>
<a name="ln304">    dt_accel_rename_preset_iop(g-&gt;module, path, name);</a>
<a name="ln305">    // commit all the user input fields</a>
<a name="ln306">    DT_DEBUG_SQLITE3_PREPARE_V2(</a>
<a name="ln307">        dt_database_get(darktable.db),</a>
<a name="ln308">        &quot;INSERT INTO data.presets (name, description, operation, op_version, op_params, enabled, &quot;</a>
<a name="ln309">        &quot;blendop_params, blendop_version, multi_priority, multi_name, &quot;</a>
<a name="ln310">        &quot;model, maker, lens, iso_min, iso_max, exposure_min, exposure_max, aperture_min, aperture_max, &quot;</a>
<a name="ln311">        &quot;focal_length_min, focal_length_max, writeprotect, autoapply, filter, def, format) &quot;</a>
<a name="ln312">        &quot;VALUES (?1, ?2, ?3, ?4, ?5, ?6, ?7, ?8, 0, '', ?9, ?10, ?11, ?12, ?13, ?14, ?15, ?16, ?17, ?18, &quot;</a>
<a name="ln313">        &quot;?19, 0, ?20, ?21, 0, ?22)&quot;,</a>
<a name="ln314">        -1, &amp;stmt, NULL);</a>
<a name="ln315">    DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 1, name, -1, SQLITE_TRANSIENT);</a>
<a name="ln316">    DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 2, gtk_entry_get_text(g-&gt;description), -1, SQLITE_TRANSIENT);</a>
<a name="ln317">    DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 3, g-&gt;module-&gt;op, -1, SQLITE_TRANSIENT);</a>
<a name="ln318">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 4, g-&gt;module-&gt;version());</a>
<a name="ln319">    DT_DEBUG_SQLITE3_BIND_BLOB(stmt, 5, g-&gt;module-&gt;params, g-&gt;module-&gt;params_size, SQLITE_TRANSIENT);</a>
<a name="ln320">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 6, g-&gt;module-&gt;enabled);</a>
<a name="ln321">    DT_DEBUG_SQLITE3_BIND_BLOB(stmt, 7, g-&gt;module-&gt;blend_params, sizeof(dt_develop_blend_params_t),</a>
<a name="ln322">                               SQLITE_TRANSIENT);</a>
<a name="ln323">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 8, dt_develop_blend_version());</a>
<a name="ln324">    DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 9, gtk_entry_get_text(GTK_ENTRY(g-&gt;model)), -1, SQLITE_TRANSIENT);</a>
<a name="ln325">    DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 10, gtk_entry_get_text(GTK_ENTRY(g-&gt;maker)), -1, SQLITE_TRANSIENT);</a>
<a name="ln326">    DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 11, gtk_entry_get_text(GTK_ENTRY(g-&gt;lens)), -1, SQLITE_TRANSIENT);</a>
<a name="ln327">    DT_DEBUG_SQLITE3_BIND_DOUBLE(stmt, 12, gtk_spin_button_get_value(GTK_SPIN_BUTTON(g-&gt;iso_min)));</a>
<a name="ln328">    DT_DEBUG_SQLITE3_BIND_DOUBLE(stmt, 13, gtk_spin_button_get_value(GTK_SPIN_BUTTON(g-&gt;iso_max)));</a>
<a name="ln329">    DT_DEBUG_SQLITE3_BIND_DOUBLE(stmt, 14,</a>
<a name="ln330">                                 dt_gui_presets_exposure_value[dt_bauhaus_combobox_get(g-&gt;exposure_min)]);</a>
<a name="ln331">    DT_DEBUG_SQLITE3_BIND_DOUBLE(stmt, 15,</a>
<a name="ln332">                                 dt_gui_presets_exposure_value[dt_bauhaus_combobox_get(g-&gt;exposure_max)]);</a>
<a name="ln333">    DT_DEBUG_SQLITE3_BIND_DOUBLE(stmt, 16,</a>
<a name="ln334">                                 dt_gui_presets_aperture_value[dt_bauhaus_combobox_get(g-&gt;aperture_min)]);</a>
<a name="ln335">    DT_DEBUG_SQLITE3_BIND_DOUBLE(stmt, 17,</a>
<a name="ln336">                                 dt_gui_presets_aperture_value[dt_bauhaus_combobox_get(g-&gt;aperture_max)]);</a>
<a name="ln337">    DT_DEBUG_SQLITE3_BIND_DOUBLE(stmt, 18, gtk_spin_button_get_value(GTK_SPIN_BUTTON(g-&gt;focal_length_min)));</a>
<a name="ln338">    DT_DEBUG_SQLITE3_BIND_DOUBLE(stmt, 19, gtk_spin_button_get_value(GTK_SPIN_BUTTON(g-&gt;focal_length_max)));</a>
<a name="ln339">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 20, gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(g-&gt;autoapply)));</a>
<a name="ln340">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 21, gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(g-&gt;filter)));</a>
<a name="ln341">    int format = 0;</a>
<a name="ln342">    for(int k = 0; k &lt; 3; k++)</a>
<a name="ln343">      format += gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(g-&gt;format_btn[k])) * dt_gui_presets_format_flag[k];</a>
<a name="ln344">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 22, format);</a>
<a name="ln345">    sqlite3_step(stmt);</a>
<a name="ln346">    sqlite3_finalize(stmt);</a>
<a name="ln347"> </a>
<a name="ln348">    dt_gui_store_last_preset(name);</a>
<a name="ln349">  }</a>
<a name="ln350"> </a>
<a name="ln351">  gtk_widget_destroy(GTK_WIDGET(dialog));</a>
<a name="ln352">  g_free(g-&gt;original_name);</a>
<a name="ln353">  free(g);</a>
<a name="ln354">}</a>
<a name="ln355"> </a>
<a name="ln356">static void check_buttons_activated(GtkCheckButton *button, dt_gui_presets_edit_dialog_t *g)</a>
<a name="ln357">{</a>
<a name="ln358">  if(gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(g-&gt;autoapply))</a>
<a name="ln359">     || gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(g-&gt;filter)))</a>
<a name="ln360">  {</a>
<a name="ln361">    gtk_widget_set_visible(GTK_WIDGET(g-&gt;details), TRUE);</a>
<a name="ln362">    gtk_widget_set_no_show_all(GTK_WIDGET(g-&gt;details), FALSE);</a>
<a name="ln363">    gtk_widget_show_all(GTK_WIDGET(g-&gt;details));</a>
<a name="ln364">    gtk_widget_set_no_show_all(GTK_WIDGET(g-&gt;details), TRUE);</a>
<a name="ln365">  }</a>
<a name="ln366">  else</a>
<a name="ln367">    gtk_widget_set_visible(GTK_WIDGET(g-&gt;details), FALSE);</a>
<a name="ln368">}</a>
<a name="ln369"> </a>
<a name="ln370">static void edit_preset(const char *name_in, dt_iop_module_t *module)</a>
<a name="ln371">{</a>
<a name="ln372">  gchar *name = NULL;</a>
<a name="ln373">  if(name_in == NULL)</a>
<a name="ln374">  {</a>
<a name="ln375">    name = get_active_preset_name(module);</a>
<a name="ln376">    if(name == NULL) return;</a>
<a name="ln377">  }</a>
<a name="ln378">  else</a>
<a name="ln379">    name = g_strdup(name_in);</a>
<a name="ln380"> </a>
<a name="ln381">  GtkWidget *dialog;</a>
<a name="ln382">  /* Create the widgets */</a>
<a name="ln383">  char title[1024];</a>
<a name="ln384">  GtkWidget *window = dt_ui_main_window(darktable.gui-&gt;ui);</a>
<a name="ln385">  snprintf(title, sizeof(title), _(&quot;edit `%s' for module `%s'&quot;), name, module-&gt;name());</a>
<a name="ln386">  dialog = gtk_dialog_new_with_buttons(title, GTK_WINDOW(window), GTK_DIALOG_DESTROY_WITH_PARENT, _(&quot;_ok&quot;),</a>
<a name="ln387">                                       GTK_RESPONSE_ACCEPT, _(&quot;_cancel&quot;), GTK_RESPONSE_REJECT, NULL);</a>
<a name="ln388">#ifdef GDK_WINDOWING_QUARTZ</a>
<a name="ln389">  dt_osx_disallow_fullscreen(dialog);</a>
<a name="ln390">#endif</a>
<a name="ln391">  GtkContainer *content_area = GTK_CONTAINER(gtk_dialog_get_content_area(GTK_DIALOG(dialog)));</a>
<a name="ln392">  GtkBox *box = GTK_BOX(gtk_box_new(GTK_ORIENTATION_VERTICAL, 0));</a>
<a name="ln393">  gtk_container_add(content_area, GTK_WIDGET(box));</a>
<a name="ln394">  GtkWidget *label;</a>
<a name="ln395"> </a>
<a name="ln396">  dt_gui_presets_edit_dialog_t *g</a>
<a name="ln397">      = (dt_gui_presets_edit_dialog_t *)malloc(sizeof(dt_gui_presets_edit_dialog_t));</a>
<a name="ln398">  g-&gt;old_id = -1;</a>
<a name="ln399">  g-&gt;original_name = name;</a>
<a name="ln400">  g-&gt;module = module;</a>
<a name="ln401">  g-&gt;name = GTK_ENTRY(gtk_entry_new());</a>
<a name="ln402">  gtk_entry_set_text(g-&gt;name, name);</a>
<a name="ln403">  gtk_box_pack_start(box, GTK_WIDGET(g-&gt;name), FALSE, FALSE, 0);</a>
<a name="ln404">  gtk_widget_set_tooltip_text(GTK_WIDGET(g-&gt;name), _(&quot;name of the preset&quot;));</a>
<a name="ln405"> </a>
<a name="ln406">  g-&gt;description = GTK_ENTRY(gtk_entry_new());</a>
<a name="ln407">  gtk_box_pack_start(box, GTK_WIDGET(g-&gt;description), FALSE, FALSE, 0);</a>
<a name="ln408">  gtk_widget_set_tooltip_text(GTK_WIDGET(g-&gt;description), _(&quot;description or further information&quot;));</a>
<a name="ln409"> </a>
<a name="ln410">  g-&gt;autoapply</a>
<a name="ln411">      = GTK_CHECK_BUTTON(gtk_check_button_new_with_label(_(&quot;auto apply this preset to matching images&quot;)));</a>
<a name="ln412">  gtk_box_pack_start(box, GTK_WIDGET(g-&gt;autoapply), FALSE, FALSE, 0);</a>
<a name="ln413">  g-&gt;filter</a>
<a name="ln414">      = GTK_CHECK_BUTTON(gtk_check_button_new_with_label(_(&quot;only show this preset for matching images&quot;)));</a>
<a name="ln415">  gtk_widget_set_tooltip_text(GTK_WIDGET(g-&gt;filter), _(&quot;be very careful with this option. &quot;</a>
<a name="ln416">                                                           &quot;this might be the last time you see your preset.&quot;));</a>
<a name="ln417">  gtk_box_pack_start(box, GTK_WIDGET(g-&gt;filter), FALSE, FALSE, 0);</a>
<a name="ln418">  g_signal_connect(G_OBJECT(g-&gt;autoapply), &quot;toggled&quot;, G_CALLBACK(check_buttons_activated), g);</a>
<a name="ln419">  g_signal_connect(G_OBJECT(g-&gt;filter), &quot;toggled&quot;, G_CALLBACK(check_buttons_activated), g);</a>
<a name="ln420"> </a>
<a name="ln421">  int line = 0;</a>
<a name="ln422">  g-&gt;details = gtk_grid_new();</a>
<a name="ln423">  gtk_grid_set_row_spacing(GTK_GRID(g-&gt;details), DT_PIXEL_APPLY_DPI(5));</a>
<a name="ln424">  gtk_grid_set_column_spacing(GTK_GRID(g-&gt;details), DT_PIXEL_APPLY_DPI(10));</a>
<a name="ln425">  gtk_box_pack_start(box, GTK_WIDGET(g-&gt;details), TRUE, TRUE, 0);</a>
<a name="ln426"> </a>
<a name="ln427">  // model, maker, lens</a>
<a name="ln428">  g-&gt;model = gtk_entry_new();</a>
<a name="ln429">  gtk_widget_set_hexpand(GTK_WIDGET(g-&gt;model), TRUE);</a>
<a name="ln430">  gtk_widget_set_tooltip_text(g-&gt;model, _(&quot;string to match model (use % as wildcard)&quot;));</a>
<a name="ln431">  label = gtk_label_new(_(&quot;model&quot;));</a>
<a name="ln432">  gtk_widget_set_halign(label, GTK_ALIGN_START);</a>
<a name="ln433">  gtk_grid_attach(GTK_GRID(g-&gt;details), label, 0, line++, 1, 1);</a>
<a name="ln434">  gtk_grid_attach_next_to(GTK_GRID(g-&gt;details), g-&gt;model, label, GTK_POS_RIGHT, 2, 1);</a>
<a name="ln435"> </a>
<a name="ln436">  g-&gt;maker = gtk_entry_new();</a>
<a name="ln437">  gtk_widget_set_tooltip_text(g-&gt;maker, _(&quot;string to match maker (use % as wildcard)&quot;));</a>
<a name="ln438">  label = gtk_label_new(_(&quot;maker&quot;));</a>
<a name="ln439">  gtk_widget_set_halign(label, GTK_ALIGN_START);</a>
<a name="ln440">  gtk_grid_attach(GTK_GRID(g-&gt;details), label, 0, line++, 1, 1);</a>
<a name="ln441">  gtk_grid_attach_next_to(GTK_GRID(g-&gt;details), g-&gt;maker, label, GTK_POS_RIGHT, 2, 1);</a>
<a name="ln442"> </a>
<a name="ln443">  g-&gt;lens = gtk_entry_new();</a>
<a name="ln444">  gtk_widget_set_tooltip_text(g-&gt;lens, _(&quot;string to match lens (use % as wildcard)&quot;));</a>
<a name="ln445">  label = gtk_label_new(_(&quot;lens&quot;));</a>
<a name="ln446">  gtk_widget_set_halign(label, GTK_ALIGN_START);</a>
<a name="ln447">  gtk_grid_attach(GTK_GRID(g-&gt;details), label, 0, line++, 1, 1);</a>
<a name="ln448">  gtk_grid_attach_next_to(GTK_GRID(g-&gt;details), g-&gt;lens, label, GTK_POS_RIGHT, 2, 1);</a>
<a name="ln449"> </a>
<a name="ln450">  // iso</a>
<a name="ln451">  label = gtk_label_new(_(&quot;ISO&quot;));</a>
<a name="ln452">  gtk_widget_set_halign(label, GTK_ALIGN_START);</a>
<a name="ln453">  g-&gt;iso_min = gtk_spin_button_new_with_range(0, FLT_MAX, 100);</a>
<a name="ln454">  gtk_widget_set_tooltip_text(g-&gt;iso_min, _(&quot;minimum ISO value&quot;));</a>
<a name="ln455">  gtk_spin_button_set_digits(GTK_SPIN_BUTTON(g-&gt;iso_min), 0);</a>
<a name="ln456">  g-&gt;iso_max = gtk_spin_button_new_with_range(0, FLT_MAX, 100);</a>
<a name="ln457">  gtk_widget_set_tooltip_text(g-&gt;iso_max, _(&quot;maximum ISO value&quot;));</a>
<a name="ln458">  gtk_spin_button_set_digits(GTK_SPIN_BUTTON(g-&gt;iso_max), 0);</a>
<a name="ln459">  gtk_grid_attach(GTK_GRID(g-&gt;details), label, 0, line++, 1, 1);</a>
<a name="ln460">  gtk_grid_attach_next_to(GTK_GRID(g-&gt;details), g-&gt;iso_min, label, GTK_POS_RIGHT, 1, 1);</a>
<a name="ln461">  gtk_grid_attach_next_to(GTK_GRID(g-&gt;details), g-&gt;iso_max, g-&gt;iso_min, GTK_POS_RIGHT, 1, 1);</a>
<a name="ln462"> </a>
<a name="ln463">  // exposure</a>
<a name="ln464">  label = gtk_label_new(_(&quot;exposure&quot;));</a>
<a name="ln465">  gtk_widget_set_halign(label, GTK_ALIGN_START);</a>
<a name="ln466">  g-&gt;exposure_min = dt_bauhaus_combobox_new(NULL);</a>
<a name="ln467">  g-&gt;exposure_max = dt_bauhaus_combobox_new(NULL);</a>
<a name="ln468">  gtk_widget_set_tooltip_text(g-&gt;exposure_min, _(&quot;minimum exposure time&quot;));</a>
<a name="ln469">  gtk_widget_set_tooltip_text(g-&gt;exposure_max, _(&quot;maximum exposure time&quot;));</a>
<a name="ln470">  for(int k = 0; k &lt; dt_gui_presets_exposure_value_cnt; k++)</a>
<a name="ln471">    dt_bauhaus_combobox_add(g-&gt;exposure_min, dt_gui_presets_exposure_value_str[k]);</a>
<a name="ln472">  for(int k = 0; k &lt; dt_gui_presets_exposure_value_cnt; k++)</a>
<a name="ln473">    dt_bauhaus_combobox_add(g-&gt;exposure_max, dt_gui_presets_exposure_value_str[k]);</a>
<a name="ln474">  gtk_grid_attach(GTK_GRID(g-&gt;details), label, 0, line++, 1, 1);</a>
<a name="ln475">  gtk_grid_attach_next_to(GTK_GRID(g-&gt;details), g-&gt;exposure_min, label, GTK_POS_RIGHT, 1, 1);</a>
<a name="ln476">  gtk_grid_attach_next_to(GTK_GRID(g-&gt;details), g-&gt;exposure_max, g-&gt;exposure_min, GTK_POS_RIGHT, 1, 1);</a>
<a name="ln477"> </a>
<a name="ln478">  // aperture</a>
<a name="ln479">  label = gtk_label_new(_(&quot;aperture&quot;));</a>
<a name="ln480">  gtk_widget_set_halign(label, GTK_ALIGN_START);</a>
<a name="ln481">  g-&gt;aperture_min = dt_bauhaus_combobox_new(NULL);</a>
<a name="ln482">  g-&gt;aperture_max = dt_bauhaus_combobox_new(NULL);</a>
<a name="ln483">  gtk_widget_set_tooltip_text(g-&gt;aperture_min, _(&quot;minimum aperture value&quot;));</a>
<a name="ln484">  gtk_widget_set_tooltip_text(g-&gt;aperture_max, _(&quot;maximum aperture value&quot;));</a>
<a name="ln485">  for(int k = 0; k &lt; dt_gui_presets_aperture_value_cnt; k++)</a>
<a name="ln486">    dt_bauhaus_combobox_add(g-&gt;aperture_min, dt_gui_presets_aperture_value_str[k]);</a>
<a name="ln487">  for(int k = 0; k &lt; dt_gui_presets_aperture_value_cnt; k++)</a>
<a name="ln488">    dt_bauhaus_combobox_add(g-&gt;aperture_max, dt_gui_presets_aperture_value_str[k]);</a>
<a name="ln489">  gtk_grid_attach(GTK_GRID(g-&gt;details), label, 0, line++, 1, 1);</a>
<a name="ln490">  gtk_grid_attach_next_to(GTK_GRID(g-&gt;details), g-&gt;aperture_min, label, GTK_POS_RIGHT, 1, 1);</a>
<a name="ln491">  gtk_grid_attach_next_to(GTK_GRID(g-&gt;details), g-&gt;aperture_max, g-&gt;aperture_min, GTK_POS_RIGHT, 1, 1);</a>
<a name="ln492"> </a>
<a name="ln493">  // focal length</a>
<a name="ln494">  label = gtk_label_new(_(&quot;focal length&quot;));</a>
<a name="ln495">  gtk_widget_set_halign(label, GTK_ALIGN_START);</a>
<a name="ln496">  g-&gt;focal_length_min = gtk_spin_button_new_with_range(0, 1000, 10);</a>
<a name="ln497">  gtk_spin_button_set_digits(GTK_SPIN_BUTTON(g-&gt;focal_length_min), 0);</a>
<a name="ln498">  g-&gt;focal_length_max = gtk_spin_button_new_with_range(0, 1000, 10);</a>
<a name="ln499">  gtk_spin_button_set_digits(GTK_SPIN_BUTTON(g-&gt;focal_length_max), 0);</a>
<a name="ln500">  gtk_widget_set_tooltip_text(g-&gt;focal_length_min, _(&quot;minimum focal length&quot;));</a>
<a name="ln501">  gtk_widget_set_tooltip_text(g-&gt;focal_length_max, _(&quot;maximum focal length&quot;));</a>
<a name="ln502">  gtk_grid_attach(GTK_GRID(g-&gt;details), label, 0, line++, 1, 1);</a>
<a name="ln503">  gtk_grid_attach_next_to(GTK_GRID(g-&gt;details), g-&gt;focal_length_min, label, GTK_POS_RIGHT, 1, 1);</a>
<a name="ln504">  gtk_grid_attach_next_to(GTK_GRID(g-&gt;details), g-&gt;focal_length_max, g-&gt;focal_length_min, GTK_POS_RIGHT, 1, 1);</a>
<a name="ln505"> </a>
<a name="ln506">  // raw/hdr/ldr</a>
<a name="ln507">  label = gtk_label_new(_(&quot;format&quot;));</a>
<a name="ln508">  gtk_widget_set_halign(label, GTK_ALIGN_START);</a>
<a name="ln509">  gtk_grid_attach(GTK_GRID(g-&gt;details), label, 0, line, 1, 1);</a>
<a name="ln510"> </a>
<a name="ln511">  for(int i = 0; i &lt; 3; i++)</a>
<a name="ln512">  {</a>
<a name="ln513">    g-&gt;format_btn[i] = gtk_check_button_new_with_label(_(dt_gui_presets_format_value_str[i]));</a>
<a name="ln514">    gtk_grid_attach(GTK_GRID(g-&gt;details), g-&gt;format_btn[i], 1, line + i, 2, 1);</a>
<a name="ln515">  }</a>
<a name="ln516"> </a>
<a name="ln517">  gtk_widget_set_no_show_all(GTK_WIDGET(g-&gt;details), TRUE);</a>
<a name="ln518"> </a>
<a name="ln519">  sqlite3_stmt *stmt;</a>
<a name="ln520">  DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln521">                              &quot;SELECT rowid, description, model, maker, lens, iso_min, iso_max, &quot;</a>
<a name="ln522">                              &quot;exposure_min, exposure_max, aperture_min, aperture_max, focal_length_min, &quot;</a>
<a name="ln523">                              &quot;focal_length_max, autoapply, filter, format FROM data.presets WHERE name = ?1 AND &quot;</a>
<a name="ln524">                              &quot;operation = ?2 AND op_version = ?3&quot;,</a>
<a name="ln525">                              -1, &amp;stmt, NULL);</a>
<a name="ln526">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 1, name, -1, SQLITE_TRANSIENT);</a>
<a name="ln527">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 2, module-&gt;op, -1, SQLITE_TRANSIENT);</a>
<a name="ln528">  DT_DEBUG_SQLITE3_BIND_INT(stmt, 3, module-&gt;version());</a>
<a name="ln529">  if(sqlite3_step(stmt) == SQLITE_ROW)</a>
<a name="ln530">  {</a>
<a name="ln531">    g-&gt;old_id = sqlite3_column_int(stmt, 0);</a>
<a name="ln532">    gtk_entry_set_text(GTK_ENTRY(g-&gt;description), (const char *)sqlite3_column_text(stmt, 1));</a>
<a name="ln533">    gtk_entry_set_text(GTK_ENTRY(g-&gt;model), (const char *)sqlite3_column_text(stmt, 2));</a>
<a name="ln534">    gtk_entry_set_text(GTK_ENTRY(g-&gt;maker), (const char *)sqlite3_column_text(stmt, 3));</a>
<a name="ln535">    gtk_entry_set_text(GTK_ENTRY(g-&gt;lens), (const char *)sqlite3_column_text(stmt, 4));</a>
<a name="ln536">    gtk_spin_button_set_value(GTK_SPIN_BUTTON(g-&gt;iso_min), sqlite3_column_double(stmt, 5));</a>
<a name="ln537">    gtk_spin_button_set_value(GTK_SPIN_BUTTON(g-&gt;iso_max), sqlite3_column_double(stmt, 6));</a>
<a name="ln538"> </a>
<a name="ln539">    float val = sqlite3_column_double(stmt, 7);</a>
<a name="ln540">    int k = 0;</a>
<a name="ln541">    for(; k &lt; dt_gui_presets_exposure_value_cnt &amp;&amp; val &gt; dt_gui_presets_exposure_value[k]; k++)</a>
<a name="ln542">      ;</a>
<a name="ln543">    dt_bauhaus_combobox_set(g-&gt;exposure_min, k);</a>
<a name="ln544">    val = sqlite3_column_double(stmt, 8);</a>
<a name="ln545">    for(k = 0; k &lt; dt_gui_presets_exposure_value_cnt &amp;&amp; val &gt; dt_gui_presets_exposure_value[k]; k++)</a>
<a name="ln546">      ;</a>
<a name="ln547">    dt_bauhaus_combobox_set(g-&gt;exposure_max, k);</a>
<a name="ln548">    val = sqlite3_column_double(stmt, 9);</a>
<a name="ln549">    for(k = 0; k &lt; dt_gui_presets_aperture_value_cnt &amp;&amp; val &gt; dt_gui_presets_aperture_value[k]; k++)</a>
<a name="ln550">      ;</a>
<a name="ln551">    dt_bauhaus_combobox_set(g-&gt;aperture_min, k);</a>
<a name="ln552">    val = sqlite3_column_double(stmt, 10);</a>
<a name="ln553">    for(k = 0; k &lt; dt_gui_presets_aperture_value_cnt &amp;&amp; val &gt; dt_gui_presets_aperture_value[k]; k++)</a>
<a name="ln554">      ;</a>
<a name="ln555">    dt_bauhaus_combobox_set(g-&gt;aperture_max, k);</a>
<a name="ln556">    gtk_spin_button_set_value(GTK_SPIN_BUTTON(g-&gt;focal_length_min), sqlite3_column_double(stmt, 11));</a>
<a name="ln557">    gtk_spin_button_set_value(GTK_SPIN_BUTTON(g-&gt;focal_length_max), sqlite3_column_double(stmt, 12));</a>
<a name="ln558">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(g-&gt;autoapply), sqlite3_column_int(stmt, 13));</a>
<a name="ln559">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(g-&gt;filter), sqlite3_column_int(stmt, 14));</a>
<a name="ln560">    const int format = sqlite3_column_int(stmt, 15);</a>
<a name="ln561">    for(k = 0; k &lt; 3; k++)</a>
<a name="ln562">      gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(g-&gt;format_btn[k]), format &amp; (dt_gui_presets_format_flag[k]));</a>
<a name="ln563">  }</a>
<a name="ln564">  else</a>
<a name="ln565">  {</a>
<a name="ln566">    gtk_entry_set_text(GTK_ENTRY(g-&gt;description), &quot;&quot;);</a>
<a name="ln567">    gtk_entry_set_text(GTK_ENTRY(g-&gt;model), &quot;%&quot;);</a>
<a name="ln568">    gtk_entry_set_text(GTK_ENTRY(g-&gt;maker), &quot;%&quot;);</a>
<a name="ln569">    gtk_entry_set_text(GTK_ENTRY(g-&gt;lens), &quot;%&quot;);</a>
<a name="ln570">    gtk_spin_button_set_value(GTK_SPIN_BUTTON(g-&gt;iso_min), 0);</a>
<a name="ln571">    gtk_spin_button_set_value(GTK_SPIN_BUTTON(g-&gt;iso_max), FLT_MAX);</a>
<a name="ln572"> </a>
<a name="ln573">    float val = 0;</a>
<a name="ln574">    int k = 0;</a>
<a name="ln575">    for(; k &lt; dt_gui_presets_exposure_value_cnt &amp;&amp; val &gt; dt_gui_presets_exposure_value[k]; k++)</a>
<a name="ln576">      ;</a>
<a name="ln577">    dt_bauhaus_combobox_set(g-&gt;exposure_min, k);</a>
<a name="ln578">    val = 100000000;</a>
<a name="ln579">    for(k = 0; k &lt; dt_gui_presets_exposure_value_cnt &amp;&amp; val &gt; dt_gui_presets_exposure_value[k]; k++)</a>
<a name="ln580">      ;</a>
<a name="ln581">    dt_bauhaus_combobox_set(g-&gt;exposure_max, k);</a>
<a name="ln582">    val = 0;</a>
<a name="ln583">    for(k = 0; k &lt; dt_gui_presets_aperture_value_cnt &amp;&amp; val &gt; dt_gui_presets_aperture_value[k]; k++)</a>
<a name="ln584">      ;</a>
<a name="ln585">    dt_bauhaus_combobox_set(g-&gt;aperture_min, k);</a>
<a name="ln586">    val = 100000000;</a>
<a name="ln587">    for(k = 0; k &lt; dt_gui_presets_aperture_value_cnt &amp;&amp; val &gt; dt_gui_presets_aperture_value[k]; k++)</a>
<a name="ln588">      ;</a>
<a name="ln589">    dt_bauhaus_combobox_set(g-&gt;aperture_max, k);</a>
<a name="ln590">    gtk_spin_button_set_value(GTK_SPIN_BUTTON(g-&gt;focal_length_min), 0);</a>
<a name="ln591">    gtk_spin_button_set_value(GTK_SPIN_BUTTON(g-&gt;focal_length_max), 1000);</a>
<a name="ln592">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(g-&gt;autoapply), 0);</a>
<a name="ln593">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(g-&gt;filter), 0);</a>
<a name="ln594">    for(k = 0; k &lt; 3; k++) gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(g-&gt;format_btn[k]), TRUE);</a>
<a name="ln595">  }</a>
<a name="ln596">  sqlite3_finalize(stmt);</a>
<a name="ln597"> </a>
<a name="ln598">  g_signal_connect(dialog, &quot;response&quot;, G_CALLBACK(edit_preset_response), g);</a>
<a name="ln599">  gtk_widget_show_all(dialog);</a>
<a name="ln600">}</a>
<a name="ln601"> </a>
<a name="ln602">static void menuitem_edit_preset(GtkMenuItem *menuitem, dt_iop_module_t *module)</a>
<a name="ln603">{</a>
<a name="ln604">  edit_preset(NULL, module);</a>
<a name="ln605">}</a>
<a name="ln606"> </a>
<a name="ln607">static void menuitem_update_preset(GtkMenuItem *menuitem, dt_iop_module_t *module)</a>
<a name="ln608">{</a>
<a name="ln609">  gchar *name = g_object_get_data(G_OBJECT(menuitem), &quot;dt-preset-name&quot;);</a>
<a name="ln610"> </a>
<a name="ln611">  // commit all the module fields</a>
<a name="ln612">  sqlite3_stmt *stmt;</a>
<a name="ln613">  DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln614">                              &quot;UPDATE data.presets SET op_version=?2, op_params=?3, enabled=?4, &quot;</a>
<a name="ln615">                              &quot;blendop_params=?5, blendop_version=?6 WHERE name=?7 AND operation=?1&quot;,</a>
<a name="ln616">                              -1, &amp;stmt, NULL);</a>
<a name="ln617"> </a>
<a name="ln618">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 1, module-&gt;op, -1, SQLITE_TRANSIENT);</a>
<a name="ln619">  DT_DEBUG_SQLITE3_BIND_INT(stmt, 2, module-&gt;version());</a>
<a name="ln620">  DT_DEBUG_SQLITE3_BIND_BLOB(stmt, 3, module-&gt;params, module-&gt;params_size, SQLITE_TRANSIENT);</a>
<a name="ln621">  DT_DEBUG_SQLITE3_BIND_INT(stmt, 4, module-&gt;enabled);</a>
<a name="ln622">  DT_DEBUG_SQLITE3_BIND_BLOB(stmt, 5, module-&gt;blend_params, sizeof(dt_develop_blend_params_t),</a>
<a name="ln623">                             SQLITE_TRANSIENT);</a>
<a name="ln624">  DT_DEBUG_SQLITE3_BIND_INT(stmt, 6, dt_develop_blend_version());</a>
<a name="ln625">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 7, name, -1, SQLITE_TRANSIENT);</a>
<a name="ln626">  sqlite3_step(stmt);</a>
<a name="ln627">  sqlite3_finalize(stmt);</a>
<a name="ln628">}</a>
<a name="ln629"> </a>
<a name="ln630">static void menuitem_new_preset(GtkMenuItem *menuitem, dt_iop_module_t *module)</a>
<a name="ln631">{</a>
<a name="ln632">  // add new preset</a>
<a name="ln633">  sqlite3_stmt *stmt;</a>
<a name="ln634">  DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln635">                              &quot;DELETE FROM data.presets WHERE name=?1 AND operation=?2 AND op_version=?3&quot;, -1,</a>
<a name="ln636">                              &amp;stmt, NULL);</a>
<a name="ln637">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 1, _(&quot;new preset&quot;), -1, SQLITE_STATIC);</a>
<a name="ln638">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 2, module-&gt;op, -1, SQLITE_TRANSIENT);</a>
<a name="ln639">  DT_DEBUG_SQLITE3_BIND_INT(stmt, 3, module-&gt;version());</a>
<a name="ln640">  sqlite3_step(stmt);</a>
<a name="ln641">  sqlite3_finalize(stmt);</a>
<a name="ln642">  // create a shortcut for the new entry</a>
<a name="ln643">  char path[1024];</a>
<a name="ln644">  snprintf(path, sizeof(path), &quot;%s/%s&quot;, _(&quot;preset&quot;), _(&quot;new preset&quot;));</a>
<a name="ln645">  dt_accel_register_iop(module-&gt;so, FALSE, path, 0, 0);</a>
<a name="ln646">  dt_accel_connect_preset_iop(module, _(&quot;new preset&quot;));</a>
<a name="ln647">  // then show edit dialog</a>
<a name="ln648">  edit_preset(_(&quot;new preset&quot;), module);</a>
<a name="ln649">}</a>
<a name="ln650"> </a>
<a name="ln651">static void menuitem_pick_preset(GtkMenuItem *menuitem, dt_iop_module_t *module)</a>
<a name="ln652">{</a>
<a name="ln653">  gchar *name = g_object_get_data(G_OBJECT(menuitem), &quot;dt-preset-name&quot;);</a>
<a name="ln654">  sqlite3_stmt *stmt;</a>
<a name="ln655">  DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln656">                              &quot;SELECT op_params, enabled, blendop_params, blendop_version, writeprotect FROM &quot;</a>
<a name="ln657">                              &quot;data.presets WHERE operation = ?1 AND op_version = ?2 AND name = ?3&quot;,</a>
<a name="ln658">                              -1, &amp;stmt, NULL);</a>
<a name="ln659">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 1, module-&gt;op, -1, SQLITE_TRANSIENT);</a>
<a name="ln660">  DT_DEBUG_SQLITE3_BIND_INT(stmt, 2, module-&gt;version());</a>
<a name="ln661">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 3, name, -1, SQLITE_TRANSIENT);</a>
<a name="ln662"> </a>
<a name="ln663">  if(sqlite3_step(stmt) == SQLITE_ROW)</a>
<a name="ln664">  {</a>
<a name="ln665">    const void *op_params = sqlite3_column_blob(stmt, 0);</a>
<a name="ln666">    int op_length = sqlite3_column_bytes(stmt, 0);</a>
<a name="ln667">    int enabled = sqlite3_column_int(stmt, 1);</a>
<a name="ln668">    const void *blendop_params = sqlite3_column_blob(stmt, 2);</a>
<a name="ln669">    int bl_length = sqlite3_column_bytes(stmt, 2);</a>
<a name="ln670">    int blendop_version = sqlite3_column_int(stmt, 3);</a>
<a name="ln671">    int writeprotect = sqlite3_column_int(stmt, 4);</a>
<a name="ln672">    if(op_params &amp;&amp; (op_length == module-&gt;params_size))</a>
<a name="ln673">    {</a>
<a name="ln674">      memcpy(module-&gt;params, op_params, op_length);</a>
<a name="ln675">      module-&gt;enabled = enabled;</a>
<a name="ln676">    }</a>
<a name="ln677">    if(blendop_params &amp;&amp; (blendop_version == dt_develop_blend_version())</a>
<a name="ln678">       &amp;&amp; (bl_length == sizeof(dt_develop_blend_params_t)))</a>
<a name="ln679">    {</a>
<a name="ln680">      dt_iop_commit_blend_params(module, blendop_params);</a>
<a name="ln681">    }</a>
<a name="ln682">    else if(blendop_params</a>
<a name="ln683">            &amp;&amp; dt_develop_blend_legacy_params(module, blendop_params, blendop_version, module-&gt;blend_params,</a>
<a name="ln684">                                              dt_develop_blend_version(), bl_length) == 0)</a>
<a name="ln685">    {</a>
<a name="ln686">      // do nothing</a>
<a name="ln687">    }</a>
<a name="ln688">    else</a>
<a name="ln689">    {</a>
<a name="ln690">      dt_iop_commit_blend_params(module, module-&gt;default_blendop_params);</a>
<a name="ln691">    }</a>
<a name="ln692"> </a>
<a name="ln693">    if(!writeprotect) dt_gui_store_last_preset(name);</a>
<a name="ln694">  }</a>
<a name="ln695">  sqlite3_finalize(stmt);</a>
<a name="ln696">  dt_iop_gui_update(module);</a>
<a name="ln697">  dt_dev_add_history_item(darktable.develop, module, FALSE);</a>
<a name="ln698">  gtk_widget_queue_draw(module-&gt;widget);</a>
<a name="ln699">}</a>
<a name="ln700"> </a>
<a name="ln701">static gboolean menuitem_button_pressed_preset(GtkMenuItem *menuitem, GdkEventButton *event, dt_iop_module_t *module)</a>
<a name="ln702">{</a>
<a name="ln703">  if (event-&gt;button == 1 || (module-&gt;flags() &amp; IOP_FLAGS_ONE_INSTANCE))</a>
<a name="ln704">  {</a>
<a name="ln705">    menuitem_pick_preset(menuitem, module);</a>
<a name="ln706">    return TRUE;</a>
<a name="ln707">  }</a>
<a name="ln708">  else if (event-&gt;button == 2)</a>
<a name="ln709">  {</a>
<a name="ln710">    dt_iop_module_t *new_module = dt_iop_gui_duplicate(module, FALSE);</a>
<a name="ln711">    if (new_module)</a>
<a name="ln712">      menuitem_pick_preset(menuitem, new_module);</a>
<a name="ln713">    return TRUE;</a>
<a name="ln714">  }</a>
<a name="ln715">  return FALSE;</a>
<a name="ln716">}</a>
<a name="ln717"> </a>
<a name="ln718">static void menuitem_favourite_toggled(GtkCheckMenuItem *checkmenuitem, gpointer user_data)</a>
<a name="ln719">{</a>
<a name="ln720">  dt_iop_module_t *module = (dt_iop_module_t *)user_data;</a>
<a name="ln721">  // the module is currently visible, otherwise we wouldn't show the popup. it should also stay visible.</a>
<a name="ln722">  dt_iop_module_state_t state = module-&gt;so-&gt;state;</a>
<a name="ln723">  if(state == dt_iop_state_FAVORITE) state = dt_iop_state_ACTIVE;</a>
<a name="ln724">  else state = dt_iop_state_FAVORITE;</a>
<a name="ln725">  dt_iop_gui_set_state(module, state);</a>
<a name="ln726">  if(state == dt_iop_state_FAVORITE)</a>
<a name="ln727">    dt_dev_modulegroups_set(darktable.develop, DT_MODULEGROUP_FAVORITES);</a>
<a name="ln728">}</a>
<a name="ln729"> </a>
<a name="ln730">void dt_gui_favorite_presets_menu_show()</a>
<a name="ln731">{</a>
<a name="ln732">  sqlite3_stmt *stmt;</a>
<a name="ln733">  GtkMenu *menu = darktable.gui-&gt;presets_popup_menu;</a>
<a name="ln734">  if(menu) gtk_widget_destroy(GTK_WIDGET(menu));</a>
<a name="ln735">  darktable.gui-&gt;presets_popup_menu = GTK_MENU(gtk_menu_new());</a>
<a name="ln736">  menu = darktable.gui-&gt;presets_popup_menu;</a>
<a name="ln737">  gboolean presets = FALSE; /* TRUE if we have at least one menu entry */</a>
<a name="ln738"> </a>
<a name="ln739">  GList *modules = darktable.develop-&gt;iop;</a>
<a name="ln740">  if(modules)</a>
<a name="ln741">  {</a>
<a name="ln742">    do</a>
<a name="ln743">    {</a>
<a name="ln744">      dt_iop_module_t *iop = (dt_iop_module_t *)modules-&gt;data;</a>
<a name="ln745"> </a>
<a name="ln746">      /* check if module is favorite */</a>
<a name="ln747">      if(iop-&gt;so-&gt;state == dt_iop_state_FAVORITE)</a>
<a name="ln748">      {</a>
<a name="ln749">        /* create submenu for module */</a>
<a name="ln750">        GtkMenuItem *smi = (GtkMenuItem *)gtk_menu_item_new_with_label(iop-&gt;name());</a>
<a name="ln751">        GtkMenu *sm = (GtkMenu *)gtk_menu_new();</a>
<a name="ln752">        gtk_menu_item_set_submenu(smi, GTK_WIDGET(sm));</a>
<a name="ln753"> </a>
<a name="ln754">        /* query presets for module */</a>
<a name="ln755">        DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), &quot;SELECT name, op_params, writeprotect, &quot;</a>
<a name="ln756">                                                                   &quot;description, blendop_params, op_version &quot;</a>
<a name="ln757">                                                                   &quot;FROM data.presets WHERE operation=?1 ORDER BY &quot;</a>
<a name="ln758">                                                                   &quot;writeprotect DESC, LOWER(name), rowid&quot;,</a>
<a name="ln759">                                    -1, &amp;stmt, NULL);</a>
<a name="ln760">        DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 1, iop-&gt;op, -1, SQLITE_TRANSIENT);</a>
<a name="ln761"> </a>
<a name="ln762">        while(sqlite3_step(stmt) == SQLITE_ROW)</a>
<a name="ln763">        {</a>
<a name="ln764">          char *name = (char *)sqlite3_column_text(stmt, 0);</a>
<a name="ln765">          GtkMenuItem *mi = (GtkMenuItem *)gtk_menu_item_new_with_label(name);</a>
<a name="ln766">          g_object_set_data_full(G_OBJECT(mi), &quot;dt-preset-name&quot;, g_strdup(name), g_free);</a>
<a name="ln767">          g_signal_connect(G_OBJECT(mi), &quot;activate&quot;, G_CALLBACK(menuitem_pick_preset), iop);</a>
<a name="ln768">          gtk_menu_shell_append(GTK_MENU_SHELL(sm), GTK_WIDGET(mi));</a>
<a name="ln769">        }</a>
<a name="ln770"> </a>
<a name="ln771">        sqlite3_finalize(stmt);</a>
<a name="ln772"> </a>
<a name="ln773">        /* add submenu to main menu if we got any presets */</a>
<a name="ln774">        GList *childs = gtk_container_get_children(GTK_CONTAINER(sm));</a>
<a name="ln775">        if(childs)</a>
<a name="ln776">        {</a>
<a name="ln777">          gtk_menu_shell_append(GTK_MENU_SHELL(menu), GTK_WIDGET(smi));</a>
<a name="ln778">          presets = TRUE;</a>
<a name="ln779">          g_list_free(childs);</a>
<a name="ln780">        }</a>
<a name="ln781">      }</a>
<a name="ln782"> </a>
<a name="ln783">    } while((modules = g_list_next(modules)) != NULL);</a>
<a name="ln784">  }</a>
<a name="ln785"> </a>
<a name="ln786">  if(!presets)</a>
<a name="ln787">  {</a>
<a name="ln788">    gtk_widget_destroy(GTK_WIDGET(menu));</a>
<a name="ln789">    darktable.gui-&gt;presets_popup_menu = NULL;</a>
<a name="ln790">  }</a>
<a name="ln791">}</a>
<a name="ln792"> </a>
<a name="ln793"> </a>
<a name="ln794">static void dt_gui_presets_popup_menu_show_internal(dt_dev_operation_t op, int32_t version,</a>
<a name="ln795">                                                    dt_iop_params_t *params, int32_t params_size,</a>
<a name="ln796">                                                    dt_develop_blend_params_t *bl_params,</a>
<a name="ln797">                                                    dt_iop_module_t *module, const dt_image_t *image,</a>
<a name="ln798">                                                    void (*pick_callback)(GtkMenuItem *, void *),</a>
<a name="ln799">                                                    void *callback_data)</a>
<a name="ln800">{</a>
<a name="ln801">  GtkMenu *menu = darktable.gui-&gt;presets_popup_menu;</a>
<a name="ln802">  if(menu) gtk_widget_destroy(GTK_WIDGET(menu));</a>
<a name="ln803">  darktable.gui-&gt;presets_popup_menu = GTK_MENU(gtk_menu_new());</a>
<a name="ln804">  menu = darktable.gui-&gt;presets_popup_menu;</a>
<a name="ln805"> </a>
<a name="ln806">  GtkWidget *mi;</a>
<a name="ln807">  int active_preset = -1, cnt = 0, writeprotect = 0; //, selected_default = 0;</a>
<a name="ln808">  sqlite3_stmt *stmt;</a>
<a name="ln809">  // order: get shipped defaults first</a>
<a name="ln810">  if(image)</a>
<a name="ln811">  {</a>
<a name="ln812">    // only matching if filter is on:</a>
<a name="ln813">    DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln814">                                &quot;SELECT name, op_params, writeprotect, description, blendop_params, &quot;</a>
<a name="ln815">                                &quot;op_version, enabled FROM data.presets WHERE operation=?1 AND &quot;</a>
<a name="ln816">                                &quot;(filter=0 OR ( &quot;</a>
<a name="ln817">                                &quot;((?2 LIKE model AND ?3 LIKE maker) OR (?4 LIKE model AND ?5 LIKE maker)) AND &quot;</a>
<a name="ln818">                                &quot;?6 LIKE lens AND &quot;</a>
<a name="ln819">                                &quot;?7 BETWEEN iso_min AND iso_max AND &quot;</a>
<a name="ln820">                                &quot;?8 BETWEEN exposure_min AND exposure_max AND &quot;</a>
<a name="ln821">                                &quot;?9 BETWEEN aperture_min AND aperture_max AND &quot;</a>
<a name="ln822">                                &quot;?10 BETWEEN focal_length_min AND focal_length_max AND &quot;</a>
<a name="ln823">                                &quot;(format = 0 OR format&amp;?11!=0)&quot;</a>
<a name="ln824">                                &quot; ) )&quot;</a>
<a name="ln825">                                &quot;ORDER BY writeprotect DESC, LOWER(name), rowid&quot;,</a>
<a name="ln826">                                -1, &amp;stmt, NULL);</a>
<a name="ln827">    DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 1, op, -1, SQLITE_TRANSIENT);</a>
<a name="ln828">    DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 2, image-&gt;exif_model, -1, SQLITE_TRANSIENT);</a>
<a name="ln829">    DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 3, image-&gt;exif_maker, -1, SQLITE_TRANSIENT);</a>
<a name="ln830">    DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 4, image-&gt;camera_alias, -1, SQLITE_TRANSIENT);</a>
<a name="ln831">    DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 5, image-&gt;camera_maker, -1, SQLITE_TRANSIENT);</a>
<a name="ln832">    DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 6, image-&gt;exif_lens, -1, SQLITE_TRANSIENT);</a>
<a name="ln833">    DT_DEBUG_SQLITE3_BIND_DOUBLE(stmt, 7, image-&gt;exif_iso);</a>
<a name="ln834">    DT_DEBUG_SQLITE3_BIND_DOUBLE(stmt, 8, image-&gt;exif_exposure);</a>
<a name="ln835">    DT_DEBUG_SQLITE3_BIND_DOUBLE(stmt, 9, image-&gt;exif_aperture);</a>
<a name="ln836">    DT_DEBUG_SQLITE3_BIND_DOUBLE(stmt, 10, image-&gt;exif_focal_length);</a>
<a name="ln837">    int ldr = dt_image_is_ldr(image) ? FOR_LDR : (dt_image_is_raw(image) ? FOR_RAW : FOR_HDR);</a>
<a name="ln838">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 11, ldr);</a>
<a name="ln839">  }</a>
<a name="ln840">  else</a>
<a name="ln841">  {</a>
<a name="ln842">    // don't know for which image. show all we got:</a>
<a name="ln843">    DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), &quot;SELECT name, op_params, writeprotect, &quot;</a>
<a name="ln844">                                                               &quot;description, blendop_params, op_version, &quot;</a>
<a name="ln845">                                                               &quot;enabled FROM data.presets WHERE operation=?1 &quot;</a>
<a name="ln846">                                                               &quot;ORDER BY writeprotect DESC, LOWER(name), rowid&quot;,</a>
<a name="ln847">                                -1, &amp;stmt, NULL);</a>
<a name="ln848">    DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 1, op, -1, SQLITE_TRANSIENT);</a>
<a name="ln849">  }</a>
<a name="ln850">  // collect all presets for op from db</a>
<a name="ln851">  int found = 0;</a>
<a name="ln852">  while(sqlite3_step(stmt) == SQLITE_ROW)</a>
<a name="ln853">  {</a>
<a name="ln854">    void *op_params = (void *)sqlite3_column_blob(stmt, 1);</a>
<a name="ln855">    int32_t op_params_size = sqlite3_column_bytes(stmt, 1);</a>
<a name="ln856">    void *blendop_params = (void *)sqlite3_column_blob(stmt, 4);</a>
<a name="ln857">    int32_t bl_params_size = sqlite3_column_bytes(stmt, 4);</a>
<a name="ln858">    int32_t preset_version = sqlite3_column_int(stmt, 5);</a>
<a name="ln859">    int32_t enabled = sqlite3_column_int(stmt, 6);</a>
<a name="ln860">    int32_t isdefault = 0;</a>
<a name="ln861">    int32_t isdisabled = (preset_version == version ? 0 : 1);</a>
<a name="ln862">    const char *name = (char *)sqlite3_column_text(stmt, 0);</a>
<a name="ln863"> </a>
<a name="ln864">    if(darktable.gui-&gt;last_preset &amp;&amp; strcmp(darktable.gui-&gt;last_preset, name) == 0) found = 1;</a>
<a name="ln865"> </a>
<a name="ln866">    if(module &amp;&amp; !memcmp(module-&gt;default_params, op_params, MIN(op_params_size, module-&gt;params_size))</a>
<a name="ln867">       &amp;&amp; !memcmp(module-&gt;default_blendop_params, blendop_params,</a>
<a name="ln868">                  MIN(bl_params_size, sizeof(dt_develop_blend_params_t))))</a>
<a name="ln869">      isdefault = 1;</a>
<a name="ln870">    if(module &amp;&amp; !memcmp(params, op_params, MIN(op_params_size, params_size))</a>
<a name="ln871">       &amp;&amp; !memcmp(bl_params, blendop_params, MIN(bl_params_size, sizeof(dt_develop_blend_params_t)))</a>
<a name="ln872">       &amp;&amp; module-&gt;enabled == enabled)</a>
<a name="ln873">    {</a>
<a name="ln874">      active_preset = cnt;</a>
<a name="ln875">      writeprotect = sqlite3_column_int(stmt, 2);</a>
<a name="ln876">      char *markup;</a>
<a name="ln877">      mi = gtk_menu_item_new_with_label(&quot;&quot;);</a>
<a name="ln878">      if(isdefault)</a>
<a name="ln879">      {</a>
<a name="ln880">        markup = g_markup_printf_escaped(&quot;&lt;span weight=\&quot;bold\&quot;&gt;%s %s&lt;/span&gt;&quot;, name, _(&quot;(default)&quot;));</a>
<a name="ln881">      }</a>
<a name="ln882">      else</a>
<a name="ln883">        markup = g_markup_printf_escaped(&quot;&lt;span weight=\&quot;bold\&quot;&gt;%s&lt;/span&gt;&quot;, name);</a>
<a name="ln884">      gtk_label_set_markup(GTK_LABEL(gtk_bin_get_child(GTK_BIN(mi))), markup);</a>
<a name="ln885">      g_free(markup);</a>
<a name="ln886">    }</a>
<a name="ln887">    else</a>
<a name="ln888">    {</a>
<a name="ln889">      if(isdefault)</a>
<a name="ln890">      {</a>
<a name="ln891">        char *markup;</a>
<a name="ln892">        mi = gtk_menu_item_new_with_label(&quot;&quot;);</a>
<a name="ln893">        markup = g_markup_printf_escaped(&quot;%s %s&quot;, name, _(&quot;(default)&quot;));</a>
<a name="ln894">        gtk_label_set_markup(GTK_LABEL(gtk_bin_get_child(GTK_BIN(mi))), markup);</a>
<a name="ln895">        g_free(markup);</a>
<a name="ln896">      }</a>
<a name="ln897">      else</a>
<a name="ln898">        mi = gtk_menu_item_new_with_label((const char *)name);</a>
<a name="ln899">    }</a>
<a name="ln900"> </a>
<a name="ln901">    if(isdisabled)</a>
<a name="ln902">    {</a>
<a name="ln903">      gtk_widget_set_sensitive(mi, 0);</a>
<a name="ln904">      gtk_widget_set_tooltip_text(mi, _(&quot;disabled: wrong module version&quot;));</a>
<a name="ln905">    }</a>
<a name="ln906">    else</a>
<a name="ln907">    {</a>
<a name="ln908">      g_object_set_data_full(G_OBJECT(mi), &quot;dt-preset-name&quot;, g_strdup(name), g_free);</a>
<a name="ln909">      if(module)</a>
<a name="ln910">      {</a>
<a name="ln911">        g_signal_connect(G_OBJECT(mi), &quot;button-press-event&quot;, G_CALLBACK(menuitem_button_pressed_preset), module);</a>
<a name="ln912">      }</a>
<a name="ln913">      else if(pick_callback)</a>
<a name="ln914">        g_signal_connect(G_OBJECT(mi), &quot;activate&quot;, G_CALLBACK(pick_callback), callback_data);</a>
<a name="ln915">      gtk_widget_set_tooltip_text(mi, (const char *)sqlite3_column_text(stmt, 3));</a>
<a name="ln916">    }</a>
<a name="ln917">    gtk_menu_shell_append(GTK_MENU_SHELL(menu), mi);</a>
<a name="ln918">    cnt++;</a>
<a name="ln919">  }</a>
<a name="ln920">  sqlite3_finalize(stmt);</a>
<a name="ln921"> </a>
<a name="ln922">  if(cnt &gt; 0) gtk_menu_shell_append(GTK_MENU_SHELL(menu), gtk_separator_menu_item_new());</a>
<a name="ln923"> </a>
<a name="ln924">  if(module)</a>
<a name="ln925">  {</a>
<a name="ln926">    if(active_preset &gt;= 0 &amp;&amp; !writeprotect)</a>
<a name="ln927">    {</a>
<a name="ln928">      mi = gtk_menu_item_new_with_label(_(&quot;edit this preset..&quot;));</a>
<a name="ln929">      g_signal_connect(G_OBJECT(mi), &quot;activate&quot;, G_CALLBACK(menuitem_edit_preset), module);</a>
<a name="ln930">      gtk_menu_shell_append(GTK_MENU_SHELL(menu), mi);</a>
<a name="ln931"> </a>
<a name="ln932">      mi = gtk_menu_item_new_with_label(_(&quot;delete this preset&quot;));</a>
<a name="ln933">      g_signal_connect(G_OBJECT(mi), &quot;activate&quot;, G_CALLBACK(menuitem_delete_preset), module);</a>
<a name="ln934">      gtk_menu_shell_append(GTK_MENU_SHELL(menu), mi);</a>
<a name="ln935">    }</a>
<a name="ln936">    else</a>
<a name="ln937">    {</a>
<a name="ln938">      mi = gtk_menu_item_new_with_label(_(&quot;store new preset..&quot;));</a>
<a name="ln939">      g_signal_connect(G_OBJECT(mi), &quot;activate&quot;, G_CALLBACK(menuitem_new_preset), module);</a>
<a name="ln940">      gtk_menu_shell_append(GTK_MENU_SHELL(menu), mi);</a>
<a name="ln941"> </a>
<a name="ln942">      if(darktable.gui-&gt;last_preset &amp;&amp; found)</a>
<a name="ln943">      {</a>
<a name="ln944">        char *markup = g_markup_printf_escaped(&quot;%s &lt;span weight=\&quot;bold\&quot;&gt;%s&lt;/span&gt;&quot;, _(&quot;update preset&quot;),</a>
<a name="ln945">                                               darktable.gui-&gt;last_preset);</a>
<a name="ln946">        mi = gtk_menu_item_new_with_label(&quot;&quot;);</a>
<a name="ln947">        gtk_label_set_markup(GTK_LABEL(gtk_bin_get_child(GTK_BIN(mi))), markup);</a>
<a name="ln948">        g_object_set_data_full(G_OBJECT(mi), &quot;dt-preset-name&quot;, g_strdup(darktable.gui-&gt;last_preset), g_free);</a>
<a name="ln949">        g_signal_connect(G_OBJECT(mi), &quot;activate&quot;, G_CALLBACK(menuitem_update_preset), module);</a>
<a name="ln950">        gtk_menu_shell_append(GTK_MENU_SHELL(menu), mi);</a>
<a name="ln951">        g_free(markup);</a>
<a name="ln952">      }</a>
<a name="ln953">    }</a>
<a name="ln954"> </a>
<a name="ln955">    // add a section to toggle favourite status of the module</a>
<a name="ln956">    gtk_menu_shell_append(GTK_MENU_SHELL(menu), gtk_separator_menu_item_new());</a>
<a name="ln957">    mi = gtk_check_menu_item_new_with_label(_(&quot;favourite&quot;));</a>
<a name="ln958">    gtk_check_menu_item_set_active(GTK_CHECK_MENU_ITEM(mi), module-&gt;so-&gt;state == dt_iop_state_FAVORITE);</a>
<a name="ln959">    g_signal_connect(G_OBJECT(mi), &quot;toggled&quot;, G_CALLBACK(menuitem_favourite_toggled), module);</a>
<a name="ln960">    gtk_menu_shell_append(GTK_MENU_SHELL(menu), mi);</a>
<a name="ln961">  }</a>
<a name="ln962">}</a>
<a name="ln963"> </a>
<a name="ln964">void dt_gui_presets_popup_menu_show_for_params(dt_dev_operation_t op, int32_t version, void *params,</a>
<a name="ln965">                                               int32_t params_size, void *blendop_params,</a>
<a name="ln966">                                               const dt_image_t *image,</a>
<a name="ln967">                                               void (*pick_callback)(GtkMenuItem *, void *),</a>
<a name="ln968">                                               void *callback_data)</a>
<a name="ln969">{</a>
<a name="ln970">  dt_gui_presets_popup_menu_show_internal(op, version, params, params_size, blendop_params, NULL, image,</a>
<a name="ln971">                                          pick_callback, callback_data);</a>
<a name="ln972">}</a>
<a name="ln973"> </a>
<a name="ln974">void dt_gui_presets_popup_menu_show_for_module(dt_iop_module_t *module)</a>
<a name="ln975">{</a>
<a name="ln976">  dt_gui_presets_popup_menu_show_internal(module-&gt;op, module-&gt;version(), module-&gt;params, module-&gt;params_size,</a>
<a name="ln977">                                          module-&gt;blend_params, module, &amp;module-&gt;dev-&gt;image_storage, NULL,</a>
<a name="ln978">                                          NULL);</a>
<a name="ln979">}</a>
<a name="ln980"> </a>
<a name="ln981">void dt_gui_presets_update_mml(const char *name, dt_dev_operation_t op, const int32_t version,</a>
<a name="ln982">                               const char *maker, const char *model, const char *lens)</a>
<a name="ln983">{</a>
<a name="ln984">  char tmp[1024];</a>
<a name="ln985">  sqlite3_stmt *stmt;</a>
<a name="ln986">  DT_DEBUG_SQLITE3_PREPARE_V2(</a>
<a name="ln987">      dt_database_get(darktable.db),</a>
<a name="ln988">      &quot;UPDATE data.presets SET maker=?1, model=?2, lens=?3 WHERE operation=?4 AND op_version=?5 AND name=?6&quot;, -1,</a>
<a name="ln989">      &amp;stmt, NULL);</a>
<a name="ln990">  snprintf(tmp, sizeof(tmp), &quot;%%%s%%&quot;, maker);</a>
<a name="ln991">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 1, tmp, -1, SQLITE_TRANSIENT);</a>
<a name="ln992">  snprintf(tmp, sizeof(tmp), &quot;%%%s%%&quot;, model);</a>
<a name="ln993">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 2, tmp, -1, SQLITE_TRANSIENT);</a>
<a name="ln994">  snprintf(tmp, sizeof(tmp), &quot;%%%s%%&quot;, lens);</a>
<a name="ln995">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 3, tmp, -1, SQLITE_TRANSIENT);</a>
<a name="ln996">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 4, op, -1, SQLITE_TRANSIENT);</a>
<a name="ln997">  DT_DEBUG_SQLITE3_BIND_INT(stmt, 5, version);</a>
<a name="ln998">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 6, name, -1, SQLITE_TRANSIENT);</a>
<a name="ln999">  sqlite3_step(stmt);</a>
<a name="ln1000">  sqlite3_finalize(stmt);</a>
<a name="ln1001">}</a>
<a name="ln1002"> </a>
<a name="ln1003">void dt_gui_presets_update_iso(const char *name, dt_dev_operation_t op, const int32_t version,</a>
<a name="ln1004">                               const float min, const float max)</a>
<a name="ln1005">{</a>
<a name="ln1006">  sqlite3_stmt *stmt;</a>
<a name="ln1007">  DT_DEBUG_SQLITE3_PREPARE_V2(</a>
<a name="ln1008">      dt_database_get(darktable.db),</a>
<a name="ln1009">      &quot;UPDATE data.presets SET iso_min=?1, iso_max=?2 WHERE operation=?3 AND op_version=?4 AND name=?5&quot;, -1, &amp;stmt,</a>
<a name="ln1010">      NULL);</a>
<a name="ln1011">  DT_DEBUG_SQLITE3_BIND_DOUBLE(stmt, 1, min);</a>
<a name="ln1012">  DT_DEBUG_SQLITE3_BIND_DOUBLE(stmt, 2, max);</a>
<a name="ln1013">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 3, op, -1, SQLITE_TRANSIENT);</a>
<a name="ln1014">  DT_DEBUG_SQLITE3_BIND_INT(stmt, 4, version);</a>
<a name="ln1015">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 5, name, -1, SQLITE_TRANSIENT);</a>
<a name="ln1016">  sqlite3_step(stmt);</a>
<a name="ln1017">  sqlite3_finalize(stmt);</a>
<a name="ln1018">}</a>
<a name="ln1019"> </a>
<a name="ln1020">void dt_gui_presets_update_av(const char *name, dt_dev_operation_t op, const int32_t version, const float min,</a>
<a name="ln1021">                              const float max)</a>
<a name="ln1022">{</a>
<a name="ln1023">  sqlite3_stmt *stmt;</a>
<a name="ln1024">  DT_DEBUG_SQLITE3_PREPARE_V2(</a>
<a name="ln1025">      dt_database_get(darktable.db),</a>
<a name="ln1026">      &quot;UPDATE data.presets SET aperture_min=?1, aperture_max=?2 WHERE operation=?3 AND op_version=?4 AND name=?5&quot;,</a>
<a name="ln1027">      -1, &amp;stmt, NULL);</a>
<a name="ln1028">  DT_DEBUG_SQLITE3_BIND_DOUBLE(stmt, 1, min);</a>
<a name="ln1029">  DT_DEBUG_SQLITE3_BIND_DOUBLE(stmt, 2, max);</a>
<a name="ln1030">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 3, op, -1, SQLITE_TRANSIENT);</a>
<a name="ln1031">  DT_DEBUG_SQLITE3_BIND_INT(stmt, 4, version);</a>
<a name="ln1032">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 5, name, -1, SQLITE_TRANSIENT);</a>
<a name="ln1033">  sqlite3_step(stmt);</a>
<a name="ln1034">  sqlite3_finalize(stmt);</a>
<a name="ln1035">}</a>
<a name="ln1036"> </a>
<a name="ln1037">void dt_gui_presets_update_tv(const char *name, dt_dev_operation_t op, const int32_t version, const float min,</a>
<a name="ln1038">                              const float max)</a>
<a name="ln1039">{</a>
<a name="ln1040">  sqlite3_stmt *stmt;</a>
<a name="ln1041">  DT_DEBUG_SQLITE3_PREPARE_V2(</a>
<a name="ln1042">      dt_database_get(darktable.db),</a>
<a name="ln1043">      &quot;UPDATE data.presets SET exposure_min=?1, exposure_max=?2 WHERE operation=?3 AND op_version=?4 AND name=?5&quot;,</a>
<a name="ln1044">      -1, &amp;stmt, NULL);</a>
<a name="ln1045">  DT_DEBUG_SQLITE3_BIND_DOUBLE(stmt, 1, min);</a>
<a name="ln1046">  DT_DEBUG_SQLITE3_BIND_DOUBLE(stmt, 2, max);</a>
<a name="ln1047">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 3, op, -1, SQLITE_TRANSIENT);</a>
<a name="ln1048">  DT_DEBUG_SQLITE3_BIND_INT(stmt, 4, version);</a>
<a name="ln1049">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 5, name, -1, SQLITE_TRANSIENT);</a>
<a name="ln1050">  sqlite3_step(stmt);</a>
<a name="ln1051">  sqlite3_finalize(stmt);</a>
<a name="ln1052">}</a>
<a name="ln1053"> </a>
<a name="ln1054">void dt_gui_presets_update_fl(const char *name, dt_dev_operation_t op, const int32_t version, const float min,</a>
<a name="ln1055">                              const float max)</a>
<a name="ln1056">{</a>
<a name="ln1057">  sqlite3_stmt *stmt;</a>
<a name="ln1058">  DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), &quot;UPDATE data.presets SET focal_length_min=?1, &quot;</a>
<a name="ln1059">                                                             &quot;focal_length_max=?2 WHERE operation=?3 AND &quot;</a>
<a name="ln1060">                                                             &quot;op_version=?4 AND name=?5&quot;,</a>
<a name="ln1061">                              -1, &amp;stmt, NULL);</a>
<a name="ln1062">  DT_DEBUG_SQLITE3_BIND_DOUBLE(stmt, 1, min);</a>
<a name="ln1063">  DT_DEBUG_SQLITE3_BIND_DOUBLE(stmt, 2, max);</a>
<a name="ln1064">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 3, op, -1, SQLITE_TRANSIENT);</a>
<a name="ln1065">  DT_DEBUG_SQLITE3_BIND_INT(stmt, 4, version);</a>
<a name="ln1066">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 5, name, -1, SQLITE_TRANSIENT);</a>
<a name="ln1067">  sqlite3_step(stmt);</a>
<a name="ln1068">  sqlite3_finalize(stmt);</a>
<a name="ln1069">}</a>
<a name="ln1070"> </a>
<a name="ln1071">void dt_gui_presets_update_ldr(const char *name, dt_dev_operation_t op, const int32_t version,</a>
<a name="ln1072">                               const int ldrflag)</a>
<a name="ln1073">{</a>
<a name="ln1074">  sqlite3_stmt *stmt;</a>
<a name="ln1075">  DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln1076">                              &quot;UPDATE data.presets SET format=?1 WHERE operation=?2 AND op_version=?3 AND name=?4&quot;,</a>
<a name="ln1077">                              -1, &amp;stmt, NULL);</a>
<a name="ln1078">  DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, ldrflag);</a>
<a name="ln1079">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 2, op, -1, SQLITE_TRANSIENT);</a>
<a name="ln1080">  DT_DEBUG_SQLITE3_BIND_INT(stmt, 3, version);</a>
<a name="ln1081">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 4, name, -1, SQLITE_TRANSIENT);</a>
<a name="ln1082">  sqlite3_step(stmt);</a>
<a name="ln1083">  sqlite3_finalize(stmt);</a>
<a name="ln1084">}</a>
<a name="ln1085"> </a>
<a name="ln1086">void dt_gui_presets_update_autoapply(const char *name, dt_dev_operation_t op, const int32_t version,</a>
<a name="ln1087">                                     const int autoapply)</a>
<a name="ln1088">{</a>
<a name="ln1089">  sqlite3_stmt *stmt;</a>
<a name="ln1090">  DT_DEBUG_SQLITE3_PREPARE_V2(</a>
<a name="ln1091">      dt_database_get(darktable.db),</a>
<a name="ln1092">      &quot;UPDATE data.presets SET autoapply=?1 WHERE operation=?2 AND op_version=?3 AND name=?4&quot;, -1, &amp;stmt, NULL);</a>
<a name="ln1093">  DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, autoapply);</a>
<a name="ln1094">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 2, op, -1, SQLITE_TRANSIENT);</a>
<a name="ln1095">  DT_DEBUG_SQLITE3_BIND_INT(stmt, 3, version);</a>
<a name="ln1096">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 4, name, -1, SQLITE_TRANSIENT);</a>
<a name="ln1097">  sqlite3_step(stmt);</a>
<a name="ln1098">  sqlite3_finalize(stmt);</a>
<a name="ln1099">}</a>
<a name="ln1100"> </a>
<a name="ln1101">void dt_gui_presets_update_filter(const char *name, dt_dev_operation_t op, const int32_t version,</a>
<a name="ln1102">                                  const int filter)</a>
<a name="ln1103">{</a>
<a name="ln1104">  sqlite3_stmt *stmt;</a>
<a name="ln1105">  DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln1106">                              &quot;UPDATE data.presets SET filter=?1 WHERE operation=?2 AND op_version=?3 AND name=?4&quot;,</a>
<a name="ln1107">                              -1, &amp;stmt, NULL);</a>
<a name="ln1108">  DT_DEBUG_SQLITE3_BIND_INT(stmt, 1, filter);</a>
<a name="ln1109">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 2, op, -1, SQLITE_TRANSIENT);</a>
<a name="ln1110">  DT_DEBUG_SQLITE3_BIND_INT(stmt, 3, version);</a>
<a name="ln1111">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 4, name, -1, SQLITE_TRANSIENT);</a>
<a name="ln1112">  sqlite3_step(stmt);</a>
<a name="ln1113">  sqlite3_finalize(stmt);</a>
<a name="ln1114">}</a>
<a name="ln1115"> </a>
<a name="ln1116">// modelines: These editor modelines have been set for all relevant files by tools/update_modelines.sh</a>
<a name="ln1117">// vim: shiftwidth=2 expandtab tabstop=2 cindent</a>
<a name="ln1118">// kate: tab-indents: off; indent-width 2; replace-tabs on; indent-mode cstyle; remove-trailing-spaces modified;</a>

</code></pre>
<div class="balloon" rel="398"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v522/" target="_blank">V522</a> There might be dereferencing of a potential null pointer 'g'. Check lines: 398, 397.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
