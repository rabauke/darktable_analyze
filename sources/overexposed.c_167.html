
<html>
<head>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>
<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2">    This file is part of darktable,</a>
<a name="ln3">    copyright (c) 2010-2013 Tobias Ellinghaus.</a>
<a name="ln4">    copyright (c) 2011-2012 henrik andersson.</a>
<a name="ln5"> </a>
<a name="ln6">    darktable is free software: you can redistribute it and/or modify</a>
<a name="ln7">    it under the terms of the GNU General Public License as published by</a>
<a name="ln8">    the Free Software Foundation, either version 3 of the License, or</a>
<a name="ln9">    (at your option) any later version.</a>
<a name="ln10"> </a>
<a name="ln11">    darktable is distributed in the hope that it will be useful,</a>
<a name="ln12">    but WITHOUT ANY WARRANTY; without even the implied warranty of</a>
<a name="ln13">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</a>
<a name="ln14">    GNU General Public License for more details.</a>
<a name="ln15"> </a>
<a name="ln16">    You should have received a copy of the GNU General Public License</a>
<a name="ln17">    along with darktable.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</a>
<a name="ln18">*/</a>
<a name="ln19">#ifdef HAVE_CONFIG_H</a>
<a name="ln20">#include &quot;config.h&quot;</a>
<a name="ln21">#endif</a>
<a name="ln22">#include &lt;stdlib.h&gt;</a>
<a name="ln23">#if defined(__SSE__)</a>
<a name="ln24">#include &lt;xmmintrin.h&gt;</a>
<a name="ln25">#endif</a>
<a name="ln26">#include &lt;cairo.h&gt;</a>
<a name="ln27"> </a>
<a name="ln28">#include &quot;common/opencl.h&quot;</a>
<a name="ln29">#include &quot;control/control.h&quot;</a>
<a name="ln30">#include &quot;develop/develop.h&quot;</a>
<a name="ln31">#include &quot;develop/imageop.h&quot;</a>
<a name="ln32">#include &quot;develop/imageop_math.h&quot;</a>
<a name="ln33">#include &quot;gui/accelerators.h&quot;</a>
<a name="ln34">#include &quot;iop/iop_api.h&quot;</a>
<a name="ln35"> </a>
<a name="ln36">DT_MODULE(3)</a>
<a name="ln37"> </a>
<a name="ln38">typedef enum dt_iop_overexposed_colorscheme_t</a>
<a name="ln39">{</a>
<a name="ln40">  DT_IOP_OVEREXPOSED_BLACKWHITE = 0,</a>
<a name="ln41">  DT_IOP_OVEREXPOSED_REDBLUE = 1,</a>
<a name="ln42">  DT_IOP_OVEREXPOSED_PURPLEGREEN = 2</a>
<a name="ln43">} dt_iop_overexposed_colorscheme_t;</a>
<a name="ln44"> </a>
<a name="ln45">static const float dt_iop_overexposed_colors[][2][4]</a>
<a name="ln46">    = { {</a>
<a name="ln47">          { 0.0f, 0.0f, 0.0f, 1.0f }, // black</a>
<a name="ln48">          { 1.0f, 1.0f, 1.0f, 1.0f }  // white</a>
<a name="ln49">        },</a>
<a name="ln50">        {</a>
<a name="ln51">          { 1.0f, 0.0f, 0.0f, 1.0f }, // red</a>
<a name="ln52">          { 0.0f, 0.0f, 1.0f, 1.0f }  // blue</a>
<a name="ln53">        },</a>
<a name="ln54">        {</a>
<a name="ln55">          { 0.371f, 0.434f, 0.934f, 1.0f }, // purple (#5f6fef)</a>
<a name="ln56">          { 0.512f, 0.934f, 0.371f, 1.0f }  // green  (#83ef5f)</a>
<a name="ln57">        } };</a>
<a name="ln58"> </a>
<a name="ln59">typedef struct dt_iop_overexposed_global_data_t</a>
<a name="ln60">{</a>
<a name="ln61">  int kernel_overexposed;</a>
<a name="ln62">} dt_iop_overexposed_global_data_t;</a>
<a name="ln63"> </a>
<a name="ln64">typedef struct dt_iop_overexposed_t</a>
<a name="ln65">{</a>
<a name="ln66">  int dummy;</a>
<a name="ln67">} dt_iop_overexposed_t;</a>
<a name="ln68"> </a>
<a name="ln69">const char *name()</a>
<a name="ln70">{</a>
<a name="ln71">  return _(&quot;overexposed&quot;);</a>
<a name="ln72">}</a>
<a name="ln73"> </a>
<a name="ln74">int default_group()</a>
<a name="ln75">{</a>
<a name="ln76">  return IOP_GROUP_BASIC;</a>
<a name="ln77">}</a>
<a name="ln78"> </a>
<a name="ln79">int flags()</a>
<a name="ln80">{</a>
<a name="ln81">  return IOP_FLAGS_ALLOW_TILING | IOP_FLAGS_HIDDEN | IOP_FLAGS_ONE_INSTANCE | IOP_FLAGS_NO_HISTORY_STACK;</a>
<a name="ln82">}</a>
<a name="ln83"> </a>
<a name="ln84"> </a>
<a name="ln85">int legacy_params(dt_iop_module_t *self, const void *const old_params, const int old_version,</a>
<a name="ln86">                  void *new_params, const int new_version)</a>
<a name="ln87">{</a>
<a name="ln88">  // we do no longer have module params in here and just ignore any legacy entries</a>
<a name="ln89">  return 0;</a>
<a name="ln90">}</a>
<a name="ln91"> </a>
<a name="ln92"> </a>
<a name="ln93">// void init_key_accels(dt_iop_module_so_t *self)</a>
<a name="ln94">// {</a>
<a name="ln95">//   dt_accel_register_slider_iop(self, FALSE, NC_(&quot;accel&quot;, &quot;lower threshold&quot;));</a>
<a name="ln96">//   dt_accel_register_slider_iop(self, FALSE, NC_(&quot;accel&quot;, &quot;upper threshold&quot;));</a>
<a name="ln97">//   dt_accel_register_slider_iop(self, FALSE, NC_(&quot;accel&quot;, &quot;color scheme&quot;));</a>
<a name="ln98">// }</a>
<a name="ln99">//</a>
<a name="ln100">// void connect_key_accels(dt_iop_module_t *self)</a>
<a name="ln101">// {</a>
<a name="ln102">//   dt_iop_overexposed_gui_data_t *g =</a>
<a name="ln103">//     (dt_iop_overexposed_gui_data_t*)self-&gt;gui_data;</a>
<a name="ln104">//</a>
<a name="ln105">//   dt_accel_connect_slider_iop(self, &quot;lower threshold&quot;, GTK_WIDGET(g-&gt;lower));</a>
<a name="ln106">//   dt_accel_connect_slider_iop(self, &quot;upper threshold&quot;, GTK_WIDGET(g-&gt;upper));</a>
<a name="ln107">//   dt_accel_connect_slider_iop(self, &quot;color scheme&quot;, GTK_WIDGET(g-&gt;colorscheme));</a>
<a name="ln108">// }</a>
<a name="ln109"> </a>
<a name="ln110">void process(struct dt_iop_module_t *self, dt_dev_pixelpipe_iop_t *piece, const void *const ivoid,</a>
<a name="ln111">             void *const ovoid, const dt_iop_roi_t *const roi_in, const dt_iop_roi_t *const roi_out)</a>
<a name="ln112">{</a>
<a name="ln113">  dt_develop_t *dev = self-&gt;dev;</a>
<a name="ln114"> </a>
<a name="ln115">  const int ch = piece-&gt;colors;</a>
<a name="ln116"> </a>
<a name="ln117">  const float lower = MAX(dev-&gt;overexposed.lower / 100.0f, 1e-6f);</a>
<a name="ln118">  const float upper = dev-&gt;overexposed.upper / 100.0f;</a>
<a name="ln119"> </a>
<a name="ln120">  const int colorscheme = dev-&gt;overexposed.colorscheme;</a>
<a name="ln121">  const float *const upper_color = dt_iop_overexposed_colors[colorscheme][0];</a>
<a name="ln122">  const float *const lower_color = dt_iop_overexposed_colors[colorscheme][1];</a>
<a name="ln123"> </a>
<a name="ln124">  const float *const in = (const float *const)ivoid;</a>
<a name="ln125">  float *const out = (float *const)ovoid;</a>
<a name="ln126"> </a>
<a name="ln127">#ifdef _OPENMP</a>
<a name="ln128">#pragma omp parallel for default(none) schedule(static)</a>
<a name="ln129">#endif</a>
<a name="ln130">  for(size_t k = 0; k &lt; (size_t)ch * roi_out-&gt;width * roi_out-&gt;height; k += ch)</a>
<a name="ln131">  {</a>
<a name="ln132">    if(in[k + 0] &gt;= upper || in[k + 1] &gt;= upper || in[k + 2] &gt;= upper)</a>
<a name="ln133">    {</a>
<a name="ln134">      for(int c = 0; c &lt; 3; c++)</a>
<a name="ln135">      {</a>
<a name="ln136">        out[k + c] = upper_color[c];</a>
<a name="ln137">      }</a>
<a name="ln138">    }</a>
<a name="ln139">    else if(in[k + 0] &lt;= lower &amp;&amp; in[k + 1] &lt;= lower &amp;&amp; in[k + 2] &lt;= lower)</a>
<a name="ln140">    {</a>
<a name="ln141">      for(int c = 0; c &lt; 3; c++)</a>
<a name="ln142">      {</a>
<a name="ln143">        out[k + c] = lower_color[c];</a>
<a name="ln144">      }</a>
<a name="ln145">    }</a>
<a name="ln146">    else</a>
<a name="ln147">    {</a>
<a name="ln148">      for(int c = 0; c &lt; 3; c++)</a>
<a name="ln149">      {</a>
<a name="ln150">        const size_t p = (size_t)k + c;</a>
<a name="ln151">        out[p] = in[p];</a>
<a name="ln152">      }</a>
<a name="ln153">    }</a>
<a name="ln154">  }</a>
<a name="ln155"> </a>
<a name="ln156">  if(piece-&gt;pipe-&gt;mask_display &amp; DT_DEV_PIXELPIPE_DISPLAY_MASK) dt_iop_alpha_copy(ivoid, ovoid, roi_out-&gt;width, roi_out-&gt;height);</a>
<a name="ln157">}</a>
<a name="ln158"> </a>
<a name="ln159">#if defined(__SSE__)</a>
<a name="ln160">void process_sse2(struct dt_iop_module_t *self, dt_dev_pixelpipe_iop_t *piece, const void *const ivoid,</a>
<a name="ln161">                  void *const ovoid, const dt_iop_roi_t *const roi_in, const dt_iop_roi_t *const roi_out)</a>
<a name="ln162">{</a>
<a name="ln163">  dt_develop_t *dev = self-&gt;dev;</a>
<a name="ln164"> </a>
<a name="ln165">  const int ch = piece-&gt;colors;</a>
<a name="ln166">  const float lower = MAX(dev-&gt;overexposed.lower / 100.0f, 1e-6f);</a>
<a name="ln167">  const float upper = dev-&gt;overexposed.upper / 100.0f;</a>
<a name="ln168"> </a>
<a name="ln169">  const __m128 mupper = _mm_set_ps(FLT_MAX, upper, upper, upper);</a>
<a name="ln170">  const __m128 mlower = _mm_set_ps(FLT_MAX, lower, lower, lower);</a>
<a name="ln171"> </a>
<a name="ln172">  const int colorscheme = dev-&gt;overexposed.colorscheme;</a>
<a name="ln173">  const __m128 upper_color = _mm_load_ps(dt_iop_overexposed_colors[colorscheme][0]);</a>
<a name="ln174">  const __m128 lower_color = _mm_load_ps(dt_iop_overexposed_colors[colorscheme][1]);</a>
<a name="ln175"> </a>
<a name="ln176">#ifdef _OPENMP</a>
<a name="ln177">#pragma omp parallel for default(none) schedule(static)</a>
<a name="ln178">#endif</a>
<a name="ln179">  for(int k = 0; k &lt; roi_out-&gt;height; k++)</a>
<a name="ln180">  {</a>
<a name="ln181">    const float *in = ((float *)ivoid) + (size_t)ch * k * roi_out-&gt;width;</a>
<a name="ln182">    float *out = ((float *)ovoid) + (size_t)ch * k * roi_out-&gt;width;</a>
<a name="ln183"> </a>
<a name="ln184">    for(int j = 0; j &lt; roi_out-&gt;width; j++, in += 4, out += 4)</a>
<a name="ln185">    {</a>
<a name="ln186">      const __m128 pixel = _mm_load_ps(in);</a>
<a name="ln187"> </a>
<a name="ln188">      __m128 isoe = _mm_cmpge_ps(pixel, mupper);</a>
<a name="ln189">      isoe = _mm_or_ps(_mm_unpacklo_ps(isoe, isoe), _mm_unpackhi_ps(isoe, isoe));</a>
<a name="ln190">      isoe = _mm_or_ps(_mm_unpacklo_ps(isoe, isoe), _mm_unpackhi_ps(isoe, isoe));</a>
<a name="ln191"> </a>
<a name="ln192">      __m128 isue = _mm_cmple_ps(pixel, mlower);</a>
<a name="ln193">      isue = _mm_and_ps(_mm_unpacklo_ps(isue, isue), _mm_unpackhi_ps(isue, isue));</a>
<a name="ln194">      isue = _mm_and_ps(_mm_unpacklo_ps(isue, isue), _mm_unpackhi_ps(isue, isue));</a>
<a name="ln195"> </a>
<a name="ln196">      __m128 result = _mm_or_ps(_mm_andnot_ps(isoe, pixel), _mm_and_ps(isoe, upper_color));</a>
<a name="ln197"> </a>
<a name="ln198">      result = _mm_or_ps(_mm_andnot_ps(isue, result), _mm_and_ps(isue, lower_color));</a>
<a name="ln199"> </a>
<a name="ln200">      _mm_stream_ps(out, result);</a>
<a name="ln201">    }</a>
<a name="ln202">  }</a>
<a name="ln203">  _mm_sfence();</a>
<a name="ln204"> </a>
<a name="ln205">  if(piece-&gt;pipe-&gt;mask_display &amp; DT_DEV_PIXELPIPE_DISPLAY_MASK) dt_iop_alpha_copy(ivoid, ovoid, roi_out-&gt;width, roi_out-&gt;height);</a>
<a name="ln206">}</a>
<a name="ln207">#endif</a>
<a name="ln208"> </a>
<a name="ln209">#ifdef HAVE_OPENCL</a>
<a name="ln210">int process_cl(struct dt_iop_module_t *self, dt_dev_pixelpipe_iop_t *piece, cl_mem dev_in, cl_mem dev_out,</a>
<a name="ln211">               const dt_iop_roi_t *const roi_in, const dt_iop_roi_t *const roi_out)</a>
<a name="ln212">{</a>
<a name="ln213">  dt_develop_t *dev = self-&gt;dev;</a>
<a name="ln214">  dt_iop_overexposed_global_data_t *gd = (dt_iop_overexposed_global_data_t *)self-&gt;data;</a>
<a name="ln215"> </a>
<a name="ln216">  cl_int err = -999;</a>
<a name="ln217">  const int devid = piece-&gt;pipe-&gt;devid;</a>
<a name="ln218"> </a>
<a name="ln219">  const int width = roi_out-&gt;width;</a>
<a name="ln220">  const int height = roi_out-&gt;height;</a>
<a name="ln221"> </a>
<a name="ln222">  const float lower = MAX(dev-&gt;overexposed.lower / 100.0f, 1e-6f);</a>
<a name="ln223">  const float upper = dev-&gt;overexposed.upper / 100.0f;</a>
<a name="ln224">  const int colorscheme = dev-&gt;overexposed.colorscheme;</a>
<a name="ln225"> </a>
<a name="ln226">  const float *upper_color = dt_iop_overexposed_colors[colorscheme][0];</a>
<a name="ln227">  const float *lower_color = dt_iop_overexposed_colors[colorscheme][1];</a>
<a name="ln228"> </a>
<a name="ln229">  size_t sizes[2] = { ROUNDUPWD(width), ROUNDUPHT(height) };</a>
<a name="ln230">  dt_opencl_set_kernel_arg(devid, gd-&gt;kernel_overexposed, 0, sizeof(cl_mem), &amp;dev_in);</a>
<a name="ln231">  dt_opencl_set_kernel_arg(devid, gd-&gt;kernel_overexposed, 1, sizeof(cl_mem), &amp;dev_out);</a>
<a name="ln232">  dt_opencl_set_kernel_arg(devid, gd-&gt;kernel_overexposed, 2, sizeof(int), &amp;width);</a>
<a name="ln233">  dt_opencl_set_kernel_arg(devid, gd-&gt;kernel_overexposed, 3, sizeof(int), &amp;height);</a>
<a name="ln234">  dt_opencl_set_kernel_arg(devid, gd-&gt;kernel_overexposed, 4, sizeof(float), &amp;lower);</a>
<a name="ln235">  dt_opencl_set_kernel_arg(devid, gd-&gt;kernel_overexposed, 5, sizeof(float), &amp;upper);</a>
<a name="ln236">  dt_opencl_set_kernel_arg(devid, gd-&gt;kernel_overexposed, 6, 4 * sizeof(float), lower_color);</a>
<a name="ln237">  dt_opencl_set_kernel_arg(devid, gd-&gt;kernel_overexposed, 7, 4 * sizeof(float), upper_color);</a>
<a name="ln238">  err = dt_opencl_enqueue_kernel_2d(devid, gd-&gt;kernel_overexposed, sizes);</a>
<a name="ln239">  if(err != CL_SUCCESS) goto error;</a>
<a name="ln240">  return TRUE;</a>
<a name="ln241"> </a>
<a name="ln242">error:</a>
<a name="ln243">  dt_print(DT_DEBUG_OPENCL, &quot;[opencl_overexposed] couldn't enqueue kernel! %d\n&quot;, err);</a>
<a name="ln244">  return FALSE;</a>
<a name="ln245">}</a>
<a name="ln246">#endif</a>
<a name="ln247"> </a>
<a name="ln248"> </a>
<a name="ln249">void init_global(dt_iop_module_so_t *module)</a>
<a name="ln250">{</a>
<a name="ln251">  const int program = 2; // basic.cl from programs.conf</a>
<a name="ln252">  dt_iop_overexposed_global_data_t *gd</a>
<a name="ln253">      = (dt_iop_overexposed_global_data_t *)malloc(sizeof(dt_iop_overexposed_global_data_t));</a>
<a name="ln254">  module-&gt;data = gd;</a>
<a name="ln255">  gd-&gt;kernel_overexposed = dt_opencl_create_kernel(program, &quot;overexposed&quot;);</a>
<a name="ln256">}</a>
<a name="ln257"> </a>
<a name="ln258"> </a>
<a name="ln259">void cleanup_global(dt_iop_module_so_t *module)</a>
<a name="ln260">{</a>
<a name="ln261">  dt_iop_overexposed_global_data_t *gd = (dt_iop_overexposed_global_data_t *)module-&gt;data;</a>
<a name="ln262">  dt_opencl_free_kernel(gd-&gt;kernel_overexposed);</a>
<a name="ln263">  free(module-&gt;data);</a>
<a name="ln264">  module-&gt;data = NULL;</a>
<a name="ln265">}</a>
<a name="ln266"> </a>
<a name="ln267">void commit_params(struct dt_iop_module_t *self, dt_iop_params_t *p1, dt_dev_pixelpipe_t *pipe,</a>
<a name="ln268">                   dt_dev_pixelpipe_iop_t *piece)</a>
<a name="ln269">{</a>
<a name="ln270">  if(pipe-&gt;type != DT_DEV_PIXELPIPE_FULL || !self-&gt;dev-&gt;overexposed.enabled || !self-&gt;dev-&gt;gui_attached)</a>
<a name="ln271">    piece-&gt;enabled = 0;</a>
<a name="ln272">}</a>
<a name="ln273"> </a>
<a name="ln274">void init_pipe(struct dt_iop_module_t *self, dt_dev_pixelpipe_t *pipe, dt_dev_pixelpipe_iop_t *piece)</a>
<a name="ln275">{</a>
<a name="ln276">  piece-&gt;data = NULL;</a>
<a name="ln277">}</a>
<a name="ln278"> </a>
<a name="ln279">void cleanup_pipe(struct dt_iop_module_t *self, dt_dev_pixelpipe_t *pipe, dt_dev_pixelpipe_iop_t *piece)</a>
<a name="ln280">{</a>
<a name="ln281">}</a>
<a name="ln282"> </a>
<a name="ln283">void init(dt_iop_module_t *module)</a>
<a name="ln284">{</a>
<a name="ln285">  module-&gt;params = calloc(1, sizeof(dt_iop_overexposed_t));</a>
<a name="ln286">  module-&gt;default_params = calloc(1, sizeof(dt_iop_overexposed_t));</a>
<a name="ln287">  module-&gt;hide_enable_button = 1;</a>
<a name="ln288">  module-&gt;default_enabled = 1;</a>
<a name="ln289">  module-&gt;priority = 928; // module order created by iop_dependencies.py, do not edit!</a>
<a name="ln290">  module-&gt;params_size = sizeof(dt_iop_overexposed_t);</a>
<a name="ln291">  module-&gt;gui_data = NULL;</a>
<a name="ln292">}</a>
<a name="ln293"> </a>
<a name="ln294">void cleanup(dt_iop_module_t *module)</a>
<a name="ln295">{</a>
<a name="ln296">  free(module-&gt;params);</a>
<a name="ln297">  module-&gt;params = NULL;</a>
<a name="ln298">}</a>
<a name="ln299"> </a>
<a name="ln300">// modelines: These editor modelines have been set for all relevant files by tools/update_modelines.sh</a>
<a name="ln301">// vim: shiftwidth=2 expandtab tabstop=2 cindent</a>
<a name="ln302">// kate: tab-indents: off; indent-width 2; replace-tabs on; indent-mode cstyle; remove-trailing-spaces modified;</a>

</code></pre>
<div class="balloon" rel="255"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v522/" target="_blank">V522</a> There might be dereferencing of a potential null pointer 'gd'. Check lines: 255, 253.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
