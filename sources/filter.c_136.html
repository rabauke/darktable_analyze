
<html>
<head>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>
<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2">    This file is part of darktable,</a>
<a name="ln3">    copyright (c) 2011 Henrik Andersson.</a>
<a name="ln4"> </a>
<a name="ln5">    darktable is free software: you can redistribute it and/or modify</a>
<a name="ln6">    it under the terms of the GNU General Public License as published by</a>
<a name="ln7">    the Free Software Foundation, either version 3 of the License, or</a>
<a name="ln8">    (at your option) any later version.</a>
<a name="ln9"> </a>
<a name="ln10">    darktable is distributed in the hope that it will be useful,</a>
<a name="ln11">    but WITHOUT ANY WARRANTY; without even the implied warranty of</a>
<a name="ln12">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</a>
<a name="ln13">    GNU General Public License for more details.</a>
<a name="ln14"> </a>
<a name="ln15">    You should have received a copy of the GNU General Public License</a>
<a name="ln16">    along with darktable.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</a>
<a name="ln17">*/</a>
<a name="ln18"> </a>
<a name="ln19">#include &quot;common/collection.h&quot;</a>
<a name="ln20">#include &quot;common/darktable.h&quot;</a>
<a name="ln21">#include &quot;control/conf.h&quot;</a>
<a name="ln22">#include &quot;control/control.h&quot;</a>
<a name="ln23">#include &quot;develop/develop.h&quot;</a>
<a name="ln24">#include &quot;gui/gtk.h&quot;</a>
<a name="ln25">#include &quot;libs/lib.h&quot;</a>
<a name="ln26">#include &quot;libs/lib_api.h&quot;</a>
<a name="ln27"> </a>
<a name="ln28">DT_MODULE(1)</a>
<a name="ln29"> </a>
<a name="ln30">typedef struct dt_lib_tool_filter_t</a>
<a name="ln31">{</a>
<a name="ln32">  GtkWidget *filter;</a>
<a name="ln33">  GtkWidget *comparator;</a>
<a name="ln34">  GtkWidget *sort;</a>
<a name="ln35">  GtkWidget *reverse;</a>
<a name="ln36">} dt_lib_tool_filter_t;</a>
<a name="ln37"> </a>
<a name="ln38">/* proxy function to intelligently reset filter */</a>
<a name="ln39">static void _lib_filter_reset(dt_lib_module_t *self, gboolean smart_filter);</a>
<a name="ln40"> </a>
<a name="ln41">/* callback for filter combobox change */</a>
<a name="ln42">static void _lib_filter_combobox_changed(GtkComboBox *widget, gpointer user_data);</a>
<a name="ln43">/* callback for sort combobox change */</a>
<a name="ln44">static void _lib_filter_sort_combobox_changed(GtkComboBox *widget, gpointer user_data);</a>
<a name="ln45">/* callback for reverse sort check button change */</a>
<a name="ln46">static void _lib_filter_reverse_button_changed(GtkDarktableToggleButton *widget, gpointer user_data);</a>
<a name="ln47">/* callback for rating comparator combobox change */</a>
<a name="ln48">static void _lib_filter_comparator_changed(GtkComboBox *widget, gpointer user_data);</a>
<a name="ln49">/* updates the query and redraws the view */</a>
<a name="ln50">static void _lib_filter_update_query(dt_lib_module_t *self);</a>
<a name="ln51">/* make sure that the comparator button matches what is shown in the filter dropdown */</a>
<a name="ln52">static gboolean _lib_filter_sync_combobox_and_comparator(dt_lib_module_t *self);</a>
<a name="ln53"> </a>
<a name="ln54"> </a>
<a name="ln55">const char *name(dt_lib_module_t *self)</a>
<a name="ln56">{</a>
<a name="ln57">  return _(&quot;filter&quot;);</a>
<a name="ln58">}</a>
<a name="ln59"> </a>
<a name="ln60">const char **views(dt_lib_module_t *self)</a>
<a name="ln61">{</a>
<a name="ln62">  /* for now, show in all view due this affects filmroll too</a>
<a name="ln63"> </a>
<a name="ln64">     TODO: Consider to add flag for all views, which prevents</a>
<a name="ln65">           unloading/loading a module while switching views.</a>
<a name="ln66"> </a>
<a name="ln67">   */</a>
<a name="ln68">  static const char *v[] = {&quot;*&quot;, NULL};</a>
<a name="ln69">  return v;</a>
<a name="ln70">}</a>
<a name="ln71"> </a>
<a name="ln72">uint32_t container(dt_lib_module_t *self)</a>
<a name="ln73">{</a>
<a name="ln74">  return DT_UI_CONTAINER_PANEL_CENTER_TOP_CENTER;</a>
<a name="ln75">}</a>
<a name="ln76"> </a>
<a name="ln77">int expandable(dt_lib_module_t *self)</a>
<a name="ln78">{</a>
<a name="ln79">  return 0;</a>
<a name="ln80">}</a>
<a name="ln81"> </a>
<a name="ln82">int position()</a>
<a name="ln83">{</a>
<a name="ln84">  return 2001;</a>
<a name="ln85">}</a>
<a name="ln86"> </a>
<a name="ln87">void gui_init(dt_lib_module_t *self)</a>
<a name="ln88">{</a>
<a name="ln89">  /* initialize ui widgets */</a>
<a name="ln90">  dt_lib_tool_filter_t *d = (dt_lib_tool_filter_t *)g_malloc0(sizeof(dt_lib_tool_filter_t));</a>
<a name="ln91">  self-&gt;data = (void *)d;</a>
<a name="ln92"> </a>
<a name="ln93">  self-&gt;widget = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 2);</a>
<a name="ln94"> </a>
<a name="ln95">  /**/</a>
<a name="ln96">  GtkWidget *widget;</a>
<a name="ln97"> </a>
<a name="ln98">  /* list label */</a>
<a name="ln99">  widget = gtk_label_new(_(&quot;view&quot;));</a>
<a name="ln100">  gtk_box_pack_start(GTK_BOX(self-&gt;widget), widget, FALSE, FALSE, 4);</a>
<a name="ln101"> </a>
<a name="ln102">  d-&gt;comparator = widget = gtk_combo_box_text_new();</a>
<a name="ln103">  gtk_box_pack_start(GTK_BOX(self-&gt;widget), widget, FALSE, FALSE, 0);</a>
<a name="ln104">  gtk_combo_box_text_append_text(GTK_COMBO_BOX_TEXT(widget), &quot;&lt;&quot;); // DT_COLLECTION_RATING_COMP_LT = 0,</a>
<a name="ln105">  gtk_combo_box_text_append_text(GTK_COMBO_BOX_TEXT(widget), &quot;≤&quot;); // DT_COLLECTION_RATING_COMP_LEQ,</a>
<a name="ln106">  gtk_combo_box_text_append_text(GTK_COMBO_BOX_TEXT(widget), &quot;=&quot;); // DT_COLLECTION_RATING_COMP_EQ,</a>
<a name="ln107">  gtk_combo_box_text_append_text(GTK_COMBO_BOX_TEXT(widget), &quot;≥&quot;); // DT_COLLECTION_RATING_COMP_GEQ,</a>
<a name="ln108">  gtk_combo_box_text_append_text(GTK_COMBO_BOX_TEXT(widget), &quot;&gt;&quot;); // DT_COLLECTION_RATING_COMP_GT,</a>
<a name="ln109">  gtk_combo_box_text_append_text(GTK_COMBO_BOX_TEXT(widget), &quot;≠&quot;); // DT_COLLECTION_RATING_COMP_NE,</a>
<a name="ln110"> </a>
<a name="ln111">  gtk_combo_box_set_active(GTK_COMBO_BOX(widget), dt_collection_get_rating_comparator(darktable.collection));</a>
<a name="ln112">  g_signal_connect(G_OBJECT(widget), &quot;changed&quot;, G_CALLBACK(_lib_filter_comparator_changed), (gpointer)self);</a>
<a name="ln113"> </a>
<a name="ln114">  /* create the filter combobox */</a>
<a name="ln115">  d-&gt;filter = widget = gtk_combo_box_text_new();</a>
<a name="ln116">  gtk_box_pack_start(GTK_BOX(self-&gt;widget), widget, FALSE, FALSE, 0);</a>
<a name="ln117">  gtk_combo_box_text_append_text(GTK_COMBO_BOX_TEXT(widget), _(&quot;all&quot;));</a>
<a name="ln118">  gtk_combo_box_text_append_text(GTK_COMBO_BOX_TEXT(widget), _(&quot;unstarred only&quot;));</a>
<a name="ln119">  gtk_combo_box_text_append_text(GTK_COMBO_BOX_TEXT(widget), &quot;★&quot;);</a>
<a name="ln120">  gtk_combo_box_text_append_text(GTK_COMBO_BOX_TEXT(widget), &quot;★ ★&quot;);</a>
<a name="ln121">  gtk_combo_box_text_append_text(GTK_COMBO_BOX_TEXT(widget), &quot;★ ★ ★&quot;);</a>
<a name="ln122">  gtk_combo_box_text_append_text(GTK_COMBO_BOX_TEXT(widget), &quot;★ ★ ★ ★&quot;);</a>
<a name="ln123">  gtk_combo_box_text_append_text(GTK_COMBO_BOX_TEXT(widget), &quot;★ ★ ★ ★ ★&quot;);</a>
<a name="ln124">  gtk_combo_box_text_append_text(GTK_COMBO_BOX_TEXT(widget), _(&quot;rejected only&quot;));</a>
<a name="ln125">  gtk_combo_box_text_append_text(GTK_COMBO_BOX_TEXT(widget), _(&quot;all except rejected&quot;));</a>
<a name="ln126"> </a>
<a name="ln127">  /* select the last selected value */</a>
<a name="ln128">  gtk_combo_box_set_active(GTK_COMBO_BOX(widget), dt_collection_get_rating(darktable.collection));</a>
<a name="ln129"> </a>
<a name="ln130">  g_signal_connect(G_OBJECT(widget), &quot;changed&quot;, G_CALLBACK(_lib_filter_combobox_changed), (gpointer)self);</a>
<a name="ln131"> </a>
<a name="ln132">  /* sort by label */</a>
<a name="ln133">  widget = gtk_label_new(_(&quot;sort by&quot;));</a>
<a name="ln134">  gtk_box_pack_start(GTK_BOX(self-&gt;widget), widget, FALSE, FALSE, 4);</a>
<a name="ln135"> </a>
<a name="ln136">  /* sort combobox */</a>
<a name="ln137">  d-&gt;sort = widget = gtk_combo_box_text_new();</a>
<a name="ln138">  gtk_box_pack_start(GTK_BOX(self-&gt;widget), widget, FALSE, FALSE, 0);</a>
<a name="ln139">  gtk_combo_box_text_append_text(GTK_COMBO_BOX_TEXT(widget), _(&quot;filename&quot;));     // DT_COLLECTION_SORT_FILENAME</a>
<a name="ln140">  gtk_combo_box_text_append_text(GTK_COMBO_BOX_TEXT(widget), _(&quot;time&quot;));         // DT_COLLECTION_SORT_DATETIME</a>
<a name="ln141">  gtk_combo_box_text_append_text(GTK_COMBO_BOX_TEXT(widget), _(&quot;rating&quot;));       // DT_COLLECTION_SORT_RATING</a>
<a name="ln142">  gtk_combo_box_text_append_text(GTK_COMBO_BOX_TEXT(widget), _(&quot;id&quot;));           // DT_COLLECTION_SORT_ID</a>
<a name="ln143">  gtk_combo_box_text_append_text(GTK_COMBO_BOX_TEXT(widget), _(&quot;color label&quot;));  // DT_COLLECTION_SORT_COLOR</a>
<a name="ln144">  gtk_combo_box_text_append_text(GTK_COMBO_BOX_TEXT(widget), _(&quot;group&quot;));        // DT_COLLECTION_SORT_GROUP</a>
<a name="ln145">  gtk_combo_box_text_append_text(GTK_COMBO_BOX_TEXT(widget), _(&quot;full path&quot;));    // DT_COLLECTION_SORT_PAT</a>
<a name="ln146">  gtk_combo_box_text_append_text(GTK_COMBO_BOX_TEXT(widget), _(&quot;custom sort&quot;));  // DT_COLLECTION_SORT_CUSTOM_ORDER</a>
<a name="ln147">  gtk_combo_box_text_append_text(GTK_COMBO_BOX_TEXT(widget), _(&quot;title&quot;));        // DT_COLLECTION_SORT_TITLE</a>
<a name="ln148">  gtk_combo_box_text_append_text(GTK_COMBO_BOX_TEXT(widget), _(&quot;description&quot;));  // DT_COLLECTION_SORT_DESCRIPTION</a>
<a name="ln149">  gtk_combo_box_text_append_text(GTK_COMBO_BOX_TEXT(widget), _(&quot;aspect ratio&quot;)); // DT_COLLECTION_SORT_ASPECT_RATIO</a>
<a name="ln150">  gtk_combo_box_text_append_text(GTK_COMBO_BOX_TEXT(widget), _(&quot;shuffle&quot;));      // DT_COLLECTION_SORT_SHUFFLE</a>
<a name="ln151"> </a>
<a name="ln152">  /* select the last selected value */</a>
<a name="ln153">  gtk_combo_box_set_active(GTK_COMBO_BOX(widget), dt_collection_get_sort_field(darktable.collection));</a>
<a name="ln154"> </a>
<a name="ln155">  g_signal_connect(G_OBJECT(widget), &quot;changed&quot;, G_CALLBACK(_lib_filter_sort_combobox_changed), (gpointer)self);</a>
<a name="ln156"> </a>
<a name="ln157">  /* reverse order checkbutton */</a>
<a name="ln158">  d-&gt;reverse = widget</a>
<a name="ln159">      = dtgtk_togglebutton_new(dtgtk_cairo_paint_solid_arrow, CPF_DO_NOT_USE_BORDER | CPF_STYLE_BOX | CPF_DIRECTION_UP, NULL);</a>
<a name="ln160">  if(darktable.collection-&gt;params.descending)</a>
<a name="ln161">    dtgtk_togglebutton_set_paint(DTGTK_TOGGLEBUTTON(widget), dtgtk_cairo_paint_solid_arrow,</a>
<a name="ln162">                                 CPF_DO_NOT_USE_BORDER | CPF_STYLE_BOX | CPF_DIRECTION_DOWN, NULL);</a>
<a name="ln163"> </a>
<a name="ln164">  gtk_box_pack_start(GTK_BOX(self-&gt;widget), widget, FALSE, FALSE, 0);</a>
<a name="ln165"> </a>
<a name="ln166">  /* select the last value and connect callback */</a>
<a name="ln167">  gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(widget),</a>
<a name="ln168">                               dt_collection_get_sort_descending(darktable.collection));</a>
<a name="ln169"> </a>
<a name="ln170">  g_signal_connect(G_OBJECT(widget), &quot;toggled&quot;, G_CALLBACK(_lib_filter_reverse_button_changed),</a>
<a name="ln171">                   (gpointer)self);</a>
<a name="ln172"> </a>
<a name="ln173">  /* initialize proxy */</a>
<a name="ln174">  darktable.view_manager-&gt;proxy.filter.module = self;</a>
<a name="ln175">  darktable.view_manager-&gt;proxy.filter.reset_filter = _lib_filter_reset;</a>
<a name="ln176"> </a>
<a name="ln177">  g_signal_connect_swapped(G_OBJECT(d-&gt;comparator), &quot;map&quot;,</a>
<a name="ln178">                           G_CALLBACK(_lib_filter_sync_combobox_and_comparator), self);</a>
<a name="ln179">}</a>
<a name="ln180"> </a>
<a name="ln181">void gui_cleanup(dt_lib_module_t *self)</a>
<a name="ln182">{</a>
<a name="ln183">  g_free(self-&gt;data);</a>
<a name="ln184">  self-&gt;data = NULL;</a>
<a name="ln185">}</a>
<a name="ln186"> </a>
<a name="ln187">// show/hide the comparator dropdown as required</a>
<a name="ln188">static gboolean _lib_filter_sync_combobox_and_comparator(dt_lib_module_t *self)</a>
<a name="ln189">{</a>
<a name="ln190">  dt_lib_tool_filter_t *d = (dt_lib_tool_filter_t *)self-&gt;data;</a>
<a name="ln191">  int filter = gtk_combo_box_get_active(GTK_COMBO_BOX(d-&gt;filter));</a>
<a name="ln192"> </a>
<a name="ln193">  // 0 all</a>
<a name="ln194">  // 1 unstarred only</a>
<a name="ln195">  // 2 ★</a>
<a name="ln196">  // 3 ★ ★</a>
<a name="ln197">  // 4 ★ ★ ★</a>
<a name="ln198">  // 5 ★ ★ ★ ★</a>
<a name="ln199">  // 6 ★ ★ ★ ★ ★</a>
<a name="ln200">  // 7 rejected only</a>
<a name="ln201">  // 8 all except rejected</a>
<a name="ln202"> </a>
<a name="ln203">  if(filter &gt; 1 &amp;&amp; filter &lt; 7)</a>
<a name="ln204">    gtk_widget_show(d-&gt;comparator);</a>
<a name="ln205">  else</a>
<a name="ln206">    gtk_widget_hide(d-&gt;comparator);</a>
<a name="ln207"> </a>
<a name="ln208">  return FALSE;</a>
<a name="ln209">}</a>
<a name="ln210"> </a>
<a name="ln211">static void _lib_filter_combobox_changed(GtkComboBox *widget, gpointer user_data)</a>
<a name="ln212">{</a>
<a name="ln213">  /* update last settings */</a>
<a name="ln214">  int i = gtk_combo_box_get_active(widget);</a>
<a name="ln215"> </a>
<a name="ln216">  /* update collection star filter flags */</a>
<a name="ln217">  if(i == 0) // all</a>
<a name="ln218">    dt_collection_set_filter_flags(darktable.collection,</a>
<a name="ln219">                                   dt_collection_get_filter_flags(darktable.collection)</a>
<a name="ln220">                                   &amp; ~(COLLECTION_FILTER_ATLEAST_RATING | COLLECTION_FILTER_EQUAL_RATING</a>
<a name="ln221">                                       | COLLECTION_FILTER_CUSTOM_COMPARE));</a>
<a name="ln222">  else if(i == 1 || i == 7) // unstarred only || rejected only</a>
<a name="ln223">    dt_collection_set_filter_flags(</a>
<a name="ln224">        darktable.collection,</a>
<a name="ln225">        (dt_collection_get_filter_flags(darktable.collection) | COLLECTION_FILTER_EQUAL_RATING)</a>
<a name="ln226">        &amp; ~(COLLECTION_FILTER_ATLEAST_RATING | COLLECTION_FILTER_CUSTOM_COMPARE));</a>
<a name="ln227">  else if(i == 8) // all except rejected</a>
<a name="ln228">    dt_collection_set_filter_flags(darktable.collection,</a>
<a name="ln229">                                   (dt_collection_get_filter_flags(darktable.collection)</a>
<a name="ln230">                                    | COLLECTION_FILTER_ATLEAST_RATING) &amp; ~COLLECTION_FILTER_CUSTOM_COMPARE);</a>
<a name="ln231">  else // explicit stars</a>
<a name="ln232">    dt_collection_set_filter_flags(darktable.collection, dt_collection_get_filter_flags(darktable.collection)</a>
<a name="ln233">                                                         | COLLECTION_FILTER_CUSTOM_COMPARE);</a>
<a name="ln234"> </a>
<a name="ln235">  /* set the star filter in collection */</a>
<a name="ln236">  dt_collection_set_rating(darktable.collection, i);</a>
<a name="ln237">  dt_control_set_mouse_over_id(-1); // maybe we are storing mouse_over_id (arrows)</a>
<a name="ln238"> </a>
<a name="ln239">  /* update the gui accordingly */</a>
<a name="ln240">  _lib_filter_sync_combobox_and_comparator(user_data);</a>
<a name="ln241"> </a>
<a name="ln242">  /* update the query and view */</a>
<a name="ln243">  _lib_filter_update_query(user_data);</a>
<a name="ln244">}</a>
<a name="ln245"> </a>
<a name="ln246">static void _lib_filter_reverse_button_changed(GtkDarktableToggleButton *widget, gpointer user_data)</a>
<a name="ln247">{</a>
<a name="ln248">  gboolean reverse = gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(widget));</a>
<a name="ln249"> </a>
<a name="ln250">  if(reverse)</a>
<a name="ln251">    dtgtk_togglebutton_set_paint(widget, dtgtk_cairo_paint_solid_arrow, CPF_DO_NOT_USE_BORDER | CPF_STYLE_BOX | CPF_DIRECTION_DOWN, NULL);</a>
<a name="ln252">  else</a>
<a name="ln253">    dtgtk_togglebutton_set_paint(widget, dtgtk_cairo_paint_solid_arrow, CPF_DO_NOT_USE_BORDER | CPF_STYLE_BOX | CPF_DIRECTION_UP, NULL);</a>
<a name="ln254">  gtk_widget_queue_draw(GTK_WIDGET(widget));</a>
<a name="ln255"> </a>
<a name="ln256">  /* update last settings */</a>
<a name="ln257">  dt_collection_set_sort(darktable.collection, -1, reverse);</a>
<a name="ln258"> </a>
<a name="ln259">  /* update query and view */</a>
<a name="ln260">  _lib_filter_update_query(user_data);</a>
<a name="ln261">}</a>
<a name="ln262"> </a>
<a name="ln263">static void _lib_filter_comparator_changed(GtkComboBox *widget, gpointer user_data)</a>
<a name="ln264">{</a>
<a name="ln265">  dt_collection_set_rating_comparator(darktable.collection, gtk_combo_box_get_active(widget));</a>
<a name="ln266"> </a>
<a name="ln267">  _lib_filter_update_query(user_data);</a>
<a name="ln268">}</a>
<a name="ln269"> </a>
<a name="ln270">static void _lib_filter_sort_combobox_changed(GtkComboBox *widget, gpointer user_data)</a>
<a name="ln271">{</a>
<a name="ln272">  /* update the ui last settings */</a>
<a name="ln273">  dt_collection_set_sort(darktable.collection, gtk_combo_box_get_active(widget), -1);</a>
<a name="ln274"> </a>
<a name="ln275">  /* update the query and view */</a>
<a name="ln276">  _lib_filter_update_query(user_data);</a>
<a name="ln277">}</a>
<a name="ln278"> </a>
<a name="ln279">static void _lib_filter_update_query(dt_lib_module_t *self)</a>
<a name="ln280">{</a>
<a name="ln281">  /* sometimes changes */</a>
<a name="ln282">  dt_collection_set_query_flags(darktable.collection, COLLECTION_QUERY_FULL);</a>
<a name="ln283"> </a>
<a name="ln284">  /* updates query */</a>
<a name="ln285">  dt_collection_update_query(darktable.collection);</a>
<a name="ln286"> </a>
<a name="ln287">  /* update film strip, jump to currently opened image, if any: */</a>
<a name="ln288">  dt_view_filmstrip_scroll_to_image(darktable.view_manager, darktable.develop-&gt;image_storage.id, FALSE);</a>
<a name="ln289">}</a>
<a name="ln290"> </a>
<a name="ln291">static void _lib_filter_reset(dt_lib_module_t *self, gboolean smart_filter)</a>
<a name="ln292">{</a>
<a name="ln293">  dt_lib_tool_filter_t *dropdowns = (dt_lib_tool_filter_t *)self-&gt;data;</a>
<a name="ln294"> </a>
<a name="ln295">  if(smart_filter == TRUE)</a>
<a name="ln296">  {</a>
<a name="ln297">    /* initial import rating setting */</a>
<a name="ln298">    int initial_rating = dt_conf_get_int(&quot;ui_last/import_initial_rating&quot;);</a>
<a name="ln299"> </a>
<a name="ln300">    /* current selection in filter dropdown */</a>
<a name="ln301">    int current_filter = gtk_combo_box_get_active(GTK_COMBO_BOX(dropdowns-&gt;filter));</a>
<a name="ln302"> </a>
<a name="ln303">    /* convert filter dropdown to rating: 2-6 is 1-5 stars, for anything else, assume 0 stars */</a>
<a name="ln304">    int current_filter_rating = (current_filter &gt;= 2 &amp;&amp; current_filter &lt;= 6) ? current_filter - 1 : 0;</a>
<a name="ln305"> </a>
<a name="ln306">    /* new filter is the lesser of the initial rating and the current filter rating */</a>
<a name="ln307">    int new_filter_rating = MIN(initial_rating, current_filter_rating);</a>
<a name="ln308"> </a>
<a name="ln309">    /* convert new filter rating to filter dropdown selector */</a>
<a name="ln310">    int new_filter = (new_filter_rating &gt;= 1 &amp;&amp; new_filter_rating &lt;= 5) ? new_filter_rating + 1</a>
<a name="ln311">                                                                        : new_filter_rating;</a>
<a name="ln312"> </a>
<a name="ln313">    /* Reset to new filter dropdown item */</a>
<a name="ln314">    gtk_combo_box_set_active(GTK_COMBO_BOX(dropdowns-&gt;filter), new_filter);</a>
<a name="ln315">  }</a>
<a name="ln316">  else</a>
<a name="ln317">  {</a>
<a name="ln318">    /* Reset to topmost item, 'all' */</a>
<a name="ln319">    gtk_combo_box_set_active(GTK_COMBO_BOX(dropdowns-&gt;filter), 0);</a>
<a name="ln320">  }</a>
<a name="ln321">}</a>
<a name="ln322"> </a>
<a name="ln323">// modelines: These editor modelines have been set for all relevant files by tools/update_modelines.sh</a>
<a name="ln324">// vim: shiftwidth=2 expandtab tabstop=2 cindent</a>
<a name="ln325">// kate: tab-indents: off; indent-width 2; replace-tabs on; indent-mode cstyle; remove-trailing-spaces modified;</a>

</code></pre>
<div class="balloon" rel="310"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v560/" target="_blank">V560</a> A part of conditional expression is always true: new_filter_rating <= 5.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
