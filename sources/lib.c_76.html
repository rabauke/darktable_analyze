
<html>
<head>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>
<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2">    This file is part of darktable,</a>
<a name="ln3">    copyright (c) 2009--2010 johannes hanika.</a>
<a name="ln4">    copyright (c) 2011 Henrik Andersson.</a>
<a name="ln5"> </a>
<a name="ln6">    darktable is free software: you can redistribute it and/or modify</a>
<a name="ln7">    it under the terms of the GNU General Public License as published by</a>
<a name="ln8">    the Free Software Foundation, either version 3 of the License, or</a>
<a name="ln9">    (at your option) any later version.</a>
<a name="ln10"> </a>
<a name="ln11">    darktable is distributed in the hope that it will be useful,</a>
<a name="ln12">    but WITHOUT ANY WARRANTY; without even the implied warranty of</a>
<a name="ln13">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</a>
<a name="ln14">    GNU General Public License for more details.</a>
<a name="ln15"> </a>
<a name="ln16">    You should have received a copy of the GNU General Public License</a>
<a name="ln17">    along with darktable.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</a>
<a name="ln18">*/</a>
<a name="ln19">#include &quot;libs/lib.h&quot;</a>
<a name="ln20">#include &quot;common/debug.h&quot;</a>
<a name="ln21">#include &quot;common/module.h&quot;</a>
<a name="ln22">#include &quot;control/conf.h&quot;</a>
<a name="ln23">#include &quot;control/control.h&quot;</a>
<a name="ln24">#include &quot;dtgtk/button.h&quot;</a>
<a name="ln25">#include &quot;dtgtk/expander.h&quot;</a>
<a name="ln26">#include &quot;dtgtk/icon.h&quot;</a>
<a name="ln27">#include &quot;gui/accelerators.h&quot;</a>
<a name="ln28">#include &quot;gui/gtk.h&quot;</a>
<a name="ln29">#ifdef GDK_WINDOWING_QUARTZ</a>
<a name="ln30">#include &quot;osx/osx.h&quot;</a>
<a name="ln31">#endif</a>
<a name="ln32">#include &lt;stdbool.h&gt;</a>
<a name="ln33">#include &lt;stdlib.h&gt;</a>
<a name="ln34"> </a>
<a name="ln35">typedef struct dt_lib_module_info_t</a>
<a name="ln36">{</a>
<a name="ln37">  char *plugin_name;</a>
<a name="ln38">  int32_t version;</a>
<a name="ln39">  char *params;</a>
<a name="ln40">  int params_size;</a>
<a name="ln41">  dt_lib_module_t *module;</a>
<a name="ln42">} dt_lib_module_info_t;</a>
<a name="ln43"> </a>
<a name="ln44">typedef struct dt_lib_presets_edit_dialog_t</a>
<a name="ln45">{</a>
<a name="ln46">  GtkEntry *name, *description;</a>
<a name="ln47">  char plugin_name[128];</a>
<a name="ln48">  int32_t version;</a>
<a name="ln49">  void *params;</a>
<a name="ln50">  int32_t params_size;</a>
<a name="ln51">  gchar *original_name;</a>
<a name="ln52">  dt_lib_module_t *module;</a>
<a name="ln53">  gint old_id;</a>
<a name="ln54">} dt_lib_presets_edit_dialog_t;</a>
<a name="ln55"> </a>
<a name="ln56">typedef enum dt_module_header_icons_t</a>
<a name="ln57">{</a>
<a name="ln58">  DT_MODULE_ARROW = 0,</a>
<a name="ln59">  DT_MODULE_LABEL,</a>
<a name="ln60">  DT_MODULE_RESET,</a>
<a name="ln61">  DT_MODULE_PRESETS,</a>
<a name="ln62">  DT_MODULE_LAST</a>
<a name="ln63">} dt_module_header_icons_t;</a>
<a name="ln64"> </a>
<a name="ln65"> </a>
<a name="ln66">gboolean dt_lib_is_visible_in_view(dt_lib_module_t *module, const dt_view_t *view)</a>
<a name="ln67">{</a>
<a name="ln68">  if(!module-&gt;views)</a>
<a name="ln69">  {</a>
<a name="ln70">    fprintf(stderr, &quot;module %s doesn't have views flags\n&quot;, module-&gt;name(module));</a>
<a name="ln71">    return FALSE;</a>
<a name="ln72">  }</a>
<a name="ln73"> </a>
<a name="ln74">  const char **views = module-&gt;views(module);</a>
<a name="ln75">  for(const char **iter = views; *iter; iter++)</a>
<a name="ln76">  {</a>
<a name="ln77">    if(!strcmp(*iter, &quot;*&quot;) || !strcmp(*iter, view-&gt;module_name)) return TRUE;</a>
<a name="ln78">  }</a>
<a name="ln79">  return FALSE;</a>
<a name="ln80">}</a>
<a name="ln81"> </a>
<a name="ln82">/** calls module-&gt;cleanup and closes the dl connection. */</a>
<a name="ln83">static void dt_lib_unload_module(dt_lib_module_t *module);</a>
<a name="ln84"> </a>
<a name="ln85">static gchar *get_active_preset_name(dt_lib_module_info_t *minfo)</a>
<a name="ln86">{</a>
<a name="ln87">  sqlite3_stmt *stmt;</a>
<a name="ln88">  DT_DEBUG_SQLITE3_PREPARE_V2(</a>
<a name="ln89">      dt_database_get(darktable.db),</a>
<a name="ln90">      &quot;SELECT name, op_params, writeprotect FROM data.presets WHERE operation=?1 AND op_version=?2&quot;, -1, &amp;stmt,</a>
<a name="ln91">      NULL);</a>
<a name="ln92">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 1, minfo-&gt;plugin_name, -1, SQLITE_TRANSIENT);</a>
<a name="ln93">  DT_DEBUG_SQLITE3_BIND_INT(stmt, 2, minfo-&gt;version);</a>
<a name="ln94">  gchar *name = NULL;</a>
<a name="ln95">  // collect all presets for op from db</a>
<a name="ln96">  while(sqlite3_step(stmt) == SQLITE_ROW)</a>
<a name="ln97">  {</a>
<a name="ln98">    void *op_params = (void *)sqlite3_column_blob(stmt, 1);</a>
<a name="ln99">    int32_t op_params_size = sqlite3_column_bytes(stmt, 1);</a>
<a name="ln100">    if(op_params_size == minfo-&gt;params_size &amp;&amp; !memcmp(minfo-&gt;params, op_params, op_params_size))</a>
<a name="ln101">    {</a>
<a name="ln102">      name = g_strdup((char *)sqlite3_column_text(stmt, 0));</a>
<a name="ln103">      break;</a>
<a name="ln104">    }</a>
<a name="ln105">  }</a>
<a name="ln106">  sqlite3_finalize(stmt);</a>
<a name="ln107">  return name;</a>
<a name="ln108">}</a>
<a name="ln109"> </a>
<a name="ln110">static void edit_preset_response(GtkDialog *dialog, gint response_id, dt_lib_presets_edit_dialog_t *g)</a>
<a name="ln111">{</a>
<a name="ln112">  gint dlg_ret;</a>
<a name="ln113">  gint is_new = 0;</a>
<a name="ln114"> </a>
<a name="ln115">  if(response_id == GTK_RESPONSE_ACCEPT)</a>
<a name="ln116">  {</a>
<a name="ln117">    sqlite3_stmt *stmt;</a>
<a name="ln118"> </a>
<a name="ln119">    // now delete preset, so we can re-insert the new values:</a>
<a name="ln120">    DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln121">                                &quot;DELETE FROM data.presets WHERE name=?1 AND operation=?2 AND op_version=?3&quot;, -1,</a>
<a name="ln122">                                &amp;stmt, NULL);</a>
<a name="ln123">    DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 1, g-&gt;original_name, -1, SQLITE_TRANSIENT);</a>
<a name="ln124">    DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 2, g-&gt;plugin_name, -1, SQLITE_TRANSIENT);</a>
<a name="ln125">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 3, g-&gt;version);</a>
<a name="ln126">    sqlite3_step(stmt);</a>
<a name="ln127">    sqlite3_finalize(stmt);</a>
<a name="ln128"> </a>
<a name="ln129">    const char *name = gtk_entry_get_text(g-&gt;name);</a>
<a name="ln130">    if(((g-&gt;old_id &gt;= 0) &amp;&amp; (strcmp(g-&gt;original_name, name) != 0)) || (g-&gt;old_id &lt; 0))</a>
<a name="ln131">    {</a>
<a name="ln132"> </a>
<a name="ln133">      // editing existing preset with different name or store new preset -&gt; check for a preset with the same</a>
<a name="ln134">      // name:</a>
<a name="ln135"> </a>
<a name="ln136">      DT_DEBUG_SQLITE3_PREPARE_V2(</a>
<a name="ln137">          dt_database_get(darktable.db),</a>
<a name="ln138">          &quot;SELECT name FROM data.presets WHERE name = ?1 AND operation=?2 AND op_version=?3&quot;, -1, &amp;stmt, NULL);</a>
<a name="ln139">      DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 1, name, -1, SQLITE_TRANSIENT);</a>
<a name="ln140">      DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 2, g-&gt;plugin_name, -1, SQLITE_TRANSIENT);</a>
<a name="ln141">      DT_DEBUG_SQLITE3_BIND_INT(stmt, 3, g-&gt;version);</a>
<a name="ln142"> </a>
<a name="ln143">      if(sqlite3_step(stmt) == SQLITE_ROW)</a>
<a name="ln144">      {</a>
<a name="ln145">        sqlite3_finalize(stmt);</a>
<a name="ln146"> </a>
<a name="ln147">        GtkWidget *window = dt_ui_main_window(darktable.gui-&gt;ui);</a>
<a name="ln148">        GtkWidget *dlg_overwrite = gtk_message_dialog_new(</a>
<a name="ln149">            GTK_WINDOW(window), GTK_DIALOG_DESTROY_WITH_PARENT, GTK_MESSAGE_WARNING, GTK_BUTTONS_YES_NO,</a>
<a name="ln150">            _(&quot;preset `%s' already exists.\ndo you want to overwrite?&quot;), name);</a>
<a name="ln151">#ifdef GDK_WINDOWING_QUARTZ</a>
<a name="ln152">        dt_osx_disallow_fullscreen(dlg_overwrite);</a>
<a name="ln153">#endif</a>
<a name="ln154">        gtk_window_set_title(GTK_WINDOW(dlg_overwrite), _(&quot;overwrite preset?&quot;));</a>
<a name="ln155">        dlg_ret = gtk_dialog_run(GTK_DIALOG(dlg_overwrite));</a>
<a name="ln156">        gtk_widget_destroy(dlg_overwrite);</a>
<a name="ln157"> </a>
<a name="ln158">        // if result is BUTTON_NO exit without destroy dialog, to permit other name</a>
<a name="ln159">        if(dlg_ret == GTK_RESPONSE_NO) return;</a>
<a name="ln160">      }</a>
<a name="ln161">      else</a>
<a name="ln162">      {</a>
<a name="ln163">        is_new = 1;</a>
<a name="ln164">        sqlite3_finalize(stmt);</a>
<a name="ln165">      }</a>
<a name="ln166">    }</a>
<a name="ln167"> </a>
<a name="ln168">    if(is_new == 0)</a>
<a name="ln169">    {</a>
<a name="ln170">      // delete preset, so we can re-insert the new values:</a>
<a name="ln171">      DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln172">                                  &quot;DELETE FROM data.presets WHERE name=?1 AND operation=?2 AND op_version=?3&quot;, -1,</a>
<a name="ln173">                                  &amp;stmt, NULL);</a>
<a name="ln174">      DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 1, name, -1, SQLITE_TRANSIENT);</a>
<a name="ln175">      DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 2, g-&gt;plugin_name, -1, SQLITE_TRANSIENT);</a>
<a name="ln176">      DT_DEBUG_SQLITE3_BIND_INT(stmt, 3, g-&gt;version);</a>
<a name="ln177">      sqlite3_step(stmt);</a>
<a name="ln178">      sqlite3_finalize(stmt);</a>
<a name="ln179">    }</a>
<a name="ln180"> </a>
<a name="ln181"> </a>
<a name="ln182">    // commit all the user input fields</a>
<a name="ln183">    char path[1024];</a>
<a name="ln184">    snprintf(path, sizeof(path), &quot;preset/%s&quot;, g-&gt;original_name);</a>
<a name="ln185">    dt_accel_rename_preset_lib(g-&gt;module, path, name);</a>
<a name="ln186">    DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln187">                                &quot;INSERT INTO data.presets (name, description, operation, op_version, op_params, &quot;</a>
<a name="ln188">                                &quot;blendop_params, blendop_version, enabled, model, maker, lens, &quot;</a>
<a name="ln189">                                &quot;iso_min, iso_max, exposure_min, exposure_max, aperture_min, aperture_max, &quot;</a>
<a name="ln190">                                &quot;focal_length_min, focal_length_max, writeprotect, &quot;</a>
<a name="ln191">                                &quot;autoapply, filter, def, format) VALUES (?1, ?2, ?3, ?4, ?5, NULL, 0, 1, &quot;</a>
<a name="ln192">                                &quot;'%', '%', '%', 0, 340282346638528859812000000000000000000, 0, 100000000, 0, &quot;</a>
<a name="ln193">                                &quot;100000000, 0, 1000, 0, 0, 0, 0, &quot;</a>
<a name="ln194">                                &quot;0)&quot;,</a>
<a name="ln195">                                -1, &amp;stmt, NULL);</a>
<a name="ln196">    DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 1, name, -1, SQLITE_TRANSIENT);</a>
<a name="ln197">    DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 2, gtk_entry_get_text(g-&gt;description), -1, SQLITE_TRANSIENT);</a>
<a name="ln198">    DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 3, g-&gt;plugin_name, -1, SQLITE_TRANSIENT);</a>
<a name="ln199">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 4, g-&gt;version);</a>
<a name="ln200">    DT_DEBUG_SQLITE3_BIND_BLOB(stmt, 5, g-&gt;params, g-&gt;params_size, SQLITE_TRANSIENT);</a>
<a name="ln201">    sqlite3_step(stmt);</a>
<a name="ln202">    sqlite3_finalize(stmt);</a>
<a name="ln203"> </a>
<a name="ln204">    dt_gui_store_last_preset(name);</a>
<a name="ln205">  }</a>
<a name="ln206">  gtk_widget_destroy(GTK_WIDGET(dialog));</a>
<a name="ln207">  g_free(g-&gt;original_name);</a>
<a name="ln208">  free(g);</a>
<a name="ln209">}</a>
<a name="ln210"> </a>
<a name="ln211">static void edit_preset(const char *name_in, dt_lib_module_info_t *minfo)</a>
<a name="ln212">{</a>
<a name="ln213">  gchar *name = NULL;</a>
<a name="ln214">  if(name_in == NULL)</a>
<a name="ln215">  {</a>
<a name="ln216">    name = get_active_preset_name(minfo);</a>
<a name="ln217">    if(name == NULL) return;</a>
<a name="ln218">  }</a>
<a name="ln219">  else</a>
<a name="ln220">    name = g_strdup(name_in);</a>
<a name="ln221"> </a>
<a name="ln222">  GtkWidget *dialog;</a>
<a name="ln223">  /* Create the widgets */</a>
<a name="ln224">  char title[1024];</a>
<a name="ln225">  GtkWidget *window = dt_ui_main_window(darktable.gui-&gt;ui);</a>
<a name="ln226">  snprintf(title, sizeof(title), _(&quot;edit `%s'&quot;), name);</a>
<a name="ln227">  dialog = gtk_dialog_new_with_buttons(title, GTK_WINDOW(window), GTK_DIALOG_DESTROY_WITH_PARENT, _(&quot;_ok&quot;),</a>
<a name="ln228">                                       GTK_RESPONSE_ACCEPT, _(&quot;_cancel&quot;), GTK_RESPONSE_REJECT, NULL);</a>
<a name="ln229">#ifdef GDK_WINDOWING_QUARTZ</a>
<a name="ln230">  dt_osx_disallow_fullscreen(dialog);</a>
<a name="ln231">#endif</a>
<a name="ln232">  GtkContainer *content_area = GTK_CONTAINER(gtk_dialog_get_content_area(GTK_DIALOG(dialog)));</a>
<a name="ln233">  GtkBox *box = GTK_BOX(gtk_box_new(GTK_ORIENTATION_VERTICAL, 0));</a>
<a name="ln234">  gtk_container_add(content_area, GTK_WIDGET(box));</a>
<a name="ln235"> </a>
<a name="ln236">  dt_lib_presets_edit_dialog_t *g</a>
<a name="ln237">      = (dt_lib_presets_edit_dialog_t *)g_malloc0(sizeof(dt_lib_presets_edit_dialog_t));</a>
<a name="ln238">  g-&gt;old_id = -1;</a>
<a name="ln239">  g_strlcpy(g-&gt;plugin_name, minfo-&gt;plugin_name, sizeof(g-&gt;plugin_name));</a>
<a name="ln240">  g-&gt;version = minfo-&gt;version;</a>
<a name="ln241">  g-&gt;params_size = minfo-&gt;params_size;</a>
<a name="ln242">  g-&gt;params = minfo-&gt;params;</a>
<a name="ln243">  g-&gt;name = GTK_ENTRY(gtk_entry_new());</a>
<a name="ln244">  g-&gt;module = minfo-&gt;module;</a>
<a name="ln245">  g-&gt;original_name = name;</a>
<a name="ln246">  gtk_entry_set_text(g-&gt;name, name);</a>
<a name="ln247">  gtk_box_pack_start(box, GTK_WIDGET(g-&gt;name), FALSE, FALSE, 0);</a>
<a name="ln248">  gtk_widget_set_tooltip_text(GTK_WIDGET(g-&gt;name), _(&quot;name of the preset&quot;));</a>
<a name="ln249"> </a>
<a name="ln250">  g-&gt;description = GTK_ENTRY(gtk_entry_new());</a>
<a name="ln251">  gtk_box_pack_start(box, GTK_WIDGET(g-&gt;description), FALSE, FALSE, 0);</a>
<a name="ln252">  gtk_widget_set_tooltip_text(GTK_WIDGET(g-&gt;description), _(&quot;description or further information&quot;));</a>
<a name="ln253"> </a>
<a name="ln254">  sqlite3_stmt *stmt;</a>
<a name="ln255">  DT_DEBUG_SQLITE3_PREPARE_V2(</a>
<a name="ln256">      dt_database_get(darktable.db),</a>
<a name="ln257">      &quot;SELECT rowid, description FROM data.presets WHERE name = ?1 AND operation = ?2 AND op_version = ?3&quot;, -1,</a>
<a name="ln258">      &amp;stmt, NULL);</a>
<a name="ln259">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 1, name, -1, SQLITE_TRANSIENT);</a>
<a name="ln260">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 2, minfo-&gt;plugin_name, -1, SQLITE_TRANSIENT);</a>
<a name="ln261">  DT_DEBUG_SQLITE3_BIND_INT(stmt, 3, minfo-&gt;version);</a>
<a name="ln262">  if(sqlite3_step(stmt) == SQLITE_ROW)</a>
<a name="ln263">  {</a>
<a name="ln264">    g-&gt;old_id = sqlite3_column_int(stmt, 0);</a>
<a name="ln265">    gtk_entry_set_text(g-&gt;description, (const char *)sqlite3_column_text(stmt, 1));</a>
<a name="ln266">  }</a>
<a name="ln267">  sqlite3_finalize(stmt);</a>
<a name="ln268"> </a>
<a name="ln269">  g_signal_connect(dialog, &quot;response&quot;, G_CALLBACK(edit_preset_response), g);</a>
<a name="ln270">  gtk_widget_show_all(dialog);</a>
<a name="ln271">}</a>
<a name="ln272"> </a>
<a name="ln273">static void menuitem_update_preset(GtkMenuItem *menuitem, dt_lib_module_info_t *minfo)</a>
<a name="ln274">{</a>
<a name="ln275">  char *name = g_object_get_data(G_OBJECT(menuitem), &quot;dt-preset-name&quot;);</a>
<a name="ln276"> </a>
<a name="ln277">  // commit all the module fields</a>
<a name="ln278">  sqlite3_stmt *stmt;</a>
<a name="ln279">  DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln280">                              &quot;UPDATE data.presets SET operation=?1, op_version=?2, op_params=?3 WHERE name=?4&quot;,</a>
<a name="ln281">                              -1, &amp;stmt, NULL);</a>
<a name="ln282"> </a>
<a name="ln283">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 1, minfo-&gt;plugin_name, -1, SQLITE_TRANSIENT);</a>
<a name="ln284">  DT_DEBUG_SQLITE3_BIND_INT(stmt, 2, minfo-&gt;version);</a>
<a name="ln285">  DT_DEBUG_SQLITE3_BIND_BLOB(stmt, 3, minfo-&gt;params, minfo-&gt;params_size, SQLITE_TRANSIENT);</a>
<a name="ln286">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 4, name, -1, SQLITE_TRANSIENT);</a>
<a name="ln287">  sqlite3_step(stmt);</a>
<a name="ln288">  sqlite3_finalize(stmt);</a>
<a name="ln289">}</a>
<a name="ln290"> </a>
<a name="ln291">static void menuitem_new_preset(GtkMenuItem *menuitem, dt_lib_module_info_t *minfo)</a>
<a name="ln292">{</a>
<a name="ln293">  // add new preset</a>
<a name="ln294">  sqlite3_stmt *stmt;</a>
<a name="ln295">  DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln296">                              &quot;DELETE FROM data.presets WHERE name=?1 AND operation=?2 AND op_version=?3&quot;, -1,</a>
<a name="ln297">                              &amp;stmt, NULL);</a>
<a name="ln298">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 1, _(&quot;new preset&quot;), -1, SQLITE_STATIC);</a>
<a name="ln299">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 2, minfo-&gt;plugin_name, -1, SQLITE_TRANSIENT);</a>
<a name="ln300">  DT_DEBUG_SQLITE3_BIND_INT(stmt, 3, minfo-&gt;version);</a>
<a name="ln301">  sqlite3_step(stmt);</a>
<a name="ln302">  sqlite3_finalize(stmt);</a>
<a name="ln303">  DT_DEBUG_SQLITE3_PREPARE_V2(</a>
<a name="ln304">      dt_database_get(darktable.db),</a>
<a name="ln305">      &quot;INSERT INTO data.presets (name, description, operation, op_version, op_params, &quot;</a>
<a name="ln306">      &quot;blendop_params, blendop_version, enabled, model, maker, lens, &quot;</a>
<a name="ln307">      &quot;iso_min, iso_max, exposure_min, exposure_max, aperture_min, aperture_max, &quot;</a>
<a name="ln308">      &quot;focal_length_min, focal_length_max, writeprotect, &quot;</a>
<a name="ln309">      &quot;autoapply, filter, def, format) VALUES (?1, '', ?2, ?3, ?4, NULL, 0, 1, '%', &quot;</a>
<a name="ln310">      &quot;'%', '%', 0, 340282346638528859812000000000000000000, 0, 100000000, 0, 100000000, 0, 1000, 0, 0, 0, 0, 0)&quot;,</a>
<a name="ln311">      -1, &amp;stmt, NULL);</a>
<a name="ln312">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 1, _(&quot;new preset&quot;), -1, SQLITE_STATIC);</a>
<a name="ln313">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 2, minfo-&gt;plugin_name, -1, SQLITE_TRANSIENT);</a>
<a name="ln314">  DT_DEBUG_SQLITE3_BIND_INT(stmt, 3, minfo-&gt;version);</a>
<a name="ln315">  DT_DEBUG_SQLITE3_BIND_BLOB(stmt, 4, minfo-&gt;params, minfo-&gt;params_size, SQLITE_TRANSIENT);</a>
<a name="ln316">  sqlite3_step(stmt);</a>
<a name="ln317">  sqlite3_finalize(stmt);</a>
<a name="ln318">  // create a shortcut for the new entry</a>
<a name="ln319">  char path[1024];</a>
<a name="ln320">  snprintf(path, sizeof(path), &quot;%s/%s&quot;, _(&quot;preset&quot;), _(&quot;new preset&quot;));</a>
<a name="ln321">  dt_accel_register_lib(minfo-&gt;module, path, 0, 0);</a>
<a name="ln322">  dt_accel_connect_preset_lib(minfo-&gt;module, _(&quot;new preset&quot;));</a>
<a name="ln323">  // then show edit dialog</a>
<a name="ln324">  edit_preset(_(&quot;new preset&quot;), minfo);</a>
<a name="ln325">}</a>
<a name="ln326"> </a>
<a name="ln327">static void menuitem_edit_preset(GtkMenuItem *menuitem, dt_lib_module_info_t *minfo)</a>
<a name="ln328">{</a>
<a name="ln329">  edit_preset(NULL, minfo);</a>
<a name="ln330">}</a>
<a name="ln331"> </a>
<a name="ln332">static void menuitem_delete_preset(GtkMenuItem *menuitem, dt_lib_module_info_t *minfo)</a>
<a name="ln333">{</a>
<a name="ln334">  sqlite3_stmt *stmt;</a>
<a name="ln335">  gchar *name = get_active_preset_name(minfo);</a>
<a name="ln336">  if(name == NULL) return;</a>
<a name="ln337">  GtkWidget *window = dt_ui_main_window(darktable.gui-&gt;ui);</a>
<a name="ln338">  GtkWidget *dialog</a>
<a name="ln339">      = gtk_message_dialog_new(GTK_WINDOW(window), GTK_DIALOG_DESTROY_WITH_PARENT, GTK_MESSAGE_QUESTION,</a>
<a name="ln340">                               GTK_BUTTONS_YES_NO, _(&quot;do you really want to delete the preset `%s'?&quot;), name);</a>
<a name="ln341">#ifdef GDK_WINDOWING_QUARTZ</a>
<a name="ln342">  dt_osx_disallow_fullscreen(dialog);</a>
<a name="ln343">#endif</a>
<a name="ln344">  gtk_window_set_title(GTK_WINDOW(dialog), _(&quot;delete preset?&quot;));</a>
<a name="ln345">  if(gtk_dialog_run(GTK_DIALOG(dialog)) == GTK_RESPONSE_YES)</a>
<a name="ln346">  {</a>
<a name="ln347">    char tmp_path[1024];</a>
<a name="ln348">    snprintf(tmp_path, sizeof(tmp_path), &quot;%s/%s&quot;, _(&quot;preset&quot;), name);</a>
<a name="ln349">    dt_accel_deregister_lib(minfo-&gt;module, tmp_path);</a>
<a name="ln350">    DT_DEBUG_SQLITE3_PREPARE_V2(</a>
<a name="ln351">        dt_database_get(darktable.db),</a>
<a name="ln352">        &quot;DELETE FROM data.presets WHERE name=?1 AND operation=?2 AND op_version=?3 AND writeprotect=0&quot;, -1, &amp;stmt,</a>
<a name="ln353">        NULL);</a>
<a name="ln354">    DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 1, name, -1, SQLITE_TRANSIENT);</a>
<a name="ln355">    DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 2, minfo-&gt;plugin_name, -1, SQLITE_TRANSIENT);</a>
<a name="ln356">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 3, minfo-&gt;version);</a>
<a name="ln357">    sqlite3_step(stmt);</a>
<a name="ln358">    sqlite3_finalize(stmt);</a>
<a name="ln359">  }</a>
<a name="ln360">  g_free(name);</a>
<a name="ln361">  gtk_widget_destroy(dialog);</a>
<a name="ln362">}</a>
<a name="ln363"> </a>
<a name="ln364">static void pick_callback(GtkMenuItem *menuitem, dt_lib_module_info_t *minfo)</a>
<a name="ln365">{</a>
<a name="ln366">  // apply preset via set_params</a>
<a name="ln367">  char *pn = g_object_get_data(G_OBJECT(menuitem), &quot;dt-preset-name&quot;);</a>
<a name="ln368">  sqlite3_stmt *stmt;</a>
<a name="ln369">  DT_DEBUG_SQLITE3_PREPARE_V2(</a>
<a name="ln370">      dt_database_get(darktable.db),</a>
<a name="ln371">      &quot;SELECT op_params, writeprotect FROM data.presets WHERE operation = ?1 AND op_version = ?2 AND name = ?3&quot;,</a>
<a name="ln372">      -1, &amp;stmt, NULL);</a>
<a name="ln373">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 1, minfo-&gt;plugin_name, -1, SQLITE_TRANSIENT);</a>
<a name="ln374">  DT_DEBUG_SQLITE3_BIND_INT(stmt, 2, minfo-&gt;version);</a>
<a name="ln375">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 3, pn, -1, SQLITE_TRANSIENT);</a>
<a name="ln376"> </a>
<a name="ln377">  int res = 0;</a>
<a name="ln378">  if(sqlite3_step(stmt) == SQLITE_ROW)</a>
<a name="ln379">  {</a>
<a name="ln380">    const void *blob = sqlite3_column_blob(stmt, 0);</a>
<a name="ln381">    int length = sqlite3_column_bytes(stmt, 0);</a>
<a name="ln382">    int writeprotect = sqlite3_column_int(stmt, 1);</a>
<a name="ln383">    if(blob)</a>
<a name="ln384">    {</a>
<a name="ln385">      GList *it = darktable.lib-&gt;plugins;</a>
<a name="ln386">      while(it)</a>
<a name="ln387">      {</a>
<a name="ln388">        dt_lib_module_t *module = (dt_lib_module_t *)it-&gt;data;</a>
<a name="ln389">        if(!strncmp(module-&gt;plugin_name, minfo-&gt;plugin_name, 128))</a>
<a name="ln390">        {</a>
<a name="ln391">          res = module-&gt;set_params(module, blob, length);</a>
<a name="ln392">          break;</a>
<a name="ln393">        }</a>
<a name="ln394">        it = g_list_next(it);</a>
<a name="ln395">      }</a>
<a name="ln396">    }</a>
<a name="ln397"> </a>
<a name="ln398">    if(!writeprotect) dt_gui_store_last_preset(pn);</a>
<a name="ln399">  }</a>
<a name="ln400">  sqlite3_finalize(stmt);</a>
<a name="ln401">  if(res)</a>
<a name="ln402">  {</a>
<a name="ln403">    dt_control_log(_(&quot;deleting preset for obsolete module&quot;));</a>
<a name="ln404">    DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln405">                                &quot;DELETE FROM data.presets WHERE operation = ?1 AND op_version = ?2 AND name = ?3&quot;,</a>
<a name="ln406">                                -1, &amp;stmt, NULL);</a>
<a name="ln407">    DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 1, minfo-&gt;plugin_name, -1, SQLITE_TRANSIENT);</a>
<a name="ln408">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 2, minfo-&gt;version);</a>
<a name="ln409">    DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 3, pn, -1, SQLITE_TRANSIENT);</a>
<a name="ln410">    sqlite3_step(stmt);</a>
<a name="ln411">    sqlite3_finalize(stmt);</a>
<a name="ln412">  }</a>
<a name="ln413">}</a>
<a name="ln414"> </a>
<a name="ln415">static void free_module_info(GtkWidget *widget, gpointer user_data)</a>
<a name="ln416">{</a>
<a name="ln417">  dt_lib_module_info_t *minfo = (dt_lib_module_info_t *)user_data;</a>
<a name="ln418">  g_free(minfo-&gt;plugin_name);</a>
<a name="ln419">  free(minfo-&gt;params);</a>
<a name="ln420">  free(minfo);</a>
<a name="ln421">}</a>
<a name="ln422"> </a>
<a name="ln423">static void dt_lib_presets_popup_menu_show(dt_lib_module_info_t *minfo)</a>
<a name="ln424">{</a>
<a name="ln425">  GtkMenu *menu = darktable.gui-&gt;presets_popup_menu;</a>
<a name="ln426">  if(menu) gtk_widget_destroy(GTK_WIDGET(menu));</a>
<a name="ln427">  darktable.gui-&gt;presets_popup_menu = GTK_MENU(gtk_menu_new());</a>
<a name="ln428">  menu = darktable.gui-&gt;presets_popup_menu;</a>
<a name="ln429"> </a>
<a name="ln430">  g_signal_connect(G_OBJECT(menu), &quot;destroy&quot;, G_CALLBACK(free_module_info), minfo);</a>
<a name="ln431"> </a>
<a name="ln432">  GtkWidget *mi;</a>
<a name="ln433">  int active_preset = -1, cnt = 0, writeprotect = 0;</a>
<a name="ln434">  sqlite3_stmt *stmt;</a>
<a name="ln435">  // order: get shipped defaults first</a>
<a name="ln436">  DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln437">                              &quot;SELECT name, op_params, writeprotect, description FROM data.presets WHERE &quot;</a>
<a name="ln438">                              &quot;operation=?1 AND op_version=?2 ORDER BY writeprotect DESC, name, rowid&quot;,</a>
<a name="ln439">                              -1, &amp;stmt, NULL);</a>
<a name="ln440">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 1, minfo-&gt;plugin_name, -1, SQLITE_TRANSIENT);</a>
<a name="ln441">  DT_DEBUG_SQLITE3_BIND_INT(stmt, 2, minfo-&gt;version);</a>
<a name="ln442"> </a>
<a name="ln443">  // collect all presets for op from db</a>
<a name="ln444">  int found = 0;</a>
<a name="ln445">  while(sqlite3_step(stmt) == SQLITE_ROW)</a>
<a name="ln446">  {</a>
<a name="ln447">    void *op_params = (void *)sqlite3_column_blob(stmt, 1);</a>
<a name="ln448">    int32_t op_params_size = sqlite3_column_bytes(stmt, 1);</a>
<a name="ln449">    const char *name = (char *)sqlite3_column_text(stmt, 0);</a>
<a name="ln450"> </a>
<a name="ln451">    if(darktable.gui-&gt;last_preset &amp;&amp; strcmp(darktable.gui-&gt;last_preset, name) == 0) found = 1;</a>
<a name="ln452"> </a>
<a name="ln453">    // selected in bold:</a>
<a name="ln454">    // printf(&quot;comparing %d bytes to %d\n&quot;, op_params_size, minfo-&gt;params_size);</a>
<a name="ln455">    // for(int k=0;k&lt;op_params_size &amp;&amp; !memcmp(minfo-&gt;params, op_params, k);k++) printf(&quot;compare [%c %c] %d:</a>
<a name="ln456">    // %d\n&quot;,</a>
<a name="ln457">    // ((const char*)(minfo-&gt;params))[k],</a>
<a name="ln458">    // ((const char*)(op_params))[k],</a>
<a name="ln459">    // k, memcmp(minfo-&gt;params, op_params, k));</a>
<a name="ln460">    if(op_params_size == minfo-&gt;params_size &amp;&amp; !memcmp(minfo-&gt;params, op_params, op_params_size))</a>
<a name="ln461">    {</a>
<a name="ln462">      active_preset = cnt;</a>
<a name="ln463">      writeprotect = sqlite3_column_int(stmt, 2);</a>
<a name="ln464">      char *markup;</a>
<a name="ln465">      mi = gtk_menu_item_new_with_label(&quot;&quot;);</a>
<a name="ln466">      markup = g_markup_printf_escaped(&quot;&lt;span weight=\&quot;bold\&quot;&gt;%s&lt;/span&gt;&quot;, name);</a>
<a name="ln467">      gtk_label_set_markup(GTK_LABEL(gtk_bin_get_child(GTK_BIN(mi))), markup);</a>
<a name="ln468">      g_free(markup);</a>
<a name="ln469">    }</a>
<a name="ln470">    else</a>
<a name="ln471">    {</a>
<a name="ln472">      mi = gtk_menu_item_new_with_label((const char *)name);</a>
<a name="ln473">    }</a>
<a name="ln474">    g_object_set_data_full(G_OBJECT(mi), &quot;dt-preset-name&quot;, g_strdup(name), g_free);</a>
<a name="ln475">    g_signal_connect(G_OBJECT(mi), &quot;activate&quot;, G_CALLBACK(pick_callback), minfo);</a>
<a name="ln476">    gtk_widget_set_tooltip_text(mi, (const char *)sqlite3_column_text(stmt, 3));</a>
<a name="ln477">    gtk_menu_shell_append(GTK_MENU_SHELL(menu), mi);</a>
<a name="ln478">    cnt++;</a>
<a name="ln479">  }</a>
<a name="ln480">  sqlite3_finalize(stmt);</a>
<a name="ln481"> </a>
<a name="ln482">  if(cnt &gt; 0) gtk_menu_shell_append(GTK_MENU_SHELL(menu), gtk_separator_menu_item_new());</a>
<a name="ln483"> </a>
<a name="ln484">  // FIXME: this doesn't seem to work.</a>
<a name="ln485">  if(active_preset &gt;= 0)</a>
<a name="ln486">  {</a>
<a name="ln487">    if(!writeprotect)</a>
<a name="ln488">    {</a>
<a name="ln489">      mi = gtk_menu_item_new_with_label(_(&quot;edit this preset..&quot;));</a>
<a name="ln490">      g_signal_connect(G_OBJECT(mi), &quot;activate&quot;, G_CALLBACK(menuitem_edit_preset), minfo);</a>
<a name="ln491">      gtk_menu_shell_append(GTK_MENU_SHELL(menu), mi);</a>
<a name="ln492"> </a>
<a name="ln493">      mi = gtk_menu_item_new_with_label(_(&quot;delete this preset&quot;));</a>
<a name="ln494">      g_signal_connect(G_OBJECT(mi), &quot;activate&quot;, G_CALLBACK(menuitem_delete_preset), minfo);</a>
<a name="ln495">      gtk_menu_shell_append(GTK_MENU_SHELL(menu), mi);</a>
<a name="ln496">    }</a>
<a name="ln497">  }</a>
<a name="ln498">  else</a>
<a name="ln499">  {</a>
<a name="ln500">    mi = gtk_menu_item_new_with_label(_(&quot;store new preset..&quot;));</a>
<a name="ln501">    if(minfo-&gt;params_size == 0)</a>
<a name="ln502">    {</a>
<a name="ln503">      gtk_widget_set_sensitive(mi, FALSE);</a>
<a name="ln504">      gtk_widget_set_tooltip_text(mi, _(&quot;nothing to save&quot;));</a>
<a name="ln505">    }</a>
<a name="ln506">    else</a>
<a name="ln507">      g_signal_connect(G_OBJECT(mi), &quot;activate&quot;, G_CALLBACK(menuitem_new_preset), minfo);</a>
<a name="ln508">    gtk_menu_shell_append(GTK_MENU_SHELL(menu), mi);</a>
<a name="ln509"> </a>
<a name="ln510">    if(darktable.gui-&gt;last_preset &amp;&amp; found)</a>
<a name="ln511">    {</a>
<a name="ln512">      char *markup = g_markup_printf_escaped(&quot;%s &lt;span weight=\&quot;bold\&quot;&gt;%s&lt;/span&gt;&quot;, _(&quot;update preset&quot;),</a>
<a name="ln513">                                             darktable.gui-&gt;last_preset);</a>
<a name="ln514">      mi = gtk_menu_item_new_with_label(&quot;&quot;);</a>
<a name="ln515">      gtk_widget_set_sensitive(mi, minfo-&gt;params_size &gt; 0);</a>
<a name="ln516">      gtk_label_set_markup(GTK_LABEL(gtk_bin_get_child(GTK_BIN(mi))), markup);</a>
<a name="ln517">      g_object_set_data_full(G_OBJECT(mi), &quot;dt-preset-name&quot;, g_strdup(darktable.gui-&gt;last_preset), g_free);</a>
<a name="ln518">      g_signal_connect(G_OBJECT(mi), &quot;activate&quot;, G_CALLBACK(menuitem_update_preset), minfo);</a>
<a name="ln519">      gtk_menu_shell_append(GTK_MENU_SHELL(menu), mi);</a>
<a name="ln520">      g_free(markup);</a>
<a name="ln521">    }</a>
<a name="ln522">  }</a>
<a name="ln523">}</a>
<a name="ln524"> </a>
<a name="ln525">gint dt_lib_sort_plugins(gconstpointer a, gconstpointer b)</a>
<a name="ln526">{</a>
<a name="ln527">  const dt_lib_module_t *am = (const dt_lib_module_t *)a;</a>
<a name="ln528">  const dt_lib_module_t *bm = (const dt_lib_module_t *)b;</a>
<a name="ln529">  const int apos = am-&gt;position ? am-&gt;position(am) : 0;</a>
<a name="ln530">  const int bpos = bm-&gt;position ? bm-&gt;position(bm) : 0;</a>
<a name="ln531">  return apos - bpos;</a>
<a name="ln532">}</a>
<a name="ln533"> </a>
<a name="ln534">/* default expandable implementation */</a>
<a name="ln535">static int _lib_default_expandable(dt_lib_module_t *self)</a>
<a name="ln536">{</a>
<a name="ln537">  return 1;</a>
<a name="ln538">}</a>
<a name="ln539"> </a>
<a name="ln540">static int dt_lib_load_module(void *m, const char *libname, const char *plugin_name)</a>
<a name="ln541">{</a>
<a name="ln542">  dt_lib_module_t *module = (dt_lib_module_t *)m;</a>
<a name="ln543">  module-&gt;dt = &amp;darktable;</a>
<a name="ln544">  module-&gt;widget = NULL;</a>
<a name="ln545">  module-&gt;expander = NULL;</a>
<a name="ln546">  g_strlcpy(module-&gt;plugin_name, plugin_name, sizeof(module-&gt;plugin_name));</a>
<a name="ln547">  dt_print(DT_DEBUG_CONTROL, &quot;[lib_load_module] loading lib `%s' from %s\n&quot;, plugin_name, libname);</a>
<a name="ln548">  module-&gt;module = g_module_open(libname, G_MODULE_BIND_LAZY | G_MODULE_BIND_LOCAL);</a>
<a name="ln549">  if(!module-&gt;module) goto error;</a>
<a name="ln550">  int (*version)();</a>
<a name="ln551">  if(!g_module_symbol(module-&gt;module, &quot;dt_module_dt_version&quot;, (gpointer) &amp; (version))) goto error;</a>
<a name="ln552">  if(version() != dt_version())</a>
<a name="ln553">  {</a>
<a name="ln554">    fprintf(stderr,</a>
<a name="ln555">            &quot;[lib_load_module] `%s' is compiled for another version of dt (module %d (%s) != dt %d (%s)) !\n&quot;,</a>
<a name="ln556">            libname, abs(version()), version() &lt; 0 ? &quot;debug&quot; : &quot;opt&quot;, abs(dt_version()),</a>
<a name="ln557">            dt_version() &lt; 0 ? &quot;debug&quot; : &quot;opt&quot;);</a>
<a name="ln558">    goto error;</a>
<a name="ln559">  }</a>
<a name="ln560">  if(!g_module_symbol(module-&gt;module, &quot;dt_module_mod_version&quot;, (gpointer) &amp; (module-&gt;version))) goto error;</a>
<a name="ln561">  if(!g_module_symbol(module-&gt;module, &quot;name&quot;, (gpointer) &amp; (module-&gt;name))) goto error;</a>
<a name="ln562">  if(!g_module_symbol(module-&gt;module, &quot;views&quot;, (gpointer) &amp; (module-&gt;views))) goto error;</a>
<a name="ln563">  if(!g_module_symbol(module-&gt;module, &quot;container&quot;, (gpointer) &amp; (module-&gt;container))) goto error;</a>
<a name="ln564">  if(!g_module_symbol(module-&gt;module, &quot;expandable&quot;, (gpointer) &amp; (module-&gt;expandable)))</a>
<a name="ln565">    module-&gt;expandable = _lib_default_expandable;</a>
<a name="ln566">  if(!g_module_symbol(module-&gt;module, &quot;init&quot;, (gpointer) &amp; (module-&gt;init))) module-&gt;init = NULL;</a>
<a name="ln567"> </a>
<a name="ln568">  if(!g_module_symbol(module-&gt;module, &quot;gui_reset&quot;, (gpointer) &amp; (module-&gt;gui_reset)))</a>
<a name="ln569">    module-&gt;gui_reset = NULL;</a>
<a name="ln570">  if(!g_module_symbol(module-&gt;module, &quot;gui_init&quot;, (gpointer) &amp; (module-&gt;gui_init))) goto error;</a>
<a name="ln571">  if(!g_module_symbol(module-&gt;module, &quot;gui_cleanup&quot;, (gpointer) &amp; (module-&gt;gui_cleanup))) goto error;</a>
<a name="ln572"> </a>
<a name="ln573">  if(!g_module_symbol(module-&gt;module, &quot;gui_post_expose&quot;, (gpointer) &amp; (module-&gt;gui_post_expose)))</a>
<a name="ln574">    module-&gt;gui_post_expose = NULL;</a>
<a name="ln575"> </a>
<a name="ln576">  if(!g_module_symbol(module-&gt;module, &quot;view_enter&quot;, (gpointer) &amp; (module-&gt;view_enter))) module-&gt;view_enter = NULL;</a>
<a name="ln577">  if(!g_module_symbol(module-&gt;module, &quot;view_leave&quot;, (gpointer) &amp; (module-&gt;view_leave))) module-&gt;view_leave = NULL;</a>
<a name="ln578"> </a>
<a name="ln579">  if(!g_module_symbol(module-&gt;module, &quot;mouse_leave&quot;, (gpointer) &amp; (module-&gt;mouse_leave)))</a>
<a name="ln580">    module-&gt;mouse_leave = NULL;</a>
<a name="ln581">  if(!g_module_symbol(module-&gt;module, &quot;mouse_moved&quot;, (gpointer) &amp; (module-&gt;mouse_moved)))</a>
<a name="ln582">    module-&gt;mouse_moved = NULL;</a>
<a name="ln583">  if(!g_module_symbol(module-&gt;module, &quot;button_released&quot;, (gpointer) &amp; (module-&gt;button_released)))</a>
<a name="ln584">    module-&gt;button_released = NULL;</a>
<a name="ln585">  if(!g_module_symbol(module-&gt;module, &quot;button_pressed&quot;, (gpointer) &amp; (module-&gt;button_pressed)))</a>
<a name="ln586">    module-&gt;button_pressed = NULL;</a>
<a name="ln587">  if(!g_module_symbol(module-&gt;module, &quot;configure&quot;, (gpointer) &amp; (module-&gt;configure)))</a>
<a name="ln588">    module-&gt;configure = NULL;</a>
<a name="ln589">  if(!g_module_symbol(module-&gt;module, &quot;scrolled&quot;, (gpointer) &amp; (module-&gt;scrolled))) module-&gt;scrolled = NULL;</a>
<a name="ln590">  if(!g_module_symbol(module-&gt;module, &quot;position&quot;, (gpointer) &amp; (module-&gt;position))) module-&gt;position = NULL;</a>
<a name="ln591">  if(!g_module_symbol(module-&gt;module, &quot;legacy_params&quot;, (gpointer) &amp; (module-&gt;legacy_params)))</a>
<a name="ln592">    module-&gt;legacy_params = NULL;</a>
<a name="ln593">  if((!g_module_symbol(module-&gt;module, &quot;get_params&quot;, (gpointer) &amp; (module-&gt;get_params)))</a>
<a name="ln594">     || (!g_module_symbol(module-&gt;module, &quot;set_params&quot;, (gpointer) &amp; (module-&gt;set_params)))</a>
<a name="ln595">     || (!g_module_symbol(module-&gt;module, &quot;init_presets&quot;, (gpointer) &amp; (module-&gt;init_presets))))</a>
<a name="ln596">  {</a>
<a name="ln597">    // need all at the same time, or none.</a>
<a name="ln598">    module-&gt;legacy_params = NULL;</a>
<a name="ln599">    module-&gt;set_params = NULL;</a>
<a name="ln600">    module-&gt;get_params = NULL;</a>
<a name="ln601">    module-&gt;init_presets = NULL;</a>
<a name="ln602">  }</a>
<a name="ln603">  if(!g_module_symbol(module-&gt;module, &quot;init_key_accels&quot;, (gpointer) &amp; (module-&gt;init_key_accels)))</a>
<a name="ln604">    module-&gt;init_key_accels = NULL;</a>
<a name="ln605">  if(!g_module_symbol(module-&gt;module, &quot;connect_key_accels&quot;, (gpointer) &amp; (module-&gt;connect_key_accels)))</a>
<a name="ln606">    module-&gt;connect_key_accels = NULL;</a>
<a name="ln607"> </a>
<a name="ln608">  module-&gt;accel_closures = NULL;</a>
<a name="ln609">  module-&gt;reset_button = NULL;</a>
<a name="ln610">  module-&gt;presets_button = NULL;</a>
<a name="ln611"> </a>
<a name="ln612">  if(module-&gt;gui_reset)</a>
<a name="ln613">  {</a>
<a name="ln614">    dt_accel_register_lib(module, NC_(&quot;accel&quot;, &quot;reset module parameters&quot;), 0, 0);</a>
<a name="ln615">  }</a>
<a name="ln616">  if(module-&gt;get_params)</a>
<a name="ln617">  {</a>
<a name="ln618">    dt_accel_register_lib(module, NC_(&quot;accel&quot;, &quot;show preset menu&quot;), 0, 0);</a>
<a name="ln619">  }</a>
<a name="ln620">#ifdef USE_LUA</a>
<a name="ln621">  dt_lua_lib_register(darktable.lua_state.state, module);</a>
<a name="ln622">#endif</a>
<a name="ln623">  if(module-&gt;init) module-&gt;init(module);</a>
<a name="ln624"> </a>
<a name="ln625">  return 0;</a>
<a name="ln626">error:</a>
<a name="ln627">  fprintf(stderr, &quot;[lib_load_module] failed to open operation `%s': %s\n&quot;, plugin_name, g_module_error());</a>
<a name="ln628">  if(module-&gt;module) g_module_close(module-&gt;module);</a>
<a name="ln629">  return 1;</a>
<a name="ln630">}</a>
<a name="ln631"> </a>
<a name="ln632">static void *_update_params(dt_lib_module_t *module,</a>
<a name="ln633">                            const void *const old_params, size_t old_params_size, int old_version,</a>
<a name="ln634">                            int target_version, size_t *new_size)</a>
<a name="ln635">{</a>
<a name="ln636">  // make a copy of the old params so we can free it in the loop</a>
<a name="ln637">  void *params = malloc(old_params_size);</a>
<a name="ln638">  if(params == NULL) return NULL;</a>
<a name="ln639">  memcpy(params, old_params, old_params_size);</a>
<a name="ln640">  while(old_version &lt; target_version)</a>
<a name="ln641">  {</a>
<a name="ln642">    size_t size;</a>
<a name="ln643">    int version;</a>
<a name="ln644">    void *new_params = module-&gt;legacy_params(module, params, old_params_size, old_version, &amp;version, &amp;size);</a>
<a name="ln645">    free(params);</a>
<a name="ln646">    if(new_params == NULL) return NULL;</a>
<a name="ln647">    params = new_params;</a>
<a name="ln648">    old_version = version;</a>
<a name="ln649">    old_params_size = size;</a>
<a name="ln650">  }</a>
<a name="ln651">  *new_size = old_params_size;</a>
<a name="ln652">  return params;</a>
<a name="ln653">}</a>
<a name="ln654"> </a>
<a name="ln655">void dt_lib_init_presets(dt_lib_module_t *module)</a>
<a name="ln656">{</a>
<a name="ln657">  // since lighttable presets can't end up in styles or any other place outside of the presets table it is</a>
<a name="ln658">  // sufficient</a>
<a name="ln659">  // to update that very table here and assume that everything is up to date elsewhere.</a>
<a name="ln660">  // the intended logic is as follows:</a>
<a name="ln661">  // - no set_params -&gt; delete all presets</a>
<a name="ln662">  // - op_version &gt;= module_version -&gt; done</a>
<a name="ln663">  // - op_version &lt; module_version -&gt;</a>
<a name="ln664">  //   - module has legacy_params -&gt; try to update</a>
<a name="ln665">  //   - module doesn't have legacy_params -&gt; delete it</a>
<a name="ln666"> </a>
<a name="ln667">  if(module-&gt;set_params == NULL)</a>
<a name="ln668">  {</a>
<a name="ln669">    sqlite3_stmt *stmt;</a>
<a name="ln670">    DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), &quot;DELETE FROM data.presets WHERE operation=?1&quot;, -1,</a>
<a name="ln671">                                &amp;stmt, NULL);</a>
<a name="ln672">    DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 1, module-&gt;plugin_name, -1, SQLITE_TRANSIENT);</a>
<a name="ln673">    sqlite3_step(stmt);</a>
<a name="ln674">    sqlite3_finalize(stmt);</a>
<a name="ln675">  }</a>
<a name="ln676">  else</a>
<a name="ln677">  {</a>
<a name="ln678">    sqlite3_stmt *stmt;</a>
<a name="ln679">    DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln680">                                &quot;SELECT rowid, op_version, op_params, name FROM data.presets WHERE operation=?1&quot;,</a>
<a name="ln681">                                -1, &amp;stmt, NULL);</a>
<a name="ln682">    DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 1, module-&gt;plugin_name, -1, SQLITE_TRANSIENT);</a>
<a name="ln683">    while(sqlite3_step(stmt) == SQLITE_ROW)</a>
<a name="ln684">    {</a>
<a name="ln685">      int rowid = sqlite3_column_int(stmt, 0);</a>
<a name="ln686">      int op_version = sqlite3_column_int(stmt, 1);</a>
<a name="ln687">      void *op_params = (void *)sqlite3_column_blob(stmt, 2);</a>
<a name="ln688">      size_t op_params_size = sqlite3_column_bytes(stmt, 2);</a>
<a name="ln689">      const char *name = (char *)sqlite3_column_text(stmt, 3);</a>
<a name="ln690"> </a>
<a name="ln691">      int version = module-&gt;version(module);</a>
<a name="ln692"> </a>
<a name="ln693">      if(op_version &lt; version)</a>
<a name="ln694">      {</a>
<a name="ln695">        size_t new_params_size = 0;</a>
<a name="ln696">        void *new_params = NULL;</a>
<a name="ln697"> </a>
<a name="ln698">        if(module-&gt;legacy_params</a>
<a name="ln699">          &amp;&amp; (new_params = _update_params(module, op_params, op_params_size, op_version, version, &amp;new_params_size)))</a>
<a name="ln700">        {</a>
<a name="ln701">          // write the updated preset back to db</a>
<a name="ln702">          fprintf(stderr,</a>
<a name="ln703">                  &quot;[lighttable_init_presets] updating '%s' preset '%s' from version %d to version %d\n&quot;,</a>
<a name="ln704">                  module-&gt;plugin_name, name, op_version, version);</a>
<a name="ln705">          sqlite3_stmt *innerstmt;</a>
<a name="ln706">          DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln707">                                      &quot;UPDATE data.presets SET op_version=?1, op_params=?2 WHERE rowid=?3&quot;, -1,</a>
<a name="ln708">                                      &amp;innerstmt, NULL);</a>
<a name="ln709">          DT_DEBUG_SQLITE3_BIND_INT(innerstmt, 1, version);</a>
<a name="ln710">          DT_DEBUG_SQLITE3_BIND_BLOB(innerstmt, 2, new_params, new_params_size, SQLITE_TRANSIENT);</a>
<a name="ln711">          DT_DEBUG_SQLITE3_BIND_INT(innerstmt, 3, rowid);</a>
<a name="ln712">          sqlite3_step(innerstmt);</a>
<a name="ln713">          sqlite3_finalize(innerstmt);</a>
<a name="ln714">        }</a>
<a name="ln715">        else</a>
<a name="ln716">        {</a>
<a name="ln717">          // delete the preset</a>
<a name="ln718">          fprintf(stderr, &quot;[lighttable_init_presets] Can't upgrade '%s' preset '%s' from version %d to %d, &quot;</a>
<a name="ln719">                          &quot;no legacy_params() implemented or unable to update\n&quot;,</a>
<a name="ln720">                  module-&gt;plugin_name, name, op_version, version);</a>
<a name="ln721">          sqlite3_stmt *innerstmt;</a>
<a name="ln722">          DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), &quot;DELETE FROM data.presets WHERE rowid=?1&quot;, -1,</a>
<a name="ln723">                                      &amp;innerstmt, NULL);</a>
<a name="ln724">          DT_DEBUG_SQLITE3_BIND_INT(innerstmt, 1, rowid);</a>
<a name="ln725">          sqlite3_step(innerstmt);</a>
<a name="ln726">          sqlite3_finalize(innerstmt);</a>
<a name="ln727">        }</a>
<a name="ln728">        free(new_params);</a>
<a name="ln729">      }</a>
<a name="ln730">    }</a>
<a name="ln731">    sqlite3_finalize(stmt);</a>
<a name="ln732">  }</a>
<a name="ln733"> </a>
<a name="ln734">  if(module-&gt;init_presets) module-&gt;init_presets(module);</a>
<a name="ln735">}</a>
<a name="ln736"> </a>
<a name="ln737">static void dt_lib_init_module(void *m)</a>
<a name="ln738">{</a>
<a name="ln739">  dt_lib_module_t *module = (dt_lib_module_t *)m;</a>
<a name="ln740">  dt_lib_init_presets(module);</a>
<a name="ln741">  // Calling the keyboard shortcut initialization callback if present</a>
<a name="ln742">  // do not init accelerators if there is no gui</a>
<a name="ln743">  if(darktable.gui)</a>
<a name="ln744">  {</a>
<a name="ln745">    if(module-&gt;init_key_accels) module-&gt;init_key_accels(module);</a>
<a name="ln746">    module-&gt;gui_init(module);</a>
<a name="ln747">    g_object_ref_sink(module-&gt;widget);</a>
<a name="ln748">  }</a>
<a name="ln749">}</a>
<a name="ln750"> </a>
<a name="ln751">void dt_lib_unload_module(dt_lib_module_t *module)</a>
<a name="ln752">{</a>
<a name="ln753">  if(module-&gt;module) g_module_close(module-&gt;module);</a>
<a name="ln754">}</a>
<a name="ln755"> </a>
<a name="ln756">static void dt_lib_gui_reset_callback(GtkButton *button, gpointer user_data)</a>
<a name="ln757">{</a>
<a name="ln758">  dt_lib_module_t *module = (dt_lib_module_t *)user_data;</a>
<a name="ln759">  module-&gt;gui_reset(module);</a>
<a name="ln760">}</a>
<a name="ln761"> </a>
<a name="ln762">#if !GTK_CHECK_VERSION(3, 22, 0)</a>
<a name="ln763">static void _preset_popup_posistion(GtkMenu *menu, gint *x, gint *y, gboolean *push_in, gpointer data)</a>
<a name="ln764">{</a>
<a name="ln765">  gint w;</a>
<a name="ln766">  gint ww;</a>
<a name="ln767">  GtkRequisition requisition = { 0 };</a>
<a name="ln768"> </a>
<a name="ln769">  w = gdk_window_get_width(gtk_widget_get_window(GTK_WIDGET(data)));</a>
<a name="ln770">  ww = gdk_window_get_width(gtk_widget_get_window(dt_ui_main_window(darktable.gui-&gt;ui)));</a>
<a name="ln771"> </a>
<a name="ln772">  gdk_window_get_origin(gtk_widget_get_window(GTK_WIDGET(data)), x, y);</a>
<a name="ln773"> </a>
<a name="ln774">  gtk_widget_get_preferred_size(GTK_WIDGET(menu), &amp;requisition, NULL);</a>
<a name="ln775"> </a>
<a name="ln776">  /* align left panel popupmenu to right edge */</a>
<a name="ln777">  if(*x &lt; ww / 2) (*x) += w - requisition.width;</a>
<a name="ln778"> </a>
<a name="ln779">  GtkAllocation allocation_data;</a>
<a name="ln780">  gtk_widget_get_allocation(GTK_WIDGET(data), &amp;allocation_data);</a>
<a name="ln781">  (*y) += allocation_data.height;</a>
<a name="ln782">}</a>
<a name="ln783">#endif</a>
<a name="ln784"> </a>
<a name="ln785">static void popup_callback(GtkButton *button, GdkEventButton *event, dt_lib_module_t *module)</a>
<a name="ln786">{</a>
<a name="ln787">  if(event-&gt;button != 1 &amp;&amp; event-&gt;button != 2) return;</a>
<a name="ln788"> </a>
<a name="ln789">  dt_lib_module_info_t *mi = (dt_lib_module_info_t *)calloc(1, sizeof(dt_lib_module_info_t));</a>
<a name="ln790"> </a>
<a name="ln791">  mi-&gt;plugin_name = g_strdup(module-&gt;plugin_name);</a>
<a name="ln792">  mi-&gt;version = module-&gt;version(module);</a>
<a name="ln793">  mi-&gt;module = module;</a>
<a name="ln794">  mi-&gt;params = module-&gt;get_params(module, &amp;mi-&gt;params_size);</a>
<a name="ln795"> </a>
<a name="ln796">  if(!mi-&gt;params)</a>
<a name="ln797">  {</a>
<a name="ln798">    // this is a valid case, for example in location.c when nothing got selected</a>
<a name="ln799">    // fprintf(stderr, &quot;something went wrong: &amp;params=%p, size=%i\n&quot;, mi-&gt;params, mi-&gt;params_size);</a>
<a name="ln800">    mi-&gt;params_size = 0;</a>
<a name="ln801">  }</a>
<a name="ln802">  dt_lib_presets_popup_menu_show(mi);</a>
<a name="ln803"> </a>
<a name="ln804">  gtk_widget_show_all(GTK_WIDGET(darktable.gui-&gt;presets_popup_menu));</a>
<a name="ln805"> </a>
<a name="ln806">#if GTK_CHECK_VERSION(3, 22, 0)</a>
<a name="ln807">  GdkGravity widget_gravity, menu_gravity;</a>
<a name="ln808">  widget_gravity = GDK_GRAVITY_SOUTH_EAST;</a>
<a name="ln809">  menu_gravity = GDK_GRAVITY_NORTH_EAST;</a>
<a name="ln810"> </a>
<a name="ln811">  gtk_menu_popup_at_widget(darktable.gui-&gt;presets_popup_menu,</a>
<a name="ln812">                           dtgtk_expander_get_header(DTGTK_EXPANDER(module-&gt;expander)), widget_gravity,</a>
<a name="ln813">                           menu_gravity, NULL);</a>
<a name="ln814">#else</a>
<a name="ln815">  gtk_menu_popup(darktable.gui-&gt;presets_popup_menu, NULL, NULL, _preset_popup_posistion, button, 0,</a>
<a name="ln816">                 gtk_get_current_event_time());</a>
<a name="ln817">  gtk_menu_reposition(GTK_MENU(darktable.gui-&gt;presets_popup_menu));</a>
<a name="ln818">#endif</a>
<a name="ln819"> </a>
<a name="ln820">  dtgtk_button_set_active(DTGTK_BUTTON(button), FALSE);</a>
<a name="ln821">}</a>
<a name="ln822"> </a>
<a name="ln823"> </a>
<a name="ln824">void dt_lib_gui_set_expanded(dt_lib_module_t *module, gboolean expanded)</a>
<a name="ln825">{</a>
<a name="ln826">  if(!module-&gt;expander) return;</a>
<a name="ln827"> </a>
<a name="ln828">  dtgtk_expander_set_expanded(DTGTK_EXPANDER(module-&gt;expander), expanded);</a>
<a name="ln829"> </a>
<a name="ln830">  /* update expander arrow state */</a>
<a name="ln831">  GtkDarktableButton *icon;</a>
<a name="ln832">  GtkWidget *header = dtgtk_expander_get_header(DTGTK_EXPANDER(module-&gt;expander));</a>
<a name="ln833">  gint flags = CPF_DIRECTION_DOWN | CPF_BG_TRANSPARENT | CPF_STYLE_FLAT;</a>
<a name="ln834"> </a>
<a name="ln835">  GList *header_childs = gtk_container_get_children(GTK_CONTAINER(header));</a>
<a name="ln836">  icon = g_list_nth_data(header_childs, DT_MODULE_ARROW);</a>
<a name="ln837">  if(!expanded) flags = CPF_DIRECTION_RIGHT | CPF_BG_TRANSPARENT | CPF_STYLE_FLAT;</a>
<a name="ln838">  g_list_free(header_childs);</a>
<a name="ln839">  dtgtk_button_set_paint(icon, dtgtk_cairo_paint_solid_arrow, flags, NULL);</a>
<a name="ln840"> </a>
<a name="ln841">  /* show / hide plugin widget */</a>
<a name="ln842">  if(expanded)</a>
<a name="ln843">  {</a>
<a name="ln844">    /* register to receive draw events */</a>
<a name="ln845">    darktable.lib-&gt;gui_module = module;</a>
<a name="ln846"> </a>
<a name="ln847">    if(dt_conf_get_bool(&quot;darkroom/ui/scroll_to_module&quot;))</a>
<a name="ln848">      darktable.gui-&gt;scroll_to[1] = module-&gt;expander;</a>
<a name="ln849">  }</a>
<a name="ln850">  else</a>
<a name="ln851">  {</a>
<a name="ln852">    if(darktable.lib-&gt;gui_module == module)</a>
<a name="ln853">    {</a>
<a name="ln854">      darktable.lib-&gt;gui_module = NULL;</a>
<a name="ln855"> </a>
<a name="ln856">      dt_control_queue_redraw();</a>
<a name="ln857">    }</a>
<a name="ln858">  }</a>
<a name="ln859"> </a>
<a name="ln860">  /* store expanded state of module */</a>
<a name="ln861">  char var[1024];</a>
<a name="ln862">  const dt_view_t *current_view = dt_view_manager_get_current_view(darktable.view_manager);</a>
<a name="ln863">  snprintf(var, sizeof(var), &quot;plugins/%s/%s/expanded&quot;, current_view-&gt;module_name, module-&gt;plugin_name);</a>
<a name="ln864">  dt_conf_set_bool(var, expanded);</a>
<a name="ln865">}</a>
<a name="ln866"> </a>
<a name="ln867">gboolean dt_lib_gui_get_expanded(dt_lib_module_t *module)</a>
<a name="ln868">{</a>
<a name="ln869">  if(!module-&gt;expandable(module)) return true;</a>
<a name="ln870">  if(!module-&gt;expander) return true;</a>
<a name="ln871">  if(!module-&gt;widget)</a>
<a name="ln872">  {</a>
<a name="ln873">    char var[1024];</a>
<a name="ln874">    const dt_view_t *current_view = dt_view_manager_get_current_view(darktable.view_manager);</a>
<a name="ln875">    snprintf(var, sizeof(var), &quot;plugins/%s/%s/expanded&quot;, current_view-&gt;module_name, module-&gt;plugin_name);</a>
<a name="ln876">    return dt_conf_get_bool(var);</a>
<a name="ln877">  }</a>
<a name="ln878">  return dtgtk_expander_get_expanded(DTGTK_EXPANDER(module-&gt;expander));</a>
<a name="ln879">}</a>
<a name="ln880"> </a>
<a name="ln881">static gboolean _lib_plugin_header_button_press(GtkWidget *w, GdkEventButton *e, gpointer user_data)</a>
<a name="ln882">{</a>
<a name="ln883">  if(e-&gt;type == GDK_2BUTTON_PRESS || e-&gt;type == GDK_3BUTTON_PRESS) return TRUE;</a>
<a name="ln884"> </a>
<a name="ln885">  dt_lib_module_t *module = (dt_lib_module_t *)user_data;</a>
<a name="ln886"> </a>
<a name="ln887">  if(e-&gt;button == 1)</a>
<a name="ln888">  {</a>
<a name="ln889">    /* bail out if module is static */</a>
<a name="ln890">    if(!module-&gt;expandable(module)) return FALSE;</a>
<a name="ln891"> </a>
<a name="ln892">    // make gtk scroll to the module once it updated its allocation size</a>
<a name="ln893">    uint32_t container = module-&gt;container(module);</a>
<a name="ln894">    if(dt_conf_get_bool(&quot;lighttable/ui/scroll_to_module&quot;))</a>
<a name="ln895">    {</a>
<a name="ln896">      if(container == DT_UI_CONTAINER_PANEL_LEFT_CENTER)</a>
<a name="ln897">        darktable.gui-&gt;scroll_to[0] = module-&gt;expander;</a>
<a name="ln898">      else if(container == DT_UI_CONTAINER_PANEL_RIGHT_CENTER)</a>
<a name="ln899">        darktable.gui-&gt;scroll_to[1] = module-&gt;expander;</a>
<a name="ln900">    }</a>
<a name="ln901"> </a>
<a name="ln902">    /* handle shiftclick on expander, hide all except this */</a>
<a name="ln903">    if(!dt_conf_get_bool(&quot;lighttable/ui/single_module&quot;) != !(e-&gt;state &amp; GDK_SHIFT_MASK))</a>
<a name="ln904">    {</a>
<a name="ln905">      GList *it = g_list_first(darktable.lib-&gt;plugins);</a>
<a name="ln906">      const dt_view_t *v = dt_view_manager_get_current_view(darktable.view_manager);</a>
<a name="ln907">      gboolean all_other_closed = TRUE;</a>
<a name="ln908">      while(it)</a>
<a name="ln909">      {</a>
<a name="ln910">        dt_lib_module_t *m = (dt_lib_module_t *)it-&gt;data;</a>
<a name="ln911"> </a>
<a name="ln912">        if(m != module &amp;&amp; container == m-&gt;container(m) &amp;&amp; m-&gt;expandable(m) &amp;&amp; dt_lib_is_visible_in_view(m, v))</a>
<a name="ln913">        {</a>
<a name="ln914">          all_other_closed = all_other_closed &amp;&amp; !dtgtk_expander_get_expanded(DTGTK_EXPANDER(m-&gt;expander));</a>
<a name="ln915">          dt_lib_gui_set_expanded(m, FALSE);</a>
<a name="ln916">        }</a>
<a name="ln917"> </a>
<a name="ln918">        it = g_list_next(it);</a>
<a name="ln919">      }</a>
<a name="ln920">      if(all_other_closed)</a>
<a name="ln921">        dt_lib_gui_set_expanded(module, !dtgtk_expander_get_expanded(DTGTK_EXPANDER(module-&gt;expander)));</a>
<a name="ln922">      else</a>
<a name="ln923">        dt_lib_gui_set_expanded(module, TRUE);</a>
<a name="ln924">    }</a>
<a name="ln925">    else</a>
<a name="ln926">    {</a>
<a name="ln927">      /* else just toggle */</a>
<a name="ln928">      dt_lib_gui_set_expanded(module, !dtgtk_expander_get_expanded(DTGTK_EXPANDER(module-&gt;expander)));</a>
<a name="ln929">    }</a>
<a name="ln930"> </a>
<a name="ln931">    return TRUE;</a>
<a name="ln932">  }</a>
<a name="ln933">  else if(e-&gt;button == 2)</a>
<a name="ln934">  {</a>
<a name="ln935">    /* show preset popup if any preset for module */</a>
<a name="ln936"> </a>
<a name="ln937">    return TRUE;</a>
<a name="ln938">  }</a>
<a name="ln939">  return FALSE;</a>
<a name="ln940">}</a>
<a name="ln941"> </a>
<a name="ln942">GtkWidget *dt_lib_gui_get_expander(dt_lib_module_t *module)</a>
<a name="ln943">{</a>
<a name="ln944">  /* check if module is expandable */</a>
<a name="ln945">  if(!module-&gt;expandable(module))</a>
<a name="ln946">  {</a>
<a name="ln947">    module-&gt;expander = NULL;</a>
<a name="ln948">    return NULL;</a>
<a name="ln949">  }</a>
<a name="ln950"> </a>
<a name="ln951">  GtkWidget *header = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0);</a>
<a name="ln952">  gtk_widget_set_name(GTK_WIDGET(header), &quot;module-header&quot;);</a>
<a name="ln953"> </a>
<a name="ln954">  GtkWidget *expander = dtgtk_expander_new(header, module-&gt;widget);</a>
<a name="ln955">  GtkWidget *header_evb = dtgtk_expander_get_header_event_box(DTGTK_EXPANDER(expander));</a>
<a name="ln956">  GtkWidget *pluginui_frame = dtgtk_expander_get_frame(DTGTK_EXPANDER(expander));</a>
<a name="ln957"> </a>
<a name="ln958">  /* setup the header box */</a>
<a name="ln959">  g_signal_connect(G_OBJECT(header_evb), &quot;button-press-event&quot;, G_CALLBACK(_lib_plugin_header_button_press),</a>
<a name="ln960">                   module);</a>
<a name="ln961"> </a>
<a name="ln962">  /*</a>
<a name="ln963">   * initialize the header widgets</a>
<a name="ln964">   */</a>
<a name="ln965">  GtkWidget *hw[DT_MODULE_LAST] = { NULL };</a>
<a name="ln966"> </a>
<a name="ln967">  /* add the expand indicator icon */</a>
<a name="ln968">  hw[DT_MODULE_ARROW] = dtgtk_button_new(dtgtk_cairo_paint_solid_arrow, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln969">  gtk_widget_set_name(GTK_WIDGET(hw[DT_MODULE_ARROW]), &quot;module-collapse-button&quot;);</a>
<a name="ln970">  g_signal_connect(G_OBJECT(hw[DT_MODULE_ARROW]), &quot;button-press-event&quot;, G_CALLBACK(_lib_plugin_header_button_press),</a>
<a name="ln971">                   module);</a>
<a name="ln972"> </a>
<a name="ln973"> </a>
<a name="ln974">  /* add module label */</a>
<a name="ln975">  hw[DT_MODULE_LABEL] = gtk_label_new(&quot;&quot;);</a>
<a name="ln976">  gtk_label_set_markup(GTK_LABEL(hw[DT_MODULE_LABEL]), module-&gt;name(module));</a>
<a name="ln977">  gtk_widget_set_tooltip_text(hw[DT_MODULE_LABEL], module-&gt;name(module));</a>
<a name="ln978">  gtk_label_set_ellipsize(GTK_LABEL(hw[DT_MODULE_LABEL]), PANGO_ELLIPSIZE_MIDDLE);</a>
<a name="ln979">  gtk_widget_set_name(hw[DT_MODULE_LABEL], &quot;lib-panel-label&quot;);</a>
<a name="ln980"> </a>
<a name="ln981">  /* add reset button if module has implementation */</a>
<a name="ln982">  hw[DT_MODULE_RESET] = dtgtk_button_new(dtgtk_cairo_paint_reset, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln983">  module-&gt;reset_button = GTK_WIDGET(hw[DT_MODULE_RESET]);</a>
<a name="ln984">  gtk_widget_set_tooltip_text(hw[DT_MODULE_RESET], _(&quot;reset parameters&quot;));</a>
<a name="ln985">  g_signal_connect(G_OBJECT(hw[DT_MODULE_RESET]), &quot;clicked&quot;, G_CALLBACK(dt_lib_gui_reset_callback), module);</a>
<a name="ln986"> </a>
<a name="ln987">  if(!module-&gt;gui_reset) gtk_widget_set_sensitive(GTK_WIDGET(hw[DT_MODULE_RESET]), FALSE);</a>
<a name="ln988">  gtk_widget_set_name(GTK_WIDGET(hw[DT_MODULE_RESET]), &quot;module-reset-button&quot;);</a>
<a name="ln989"> </a>
<a name="ln990">  /* add preset button if module has implementation */</a>
<a name="ln991">  hw[DT_MODULE_PRESETS] = dtgtk_button_new(dtgtk_cairo_paint_presets, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln992">  module-&gt;presets_button = GTK_WIDGET(hw[DT_MODULE_PRESETS]);</a>
<a name="ln993">  gtk_widget_set_tooltip_text(hw[DT_MODULE_PRESETS], _(&quot;presets&quot;));</a>
<a name="ln994">  g_signal_connect(G_OBJECT(hw[DT_MODULE_PRESETS]), &quot;button-press-event&quot;, G_CALLBACK(popup_callback), module);</a>
<a name="ln995"> </a>
<a name="ln996">  if(!module-&gt;get_params) gtk_widget_set_sensitive(GTK_WIDGET(hw[DT_MODULE_PRESETS]), FALSE);</a>
<a name="ln997">  gtk_widget_set_name(GTK_WIDGET(hw[DT_MODULE_PRESETS]), &quot;module-preset-button&quot;);</a>
<a name="ln998"> </a>
<a name="ln999">  /* lets order header elements depending on left/right side panel placement */</a>
<a name="ln1000"> </a>
<a name="ln1001">  for(int i = 0; i &lt; DT_MODULE_LAST; i++)</a>
<a name="ln1002">    if(hw[i]) gtk_box_pack_start(GTK_BOX(header), hw[i], i == DT_MODULE_LABEL ? TRUE : FALSE, i == DT_MODULE_LABEL ? TRUE : FALSE, 0);</a>
<a name="ln1003">  gtk_widget_set_halign(hw[DT_MODULE_ARROW], GTK_ALIGN_START);</a>
<a name="ln1004">  gtk_widget_set_halign(hw[DT_MODULE_LABEL], GTK_ALIGN_START);</a>
<a name="ln1005">  gtk_widget_set_halign(hw[DT_MODULE_RESET], GTK_ALIGN_END);</a>
<a name="ln1006"> </a>
<a name="ln1007">  gtk_widget_show_all(module-&gt;widget);</a>
<a name="ln1008">  gtk_widget_set_name(module-&gt;widget, &quot;lib-plugin-ui-main&quot;);</a>
<a name="ln1009">  gtk_widget_set_name(pluginui_frame, &quot;lib-plugin-ui&quot;);</a>
<a name="ln1010">  module-&gt;expander = expander;</a>
<a name="ln1011"> </a>
<a name="ln1012">  gtk_widget_set_hexpand(module-&gt;widget, FALSE);</a>
<a name="ln1013">  gtk_widget_set_vexpand(module-&gt;widget, FALSE);</a>
<a name="ln1014"> </a>
<a name="ln1015">  return module-&gt;expander;</a>
<a name="ln1016">}</a>
<a name="ln1017"> </a>
<a name="ln1018">void dt_lib_init(dt_lib_t *lib)</a>
<a name="ln1019">{</a>
<a name="ln1020">  // Setting everything to null initially</a>
<a name="ln1021">  memset(lib, 0, sizeof(dt_lib_t));</a>
<a name="ln1022">  darktable.lib-&gt;plugins = dt_module_load_modules(&quot;/plugins/lighttable&quot;, sizeof(dt_lib_module_t),</a>
<a name="ln1023">                                                  dt_lib_load_module, dt_lib_init_module, dt_lib_sort_plugins);</a>
<a name="ln1024">}</a>
<a name="ln1025"> </a>
<a name="ln1026">void dt_lib_cleanup(dt_lib_t *lib)</a>
<a name="ln1027">{</a>
<a name="ln1028">  while(lib-&gt;plugins)</a>
<a name="ln1029">  {</a>
<a name="ln1030">    dt_lib_module_t *module = (dt_lib_module_t *)(lib-&gt;plugins-&gt;data);</a>
<a name="ln1031">    if(module)</a>
<a name="ln1032">    {</a>
<a name="ln1033">      if(module-&gt;data != NULL)</a>
<a name="ln1034">      {</a>
<a name="ln1035">        module-&gt;gui_cleanup(module);</a>
<a name="ln1036">        module-&gt;data = NULL;</a>
<a name="ln1037">      }</a>
<a name="ln1038">      dt_lib_unload_module(module);</a>
<a name="ln1039">      free(module);</a>
<a name="ln1040">    }</a>
<a name="ln1041">    lib-&gt;plugins = g_list_delete_link(lib-&gt;plugins, lib-&gt;plugins);</a>
<a name="ln1042">  }</a>
<a name="ln1043">}</a>
<a name="ln1044"> </a>
<a name="ln1045">void dt_lib_presets_add(const char *name, const char *plugin_name, const int32_t version, const void *params,</a>
<a name="ln1046">                        const int32_t params_size)</a>
<a name="ln1047">{</a>
<a name="ln1048">  sqlite3_stmt *stmt;</a>
<a name="ln1049">  DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db),</a>
<a name="ln1050">                              &quot;DELETE FROM data.presets WHERE name=?1 AND operation=?2 AND op_version=?3&quot;, -1,</a>
<a name="ln1051">                              &amp;stmt, NULL);</a>
<a name="ln1052">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 1, name, -1, SQLITE_TRANSIENT);</a>
<a name="ln1053">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 2, plugin_name, -1, SQLITE_TRANSIENT);</a>
<a name="ln1054">  DT_DEBUG_SQLITE3_BIND_INT(stmt, 3, version);</a>
<a name="ln1055">  sqlite3_step(stmt);</a>
<a name="ln1056">  sqlite3_finalize(stmt);</a>
<a name="ln1057">  DT_DEBUG_SQLITE3_PREPARE_V2(</a>
<a name="ln1058">      dt_database_get(darktable.db),</a>
<a name="ln1059">      &quot;INSERT INTO data.presets (name, description, operation, op_version, op_params, &quot;</a>
<a name="ln1060">      &quot;blendop_params, blendop_version, enabled, model, maker, lens, &quot;</a>
<a name="ln1061">      &quot;iso_min, iso_max, exposure_min, exposure_max, aperture_min, aperture_max, &quot;</a>
<a name="ln1062">      &quot;focal_length_min, focal_length_max, writeprotect, &quot;</a>
<a name="ln1063">      &quot;autoapply, filter, def, format) VALUES (?1, '', ?2, ?3, ?4, NULL, 0, 1, '%', &quot;</a>
<a name="ln1064">      &quot;'%', '%', 0, 340282346638528859812000000000000000000, 0, 10000000, 0, 100000000, 0, 1000, 1, 0, 0, 0, 0)&quot;,</a>
<a name="ln1065">      -1, &amp;stmt, NULL);</a>
<a name="ln1066">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 1, name, -1, SQLITE_TRANSIENT);</a>
<a name="ln1067">  DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 2, plugin_name, -1, SQLITE_TRANSIENT);</a>
<a name="ln1068">  DT_DEBUG_SQLITE3_BIND_INT(stmt, 3, version);</a>
<a name="ln1069">  DT_DEBUG_SQLITE3_BIND_BLOB(stmt, 4, params, params_size, SQLITE_TRANSIENT);</a>
<a name="ln1070">  sqlite3_step(stmt);</a>
<a name="ln1071">  sqlite3_finalize(stmt);</a>
<a name="ln1072">}</a>
<a name="ln1073"> </a>
<a name="ln1074">gboolean dt_lib_is_visible(dt_lib_module_t *module)</a>
<a name="ln1075">{</a>
<a name="ln1076">  char key[512];</a>
<a name="ln1077">  g_snprintf(key, sizeof(key), &quot;plugins/lighttable/%s/visible&quot;, module-&gt;plugin_name);</a>
<a name="ln1078">  if(dt_conf_key_exists(key)) return dt_conf_get_bool(key);</a>
<a name="ln1079"> </a>
<a name="ln1080">  /* if not key found, always make module visible */</a>
<a name="ln1081">  return TRUE;</a>
<a name="ln1082">}</a>
<a name="ln1083"> </a>
<a name="ln1084">void dt_lib_set_visible(dt_lib_module_t *module, gboolean visible)</a>
<a name="ln1085">{</a>
<a name="ln1086">  char key[512];</a>
<a name="ln1087">  g_snprintf(key, sizeof(key), &quot;plugins/lighttable/%s/visible&quot;, module-&gt;plugin_name);</a>
<a name="ln1088">  dt_conf_set_bool(key, visible);</a>
<a name="ln1089">  if(module-&gt;widget)</a>
<a name="ln1090">  {</a>
<a name="ln1091">    if(module-&gt;expander)</a>
<a name="ln1092">    {</a>
<a name="ln1093">      dtgtk_expander_set_expanded(DTGTK_EXPANDER(module-&gt;expander), visible);</a>
<a name="ln1094">    }</a>
<a name="ln1095">    else</a>
<a name="ln1096">    {</a>
<a name="ln1097">      if(visible)</a>
<a name="ln1098">        gtk_widget_show_all(GTK_WIDGET(module-&gt;widget));</a>
<a name="ln1099">      else</a>
<a name="ln1100">        gtk_widget_hide(GTK_WIDGET(module-&gt;widget));</a>
<a name="ln1101">    }</a>
<a name="ln1102">  }</a>
<a name="ln1103">}</a>
<a name="ln1104"> </a>
<a name="ln1105">void dt_lib_connect_common_accels(dt_lib_module_t *module)</a>
<a name="ln1106">{</a>
<a name="ln1107">  if(module-&gt;reset_button)</a>
<a name="ln1108">    dt_accel_connect_button_lib(module, &quot;reset module parameters&quot;, module-&gt;reset_button);</a>
<a name="ln1109">  if(module-&gt;presets_button) dt_accel_connect_button_lib(module, &quot;show preset menu&quot;, module-&gt;presets_button);</a>
<a name="ln1110">  if(module-&gt;init_presets)</a>
<a name="ln1111">  {</a>
<a name="ln1112">    sqlite3_stmt *stmt;</a>
<a name="ln1113">    DT_DEBUG_SQLITE3_PREPARE_V2(dt_database_get(darktable.db), &quot;SELECT name FROM data.presets WHERE operation=?1 &quot;</a>
<a name="ln1114">                                                               &quot;AND op_version=?2 ORDER BY writeprotect DESC, &quot;</a>
<a name="ln1115">                                                               &quot;name, rowid&quot;,</a>
<a name="ln1116">                                -1, &amp;stmt, NULL);</a>
<a name="ln1117">    DT_DEBUG_SQLITE3_BIND_TEXT(stmt, 1, module-&gt;plugin_name, -1, SQLITE_TRANSIENT);</a>
<a name="ln1118">    DT_DEBUG_SQLITE3_BIND_INT(stmt, 2, module-&gt;version());</a>
<a name="ln1119">    while(sqlite3_step(stmt) == SQLITE_ROW)</a>
<a name="ln1120">    {</a>
<a name="ln1121">      char path[1024];</a>
<a name="ln1122">      snprintf(path, sizeof(path), &quot;%s/%s&quot;, _(&quot;preset&quot;), (char *)sqlite3_column_text(stmt, 0));</a>
<a name="ln1123">      dt_accel_register_lib(module, path, 0, 0);</a>
<a name="ln1124">      dt_accel_connect_preset_lib(module, (char *)sqlite3_column_text(stmt, 0));</a>
<a name="ln1125">    }</a>
<a name="ln1126">    sqlite3_finalize(stmt);</a>
<a name="ln1127">  }</a>
<a name="ln1128">}</a>
<a name="ln1129"> </a>
<a name="ln1130">gchar *dt_lib_get_localized_name(const gchar *plugin_name)</a>
<a name="ln1131">{</a>
<a name="ln1132">  // Prepare mapping op -&gt; localized name</a>
<a name="ln1133">  static GHashTable *module_names = NULL;</a>
<a name="ln1134">  if(module_names == NULL)</a>
<a name="ln1135">  {</a>
<a name="ln1136">    module_names = g_hash_table_new(g_str_hash, g_str_equal);</a>
<a name="ln1137">    GList *lib = g_list_first(darktable.lib-&gt;plugins);</a>
<a name="ln1138">    if(lib != NULL)</a>
<a name="ln1139">    {</a>
<a name="ln1140">      do</a>
<a name="ln1141">      {</a>
<a name="ln1142">        dt_lib_module_t *module = (dt_lib_module_t *)lib-&gt;data;</a>
<a name="ln1143">        g_hash_table_insert(module_names, module-&gt;plugin_name, g_strdup(module-&gt;name(module)));</a>
<a name="ln1144">      } while((lib = g_list_next(lib)) != NULL);</a>
<a name="ln1145">    }</a>
<a name="ln1146">  }</a>
<a name="ln1147"> </a>
<a name="ln1148">  return (gchar *)g_hash_table_lookup(module_names, plugin_name);</a>
<a name="ln1149">}</a>
<a name="ln1150"> </a>
<a name="ln1151">void dt_lib_colorpicker_set_area(dt_lib_t *lib, float size)</a>
<a name="ln1152">{</a>
<a name="ln1153">  if(!lib-&gt;proxy.colorpicker.module || !lib-&gt;proxy.colorpicker.set_sample_area) return;</a>
<a name="ln1154">  lib-&gt;proxy.colorpicker.set_sample_area(lib-&gt;proxy.colorpicker.module, size);</a>
<a name="ln1155">  gtk_widget_grab_focus(dt_ui_center(darktable.gui-&gt;ui));</a>
<a name="ln1156">}</a>
<a name="ln1157"> </a>
<a name="ln1158">void dt_lib_colorpicker_set_box_area(dt_lib_t *lib, const float *const box)</a>
<a name="ln1159">{</a>
<a name="ln1160">  if(!lib-&gt;proxy.colorpicker.module || !lib-&gt;proxy.colorpicker.set_sample_box_area) return;</a>
<a name="ln1161">  lib-&gt;proxy.colorpicker.set_sample_box_area(lib-&gt;proxy.colorpicker.module, box);</a>
<a name="ln1162">  gtk_widget_grab_focus(dt_ui_center(darktable.gui-&gt;ui));</a>
<a name="ln1163">}</a>
<a name="ln1164"> </a>
<a name="ln1165">void dt_lib_colorpicker_set_point(dt_lib_t *lib, float x, float y)</a>
<a name="ln1166">{</a>
<a name="ln1167">  if(!lib-&gt;proxy.colorpicker.module || !lib-&gt;proxy.colorpicker.set_sample_point) return;</a>
<a name="ln1168">  lib-&gt;proxy.colorpicker.set_sample_point(lib-&gt;proxy.colorpicker.module, x, y);</a>
<a name="ln1169">  gtk_widget_grab_focus(dt_ui_center(darktable.gui-&gt;ui));</a>
<a name="ln1170">}</a>
<a name="ln1171"> </a>
<a name="ln1172">// modelines: These editor modelines have been set for all relevant files by tools/update_modelines.sh</a>
<a name="ln1173">// vim: shiftwidth=2 expandtab tabstop=2 cindent</a>
<a name="ln1174">// kate: tab-indents: off; indent-width 2; replace-tabs on; indent-mode cstyle; remove-trailing-spaces modified;</a>

</code></pre>
<div class="balloon" rel="791"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v522/" target="_blank">V522</a> There might be dereferencing of a potential null pointer 'mi'. Check lines: 791, 789.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
