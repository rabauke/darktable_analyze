
<html>
<head>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>
<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2">    This file is part of darktable,</a>
<a name="ln3">    copyright (c) 2009--2012 johannes hanika.</a>
<a name="ln4">    copyright (c) 2011 Henrik Andersson.</a>
<a name="ln5">    copyright (c) 2012--2013 Ulrich Pegelow</a>
<a name="ln6"> </a>
<a name="ln7">    darktable is free software: you can redistribute it and/or modify</a>
<a name="ln8">    it under the terms of the GNU General Public License as published by</a>
<a name="ln9">    the Free Software Foundation, either version 3 of the License, or</a>
<a name="ln10">    (at your option) any later version.</a>
<a name="ln11"> </a>
<a name="ln12">    darktable is distributed in the hope that it will be useful,</a>
<a name="ln13">    but WITHOUT ANY WARRANTY; without even the implied warranty of</a>
<a name="ln14">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</a>
<a name="ln15">    GNU General Public License for more details.</a>
<a name="ln16"> </a>
<a name="ln17">    You should have received a copy of the GNU General Public License</a>
<a name="ln18">    along with darktable.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</a>
<a name="ln19">*/</a>
<a name="ln20">#include &quot;bauhaus/bauhaus.h&quot;</a>
<a name="ln21">#include &quot;common/debug.h&quot;</a>
<a name="ln22">#include &quot;common/dtpthread.h&quot;</a>
<a name="ln23">#include &quot;common/opencl.h&quot;</a>
<a name="ln24">#include &quot;control/control.h&quot;</a>
<a name="ln25">#include &quot;develop/blend.h&quot;</a>
<a name="ln26">#include &quot;develop/develop.h&quot;</a>
<a name="ln27">#include &quot;develop/imageop.h&quot;</a>
<a name="ln28">#include &quot;develop/masks.h&quot;</a>
<a name="ln29">#include &quot;develop/tiling.h&quot;</a>
<a name="ln30">#include &quot;dtgtk/button.h&quot;</a>
<a name="ln31">#include &quot;dtgtk/gradientslider.h&quot;</a>
<a name="ln32">#include &quot;gui/accelerators.h&quot;</a>
<a name="ln33">#include &quot;gui/gtk.h&quot;</a>
<a name="ln34">#include &quot;gui/presets.h&quot;</a>
<a name="ln35"> </a>
<a name="ln36">#include &lt;assert.h&gt;</a>
<a name="ln37">#include &lt;gmodule.h&gt;</a>
<a name="ln38">#include &lt;math.h&gt;</a>
<a name="ln39">#include &lt;stdlib.h&gt;</a>
<a name="ln40">#include &lt;string.h&gt;</a>
<a name="ln41">#include &lt;strings.h&gt;</a>
<a name="ln42"> </a>
<a name="ln43">#define CLAMP_RANGE(x, y, z) (CLAMP(x, y, z))</a>
<a name="ln44">#define NEUTRAL_GRAY 0.5</a>
<a name="ln45"> </a>
<a name="ln46">typedef enum _iop_gui_blendif_channel_t</a>
<a name="ln47">{</a>
<a name="ln48">  ch_L = 0,</a>
<a name="ln49">  ch_a = 1,</a>
<a name="ln50">  ch_b = 2,</a>
<a name="ln51">  ch_gray = 0,</a>
<a name="ln52">  ch_red = 1,</a>
<a name="ln53">  ch_green = 2,</a>
<a name="ln54">  ch_blue = 3,</a>
<a name="ln55">  ch_max = 4</a>
<a name="ln56">} _iop_gui_blendif_channel_t;</a>
<a name="ln57"> </a>
<a name="ln58"> </a>
<a name="ln59"> </a>
<a name="ln60">static const dt_iop_gui_blendif_colorstop_t _gradient_L[]</a>
<a name="ln61">    = { { 0.0f, { 0, 0, 0, 1.0 } },</a>
<a name="ln62">        { 0.5f, { NEUTRAL_GRAY / 2, NEUTRAL_GRAY / 2, NEUTRAL_GRAY / 2, 1.0 } },</a>
<a name="ln63">        { 1.0f, { NEUTRAL_GRAY, NEUTRAL_GRAY, NEUTRAL_GRAY, 1.0 } } };</a>
<a name="ln64"> </a>
<a name="ln65">static const dt_iop_gui_blendif_colorstop_t _gradient_a[]</a>
<a name="ln66">    = { { 0.0f, { 0, 0.34 * NEUTRAL_GRAY * 2, 0.27 * NEUTRAL_GRAY * 2, 1.0 } },</a>
<a name="ln67">        { 0.5f, { NEUTRAL_GRAY, NEUTRAL_GRAY, NEUTRAL_GRAY, 1.0 } },</a>
<a name="ln68">        { 1.0f, { 0.53 * NEUTRAL_GRAY * 2, 0.08 * NEUTRAL_GRAY * 2, 0.28 * NEUTRAL_GRAY * 2, 1.0 } } };</a>
<a name="ln69"> </a>
<a name="ln70">static const dt_iop_gui_blendif_colorstop_t _gradient_b[]</a>
<a name="ln71">    = { { 0.0f, { 0, 0.27 * NEUTRAL_GRAY * 2, 0.58 * NEUTRAL_GRAY * 2, 1.0 } },</a>
<a name="ln72">        { 0.5f, { NEUTRAL_GRAY, NEUTRAL_GRAY, NEUTRAL_GRAY, 1.0 } },</a>
<a name="ln73">        { 1.0f, { 0.81 * NEUTRAL_GRAY * 2, 0.66 * NEUTRAL_GRAY * 2, 0, 1.0 } } };</a>
<a name="ln74"> </a>
<a name="ln75">static const dt_iop_gui_blendif_colorstop_t _gradient_gray[]</a>
<a name="ln76">    = { { 0.0f, { 0, 0, 0, 1.0 } },</a>
<a name="ln77">        { 0.5f, { NEUTRAL_GRAY / 2, NEUTRAL_GRAY / 2, NEUTRAL_GRAY / 2, 1.0 } },</a>
<a name="ln78">        { 1.0f, { NEUTRAL_GRAY, NEUTRAL_GRAY, NEUTRAL_GRAY, 1.0 } } };</a>
<a name="ln79"> </a>
<a name="ln80">static const dt_iop_gui_blendif_colorstop_t _gradient_red[] = { { 0.0f, { 0, 0, 0, 1.0 } },</a>
<a name="ln81">                                                                { 0.5f, { NEUTRAL_GRAY / 2, 0, 0, 1.0 } },</a>
<a name="ln82">                                                                { 1.0f, { NEUTRAL_GRAY, 0, 0, 1.0 } } };</a>
<a name="ln83"> </a>
<a name="ln84">static const dt_iop_gui_blendif_colorstop_t _gradient_green[] = { { 0.0f, { 0, 0, 0, 1.0 } },</a>
<a name="ln85">                                                                  { 0.5f, { 0, NEUTRAL_GRAY / 2, 0, 1.0 } },</a>
<a name="ln86">                                                                  { 1.0f, { 0, NEUTRAL_GRAY, 0, 1.0 } } };</a>
<a name="ln87"> </a>
<a name="ln88">static const dt_iop_gui_blendif_colorstop_t _gradient_blue[] = { { 0.0f, { 0, 0, 0, 1.0 } },</a>
<a name="ln89">                                                                 { 0.5f, { 0, 0, NEUTRAL_GRAY / 2, 1.0 } },</a>
<a name="ln90">                                                                 { 1.0f, { 0, 0, NEUTRAL_GRAY, 1.0 } } };</a>
<a name="ln91"> </a>
<a name="ln92">static const dt_iop_gui_blendif_colorstop_t _gradient_chroma[]</a>
<a name="ln93">    = { { 0.0f, { NEUTRAL_GRAY, NEUTRAL_GRAY, NEUTRAL_GRAY, 1.0 } },</a>
<a name="ln94">        { 0.5f, { NEUTRAL_GRAY, NEUTRAL_GRAY / 2, NEUTRAL_GRAY, 1.0 } },</a>
<a name="ln95">        { 1.0f, { NEUTRAL_GRAY, 0, NEUTRAL_GRAY, 1.0 } } };</a>
<a name="ln96"> </a>
<a name="ln97">static const dt_iop_gui_blendif_colorstop_t _gradient_hue[] = {</a>
<a name="ln98">  { 0.0f, { 1.00f * 1.5f * NEUTRAL_GRAY, 0.68f * 1.5f * NEUTRAL_GRAY, 0.78f * 1.5f * NEUTRAL_GRAY, 1.0 } },</a>
<a name="ln99">  { 0.166f, { 0.95f * 1.5f * NEUTRAL_GRAY, 0.73f * 1.5f * NEUTRAL_GRAY, 0.56f * 1.5f * NEUTRAL_GRAY, 1.0 } },</a>
<a name="ln100">  { 0.333f, { 0.71f * 1.5f * NEUTRAL_GRAY, 0.81f * 1.5f * NEUTRAL_GRAY, 0.55f * 1.5f * NEUTRAL_GRAY, 1.0 } },</a>
<a name="ln101">  { 0.500f, { 0.45f * 1.5f * NEUTRAL_GRAY, 0.85f * 1.5f * NEUTRAL_GRAY, 0.77f * 1.5f * NEUTRAL_GRAY, 1.0 } },</a>
<a name="ln102">  { 0.666f, { 0.49f * 1.5f * NEUTRAL_GRAY, 0.82f * 1.5f * NEUTRAL_GRAY, 1.00f * 1.5f * NEUTRAL_GRAY, 1.0 } },</a>
<a name="ln103">  { 0.833f, { 0.82f * 1.5f * NEUTRAL_GRAY, 0.74f * 1.5f * NEUTRAL_GRAY, 1.00f * 1.5f * NEUTRAL_GRAY, 1.0 } },</a>
<a name="ln104">  { 1.0f, { 1.00f * 1.5f * NEUTRAL_GRAY, 0.68f * 1.5f * NEUTRAL_GRAY, 0.78f * 1.5f * NEUTRAL_GRAY, 1.0 } }</a>
<a name="ln105">};</a>
<a name="ln106"> </a>
<a name="ln107">static const dt_iop_gui_blendif_colorstop_t _gradient_HUE[]</a>
<a name="ln108">    = { { 0.0f, { NEUTRAL_GRAY, 0, 0, 1.0 } },</a>
<a name="ln109">        { 0.166f, { NEUTRAL_GRAY, NEUTRAL_GRAY, 0, 1.0 } },</a>
<a name="ln110">        { 0.332f, { 0, NEUTRAL_GRAY, 0, 1.0 } },</a>
<a name="ln111">        { 0.498f, { 0, NEUTRAL_GRAY, NEUTRAL_GRAY, 1.0 } },</a>
<a name="ln112">        { 0.664f, { 0, 0, NEUTRAL_GRAY, 1.0 } },</a>
<a name="ln113">        { 0.830f, { NEUTRAL_GRAY, 0, NEUTRAL_GRAY, 1.0 } },</a>
<a name="ln114">        { 1.0f, { NEUTRAL_GRAY, 0, 0, 1.0 } } };</a>
<a name="ln115"> </a>
<a name="ln116"> </a>
<a name="ln117">static inline void _RGB_2_HSL(const float *RGB, float *HSL)</a>
<a name="ln118">{</a>
<a name="ln119">  float H, S, L;</a>
<a name="ln120"> </a>
<a name="ln121">  float R = RGB[0];</a>
<a name="ln122">  float G = RGB[1];</a>
<a name="ln123">  float B = RGB[2];</a>
<a name="ln124"> </a>
<a name="ln125">  float var_Min = fminf(R, fminf(G, B));</a>
<a name="ln126">  float var_Max = fmaxf(R, fmaxf(G, B));</a>
<a name="ln127">  float del_Max = var_Max - var_Min;</a>
<a name="ln128"> </a>
<a name="ln129">  L = (var_Max + var_Min) / 2.0f;</a>
<a name="ln130"> </a>
<a name="ln131">  if(del_Max == 0.0f)</a>
<a name="ln132">  {</a>
<a name="ln133">    H = 0.0f;</a>
<a name="ln134">    S = 0.0f;</a>
<a name="ln135">  }</a>
<a name="ln136">  else</a>
<a name="ln137">  {</a>
<a name="ln138">    if(L &lt; 0.5f)</a>
<a name="ln139">      S = del_Max / (var_Max + var_Min);</a>
<a name="ln140">    else</a>
<a name="ln141">      S = del_Max / (2.0f - var_Max - var_Min);</a>
<a name="ln142"> </a>
<a name="ln143">    float del_R = (((var_Max - R) / 6.0f) + (del_Max / 2.0f)) / del_Max;</a>
<a name="ln144">    float del_G = (((var_Max - G) / 6.0f) + (del_Max / 2.0f)) / del_Max;</a>
<a name="ln145">    float del_B = (((var_Max - B) / 6.0f) + (del_Max / 2.0f)) / del_Max;</a>
<a name="ln146"> </a>
<a name="ln147">    if(R == var_Max)</a>
<a name="ln148">      H = del_B - del_G;</a>
<a name="ln149">    else if(G == var_Max)</a>
<a name="ln150">      H = (1.0f / 3.0f) + del_R - del_B;</a>
<a name="ln151">    else if(B == var_Max)</a>
<a name="ln152">      H = (2.0f / 3.0f) + del_G - del_R;</a>
<a name="ln153">    else</a>
<a name="ln154">      H = 0.0f; // make GCC happy</a>
<a name="ln155"> </a>
<a name="ln156">    if(H &lt; 0.0f) H += 1.0f;</a>
<a name="ln157">    if(H &gt; 1.0f) H -= 1.0f;</a>
<a name="ln158">  }</a>
<a name="ln159"> </a>
<a name="ln160">  HSL[0] = H;</a>
<a name="ln161">  HSL[1] = S;</a>
<a name="ln162">  HSL[2] = L;</a>
<a name="ln163">}</a>
<a name="ln164"> </a>
<a name="ln165"> </a>
<a name="ln166">static inline void _Lab_2_LCH(const float *Lab, float *LCH)</a>
<a name="ln167">{</a>
<a name="ln168">  float var_H = atan2f(Lab[2], Lab[1]);</a>
<a name="ln169"> </a>
<a name="ln170">  if(var_H &gt; 0.0f)</a>
<a name="ln171">    var_H = var_H / (2.0f * M_PI);</a>
<a name="ln172">  else</a>
<a name="ln173">    var_H = 1.0f - fabs(var_H) / (2.0f * M_PI);</a>
<a name="ln174"> </a>
<a name="ln175">  LCH[0] = Lab[0];</a>
<a name="ln176">  LCH[1] = sqrtf(Lab[1] * Lab[1] + Lab[2] * Lab[2]);</a>
<a name="ln177">  LCH[2] = var_H;</a>
<a name="ln178">}</a>
<a name="ln179"> </a>
<a name="ln180"> </a>
<a name="ln181">static void _blendif_scale(dt_iop_colorspace_type_t cst, const float *in, float *out)</a>
<a name="ln182">{</a>
<a name="ln183">  float temp[4];</a>
<a name="ln184"> </a>
<a name="ln185">  switch(cst)</a>
<a name="ln186">  {</a>
<a name="ln187">    case iop_cs_Lab:</a>
<a name="ln188">      _Lab_2_LCH(in, temp);</a>
<a name="ln189">      out[0] = CLAMP_RANGE(in[0] / 100.0f, 0.0f, 1.0f);</a>
<a name="ln190">      out[1] = CLAMP_RANGE((in[1] + 128.0f) / 256.0f, 0.0f, 1.0f);</a>
<a name="ln191">      out[2] = CLAMP_RANGE((in[2] + 128.0f) / 256.0f, 0.0f, 1.0f);</a>
<a name="ln192">      out[3] = CLAMP_RANGE(temp[1] / (128.0f * sqrtf(2.0f)), 0.0f, 1.0f);</a>
<a name="ln193">      out[4] = CLAMP_RANGE(temp[2], 0.0f, 1.0f);</a>
<a name="ln194">      out[5] = out[6] = out[7] = -1;</a>
<a name="ln195">      break;</a>
<a name="ln196">    case iop_cs_rgb:</a>
<a name="ln197">      _RGB_2_HSL(in, temp);</a>
<a name="ln198">      out[0] = CLAMP_RANGE(0.3f * in[0] + 0.59f * in[1] + 0.11f * in[2], 0.0f, 1.0f);</a>
<a name="ln199">      out[1] = CLAMP_RANGE(in[0], 0.0f, 1.0f);</a>
<a name="ln200">      out[2] = CLAMP_RANGE(in[1], 0.0f, 1.0f);</a>
<a name="ln201">      out[3] = CLAMP_RANGE(in[2], 0.0f, 1.0f);</a>
<a name="ln202">      out[4] = CLAMP_RANGE(temp[0], 0.0f, 1.0f);</a>
<a name="ln203">      out[5] = CLAMP_RANGE(temp[1], 0.0f, 1.0f);</a>
<a name="ln204">      out[6] = CLAMP_RANGE(temp[2], 0.0f, 1.0f);</a>
<a name="ln205">      out[7] = -1;</a>
<a name="ln206">      break;</a>
<a name="ln207">    default:</a>
<a name="ln208">      out[0] = out[1] = out[2] = out[3] = out[4] = out[5] = out[6] = out[7] = -1.0f;</a>
<a name="ln209">  }</a>
<a name="ln210">}</a>
<a name="ln211"> </a>
<a name="ln212">static void _blendif_cook(dt_iop_colorspace_type_t cst, const float *in, float *out)</a>
<a name="ln213">{</a>
<a name="ln214">  float temp[4];</a>
<a name="ln215"> </a>
<a name="ln216">  switch(cst)</a>
<a name="ln217">  {</a>
<a name="ln218">    case iop_cs_Lab:</a>
<a name="ln219">      _Lab_2_LCH(in, temp);</a>
<a name="ln220">      out[0] = in[0];</a>
<a name="ln221">      out[1] = in[1];</a>
<a name="ln222">      out[2] = in[2];</a>
<a name="ln223">      out[3] = temp[1] / (128.0f * sqrtf(2.0f)) * 100.0f;</a>
<a name="ln224">      out[4] = temp[2] * 360.0f;</a>
<a name="ln225">      out[5] = out[6] = out[7] = -1;</a>
<a name="ln226">      break;</a>
<a name="ln227">    case iop_cs_rgb:</a>
<a name="ln228">      _RGB_2_HSL(in, temp);</a>
<a name="ln229">      out[0] = (0.3f * in[0] + 0.59f * in[1] + 0.11f * in[2]) * 255.0f;</a>
<a name="ln230">      out[1] = in[0] * 255.0f;</a>
<a name="ln231">      out[2] = in[1] * 255.0f;</a>
<a name="ln232">      out[3] = in[2] * 255.0f;</a>
<a name="ln233">      out[4] = temp[0] * 360.0f;</a>
<a name="ln234">      out[5] = temp[1] * 100.0f;</a>
<a name="ln235">      out[6] = temp[2] * 100.0f;</a>
<a name="ln236">      out[7] = -1;</a>
<a name="ln237">      break;</a>
<a name="ln238">    default:</a>
<a name="ln239">      out[0] = out[1] = out[2] = out[3] = out[4] = out[5] = out[6] = out[7] = -1.0f;</a>
<a name="ln240">  }</a>
<a name="ln241">}</a>
<a name="ln242"> </a>
<a name="ln243"> </a>
<a name="ln244">static void _blendif_scale_print_L(float value, char *string, int n)</a>
<a name="ln245">{</a>
<a name="ln246">  snprintf(string, n, &quot;%-4.0f&quot;, value * 100.0f);</a>
<a name="ln247">}</a>
<a name="ln248"> </a>
<a name="ln249">static void _blendif_scale_print_ab(float value, char *string, int n)</a>
<a name="ln250">{</a>
<a name="ln251">  snprintf(string, n, &quot;%-4.0f&quot;, value * 256.0f - 128.0f);</a>
<a name="ln252">}</a>
<a name="ln253"> </a>
<a name="ln254">static void _blendif_scale_print_rgb(float value, char *string, int n)</a>
<a name="ln255">{</a>
<a name="ln256">  snprintf(string, n, &quot;%-4.0f&quot;, value * 255.0f);</a>
<a name="ln257">}</a>
<a name="ln258"> </a>
<a name="ln259">static void _blendif_scale_print_hue(float value, char *string, int n)</a>
<a name="ln260">{</a>
<a name="ln261">  snprintf(string, n, &quot;%-4.0f&quot;, value * 360.0f);</a>
<a name="ln262">}</a>
<a name="ln263"> </a>
<a name="ln264">static void _blendif_scale_print_default(float value, char *string, int n)</a>
<a name="ln265">{</a>
<a name="ln266">  snprintf(string, n, &quot;%-4.0f&quot;, value * 100.0f);</a>
<a name="ln267">}</a>
<a name="ln268"> </a>
<a name="ln269">static void _blendop_masks_mode_callback(const unsigned int mask_mode, dt_iop_gui_blend_data_t *data)</a>
<a name="ln270">{</a>
<a name="ln271">  data-&gt;module-&gt;blend_params-&gt;mask_mode = mask_mode;</a>
<a name="ln272"> </a>
<a name="ln273">  if(mask_mode &amp; DEVELOP_MASK_ENABLED)</a>
<a name="ln274">  {</a>
<a name="ln275">    gtk_widget_show(GTK_WIDGET(data-&gt;top_box));</a>
<a name="ln276">  }</a>
<a name="ln277">  else</a>
<a name="ln278">  {</a>
<a name="ln279">    gtk_widget_hide(GTK_WIDGET(data-&gt;top_box));</a>
<a name="ln280">  }</a>
<a name="ln281"> </a>
<a name="ln282">  dt_iop_set_mask_mode(data-&gt;module, mask_mode);</a>
<a name="ln283"> </a>
<a name="ln284">  if((mask_mode &amp; DEVELOP_MASK_ENABLED)</a>
<a name="ln285">     &amp;&amp; ((data-&gt;masks_inited &amp;&amp; (mask_mode &amp; DEVELOP_MASK_MASK))</a>
<a name="ln286">         || (data-&gt;blendif_inited &amp;&amp; (mask_mode &amp; DEVELOP_MASK_CONDITIONAL))))</a>
<a name="ln287">  {</a>
<a name="ln288">    if(data-&gt;blendif_inited &amp;&amp; (mask_mode &amp; DEVELOP_MASK_CONDITIONAL))</a>
<a name="ln289">    {</a>
<a name="ln290">      dt_bauhaus_combobox_set(data-&gt;masks_combine_combo,</a>
<a name="ln291">                              g_list_index(data-&gt;masks_combine,</a>
<a name="ln292">                                           GUINT_TO_POINTER(data-&gt;module-&gt;blend_params-&gt;mask_combine</a>
<a name="ln293">                                                            &amp; (DEVELOP_COMBINE_INV | DEVELOP_COMBINE_INCL))));</a>
<a name="ln294">      gtk_widget_hide(GTK_WIDGET(data-&gt;masks_invert_combo));</a>
<a name="ln295">      gtk_widget_show(GTK_WIDGET(data-&gt;masks_combine_combo));</a>
<a name="ln296">    }</a>
<a name="ln297">    else</a>
<a name="ln298">    {</a>
<a name="ln299">      dt_bauhaus_combobox_set(</a>
<a name="ln300">          data-&gt;masks_invert_combo,</a>
<a name="ln301">          g_list_index(data-&gt;masks_invert,</a>
<a name="ln302">                       GUINT_TO_POINTER(data-&gt;module-&gt;blend_params-&gt;mask_combine &amp; DEVELOP_COMBINE_INV)));</a>
<a name="ln303">      gtk_widget_show(GTK_WIDGET(data-&gt;masks_invert_combo));</a>
<a name="ln304">      gtk_widget_hide(GTK_WIDGET(data-&gt;masks_combine_combo));</a>
<a name="ln305">    }</a>
<a name="ln306"> </a>
<a name="ln307">    /*</a>
<a name="ln308">     * if this iop is operating in raw space, it has only 1 channel per pixel,</a>
<a name="ln309">     * thus there is no alpha channel where we would normally store mask</a>
<a name="ln310">     * that would get displayed if following button have been pressed.</a>
<a name="ln311">     *</a>
<a name="ln312">     * TODO: revisit if/once there semi-raw iops (e.g temperature) with blending</a>
<a name="ln313">     */</a>
<a name="ln314">    if(dt_iop_module_colorspace(data-&gt;module) == iop_cs_RAW)</a>
<a name="ln315">    {</a>
<a name="ln316">      data-&gt;module-&gt;request_mask_display = DT_DEV_PIXELPIPE_DISPLAY_NONE;</a>
<a name="ln317">      dtgtk_button_set_active(DTGTK_BUTTON(data-&gt;showmask), 0);</a>
<a name="ln318">      gtk_widget_hide(GTK_WIDGET(data-&gt;showmask));</a>
<a name="ln319"> </a>
<a name="ln320">      // disable also guided-filters on RAW based color space</a>
<a name="ln321">      gtk_widget_set_sensitive(data-&gt;masks_feathering_guide_combo, 0);</a>
<a name="ln322">      gtk_widget_hide(GTK_WIDGET(data-&gt;masks_feathering_guide_combo));</a>
<a name="ln323">      gtk_widget_set_sensitive(data-&gt;feathering_radius_slider, 0);</a>
<a name="ln324">      gtk_widget_hide(GTK_WIDGET(data-&gt;feathering_radius_slider));</a>
<a name="ln325">      gtk_widget_set_sensitive(data-&gt;brightness_slider, 0);</a>
<a name="ln326">      gtk_widget_hide(GTK_WIDGET(data-&gt;brightness_slider));</a>
<a name="ln327">      gtk_widget_set_sensitive(data-&gt;contrast_slider, 0);</a>
<a name="ln328">      gtk_widget_hide(GTK_WIDGET(data-&gt;contrast_slider));</a>
<a name="ln329">    }</a>
<a name="ln330">    else</a>
<a name="ln331">    {</a>
<a name="ln332">      gtk_widget_show(GTK_WIDGET(data-&gt;showmask));</a>
<a name="ln333">    }</a>
<a name="ln334"> </a>
<a name="ln335">    gtk_widget_show(GTK_WIDGET(data-&gt;bottom_box));</a>
<a name="ln336">  }</a>
<a name="ln337">  else</a>
<a name="ln338">  {</a>
<a name="ln339">    data-&gt;module-&gt;request_mask_display = DT_DEV_PIXELPIPE_DISPLAY_NONE;</a>
<a name="ln340">    dtgtk_button_set_active(DTGTK_BUTTON(data-&gt;showmask), 0);</a>
<a name="ln341">    data-&gt;module-&gt;suppress_mask = 0;</a>
<a name="ln342">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(data-&gt;suppress), 0);</a>
<a name="ln343"> </a>
<a name="ln344">    gtk_widget_hide(GTK_WIDGET(data-&gt;bottom_box));</a>
<a name="ln345">  }</a>
<a name="ln346"> </a>
<a name="ln347">  if(data-&gt;masks_inited &amp;&amp; (mask_mode &amp; DEVELOP_MASK_MASK))</a>
<a name="ln348">  {</a>
<a name="ln349">    gtk_widget_show(GTK_WIDGET(data-&gt;masks_box));</a>
<a name="ln350">  }</a>
<a name="ln351">  else if(data-&gt;masks_inited)</a>
<a name="ln352">  {</a>
<a name="ln353">    dt_masks_set_edit_mode(data-&gt;module, DT_MASKS_EDIT_OFF);</a>
<a name="ln354">    gtk_widget_hide(GTK_WIDGET(data-&gt;masks_box));</a>
<a name="ln355">  }</a>
<a name="ln356">  else</a>
<a name="ln357">  {</a>
<a name="ln358">    gtk_widget_hide(GTK_WIDGET(data-&gt;masks_box));</a>
<a name="ln359">  }</a>
<a name="ln360"> </a>
<a name="ln361">  if(data-&gt;raster_inited &amp;&amp; (mask_mode &amp; DEVELOP_MASK_RASTER))</a>
<a name="ln362">  {</a>
<a name="ln363">    gtk_widget_show(GTK_WIDGET(data-&gt;raster_box));</a>
<a name="ln364">  }</a>
<a name="ln365">  else if(data-&gt;raster_inited)</a>
<a name="ln366">  {</a>
<a name="ln367">//     dt_masks_set_edit_mode(data-&gt;module, DT_MASKS_EDIT_OFF);</a>
<a name="ln368">    gtk_widget_hide(GTK_WIDGET(data-&gt;raster_box));</a>
<a name="ln369">  }</a>
<a name="ln370">  else</a>
<a name="ln371">  {</a>
<a name="ln372">    gtk_widget_hide(GTK_WIDGET(data-&gt;raster_box));</a>
<a name="ln373">  }</a>
<a name="ln374"> </a>
<a name="ln375">  if(data-&gt;blendif_inited &amp;&amp; (mask_mode &amp; DEVELOP_MASK_CONDITIONAL))</a>
<a name="ln376">  {</a>
<a name="ln377">    gtk_widget_show(GTK_WIDGET(data-&gt;blendif_box));</a>
<a name="ln378">  }</a>
<a name="ln379">  else if(data-&gt;blendif_inited)</a>
<a name="ln380">  {</a>
<a name="ln381">    /* switch off color picker - only if it was requested by blendif */</a>
<a name="ln382">    if(data-&gt;module-&gt;request_color_pick == DT_REQUEST_COLORPICK_BLEND)</a>
<a name="ln383">    {</a>
<a name="ln384">      data-&gt;module-&gt;request_color_pick = DT_REQUEST_COLORPICK_OFF;</a>
<a name="ln385">      gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(data-&gt;colorpicker), 0);</a>
<a name="ln386">    }</a>
<a name="ln387"> </a>
<a name="ln388">    gtk_widget_hide(GTK_WIDGET(data-&gt;blendif_box));</a>
<a name="ln389">  }</a>
<a name="ln390">  else</a>
<a name="ln391">  {</a>
<a name="ln392">    gtk_widget_hide(GTK_WIDGET(data-&gt;blendif_box));</a>
<a name="ln393">  }</a>
<a name="ln394"> </a>
<a name="ln395">  dt_dev_add_history_item(darktable.develop, data-&gt;module, TRUE);</a>
<a name="ln396">}</a>
<a name="ln397"> </a>
<a name="ln398"> </a>
<a name="ln399">static void _blendop_blend_mode_callback(GtkWidget *combo, dt_iop_gui_blend_data_t *data)</a>
<a name="ln400">{</a>
<a name="ln401">  data-&gt;module-&gt;blend_params-&gt;blend_mode = GPOINTER_TO_UINT(</a>
<a name="ln402">      g_list_nth_data(data-&gt;blend_modes, dt_bauhaus_combobox_get(data-&gt;blend_modes_combo)));</a>
<a name="ln403">  dt_dev_add_history_item(darktable.develop, data-&gt;module, TRUE);</a>
<a name="ln404">}</a>
<a name="ln405"> </a>
<a name="ln406">static void _blendop_masks_combine_callback(GtkWidget *combo, dt_iop_gui_blend_data_t *data)</a>
<a name="ln407">{</a>
<a name="ln408">  const unsigned combine = GPOINTER_TO_UINT(</a>
<a name="ln409">      g_list_nth_data(data-&gt;masks_combine, dt_bauhaus_combobox_get(data-&gt;masks_combine_combo)));</a>
<a name="ln410">  data-&gt;module-&gt;blend_params-&gt;mask_combine &amp;= ~(DEVELOP_COMBINE_INV | DEVELOP_COMBINE_INCL);</a>
<a name="ln411">  data-&gt;module-&gt;blend_params-&gt;mask_combine |= combine;</a>
<a name="ln412">  dt_dev_add_history_item(darktable.develop, data-&gt;module, TRUE);</a>
<a name="ln413">}</a>
<a name="ln414"> </a>
<a name="ln415">static void _blendop_masks_invert_callback(GtkWidget *combo, dt_iop_gui_blend_data_t *data)</a>
<a name="ln416">{</a>
<a name="ln417">  unsigned int invert = GPOINTER_TO_UINT(g_list_nth_data(data-&gt;masks_invert,</a>
<a name="ln418">                                                         dt_bauhaus_combobox_get(data-&gt;masks_invert_combo)))</a>
<a name="ln419">                        &amp; DEVELOP_COMBINE_INV;</a>
<a name="ln420">  if(invert)</a>
<a name="ln421">    data-&gt;module-&gt;blend_params-&gt;mask_combine |= DEVELOP_COMBINE_INV;</a>
<a name="ln422">  else</a>
<a name="ln423">    data-&gt;module-&gt;blend_params-&gt;mask_combine &amp;= ~DEVELOP_COMBINE_INV;</a>
<a name="ln424">  dt_dev_add_history_item(darktable.develop, data-&gt;module, TRUE);</a>
<a name="ln425">}</a>
<a name="ln426"> </a>
<a name="ln427">static void _blendop_opacity_callback(GtkWidget *slider, dt_iop_gui_blend_data_t *data)</a>
<a name="ln428">{</a>
<a name="ln429">  data-&gt;module-&gt;blend_params-&gt;opacity = dt_bauhaus_slider_get(slider);</a>
<a name="ln430">  dt_dev_add_history_item(darktable.develop, data-&gt;module, TRUE);</a>
<a name="ln431">}</a>
<a name="ln432"> </a>
<a name="ln433">static void _blendop_blendif_feathering_radius_callback(GtkWidget *slider, dt_iop_gui_blend_data_t *data)</a>
<a name="ln434">{</a>
<a name="ln435">  data-&gt;module-&gt;blend_params-&gt;feathering_radius = dt_bauhaus_slider_get(slider);</a>
<a name="ln436">  dt_dev_add_history_item(darktable.develop, data-&gt;module, TRUE);</a>
<a name="ln437">}</a>
<a name="ln438"> </a>
<a name="ln439">static void _blendop_masks_feathering_guide_callback(GtkWidget *combo, dt_iop_gui_blend_data_t *data)</a>
<a name="ln440">{</a>
<a name="ln441">  data-&gt;module-&gt;blend_params-&gt;feathering_guide = GPOINTER_TO_UINT(</a>
<a name="ln442">      g_list_nth_data(data-&gt;masks_feathering_guide, dt_bauhaus_combobox_get(data-&gt;masks_feathering_guide_combo)));</a>
<a name="ln443">  dt_dev_add_history_item(darktable.develop, data-&gt;module, TRUE);</a>
<a name="ln444">}</a>
<a name="ln445"> </a>
<a name="ln446">static void _blendop_blendif_blur_radius_callback(GtkWidget *slider, dt_iop_gui_blend_data_t *data)</a>
<a name="ln447">{</a>
<a name="ln448">  data-&gt;module-&gt;blend_params-&gt;blur_radius = dt_bauhaus_slider_get(slider);</a>
<a name="ln449">  dt_dev_add_history_item(darktable.develop, data-&gt;module, TRUE);</a>
<a name="ln450">}</a>
<a name="ln451"> </a>
<a name="ln452">static void _blendop_blendif_brightness_callback(GtkWidget *slider, dt_iop_gui_blend_data_t *data)</a>
<a name="ln453">{</a>
<a name="ln454">  data-&gt;module-&gt;blend_params-&gt;brightness = dt_bauhaus_slider_get(slider);</a>
<a name="ln455">  dt_dev_add_history_item(darktable.develop, data-&gt;module, TRUE);</a>
<a name="ln456">}</a>
<a name="ln457"> </a>
<a name="ln458">static void _blendop_blendif_contrast_callback(GtkWidget *slider, dt_iop_gui_blend_data_t *data)</a>
<a name="ln459">{</a>
<a name="ln460">  data-&gt;module-&gt;blend_params-&gt;contrast = dt_bauhaus_slider_get(slider);</a>
<a name="ln461">  dt_dev_add_history_item(darktable.develop, data-&gt;module, TRUE);</a>
<a name="ln462">}</a>
<a name="ln463"> </a>
<a name="ln464">static void _blendop_blendif_upper_callback(GtkDarktableGradientSlider *slider, dt_iop_gui_blend_data_t *data)</a>
<a name="ln465">{</a>
<a name="ln466">  if(darktable.gui-&gt;reset) return;</a>
<a name="ln467">  dt_develop_blend_params_t *bp = data-&gt;module-&gt;blend_params;</a>
<a name="ln468"> </a>
<a name="ln469">  int tab = data-&gt;tab;</a>
<a name="ln470">  int ch = data-&gt;channels[tab][1];</a>
<a name="ln471"> </a>
<a name="ln472">  float *parameters = &amp;(bp-&gt;blendif_parameters[4 * ch]);</a>
<a name="ln473"> </a>
<a name="ln474">  for(int k = 0; k &lt; 4; k++) parameters[k] = dtgtk_gradient_slider_multivalue_get_value(slider, k);</a>
<a name="ln475"> </a>
<a name="ln476">  for(int k = 0; k &lt; 4; k++)</a>
<a name="ln477">  {</a>
<a name="ln478">    char text[256];</a>
<a name="ln479">    (data-&gt;scale_print[tab])(parameters[k], text, sizeof(text));</a>
<a name="ln480">    gtk_label_set_text(data-&gt;upper_label[k], text);</a>
<a name="ln481">  }</a>
<a name="ln482"> </a>
<a name="ln483">  /** de-activate processing of this channel if maximum span is selected */</a>
<a name="ln484">  if(parameters[1] == 0.0f &amp;&amp; parameters[2] == 1.0f)</a>
<a name="ln485">    bp-&gt;blendif &amp;= ~(1 &lt;&lt; ch);</a>
<a name="ln486">  else</a>
<a name="ln487">    bp-&gt;blendif |= (1 &lt;&lt; ch);</a>
<a name="ln488"> </a>
<a name="ln489">  dt_dev_add_history_item(darktable.develop, data-&gt;module, TRUE);</a>
<a name="ln490">}</a>
<a name="ln491"> </a>
<a name="ln492"> </a>
<a name="ln493">static void _blendop_blendif_lower_callback(GtkDarktableGradientSlider *slider, dt_iop_gui_blend_data_t *data)</a>
<a name="ln494">{</a>
<a name="ln495">  if(darktable.gui-&gt;reset) return;</a>
<a name="ln496">  dt_develop_blend_params_t *bp = data-&gt;module-&gt;blend_params;</a>
<a name="ln497"> </a>
<a name="ln498">  int tab = data-&gt;tab;</a>
<a name="ln499">  int ch = data-&gt;channels[tab][0];</a>
<a name="ln500"> </a>
<a name="ln501">  float *parameters = &amp;(bp-&gt;blendif_parameters[4 * ch]);</a>
<a name="ln502"> </a>
<a name="ln503">  for(int k = 0; k &lt; 4; k++) parameters[k] = dtgtk_gradient_slider_multivalue_get_value(slider, k);</a>
<a name="ln504"> </a>
<a name="ln505">  for(int k = 0; k &lt; 4; k++)</a>
<a name="ln506">  {</a>
<a name="ln507">    char text[256];</a>
<a name="ln508">    (data-&gt;scale_print[tab])(parameters[k], text, sizeof(text));</a>
<a name="ln509">    gtk_label_set_text(data-&gt;lower_label[k], text);</a>
<a name="ln510">  }</a>
<a name="ln511"> </a>
<a name="ln512">  /** de-activate processing of this channel if maximum span is selected */</a>
<a name="ln513">  if(parameters[1] == 0.0f &amp;&amp; parameters[2] == 1.0f)</a>
<a name="ln514">    bp-&gt;blendif &amp;= ~(1 &lt;&lt; ch);</a>
<a name="ln515">  else</a>
<a name="ln516">    bp-&gt;blendif |= (1 &lt;&lt; ch);</a>
<a name="ln517"> </a>
<a name="ln518">  dt_dev_add_history_item(darktable.develop, data-&gt;module, TRUE);</a>
<a name="ln519">}</a>
<a name="ln520"> </a>
<a name="ln521"> </a>
<a name="ln522">static void _blendop_blendif_polarity_callback(GtkToggleButton *togglebutton, dt_iop_gui_blend_data_t *data)</a>
<a name="ln523">{</a>
<a name="ln524">  int active = gtk_toggle_button_get_active(togglebutton);</a>
<a name="ln525">  if(darktable.gui-&gt;reset) return;</a>
<a name="ln526">  dt_develop_blend_params_t *bp = data-&gt;module-&gt;blend_params;</a>
<a name="ln527"> </a>
<a name="ln528">  int tab = data-&gt;tab;</a>
<a name="ln529">  int ch = GTK_WIDGET(togglebutton) == data-&gt;lower_polarity ? data-&gt;channels[tab][0] : data-&gt;channels[tab][1];</a>
<a name="ln530">  GtkDarktableGradientSlider *slider = GTK_WIDGET(togglebutton) == data-&gt;lower_polarity ? data-&gt;lower_slider</a>
<a name="ln531">                                                                                        : data-&gt;upper_slider;</a>
<a name="ln532"> </a>
<a name="ln533">  if(!active)</a>
<a name="ln534">    bp-&gt;blendif |= (1 &lt;&lt; (ch + 16));</a>
<a name="ln535">  else</a>
<a name="ln536">    bp-&gt;blendif &amp;= ~(1 &lt;&lt; (ch + 16));</a>
<a name="ln537"> </a>
<a name="ln538">  dtgtk_gradient_slider_multivalue_set_marker(</a>
<a name="ln539">      slider, active ? GRADIENT_SLIDER_MARKER_LOWER_OPEN_BIG : GRADIENT_SLIDER_MARKER_UPPER_OPEN_BIG, 0);</a>
<a name="ln540">  dtgtk_gradient_slider_multivalue_set_marker(</a>
<a name="ln541">      slider, active ? GRADIENT_SLIDER_MARKER_UPPER_FILLED_BIG : GRADIENT_SLIDER_MARKER_LOWER_FILLED_BIG, 1);</a>
<a name="ln542">  dtgtk_gradient_slider_multivalue_set_marker(</a>
<a name="ln543">      slider, active ? GRADIENT_SLIDER_MARKER_UPPER_FILLED_BIG : GRADIENT_SLIDER_MARKER_LOWER_FILLED_BIG, 2);</a>
<a name="ln544">  dtgtk_gradient_slider_multivalue_set_marker(</a>
<a name="ln545">      slider, active ? GRADIENT_SLIDER_MARKER_LOWER_OPEN_BIG : GRADIENT_SLIDER_MARKER_UPPER_OPEN_BIG, 3);</a>
<a name="ln546"> </a>
<a name="ln547">  dt_dev_add_history_item(darktable.develop, data-&gt;module, TRUE);</a>
<a name="ln548">}</a>
<a name="ln549"> </a>
<a name="ln550"> </a>
<a name="ln551">static void _blendop_blendif_tab_switch(GtkNotebook *notebook, GtkWidget *page, guint page_num,</a>
<a name="ln552">                                        dt_iop_gui_blend_data_t *data)</a>
<a name="ln553">{</a>
<a name="ln554">  data-&gt;tab = page_num;</a>
<a name="ln555">  dt_iop_gui_update_blendif(data-&gt;module);</a>
<a name="ln556">}</a>
<a name="ln557"> </a>
<a name="ln558"> </a>
<a name="ln559">static void _blendop_blendif_pick_toggled(GtkToggleButton *togglebutton, dt_iop_module_t *module)</a>
<a name="ln560">{</a>
<a name="ln561">  if(darktable.gui-&gt;reset) return;</a>
<a name="ln562"> </a>
<a name="ln563">  /* if module itself already requested color pick don't tamper with it. A module color picker takes</a>
<a name="ln564">   * precedence. */</a>
<a name="ln565">  if(module-&gt;request_color_pick == DT_REQUEST_COLORPICK_MODULE)</a>
<a name="ln566">  {</a>
<a name="ln567">    gtk_toggle_button_set_active(togglebutton, 0);</a>
<a name="ln568">    return;</a>
<a name="ln569">  }</a>
<a name="ln570"> </a>
<a name="ln571">  module-&gt;request_color_pick</a>
<a name="ln572">      = (gtk_toggle_button_get_active(togglebutton) ? DT_REQUEST_COLORPICK_BLEND : DT_REQUEST_COLORPICK_OFF);</a>
<a name="ln573"> </a>
<a name="ln574">  /* set the area sample size */</a>
<a name="ln575">  if(module-&gt;request_color_pick != DT_REQUEST_COLORPICK_OFF)</a>
<a name="ln576">  {</a>
<a name="ln577">    dt_lib_colorpicker_set_point(darktable.lib, 0.5, 0.5);</a>
<a name="ln578">    dt_dev_reprocess_all(module-&gt;dev);</a>
<a name="ln579">  }</a>
<a name="ln580">  else</a>
<a name="ln581">    dt_control_queue_redraw();</a>
<a name="ln582"> </a>
<a name="ln583">  if(module-&gt;off) gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(module-&gt;off), 1);</a>
<a name="ln584">  dt_iop_request_focus(module);</a>
<a name="ln585">}</a>
<a name="ln586"> </a>
<a name="ln587">static void _blendop_blendif_showmask_clicked(GtkWidget *button, GdkEventButton *event, dt_iop_module_t *module)</a>
<a name="ln588">{</a>
<a name="ln589">  if(darktable.gui-&gt;reset) return;</a>
<a name="ln590"> </a>
<a name="ln591">  // if blendif is bypassed don't allow to set this button on</a>
<a name="ln592">  if(module-&gt;bypass_blendif)</a>
<a name="ln593">  {</a>
<a name="ln594">    dt_control_log(_(&quot;display mask is currently disabled by another module&quot;));</a>
<a name="ln595"> </a>
<a name="ln596">    if(darktable.gui-&gt;reset) return;</a>
<a name="ln597">    const int reset = darktable.gui-&gt;reset;</a>
<a name="ln598">    darktable.gui-&gt;reset = 1;</a>
<a name="ln599">    dtgtk_button_set_active(DTGTK_BUTTON(button), FALSE);</a>
<a name="ln600">    darktable.gui-&gt;reset = reset;</a>
<a name="ln601">    return;</a>
<a name="ln602">  }</a>
<a name="ln603"> </a>
<a name="ln604">  if(event-&gt;button == 1)</a>
<a name="ln605">  {</a>
<a name="ln606">    const int has_mask_display = module-&gt;request_mask_display &amp; (DT_DEV_PIXELPIPE_DISPLAY_MASK | DT_DEV_PIXELPIPE_DISPLAY_CHANNEL);</a>
<a name="ln607"> </a>
<a name="ln608">    module-&gt;request_mask_display &amp;= ~(DT_DEV_PIXELPIPE_DISPLAY_MASK | DT_DEV_PIXELPIPE_DISPLAY_CHANNEL | DT_DEV_PIXELPIPE_DISPLAY_ANY);</a>
<a name="ln609"> </a>
<a name="ln610">    GdkModifierType modifiers = gtk_accelerator_get_default_mod_mask();</a>
<a name="ln611">    if((event-&gt;state &amp; modifiers) == (GDK_CONTROL_MASK | GDK_SHIFT_MASK))</a>
<a name="ln612">      module-&gt;request_mask_display |= (DT_DEV_PIXELPIPE_DISPLAY_MASK | DT_DEV_PIXELPIPE_DISPLAY_CHANNEL);</a>
<a name="ln613">    else if((event-&gt;state &amp; modifiers) == GDK_SHIFT_MASK)</a>
<a name="ln614">      module-&gt;request_mask_display |= DT_DEV_PIXELPIPE_DISPLAY_CHANNEL;</a>
<a name="ln615">    else if((event-&gt;state &amp; modifiers) == GDK_CONTROL_MASK)</a>
<a name="ln616">      module-&gt;request_mask_display |= DT_DEV_PIXELPIPE_DISPLAY_MASK;</a>
<a name="ln617">    else</a>
<a name="ln618">      module-&gt;request_mask_display |= (has_mask_display ? 0 : DT_DEV_PIXELPIPE_DISPLAY_MASK);</a>
<a name="ln619"> </a>
<a name="ln620">    if(module-&gt;request_mask_display &amp; (DT_DEV_PIXELPIPE_DISPLAY_MASK | DT_DEV_PIXELPIPE_DISPLAY_CHANNEL))</a>
<a name="ln621">      dtgtk_button_set_active(DTGTK_BUTTON(button), 1);</a>
<a name="ln622">    else</a>
<a name="ln623">      dtgtk_button_set_active(DTGTK_BUTTON(button), 0);</a>
<a name="ln624"> </a>
<a name="ln625"> </a>
<a name="ln626">    if(module-&gt;off) gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(module-&gt;off), 1);</a>
<a name="ln627"> </a>
<a name="ln628">    dt_iop_request_focus(module);</a>
<a name="ln629">    dt_dev_reprocess_all(module-&gt;dev);</a>
<a name="ln630">  }</a>
<a name="ln631">}</a>
<a name="ln632"> </a>
<a name="ln633">static void _blendop_masks_modes_none_clicked(GtkWidget *button, GdkEventButton *event, dt_iop_module_t *module)</a>
<a name="ln634">{</a>
<a name="ln635">  if(darktable.gui-&gt;reset) return;</a>
<a name="ln636">  dt_iop_gui_blend_data_t *data = module-&gt;blend_data;</a>
<a name="ln637"> </a>
<a name="ln638">  if(event-&gt;button == 1 &amp;&amp; data-&gt;selected_mask_mode != button)</a>
<a name="ln639">  {</a>
<a name="ln640">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(data-&gt;selected_mask_mode),</a>
<a name="ln641">                                 FALSE); // unsets currently toggled if any</a>
<a name="ln642"> </a>
<a name="ln643">    _blendop_masks_mode_callback(DEVELOP_MASK_DISABLED, data);</a>
<a name="ln644">    data-&gt;selected_mask_mode = button;</a>
<a name="ln645">  }</a>
<a name="ln646">}</a>
<a name="ln647"> </a>
<a name="ln648">static void _blendop_masks_modes_toggle(GtkToggleButton *button, dt_iop_module_t *module, const unsigned int mask_mode)</a>
<a name="ln649">{</a>
<a name="ln650">  if(darktable.gui-&gt;reset) return;</a>
<a name="ln651">  dt_iop_gui_blend_data_t *data = module-&gt;blend_data;</a>
<a name="ln652"> </a>
<a name="ln653">  gboolean was_toggled = gtk_toggle_button_get_active(button);</a>
<a name="ln654"> </a>
<a name="ln655">  // avoids trying to untoggle the cancel button</a>
<a name="ln656">  if(data-&gt;selected_mask_mode</a>
<a name="ln657">     != g_list_nth_data(data-&gt;masks_modes_toggles,</a>
<a name="ln658">                        g_list_index(data-&gt;masks_modes, GUINT_TO_POINTER(DEVELOP_MASK_DISABLED))))</a>
<a name="ln659">  {</a>
<a name="ln660">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(data-&gt;selected_mask_mode), FALSE);</a>
<a name="ln661">  }</a>
<a name="ln662"> </a>
<a name="ln663">  if(was_toggled)</a>
<a name="ln664">  {</a>
<a name="ln665">    _blendop_masks_mode_callback(mask_mode, data);</a>
<a name="ln666">    data-&gt;selected_mask_mode = GTK_WIDGET(button);</a>
<a name="ln667">  }</a>
<a name="ln668">  else</a>
<a name="ln669">  {</a>
<a name="ln670">    _blendop_masks_mode_callback(DEVELOP_MASK_DISABLED, data);</a>
<a name="ln671">    data-&gt;selected_mask_mode = GTK_WIDGET(</a>
<a name="ln672">      g_list_nth_data(data-&gt;masks_modes_toggles,</a>
<a name="ln673">                      g_list_index(data-&gt;masks_modes, (gconstpointer)DEVELOP_MASK_DISABLED)));</a>
<a name="ln674">  }</a>
<a name="ln675">}</a>
<a name="ln676"> </a>
<a name="ln677">static void _blendop_masks_modes_uni_toggled(GtkToggleButton *button, dt_iop_module_t *module)</a>
<a name="ln678">{</a>
<a name="ln679">  _blendop_masks_modes_toggle(button, module, DEVELOP_MASK_ENABLED);</a>
<a name="ln680">}</a>
<a name="ln681"> </a>
<a name="ln682">static void _blendop_masks_modes_drawn_toggled(GtkToggleButton *button, dt_iop_module_t *module)</a>
<a name="ln683">{</a>
<a name="ln684">  _blendop_masks_modes_toggle(button, module, DEVELOP_MASK_ENABLED | DEVELOP_MASK_MASK);</a>
<a name="ln685">}</a>
<a name="ln686"> </a>
<a name="ln687">static void _blendop_masks_modes_param_toggled(GtkToggleButton *button, dt_iop_module_t *module)</a>
<a name="ln688">{</a>
<a name="ln689">  _blendop_masks_modes_toggle(button, module, DEVELOP_MASK_ENABLED | DEVELOP_MASK_CONDITIONAL);</a>
<a name="ln690">}</a>
<a name="ln691"> </a>
<a name="ln692">static void _blendop_masks_modes_both_toggled(GtkToggleButton *button, dt_iop_module_t *module)</a>
<a name="ln693">{</a>
<a name="ln694">  _blendop_masks_modes_toggle(button, module, DEVELOP_MASK_ENABLED | DEVELOP_MASK_MASK_CONDITIONAL);</a>
<a name="ln695">}</a>
<a name="ln696"> </a>
<a name="ln697">static void _blendop_masks_modes_raster_toggled(GtkToggleButton *button, dt_iop_module_t *module)</a>
<a name="ln698">{</a>
<a name="ln699">  _blendop_masks_modes_toggle(button, module, DEVELOP_MASK_ENABLED | DEVELOP_MASK_RASTER);</a>
<a name="ln700">}</a>
<a name="ln701"> </a>
<a name="ln702">static void _blendop_blendif_suppress_toggled(GtkToggleButton *togglebutton, dt_iop_module_t *module)</a>
<a name="ln703">{</a>
<a name="ln704">  module-&gt;suppress_mask = gtk_toggle_button_get_active(togglebutton);</a>
<a name="ln705">  if(darktable.gui-&gt;reset) return;</a>
<a name="ln706"> </a>
<a name="ln707">  if(module-&gt;off) gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(module-&gt;off), 1);</a>
<a name="ln708">  dt_iop_request_focus(module);</a>
<a name="ln709"> </a>
<a name="ln710">  dt_dev_reprocess_all(module-&gt;dev);</a>
<a name="ln711">}</a>
<a name="ln712"> </a>
<a name="ln713">static void _blendop_blendif_reset(GtkButton *button, dt_iop_module_t *module)</a>
<a name="ln714">{</a>
<a name="ln715">  module-&gt;blend_params-&gt;blendif = module-&gt;default_blendop_params-&gt;blendif;</a>
<a name="ln716">  memcpy(module-&gt;blend_params-&gt;blendif_parameters, module-&gt;default_blendop_params-&gt;blendif_parameters,</a>
<a name="ln717">         4 * DEVELOP_BLENDIF_SIZE * sizeof(float));</a>
<a name="ln718"> </a>
<a name="ln719">  dt_iop_gui_update_blendif(module);</a>
<a name="ln720">  dt_dev_add_history_item(darktable.develop, module, TRUE);</a>
<a name="ln721">}</a>
<a name="ln722"> </a>
<a name="ln723">static void _blendop_blendif_invert(GtkButton *button, dt_iop_module_t *module)</a>
<a name="ln724">{</a>
<a name="ln725">  if(darktable.gui-&gt;reset) return;</a>
<a name="ln726"> </a>
<a name="ln727">  dt_iop_gui_blend_data_t *data = module-&gt;blend_data;</a>
<a name="ln728"> </a>
<a name="ln729">  unsigned int toggle_mask = 0;</a>
<a name="ln730"> </a>
<a name="ln731">  switch(data-&gt;csp)</a>
<a name="ln732">  {</a>
<a name="ln733">    case iop_cs_Lab:</a>
<a name="ln734">      toggle_mask = DEVELOP_BLENDIF_Lab_MASK &lt;&lt; 16;</a>
<a name="ln735">      break;</a>
<a name="ln736"> </a>
<a name="ln737">    case iop_cs_rgb:</a>
<a name="ln738">      toggle_mask = DEVELOP_BLENDIF_RGB_MASK &lt;&lt; 16;</a>
<a name="ln739">      break;</a>
<a name="ln740"> </a>
<a name="ln741">    case iop_cs_RAW:</a>
<a name="ln742">      toggle_mask = 0;</a>
<a name="ln743">      break;</a>
<a name="ln744">  }</a>
<a name="ln745"> </a>
<a name="ln746">  module-&gt;blend_params-&gt;blendif ^= toggle_mask;</a>
<a name="ln747">  module-&gt;blend_params-&gt;mask_combine ^= DEVELOP_COMBINE_MASKS_POS;</a>
<a name="ln748">  module-&gt;blend_params-&gt;mask_combine ^= DEVELOP_COMBINE_INCL;</a>
<a name="ln749">  dt_iop_gui_update_blending(module);</a>
<a name="ln750">  dt_dev_add_history_item(darktable.develop, module, TRUE);</a>
<a name="ln751">}</a>
<a name="ln752"> </a>
<a name="ln753">static int _blendop_masks_add_path(GtkWidget *widget, GdkEventButton *event, dt_iop_module_t *self)</a>
<a name="ln754">{</a>
<a name="ln755">  if(darktable.gui-&gt;reset) return FALSE;</a>
<a name="ln756">  dt_iop_gui_blend_data_t *bd = (dt_iop_gui_blend_data_t *)self-&gt;blend_data;</a>
<a name="ln757"> </a>
<a name="ln758">  if(event-&gt;button == 1)</a>
<a name="ln759">  {</a>
<a name="ln760">    // we want to be sure that the iop has focus</a>
<a name="ln761">    dt_iop_request_focus(self);</a>
<a name="ln762">    self-&gt;request_color_pick = DT_REQUEST_COLORPICK_OFF;</a>
<a name="ln763">    bd-&gt;masks_shown = DT_MASKS_EDIT_FULL;</a>
<a name="ln764">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_edit), TRUE);</a>
<a name="ln765">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(widget), TRUE);</a>
<a name="ln766">    // we create the new form</a>
<a name="ln767">    dt_masks_form_t *form = dt_masks_create(DT_MASKS_PATH);</a>
<a name="ln768">    dt_masks_change_form_gui(form);</a>
<a name="ln769">    darktable.develop-&gt;form_gui-&gt;creation = TRUE;</a>
<a name="ln770">    darktable.develop-&gt;form_gui-&gt;creation_module = self;</a>
<a name="ln771">    dt_control_queue_redraw_center();</a>
<a name="ln772">    return TRUE;</a>
<a name="ln773">  }</a>
<a name="ln774"> </a>
<a name="ln775">  return FALSE;</a>
<a name="ln776">}</a>
<a name="ln777"> </a>
<a name="ln778">static int _blendop_masks_add_circle(GtkWidget *widget, GdkEventButton *event, dt_iop_module_t *self)</a>
<a name="ln779">{</a>
<a name="ln780">  if(darktable.gui-&gt;reset) return FALSE;</a>
<a name="ln781">  dt_iop_gui_blend_data_t *bd = (dt_iop_gui_blend_data_t *)self-&gt;blend_data;</a>
<a name="ln782"> </a>
<a name="ln783">  if(event-&gt;button == 1)</a>
<a name="ln784">  {</a>
<a name="ln785">    // we want to be sure that the iop has focus</a>
<a name="ln786">    dt_iop_request_focus(self);</a>
<a name="ln787">    self-&gt;request_color_pick = DT_REQUEST_COLORPICK_OFF;</a>
<a name="ln788">    bd-&gt;masks_shown = DT_MASKS_EDIT_FULL;</a>
<a name="ln789">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_edit), TRUE);</a>
<a name="ln790">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(widget), TRUE);</a>
<a name="ln791">    // we create the new form</a>
<a name="ln792">    dt_masks_form_t *spot = dt_masks_create(DT_MASKS_CIRCLE);</a>
<a name="ln793">    dt_masks_change_form_gui(spot);</a>
<a name="ln794">    darktable.develop-&gt;form_gui-&gt;creation = TRUE;</a>
<a name="ln795">    darktable.develop-&gt;form_gui-&gt;creation_module = self;</a>
<a name="ln796">    dt_control_queue_redraw_center();</a>
<a name="ln797">    return TRUE;</a>
<a name="ln798">  }</a>
<a name="ln799"> </a>
<a name="ln800">  return FALSE;</a>
<a name="ln801">}</a>
<a name="ln802"> </a>
<a name="ln803">static int _blendop_masks_add_ellipse(GtkWidget *widget, GdkEventButton *event, dt_iop_module_t *self)</a>
<a name="ln804">{</a>
<a name="ln805">  if(darktable.gui-&gt;reset) return FALSE;</a>
<a name="ln806">  dt_iop_gui_blend_data_t *bd = (dt_iop_gui_blend_data_t *)self-&gt;blend_data;</a>
<a name="ln807"> </a>
<a name="ln808">  if(event-&gt;button == 1)</a>
<a name="ln809">  {</a>
<a name="ln810">    // we want to be sure that the iop has focus</a>
<a name="ln811">    dt_iop_request_focus(self);</a>
<a name="ln812">    self-&gt;request_color_pick = DT_REQUEST_COLORPICK_OFF;</a>
<a name="ln813">    bd-&gt;masks_shown = DT_MASKS_EDIT_FULL;</a>
<a name="ln814">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_edit), TRUE);</a>
<a name="ln815">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(widget), TRUE);</a>
<a name="ln816">    // we create the new form</a>
<a name="ln817">    dt_masks_form_t *spot = dt_masks_create(DT_MASKS_ELLIPSE);</a>
<a name="ln818">    dt_masks_change_form_gui(spot);</a>
<a name="ln819">    darktable.develop-&gt;form_gui-&gt;creation = TRUE;</a>
<a name="ln820">    darktable.develop-&gt;form_gui-&gt;creation_module = self;</a>
<a name="ln821">    dt_control_queue_redraw_center();</a>
<a name="ln822">    return TRUE;</a>
<a name="ln823">  }</a>
<a name="ln824"> </a>
<a name="ln825">  return FALSE;</a>
<a name="ln826">}</a>
<a name="ln827"> </a>
<a name="ln828">static int _blendop_masks_add_brush(GtkWidget *widget, GdkEventButton *event, dt_iop_module_t *self)</a>
<a name="ln829">{</a>
<a name="ln830">  if(darktable.gui-&gt;reset) return FALSE;</a>
<a name="ln831">  dt_iop_gui_blend_data_t *bd = (dt_iop_gui_blend_data_t *)self-&gt;blend_data;</a>
<a name="ln832"> </a>
<a name="ln833">  if(event-&gt;button == 1)</a>
<a name="ln834">  {</a>
<a name="ln835">    // we want to be sure that the iop has focus</a>
<a name="ln836">    dt_iop_request_focus(self);</a>
<a name="ln837">    self-&gt;request_color_pick = DT_REQUEST_COLORPICK_OFF;</a>
<a name="ln838">    bd-&gt;masks_shown = DT_MASKS_EDIT_FULL;</a>
<a name="ln839">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_edit), TRUE);</a>
<a name="ln840">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(widget), TRUE);</a>
<a name="ln841">    // we create the new form</a>
<a name="ln842">    dt_masks_form_t *form = dt_masks_create(DT_MASKS_BRUSH);</a>
<a name="ln843">    dt_masks_change_form_gui(form);</a>
<a name="ln844">    darktable.develop-&gt;form_gui-&gt;creation = TRUE;</a>
<a name="ln845">    darktable.develop-&gt;form_gui-&gt;creation_module = self;</a>
<a name="ln846">    dt_control_queue_redraw_center();</a>
<a name="ln847">    return TRUE;</a>
<a name="ln848">  }</a>
<a name="ln849"> </a>
<a name="ln850">  return FALSE;</a>
<a name="ln851">}</a>
<a name="ln852"> </a>
<a name="ln853">static int _blendop_masks_add_gradient(GtkWidget *widget, GdkEventButton *event, dt_iop_module_t *self)</a>
<a name="ln854">{</a>
<a name="ln855">  if(darktable.gui-&gt;reset) return FALSE;</a>
<a name="ln856">  dt_iop_gui_blend_data_t *bd = (dt_iop_gui_blend_data_t *)self-&gt;blend_data;</a>
<a name="ln857"> </a>
<a name="ln858">  if(event-&gt;button == 1)</a>
<a name="ln859">  {</a>
<a name="ln860">    // we want to be sure that the iop has focus</a>
<a name="ln861">    dt_iop_request_focus(self);</a>
<a name="ln862">    self-&gt;request_color_pick = DT_REQUEST_COLORPICK_OFF;</a>
<a name="ln863">    bd-&gt;masks_shown = DT_MASKS_EDIT_FULL;</a>
<a name="ln864">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_edit), TRUE);</a>
<a name="ln865">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(widget), TRUE);</a>
<a name="ln866">    // we create the new form</a>
<a name="ln867">    dt_masks_form_t *spot = dt_masks_create(DT_MASKS_GRADIENT);</a>
<a name="ln868">    dt_masks_change_form_gui(spot);</a>
<a name="ln869">    darktable.develop-&gt;form_gui-&gt;creation = TRUE;</a>
<a name="ln870">    darktable.develop-&gt;form_gui-&gt;creation_module = self;</a>
<a name="ln871">    dt_control_queue_redraw_center();</a>
<a name="ln872">    return TRUE;</a>
<a name="ln873">  }</a>
<a name="ln874"> </a>
<a name="ln875">  return FALSE;</a>
<a name="ln876">}</a>
<a name="ln877"> </a>
<a name="ln878"> </a>
<a name="ln879">static int _blendop_masks_show_and_edit(GtkWidget *widget, GdkEventButton *event, dt_iop_module_t *self)</a>
<a name="ln880">{</a>
<a name="ln881">  if(darktable.gui-&gt;reset) return FALSE;</a>
<a name="ln882">  dt_iop_gui_blend_data_t *bd = (dt_iop_gui_blend_data_t *)self-&gt;blend_data;</a>
<a name="ln883"> </a>
<a name="ln884">  if(event-&gt;button == 1)</a>
<a name="ln885">  {</a>
<a name="ln886">    darktable.gui-&gt;reset = 1;</a>
<a name="ln887"> </a>
<a name="ln888">    dt_iop_request_focus(self);</a>
<a name="ln889">    self-&gt;request_color_pick = DT_REQUEST_COLORPICK_OFF;</a>
<a name="ln890"> </a>
<a name="ln891">    dt_masks_form_t *grp = dt_masks_get_from_id(darktable.develop, self-&gt;blend_params-&gt;mask_id);</a>
<a name="ln892">    if(grp &amp;&amp; (grp-&gt;type &amp; DT_MASKS_GROUP) &amp;&amp; g_list_length(grp-&gt;points) &gt; 0)</a>
<a name="ln893">    {</a>
<a name="ln894">      const int control_button_pressed = event-&gt;state &amp; GDK_CONTROL_MASK;</a>
<a name="ln895"> </a>
<a name="ln896">      switch(bd-&gt;masks_shown)</a>
<a name="ln897">      {</a>
<a name="ln898">        case DT_MASKS_EDIT_FULL:</a>
<a name="ln899">          bd-&gt;masks_shown = control_button_pressed ? DT_MASKS_EDIT_RESTRICTED : DT_MASKS_EDIT_OFF;</a>
<a name="ln900">          break;</a>
<a name="ln901"> </a>
<a name="ln902">        case DT_MASKS_EDIT_RESTRICTED:</a>
<a name="ln903">          bd-&gt;masks_shown = !control_button_pressed ? DT_MASKS_EDIT_FULL : DT_MASKS_EDIT_OFF;</a>
<a name="ln904">          break;</a>
<a name="ln905"> </a>
<a name="ln906">        default:</a>
<a name="ln907">        case DT_MASKS_EDIT_OFF:</a>
<a name="ln908">          bd-&gt;masks_shown = control_button_pressed ? DT_MASKS_EDIT_RESTRICTED : DT_MASKS_EDIT_FULL;</a>
<a name="ln909">      }</a>
<a name="ln910">    }</a>
<a name="ln911">    else</a>
<a name="ln912">      bd-&gt;masks_shown = DT_MASKS_EDIT_OFF;</a>
<a name="ln913"> </a>
<a name="ln914">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_edit), bd-&gt;masks_shown != DT_MASKS_EDIT_OFF);</a>
<a name="ln915">    dt_masks_set_edit_mode(self, bd-&gt;masks_shown);</a>
<a name="ln916"> </a>
<a name="ln917">    darktable.gui-&gt;reset = 0;</a>
<a name="ln918"> </a>
<a name="ln919">    return TRUE;</a>
<a name="ln920">  }</a>
<a name="ln921"> </a>
<a name="ln922">  return FALSE;</a>
<a name="ln923">}</a>
<a name="ln924"> </a>
<a name="ln925">static void _blendop_masks_polarity_callback(GtkToggleButton *togglebutton, dt_iop_module_t *self)</a>
<a name="ln926">{</a>
<a name="ln927">  if(darktable.gui-&gt;reset) return;</a>
<a name="ln928"> </a>
<a name="ln929">  int active = gtk_toggle_button_get_active(togglebutton);</a>
<a name="ln930">  dt_develop_blend_params_t *bp = (dt_develop_blend_params_t *)self-&gt;blend_params;</a>
<a name="ln931"> </a>
<a name="ln932">  if(active)</a>
<a name="ln933">    bp-&gt;mask_combine |= DEVELOP_COMBINE_MASKS_POS;</a>
<a name="ln934">  else</a>
<a name="ln935">    bp-&gt;mask_combine &amp;= ~DEVELOP_COMBINE_MASKS_POS;</a>
<a name="ln936"> </a>
<a name="ln937">  dt_dev_add_history_item(darktable.develop, self, TRUE);</a>
<a name="ln938">}</a>
<a name="ln939"> </a>
<a name="ln940">static gboolean _blendop_blendif_draw(GtkWidget *widget, cairo_t *cr, dt_iop_module_t *module)</a>
<a name="ln941">{</a>
<a name="ln942">  if(darktable.gui-&gt;reset) return FALSE;</a>
<a name="ln943"> </a>
<a name="ln944">  dt_iop_gui_blend_data_t *data = module-&gt;blend_data;</a>
<a name="ln945"> </a>
<a name="ln946">  float picker_mean[8], picker_min[8], picker_max[8];</a>
<a name="ln947">  float cooked[8];</a>
<a name="ln948">  float *raw_mean, *raw_min, *raw_max;</a>
<a name="ln949">  char text[256];</a>
<a name="ln950">  GtkLabel *label;</a>
<a name="ln951"> </a>
<a name="ln952">  if(widget == GTK_WIDGET(data-&gt;lower_slider))</a>
<a name="ln953">  {</a>
<a name="ln954">    raw_mean = module-&gt;picked_color;</a>
<a name="ln955">    raw_min = module-&gt;picked_color_min;</a>
<a name="ln956">    raw_max = module-&gt;picked_color_max;</a>
<a name="ln957">    label = data-&gt;lower_picker_label;</a>
<a name="ln958">  }</a>
<a name="ln959">  else</a>
<a name="ln960">  {</a>
<a name="ln961">    raw_mean = module-&gt;picked_output_color;</a>
<a name="ln962">    raw_min = module-&gt;picked_output_color_min;</a>
<a name="ln963">    raw_max = module-&gt;picked_output_color_max;</a>
<a name="ln964">    label = data-&gt;upper_picker_label;</a>
<a name="ln965">  }</a>
<a name="ln966"> </a>
<a name="ln967">  darktable.gui-&gt;reset = 1;</a>
<a name="ln968">  if((module-&gt;request_color_pick == DT_REQUEST_COLORPICK_BLEND) &amp;&amp; (raw_min[0] != INFINITY))</a>
<a name="ln969">  {</a>
<a name="ln970">    _blendif_scale(data-&gt;csp, raw_mean, picker_mean);</a>
<a name="ln971">    _blendif_scale(data-&gt;csp, raw_min, picker_min);</a>
<a name="ln972">    _blendif_scale(data-&gt;csp, raw_max, picker_max);</a>
<a name="ln973">    _blendif_cook(data-&gt;csp, raw_mean, cooked);</a>
<a name="ln974"> </a>
<a name="ln975">    if(data-&gt;channels[data-&gt;tab][0] &gt;= 8) // min and max make no sense for HSL and LCh</a>
<a name="ln976">      picker_min[data-&gt;tab] = picker_max[data-&gt;tab] = picker_mean[data-&gt;tab];</a>
<a name="ln977"> </a>
<a name="ln978">    snprintf(text, sizeof(text), &quot;(%.1f)&quot;, cooked[data-&gt;tab]);</a>
<a name="ln979"> </a>
<a name="ln980">    dtgtk_gradient_slider_multivalue_set_picker_meanminmax(</a>
<a name="ln981">        DTGTK_GRADIENT_SLIDER(widget), picker_mean[data-&gt;tab], picker_min[data-&gt;tab], picker_max[data-&gt;tab]);</a>
<a name="ln982">    gtk_label_set_text(label, text);</a>
<a name="ln983">  }</a>
<a name="ln984">  else</a>
<a name="ln985">  {</a>
<a name="ln986">    dtgtk_gradient_slider_multivalue_set_picker(DTGTK_GRADIENT_SLIDER(widget), NAN);</a>
<a name="ln987">    gtk_label_set_text(label, &quot;&quot;);</a>
<a name="ln988">  }</a>
<a name="ln989"> </a>
<a name="ln990">  gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(data-&gt;colorpicker),</a>
<a name="ln991">                               (module-&gt;request_color_pick == DT_REQUEST_COLORPICK_BLEND ? 1 : 0));</a>
<a name="ln992"> </a>
<a name="ln993">  darktable.gui-&gt;reset = 0;</a>
<a name="ln994"> </a>
<a name="ln995">  return FALSE;</a>
<a name="ln996">}</a>
<a name="ln997"> </a>
<a name="ln998">// magic mode: if mouse curser enters a gradient slider with shift and/or control pressed we</a>
<a name="ln999">// enter channel display and/or mask display mode</a>
<a name="ln1000">static gboolean _blendop_blendif_enter(GtkWidget *widget, GdkEventCrossing *event, dt_iop_module_t *module)</a>
<a name="ln1001">{</a>
<a name="ln1002">  if(darktable.gui-&gt;reset) return FALSE;</a>
<a name="ln1003">  dt_iop_gui_blend_data_t *data = module-&gt;blend_data;</a>
<a name="ln1004"> </a>
<a name="ln1005">  dt_pthread_mutex_lock(&amp;data-&gt;lock);</a>
<a name="ln1006">  if(data-&gt;timeout_handle)</a>
<a name="ln1007">  {</a>
<a name="ln1008">    // purge any remaining timeout handlers</a>
<a name="ln1009">    g_source_remove(data-&gt;timeout_handle);</a>
<a name="ln1010">    data-&gt;timeout_handle = 0;</a>
<a name="ln1011">  }</a>
<a name="ln1012">  else</a>
<a name="ln1013">  {</a>
<a name="ln1014">    // save request_mask_display to restore later</a>
<a name="ln1015">    data-&gt;save_for_leave = module-&gt;request_mask_display;</a>
<a name="ln1016">  }</a>
<a name="ln1017">  dt_pthread_mutex_unlock(&amp;data-&gt;lock);</a>
<a name="ln1018"> </a>
<a name="ln1019">  dt_dev_pixelpipe_display_mask_t new_request_mask_display = module-&gt;request_mask_display;</a>
<a name="ln1020"> </a>
<a name="ln1021">  // depending on shift modifiers we activate channel and/or mask display</a>
<a name="ln1022">  GdkModifierType modifiers = gtk_accelerator_get_default_mod_mask();</a>
<a name="ln1023">  if((event-&gt;state &amp; modifiers) == (GDK_SHIFT_MASK | GDK_CONTROL_MASK))</a>
<a name="ln1024">  {</a>
<a name="ln1025">    new_request_mask_display |= (DT_DEV_PIXELPIPE_DISPLAY_MASK | DT_DEV_PIXELPIPE_DISPLAY_CHANNEL);</a>
<a name="ln1026">  }</a>
<a name="ln1027">  else if((event-&gt;state &amp; modifiers) == GDK_SHIFT_MASK)</a>
<a name="ln1028">  {</a>
<a name="ln1029">    new_request_mask_display |= DT_DEV_PIXELPIPE_DISPLAY_CHANNEL;</a>
<a name="ln1030">  }</a>
<a name="ln1031">  else if((event-&gt;state &amp; modifiers) == GDK_CONTROL_MASK)</a>
<a name="ln1032">  {</a>
<a name="ln1033">    new_request_mask_display |= DT_DEV_PIXELPIPE_DISPLAY_MASK;</a>
<a name="ln1034">  }</a>
<a name="ln1035"> </a>
<a name="ln1036">  // in case user requests channel display: get the cannel</a>
<a name="ln1037">  if(new_request_mask_display &amp; DT_DEV_PIXELPIPE_DISPLAY_CHANNEL)</a>
<a name="ln1038">  {</a>
<a name="ln1039">    int tab = data-&gt;tab;</a>
<a name="ln1040">    int inout = (widget == GTK_WIDGET(data-&gt;lower_slider)) ? 0 : 1;</a>
<a name="ln1041">    dt_dev_pixelpipe_display_mask_t channel = data-&gt;display_channel[tab][inout];</a>
<a name="ln1042"> </a>
<a name="ln1043">    new_request_mask_display &amp;= ~DT_DEV_PIXELPIPE_DISPLAY_ANY;</a>
<a name="ln1044">    new_request_mask_display |= channel;</a>
<a name="ln1045">  }</a>
<a name="ln1046"> </a>
<a name="ln1047">  // only if something has changed: reprocess center view</a>
<a name="ln1048">  if(new_request_mask_display != module-&gt;request_mask_display)</a>
<a name="ln1049">  {</a>
<a name="ln1050">    module-&gt;request_mask_display = new_request_mask_display;</a>
<a name="ln1051">    dt_dev_reprocess_all(module-&gt;dev);</a>
<a name="ln1052">  }</a>
<a name="ln1053"> </a>
<a name="ln1054">  return TRUE;</a>
<a name="ln1055">}</a>
<a name="ln1056"> </a>
<a name="ln1057">// handler for delayed mask/channel display mode switch-off</a>
<a name="ln1058">static gboolean _blendop_blendif_leave_delayed(gpointer data)</a>
<a name="ln1059">{</a>
<a name="ln1060">  dt_iop_module_t *module = (dt_iop_module_t *)data;</a>
<a name="ln1061">  dt_iop_gui_blend_data_t *bd = module-&gt;blend_data;</a>
<a name="ln1062"> </a>
<a name="ln1063">  dt_pthread_mutex_lock(&amp;bd-&gt;lock);</a>
<a name="ln1064">  // restore saved request_mask_display and reprocess image</a>
<a name="ln1065">  if(bd-&gt;timeout_handle &amp;&amp; (module-&gt;request_mask_display != bd-&gt;save_for_leave))</a>
<a name="ln1066">  {</a>
<a name="ln1067">    module-&gt;request_mask_display = bd-&gt;save_for_leave;</a>
<a name="ln1068">    dt_dev_reprocess_all(module-&gt;dev);</a>
<a name="ln1069">  }</a>
<a name="ln1070"> </a>
<a name="ln1071">  bd-&gt;timeout_handle = 0;</a>
<a name="ln1072">  dt_pthread_mutex_unlock(&amp;bd-&gt;lock);</a>
<a name="ln1073"> </a>
<a name="ln1074">  // return FALSE and thereby terminate the handler</a>
<a name="ln1075">  return FALSE;</a>
<a name="ln1076">}</a>
<a name="ln1077"> </a>
<a name="ln1078">// de-activate magic mode when leaving the gradient slider</a>
<a name="ln1079">static gboolean _blendop_blendif_leave(GtkWidget *widget, GdkEventCrossing *event, dt_iop_module_t *module)</a>
<a name="ln1080">{</a>
<a name="ln1081">  if(darktable.gui-&gt;reset) return FALSE;</a>
<a name="ln1082">  dt_iop_gui_blend_data_t *data = module-&gt;blend_data;</a>
<a name="ln1083"> </a>
<a name="ln1084">  if(module-&gt;request_mask_display &amp; (DT_DEV_PIXELPIPE_DISPLAY_MASK | DT_DEV_PIXELPIPE_DISPLAY_CHANNEL))</a>
<a name="ln1085">  {</a>
<a name="ln1086">    // do not immediately switch-off mask/channel display in case user leaves gradient only briefly.</a>
<a name="ln1087">    // instead we activate a handler function that gets triggered after some timeout</a>
<a name="ln1088">    dt_pthread_mutex_lock(&amp;data-&gt;lock);</a>
<a name="ln1089">    if(!data-&gt;timeout_handle &amp;&amp; (module-&gt;request_mask_display != data-&gt;save_for_leave))</a>
<a name="ln1090">      data-&gt;timeout_handle = g_timeout_add(1000, _blendop_blendif_leave_delayed, module);</a>
<a name="ln1091">    dt_pthread_mutex_unlock(&amp;data-&gt;lock);</a>
<a name="ln1092">  }</a>
<a name="ln1093"> </a>
<a name="ln1094">  return TRUE;</a>
<a name="ln1095">}</a>
<a name="ln1096"> </a>
<a name="ln1097"> </a>
<a name="ln1098">void dt_iop_gui_update_blendif(dt_iop_module_t *module)</a>
<a name="ln1099">{</a>
<a name="ln1100">  dt_iop_gui_blend_data_t *data = module-&gt;blend_data;</a>
<a name="ln1101">  dt_develop_blend_params_t *bp = module-&gt;blend_params;</a>
<a name="ln1102">  dt_develop_blend_params_t *dp = module-&gt;default_blendop_params;</a>
<a name="ln1103"> </a>
<a name="ln1104">  if(!data || !data-&gt;blendif_support || !data-&gt;blendif_inited) return;</a>
<a name="ln1105"> </a>
<a name="ln1106">  dt_pthread_mutex_lock(&amp;data-&gt;lock);</a>
<a name="ln1107">  if(data-&gt;timeout_handle)</a>
<a name="ln1108">  {</a>
<a name="ln1109">    g_source_remove(data-&gt;timeout_handle);</a>
<a name="ln1110">    data-&gt;timeout_handle = 0;</a>
<a name="ln1111">    if(module-&gt;request_mask_display != data-&gt;save_for_leave)</a>
<a name="ln1112">    {</a>
<a name="ln1113">      module-&gt;request_mask_display = data-&gt;save_for_leave;</a>
<a name="ln1114">      dt_dev_reprocess_all(module-&gt;dev);</a>
<a name="ln1115">    }</a>
<a name="ln1116">  }</a>
<a name="ln1117">  dt_pthread_mutex_unlock(&amp;data-&gt;lock);</a>
<a name="ln1118"> </a>
<a name="ln1119">  int tab = data-&gt;tab;</a>
<a name="ln1120">  int in_ch = data-&gt;channels[tab][0];</a>
<a name="ln1121">  int out_ch = data-&gt;channels[tab][1];</a>
<a name="ln1122"> </a>
<a name="ln1123">  float *iparameters = &amp;(bp-&gt;blendif_parameters[4 * in_ch]);</a>
<a name="ln1124">  float *oparameters = &amp;(bp-&gt;blendif_parameters[4 * out_ch]);</a>
<a name="ln1125">  float *idefaults = &amp;(dp-&gt;blendif_parameters[4 * in_ch]);</a>
<a name="ln1126">  float *odefaults = &amp;(dp-&gt;blendif_parameters[4 * out_ch]);</a>
<a name="ln1127"> </a>
<a name="ln1128">  int ipolarity = !(bp-&gt;blendif &amp; (1 &lt;&lt; (in_ch + 16)));</a>
<a name="ln1129">  int opolarity = !(bp-&gt;blendif &amp; (1 &lt;&lt; (out_ch + 16)));</a>
<a name="ln1130">  char text[256];</a>
<a name="ln1131"> </a>
<a name="ln1132">  int reset = darktable.gui-&gt;reset;</a>
<a name="ln1133">  darktable.gui-&gt;reset = 1;</a>
<a name="ln1134"> </a>
<a name="ln1135">  gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(data-&gt;lower_polarity), ipolarity);</a>
<a name="ln1136">  gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(data-&gt;upper_polarity), opolarity);</a>
<a name="ln1137"> </a>
<a name="ln1138">  dtgtk_gradient_slider_multivalue_set_marker(</a>
<a name="ln1139">      data-&gt;lower_slider,</a>
<a name="ln1140">      ipolarity ? GRADIENT_SLIDER_MARKER_LOWER_OPEN_BIG : GRADIENT_SLIDER_MARKER_UPPER_OPEN_BIG, 0);</a>
<a name="ln1141">  dtgtk_gradient_slider_multivalue_set_marker(</a>
<a name="ln1142">      data-&gt;lower_slider,</a>
<a name="ln1143">      ipolarity ? GRADIENT_SLIDER_MARKER_UPPER_FILLED_BIG : GRADIENT_SLIDER_MARKER_LOWER_FILLED_BIG, 1);</a>
<a name="ln1144">  dtgtk_gradient_slider_multivalue_set_marker(</a>
<a name="ln1145">      data-&gt;lower_slider,</a>
<a name="ln1146">      ipolarity ? GRADIENT_SLIDER_MARKER_UPPER_FILLED_BIG : GRADIENT_SLIDER_MARKER_LOWER_FILLED_BIG, 2);</a>
<a name="ln1147">  dtgtk_gradient_slider_multivalue_set_marker(</a>
<a name="ln1148">      data-&gt;lower_slider,</a>
<a name="ln1149">      ipolarity ? GRADIENT_SLIDER_MARKER_LOWER_OPEN_BIG : GRADIENT_SLIDER_MARKER_UPPER_OPEN_BIG, 3);</a>
<a name="ln1150"> </a>
<a name="ln1151">  dtgtk_gradient_slider_multivalue_set_marker(</a>
<a name="ln1152">      data-&gt;upper_slider,</a>
<a name="ln1153">      opolarity ? GRADIENT_SLIDER_MARKER_LOWER_OPEN_BIG : GRADIENT_SLIDER_MARKER_UPPER_OPEN_BIG, 0);</a>
<a name="ln1154">  dtgtk_gradient_slider_multivalue_set_marker(</a>
<a name="ln1155">      data-&gt;upper_slider,</a>
<a name="ln1156">      opolarity ? GRADIENT_SLIDER_MARKER_UPPER_FILLED_BIG : GRADIENT_SLIDER_MARKER_LOWER_FILLED_BIG, 1);</a>
<a name="ln1157">  dtgtk_gradient_slider_multivalue_set_marker(</a>
<a name="ln1158">      data-&gt;upper_slider,</a>
<a name="ln1159">      opolarity ? GRADIENT_SLIDER_MARKER_UPPER_FILLED_BIG : GRADIENT_SLIDER_MARKER_LOWER_FILLED_BIG, 2);</a>
<a name="ln1160">  dtgtk_gradient_slider_multivalue_set_marker(</a>
<a name="ln1161">      data-&gt;upper_slider,</a>
<a name="ln1162">      opolarity ? GRADIENT_SLIDER_MARKER_LOWER_OPEN_BIG : GRADIENT_SLIDER_MARKER_UPPER_OPEN_BIG, 3);</a>
<a name="ln1163"> </a>
<a name="ln1164">  for(int k = 0; k &lt; 4; k++)</a>
<a name="ln1165">  {</a>
<a name="ln1166">    dtgtk_gradient_slider_multivalue_set_value(data-&gt;lower_slider, iparameters[k], k);</a>
<a name="ln1167">    dtgtk_gradient_slider_multivalue_set_value(data-&gt;upper_slider, oparameters[k], k);</a>
<a name="ln1168">    dtgtk_gradient_slider_multivalue_set_resetvalue(data-&gt;lower_slider, idefaults[k], k);</a>
<a name="ln1169">    dtgtk_gradient_slider_multivalue_set_resetvalue(data-&gt;upper_slider, odefaults[k], k);</a>
<a name="ln1170">  }</a>
<a name="ln1171"> </a>
<a name="ln1172">  for(int k = 0; k &lt; 4; k++)</a>
<a name="ln1173">  {</a>
<a name="ln1174">    (data-&gt;scale_print[tab])(iparameters[k], text, sizeof(text));</a>
<a name="ln1175">    gtk_label_set_text(data-&gt;lower_label[k], text);</a>
<a name="ln1176">    (data-&gt;scale_print[tab])(oparameters[k], text, sizeof(text));</a>
<a name="ln1177">    gtk_label_set_text(data-&gt;upper_label[k], text);</a>
<a name="ln1178">  }</a>
<a name="ln1179"> </a>
<a name="ln1180">  dtgtk_gradient_slider_multivalue_clear_stops(data-&gt;lower_slider);</a>
<a name="ln1181">  dtgtk_gradient_slider_multivalue_clear_stops(data-&gt;upper_slider);</a>
<a name="ln1182"> </a>
<a name="ln1183">  for(int k = 0; k &lt; data-&gt;numberstops[tab]; k++)</a>
<a name="ln1184">  {</a>
<a name="ln1185">    dtgtk_gradient_slider_multivalue_set_stop(data-&gt;lower_slider, (data-&gt;colorstops[tab])[k].stoppoint,</a>
<a name="ln1186">                                              (data-&gt;colorstops[tab])[k].color);</a>
<a name="ln1187">    dtgtk_gradient_slider_multivalue_set_stop(data-&gt;upper_slider, (data-&gt;colorstops[tab])[k].stoppoint,</a>
<a name="ln1188">                                              (data-&gt;colorstops[tab])[k].color);</a>
<a name="ln1189">  }</a>
<a name="ln1190"> </a>
<a name="ln1191">  dtgtk_gradient_slider_multivalue_set_increment(data-&gt;lower_slider, data-&gt;increments[tab]);</a>
<a name="ln1192">  dtgtk_gradient_slider_multivalue_set_increment(data-&gt;upper_slider, data-&gt;increments[tab]);</a>
<a name="ln1193"> </a>
<a name="ln1194">  darktable.gui-&gt;reset = reset;</a>
<a name="ln1195">}</a>
<a name="ln1196"> </a>
<a name="ln1197"> </a>
<a name="ln1198">void dt_iop_gui_init_blendif(GtkBox *blendw, dt_iop_module_t *module)</a>
<a name="ln1199">{</a>
<a name="ln1200">  dt_iop_gui_blend_data_t *bd = (dt_iop_gui_blend_data_t *)module-&gt;blend_data;</a>
<a name="ln1201"> </a>
<a name="ln1202">  bd-&gt;blendif_box = GTK_BOX(gtk_box_new(GTK_ORIENTATION_VERTICAL, DT_BAUHAUS_SPACE));</a>
<a name="ln1203">  // add event box so that one can click into the area to get help for parametric masks</a>
<a name="ln1204">  GtkWidget* event_box = gtk_event_box_new();</a>
<a name="ln1205">  dt_gui_add_help_link(GTK_WIDGET(event_box), &quot;parametric_mask.html&quot;);</a>
<a name="ln1206">  gtk_container_add(GTK_CONTAINER(blendw), event_box);</a>
<a name="ln1207"> </a>
<a name="ln1208">  /* create and add blendif support if module supports it */</a>
<a name="ln1209">  if(bd-&gt;blendif_support)</a>
<a name="ln1210">  {</a>
<a name="ln1211">    char *Lab_labels[] = { &quot;  L  &quot;, &quot;  a  &quot;, &quot;  b  &quot;, &quot; C &quot;, &quot; h &quot; };</a>
<a name="ln1212">    char *Lab_tooltips[]</a>
<a name="ln1213">        = { _(&quot;sliders for L channel&quot;), _(&quot;sliders for a channel&quot;), _(&quot;sliders for b channel&quot;),</a>
<a name="ln1214">            _(&quot;sliders for chroma channel (of LCh)&quot;), _(&quot;sliders for hue channel (of LCh)&quot;) };</a>
<a name="ln1215">    char *rgb_labels[] = { _(&quot; g &quot;), _(&quot; R &quot;), _(&quot; G &quot;), _(&quot; B &quot;), _(&quot; H &quot;), _(&quot; S &quot;), _(&quot; L &quot;) };</a>
<a name="ln1216">    char *rgb_tooltips[]</a>
<a name="ln1217">        = { _(&quot;sliders for gray value&quot;), _(&quot;sliders for red channel&quot;), _(&quot;sliders for green channel&quot;),</a>
<a name="ln1218">            _(&quot;sliders for blue channel&quot;), _(&quot;sliders for hue channel (of HSL)&quot;),</a>
<a name="ln1219">            _(&quot;sliders for chroma channel (of HSL)&quot;), _(&quot;sliders for value channel (of HSL)&quot;) };</a>
<a name="ln1220"> </a>
<a name="ln1221">    char *ttinput = _(&quot;adjustment based on input received by this module:\n* range defined by upper markers: &quot;</a>
<a name="ln1222">                      &quot;blend fully\n* range defined by lower markers: do not blend at all\n* range between &quot;</a>
<a name="ln1223">                      &quot;adjacent upper/lower markers: blend gradually&quot;);</a>
<a name="ln1224"> </a>
<a name="ln1225">    char *ttoutput = _(&quot;adjustment based on unblended output of this module:\n* range defined by upper &quot;</a>
<a name="ln1226">                       &quot;markers: blend fully\n* range defined by lower markers: do not blend at all\n* range &quot;</a>
<a name="ln1227">                       &quot;between adjacent upper/lower markers: blend gradually&quot;);</a>
<a name="ln1228"> </a>
<a name="ln1229">    bd-&gt;tab = 0;</a>
<a name="ln1230">    const int bs = DT_PIXEL_APPLY_DPI(14);</a>
<a name="ln1231"> </a>
<a name="ln1232">    int maxchannels = 0;</a>
<a name="ln1233">    char **labels = NULL;</a>
<a name="ln1234">    char **tooltips = NULL;</a>
<a name="ln1235"> </a>
<a name="ln1236">    switch(bd-&gt;csp)</a>
<a name="ln1237">    {</a>
<a name="ln1238">      case iop_cs_Lab:</a>
<a name="ln1239">        maxchannels = 5;</a>
<a name="ln1240">        labels = Lab_labels;</a>
<a name="ln1241">        tooltips = Lab_tooltips;</a>
<a name="ln1242">        bd-&gt;scale_print[0] = _blendif_scale_print_L;</a>
<a name="ln1243">        bd-&gt;scale_print[1] = _blendif_scale_print_ab;</a>
<a name="ln1244">        bd-&gt;scale_print[2] = _blendif_scale_print_ab;</a>
<a name="ln1245">        bd-&gt;scale_print[3] = _blendif_scale_print_default;</a>
<a name="ln1246">        bd-&gt;scale_print[4] = _blendif_scale_print_hue;</a>
<a name="ln1247">        bd-&gt;increments[0] = 1.0f / 100.0f;</a>
<a name="ln1248">        bd-&gt;increments[1] = 1.0f / 256.0f;</a>
<a name="ln1249">        bd-&gt;increments[2] = 1.0f / 256.0f;</a>
<a name="ln1250">        bd-&gt;increments[3] = 1.0f / 100.0f;</a>
<a name="ln1251">        bd-&gt;increments[4] = 1.0f / 360.0f;</a>
<a name="ln1252">        bd-&gt;channels[0][0] = DEVELOP_BLENDIF_L_in;</a>
<a name="ln1253">        bd-&gt;channels[0][1] = DEVELOP_BLENDIF_L_out;</a>
<a name="ln1254">        bd-&gt;channels[1][0] = DEVELOP_BLENDIF_A_in;</a>
<a name="ln1255">        bd-&gt;channels[1][1] = DEVELOP_BLENDIF_A_out;</a>
<a name="ln1256">        bd-&gt;channels[2][0] = DEVELOP_BLENDIF_B_in;</a>
<a name="ln1257">        bd-&gt;channels[2][1] = DEVELOP_BLENDIF_B_out;</a>
<a name="ln1258">        bd-&gt;channels[3][0] = DEVELOP_BLENDIF_C_in;</a>
<a name="ln1259">        bd-&gt;channels[3][1] = DEVELOP_BLENDIF_C_out;</a>
<a name="ln1260">        bd-&gt;channels[4][0] = DEVELOP_BLENDIF_h_in;</a>
<a name="ln1261">        bd-&gt;channels[4][1] = DEVELOP_BLENDIF_h_out;</a>
<a name="ln1262">        bd-&gt;display_channel[0][0] = DT_DEV_PIXELPIPE_DISPLAY_L;</a>
<a name="ln1263">        bd-&gt;display_channel[0][1] = DT_DEV_PIXELPIPE_DISPLAY_L | DT_DEV_PIXELPIPE_DISPLAY_OUTPUT;</a>
<a name="ln1264">        bd-&gt;display_channel[1][0] = DT_DEV_PIXELPIPE_DISPLAY_a;</a>
<a name="ln1265">        bd-&gt;display_channel[1][1] = DT_DEV_PIXELPIPE_DISPLAY_a | DT_DEV_PIXELPIPE_DISPLAY_OUTPUT;</a>
<a name="ln1266">        bd-&gt;display_channel[2][0] = DT_DEV_PIXELPIPE_DISPLAY_b;</a>
<a name="ln1267">        bd-&gt;display_channel[2][1] = DT_DEV_PIXELPIPE_DISPLAY_b | DT_DEV_PIXELPIPE_DISPLAY_OUTPUT;</a>
<a name="ln1268">        bd-&gt;display_channel[3][0] = DT_DEV_PIXELPIPE_DISPLAY_LCH_C;</a>
<a name="ln1269">        bd-&gt;display_channel[3][1] = DT_DEV_PIXELPIPE_DISPLAY_LCH_C | DT_DEV_PIXELPIPE_DISPLAY_OUTPUT;</a>
<a name="ln1270">        bd-&gt;display_channel[4][0] = DT_DEV_PIXELPIPE_DISPLAY_LCH_h;</a>
<a name="ln1271">        bd-&gt;display_channel[4][1] = DT_DEV_PIXELPIPE_DISPLAY_LCH_h | DT_DEV_PIXELPIPE_DISPLAY_OUTPUT;</a>
<a name="ln1272">        bd-&gt;colorstops[0] = _gradient_L;</a>
<a name="ln1273">        bd-&gt;numberstops[0] = sizeof(_gradient_L) / sizeof(dt_iop_gui_blendif_colorstop_t);</a>
<a name="ln1274">        bd-&gt;colorstops[1] = _gradient_a;</a>
<a name="ln1275">        bd-&gt;numberstops[1] = sizeof(_gradient_a) / sizeof(dt_iop_gui_blendif_colorstop_t);</a>
<a name="ln1276">        bd-&gt;colorstops[2] = _gradient_b;</a>
<a name="ln1277">        bd-&gt;numberstops[2] = sizeof(_gradient_b) / sizeof(dt_iop_gui_blendif_colorstop_t);</a>
<a name="ln1278">        bd-&gt;colorstops[3] = _gradient_chroma;</a>
<a name="ln1279">        bd-&gt;numberstops[3] = sizeof(_gradient_chroma) / sizeof(dt_iop_gui_blendif_colorstop_t);</a>
<a name="ln1280">        bd-&gt;colorstops[4] = _gradient_hue;</a>
<a name="ln1281">        bd-&gt;numberstops[4] = sizeof(_gradient_hue) / sizeof(dt_iop_gui_blendif_colorstop_t);</a>
<a name="ln1282">        break;</a>
<a name="ln1283">      case iop_cs_rgb:</a>
<a name="ln1284">        maxchannels = 7;</a>
<a name="ln1285">        labels = rgb_labels;</a>
<a name="ln1286">        tooltips = rgb_tooltips;</a>
<a name="ln1287">        bd-&gt;scale_print[0] = _blendif_scale_print_rgb;</a>
<a name="ln1288">        bd-&gt;scale_print[1] = _blendif_scale_print_rgb;</a>
<a name="ln1289">        bd-&gt;scale_print[2] = _blendif_scale_print_rgb;</a>
<a name="ln1290">        bd-&gt;scale_print[3] = _blendif_scale_print_rgb;</a>
<a name="ln1291">        bd-&gt;scale_print[4] = _blendif_scale_print_hue;</a>
<a name="ln1292">        bd-&gt;scale_print[5] = _blendif_scale_print_default;</a>
<a name="ln1293">        bd-&gt;scale_print[6] = _blendif_scale_print_L;</a>
<a name="ln1294">        bd-&gt;increments[0] = 1.0f / 255.0f;</a>
<a name="ln1295">        bd-&gt;increments[1] = 1.0f / 255.0f;</a>
<a name="ln1296">        bd-&gt;increments[2] = 1.0f / 255.0f;</a>
<a name="ln1297">        bd-&gt;increments[3] = 1.0f / 255.0f;</a>
<a name="ln1298">        bd-&gt;increments[4] = 1.0f / 360.0f;</a>
<a name="ln1299">        bd-&gt;increments[5] = 1.0f / 100.0f;</a>
<a name="ln1300">        bd-&gt;increments[6] = 1.0f / 100.0f;</a>
<a name="ln1301">        bd-&gt;channels[0][0] = DEVELOP_BLENDIF_GRAY_in;</a>
<a name="ln1302">        bd-&gt;channels[0][1] = DEVELOP_BLENDIF_GRAY_out;</a>
<a name="ln1303">        bd-&gt;channels[1][0] = DEVELOP_BLENDIF_RED_in;</a>
<a name="ln1304">        bd-&gt;channels[1][1] = DEVELOP_BLENDIF_RED_out;</a>
<a name="ln1305">        bd-&gt;channels[2][0] = DEVELOP_BLENDIF_GREEN_in;</a>
<a name="ln1306">        bd-&gt;channels[2][1] = DEVELOP_BLENDIF_GREEN_out;</a>
<a name="ln1307">        bd-&gt;channels[3][0] = DEVELOP_BLENDIF_BLUE_in;</a>
<a name="ln1308">        bd-&gt;channels[3][1] = DEVELOP_BLENDIF_BLUE_out;</a>
<a name="ln1309">        bd-&gt;channels[4][0] = DEVELOP_BLENDIF_H_in;</a>
<a name="ln1310">        bd-&gt;channels[4][1] = DEVELOP_BLENDIF_H_out;</a>
<a name="ln1311">        bd-&gt;channels[5][0] = DEVELOP_BLENDIF_S_in;</a>
<a name="ln1312">        bd-&gt;channels[5][1] = DEVELOP_BLENDIF_S_out;</a>
<a name="ln1313">        bd-&gt;channels[6][0] = DEVELOP_BLENDIF_l_in;</a>
<a name="ln1314">        bd-&gt;channels[6][1] = DEVELOP_BLENDIF_l_out;</a>
<a name="ln1315">        bd-&gt;display_channel[0][0] = DT_DEV_PIXELPIPE_DISPLAY_GRAY;</a>
<a name="ln1316">        bd-&gt;display_channel[0][1] = DT_DEV_PIXELPIPE_DISPLAY_GRAY | DT_DEV_PIXELPIPE_DISPLAY_OUTPUT;</a>
<a name="ln1317">        bd-&gt;display_channel[1][0] = DT_DEV_PIXELPIPE_DISPLAY_R;</a>
<a name="ln1318">        bd-&gt;display_channel[1][1] = DT_DEV_PIXELPIPE_DISPLAY_R | DT_DEV_PIXELPIPE_DISPLAY_OUTPUT;</a>
<a name="ln1319">        bd-&gt;display_channel[2][0] = DT_DEV_PIXELPIPE_DISPLAY_G;</a>
<a name="ln1320">        bd-&gt;display_channel[2][1] = DT_DEV_PIXELPIPE_DISPLAY_G | DT_DEV_PIXELPIPE_DISPLAY_OUTPUT;</a>
<a name="ln1321">        bd-&gt;display_channel[3][0] = DT_DEV_PIXELPIPE_DISPLAY_B;</a>
<a name="ln1322">        bd-&gt;display_channel[3][1] = DT_DEV_PIXELPIPE_DISPLAY_B | DT_DEV_PIXELPIPE_DISPLAY_OUTPUT;</a>
<a name="ln1323">        bd-&gt;display_channel[4][0] = DT_DEV_PIXELPIPE_DISPLAY_HSL_H;</a>
<a name="ln1324">        bd-&gt;display_channel[4][1] = DT_DEV_PIXELPIPE_DISPLAY_HSL_H | DT_DEV_PIXELPIPE_DISPLAY_OUTPUT;</a>
<a name="ln1325">        bd-&gt;display_channel[5][0] = DT_DEV_PIXELPIPE_DISPLAY_HSL_S;</a>
<a name="ln1326">        bd-&gt;display_channel[5][1] = DT_DEV_PIXELPIPE_DISPLAY_HSL_S | DT_DEV_PIXELPIPE_DISPLAY_OUTPUT;</a>
<a name="ln1327">        bd-&gt;display_channel[6][0] = DT_DEV_PIXELPIPE_DISPLAY_HSL_l;</a>
<a name="ln1328">        bd-&gt;display_channel[6][1] = DT_DEV_PIXELPIPE_DISPLAY_HSL_l | DT_DEV_PIXELPIPE_DISPLAY_OUTPUT;</a>
<a name="ln1329">        bd-&gt;colorstops[0] = _gradient_gray;</a>
<a name="ln1330">        bd-&gt;numberstops[0] = sizeof(_gradient_gray) / sizeof(dt_iop_gui_blendif_colorstop_t);</a>
<a name="ln1331">        bd-&gt;colorstops[1] = _gradient_red;</a>
<a name="ln1332">        bd-&gt;numberstops[1] = sizeof(_gradient_red) / sizeof(dt_iop_gui_blendif_colorstop_t);</a>
<a name="ln1333">        bd-&gt;colorstops[2] = _gradient_green;</a>
<a name="ln1334">        bd-&gt;numberstops[2] = sizeof(_gradient_green) / sizeof(dt_iop_gui_blendif_colorstop_t);</a>
<a name="ln1335">        bd-&gt;colorstops[3] = _gradient_blue;</a>
<a name="ln1336">        bd-&gt;numberstops[3] = sizeof(_gradient_blue) / sizeof(dt_iop_gui_blendif_colorstop_t);</a>
<a name="ln1337">        bd-&gt;colorstops[4] = _gradient_HUE;</a>
<a name="ln1338">        bd-&gt;numberstops[4] = sizeof(_gradient_HUE) / sizeof(dt_iop_gui_blendif_colorstop_t);</a>
<a name="ln1339">        bd-&gt;colorstops[5] = _gradient_chroma;</a>
<a name="ln1340">        bd-&gt;numberstops[5] = sizeof(_gradient_chroma) / sizeof(dt_iop_gui_blendif_colorstop_t);</a>
<a name="ln1341">        bd-&gt;colorstops[6] = _gradient_gray;</a>
<a name="ln1342">        bd-&gt;numberstops[6] = sizeof(_gradient_gray) / sizeof(dt_iop_gui_blendif_colorstop_t);</a>
<a name="ln1343">        break;</a>
<a name="ln1344">      default:</a>
<a name="ln1345">        assert(FALSE); // blendif not supported for RAW, which is already caught upstream; we should not get</a>
<a name="ln1346">                       // here</a>
<a name="ln1347">    }</a>
<a name="ln1348"> </a>
<a name="ln1349">    GtkWidget *uplabel = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0);</a>
<a name="ln1350">    GtkWidget *lowlabel = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0);</a>
<a name="ln1351">    GtkWidget *upslider = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, DT_PIXEL_APPLY_DPI(5));</a>
<a name="ln1352">    GtkWidget *lowslider = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, DT_PIXEL_APPLY_DPI(5));</a>
<a name="ln1353">    GtkWidget *notebook = gtk_box_new(GTK_ORIENTATION_VERTICAL, 0);</a>
<a name="ln1354">    GtkWidget *header = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, DT_PIXEL_APPLY_DPI(5));</a>
<a name="ln1355"> </a>
<a name="ln1356">    bd-&gt;channel_tabs = GTK_NOTEBOOK(gtk_notebook_new());</a>
<a name="ln1357"> </a>
<a name="ln1358">    for(int ch = 0; ch &lt; maxchannels; ch++)</a>
<a name="ln1359">    {</a>
<a name="ln1360">      gtk_notebook_append_page(GTK_NOTEBOOK(bd-&gt;channel_tabs),</a>
<a name="ln1361">                               GTK_WIDGET(gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0)),</a>
<a name="ln1362">                               gtk_label_new(labels[ch]));</a>
<a name="ln1363">      gtk_widget_set_tooltip_text(gtk_notebook_get_tab_label(bd-&gt;channel_tabs,</a>
<a name="ln1364">                                                             gtk_notebook_get_nth_page(bd-&gt;channel_tabs, -1)),</a>
<a name="ln1365">                                  tooltips[ch]);</a>
<a name="ln1366">    }</a>
<a name="ln1367"> </a>
<a name="ln1368">    gtk_widget_show_all(GTK_WIDGET(gtk_notebook_get_nth_page(bd-&gt;channel_tabs, bd-&gt;tab)));</a>
<a name="ln1369">    gtk_notebook_set_current_page(GTK_NOTEBOOK(bd-&gt;channel_tabs), bd-&gt;tab);</a>
<a name="ln1370">    gtk_notebook_set_scrollable(bd-&gt;channel_tabs, TRUE);</a>
<a name="ln1371"> </a>
<a name="ln1372">    gtk_box_pack_start(GTK_BOX(notebook), GTK_WIDGET(bd-&gt;channel_tabs), FALSE, FALSE, 0);</a>
<a name="ln1373"> </a>
<a name="ln1374">    bd-&gt;colorpicker</a>
<a name="ln1375">        = dtgtk_togglebutton_new(dtgtk_cairo_paint_colorpicker, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln1376">    gtk_widget_set_tooltip_text(bd-&gt;colorpicker, _(&quot;pick GUI color from image&quot;));</a>
<a name="ln1377">    gtk_widget_set_size_request(GTK_WIDGET(bd-&gt;colorpicker), bs, bs);</a>
<a name="ln1378"> </a>
<a name="ln1379">    GtkWidget *res = dtgtk_button_new(dtgtk_cairo_paint_reset, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln1380">    gtk_widget_set_tooltip_text(res, _(&quot;reset blend mask settings&quot;));</a>
<a name="ln1381">    gtk_widget_set_size_request(res, bs, bs);</a>
<a name="ln1382"> </a>
<a name="ln1383">    GtkWidget *inv = dtgtk_button_new(dtgtk_cairo_paint_invert, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln1384">    gtk_widget_set_tooltip_text(inv, _(&quot;invert all channel's polarities&quot;));</a>
<a name="ln1385">    gtk_widget_set_size_request(inv, bs, bs);</a>
<a name="ln1386"> </a>
<a name="ln1387">    gtk_box_pack_start(GTK_BOX(header), GTK_WIDGET(notebook), TRUE, TRUE, 0);</a>
<a name="ln1388">    gtk_box_pack_end(GTK_BOX(header), GTK_WIDGET(res), FALSE, FALSE, 0);</a>
<a name="ln1389">    gtk_box_pack_end(GTK_BOX(header), GTK_WIDGET(inv), FALSE, FALSE, 0);</a>
<a name="ln1390">    gtk_box_pack_end(GTK_BOX(header), GTK_WIDGET(bd-&gt;colorpicker), FALSE, FALSE, 0);</a>
<a name="ln1391"> </a>
<a name="ln1392">    bd-&gt;lower_slider = DTGTK_GRADIENT_SLIDER_MULTIVALUE(dtgtk_gradient_slider_multivalue_new(4));</a>
<a name="ln1393">    bd-&gt;upper_slider = DTGTK_GRADIENT_SLIDER_MULTIVALUE(dtgtk_gradient_slider_multivalue_new(4));</a>
<a name="ln1394"> </a>
<a name="ln1395">    bd-&gt;lower_polarity</a>
<a name="ln1396">        = dtgtk_togglebutton_new(dtgtk_cairo_paint_plusminus, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln1397">    gtk_widget_set_tooltip_text(bd-&gt;lower_polarity, _(&quot;toggle polarity. best seen by enabling 'display mask'&quot;));</a>
<a name="ln1398"> </a>
<a name="ln1399">    bd-&gt;upper_polarity</a>
<a name="ln1400">        = dtgtk_togglebutton_new(dtgtk_cairo_paint_plusminus, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln1401">    gtk_widget_set_tooltip_text(bd-&gt;upper_polarity, _(&quot;toggle polarity. best seen by enabling 'display mask'&quot;));</a>
<a name="ln1402"> </a>
<a name="ln1403">    gtk_box_pack_start(GTK_BOX(upslider), GTK_WIDGET(bd-&gt;upper_slider), TRUE, TRUE, 0);</a>
<a name="ln1404">    gtk_box_pack_end(GTK_BOX(upslider), GTK_WIDGET(bd-&gt;upper_polarity), FALSE, FALSE, 0);</a>
<a name="ln1405"> </a>
<a name="ln1406">    gtk_box_pack_start(GTK_BOX(lowslider), GTK_WIDGET(bd-&gt;lower_slider), TRUE, TRUE, 0);</a>
<a name="ln1407">    gtk_box_pack_end(GTK_BOX(lowslider), GTK_WIDGET(bd-&gt;lower_polarity), FALSE, FALSE, 0);</a>
<a name="ln1408"> </a>
<a name="ln1409"> </a>
<a name="ln1410">    GtkWidget *output = gtk_label_new(_(&quot;output&quot;));</a>
<a name="ln1411">    bd-&gt;upper_picker_label = GTK_LABEL(gtk_label_new(&quot;&quot;));</a>
<a name="ln1412">    gtk_box_pack_start(GTK_BOX(uplabel), GTK_WIDGET(output), FALSE, FALSE, 0);</a>
<a name="ln1413">    gtk_box_pack_start(GTK_BOX(uplabel), GTK_WIDGET(bd-&gt;upper_picker_label), TRUE, TRUE, 0);</a>
<a name="ln1414">    for(int k = 0; k &lt; 4; k++)</a>
<a name="ln1415">    {</a>
<a name="ln1416">      bd-&gt;upper_label[k] = GTK_LABEL(gtk_label_new(NULL));</a>
<a name="ln1417">      gtk_label_set_width_chars(bd-&gt;upper_label[k], 5);</a>
<a name="ln1418">      gtk_box_pack_start(GTK_BOX(uplabel), GTK_WIDGET(bd-&gt;upper_label[k]), FALSE, FALSE, 0);</a>
<a name="ln1419">    }</a>
<a name="ln1420"> </a>
<a name="ln1421">    GtkWidget *input = gtk_label_new(_(&quot;input&quot;));</a>
<a name="ln1422">    bd-&gt;lower_picker_label = GTK_LABEL(gtk_label_new(&quot;&quot;));</a>
<a name="ln1423">    gtk_box_pack_start(GTK_BOX(lowlabel), GTK_WIDGET(input), FALSE, FALSE, 0);</a>
<a name="ln1424">    gtk_box_pack_start(GTK_BOX(lowlabel), GTK_WIDGET(bd-&gt;lower_picker_label), TRUE, TRUE, 0);</a>
<a name="ln1425">    for(int k = 0; k &lt; 4; k++)</a>
<a name="ln1426">    {</a>
<a name="ln1427">      bd-&gt;lower_label[k] = GTK_LABEL(gtk_label_new(NULL));</a>
<a name="ln1428">      gtk_label_set_width_chars(bd-&gt;lower_label[k], 5);</a>
<a name="ln1429">      gtk_box_pack_start(GTK_BOX(lowlabel), GTK_WIDGET(bd-&gt;lower_label[k]), FALSE, FALSE, 0);</a>
<a name="ln1430">    }</a>
<a name="ln1431"> </a>
<a name="ln1432">    gtk_widget_set_tooltip_text(GTK_WIDGET(bd-&gt;lower_slider), _(&quot;double click to reset&quot;));</a>
<a name="ln1433">    gtk_widget_set_tooltip_text(GTK_WIDGET(bd-&gt;upper_slider), _(&quot;double click to reset&quot;));</a>
<a name="ln1434">    gtk_widget_set_tooltip_text(output, ttoutput);</a>
<a name="ln1435">    gtk_widget_set_tooltip_text(input, ttinput);</a>
<a name="ln1436"> </a>
<a name="ln1437">    g_signal_connect(G_OBJECT(bd-&gt;lower_slider), &quot;draw&quot;, G_CALLBACK(_blendop_blendif_draw), module);</a>
<a name="ln1438"> </a>
<a name="ln1439">    g_signal_connect(G_OBJECT(bd-&gt;upper_slider), &quot;draw&quot;, G_CALLBACK(_blendop_blendif_draw), module);</a>
<a name="ln1440"> </a>
<a name="ln1441">    g_signal_connect(G_OBJECT(bd-&gt;channel_tabs), &quot;switch_page&quot;, G_CALLBACK(_blendop_blendif_tab_switch), bd);</a>
<a name="ln1442"> </a>
<a name="ln1443">    g_signal_connect(G_OBJECT(bd-&gt;upper_slider), &quot;value-changed&quot;, G_CALLBACK(_blendop_blendif_upper_callback),</a>
<a name="ln1444">                     bd);</a>
<a name="ln1445"> </a>
<a name="ln1446">    g_signal_connect(G_OBJECT(bd-&gt;lower_slider), &quot;value-changed&quot;, G_CALLBACK(_blendop_blendif_lower_callback),</a>
<a name="ln1447">                     bd);</a>
<a name="ln1448"> </a>
<a name="ln1449">    g_signal_connect(G_OBJECT(bd-&gt;lower_slider), &quot;leave-notify-event&quot;, G_CALLBACK(_blendop_blendif_leave), module);</a>
<a name="ln1450"> </a>
<a name="ln1451">    g_signal_connect(G_OBJECT(bd-&gt;upper_slider), &quot;leave-notify-event&quot;, G_CALLBACK(_blendop_blendif_leave), module);</a>
<a name="ln1452"> </a>
<a name="ln1453">    g_signal_connect(G_OBJECT(bd-&gt;lower_slider), &quot;enter-notify-event&quot;, G_CALLBACK(_blendop_blendif_enter), module);</a>
<a name="ln1454"> </a>
<a name="ln1455">    g_signal_connect(G_OBJECT(bd-&gt;upper_slider), &quot;enter-notify-event&quot;, G_CALLBACK(_blendop_blendif_enter), module);</a>
<a name="ln1456"> </a>
<a name="ln1457">    g_signal_connect(G_OBJECT(bd-&gt;colorpicker), &quot;toggled&quot;, G_CALLBACK(_blendop_blendif_pick_toggled), module);</a>
<a name="ln1458"> </a>
<a name="ln1459">    g_signal_connect(G_OBJECT(res), &quot;clicked&quot;, G_CALLBACK(_blendop_blendif_reset), module);</a>
<a name="ln1460"> </a>
<a name="ln1461">    g_signal_connect(G_OBJECT(inv), &quot;clicked&quot;, G_CALLBACK(_blendop_blendif_invert), module);</a>
<a name="ln1462"> </a>
<a name="ln1463">    g_signal_connect(G_OBJECT(bd-&gt;lower_polarity), &quot;toggled&quot;, G_CALLBACK(_blendop_blendif_polarity_callback),</a>
<a name="ln1464">                     bd);</a>
<a name="ln1465"> </a>
<a name="ln1466">    g_signal_connect(G_OBJECT(bd-&gt;upper_polarity), &quot;toggled&quot;, G_CALLBACK(_blendop_blendif_polarity_callback),</a>
<a name="ln1467">                     bd);</a>
<a name="ln1468"> </a>
<a name="ln1469">    gtk_box_pack_start(GTK_BOX(bd-&gt;blendif_box), dt_ui_section_label_new(_(&quot;parametric mask&quot;)), TRUE, TRUE, 0);</a>
<a name="ln1470">    gtk_box_pack_start(GTK_BOX(bd-&gt;blendif_box), GTK_WIDGET(header), TRUE, FALSE, 0);</a>
<a name="ln1471">    gtk_box_pack_start(GTK_BOX(bd-&gt;blendif_box), GTK_WIDGET(uplabel), TRUE, FALSE, 0);</a>
<a name="ln1472">    gtk_box_pack_start(GTK_BOX(bd-&gt;blendif_box), GTK_WIDGET(upslider), TRUE, FALSE, 0);</a>
<a name="ln1473">    gtk_box_pack_start(GTK_BOX(bd-&gt;blendif_box), GTK_WIDGET(lowlabel), TRUE, FALSE, 0);</a>
<a name="ln1474">    gtk_box_pack_start(GTK_BOX(bd-&gt;blendif_box), GTK_WIDGET(lowslider), TRUE, FALSE, 0);</a>
<a name="ln1475"> </a>
<a name="ln1476">    bd-&gt;blendif_inited = 1;</a>
<a name="ln1477">  }</a>
<a name="ln1478"> </a>
<a name="ln1479">  gtk_container_add(GTK_CONTAINER(event_box), GTK_WIDGET(bd-&gt;blendif_box));</a>
<a name="ln1480">}</a>
<a name="ln1481"> </a>
<a name="ln1482">void dt_iop_gui_update_masks(dt_iop_module_t *module)</a>
<a name="ln1483">{</a>
<a name="ln1484">  dt_iop_gui_blend_data_t *bd = (dt_iop_gui_blend_data_t *)module-&gt;blend_data;</a>
<a name="ln1485">  dt_develop_blend_params_t *bp = module-&gt;blend_params;</a>
<a name="ln1486"> </a>
<a name="ln1487">  if(!bd || !bd-&gt;masks_support || !bd-&gt;masks_inited) return;</a>
<a name="ln1488"> </a>
<a name="ln1489">  /* update masks state */</a>
<a name="ln1490">  dt_masks_form_t *grp = dt_masks_get_from_id(darktable.develop, module-&gt;blend_params-&gt;mask_id);</a>
<a name="ln1491">  dt_bauhaus_combobox_clear(bd-&gt;masks_combo);</a>
<a name="ln1492">  if(grp &amp;&amp; (grp-&gt;type &amp; DT_MASKS_GROUP) &amp;&amp; g_list_length(grp-&gt;points) &gt; 0)</a>
<a name="ln1493">  {</a>
<a name="ln1494">    char txt[512];</a>
<a name="ln1495">    guint n = g_list_length(grp-&gt;points);</a>
<a name="ln1496">    snprintf(txt, sizeof(txt), ngettext(&quot;%d shape used&quot;, &quot;%d shapes used&quot;, n), n);</a>
<a name="ln1497">    dt_bauhaus_combobox_add(bd-&gt;masks_combo, txt);</a>
<a name="ln1498">  }</a>
<a name="ln1499">  else</a>
<a name="ln1500">  {</a>
<a name="ln1501">    dt_bauhaus_combobox_add(bd-&gt;masks_combo, _(&quot;no mask used&quot;));</a>
<a name="ln1502">    bd-&gt;masks_shown = DT_MASKS_EDIT_OFF;</a>
<a name="ln1503">    // reset the gui</a>
<a name="ln1504">    dt_masks_set_edit_mode(module, DT_MASKS_EDIT_OFF);</a>
<a name="ln1505">  }</a>
<a name="ln1506">  dt_bauhaus_combobox_set(bd-&gt;masks_combo, 0);</a>
<a name="ln1507"> </a>
<a name="ln1508">  gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_edit), bd-&gt;masks_shown != DT_MASKS_EDIT_OFF);</a>
<a name="ln1509">  gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_polarity),</a>
<a name="ln1510">                               bp-&gt;mask_combine &amp; DEVELOP_COMBINE_MASKS_POS);</a>
<a name="ln1511"> </a>
<a name="ln1512">  // update buttons status</a>
<a name="ln1513">  int b1 = 0, b2 = 0, b3 = 0, b4 = 0, b5 = 0;</a>
<a name="ln1514">  if(module-&gt;dev-&gt;form_gui &amp;&amp; module-&gt;dev-&gt;form_visible &amp;&amp; module-&gt;dev-&gt;form_gui-&gt;creation</a>
<a name="ln1515">     &amp;&amp; module-&gt;dev-&gt;form_gui-&gt;creation_module == module)</a>
<a name="ln1516">  {</a>
<a name="ln1517">    if(module-&gt;dev-&gt;form_visible-&gt;type &amp; DT_MASKS_CIRCLE)</a>
<a name="ln1518">      b1 = 1;</a>
<a name="ln1519">    else if(module-&gt;dev-&gt;form_visible-&gt;type &amp; DT_MASKS_PATH)</a>
<a name="ln1520">      b2 = 1;</a>
<a name="ln1521">    else if(module-&gt;dev-&gt;form_visible-&gt;type &amp; DT_MASKS_GRADIENT)</a>
<a name="ln1522">      b3 = 1;</a>
<a name="ln1523">    else if(module-&gt;dev-&gt;form_visible-&gt;type &amp; DT_MASKS_ELLIPSE)</a>
<a name="ln1524">      b4 = 1;</a>
<a name="ln1525">    else if(module-&gt;dev-&gt;form_visible-&gt;type &amp; DT_MASKS_BRUSH)</a>
<a name="ln1526">      b5 = 1;</a>
<a name="ln1527">  }</a>
<a name="ln1528">  gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_circle), b1);</a>
<a name="ln1529">  gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_path), b2);</a>
<a name="ln1530">  gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_gradient), b3);</a>
<a name="ln1531">  gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_ellipse), b4);</a>
<a name="ln1532">  gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_brush), b5);</a>
<a name="ln1533">}</a>
<a name="ln1534"> </a>
<a name="ln1535">void dt_iop_gui_init_masks(GtkBox *blendw, dt_iop_module_t *module)</a>
<a name="ln1536">{</a>
<a name="ln1537">  dt_iop_gui_blend_data_t *bd = (dt_iop_gui_blend_data_t *)module-&gt;blend_data;</a>
<a name="ln1538"> </a>
<a name="ln1539">  bd-&gt;masks_box = GTK_BOX(gtk_box_new(GTK_ORIENTATION_VERTICAL, DT_BAUHAUS_SPACE));</a>
<a name="ln1540">  // add event box so that one can click into the area to get help for drawn masks</a>
<a name="ln1541">  GtkWidget* event_box = gtk_event_box_new();</a>
<a name="ln1542">  dt_gui_add_help_link(GTK_WIDGET(event_box), &quot;drawn_mask.html&quot;);</a>
<a name="ln1543">  gtk_container_add(GTK_CONTAINER(blendw), event_box);</a>
<a name="ln1544"> </a>
<a name="ln1545">  /* create and add masks support if module supports it */</a>
<a name="ln1546">  if(bd-&gt;masks_support)</a>
<a name="ln1547">  {</a>
<a name="ln1548">    const int bs = DT_PIXEL_APPLY_DPI(14);</a>
<a name="ln1549"> </a>
<a name="ln1550">    bd-&gt;masks_combo_ids = NULL;</a>
<a name="ln1551">    bd-&gt;masks_shown = DT_MASKS_EDIT_OFF;</a>
<a name="ln1552"> </a>
<a name="ln1553">    GtkWidget *hbox = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0);</a>
<a name="ln1554">    GtkWidget *abox = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0);</a>
<a name="ln1555"> </a>
<a name="ln1556">    bd-&gt;masks_combo = dt_bauhaus_combobox_new(module);</a>
<a name="ln1557">    dt_bauhaus_widget_set_label(bd-&gt;masks_combo, _(&quot;blend&quot;), _(&quot;drawn mask&quot;));</a>
<a name="ln1558">    dt_bauhaus_combobox_add(bd-&gt;masks_combo, _(&quot;no mask used&quot;));</a>
<a name="ln1559">    dt_bauhaus_combobox_set(bd-&gt;masks_combo, 0);</a>
<a name="ln1560">    g_signal_connect(G_OBJECT(bd-&gt;masks_combo), &quot;value-changed&quot;,</a>
<a name="ln1561">                     G_CALLBACK(dt_masks_iop_value_changed_callback), module);</a>
<a name="ln1562">    dt_bauhaus_combobox_add_populate_fct(bd-&gt;masks_combo, dt_masks_iop_combo_populate);</a>
<a name="ln1563">    gtk_box_pack_start(GTK_BOX(hbox), bd-&gt;masks_combo, TRUE, TRUE, 0);</a>
<a name="ln1564"> </a>
<a name="ln1565">    bd-&gt;masks_edit</a>
<a name="ln1566">        = dtgtk_togglebutton_new(dtgtk_cairo_paint_masks_eye, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln1567">    g_signal_connect(G_OBJECT(bd-&gt;masks_edit), &quot;button-press-event&quot;, G_CALLBACK(_blendop_masks_show_and_edit),</a>
<a name="ln1568">                     module);</a>
<a name="ln1569">    gtk_widget_set_tooltip_text(bd-&gt;masks_edit, _(&quot;show and edit mask elements&quot;));</a>
<a name="ln1570">    gtk_widget_set_size_request(GTK_WIDGET(bd-&gt;masks_edit), bs, bs);</a>
<a name="ln1571">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_edit), FALSE);</a>
<a name="ln1572">    gtk_box_pack_start(GTK_BOX(hbox), bd-&gt;masks_edit, FALSE, FALSE, 0);</a>
<a name="ln1573"> </a>
<a name="ln1574">    bd-&gt;masks_polarity</a>
<a name="ln1575">        = dtgtk_togglebutton_new(dtgtk_cairo_paint_plusminus, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln1576">    gtk_widget_set_tooltip_text(bd-&gt;masks_polarity, _(&quot;toggle polarity of drawn mask&quot;));</a>
<a name="ln1577">    g_signal_connect(G_OBJECT(bd-&gt;masks_polarity), &quot;toggled&quot;, G_CALLBACK(_blendop_masks_polarity_callback),</a>
<a name="ln1578">                     module);</a>
<a name="ln1579">    gtk_widget_set_size_request(GTK_WIDGET(bd-&gt;masks_polarity), bs, bs);</a>
<a name="ln1580">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_polarity), FALSE);</a>
<a name="ln1581">    gtk_box_pack_start(GTK_BOX(hbox), bd-&gt;masks_polarity, FALSE, FALSE, 0);</a>
<a name="ln1582"> </a>
<a name="ln1583">    bd-&gt;masks_gradient</a>
<a name="ln1584">        = dtgtk_togglebutton_new(dtgtk_cairo_paint_masks_gradient, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln1585">    g_signal_connect(G_OBJECT(bd-&gt;masks_gradient), &quot;button-press-event&quot;,</a>
<a name="ln1586">                     G_CALLBACK(_blendop_masks_add_gradient), module);</a>
<a name="ln1587">    gtk_widget_set_tooltip_text(bd-&gt;masks_gradient, _(&quot;add gradient&quot;));</a>
<a name="ln1588">    gtk_widget_set_size_request(GTK_WIDGET(bd-&gt;masks_gradient), bs, bs);</a>
<a name="ln1589">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_gradient), FALSE);</a>
<a name="ln1590">    gtk_box_pack_end(GTK_BOX(abox), bd-&gt;masks_gradient, FALSE, FALSE, 0);</a>
<a name="ln1591"> </a>
<a name="ln1592">    bd-&gt;masks_path</a>
<a name="ln1593">        = dtgtk_togglebutton_new(dtgtk_cairo_paint_masks_path, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln1594">    g_signal_connect(G_OBJECT(bd-&gt;masks_path), &quot;button-press-event&quot;, G_CALLBACK(_blendop_masks_add_path),</a>
<a name="ln1595">                     module);</a>
<a name="ln1596">    gtk_widget_set_tooltip_text(bd-&gt;masks_path, _(&quot;add path&quot;));</a>
<a name="ln1597">    gtk_widget_set_size_request(GTK_WIDGET(bd-&gt;masks_path), bs, bs);</a>
<a name="ln1598">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_path), FALSE);</a>
<a name="ln1599">    gtk_box_pack_end(GTK_BOX(abox), bd-&gt;masks_path, FALSE, FALSE, bs);</a>
<a name="ln1600"> </a>
<a name="ln1601">    bd-&gt;masks_ellipse</a>
<a name="ln1602">        = dtgtk_togglebutton_new(dtgtk_cairo_paint_masks_ellipse, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln1603">    g_signal_connect(G_OBJECT(bd-&gt;masks_ellipse), &quot;button-press-event&quot;,</a>
<a name="ln1604">                     G_CALLBACK(_blendop_masks_add_ellipse), module);</a>
<a name="ln1605">    gtk_widget_set_tooltip_text(bd-&gt;masks_ellipse, _(&quot;add ellipse&quot;));</a>
<a name="ln1606">    gtk_widget_set_size_request(GTK_WIDGET(bd-&gt;masks_ellipse), bs, bs);</a>
<a name="ln1607">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_ellipse), FALSE);</a>
<a name="ln1608">    gtk_box_pack_end(GTK_BOX(abox), bd-&gt;masks_ellipse, FALSE, FALSE, 0);</a>
<a name="ln1609"> </a>
<a name="ln1610">    bd-&gt;masks_circle</a>
<a name="ln1611">        = dtgtk_togglebutton_new(dtgtk_cairo_paint_masks_circle, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln1612">    g_signal_connect(G_OBJECT(bd-&gt;masks_circle), &quot;button-press-event&quot;, G_CALLBACK(_blendop_masks_add_circle),</a>
<a name="ln1613">                     module);</a>
<a name="ln1614">    gtk_widget_set_tooltip_text(bd-&gt;masks_circle, _(&quot;add circle&quot;));</a>
<a name="ln1615">    gtk_widget_set_size_request(GTK_WIDGET(bd-&gt;masks_circle), bs, bs);</a>
<a name="ln1616">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_circle), FALSE);</a>
<a name="ln1617">    gtk_box_pack_end(GTK_BOX(abox), bd-&gt;masks_circle, FALSE, FALSE, bs);</a>
<a name="ln1618"> </a>
<a name="ln1619">    bd-&gt;masks_brush</a>
<a name="ln1620">        = dtgtk_togglebutton_new(dtgtk_cairo_paint_masks_brush, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln1621">    g_signal_connect(G_OBJECT(bd-&gt;masks_brush), &quot;button-press-event&quot;, G_CALLBACK(_blendop_masks_add_brush),</a>
<a name="ln1622">                     module);</a>
<a name="ln1623">    gtk_widget_set_tooltip_text(bd-&gt;masks_brush, _(&quot;add brush&quot;));</a>
<a name="ln1624">    gtk_widget_set_size_request(GTK_WIDGET(bd-&gt;masks_brush), bs, bs);</a>
<a name="ln1625">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;masks_brush), FALSE);</a>
<a name="ln1626">    gtk_box_pack_end(GTK_BOX(abox), bd-&gt;masks_brush, FALSE, FALSE, 0);</a>
<a name="ln1627"> </a>
<a name="ln1628"> </a>
<a name="ln1629">    gtk_box_pack_start(GTK_BOX(bd-&gt;masks_box), dt_ui_section_label_new(_(&quot;drawn mask&quot;)), TRUE, TRUE, 0);</a>
<a name="ln1630">    gtk_box_pack_start(GTK_BOX(bd-&gt;masks_box), GTK_WIDGET(hbox), TRUE, TRUE, 0);</a>
<a name="ln1631">    gtk_box_pack_start(GTK_BOX(bd-&gt;masks_box), GTK_WIDGET(abox), TRUE, TRUE, 0);</a>
<a name="ln1632"> </a>
<a name="ln1633">    bd-&gt;masks_inited = 1;</a>
<a name="ln1634">  }</a>
<a name="ln1635">  gtk_container_add(GTK_CONTAINER(event_box), GTK_WIDGET(bd-&gt;masks_box));</a>
<a name="ln1636">}</a>
<a name="ln1637"> </a>
<a name="ln1638">typedef struct raster_combo_entry_t</a>
<a name="ln1639">{</a>
<a name="ln1640">  dt_iop_module_t *module;</a>
<a name="ln1641">  int id;</a>
<a name="ln1642">} raster_combo_entry_t;</a>
<a name="ln1643"> </a>
<a name="ln1644">static void _raster_combo_populate(GtkWidget *w, struct dt_iop_module_t **m)</a>
<a name="ln1645">{</a>
<a name="ln1646">  dt_iop_module_t *module = *m;</a>
<a name="ln1647">  dt_iop_request_focus(module);</a>
<a name="ln1648"> </a>
<a name="ln1649">  dt_bauhaus_combobox_clear(w);</a>
<a name="ln1650"> </a>
<a name="ln1651">  raster_combo_entry_t *entry = (raster_combo_entry_t *)malloc(sizeof(raster_combo_entry_t));</a>
<a name="ln1652">  entry-&gt;module = NULL;</a>
<a name="ln1653">  entry-&gt;id = 0;</a>
<a name="ln1654">  dt_bauhaus_combobox_add_full(w, _(&quot;no mask used&quot;), DT_BAUHAUS_COMBOBOX_ALIGN_RIGHT, entry, free);</a>
<a name="ln1655"> </a>
<a name="ln1656">  int i = 1;</a>
<a name="ln1657"> </a>
<a name="ln1658">  for(GList* iter = darktable.develop-&gt;iop; iter; iter = g_list_next(iter))</a>
<a name="ln1659">  {</a>
<a name="ln1660">    dt_iop_module_t *iop = (dt_iop_module_t *)iter-&gt;data;</a>
<a name="ln1661">    if(iop == module)</a>
<a name="ln1662">      break;</a>
<a name="ln1663"> </a>
<a name="ln1664">    GHashTableIter masks_iter;</a>
<a name="ln1665">    gpointer key, value;</a>
<a name="ln1666"> </a>
<a name="ln1667">    g_hash_table_iter_init(&amp;masks_iter, iop-&gt;raster_mask.source.masks);</a>
<a name="ln1668">    while(g_hash_table_iter_next(&amp;masks_iter, &amp;key, &amp;value))</a>
<a name="ln1669">    {</a>
<a name="ln1670">      const int id = GPOINTER_TO_INT(key);</a>
<a name="ln1671">      const char *modulename = (char *)value;</a>
<a name="ln1672">      entry = (raster_combo_entry_t *)malloc(sizeof(raster_combo_entry_t));</a>
<a name="ln1673">      entry-&gt;module = iop;</a>
<a name="ln1674">      entry-&gt;id = id;</a>
<a name="ln1675">      dt_bauhaus_combobox_add_full(w, modulename, DT_BAUHAUS_COMBOBOX_ALIGN_RIGHT, entry, free);</a>
<a name="ln1676">      if(iop == module-&gt;raster_mask.sink.source &amp;&amp; module-&gt;raster_mask.sink.id == id)</a>
<a name="ln1677">        dt_bauhaus_combobox_set(w, i);</a>
<a name="ln1678">      i++;</a>
<a name="ln1679">    }</a>
<a name="ln1680">  }</a>
<a name="ln1681">}</a>
<a name="ln1682"> </a>
<a name="ln1683">static void _raster_value_changed_callback(GtkWidget *widget, struct dt_iop_module_t *module)</a>
<a name="ln1684">{</a>
<a name="ln1685">  raster_combo_entry_t *entry = dt_bauhaus_combobox_get_data(widget);</a>
<a name="ln1686"> </a>
<a name="ln1687">  // nothing to do</a>
<a name="ln1688">  if(entry-&gt;module == module-&gt;raster_mask.sink.source &amp;&amp; entry-&gt;id == module-&gt;raster_mask.sink.id)</a>
<a name="ln1689">    return;</a>
<a name="ln1690"> </a>
<a name="ln1691">  if(module-&gt;raster_mask.sink.source)</a>
<a name="ln1692">  {</a>
<a name="ln1693">    // we no longer use this one</a>
<a name="ln1694">    g_hash_table_remove(module-&gt;raster_mask.sink.source-&gt;raster_mask.source.users, module);</a>
<a name="ln1695">  }</a>
<a name="ln1696"> </a>
<a name="ln1697">  module-&gt;raster_mask.sink.source = entry-&gt;module;</a>
<a name="ln1698">  module-&gt;raster_mask.sink.id = entry-&gt;id;</a>
<a name="ln1699"> </a>
<a name="ln1700">  gboolean reprocess = FALSE;</a>
<a name="ln1701"> </a>
<a name="ln1702">  if(entry-&gt;module)</a>
<a name="ln1703">  {</a>
<a name="ln1704">    reprocess = dt_iop_is_raster_mask_used(entry-&gt;module, 0) == FALSE;</a>
<a name="ln1705">    g_hash_table_add(entry-&gt;module-&gt;raster_mask.source.users, module);</a>
<a name="ln1706"> </a>
<a name="ln1707">    // update blend_params!</a>
<a name="ln1708">    memcpy(module-&gt;blend_params-&gt;raster_mask_source, entry-&gt;module-&gt;op, sizeof(module-&gt;blend_params-&gt;raster_mask_source));</a>
<a name="ln1709">    module-&gt;blend_params-&gt;raster_mask_instance = entry-&gt;module-&gt;multi_priority;</a>
<a name="ln1710">    module-&gt;blend_params-&gt;raster_mask_id = entry-&gt;id;</a>
<a name="ln1711">  }</a>
<a name="ln1712">  else</a>
<a name="ln1713">  {</a>
<a name="ln1714">    memset(module-&gt;blend_params-&gt;raster_mask_source, 0, sizeof(module-&gt;blend_params-&gt;raster_mask_source));</a>
<a name="ln1715">    module-&gt;blend_params-&gt;raster_mask_instance = 0;</a>
<a name="ln1716">    module-&gt;blend_params-&gt;raster_mask_id = 0;</a>
<a name="ln1717">  }</a>
<a name="ln1718"> </a>
<a name="ln1719">  dt_dev_add_history_item(module-&gt;dev, module, TRUE);</a>
<a name="ln1720"> </a>
<a name="ln1721">  if(reprocess)</a>
<a name="ln1722">    dt_dev_reprocess_all(module-&gt;dev);</a>
<a name="ln1723">}</a>
<a name="ln1724"> </a>
<a name="ln1725">void dt_iop_gui_update_raster(dt_iop_module_t *module)</a>
<a name="ln1726">{</a>
<a name="ln1727">  dt_iop_gui_blend_data_t *bd = (dt_iop_gui_blend_data_t *)module-&gt;blend_data;</a>
<a name="ln1728">  dt_develop_blend_params_t *bp = module-&gt;blend_params;</a>
<a name="ln1729"> </a>
<a name="ln1730">  if(!bd || !bd-&gt;masks_support || !bd-&gt;raster_inited) return;</a>
<a name="ln1731"> </a>
<a name="ln1732">  gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;raster_polarity), bp-&gt;raster_mask_invert);</a>
<a name="ln1733"> </a>
<a name="ln1734">  _raster_combo_populate(bd-&gt;raster_combo, &amp;module);</a>
<a name="ln1735">}</a>
<a name="ln1736"> </a>
<a name="ln1737">static void _raster_polarity_callback(GtkToggleButton *togglebutton, dt_iop_module_t *self)</a>
<a name="ln1738">{</a>
<a name="ln1739">  if(darktable.gui-&gt;reset) return;</a>
<a name="ln1740"> </a>
<a name="ln1741">  dt_develop_blend_params_t *bp = (dt_develop_blend_params_t *)self-&gt;blend_params;</a>
<a name="ln1742"> </a>
<a name="ln1743">  bp-&gt;raster_mask_invert = gtk_toggle_button_get_active(togglebutton);</a>
<a name="ln1744"> </a>
<a name="ln1745">  dt_dev_add_history_item(darktable.develop, self, TRUE);</a>
<a name="ln1746">}</a>
<a name="ln1747"> </a>
<a name="ln1748">void dt_iop_gui_init_raster(GtkBox *blendw, dt_iop_module_t *module)</a>
<a name="ln1749">{</a>
<a name="ln1750">  dt_iop_gui_blend_data_t *bd = (dt_iop_gui_blend_data_t *)module-&gt;blend_data;</a>
<a name="ln1751"> </a>
<a name="ln1752">  bd-&gt;raster_box = GTK_BOX(gtk_box_new(GTK_ORIENTATION_VERTICAL, DT_BAUHAUS_SPACE));</a>
<a name="ln1753">  // add event box so that one can click into the area to get help for drawn masks</a>
<a name="ln1754">  GtkWidget* event_box = gtk_event_box_new();</a>
<a name="ln1755">//  dt_gui_add_help_link(GTK_WIDGET(event_box), &quot;raster_mask.html&quot;);</a>
<a name="ln1756">  gtk_container_add(GTK_CONTAINER(blendw), event_box);</a>
<a name="ln1757"> </a>
<a name="ln1758">  /* create and add raster support if module supports it (it's coupled to masks at the moment) */</a>
<a name="ln1759">  if(bd-&gt;masks_support)</a>
<a name="ln1760">  {</a>
<a name="ln1761">    const int bs = DT_PIXEL_APPLY_DPI(14);</a>
<a name="ln1762"> </a>
<a name="ln1763">    GtkWidget *hbox = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0);</a>
<a name="ln1764"> </a>
<a name="ln1765">    bd-&gt;raster_combo = dt_bauhaus_combobox_new(module);</a>
<a name="ln1766">    dt_bauhaus_widget_set_label(bd-&gt;raster_combo, _(&quot;blend&quot;), _(&quot;raster mask&quot;));</a>
<a name="ln1767">    dt_bauhaus_combobox_add(bd-&gt;raster_combo, _(&quot;no mask used&quot;));</a>
<a name="ln1768">    dt_bauhaus_combobox_set(bd-&gt;raster_combo, 0);</a>
<a name="ln1769">    g_signal_connect(G_OBJECT(bd-&gt;raster_combo), &quot;value-changed&quot;,</a>
<a name="ln1770">                     G_CALLBACK(_raster_value_changed_callback), module);</a>
<a name="ln1771">    dt_bauhaus_combobox_add_populate_fct(bd-&gt;raster_combo, _raster_combo_populate);</a>
<a name="ln1772">    gtk_box_pack_start(GTK_BOX(hbox), bd-&gt;raster_combo, TRUE, TRUE, 0);</a>
<a name="ln1773"> </a>
<a name="ln1774">    bd-&gt;raster_polarity = dtgtk_togglebutton_new(dtgtk_cairo_paint_plusminus, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER,</a>
<a name="ln1775">                                                 NULL);</a>
<a name="ln1776">    gtk_widget_set_tooltip_text(bd-&gt;raster_polarity, _(&quot;toggle polarity of raster mask&quot;));</a>
<a name="ln1777">    g_signal_connect(G_OBJECT(bd-&gt;raster_polarity), &quot;toggled&quot;, G_CALLBACK(_raster_polarity_callback), module);</a>
<a name="ln1778">    gtk_widget_set_size_request(GTK_WIDGET(bd-&gt;raster_polarity), bs, bs);</a>
<a name="ln1779">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;raster_polarity), FALSE);</a>
<a name="ln1780">    gtk_box_pack_start(GTK_BOX(hbox), bd-&gt;raster_polarity, FALSE, FALSE, 0);</a>
<a name="ln1781"> </a>
<a name="ln1782">    gtk_box_pack_start(GTK_BOX(bd-&gt;raster_box), GTK_WIDGET(hbox), TRUE, TRUE, 0);</a>
<a name="ln1783"> </a>
<a name="ln1784">    bd-&gt;raster_inited = 1;</a>
<a name="ln1785">  }</a>
<a name="ln1786">  gtk_container_add(GTK_CONTAINER(event_box), GTK_WIDGET(bd-&gt;raster_box));</a>
<a name="ln1787">}</a>
<a name="ln1788"> </a>
<a name="ln1789">void dt_iop_gui_cleanup_blending(dt_iop_module_t *module)</a>
<a name="ln1790">{</a>
<a name="ln1791">  if(!module-&gt;blend_data) return;</a>
<a name="ln1792">  dt_iop_gui_blend_data_t *bd = (dt_iop_gui_blend_data_t *)module-&gt;blend_data;</a>
<a name="ln1793"> </a>
<a name="ln1794">  dt_pthread_mutex_lock(&amp;bd-&gt;lock);</a>
<a name="ln1795">  if(bd-&gt;timeout_handle)</a>
<a name="ln1796">    g_source_remove(bd-&gt;timeout_handle);</a>
<a name="ln1797"> </a>
<a name="ln1798">  g_list_free(bd-&gt;blend_modes);</a>
<a name="ln1799">  g_list_free(bd-&gt;masks_modes);</a>
<a name="ln1800">  g_list_free(bd-&gt;masks_modes_toggles);</a>
<a name="ln1801">  g_list_free(bd-&gt;masks_combine);</a>
<a name="ln1802">  g_list_free(bd-&gt;masks_invert);</a>
<a name="ln1803">  g_list_free(bd-&gt;masks_feathering_guide);</a>
<a name="ln1804">  g_list_free_full(bd-&gt;blend_modes_all, g_free);</a>
<a name="ln1805">  free(bd-&gt;masks_combo_ids);</a>
<a name="ln1806">  dt_pthread_mutex_unlock(&amp;bd-&gt;lock);</a>
<a name="ln1807">  dt_pthread_mutex_destroy(&amp;bd-&gt;lock);</a>
<a name="ln1808"> </a>
<a name="ln1809">  memset(module-&gt;blend_data, 0, sizeof(dt_iop_gui_blend_data_t));</a>
<a name="ln1810"> </a>
<a name="ln1811">  g_free(module-&gt;blend_data);</a>
<a name="ln1812">  module-&gt;blend_data = NULL;</a>
<a name="ln1813">}</a>
<a name="ln1814"> </a>
<a name="ln1815">void dt_iop_gui_update_blending(dt_iop_module_t *module)</a>
<a name="ln1816">{</a>
<a name="ln1817">  dt_iop_gui_blend_data_t *bd = (dt_iop_gui_blend_data_t *)module-&gt;blend_data;</a>
<a name="ln1818"> </a>
<a name="ln1819">  if(!(module-&gt;flags() &amp; IOP_FLAGS_SUPPORTS_BLENDING) || !bd || !bd-&gt;blend_inited) return;</a>
<a name="ln1820"> </a>
<a name="ln1821">  unsigned int mode = g_list_index(bd-&gt;masks_modes, GUINT_TO_POINTER(module-&gt;blend_params-&gt;mask_mode));</a>
<a name="ln1822"> </a>
<a name="ln1823">  // unsets currently toggled if any, won't try to untoggle the cancel button</a>
<a name="ln1824">  if(bd-&gt;selected_mask_mode</a>
<a name="ln1825">     != g_list_nth_data(bd-&gt;masks_modes_toggles,</a>
<a name="ln1826">                        g_list_index(bd-&gt;masks_modes, GUINT_TO_POINTER(DEVELOP_MASK_DISABLED))))</a>
<a name="ln1827">  {</a>
<a name="ln1828">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;selected_mask_mode), FALSE);</a>
<a name="ln1829">  }</a>
<a name="ln1830"> </a>
<a name="ln1831">  if(mode &gt; 0)</a>
<a name="ln1832">  {</a>
<a name="ln1833">    GtkToggleButton *to_be_activated = GTK_TOGGLE_BUTTON(g_list_nth_data(bd-&gt;masks_modes_toggles, mode));</a>
<a name="ln1834">    gtk_toggle_button_set_active(to_be_activated, TRUE);</a>
<a name="ln1835">    bd-&gt;selected_mask_mode = GTK_WIDGET(to_be_activated);</a>
<a name="ln1836">  }</a>
<a name="ln1837">  else</a>
<a name="ln1838">  {</a>
<a name="ln1839">    bd-&gt;selected_mask_mode = g_list_nth_data(</a>
<a name="ln1840">        bd-&gt;masks_modes_toggles, g_list_index(bd-&gt;masks_modes, GUINT_TO_POINTER(DEVELOP_MASK_DISABLED)));</a>
<a name="ln1841">  }</a>
<a name="ln1842"> </a>
<a name="ln1843">  int reset = darktable.gui-&gt;reset;</a>
<a name="ln1844">  darktable.gui-&gt;reset = 1;</a>
<a name="ln1845"> </a>
<a name="ln1846">  /* special handling of deprecated blend modes */</a>
<a name="ln1847">  int blend_mode_number = g_list_index(bd-&gt;blend_modes, GUINT_TO_POINTER(module-&gt;blend_params-&gt;blend_mode));</a>
<a name="ln1848">  if(blend_mode_number &lt; 0)</a>
<a name="ln1849">  {</a>
<a name="ln1850">    GList *complete_list = bd-&gt;blend_modes_all;</a>
<a name="ln1851"> </a>
<a name="ln1852">    while(complete_list)</a>
<a name="ln1853">    {</a>
<a name="ln1854">      dt_iop_blend_mode_t *bm = (dt_iop_blend_mode_t *)complete_list-&gt;data;</a>
<a name="ln1855">      if(bm-&gt;mode == module-&gt;blend_params-&gt;blend_mode)</a>
<a name="ln1856">      {</a>
<a name="ln1857">        dt_bauhaus_combobox_add(bd-&gt;blend_modes_combo, bm-&gt;name);</a>
<a name="ln1858">        bd-&gt;blend_modes = g_list_append(bd-&gt;blend_modes, GUINT_TO_POINTER(bm-&gt;mode));</a>
<a name="ln1859">        break;</a>
<a name="ln1860">      }</a>
<a name="ln1861">      complete_list = g_list_next(complete_list);</a>
<a name="ln1862">    }</a>
<a name="ln1863"> </a>
<a name="ln1864">    if(complete_list)</a>
<a name="ln1865">    {</a>
<a name="ln1866">      /* found it and added it to combobox, now find entry number */</a>
<a name="ln1867">      blend_mode_number = g_list_index(bd-&gt;blend_modes, GUINT_TO_POINTER(module-&gt;blend_params-&gt;blend_mode));</a>
<a name="ln1868">    }</a>
<a name="ln1869">    else</a>
<a name="ln1870">    {</a>
<a name="ln1871">      /* should never happen: unknown blend mode */</a>
<a name="ln1872">      dt_control_log(&quot;unknown blend mode '%d' in module '%s'&quot;, module-&gt;blend_params-&gt;blend_mode, module-&gt;op);</a>
<a name="ln1873">      blend_mode_number = 0;</a>
<a name="ln1874">    }</a>
<a name="ln1875">  }</a>
<a name="ln1876"> </a>
<a name="ln1877">  dt_bauhaus_combobox_set(bd-&gt;blend_modes_combo, blend_mode_number);</a>
<a name="ln1878"> </a>
<a name="ln1879">  dt_bauhaus_combobox_set(</a>
<a name="ln1880">      bd-&gt;masks_combine_combo,</a>
<a name="ln1881">      g_list_index(bd-&gt;masks_combine, GUINT_TO_POINTER(module-&gt;blend_params-&gt;mask_combine</a>
<a name="ln1882">                                                       &amp; (DEVELOP_COMBINE_INV | DEVELOP_COMBINE_INCL))));</a>
<a name="ln1883">  dt_bauhaus_combobox_set(bd-&gt;masks_invert_combo,</a>
<a name="ln1884">                          g_list_index(bd-&gt;masks_invert, GUINT_TO_POINTER(module-&gt;blend_params-&gt;mask_combine</a>
<a name="ln1885">                                                                          &amp; DEVELOP_COMBINE_INV)));</a>
<a name="ln1886">  dt_bauhaus_slider_set(bd-&gt;opacity_slider, module-&gt;blend_params-&gt;opacity);</a>
<a name="ln1887">  dt_bauhaus_combobox_set(</a>
<a name="ln1888">      bd-&gt;masks_feathering_guide_combo,</a>
<a name="ln1889">      g_list_index(bd-&gt;masks_feathering_guide, GUINT_TO_POINTER(module-&gt;blend_params-&gt;feathering_guide)));</a>
<a name="ln1890">  dt_bauhaus_slider_set(bd-&gt;feathering_radius_slider, module-&gt;blend_params-&gt;feathering_radius);</a>
<a name="ln1891">  dt_bauhaus_slider_set(bd-&gt;blur_radius_slider, module-&gt;blend_params-&gt;blur_radius);</a>
<a name="ln1892">  dt_bauhaus_slider_set(bd-&gt;brightness_slider, module-&gt;blend_params-&gt;brightness);</a>
<a name="ln1893">  dt_bauhaus_slider_set(bd-&gt;contrast_slider, module-&gt;blend_params-&gt;contrast);</a>
<a name="ln1894"> </a>
<a name="ln1895">  dt_iop_gui_update_blendif(module);</a>
<a name="ln1896">  dt_iop_gui_update_masks(module);</a>
<a name="ln1897">  dt_iop_gui_update_raster(module);</a>
<a name="ln1898"> </a>
<a name="ln1899">  /* now show hide controls as required */</a>
<a name="ln1900">  const unsigned int mask_mode = module-&gt;blend_params-&gt;mask_mode;</a>
<a name="ln1901"> </a>
<a name="ln1902">  if(mask_mode &amp; DEVELOP_MASK_ENABLED)</a>
<a name="ln1903">  {</a>
<a name="ln1904">    gtk_widget_show(GTK_WIDGET(bd-&gt;top_box));</a>
<a name="ln1905">  }</a>
<a name="ln1906">  else</a>
<a name="ln1907">  {</a>
<a name="ln1908">    gtk_widget_hide(GTK_WIDGET(bd-&gt;top_box));</a>
<a name="ln1909">  }</a>
<a name="ln1910"> </a>
<a name="ln1911">  if((mask_mode &amp; DEVELOP_MASK_ENABLED) &amp;&amp; ((bd-&gt;masks_inited &amp;&amp; (mask_mode &amp; DEVELOP_MASK_MASK))</a>
<a name="ln1912">                                            || (bd-&gt;blendif_inited &amp;&amp; (mask_mode &amp; DEVELOP_MASK_CONDITIONAL))))</a>
<a name="ln1913">  {</a>
<a name="ln1914">    if(bd-&gt;blendif_inited &amp;&amp; (mask_mode &amp; DEVELOP_MASK_CONDITIONAL))</a>
<a name="ln1915">    {</a>
<a name="ln1916">      gtk_widget_hide(GTK_WIDGET(bd-&gt;masks_invert_combo));</a>
<a name="ln1917">      gtk_widget_show(GTK_WIDGET(bd-&gt;masks_combine_combo));</a>
<a name="ln1918">    }</a>
<a name="ln1919">    else</a>
<a name="ln1920">    {</a>
<a name="ln1921">      gtk_widget_show(GTK_WIDGET(bd-&gt;masks_invert_combo));</a>
<a name="ln1922">      gtk_widget_hide(GTK_WIDGET(bd-&gt;masks_combine_combo));</a>
<a name="ln1923">    }</a>
<a name="ln1924"> </a>
<a name="ln1925">    /*</a>
<a name="ln1926">     * if this iop is operating in raw space, it has only 1 channel per pixel,</a>
<a name="ln1927">     * thus there is no alpha channel where we would normally store mask</a>
<a name="ln1928">     * that would get displayed if following button have been pressed.</a>
<a name="ln1929">     *</a>
<a name="ln1930">     * TODO: revisit if/once there semi-raw iops (e.g temperature) with blending</a>
<a name="ln1931">     */</a>
<a name="ln1932">    if(dt_iop_module_colorspace(module) == iop_cs_RAW)</a>
<a name="ln1933">    {</a>
<a name="ln1934">      module-&gt;request_mask_display = DT_DEV_PIXELPIPE_DISPLAY_NONE;</a>
<a name="ln1935">      dtgtk_button_set_active(DTGTK_BUTTON(bd-&gt;showmask), 0);</a>
<a name="ln1936">      gtk_widget_hide(GTK_WIDGET(bd-&gt;showmask));</a>
<a name="ln1937">    }</a>
<a name="ln1938">    else</a>
<a name="ln1939">    {</a>
<a name="ln1940">      gtk_widget_show(GTK_WIDGET(bd-&gt;showmask));</a>
<a name="ln1941">    }</a>
<a name="ln1942"> </a>
<a name="ln1943">    gtk_widget_show(GTK_WIDGET(bd-&gt;bottom_box));</a>
<a name="ln1944">  }</a>
<a name="ln1945">  else</a>
<a name="ln1946">  {</a>
<a name="ln1947">    module-&gt;request_mask_display = DT_DEV_PIXELPIPE_DISPLAY_NONE;</a>
<a name="ln1948">    dtgtk_button_set_active(DTGTK_BUTTON(bd-&gt;showmask), 0);</a>
<a name="ln1949">    module-&gt;suppress_mask = 0;</a>
<a name="ln1950">    gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;suppress), 0);</a>
<a name="ln1951"> </a>
<a name="ln1952">    gtk_widget_hide(GTK_WIDGET(bd-&gt;bottom_box));</a>
<a name="ln1953">  }</a>
<a name="ln1954"> </a>
<a name="ln1955"> </a>
<a name="ln1956">  if(bd-&gt;masks_inited &amp;&amp; (mask_mode &amp; DEVELOP_MASK_MASK))</a>
<a name="ln1957">  {</a>
<a name="ln1958">    gtk_widget_show(GTK_WIDGET(bd-&gt;masks_box));</a>
<a name="ln1959">  }</a>
<a name="ln1960">  else if(bd-&gt;masks_inited)</a>
<a name="ln1961">  {</a>
<a name="ln1962">    dt_masks_set_edit_mode(module, DT_MASKS_EDIT_OFF);</a>
<a name="ln1963"> </a>
<a name="ln1964">    gtk_widget_hide(GTK_WIDGET(bd-&gt;masks_box));</a>
<a name="ln1965">  }</a>
<a name="ln1966">  else</a>
<a name="ln1967">  {</a>
<a name="ln1968">    gtk_widget_hide(GTK_WIDGET(bd-&gt;masks_box));</a>
<a name="ln1969">  }</a>
<a name="ln1970"> </a>
<a name="ln1971">  if(bd-&gt;raster_inited &amp;&amp; (mask_mode &amp; DEVELOP_MASK_RASTER))</a>
<a name="ln1972">  {</a>
<a name="ln1973">    gtk_widget_show(GTK_WIDGET(bd-&gt;raster_box));</a>
<a name="ln1974">  }</a>
<a name="ln1975">  else if(bd-&gt;raster_inited)</a>
<a name="ln1976">  {</a>
<a name="ln1977">//     dt_masks_set_edit_mode(module, DT_MASKS_EDIT_OFF);</a>
<a name="ln1978"> </a>
<a name="ln1979">    gtk_widget_hide(GTK_WIDGET(bd-&gt;raster_box));</a>
<a name="ln1980">  }</a>
<a name="ln1981">  else</a>
<a name="ln1982">  {</a>
<a name="ln1983">    gtk_widget_hide(GTK_WIDGET(bd-&gt;raster_box));</a>
<a name="ln1984">  }</a>
<a name="ln1985"> </a>
<a name="ln1986">  if(bd-&gt;blendif_inited &amp;&amp; (mask_mode &amp; DEVELOP_MASK_CONDITIONAL))</a>
<a name="ln1987">  {</a>
<a name="ln1988">    gtk_widget_show(GTK_WIDGET(bd-&gt;blendif_box));</a>
<a name="ln1989">  }</a>
<a name="ln1990">  else if(bd-&gt;blendif_inited)</a>
<a name="ln1991">  {</a>
<a name="ln1992">    /* switch off color picker if it was requested by blendif */</a>
<a name="ln1993">    if(module-&gt;request_color_pick == DT_REQUEST_COLORPICK_BLEND)</a>
<a name="ln1994">    {</a>
<a name="ln1995">      module-&gt;request_color_pick = DT_REQUEST_COLORPICK_OFF;</a>
<a name="ln1996">      gtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(bd-&gt;colorpicker), 0);</a>
<a name="ln1997">    }</a>
<a name="ln1998"> </a>
<a name="ln1999">    gtk_widget_hide(GTK_WIDGET(bd-&gt;blendif_box));</a>
<a name="ln2000">  }</a>
<a name="ln2001">  else</a>
<a name="ln2002">  {</a>
<a name="ln2003">    gtk_widget_hide(GTK_WIDGET(bd-&gt;blendif_box));</a>
<a name="ln2004">  }</a>
<a name="ln2005"> </a>
<a name="ln2006">  darktable.gui-&gt;reset = reset;</a>
<a name="ln2007">}</a>
<a name="ln2008"> </a>
<a name="ln2009">static void _collect_blend_modes(GList **list, const char *name, unsigned int mode)</a>
<a name="ln2010">{</a>
<a name="ln2011">  dt_iop_blend_mode_t *bm;</a>
<a name="ln2012">  bm = g_malloc(sizeof(dt_iop_blend_mode_t));</a>
<a name="ln2013">  g_strlcpy(bm-&gt;name, name, sizeof(bm-&gt;name));</a>
<a name="ln2014">  bm-&gt;mode = mode;</a>
<a name="ln2015">  *list = g_list_append(*list, bm);</a>
<a name="ln2016">}</a>
<a name="ln2017"> </a>
<a name="ln2018"> </a>
<a name="ln2019">static void _add_blendmode_combo(GList **list, GtkWidget *combobox, GList *complete, unsigned int mode)</a>
<a name="ln2020">{</a>
<a name="ln2021">  GList *all = complete;</a>
<a name="ln2022"> </a>
<a name="ln2023">  while(all)</a>
<a name="ln2024">  {</a>
<a name="ln2025">    dt_iop_blend_mode_t *bm = (dt_iop_blend_mode_t *)all-&gt;data;</a>
<a name="ln2026">    if(bm-&gt;mode == mode)</a>
<a name="ln2027">    {</a>
<a name="ln2028">      dt_bauhaus_combobox_add(combobox, bm-&gt;name);</a>
<a name="ln2029">      *list = g_list_append(*list, GUINT_TO_POINTER(bm-&gt;mode));</a>
<a name="ln2030">      break;</a>
<a name="ln2031">    }</a>
<a name="ln2032">    all = g_list_next(all);</a>
<a name="ln2033">  }</a>
<a name="ln2034">}</a>
<a name="ln2035"> </a>
<a name="ln2036"> </a>
<a name="ln2037">void dt_iop_gui_init_blending(GtkWidget *iopw, dt_iop_module_t *module)</a>
<a name="ln2038">{</a>
<a name="ln2039"> </a>
<a name="ln2040">  /* create and add blend mode if module supports it */</a>
<a name="ln2041">  if(module-&gt;flags() &amp; IOP_FLAGS_SUPPORTS_BLENDING)</a>
<a name="ln2042">  {</a>
<a name="ln2043">    const int bs = DT_PIXEL_APPLY_DPI(14);</a>
<a name="ln2044"> </a>
<a name="ln2045">    module-&gt;blend_data = g_malloc0(sizeof(dt_iop_gui_blend_data_t));</a>
<a name="ln2046">    dt_iop_gui_blend_data_t *bd = (dt_iop_gui_blend_data_t *)module-&gt;blend_data;</a>
<a name="ln2047"> </a>
<a name="ln2048">    bd-&gt;iopw = iopw;</a>
<a name="ln2049">    bd-&gt;module = module;</a>
<a name="ln2050">    bd-&gt;csp = dt_iop_module_colorspace(module);</a>
<a name="ln2051">    bd-&gt;blendif_support = (bd-&gt;csp == iop_cs_Lab || bd-&gt;csp == iop_cs_rgb);</a>
<a name="ln2052">    bd-&gt;masks_support = !(module-&gt;flags() &amp; IOP_FLAGS_NO_MASKS);</a>
<a name="ln2053"> </a>
<a name="ln2054">    bd-&gt;masks_modes = NULL;</a>
<a name="ln2055">    bd-&gt;masks_modes_toggles = NULL;</a>
<a name="ln2056">    bd-&gt;blend_modes = NULL;</a>
<a name="ln2057">    bd-&gt;masks_combine = NULL;</a>
<a name="ln2058">    bd-&gt;masks_invert = NULL;</a>
<a name="ln2059">    bd-&gt;blend_modes_all = NULL;</a>
<a name="ln2060"> </a>
<a name="ln2061">    dt_pthread_mutex_init(&amp;bd-&gt;lock, NULL);</a>
<a name="ln2062">    dt_pthread_mutex_lock(&amp;bd-&gt;lock);</a>
<a name="ln2063">    bd-&gt;timeout_handle = 0;</a>
<a name="ln2064">    bd-&gt;save_for_leave = 0;</a>
<a name="ln2065">    dt_pthread_mutex_unlock(&amp;bd-&gt;lock);</a>
<a name="ln2066"> </a>
<a name="ln2067"> </a>
<a name="ln2068">    /** generate a list of all available blend modes */</a>
<a name="ln2069">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;normal&quot;), DEVELOP_BLEND_NORMAL2);</a>
<a name="ln2070">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;normal bounded&quot;), DEVELOP_BLEND_BOUNDED);</a>
<a name="ln2071">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;lighten&quot;), DEVELOP_BLEND_LIGHTEN);</a>
<a name="ln2072">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;darken&quot;), DEVELOP_BLEND_DARKEN);</a>
<a name="ln2073">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;multiply&quot;), DEVELOP_BLEND_MULTIPLY);</a>
<a name="ln2074">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;average&quot;), DEVELOP_BLEND_AVERAGE);</a>
<a name="ln2075">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;addition&quot;), DEVELOP_BLEND_ADD);</a>
<a name="ln2076">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;subtract&quot;), DEVELOP_BLEND_SUBSTRACT);</a>
<a name="ln2077">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;difference&quot;), DEVELOP_BLEND_DIFFERENCE2);</a>
<a name="ln2078">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;screen&quot;), DEVELOP_BLEND_SCREEN);</a>
<a name="ln2079">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;overlay&quot;), DEVELOP_BLEND_OVERLAY);</a>
<a name="ln2080">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;softlight&quot;), DEVELOP_BLEND_SOFTLIGHT);</a>
<a name="ln2081">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;hardlight&quot;), DEVELOP_BLEND_HARDLIGHT);</a>
<a name="ln2082">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;vividlight&quot;), DEVELOP_BLEND_VIVIDLIGHT);</a>
<a name="ln2083">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;linearlight&quot;), DEVELOP_BLEND_LINEARLIGHT);</a>
<a name="ln2084">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;pinlight&quot;), DEVELOP_BLEND_PINLIGHT);</a>
<a name="ln2085">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;lightness&quot;), DEVELOP_BLEND_LIGHTNESS);</a>
<a name="ln2086">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;chroma&quot;), DEVELOP_BLEND_CHROMA);</a>
<a name="ln2087">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;hue&quot;), DEVELOP_BLEND_HUE);</a>
<a name="ln2088">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;color&quot;), DEVELOP_BLEND_COLOR);</a>
<a name="ln2089">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;coloradjustment&quot;),</a>
<a name="ln2090">                         DEVELOP_BLEND_COLORADJUST);</a>
<a name="ln2091">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;Lab lightness&quot;),</a>
<a name="ln2092">                         DEVELOP_BLEND_LAB_LIGHTNESS);</a>
<a name="ln2093">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;Lab color&quot;), DEVELOP_BLEND_LAB_COLOR);</a>
<a name="ln2094">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;Lab L-channel&quot;),</a>
<a name="ln2095">                         DEVELOP_BLEND_LAB_L);</a>
<a name="ln2096">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;Lab a-channel&quot;),</a>
<a name="ln2097">                         DEVELOP_BLEND_LAB_A);</a>
<a name="ln2098">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;Lab b-channel&quot;),</a>
<a name="ln2099">                         DEVELOP_BLEND_LAB_B);</a>
<a name="ln2100">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;HSV lightness&quot;),</a>
<a name="ln2101">                         DEVELOP_BLEND_HSV_LIGHTNESS);</a>
<a name="ln2102">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;HSV color&quot;), DEVELOP_BLEND_HSV_COLOR);</a>
<a name="ln2103">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;RGB red channel&quot;),</a>
<a name="ln2104">                         DEVELOP_BLEND_RGB_R);</a>
<a name="ln2105">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;RGB green channel&quot;),</a>
<a name="ln2106">                         DEVELOP_BLEND_RGB_G);</a>
<a name="ln2107">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;RGB blue channel&quot;),</a>
<a name="ln2108">                         DEVELOP_BLEND_RGB_B);</a>
<a name="ln2109"> </a>
<a name="ln2110">    /** deprecated blend modes: make them available as legacy history stacks might want them */</a>
<a name="ln2111">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;difference (deprecated)&quot;),</a>
<a name="ln2112">                         DEVELOP_BLEND_DIFFERENCE);</a>
<a name="ln2113">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;inverse (deprecated)&quot;),</a>
<a name="ln2114">                         DEVELOP_BLEND_INVERSE);</a>
<a name="ln2115">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;normal (deprecated)&quot;), DEVELOP_BLEND_NORMAL);</a>
<a name="ln2116">    _collect_blend_modes(&amp;(bd-&gt;blend_modes_all), C_(&quot;blendmode&quot;, &quot;unbounded (deprecated)&quot;),</a>
<a name="ln2117">                         DEVELOP_BLEND_UNBOUNDED);</a>
<a name="ln2118"> </a>
<a name="ln2119">    //toggle buttons creation for masks modes</a>
<a name="ln2120">    GtkWidget *but = NULL;</a>
<a name="ln2121"> </a>
<a name="ln2122">    // DEVELOP_MASK_DISABLED</a>
<a name="ln2123">    but = dtgtk_button_new(dtgtk_cairo_paint_cancel, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln2124">    gtk_widget_set_tooltip_text(but, _(&quot;off&quot;));</a>
<a name="ln2125">    bd-&gt;masks_modes = g_list_append(bd-&gt;masks_modes, GUINT_TO_POINTER(DEVELOP_MASK_DISABLED));</a>
<a name="ln2126">    bd-&gt;masks_modes_toggles = g_list_append(bd-&gt;masks_modes_toggles , GTK_WIDGET(but));</a>
<a name="ln2127">    g_signal_connect(G_OBJECT(but), &quot;button-press-event&quot;, G_CALLBACK(_blendop_masks_modes_none_clicked), module);</a>
<a name="ln2128"> </a>
<a name="ln2129">    // DEVELOP_MASK_ENABLED</a>
<a name="ln2130">    but = dtgtk_togglebutton_new(dtgtk_cairo_paint_masks_uniform, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln2131">    gtk_widget_set_tooltip_text(but, _(&quot;uniformly&quot;));</a>
<a name="ln2132">    bd-&gt;masks_modes = g_list_append(bd-&gt;masks_modes, GUINT_TO_POINTER(DEVELOP_MASK_ENABLED));</a>
<a name="ln2133">    bd-&gt;masks_modes_toggles  = g_list_append(bd-&gt;masks_modes_toggles , GTK_WIDGET(but));</a>
<a name="ln2134">    g_signal_connect(G_OBJECT(but), &quot;toggled&quot;, G_CALLBACK(_blendop_masks_modes_uni_toggled), module);</a>
<a name="ln2135"> </a>
<a name="ln2136">    if(bd-&gt;masks_support) //DEVELOP_MASK_ENABLED | DEVELOP_MASK_MASK</a>
<a name="ln2137">    {</a>
<a name="ln2138">      but = dtgtk_togglebutton_new(dtgtk_cairo_paint_masks_drawn, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln2139">      gtk_widget_set_tooltip_text(but, _(&quot;drawn mask&quot;));</a>
<a name="ln2140">      bd-&gt;masks_modes = g_list_append(bd-&gt;masks_modes, GUINT_TO_POINTER(DEVELOP_MASK_ENABLED | DEVELOP_MASK_MASK));</a>
<a name="ln2141">      bd-&gt;masks_modes_toggles = g_list_append(bd-&gt;masks_modes_toggles, GTK_WIDGET(but));</a>
<a name="ln2142">      g_signal_connect(G_OBJECT(but), &quot;toggled&quot;, G_CALLBACK(_blendop_masks_modes_drawn_toggled), module);</a>
<a name="ln2143">    }</a>
<a name="ln2144">    if(bd-&gt;blendif_support) //DEVELOP_MASK_ENABLED | DEVELOP_MASK_CONDITIONAL</a>
<a name="ln2145">    {</a>
<a name="ln2146">      but = dtgtk_togglebutton_new(dtgtk_cairo_paint_masks_parametric, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER,</a>
<a name="ln2147">                                   NULL);</a>
<a name="ln2148">      gtk_widget_set_tooltip_text(but, _(&quot;parametric mask&quot;));</a>
<a name="ln2149">      bd-&gt;masks_modes</a>
<a name="ln2150">          = g_list_append(bd-&gt;masks_modes, GUINT_TO_POINTER(DEVELOP_MASK_ENABLED | DEVELOP_MASK_CONDITIONAL));</a>
<a name="ln2151">      bd-&gt;masks_modes_toggles = g_list_append(bd-&gt;masks_modes_toggles, GTK_WIDGET(but));</a>
<a name="ln2152">      g_signal_connect(G_OBJECT(but), &quot;toggled&quot;, G_CALLBACK(_blendop_masks_modes_param_toggled), module);</a>
<a name="ln2153">    }</a>
<a name="ln2154"> </a>
<a name="ln2155">    if(bd-&gt;blendif_support &amp;&amp; bd-&gt;masks_support) //DEVELOP_MASK_ENABLED | DEVELOP_MASK_MASK_CONDITIONAL</a>
<a name="ln2156">    {</a>
<a name="ln2157">      but = dtgtk_togglebutton_new(dtgtk_cairo_paint_masks_drawn_and_parametric,</a>
<a name="ln2158">                                   CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL); // overlays and</a>
<a name="ln2159">      gtk_widget_set_tooltip_text(but, _(&quot;drawn &amp; parametric mask&quot;));</a>
<a name="ln2160">      bd-&gt;masks_modes</a>
<a name="ln2161">          = g_list_append(bd-&gt;masks_modes, GUINT_TO_POINTER(DEVELOP_MASK_ENABLED | DEVELOP_MASK_MASK_CONDITIONAL));</a>
<a name="ln2162">      bd-&gt;masks_modes_toggles = g_list_append(bd-&gt;masks_modes_toggles, GTK_WIDGET(but));</a>
<a name="ln2163">      g_signal_connect(G_OBJECT(but), &quot;toggled&quot;, G_CALLBACK(_blendop_masks_modes_both_toggled), module);</a>
<a name="ln2164">    }</a>
<a name="ln2165"> </a>
<a name="ln2166">    if(bd-&gt;masks_support) //DEVELOP_MASK_ENABLED | DEVELOP_MASK_RASTER</a>
<a name="ln2167">    {</a>
<a name="ln2168">      but = dtgtk_togglebutton_new(dtgtk_cairo_paint_masks_raster, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln2169">      gtk_widget_set_tooltip_text(but, _(&quot;raster mask&quot;));</a>
<a name="ln2170">      bd-&gt;masks_modes</a>
<a name="ln2171">          = g_list_append(bd-&gt;masks_modes, GUINT_TO_POINTER(DEVELOP_MASK_ENABLED | DEVELOP_MASK_RASTER));</a>
<a name="ln2172">      bd-&gt;masks_modes_toggles = g_list_append(bd-&gt;masks_modes_toggles, GTK_WIDGET(but));</a>
<a name="ln2173">      g_signal_connect(G_OBJECT(but), &quot;toggled&quot;, G_CALLBACK(_blendop_masks_modes_raster_toggled), module);</a>
<a name="ln2174">    }</a>
<a name="ln2175">    // initial state is no mask</a>
<a name="ln2176">    bd-&gt;selected_mask_mode = GTK_WIDGET(</a>
<a name="ln2177">        g_list_nth_data(bd-&gt;masks_modes_toggles,</a>
<a name="ln2178">                        g_list_index(bd-&gt;masks_modes, (gconstpointer)DEVELOP_MASK_DISABLED)));</a>
<a name="ln2179"> </a>
<a name="ln2180">    bd-&gt;blend_modes_combo = dt_bauhaus_combobox_new(module);</a>
<a name="ln2181">    dt_bauhaus_widget_set_label(bd-&gt;blend_modes_combo, _(&quot;blend&quot;), _(&quot;blend mode&quot;));</a>
<a name="ln2182">    gtk_widget_set_tooltip_text(bd-&gt;blend_modes_combo, _(&quot;choose blending mode&quot;));</a>
<a name="ln2183"> </a>
<a name="ln2184">    switch(bd-&gt;csp)</a>
<a name="ln2185">    {</a>
<a name="ln2186">      case iop_cs_Lab:</a>
<a name="ln2187">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2188">                             DEVELOP_BLEND_NORMAL2);</a>
<a name="ln2189">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2190">                             DEVELOP_BLEND_BOUNDED);</a>
<a name="ln2191">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2192">                             DEVELOP_BLEND_LIGHTEN);</a>
<a name="ln2193">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2194">                             DEVELOP_BLEND_DARKEN);</a>
<a name="ln2195">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2196">                             DEVELOP_BLEND_MULTIPLY);</a>
<a name="ln2197">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2198">                             DEVELOP_BLEND_AVERAGE);</a>
<a name="ln2199">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2200">                             DEVELOP_BLEND_ADD);</a>
<a name="ln2201">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2202">                             DEVELOP_BLEND_SUBSTRACT);</a>
<a name="ln2203">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2204">                             DEVELOP_BLEND_DIFFERENCE2);</a>
<a name="ln2205">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2206">                             DEVELOP_BLEND_SCREEN);</a>
<a name="ln2207">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2208">                             DEVELOP_BLEND_OVERLAY);</a>
<a name="ln2209">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2210">                             DEVELOP_BLEND_SOFTLIGHT);</a>
<a name="ln2211">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2212">                             DEVELOP_BLEND_HARDLIGHT);</a>
<a name="ln2213">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2214">                             DEVELOP_BLEND_VIVIDLIGHT);</a>
<a name="ln2215">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2216">                             DEVELOP_BLEND_LINEARLIGHT);</a>
<a name="ln2217">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2218">                             DEVELOP_BLEND_PINLIGHT);</a>
<a name="ln2219">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2220">                             DEVELOP_BLEND_LAB_LIGHTNESS);</a>
<a name="ln2221">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2222">                             DEVELOP_BLEND_LAB_A);</a>
<a name="ln2223">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2224">                             DEVELOP_BLEND_LAB_B);</a>
<a name="ln2225">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2226">                             DEVELOP_BLEND_LAB_COLOR);</a>
<a name="ln2227">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2228">                             DEVELOP_BLEND_LIGHTNESS);</a>
<a name="ln2229">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2230">                             DEVELOP_BLEND_CHROMA);</a>
<a name="ln2231">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2232">                             DEVELOP_BLEND_HUE);</a>
<a name="ln2233">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2234">                             DEVELOP_BLEND_COLOR);</a>
<a name="ln2235">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2236">                             DEVELOP_BLEND_COLORADJUST);</a>
<a name="ln2237">        break;</a>
<a name="ln2238"> </a>
<a name="ln2239">      case iop_cs_rgb:</a>
<a name="ln2240">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2241">                             DEVELOP_BLEND_NORMAL2);</a>
<a name="ln2242">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2243">                             DEVELOP_BLEND_BOUNDED);</a>
<a name="ln2244">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2245">                             DEVELOP_BLEND_LIGHTEN);</a>
<a name="ln2246">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2247">                             DEVELOP_BLEND_DARKEN);</a>
<a name="ln2248">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2249">                             DEVELOP_BLEND_MULTIPLY);</a>
<a name="ln2250">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2251">                             DEVELOP_BLEND_AVERAGE);</a>
<a name="ln2252">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2253">                             DEVELOP_BLEND_ADD);</a>
<a name="ln2254">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2255">                             DEVELOP_BLEND_SUBSTRACT);</a>
<a name="ln2256">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2257">                             DEVELOP_BLEND_DIFFERENCE2);</a>
<a name="ln2258">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2259">                             DEVELOP_BLEND_SCREEN);</a>
<a name="ln2260">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2261">                             DEVELOP_BLEND_OVERLAY);</a>
<a name="ln2262">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2263">                             DEVELOP_BLEND_SOFTLIGHT);</a>
<a name="ln2264">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2265">                             DEVELOP_BLEND_HARDLIGHT);</a>
<a name="ln2266">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2267">                             DEVELOP_BLEND_VIVIDLIGHT);</a>
<a name="ln2268">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2269">                             DEVELOP_BLEND_LINEARLIGHT);</a>
<a name="ln2270">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2271">                             DEVELOP_BLEND_PINLIGHT);</a>
<a name="ln2272">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2273">                             DEVELOP_BLEND_HSV_LIGHTNESS);</a>
<a name="ln2274">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2275">                             DEVELOP_BLEND_HSV_COLOR);</a>
<a name="ln2276">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2277">                             DEVELOP_BLEND_RGB_R);</a>
<a name="ln2278">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2279">                             DEVELOP_BLEND_RGB_G);</a>
<a name="ln2280">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2281">                             DEVELOP_BLEND_RGB_B);</a>
<a name="ln2282">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2283">                             DEVELOP_BLEND_LIGHTNESS);</a>
<a name="ln2284">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2285">                             DEVELOP_BLEND_CHROMA);</a>
<a name="ln2286">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2287">                             DEVELOP_BLEND_HUE);</a>
<a name="ln2288">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2289">                             DEVELOP_BLEND_COLOR);</a>
<a name="ln2290">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2291">                             DEVELOP_BLEND_COLORADJUST);</a>
<a name="ln2292">        break;</a>
<a name="ln2293"> </a>
<a name="ln2294">      case iop_cs_RAW:</a>
<a name="ln2295">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2296">                             DEVELOP_BLEND_NORMAL2);</a>
<a name="ln2297">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2298">                             DEVELOP_BLEND_BOUNDED);</a>
<a name="ln2299">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2300">                             DEVELOP_BLEND_LIGHTEN);</a>
<a name="ln2301">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2302">                             DEVELOP_BLEND_DARKEN);</a>
<a name="ln2303">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2304">                             DEVELOP_BLEND_MULTIPLY);</a>
<a name="ln2305">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2306">                             DEVELOP_BLEND_AVERAGE);</a>
<a name="ln2307">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2308">                             DEVELOP_BLEND_ADD);</a>
<a name="ln2309">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2310">                             DEVELOP_BLEND_SUBSTRACT);</a>
<a name="ln2311">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2312">                             DEVELOP_BLEND_DIFFERENCE2);</a>
<a name="ln2313">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2314">                             DEVELOP_BLEND_SCREEN);</a>
<a name="ln2315">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2316">                             DEVELOP_BLEND_OVERLAY);</a>
<a name="ln2317">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2318">                             DEVELOP_BLEND_SOFTLIGHT);</a>
<a name="ln2319">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2320">                             DEVELOP_BLEND_HARDLIGHT);</a>
<a name="ln2321">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2322">                             DEVELOP_BLEND_VIVIDLIGHT);</a>
<a name="ln2323">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2324">                             DEVELOP_BLEND_LINEARLIGHT);</a>
<a name="ln2325">        _add_blendmode_combo(&amp;(bd-&gt;blend_modes), bd-&gt;blend_modes_combo, bd-&gt;blend_modes_all,</a>
<a name="ln2326">                             DEVELOP_BLEND_PINLIGHT);</a>
<a name="ln2327">        break;</a>
<a name="ln2328">    }</a>
<a name="ln2329"> </a>
<a name="ln2330"> </a>
<a name="ln2331">    dt_bauhaus_combobox_set(bd-&gt;blend_modes_combo, 0);</a>
<a name="ln2332">    g_signal_connect(G_OBJECT(bd-&gt;blend_modes_combo), &quot;value-changed&quot;,</a>
<a name="ln2333">                     G_CALLBACK(_blendop_blend_mode_callback), bd);</a>
<a name="ln2334">    dt_gui_add_help_link(GTK_WIDGET(bd-&gt;blend_modes_combo), &quot;blending_operators.html&quot;);</a>
<a name="ln2335"> </a>
<a name="ln2336"> </a>
<a name="ln2337">    bd-&gt;opacity_slider = dt_bauhaus_slider_new_with_range(module, 0.0, 100.0, 1, 100.0, 0);</a>
<a name="ln2338">    dt_bauhaus_widget_set_label(bd-&gt;opacity_slider, _(&quot;blend&quot;), _(&quot;opacity&quot;));</a>
<a name="ln2339">    dt_bauhaus_slider_set_format(bd-&gt;opacity_slider, &quot;%.0f%%&quot;);</a>
<a name="ln2340">    module-&gt;fusion_slider = bd-&gt;opacity_slider;</a>
<a name="ln2341">    gtk_widget_set_tooltip_text(bd-&gt;opacity_slider, _(&quot;set the opacity of the blending&quot;));</a>
<a name="ln2342">    g_signal_connect(G_OBJECT(bd-&gt;opacity_slider), &quot;value-changed&quot;, G_CALLBACK(_blendop_opacity_callback), bd);</a>
<a name="ln2343"> </a>
<a name="ln2344"> </a>
<a name="ln2345">    bd-&gt;masks_combine_combo = dt_bauhaus_combobox_new(module);</a>
<a name="ln2346">    dt_bauhaus_widget_set_label(bd-&gt;masks_combine_combo, _(&quot;blend&quot;), _(&quot;combine masks&quot;));</a>
<a name="ln2347"> </a>
<a name="ln2348">    dt_bauhaus_combobox_add(bd-&gt;masks_combine_combo, _(&quot;exclusive&quot;));</a>
<a name="ln2349">    bd-&gt;masks_combine = g_list_append(bd-&gt;masks_combine, GUINT_TO_POINTER(DEVELOP_COMBINE_NORM_EXCL));</a>
<a name="ln2350"> </a>
<a name="ln2351">    dt_bauhaus_combobox_add(bd-&gt;masks_combine_combo, _(&quot;inclusive&quot;));</a>
<a name="ln2352">    bd-&gt;masks_combine = g_list_append(bd-&gt;masks_combine, GUINT_TO_POINTER(DEVELOP_COMBINE_NORM_INCL));</a>
<a name="ln2353"> </a>
<a name="ln2354">    dt_bauhaus_combobox_add(bd-&gt;masks_combine_combo, _(&quot;exclusive &amp; inverted&quot;));</a>
<a name="ln2355">    bd-&gt;masks_combine = g_list_append(bd-&gt;masks_combine, GUINT_TO_POINTER(DEVELOP_COMBINE_INV_EXCL));</a>
<a name="ln2356"> </a>
<a name="ln2357">    dt_bauhaus_combobox_add(bd-&gt;masks_combine_combo, _(&quot;inclusive &amp; inverted&quot;));</a>
<a name="ln2358">    bd-&gt;masks_combine = g_list_append(bd-&gt;masks_combine, GUINT_TO_POINTER(DEVELOP_COMBINE_INV_INCL));</a>
<a name="ln2359"> </a>
<a name="ln2360">    dt_bauhaus_combobox_set(bd-&gt;masks_combine_combo, 0);</a>
<a name="ln2361">    gtk_widget_set_tooltip_text(bd-&gt;masks_combine_combo,</a>
<a name="ln2362">                                _(&quot;how to combine individual drawn mask and different channels of parametric mask&quot;));</a>
<a name="ln2363">    g_signal_connect(G_OBJECT(bd-&gt;masks_combine_combo), &quot;value-changed&quot;,</a>
<a name="ln2364">                     G_CALLBACK(_blendop_masks_combine_callback), bd);</a>
<a name="ln2365"> </a>
<a name="ln2366"> </a>
<a name="ln2367">    bd-&gt;masks_invert_combo = dt_bauhaus_combobox_new(module);</a>
<a name="ln2368">    dt_bauhaus_widget_set_label(bd-&gt;masks_invert_combo, _(&quot;blend&quot;), _(&quot;invert mask&quot;));</a>
<a name="ln2369"> </a>
<a name="ln2370">    dt_bauhaus_combobox_add(bd-&gt;masks_invert_combo, _(&quot;off&quot;));</a>
<a name="ln2371">    bd-&gt;masks_invert = g_list_append(bd-&gt;masks_invert, GUINT_TO_POINTER(DEVELOP_COMBINE_NORM));</a>
<a name="ln2372"> </a>
<a name="ln2373">    dt_bauhaus_combobox_add(bd-&gt;masks_invert_combo, _(&quot;on&quot;));</a>
<a name="ln2374">    bd-&gt;masks_invert = g_list_append(bd-&gt;masks_invert, GUINT_TO_POINTER(DEVELOP_COMBINE_INV));</a>
<a name="ln2375"> </a>
<a name="ln2376">    dt_bauhaus_combobox_set(bd-&gt;masks_invert_combo, 0);</a>
<a name="ln2377">    gtk_widget_set_tooltip_text(bd-&gt;masks_invert_combo, _(&quot;apply mask in normal or inverted mode&quot;));</a>
<a name="ln2378">    g_signal_connect(G_OBJECT(bd-&gt;masks_invert_combo), &quot;value-changed&quot;,</a>
<a name="ln2379">                     G_CALLBACK(_blendop_masks_invert_callback), bd);</a>
<a name="ln2380"> </a>
<a name="ln2381"> </a>
<a name="ln2382">    bd-&gt;masks_feathering_guide_combo = dt_bauhaus_combobox_new(module);</a>
<a name="ln2383">    dt_bauhaus_widget_set_label(bd-&gt;masks_feathering_guide_combo, _(&quot;feathering guide&quot;), _(&quot;feathering guide&quot;));</a>
<a name="ln2384"> </a>
<a name="ln2385">    dt_bauhaus_combobox_add(bd-&gt;masks_feathering_guide_combo, _(&quot;output image&quot;));</a>
<a name="ln2386">    bd-&gt;masks_feathering_guide</a>
<a name="ln2387">        = g_list_append(bd-&gt;masks_feathering_guide, GUINT_TO_POINTER(DEVELOP_MASK_GUIDE_OUT));</a>
<a name="ln2388"> </a>
<a name="ln2389">    dt_bauhaus_combobox_add(bd-&gt;masks_feathering_guide_combo, _(&quot;input image&quot;));</a>
<a name="ln2390">    bd-&gt;masks_feathering_guide</a>
<a name="ln2391">        = g_list_append(bd-&gt;masks_feathering_guide, GUINT_TO_POINTER(DEVELOP_MASK_GUIDE_IN));</a>
<a name="ln2392"> </a>
<a name="ln2393">    dt_bauhaus_combobox_set(bd-&gt;masks_feathering_guide_combo, 0);</a>
<a name="ln2394">    gtk_widget_set_tooltip_text(bd-&gt;masks_feathering_guide_combo,</a>
<a name="ln2395">                                _(&quot;choose to guide mask by input or output image&quot;));</a>
<a name="ln2396">    g_signal_connect(G_OBJECT(bd-&gt;masks_feathering_guide_combo), &quot;value-changed&quot;,</a>
<a name="ln2397">                     G_CALLBACK(_blendop_masks_feathering_guide_callback), bd);</a>
<a name="ln2398"> </a>
<a name="ln2399"> </a>
<a name="ln2400">    bd-&gt;feathering_radius_slider = dt_bauhaus_slider_new_with_range(module, 0.0, 250.0, 0.1, 0.0, 1);</a>
<a name="ln2401">    dt_bauhaus_widget_set_label(bd-&gt;feathering_radius_slider, _(&quot;blend&quot;), _(&quot;feathering radius&quot;));</a>
<a name="ln2402">    dt_bauhaus_slider_set_format(bd-&gt;feathering_radius_slider, &quot;%.1f&quot;);</a>
<a name="ln2403">    gtk_widget_set_tooltip_text(bd-&gt;feathering_radius_slider, _(&quot;spatial radius of feathering&quot;));</a>
<a name="ln2404">    g_signal_connect(G_OBJECT(bd-&gt;feathering_radius_slider), &quot;value-changed&quot;,</a>
<a name="ln2405">                     G_CALLBACK(_blendop_blendif_feathering_radius_callback), bd);</a>
<a name="ln2406"> </a>
<a name="ln2407"> </a>
<a name="ln2408">    bd-&gt;blur_radius_slider = dt_bauhaus_slider_new_with_range(module, 0.0, 100.0, 0.1, 0.0, 1);</a>
<a name="ln2409">    dt_bauhaus_widget_set_label(bd-&gt;blur_radius_slider, _(&quot;blend&quot;), _(&quot;mask blur&quot;));</a>
<a name="ln2410">    dt_bauhaus_slider_set_format(bd-&gt;blur_radius_slider, &quot;%.1f&quot;);</a>
<a name="ln2411">    gtk_widget_set_tooltip_text(bd-&gt;blur_radius_slider, _(&quot;radius for gaussian blur of blend mask&quot;));</a>
<a name="ln2412">    g_signal_connect(G_OBJECT(bd-&gt;blur_radius_slider), &quot;value-changed&quot;,</a>
<a name="ln2413">                     G_CALLBACK(_blendop_blendif_blur_radius_callback), bd);</a>
<a name="ln2414"> </a>
<a name="ln2415"> </a>
<a name="ln2416">    bd-&gt;brightness_slider = dt_bauhaus_slider_new_with_range(module, -1.0, 1.0, 0.01, 0.0, 2);</a>
<a name="ln2417">    dt_bauhaus_widget_set_label(bd-&gt;brightness_slider, _(&quot;blend&quot;), _(&quot;mask opacity&quot;));</a>
<a name="ln2418">    dt_bauhaus_slider_set_format(bd-&gt;brightness_slider, &quot;%.2f&quot;);</a>
<a name="ln2419">    gtk_widget_set_tooltip_text(bd-&gt;brightness_slider, _(&quot;shifts and tilts the tone curve of the blend mask to adjust its &quot;</a>
<a name="ln2420">                                                         &quot;brightness without affecting fully transparent/fully opaque &quot;</a>
<a name="ln2421">                                                         &quot;regions&quot;));</a>
<a name="ln2422">    g_signal_connect(G_OBJECT(bd-&gt;brightness_slider), &quot;value-changed&quot;,</a>
<a name="ln2423">                     G_CALLBACK(_blendop_blendif_brightness_callback), bd);</a>
<a name="ln2424"> </a>
<a name="ln2425"> </a>
<a name="ln2426">    bd-&gt;contrast_slider = dt_bauhaus_slider_new_with_range(module, -1.0, 1.0, 0.01, 0.0, 2);</a>
<a name="ln2427">    dt_bauhaus_widget_set_label(bd-&gt;contrast_slider, _(&quot;blend&quot;), _(&quot;mask contrast&quot;));</a>
<a name="ln2428">    dt_bauhaus_slider_set_format(bd-&gt;contrast_slider, &quot;%.2f&quot;);</a>
<a name="ln2429">    gtk_widget_set_tooltip_text(bd-&gt;contrast_slider, _(&quot;gives the tone curve of the blend mask an s-like shape to &quot;</a>
<a name="ln2430">                                                       &quot;adjust its contrast&quot;));</a>
<a name="ln2431">    g_signal_connect(G_OBJECT(bd-&gt;contrast_slider), &quot;value-changed&quot;,</a>
<a name="ln2432">                     G_CALLBACK(_blendop_blendif_contrast_callback), bd);</a>
<a name="ln2433"> </a>
<a name="ln2434"> </a>
<a name="ln2435">    bd-&gt;showmask = dtgtk_button_new(dtgtk_cairo_paint_showmask, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln2436">    gtk_widget_set_tooltip_text(bd-&gt;showmask, _(&quot;display mask and/or color channel. ctrl-click to display mask, &quot;</a>
<a name="ln2437">                                                &quot;shift-click to display channel. hover over parametric mask slider to &quot;</a>
<a name="ln2438">                                                &quot;select channel for display&quot;));</a>
<a name="ln2439">    gtk_widget_set_size_request(GTK_WIDGET(bd-&gt;showmask), bs, bs);</a>
<a name="ln2440">    g_signal_connect(G_OBJECT(bd-&gt;showmask), &quot;button-press-event&quot;, G_CALLBACK(_blendop_blendif_showmask_clicked), module);</a>
<a name="ln2441">    gtk_widget_set_name(bd-&gt;showmask, &quot;show_mask_button&quot;);</a>
<a name="ln2442"> </a>
<a name="ln2443">    bd-&gt;suppress</a>
<a name="ln2444">        = dtgtk_togglebutton_new(dtgtk_cairo_paint_eye_toggle, CPF_STYLE_FLAT | CPF_DO_NOT_USE_BORDER, NULL);</a>
<a name="ln2445">    gtk_widget_set_tooltip_text(bd-&gt;suppress, _(&quot;temporarily switch off blend mask. only for module in focus&quot;));</a>
<a name="ln2446">    gtk_widget_set_size_request(GTK_WIDGET(bd-&gt;suppress), bs, bs);</a>
<a name="ln2447">    g_signal_connect(G_OBJECT(bd-&gt;suppress), &quot;toggled&quot;, G_CALLBACK(_blendop_blendif_suppress_toggled), module);</a>
<a name="ln2448"> </a>
<a name="ln2449">    GtkWidget *box = gtk_box_new(GTK_ORIENTATION_VERTICAL, DT_BAUHAUS_SPACE);</a>
<a name="ln2450">    gtk_box_pack_start(GTK_BOX(iopw), GTK_WIDGET(box), TRUE, TRUE, 0);</a>
<a name="ln2451"> </a>
<a name="ln2452">    GtkWidget *blend_label = dt_ui_section_label_new(_(&quot;blend options&quot;));</a>
<a name="ln2453">    gtk_box_pack_start(GTK_BOX(box), blend_label, TRUE, TRUE, 0);</a>
<a name="ln2454">    gtk_widget_set_tooltip_text(GTK_WIDGET(blend_label), _(&quot;activate blending: uniformly, with drawn mask, with &quot;</a>
<a name="ln2455">                                                        &quot;parametric mask, or combination of both&quot;));</a>
<a name="ln2456"> </a>
<a name="ln2457">    //box enclosing the mask mode selection buttons</a>
<a name="ln2458">    bd-&gt;masks_modes_box = GTK_BOX(gtk_box_new(GTK_ORIENTATION_HORIZONTAL, DT_BAUHAUS_SPACE));</a>
<a name="ln2459">    //mask selection buttons packing in mask_box</a>
<a name="ln2460">    for (int i = 0; i &lt; g_list_length(bd-&gt;masks_modes_toggles); i++)</a>
<a name="ln2461">      gtk_box_pack_start(GTK_BOX(bd-&gt;masks_modes_box), GTK_WIDGET(g_list_nth_data(bd-&gt;masks_modes_toggles, i)), TRUE, TRUE, 0);</a>
<a name="ln2462">    gtk_box_pack_start(GTK_BOX(box), GTK_WIDGET(bd-&gt;masks_modes_box), FALSE, FALSE, 0);</a>
<a name="ln2463">    dt_gui_add_help_link(GTK_WIDGET(bd-&gt;masks_modes_box), &quot;blending.html&quot;);</a>
<a name="ln2464"> </a>
<a name="ln2465">    bd-&gt;top_box = GTK_BOX(gtk_box_new(GTK_ORIENTATION_VERTICAL, DT_BAUHAUS_SPACE));</a>
<a name="ln2466">    gtk_box_pack_start(GTK_BOX(bd-&gt;top_box), bd-&gt;blend_modes_combo, TRUE, TRUE, 0);</a>
<a name="ln2467">    gtk_box_pack_start(GTK_BOX(bd-&gt;top_box), bd-&gt;opacity_slider, TRUE, TRUE, 0);</a>
<a name="ln2468">    gtk_box_pack_start(GTK_BOX(box), GTK_WIDGET(bd-&gt;top_box), TRUE, TRUE, 0);</a>
<a name="ln2469"> </a>
<a name="ln2470">    dt_iop_gui_init_masks(GTK_BOX(iopw), module);</a>
<a name="ln2471">    dt_iop_gui_init_raster(GTK_BOX(iopw), module);</a>
<a name="ln2472">    dt_iop_gui_init_blendif(GTK_BOX(iopw), module);</a>
<a name="ln2473"> </a>
<a name="ln2474">    GtkWidget *hbox = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 4*DT_BAUHAUS_SPACE);</a>
<a name="ln2475">    gtk_box_pack_end(GTK_BOX(hbox), GTK_WIDGET(bd-&gt;showmask), FALSE, FALSE, 0);</a>
<a name="ln2476">    gtk_box_pack_end(GTK_BOX(hbox), GTK_WIDGET(bd-&gt;suppress), FALSE, FALSE, 0);</a>
<a name="ln2477">    bd-&gt;bottom_box = GTK_BOX(gtk_box_new(GTK_ORIENTATION_VERTICAL, DT_BAUHAUS_SPACE));</a>
<a name="ln2478">    gtk_box_pack_start(GTK_BOX(bd-&gt;bottom_box), GTK_WIDGET(bd-&gt;masks_combine_combo), TRUE, TRUE, 0);</a>
<a name="ln2479">    gtk_box_pack_start(GTK_BOX(bd-&gt;bottom_box), GTK_WIDGET(bd-&gt;masks_invert_combo), TRUE, TRUE, 0);</a>
<a name="ln2480">    gtk_box_pack_start(GTK_BOX(bd-&gt;bottom_box), dt_ui_section_label_new(_(&quot;mask refinement&quot;)), TRUE, TRUE, 0);</a>
<a name="ln2481">    gtk_box_pack_start(GTK_BOX(bd-&gt;bottom_box), bd-&gt;masks_feathering_guide_combo, TRUE, TRUE, 0);</a>
<a name="ln2482">    gtk_box_pack_start(GTK_BOX(bd-&gt;bottom_box), bd-&gt;feathering_radius_slider, TRUE, TRUE, 0);</a>
<a name="ln2483">    gtk_box_pack_start(GTK_BOX(bd-&gt;bottom_box), bd-&gt;blur_radius_slider, TRUE, TRUE, 0);</a>
<a name="ln2484">    gtk_box_pack_start(GTK_BOX(bd-&gt;bottom_box), bd-&gt;brightness_slider, TRUE, TRUE, 0);</a>
<a name="ln2485">    gtk_box_pack_start(GTK_BOX(bd-&gt;bottom_box), bd-&gt;contrast_slider, TRUE, TRUE, 0);</a>
<a name="ln2486">    gtk_box_pack_start(GTK_BOX(bd-&gt;bottom_box), hbox, TRUE, TRUE, 0);</a>
<a name="ln2487">    gtk_box_pack_start(GTK_BOX(iopw), GTK_WIDGET(bd-&gt;bottom_box), TRUE, TRUE, 0);</a>
<a name="ln2488">    dt_gui_add_help_link(GTK_WIDGET(bd-&gt;bottom_box), &quot;combined_masks.html&quot;);</a>
<a name="ln2489"> </a>
<a name="ln2490">    bd-&gt;blend_inited = 1;</a>
<a name="ln2491">    gtk_widget_queue_draw(GTK_WIDGET(iopw));</a>
<a name="ln2492">    dt_iop_gui_update_blending(module);</a>
<a name="ln2493"> </a>
<a name="ln2494">  }</a>
<a name="ln2495">}</a>
<a name="ln2496"> </a>
<a name="ln2497">// modelines: These editor modelines have been set for all relevant files by tools/update_modelines.sh</a>
<a name="ln2498">// vim: shiftwidth=2 expandtab tabstop=2 cindent</a>
<a name="ln2499">// kate: tab-indents: off; indent-width 2; replace-tabs on; indent-mode cstyle; remove-trailing-spaces modified;</a>

</code></pre>
<div class="balloon" rel="658"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v575/" target="_blank">V575</a> The null pointer is passed into 'g_list_index' function. Inspect the second argument.</p></div>
<div class="balloon" rel="671"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v575/" target="_blank">V575</a> The null pointer is passed into 'g_list_index' function. Inspect the second argument.</p></div>
<div class="balloon" rel="1652"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v522/" target="_blank">V522</a> There might be dereferencing of a potential null pointer 'entry'. Check lines: 1652, 1651.</p></div>
<div class="balloon" rel="1826"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v575/" target="_blank">V575</a> The null pointer is passed into 'g_list_index' function. Inspect the second argument.</p></div>
<div class="balloon" rel="1840"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v575/" target="_blank">V575</a> The null pointer is passed into 'g_list_index' function. Inspect the second argument.</p></div>
<div class="balloon" rel="2176"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v575/" target="_blank">V575</a> The null pointer is passed into 'g_list_index' function. Inspect the second argument.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
