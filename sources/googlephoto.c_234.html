
<html>
<head>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>
<pre><code class = "cpp">
<a name="ln1">/*</a>
<a name="ln2">    This file is part of darktable,</a>
<a name="ln3">    copyright (c) 2012 Pierre Lamot</a>
<a name="ln4">    copyright (c) 2013-2014 Jose Carlos Garcia Sogo</a>
<a name="ln5">    copyright (c) 2012-2019 Pascal Obry</a>
<a name="ln6"> </a>
<a name="ln7">    darktable is free software: you can redistribute it and/or modify</a>
<a name="ln8">    it under the terms of the GNU General Public License as published by</a>
<a name="ln9">    the Free Software Foundation, either version 3 of the License, or</a>
<a name="ln10">    (at your option) any later version.</a>
<a name="ln11"> </a>
<a name="ln12">    darktable is distributed in the hope that it will be useful,</a>
<a name="ln13">    but WITHOUT ANY WARRANTY; without even the implied warranty of</a>
<a name="ln14">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</a>
<a name="ln15">    GNU General Public License for more details.</a>
<a name="ln16"> </a>
<a name="ln17">    You should have received a copy of the GNU General Public License</a>
<a name="ln18">    along with darktable.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</a>
<a name="ln19">*/</a>
<a name="ln20"> </a>
<a name="ln21">#include &quot;common/darktable.h&quot;</a>
<a name="ln22">#include &quot;common/image.h&quot;</a>
<a name="ln23">#include &quot;common/image_cache.h&quot;</a>
<a name="ln24">#include &quot;common/imageio.h&quot;</a>
<a name="ln25">#include &quot;common/imageio_module.h&quot;</a>
<a name="ln26">#include &quot;common/metadata.h&quot;</a>
<a name="ln27">#include &quot;common/pwstorage/pwstorage.h&quot;</a>
<a name="ln28">#include &quot;common/tags.h&quot;</a>
<a name="ln29">#include &quot;common/curl_tools.h&quot;</a>
<a name="ln30">#include &quot;control/conf.h&quot;</a>
<a name="ln31">#include &quot;control/control.h&quot;</a>
<a name="ln32">#include &quot;dtgtk/button.h&quot;</a>
<a name="ln33">#include &quot;gui/gtk.h&quot;</a>
<a name="ln34">#include &quot;imageio/storage/imageio_storage_api.h&quot;</a>
<a name="ln35">#ifdef GDK_WINDOWING_QUARTZ</a>
<a name="ln36">#include &quot;osx/osx.h&quot;</a>
<a name="ln37">#endif</a>
<a name="ln38">#include &lt;curl/curl.h&gt;</a>
<a name="ln39">#include &lt;json-glib/json-glib.h&gt;</a>
<a name="ln40">#include &lt;libxml/parser.h&gt;</a>
<a name="ln41">#include &lt;stdio.h&gt;</a>
<a name="ln42">#include &lt;stdlib.h&gt;</a>
<a name="ln43">#include &lt;stdbool.h&gt;</a>
<a name="ln44">#include &lt;unistd.h&gt;</a>
<a name="ln45"> </a>
<a name="ln46">DT_MODULE(2)</a>
<a name="ln47"> </a>
<a name="ln48">#define GOOGLE_WS_BASE_URL &quot;https://accounts.google.com/&quot;</a>
<a name="ln49">#define GOOGLE_API_BASE_URL &quot;https://www.googleapis.com/&quot;</a>
<a name="ln50">#define GOOGLE_URI &quot;urn:ietf:wg:oauth:2.0:oob&quot;</a>
<a name="ln51">#define GOOGLE_GPHOTO &quot;https://photoslibrary.googleapis.com/&quot;</a>
<a name="ln52"> </a>
<a name="ln53">// client_id and client_secret are in darktablerc. those values are</a>
<a name="ln54">// shared and a max of 10.000 calls are allowed per day</a>
<a name="ln55">//  &quot;plugins/imageio/storage/gphoto/id&quot;</a>
<a name="ln56">//  &quot;plugins/imageio/storage/gphoto/secret&quot;</a>
<a name="ln57">//</a>
<a name="ln58">// to generate new: https://developers.google.com/photos/library/guides/get-started</a>
<a name="ln59"> </a>
<a name="ln60"> </a>
<a name="ln61">#define MSGCOLOR_RED &quot;#e07f7f&quot;</a>
<a name="ln62">#define MSGCOLOR_GREEN &quot;#7fe07f&quot;</a>
<a name="ln63"> </a>
<a name="ln64">#define gphoto_EXTRA_VERBOSE FALSE</a>
<a name="ln65">#define GPHOTO_STORAGE &quot;googlephoto&quot;</a>
<a name="ln66"> </a>
<a name="ln67">/** Authenticate against google gphoto service*/</a>
<a name="ln68">typedef struct _buffer_t</a>
<a name="ln69">{</a>
<a name="ln70">  char *data;</a>
<a name="ln71">  size_t size;</a>
<a name="ln72">  size_t offset;</a>
<a name="ln73">} _buffer_t;</a>
<a name="ln74"> </a>
<a name="ln75">typedef enum _combo_user_model_t</a>
<a name="ln76">{</a>
<a name="ln77">  COMBO_USER_MODEL_NAME_COL = 0,</a>
<a name="ln78">  COMBO_USER_MODEL_TOKEN_COL,</a>
<a name="ln79">  COMBO_USER_MODEL_REFRESH_TOKEN_COL,</a>
<a name="ln80">  COMBO_USER_MODEL_ID_COL,</a>
<a name="ln81">  COMBO_USER_MODEL_NB_COL</a>
<a name="ln82">} dt_combo_user_model_t;</a>
<a name="ln83"> </a>
<a name="ln84">typedef enum _combo_album_model_t</a>
<a name="ln85">{</a>
<a name="ln86">  COMBO_ALBUM_MODEL_NAME_COL = 0,</a>
<a name="ln87">  COMBO_ALBUM_MODEL_ID_COL,</a>
<a name="ln88">  COMBO_ALBUM_MODEL_NB_COL</a>
<a name="ln89">} dt_combo_album_model_t;</a>
<a name="ln90"> </a>
<a name="ln91">/**</a>
<a name="ln92"> * Represents information about an album</a>
<a name="ln93"> */</a>
<a name="ln94">typedef struct dt_gphoto_album_t</a>
<a name="ln95">{</a>
<a name="ln96">  gchar *id;</a>
<a name="ln97">  gchar *name;</a>
<a name="ln98">  int size;</a>
<a name="ln99">} dt_gphoto_album_t;</a>
<a name="ln100"> </a>
<a name="ln101">typedef struct _curl_args_t</a>
<a name="ln102">{</a>
<a name="ln103">  char name[100];</a>
<a name="ln104">  char value[2048];</a>
<a name="ln105">} _curl_args_t;</a>
<a name="ln106"> </a>
<a name="ln107">static dt_gphoto_album_t *gphoto_album_init()</a>
<a name="ln108">{</a>
<a name="ln109">  return (dt_gphoto_album_t *)g_malloc0(sizeof(dt_gphoto_album_t));</a>
<a name="ln110">}</a>
<a name="ln111"> </a>
<a name="ln112">static void gphoto_album_destroy(dt_gphoto_album_t *album)</a>
<a name="ln113">{</a>
<a name="ln114">  if(album == NULL) return;</a>
<a name="ln115">  g_free(album-&gt;id);</a>
<a name="ln116">  g_free(album-&gt;name);</a>
<a name="ln117">  g_free(album);</a>
<a name="ln118">}</a>
<a name="ln119"> </a>
<a name="ln120">/**</a>
<a name="ln121"> * Represents information about an account</a>
<a name="ln122"> */</a>
<a name="ln123">typedef struct _gphoto_account_info_t</a>
<a name="ln124">{</a>
<a name="ln125">  gchar *id;</a>
<a name="ln126">  gchar *username;</a>
<a name="ln127">  gchar *token;</a>
<a name="ln128">  gchar *refresh_token;</a>
<a name="ln129">} dt_gphoto_account_info_t;</a>
<a name="ln130"> </a>
<a name="ln131">static dt_gphoto_account_info_t *gphoto_account_info_init()</a>
<a name="ln132">{</a>
<a name="ln133">  return (dt_gphoto_account_info_t *)g_malloc0(sizeof(dt_gphoto_account_info_t));</a>
<a name="ln134">}</a>
<a name="ln135"> </a>
<a name="ln136">static void gphoto_account_info_destroy(dt_gphoto_account_info_t *account)</a>
<a name="ln137">{</a>
<a name="ln138">  if(account == NULL) return;</a>
<a name="ln139">  g_free(account-&gt;id);</a>
<a name="ln140">  g_free(account-&gt;username);</a>
<a name="ln141">  g_free(account);</a>
<a name="ln142">}</a>
<a name="ln143"> </a>
<a name="ln144">typedef struct _gphoto_context_t</a>
<a name="ln145">{</a>
<a name="ln146">  gchar album_id[1024];</a>
<a name="ln147">  gchar userid[1024];</a>
<a name="ln148"> </a>
<a name="ln149">  gchar *album_title;</a>
<a name="ln150">  int album_permission;</a>
<a name="ln151"> </a>
<a name="ln152">  /// curl context</a>
<a name="ln153">  CURL *curl_ctx;</a>
<a name="ln154">  /// Json parser context</a>
<a name="ln155">  JsonParser *json_parser;</a>
<a name="ln156"> </a>
<a name="ln157">  GString *errmsg;</a>
<a name="ln158">  GString *response;</a>
<a name="ln159"> </a>
<a name="ln160">  /// authorization token</a>
<a name="ln161">  gchar *token;</a>
<a name="ln162">  gchar *refresh_token;</a>
<a name="ln163">  gchar *google_client_id;</a>
<a name="ln164">  gchar *google_client_secret;</a>
<a name="ln165">} dt_gphoto_context_t;</a>
<a name="ln166"> </a>
<a name="ln167">typedef struct dt_storage_gphoto_gui_data_t</a>
<a name="ln168">{</a>
<a name="ln169">  // == ui elements ==</a>
<a name="ln170">  GtkLabel *label_status;</a>
<a name="ln171"> </a>
<a name="ln172">  GtkComboBox *combo_username;</a>
<a name="ln173">  GtkButton *button_login;</a>
<a name="ln174"> </a>
<a name="ln175">  GtkDarktableButton *dtbutton_refresh_album;</a>
<a name="ln176">  GtkComboBox *combo_album;</a>
<a name="ln177">  int albums_count;</a>
<a name="ln178"> </a>
<a name="ln179">  //  === album creation section ===</a>
<a name="ln180">  GtkLabel *label_album_title;</a>
<a name="ln181"> </a>
<a name="ln182">  GtkEntry *entry_album_title;</a>
<a name="ln183"> </a>
<a name="ln184">  GtkBox *hbox_album;</a>
<a name="ln185"> </a>
<a name="ln186">  // == context ==</a>
<a name="ln187">  gboolean connected;</a>
<a name="ln188">  dt_gphoto_context_t *gphoto_api;</a>
<a name="ln189">} dt_storage_gphoto_gui_data_t;</a>
<a name="ln190"> </a>
<a name="ln191"> </a>
<a name="ln192">static dt_gphoto_context_t *gphoto_api_init()</a>
<a name="ln193">{</a>
<a name="ln194">  dt_gphoto_context_t *ctx = (dt_gphoto_context_t *)g_malloc0(sizeof(dt_gphoto_context_t));</a>
<a name="ln195">  ctx-&gt;curl_ctx = curl_easy_init();</a>
<a name="ln196">  ctx-&gt;errmsg = g_string_new(&quot;&quot;);</a>
<a name="ln197">  ctx-&gt;response = g_string_new(&quot;&quot;);</a>
<a name="ln198">  ctx-&gt;json_parser = json_parser_new();</a>
<a name="ln199">  ctx-&gt;google_client_id = dt_conf_get_string(&quot;plugins/imageio/storage/gphoto/id&quot;);</a>
<a name="ln200">  ctx-&gt;google_client_secret = dt_conf_get_string(&quot;plugins/imageio/storage/gphoto/secret&quot;);</a>
<a name="ln201">  return ctx;</a>
<a name="ln202">}</a>
<a name="ln203"> </a>
<a name="ln204">static void gphoto_api_destroy(dt_gphoto_context_t *ctx)</a>
<a name="ln205">{</a>
<a name="ln206">  if(ctx == NULL) return;</a>
<a name="ln207">  curl_easy_cleanup(ctx-&gt;curl_ctx);</a>
<a name="ln208">  g_free(ctx-&gt;token);</a>
<a name="ln209">  g_free(ctx-&gt;refresh_token);</a>
<a name="ln210">  g_free(ctx-&gt;album_title);</a>
<a name="ln211">  g_free(ctx-&gt;google_client_id);</a>
<a name="ln212">  g_free(ctx-&gt;google_client_secret);</a>
<a name="ln213"> </a>
<a name="ln214">  g_object_unref(ctx-&gt;json_parser);</a>
<a name="ln215">  g_string_free(ctx-&gt;errmsg, TRUE);</a>
<a name="ln216">  g_string_free(ctx-&gt;response, TRUE);</a>
<a name="ln217">  g_free(ctx);</a>
<a name="ln218">}</a>
<a name="ln219"> </a>
<a name="ln220"> </a>
<a name="ln221">typedef struct dt_storage_gphoto_param_t</a>
<a name="ln222">{</a>
<a name="ln223">  gint64 hash;</a>
<a name="ln224">} dt_storage_gphoto_param_t;</a>
<a name="ln225"> </a>
<a name="ln226"> </a>
<a name="ln227">static gchar *gphoto_get_user_refresh_token(dt_gphoto_context_t *ctx);</a>
<a name="ln228">static void ui_refresh_albums_fill(dt_gphoto_album_t *album, GtkListStore *list_store);</a>
<a name="ln229"> </a>
<a name="ln230">//////////////////////////// curl requests related functions</a>
<a name="ln231"> </a>
<a name="ln232">static size_t _gphoto_api_buffer_read_func(void *ptr, size_t size, size_t nmemb, void *stream)</a>
<a name="ln233">{</a>
<a name="ln234">  _buffer_t *buffer = (_buffer_t *)stream;</a>
<a name="ln235">  size_t dsize = 0;</a>
<a name="ln236">  if((buffer-&gt;size - buffer-&gt;offset) &gt; nmemb)</a>
<a name="ln237">    dsize = nmemb;</a>
<a name="ln238">  else</a>
<a name="ln239">    dsize = (buffer-&gt;size - buffer-&gt;offset);</a>
<a name="ln240"> </a>
<a name="ln241">  memcpy(ptr, buffer-&gt;data + buffer-&gt;offset, dsize);</a>
<a name="ln242">  buffer-&gt;offset += dsize;</a>
<a name="ln243">  return dsize;</a>
<a name="ln244">}</a>
<a name="ln245"> </a>
<a name="ln246">static size_t curl_write_data_cb(void *ptr, size_t size, size_t nmemb, void *data)</a>
<a name="ln247">{</a>
<a name="ln248">  GString *string = (GString *)data;</a>
<a name="ln249">  g_string_append_len(string, ptr, size * nmemb);</a>
<a name="ln250">#if gphoto_EXTRA_VERBOSE == TRUE</a>
<a name="ln251">  if(strlen(string-&gt;str)&lt;1500)</a>
<a name="ln252">  g_printf(&quot;server reply: %s\n&quot;, string-&gt;str);</a>
<a name="ln253">#endif</a>
<a name="ln254">  return size * nmemb;</a>
<a name="ln255">}</a>
<a name="ln256"> </a>
<a name="ln257">static JsonObject *gphoto_parse_response(dt_gphoto_context_t *ctx, GString *response)</a>
<a name="ln258">{</a>
<a name="ln259">  GError *error = NULL;</a>
<a name="ln260">  gboolean ret = json_parser_load_from_data(ctx-&gt;json_parser, response-&gt;str, response-&gt;len, &amp;error);</a>
<a name="ln261"> </a>
<a name="ln262">  if(ret)</a>
<a name="ln263">  {</a>
<a name="ln264">    JsonNode *root = json_parser_get_root(ctx-&gt;json_parser);</a>
<a name="ln265">    // we should always have a dict</a>
<a name="ln266">    g_return_val_if_fail((json_node_get_node_type(root) == JSON_NODE_OBJECT), NULL);</a>
<a name="ln267"> </a>
<a name="ln268">    JsonObject *rootdict = json_node_get_object(root);</a>
<a name="ln269">    if(json_object_has_member(rootdict, &quot;error&quot;))</a>
<a name="ln270">    {</a>
<a name="ln271">      JsonObject *errorstruct = json_object_get_object_member(rootdict, &quot;error&quot;);</a>
<a name="ln272">      g_return_val_if_fail((errorstruct != NULL), NULL);</a>
<a name="ln273">      const gchar *errormessage = json_object_get_string_member(errorstruct, &quot;message&quot;);</a>
<a name="ln274">      g_return_val_if_fail((errormessage != NULL), NULL);</a>
<a name="ln275">      g_string_assign(ctx-&gt;errmsg, errormessage);</a>
<a name="ln276">      return NULL;</a>
<a name="ln277">    }</a>
<a name="ln278"> </a>
<a name="ln279">    return rootdict;</a>
<a name="ln280">  }</a>
<a name="ln281">  else // not a json response, can be the upload-token</a>
<a name="ln282">  {</a>
<a name="ln283">    ctx-&gt;response = g_string_new(response-&gt;str);</a>
<a name="ln284">    return NULL;</a>
<a name="ln285">  }</a>
<a name="ln286">}</a>
<a name="ln287"> </a>
<a name="ln288">static GList *_gphoto_query_add_arguments(GList *args, const char *name, const char *value)</a>
<a name="ln289">{</a>
<a name="ln290">  _curl_args_t *arg = malloc(sizeof(_curl_args_t));</a>
<a name="ln291">  g_strlcpy(arg-&gt;name, name, sizeof(arg-&gt;name));</a>
<a name="ln292">  g_strlcpy(arg-&gt;value, value, sizeof(arg-&gt;value));</a>
<a name="ln293">  return g_list_append(args, arg);</a>
<a name="ln294">}</a>
<a name="ln295"> </a>
<a name="ln296">/**</a>
<a name="ln297"> * perform a GET request on google photo api</a>
<a name="ln298"> * @returns NULL if the request fails, or a JsonObject of the reply</a>
<a name="ln299"> */</a>
<a name="ln300">static JsonObject *gphoto_query_get(dt_gphoto_context_t *ctx, const gchar *url, GList *args)</a>
<a name="ln301">{</a>
<a name="ln302">  g_return_val_if_fail(ctx != NULL, NULL);</a>
<a name="ln303">  g_return_val_if_fail(ctx-&gt;token != NULL, NULL);</a>
<a name="ln304"> </a>
<a name="ln305">  // send the request</a>
<a name="ln306">  GString *response = g_string_new(&quot;&quot;);</a>
<a name="ln307"> </a>
<a name="ln308">  dt_curl_init(ctx-&gt;curl_ctx, strstr(url,&quot;v1/albums&quot;)==NULL?gphoto_EXTRA_VERBOSE:FALSE);</a>
<a name="ln309"> </a>
<a name="ln310">  args = _gphoto_query_add_arguments(args, &quot;alt&quot;, &quot;json&quot;);</a>
<a name="ln311">  args = _gphoto_query_add_arguments(args, &quot;access_token&quot;, ctx-&gt;token);</a>
<a name="ln312"> </a>
<a name="ln313">  GString *gurl = g_string_new(url);</a>
<a name="ln314"> </a>
<a name="ln315">  GList *a = args;</a>
<a name="ln316"> </a>
<a name="ln317">  while (a)</a>
<a name="ln318">  {</a>
<a name="ln319">    _curl_args_t *ca = (_curl_args_t *)a-&gt;data;</a>
<a name="ln320">    if(a==args)</a>
<a name="ln321">      g_string_append(gurl, &quot;?&quot;);</a>
<a name="ln322">    else</a>
<a name="ln323">      g_string_append(gurl, &quot;&amp;&quot;);</a>
<a name="ln324">    g_string_append(gurl, ca-&gt;name);</a>
<a name="ln325">    g_string_append(gurl, &quot;=&quot;);</a>
<a name="ln326">    g_string_append(gurl, ca-&gt;value);</a>
<a name="ln327"> </a>
<a name="ln328">    a = g_list_next(a);</a>
<a name="ln329">  }</a>
<a name="ln330"> </a>
<a name="ln331">  curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_URL, gurl-&gt;str);</a>
<a name="ln332">  curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_WRITEFUNCTION, curl_write_data_cb);</a>
<a name="ln333">  curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_WRITEDATA, response);</a>
<a name="ln334"> </a>
<a name="ln335">  int res = curl_easy_perform(ctx-&gt;curl_ctx);</a>
<a name="ln336"> </a>
<a name="ln337">  g_list_free(args);</a>
<a name="ln338">  g_string_free(gurl, TRUE);</a>
<a name="ln339"> </a>
<a name="ln340">  if(res != CURLE_OK)</a>
<a name="ln341">  {</a>
<a name="ln342">    g_string_free(response, TRUE);</a>
<a name="ln343">    return NULL;</a>
<a name="ln344">  }</a>
<a name="ln345">  // parse the response</a>
<a name="ln346">  JsonObject *respobj = gphoto_parse_response(ctx, response);</a>
<a name="ln347"> </a>
<a name="ln348">  g_string_free(response, TRUE);</a>
<a name="ln349"> </a>
<a name="ln350">  return respobj;</a>
<a name="ln351">}</a>
<a name="ln352"> </a>
<a name="ln353">/**</a>
<a name="ln354"> * perform a POST request on google photo api</a>
<a name="ln355"> * @returns NULL if the request fails, or a JsonObject of the reply</a>
<a name="ln356"> */</a>
<a name="ln357">static JsonObject *gphoto_query_post(dt_gphoto_context_t *ctx, const gchar *url,</a>
<a name="ln358">                                     struct curl_slist *headers, GList *args, gchar *body, int size)</a>
<a name="ln359">{</a>
<a name="ln360">  g_return_val_if_fail(ctx != NULL, NULL);</a>
<a name="ln361">  g_return_val_if_fail(ctx-&gt;token != NULL, NULL);</a>
<a name="ln362"> </a>
<a name="ln363">  // send the request</a>
<a name="ln364">  GString *response = g_string_new(&quot;&quot;);</a>
<a name="ln365"> </a>
<a name="ln366">  gchar *auth = dt_util_dstrcat(NULL, &quot;Authorization: Bearer %s&quot;, ctx-&gt;token);</a>
<a name="ln367">  struct curl_slist *h = curl_slist_append(headers, auth);</a>
<a name="ln368"> </a>
<a name="ln369">  _buffer_t writebuffer;</a>
<a name="ln370">  writebuffer.data = (void *)body;</a>
<a name="ln371">  writebuffer.size = size;</a>
<a name="ln372">  writebuffer.offset = 0;</a>
<a name="ln373"> </a>
<a name="ln374">  dt_curl_init(ctx-&gt;curl_ctx, TRUE);</a>
<a name="ln375"> </a>
<a name="ln376">  curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_HTTPHEADER, h);</a>
<a name="ln377"> </a>
<a name="ln378">  curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_URL, url);</a>
<a name="ln379">  curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_POST, 1);</a>
<a name="ln380">  curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_WRITEFUNCTION, curl_write_data_cb);</a>
<a name="ln381">  curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_WRITEDATA, response);</a>
<a name="ln382">  curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_READFUNCTION, _gphoto_api_buffer_read_func);</a>
<a name="ln383">  curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_READDATA, &amp;writebuffer);</a>
<a name="ln384"> </a>
<a name="ln385">  int res = curl_easy_perform(ctx-&gt;curl_ctx);</a>
<a name="ln386"> </a>
<a name="ln387">  curl_slist_free_all(h);</a>
<a name="ln388">  g_list_free(args);</a>
<a name="ln389"> </a>
<a name="ln390">  if(res != CURLE_OK)</a>
<a name="ln391">  {</a>
<a name="ln392">    g_string_free(response, TRUE);</a>
<a name="ln393">    return NULL;</a>
<a name="ln394">  }</a>
<a name="ln395">  // parse the response</a>
<a name="ln396">  JsonObject *respobj = gphoto_parse_response(ctx, response);</a>
<a name="ln397"> </a>
<a name="ln398">  g_string_free(response, TRUE);</a>
<a name="ln399"> </a>
<a name="ln400">  return respobj;</a>
<a name="ln401">}</a>
<a name="ln402"> </a>
<a name="ln403">typedef struct</a>
<a name="ln404">{</a>
<a name="ln405">  struct curl_httppost *formpost;</a>
<a name="ln406">  struct curl_httppost *lastptr;</a>
<a name="ln407">} HttppostFormList;</a>
<a name="ln408"> </a>
<a name="ln409">/**</a>
<a name="ln410"> * perform a POST request on google api to get the auth token</a>
<a name="ln411"> *</a>
<a name="ln412"> * @param ctx gphoto context (token field must be set)</a>
<a name="ln413"> * @param method the method to call on the google API, the methods should not start with '/' example:</a>
<a name="ln414"> *&quot;me/albums&quot;</a>
<a name="ln415"> * @param args hashtable of the arguments to be added to the requests, might be null if none</a>
<a name="ln416"> * @returns NULL if the request fails, or a JsonObject of the reply</a>
<a name="ln417"> */</a>
<a name="ln418"> </a>
<a name="ln419">static JsonObject *gphoto_query_post_auth(dt_gphoto_context_t *ctx, const gchar *url, gchar *args)</a>
<a name="ln420">{</a>
<a name="ln421">  g_return_val_if_fail(ctx != NULL, NULL);</a>
<a name="ln422"> </a>
<a name="ln423">  // send the requests</a>
<a name="ln424">  GString *response = g_string_new(&quot;&quot;);</a>
<a name="ln425"> </a>
<a name="ln426">  dt_curl_init(ctx-&gt;curl_ctx, gphoto_EXTRA_VERBOSE);</a>
<a name="ln427"> </a>
<a name="ln428">  curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_URL, url);</a>
<a name="ln429">  curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_POST, 1);</a>
<a name="ln430">  curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_COPYPOSTFIELDS, args);</a>
<a name="ln431">  curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_WRITEFUNCTION, curl_write_data_cb);</a>
<a name="ln432">  curl_easy_setopt(ctx-&gt;curl_ctx, CURLOPT_WRITEDATA, response);</a>
<a name="ln433"> </a>
<a name="ln434">  int res = curl_easy_perform(ctx-&gt;curl_ctx);</a>
<a name="ln435">  if(res != CURLE_OK) return NULL;</a>
<a name="ln436">  // parse the response</a>
<a name="ln437">  JsonObject *respobj = gphoto_parse_response(ctx, response);</a>
<a name="ln438">  g_string_free(response, TRUE);</a>
<a name="ln439">  return respobj;</a>
<a name="ln440">}</a>
<a name="ln441"> </a>
<a name="ln442">//////////////////////////// gphoto api functions</a>
<a name="ln443"> </a>
<a name="ln444">/**</a>
<a name="ln445"> * @returns TRUE if the current token is valid</a>
<a name="ln446"> */</a>
<a name="ln447">static gboolean gphoto_test_auth_token(dt_gphoto_context_t *ctx)</a>
<a name="ln448">{</a>
<a name="ln449">  gchar *access_token = NULL;</a>
<a name="ln450">  access_token = gphoto_get_user_refresh_token(ctx);</a>
<a name="ln451"> </a>
<a name="ln452">  if(access_token != NULL) ctx-&gt;token = access_token;</a>
<a name="ln453"> </a>
<a name="ln454">  return access_token != NULL;</a>
<a name="ln455">}</a>
<a name="ln456"> </a>
<a name="ln457">static dt_gphoto_album_t *_json_new_album(JsonObject *obj)</a>
<a name="ln458">{</a>
<a name="ln459">  // handle on writable albums (in Google Photo only albums created by the API are writeable via the API)</a>
<a name="ln460"> </a>
<a name="ln461">  if(json_object_has_member(obj, &quot;isWriteable&quot;))</a>
<a name="ln462">    if(json_object_get_boolean_member(obj, &quot;isWriteable&quot;))</a>
<a name="ln463">    {</a>
<a name="ln464">      dt_gphoto_album_t *album = gphoto_album_init();</a>
<a name="ln465">      if(album == NULL) goto error;</a>
<a name="ln466"> </a>
<a name="ln467">      const char *id = json_object_get_string_member(obj, &quot;id&quot;);</a>
<a name="ln468">      const char *name = json_object_get_string_member(obj, &quot;title&quot;);</a>
<a name="ln469">      const int size = json_object_has_member(obj, &quot;mediaItemsCount&quot;)</a>
<a name="ln470">        ? json_object_get_int_member(obj, &quot;mediaItemsCount&quot;)</a>
<a name="ln471">        : 0;</a>
<a name="ln472"> </a>
<a name="ln473">      if(id == NULL || name == NULL)</a>
<a name="ln474">      {</a>
<a name="ln475">        gphoto_album_destroy(album);</a>
<a name="ln476">        goto error;</a>
<a name="ln477">      }</a>
<a name="ln478"> </a>
<a name="ln479">      album-&gt;id = g_strdup(id);</a>
<a name="ln480">      album-&gt;name = g_strdup(name);</a>
<a name="ln481">      album-&gt;size = size;</a>
<a name="ln482"> </a>
<a name="ln483">      return album;</a>
<a name="ln484">    }</a>
<a name="ln485"> </a>
<a name="ln486"> error:</a>
<a name="ln487">  return NULL;</a>
<a name="ln488">}</a>
<a name="ln489"> </a>
<a name="ln490">/**</a>
<a name="ln491"> * @return a GList of dt_gphoto_album_ts associated to the user</a>
<a name="ln492"> */</a>
<a name="ln493">static GList *gphoto_get_album_list(dt_gphoto_context_t *ctx, gboolean *ok)</a>
<a name="ln494">{</a>
<a name="ln495">  if(!ok) return NULL;</a>
<a name="ln496"> </a>
<a name="ln497">  *ok = TRUE;</a>
<a name="ln498">  GList *album_list = NULL;</a>
<a name="ln499"> </a>
<a name="ln500">  GList *args = NULL;</a>
<a name="ln501"> </a>
<a name="ln502">//  args = _gphoto_query_add_arguments(args, &quot;pageSize&quot;, &quot;50&quot;); // max for list albums</a>
<a name="ln503"> </a>
<a name="ln504">  JsonObject *reply = gphoto_query_get(ctx, GOOGLE_GPHOTO &quot;v1/albums&quot;, NULL);</a>
<a name="ln505">  if(reply == NULL) goto error;</a>
<a name="ln506"> </a>
<a name="ln507">  do</a>
<a name="ln508">  {</a>
<a name="ln509">    JsonArray *jsalbums = json_object_get_array_member(reply, &quot;albums&quot;);</a>
<a name="ln510"> </a>
<a name="ln511">    for(gint i = 0; i &lt; json_array_get_length(jsalbums); i++)</a>
<a name="ln512">    {</a>
<a name="ln513">      JsonObject *obj = json_array_get_object_element(jsalbums, i);</a>
<a name="ln514">      if(obj == NULL) continue;</a>
<a name="ln515"> </a>
<a name="ln516">      dt_gphoto_album_t *album = _json_new_album(obj);</a>
<a name="ln517">      if(album)</a>
<a name="ln518">        album_list = g_list_append(album_list, album);</a>
<a name="ln519">    }</a>
<a name="ln520"> </a>
<a name="ln521">    args = NULL;</a>
<a name="ln522"> </a>
<a name="ln523">//    args = _gphoto_query_add_arguments(args, &quot;pageSize&quot;, &quot;50&quot;); // max for list albums</a>
<a name="ln524"> </a>
<a name="ln525">    if(json_object_has_member(reply, &quot;nextPageToken&quot;))</a>
<a name="ln526">      args = _gphoto_query_add_arguments(args, &quot;pageToken&quot;, json_object_get_string_member(reply, &quot;nextPageToken&quot;));</a>
<a name="ln527">    else</a>
<a name="ln528">      break;</a>
<a name="ln529"> </a>
<a name="ln530">    reply = gphoto_query_get(ctx, GOOGLE_GPHOTO &quot;v1/albums&quot;, args);</a>
<a name="ln531">    if(reply == NULL) goto error;</a>
<a name="ln532">  } while(true);</a>
<a name="ln533"> </a>
<a name="ln534">  return album_list;</a>
<a name="ln535"> </a>
<a name="ln536">error:</a>
<a name="ln537">  *ok = FALSE;</a>
<a name="ln538">  g_list_free_full(album_list, (GDestroyNotify)gphoto_album_destroy);</a>
<a name="ln539">  return NULL;</a>
<a name="ln540">}</a>
<a name="ln541"> </a>
<a name="ln542">static void ui_reset_albums_creation(struct dt_storage_gphoto_gui_data_t *ui)</a>
<a name="ln543">{</a>
<a name="ln544">  gtk_entry_set_text(ui-&gt;entry_album_title, &quot;&quot;);</a>
<a name="ln545">  gtk_widget_hide(GTK_WIDGET(ui-&gt;hbox_album));</a>
<a name="ln546">}</a>
<a name="ln547"> </a>
<a name="ln548">/**</a>
<a name="ln549"> * @see https://developers.google.com/photos/library/guides/create-albums</a>
<a name="ln550"> * @return the id of the newly reacted</a>
<a name="ln551"> */</a>
<a name="ln552">static const gchar *gphoto_create_album(dt_storage_gphoto_gui_data_t *ui, dt_gphoto_context_t *ctx, gchar *name)</a>
<a name="ln553">{</a>
<a name="ln554">  struct curl_slist *headers = NULL;</a>
<a name="ln555"> </a>
<a name="ln556">  gchar *jbody = dt_util_dstrcat(NULL, &quot;{ \&quot;album\&quot;: { \&quot;title\&quot;: \&quot;%s\&quot;} }&quot;, name);</a>
<a name="ln557"> </a>
<a name="ln558">  headers = curl_slist_append(headers, &quot;Content-type: application/json&quot;);</a>
<a name="ln559"> </a>
<a name="ln560">  JsonObject *response = gphoto_query_post(ctx, GOOGLE_GPHOTO &quot;v1/albums&quot;, headers, NULL, jbody, strlen(jbody));</a>
<a name="ln561"> </a>
<a name="ln562">  // add new album into the list</a>
<a name="ln563">  dt_gphoto_album_t *album = _json_new_album(response);</a>
<a name="ln564">  GtkListStore *model_album = GTK_LIST_STORE(gtk_combo_box_get_model(ui-&gt;combo_album));</a>
<a name="ln565"> </a>
<a name="ln566">  if(album)</a>
<a name="ln567">  {</a>
<a name="ln568">    ui_refresh_albums_fill(album, model_album);</a>
<a name="ln569">    gtk_combo_box_set_active(ui-&gt;combo_album, ui-&gt;albums_count);</a>
<a name="ln570">    ui-&gt;albums_count++;</a>
<a name="ln571">    ui_reset_albums_creation(ui);</a>
<a name="ln572">  }</a>
<a name="ln573"> </a>
<a name="ln574">  g_free(jbody);</a>
<a name="ln575"> </a>
<a name="ln576">  return album?album-&gt;id:NULL;</a>
<a name="ln577">}</a>
<a name="ln578"> </a>
<a name="ln579">/**</a>
<a name="ln580"> *  step.1: https://developers.google.com/photos/library/guides/upload-media#uploading-bytes</a>
<a name="ln581"> *  step.2: https://developers.google.com/photos/library/guides/upload-media#creating-media-item</a>
<a name="ln582"> */</a>
<a name="ln583">static const gchar *gphoto_upload_photo_to_album(dt_gphoto_context_t *ctx, gchar *albumid, gchar *fname,</a>
<a name="ln584">                                                 gchar *title, gchar *summary, const int imgid)</a>
<a name="ln585">{</a>
<a name="ln586">  // step.1 : upload raw data</a>
<a name="ln587"> </a>
<a name="ln588">  gchar *basename = g_path_get_basename(fname);</a>
<a name="ln589"> </a>
<a name="ln590">  JsonObject *response = NULL;</a>
<a name="ln591">  gchar *photo_id = NULL;</a>
<a name="ln592">  gchar *upload_token = NULL;</a>
<a name="ln593"> </a>
<a name="ln594">  gchar *filename = dt_util_dstrcat(NULL, &quot;X-Goog-Upload-File-Name: %s&quot;, basename);</a>
<a name="ln595">  g_free(basename);</a>
<a name="ln596"> </a>
<a name="ln597">  struct curl_slist *headers = curl_slist_append(NULL, &quot;Content-type: application/octet-stream&quot;);</a>
<a name="ln598">  headers = curl_slist_append(headers, filename);</a>
<a name="ln599">  headers = curl_slist_append(headers, &quot;X-Goog-Upload-Protocol: raw&quot;);</a>
<a name="ln600"> </a>
<a name="ln601">  // Open the temp file and read image to memory</a>
<a name="ln602">  GMappedFile *imgfile = g_mapped_file_new(fname, FALSE, NULL);</a>
<a name="ln603">  const int size = g_mapped_file_get_length(imgfile);</a>
<a name="ln604">  gchar *data = g_mapped_file_get_contents(imgfile);</a>
<a name="ln605"> </a>
<a name="ln606">  response = gphoto_query_post(ctx, GOOGLE_GPHOTO &quot;v1/uploads&quot;, headers, NULL, data, size);</a>
<a name="ln607"> </a>
<a name="ln608">  if(!response)</a>
<a name="ln609">  {</a>
<a name="ln610">    // all good, the body is the upload-token</a>
<a name="ln611">    upload_token = g_strdup(ctx-&gt;response-&gt;str);</a>
<a name="ln612">  }</a>
<a name="ln613">  else</a>
<a name="ln614">    return NULL;</a>
<a name="ln615"> </a>
<a name="ln616">  // step.2 : add raw data into an album</a>
<a name="ln617"> </a>
<a name="ln618">  headers = NULL;</a>
<a name="ln619"> </a>
<a name="ln620">  headers = curl_slist_append(headers, &quot;Content-type: application/json&quot;);</a>
<a name="ln621"> </a>
<a name="ln622">  gchar *jbody = dt_util_dstrcat(NULL, &quot;{ \&quot;albumId\&quot;: \&quot;%s\&quot;, &quot;</a>
<a name="ln623">                                         &quot;\&quot;newMediaItems\&quot;: [ &quot;</a>
<a name="ln624">                                           &quot;{ \&quot;description\&quot;: \&quot;%s\&quot;, &quot;</a>
<a name="ln625">                                           &quot;  \&quot;simpleMediaItem\&quot;: { \&quot;uploadToken\&quot;: \&quot;%s\&quot;} &quot;</a>
<a name="ln626">                                           &quot;} ] }&quot;, albumid, summary, upload_token);</a>
<a name="ln627"> </a>
<a name="ln628">  response = gphoto_query_post(ctx, GOOGLE_GPHOTO &quot;v1/mediaItems:batchCreate&quot;, headers, NULL, jbody, strlen(jbody));</a>
<a name="ln629"> </a>
<a name="ln630">  g_free(jbody);</a>
<a name="ln631"> </a>
<a name="ln632">  // check that the upload was correct and return the photo_id</a>
<a name="ln633"> </a>
<a name="ln634">  if(response)</a>
<a name="ln635">  {</a>
<a name="ln636">    if(json_object_has_member(response, &quot;newMediaItemResults&quot;))</a>
<a name="ln637">    {</a>
<a name="ln638">      JsonArray *results = json_object_get_array_member(response, &quot;newMediaItemResults&quot;);</a>
<a name="ln639">      // get first element, we have uploaded a single pciture</a>
<a name="ln640">      JsonObject *root = json_array_get_object_element(results, 0);</a>
<a name="ln641">      JsonObject *o = root;</a>
<a name="ln642">      if(json_object_has_member(o, &quot;status&quot;))</a>
<a name="ln643">      {</a>
<a name="ln644">        o = json_node_get_object(json_object_get_member(o, &quot;status&quot;));</a>
<a name="ln645">        if(json_object_has_member(o, &quot;message&quot;))</a>
<a name="ln646">        {</a>
<a name="ln647">          if(g_strcmp0(json_object_get_string_member(o, &quot;message&quot;), &quot;OK&quot;))</a>
<a name="ln648">            return NULL;</a>
<a name="ln649">        }</a>
<a name="ln650">        else</a>
<a name="ln651">          return NULL;</a>
<a name="ln652">      }</a>
<a name="ln653">      else</a>
<a name="ln654">        return NULL;</a>
<a name="ln655"> </a>
<a name="ln656">      if(json_object_has_member(root, &quot;mediaItem&quot;))</a>
<a name="ln657">      {</a>
<a name="ln658">        o = json_node_get_object(json_object_get_member(root, &quot;mediaItem&quot;));</a>
<a name="ln659">        if(json_object_has_member(o, &quot;id&quot;))</a>
<a name="ln660">          photo_id = g_strdup(json_object_get_string_member(o, &quot;id&quot;));</a>
<a name="ln661">      }</a>
<a name="ln662">    }</a>
<a name="ln663">  }</a>
<a name="ln664"> </a>
<a name="ln665">  return photo_id;</a>
<a name="ln666">}</a>
<a name="ln667"> </a>
<a name="ln668">/**</a>
<a name="ln669"> * @see https://developers.google.com/accounts/docs/OAuth2InstalledApp#callinganapi</a>
<a name="ln670"> * @return basic information about the account</a>
<a name="ln671"> */</a>
<a name="ln672">static dt_gphoto_account_info_t *gphoto_get_account_info(dt_gphoto_context_t *ctx)</a>
<a name="ln673">{</a>
<a name="ln674">  JsonObject *obj = gphoto_query_get(ctx, GOOGLE_API_BASE_URL &quot;oauth2/v1/userinfo&quot;, NULL);</a>
<a name="ln675">  g_return_val_if_fail((obj != NULL), NULL);</a>
<a name="ln676">  /* Using the email instead of the username as it is unique */</a>
<a name="ln677">  /* To change it to use the username, change &quot;email&quot; by &quot;name&quot; */</a>
<a name="ln678">  const gchar *user_name = json_object_get_string_member(obj, &quot;given_name&quot;);</a>
<a name="ln679">  const gchar *email = json_object_get_string_member(obj, &quot;email&quot;);</a>
<a name="ln680">  const gchar *user_id = json_object_get_string_member(obj, &quot;id&quot;);</a>
<a name="ln681">  g_return_val_if_fail(user_name != NULL &amp;&amp; user_id != NULL, NULL);</a>
<a name="ln682"> </a>
<a name="ln683">  gchar *name = NULL;</a>
<a name="ln684">  name = dt_util_dstrcat(name, &quot;%s - %s&quot;, user_name, email);</a>
<a name="ln685"> </a>
<a name="ln686">  dt_gphoto_account_info_t *accountinfo = gphoto_account_info_init();</a>
<a name="ln687">  accountinfo-&gt;id = g_strdup(user_id);</a>
<a name="ln688">  accountinfo-&gt;username = g_strdup(name);</a>
<a name="ln689">  accountinfo-&gt;token = g_strdup(ctx-&gt;token);</a>
<a name="ln690">  accountinfo-&gt;refresh_token = g_strdup(ctx-&gt;refresh_token);</a>
<a name="ln691"> </a>
<a name="ln692">  g_snprintf(ctx-&gt;userid, sizeof(ctx-&gt;userid), &quot;%s&quot;, user_id);</a>
<a name="ln693">  g_free(name);</a>
<a name="ln694">  return accountinfo;</a>
<a name="ln695">}</a>
<a name="ln696"> </a>
<a name="ln697"> </a>
<a name="ln698">///////////////////////////////// UI functions</a>
<a name="ln699"> </a>
<a name="ln700">static gboolean combobox_separator(GtkTreeModel *model, GtkTreeIter *iter, gpointer data)</a>
<a name="ln701">{</a>
<a name="ln702">  GValue value = {</a>
<a name="ln703">    0,</a>
<a name="ln704">  };</a>
<a name="ln705">  gtk_tree_model_get_value(model, iter, 0, &amp;value);</a>
<a name="ln706">  gchar *v = NULL;</a>
<a name="ln707">  if(G_VALUE_HOLDS_STRING(&amp;value))</a>
<a name="ln708">  {</a>
<a name="ln709">    if((v = (gchar *)g_value_get_string(&amp;value)) != NULL &amp;&amp; *v == '\0') return TRUE;</a>
<a name="ln710">  }</a>
<a name="ln711">  g_value_unset(&amp;value);</a>
<a name="ln712">  return FALSE;</a>
<a name="ln713">}</a>
<a name="ln714"> </a>
<a name="ln715">static gchar *gphoto_get_user_refresh_token(dt_gphoto_context_t *ctx)</a>
<a name="ln716">{</a>
<a name="ln717">  gchar *refresh_token = NULL;</a>
<a name="ln718">  JsonObject *reply;</a>
<a name="ln719">  gchar *params = NULL;</a>
<a name="ln720"> </a>
<a name="ln721">  params = dt_util_dstrcat(params, &quot;refresh_token=%s&amp;client_id=%s&amp;client_secret=%s&amp;grant_type=refresh_token&quot;,</a>
<a name="ln722">                           ctx-&gt;refresh_token, ctx-&gt;google_client_id, ctx-&gt;google_client_secret);</a>
<a name="ln723"> </a>
<a name="ln724">  reply = gphoto_query_post_auth(ctx, GOOGLE_API_BASE_URL &quot;oauth2/v4/token&quot;, params);</a>
<a name="ln725"> </a>
<a name="ln726">  refresh_token = g_strdup(json_object_get_string_member(reply, &quot;access_token&quot;));</a>
<a name="ln727"> </a>
<a name="ln728">  g_free(params);</a>
<a name="ln729"> </a>
<a name="ln730">  return refresh_token;</a>
<a name="ln731">}</a>
<a name="ln732"> </a>
<a name="ln733">/**</a>
<a name="ln734"> * @see https://developers.google.com/accounts/docs/OAuth2InstalledApp</a>
<a name="ln735"> * @returns NULL if the user cancels the operation or a valid token</a>
<a name="ln736"> */</a>
<a name="ln737">static int gphoto_get_user_auth_token(dt_storage_gphoto_gui_data_t *ui)</a>
<a name="ln738">{</a>
<a name="ln739">  ///////////// open the authentication url in a browser</a>
<a name="ln740">  GError *error = NULL;</a>
<a name="ln741">  gchar *params = NULL;</a>
<a name="ln742">  params = dt_util_dstrcat(params,</a>
<a name="ln743">                           GOOGLE_WS_BASE_URL</a>
<a name="ln744">                           &quot;o/oauth2/v2/auth?&quot;</a>
<a name="ln745">                           &quot;client_id=%s&amp;redirect_uri=urn:ietf:wg:oauth:2.0:oob&quot;</a>
<a name="ln746">                           &quot;&amp;scope=&quot; GOOGLE_API_BASE_URL &quot;auth/photoslibrary &quot;</a>
<a name="ln747">                           GOOGLE_API_BASE_URL &quot;auth/userinfo.profile &quot;</a>
<a name="ln748">                           GOOGLE_API_BASE_URL &quot;auth/userinfo.email&quot;</a>
<a name="ln749">                           &quot;&amp;response_type=code&amp;access_type=offline&quot;,</a>
<a name="ln750">                           ui-&gt;gphoto_api-&gt;google_client_id);</a>
<a name="ln751"> </a>
<a name="ln752">  if(!gtk_show_uri(gdk_screen_get_default(), params, gtk_get_current_event_time(), &amp;error))</a>
<a name="ln753">  {</a>
<a name="ln754">    fprintf(stderr, &quot;[gphoto] error opening browser: %s\n&quot;, error-&gt;message);</a>
<a name="ln755">    g_error_free(error);</a>
<a name="ln756">  }</a>
<a name="ln757"> </a>
<a name="ln758">  ////////////// build &amp; show the validation dialog</a>
<a name="ln759">  const gchar *text1 = _(&quot;step 1: a new window or tab of your browser should have been &quot;</a>
<a name="ln760">                         &quot;loaded. you have to login into your google account there &quot;</a>
<a name="ln761">                         &quot;and authorize darktable to upload photos before continuing.&quot;);</a>
<a name="ln762">  const gchar *text2 = _(&quot;step 2: paste the verification code shown to you in the browser &quot;</a>
<a name="ln763">                         &quot;and click the OK button once you are done.&quot;);</a>
<a name="ln764"> </a>
<a name="ln765">  GtkWidget *window = dt_ui_main_window(darktable.gui-&gt;ui);</a>
<a name="ln766">  GtkDialog *gphoto_auth_dialog = GTK_DIALOG(</a>
<a name="ln767">      gtk_message_dialog_new(GTK_WINDOW(window), GTK_DIALOG_DESTROY_WITH_PARENT, GTK_MESSAGE_QUESTION,</a>
<a name="ln768">                             GTK_BUTTONS_OK_CANCEL, _(&quot;google authentication&quot;)));</a>
<a name="ln769">#ifdef GDK_WINDOWING_QUARTZ</a>
<a name="ln770">  dt_osx_disallow_fullscreen(GTK_WIDGET(gphoto_auth_dialog));</a>
<a name="ln771">#endif</a>
<a name="ln772">  gtk_message_dialog_format_secondary_text(GTK_MESSAGE_DIALOG(gphoto_auth_dialog), &quot;%s\n\n%s&quot;, text1, text2);</a>
<a name="ln773"> </a>
<a name="ln774">  GtkWidget *entry = gtk_entry_new();</a>
<a name="ln775">  GtkWidget *hbox = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 5);</a>
<a name="ln776">  gtk_box_pack_start(GTK_BOX(hbox), GTK_WIDGET(gtk_label_new(_(&quot;verification code:&quot;))), FALSE, FALSE, 0);</a>
<a name="ln777">  gtk_box_pack_start(GTK_BOX(hbox), GTK_WIDGET(entry), TRUE, TRUE, 0);</a>
<a name="ln778"> </a>
<a name="ln779">  GtkWidget *gphotoauthdialog_vbox</a>
<a name="ln780">      = gtk_message_dialog_get_message_area(GTK_MESSAGE_DIALOG(gphoto_auth_dialog));</a>
<a name="ln781">  gtk_box_pack_end(GTK_BOX(gphotoauthdialog_vbox), hbox, TRUE, TRUE, 0);</a>
<a name="ln782"> </a>
<a name="ln783">  gtk_widget_show_all(GTK_WIDGET(gphoto_auth_dialog));</a>
<a name="ln784"> </a>
<a name="ln785">  ////////////// wait for the user to enter the verification code</a>
<a name="ln786">  gint result;</a>
<a name="ln787">  gchar *token = NULL;</a>
<a name="ln788">  const char *replycode;</a>
<a name="ln789">  while(TRUE)</a>
<a name="ln790">  {</a>
<a name="ln791">    result = gtk_dialog_run(GTK_DIALOG(gphoto_auth_dialog));</a>
<a name="ln792">    if(result == GTK_RESPONSE_CANCEL) break;</a>
<a name="ln793">    replycode = gtk_entry_get_text(GTK_ENTRY(entry));</a>
<a name="ln794">    if(replycode == NULL || g_strcmp0(replycode, &quot;&quot;) == 0)</a>
<a name="ln795">    {</a>
<a name="ln796">      gtk_message_dialog_format_secondary_markup(GTK_MESSAGE_DIALOG(gphoto_auth_dialog),</a>
<a name="ln797">                                                 &quot;%s\n\n%s\n\n&lt;span foreground=\&quot;&quot; MSGCOLOR_RED</a>
<a name="ln798">                                                 &quot;\&quot; &gt;&lt;small&gt;%s&lt;/small&gt;&lt;/span&gt;&quot;,</a>
<a name="ln799">                                                 text1, text2, _(&quot;please enter the verification code&quot;));</a>
<a name="ln800">      continue;</a>
<a name="ln801">    }</a>
<a name="ln802">    else</a>
<a name="ln803">    {</a>
<a name="ln804">      token = g_strdup(replycode);</a>
<a name="ln805">      break;</a>
<a name="ln806">    }</a>
<a name="ln807">  }</a>
<a name="ln808">  gtk_widget_destroy(GTK_WIDGET(gphoto_auth_dialog));</a>
<a name="ln809">  g_free(params);</a>
<a name="ln810"> </a>
<a name="ln811">  if(result == GTK_RESPONSE_CANCEL)</a>
<a name="ln812">    return 1;</a>
<a name="ln813"> </a>
<a name="ln814">  // Interchange now the authorization_code for an access_token and refresh_token</a>
<a name="ln815">  JsonObject *reply;</a>
<a name="ln816"> </a>
<a name="ln817">  params = NULL;</a>
<a name="ln818">  params = dt_util_dstrcat(params, &quot;code=%s&amp;client_id=%s&amp;client_secret=%s&quot;</a>
<a name="ln819">                           &quot;&amp;redirect_uri=&quot; GOOGLE_URI &quot;&amp;grant_type=authorization_code&quot;,</a>
<a name="ln820">                           token, ui-&gt;gphoto_api-&gt;google_client_id, ui-&gt;gphoto_api-&gt;google_client_secret);</a>
<a name="ln821"> </a>
<a name="ln822">  g_free(token);</a>
<a name="ln823"> </a>
<a name="ln824">  reply = gphoto_query_post_auth(ui-&gt;gphoto_api, GOOGLE_WS_BASE_URL &quot;o/oauth2/token&quot;, params);</a>
<a name="ln825"> </a>
<a name="ln826">  gchar *access_token = g_strdup(json_object_get_string_member(reply, &quot;access_token&quot;));</a>
<a name="ln827"> </a>
<a name="ln828">  gchar *refresh_token = g_strdup(json_object_get_string_member(reply, &quot;refresh_token&quot;));</a>
<a name="ln829"> </a>
<a name="ln830">  ui-&gt;gphoto_api-&gt;token = access_token;</a>
<a name="ln831">  ui-&gt;gphoto_api-&gt;refresh_token = refresh_token;</a>
<a name="ln832"> </a>
<a name="ln833">  g_free(params);</a>
<a name="ln834"> </a>
<a name="ln835">  return 0; // FIXME</a>
<a name="ln836">}</a>
<a name="ln837"> </a>
<a name="ln838"> </a>
<a name="ln839">static void load_account_info_fill(gchar *key, gchar *value, GSList **accountlist)</a>
<a name="ln840">{</a>
<a name="ln841">  JsonParser *parser = json_parser_new();</a>
<a name="ln842">  json_parser_load_from_data(parser, value, strlen(value), NULL);</a>
<a name="ln843">  JsonNode *root = json_parser_get_root(parser);</a>
<a name="ln844"> </a>
<a name="ln845">  // defensive check, root can be null while parsing the account info</a>
<a name="ln846">  if(root)</a>
<a name="ln847">  {</a>
<a name="ln848">    JsonObject *obj = json_node_get_object(root);</a>
<a name="ln849">    dt_gphoto_account_info_t *info = gphoto_account_info_init();</a>
<a name="ln850">    info-&gt;id = g_strdup(key);</a>
<a name="ln851">    info-&gt;token = g_strdup(json_object_get_string_member(obj, &quot;token&quot;));</a>
<a name="ln852">    info-&gt;username = g_strdup(json_object_get_string_member(obj, &quot;username&quot;));</a>
<a name="ln853">    info-&gt;id = g_strdup(json_object_get_string_member(obj, &quot;userid&quot;));</a>
<a name="ln854">    info-&gt;refresh_token = g_strdup(json_object_get_string_member(obj, &quot;refresh_token&quot;));</a>
<a name="ln855">    *accountlist = g_slist_prepend(*accountlist, info);</a>
<a name="ln856">  }</a>
<a name="ln857">  g_object_unref(parser);</a>
<a name="ln858">}</a>
<a name="ln859"> </a>
<a name="ln860">/**</a>
<a name="ln861"> * @return a GSList of saved dt_gphoto_account_info_t</a>
<a name="ln862"> */</a>
<a name="ln863">static GSList *load_account_info()</a>
<a name="ln864">{</a>
<a name="ln865">  GSList *accountlist = NULL;</a>
<a name="ln866"> </a>
<a name="ln867">  GHashTable *table = dt_pwstorage_get(GPHOTO_STORAGE);</a>
<a name="ln868">  g_hash_table_foreach(table, (GHFunc)load_account_info_fill, &amp;accountlist);</a>
<a name="ln869">  g_hash_table_destroy(table);</a>
<a name="ln870">  return accountlist;</a>
<a name="ln871">}</a>
<a name="ln872"> </a>
<a name="ln873">static void save_account_info(dt_storage_gphoto_gui_data_t *ui, dt_gphoto_account_info_t *accountinfo)</a>
<a name="ln874">{</a>
<a name="ln875">  dt_gphoto_context_t *ctx = ui-&gt;gphoto_api;</a>
<a name="ln876">  g_return_if_fail(ctx != NULL);</a>
<a name="ln877"> </a>
<a name="ln878">  /// serialize data;</a>
<a name="ln879">  JsonBuilder *builder = json_builder_new();</a>
<a name="ln880">  json_builder_begin_object(builder);</a>
<a name="ln881">  json_builder_set_member_name(builder, &quot;username&quot;);</a>
<a name="ln882">  json_builder_add_string_value(builder, accountinfo-&gt;username);</a>
<a name="ln883">  json_builder_set_member_name(builder, &quot;userid&quot;);</a>
<a name="ln884">  json_builder_add_string_value(builder, accountinfo-&gt;id);</a>
<a name="ln885">  json_builder_set_member_name(builder, &quot;token&quot;);</a>
<a name="ln886">  json_builder_add_string_value(builder, accountinfo-&gt;token);</a>
<a name="ln887">  json_builder_set_member_name(builder, &quot;refresh_token&quot;);</a>
<a name="ln888">  json_builder_add_string_value(builder, accountinfo-&gt;refresh_token);</a>
<a name="ln889"> </a>
<a name="ln890">  json_builder_end_object(builder);</a>
<a name="ln891"> </a>
<a name="ln892">  JsonNode *node = json_builder_get_root(builder);</a>
<a name="ln893">  JsonGenerator *generator = json_generator_new();</a>
<a name="ln894">  json_generator_set_root(generator, node);</a>
<a name="ln895">#if JSON_CHECK_VERSION(0, 14, 0)</a>
<a name="ln896">  json_generator_set_pretty(generator, FALSE);</a>
<a name="ln897">#endif</a>
<a name="ln898">  gchar *data = json_generator_to_data(generator, NULL);</a>
<a name="ln899"> </a>
<a name="ln900">  json_node_free(node);</a>
<a name="ln901">  g_object_unref(generator);</a>
<a name="ln902">  g_object_unref(builder);</a>
<a name="ln903"> </a>
<a name="ln904">  GHashTable *table = dt_pwstorage_get(GPHOTO_STORAGE);</a>
<a name="ln905">  g_hash_table_insert(table, g_strdup(accountinfo-&gt;id), data);</a>
<a name="ln906">  dt_pwstorage_set(GPHOTO_STORAGE, table);</a>
<a name="ln907"> </a>
<a name="ln908">  g_hash_table_destroy(table);</a>
<a name="ln909">}</a>
<a name="ln910"> </a>
<a name="ln911">static void remove_account_info(const gchar *accountid)</a>
<a name="ln912">{</a>
<a name="ln913">  GHashTable *table = dt_pwstorage_get(GPHOTO_STORAGE);</a>
<a name="ln914">  g_hash_table_remove(table, accountid);</a>
<a name="ln915">  dt_pwstorage_set(GPHOTO_STORAGE, table);</a>
<a name="ln916">  g_hash_table_destroy(table);</a>
<a name="ln917">}</a>
<a name="ln918"> </a>
<a name="ln919">static void ui_refresh_users_fill(dt_gphoto_account_info_t *value, gpointer dataptr)</a>
<a name="ln920">{</a>
<a name="ln921">  GtkListStore *liststore = GTK_LIST_STORE(dataptr);</a>
<a name="ln922">  GtkTreeIter iter;</a>
<a name="ln923">  gtk_list_store_append(liststore, &amp;iter);</a>
<a name="ln924">  gtk_list_store_set(liststore, &amp;iter, COMBO_USER_MODEL_NAME_COL, value-&gt;username, COMBO_USER_MODEL_TOKEN_COL,</a>
<a name="ln925">                     value-&gt;token, COMBO_USER_MODEL_REFRESH_TOKEN_COL, value-&gt;refresh_token,</a>
<a name="ln926">                     COMBO_USER_MODEL_ID_COL, value-&gt;id, -1);</a>
<a name="ln927">}</a>
<a name="ln928"> </a>
<a name="ln929">static void ui_refresh_users(dt_storage_gphoto_gui_data_t *ui)</a>
<a name="ln930">{</a>
<a name="ln931">  GSList *accountlist = load_account_info();</a>
<a name="ln932">  GtkListStore *list_store = GTK_LIST_STORE(gtk_combo_box_get_model(ui-&gt;combo_username));</a>
<a name="ln933">  GtkTreeIter iter;</a>
<a name="ln934"> </a>
<a name="ln935">  gtk_list_store_clear(list_store);</a>
<a name="ln936">  gtk_list_store_append(list_store, &amp;iter);</a>
<a name="ln937"> </a>
<a name="ln938">  if(g_slist_length(accountlist) == 0)</a>
<a name="ln939">  {</a>
<a name="ln940">    gtk_list_store_set(list_store, &amp;iter, COMBO_USER_MODEL_NAME_COL, _(&quot;new account&quot;),</a>
<a name="ln941">                       COMBO_USER_MODEL_TOKEN_COL, NULL, COMBO_USER_MODEL_ID_COL, NULL, -1);</a>
<a name="ln942">  }</a>
<a name="ln943">  else</a>
<a name="ln944">  {</a>
<a name="ln945">    gtk_list_store_set(list_store, &amp;iter, COMBO_USER_MODEL_NAME_COL, _(&quot;other account&quot;),</a>
<a name="ln946">                       COMBO_USER_MODEL_TOKEN_COL, NULL, COMBO_USER_MODEL_ID_COL, NULL, -1);</a>
<a name="ln947">    gtk_list_store_append(list_store, &amp;iter);</a>
<a name="ln948">    gtk_list_store_set(list_store, &amp;iter, COMBO_USER_MODEL_NAME_COL, &quot;&quot;, COMBO_USER_MODEL_TOKEN_COL, NULL,</a>
<a name="ln949">                       COMBO_USER_MODEL_ID_COL, NULL, -1); // separator</a>
<a name="ln950">  }</a>
<a name="ln951"> </a>
<a name="ln952">  g_slist_foreach(accountlist, (GFunc)ui_refresh_users_fill, list_store);</a>
<a name="ln953">  gtk_combo_box_set_active(ui-&gt;combo_username, 0);</a>
<a name="ln954"> </a>
<a name="ln955">  g_slist_free_full(accountlist, (GDestroyNotify)gphoto_account_info_destroy);</a>
<a name="ln956">  gtk_combo_box_set_row_separator_func(ui-&gt;combo_username, combobox_separator, ui-&gt;combo_username, NULL);</a>
<a name="ln957">}</a>
<a name="ln958"> </a>
<a name="ln959">static void ui_refresh_albums_fill(dt_gphoto_album_t *album, GtkListStore *list_store)</a>
<a name="ln960">{</a>
<a name="ln961">  GtkTreeIter iter;</a>
<a name="ln962">  gtk_list_store_append(list_store, &amp;iter);</a>
<a name="ln963">  gtk_list_store_set(list_store, &amp;iter, COMBO_ALBUM_MODEL_NAME_COL, album-&gt;name, COMBO_ALBUM_MODEL_ID_COL,</a>
<a name="ln964">                     album-&gt;id, -1);</a>
<a name="ln965">}</a>
<a name="ln966"> </a>
<a name="ln967">static void ui_refresh_albums(dt_storage_gphoto_gui_data_t *ui)</a>
<a name="ln968">{</a>
<a name="ln969">  gboolean getlistok;</a>
<a name="ln970">  GList *albumList = gphoto_get_album_list(ui-&gt;gphoto_api, &amp;getlistok);</a>
<a name="ln971">  if(!getlistok)</a>
<a name="ln972">  {</a>
<a name="ln973">    dt_control_log(_(&quot;unable to retrieve the album list&quot;));</a>
<a name="ln974">    goto cleanup;</a>
<a name="ln975">  }</a>
<a name="ln976"> </a>
<a name="ln977">  const int current_index = gtk_combo_box_get_active(ui-&gt;combo_album);</a>
<a name="ln978"> </a>
<a name="ln979">  GtkListStore *model_album = GTK_LIST_STORE(gtk_combo_box_get_model(ui-&gt;combo_album));</a>
<a name="ln980">  GtkTreeIter iter;</a>
<a name="ln981">  gtk_list_store_clear(model_album);</a>
<a name="ln982">  gtk_list_store_append(model_album, &amp;iter);</a>
<a name="ln983">  gtk_list_store_set(model_album, &amp;iter, COMBO_ALBUM_MODEL_NAME_COL, _(&quot;create new album&quot;),</a>
<a name="ln984">                     COMBO_ALBUM_MODEL_ID_COL, NULL, -1);</a>
<a name="ln985">  ui-&gt;albums_count = 1;</a>
<a name="ln986"> </a>
<a name="ln987">  if(albumList != NULL)</a>
<a name="ln988">  {</a>
<a name="ln989">    gtk_list_store_append(model_album, &amp;iter);</a>
<a name="ln990">    gtk_list_store_set(model_album, &amp;iter, COMBO_ALBUM_MODEL_NAME_COL, &quot;&quot;, COMBO_ALBUM_MODEL_ID_COL, NULL,</a>
<a name="ln991">                       -1); // separator</a>
<a name="ln992">    ui-&gt;albums_count += g_list_length(albumList);</a>
<a name="ln993">  }</a>
<a name="ln994"> </a>
<a name="ln995">  g_list_foreach(albumList, (GFunc)ui_refresh_albums_fill, model_album);</a>
<a name="ln996"> </a>
<a name="ln997">  gtk_widget_show_all(GTK_WIDGET(ui-&gt;combo_album));</a>
<a name="ln998"> </a>
<a name="ln999">  if (albumList != NULL &amp;&amp; current_index &gt; 0)</a>
<a name="ln1000">  {</a>
<a name="ln1001">    gtk_combo_box_set_active(ui-&gt;combo_album, current_index);</a>
<a name="ln1002">    gtk_widget_set_no_show_all(GTK_WIDGET(ui-&gt;hbox_album), TRUE);</a>
<a name="ln1003">    gtk_widget_hide(GTK_WIDGET(ui-&gt;hbox_album));</a>
<a name="ln1004">  }</a>
<a name="ln1005">  else</a>
<a name="ln1006">  {</a>
<a name="ln1007">    gtk_combo_box_set_active(ui-&gt;combo_album, 0);</a>
<a name="ln1008">    gtk_widget_set_no_show_all(GTK_WIDGET(ui-&gt;hbox_album), FALSE);</a>
<a name="ln1009">    gtk_widget_show_all(GTK_WIDGET(ui-&gt;hbox_album));</a>
<a name="ln1010">  }</a>
<a name="ln1011"> </a>
<a name="ln1012">  g_list_free_full(albumList, (GDestroyNotify)gphoto_album_destroy);</a>
<a name="ln1013">cleanup:</a>
<a name="ln1014">  return;</a>
<a name="ln1015">}</a>
<a name="ln1016"> </a>
<a name="ln1017">static void ui_combo_username_changed(GtkComboBox *combo, struct dt_storage_gphoto_gui_data_t *ui)</a>
<a name="ln1018">{</a>
<a name="ln1019">  GtkTreeIter iter;</a>
<a name="ln1020">  gchar *token = NULL;</a>
<a name="ln1021">  gchar *refresh_token = NULL;</a>
<a name="ln1022">  gchar *userid = NULL;</a>
<a name="ln1023">  if(!gtk_combo_box_get_active_iter(combo, &amp;iter)) return; // ie: list is empty while clearing the combo</a>
<a name="ln1024">  GtkTreeModel *model = gtk_combo_box_get_model(combo);</a>
<a name="ln1025">  gtk_tree_model_get(model, &amp;iter, COMBO_USER_MODEL_TOKEN_COL, &amp;token, -1); // get the selected token</a>
<a name="ln1026">  gtk_tree_model_get(model, &amp;iter, COMBO_USER_MODEL_REFRESH_TOKEN_COL, &amp;refresh_token, -1);</a>
<a name="ln1027">  gtk_tree_model_get(model, &amp;iter, COMBO_USER_MODEL_ID_COL, &amp;userid, -1);</a>
<a name="ln1028"> </a>
<a name="ln1029">  ui-&gt;gphoto_api-&gt;token = g_strdup(token);</a>
<a name="ln1030">  ui-&gt;gphoto_api-&gt;refresh_token = g_strdup(refresh_token);</a>
<a name="ln1031">  g_snprintf(ui-&gt;gphoto_api-&gt;userid, sizeof(ui-&gt;gphoto_api-&gt;userid), &quot;%s&quot;, userid);</a>
<a name="ln1032"> </a>
<a name="ln1033">  if(ui-&gt;gphoto_api-&gt;token != NULL &amp;&amp; gphoto_test_auth_token(ui-&gt;gphoto_api))</a>
<a name="ln1034">  {</a>
<a name="ln1035">    ui-&gt;connected = TRUE;</a>
<a name="ln1036">    gtk_button_set_label(ui-&gt;button_login, _(&quot;logout&quot;));</a>
<a name="ln1037">    ui_refresh_albums(ui);</a>
<a name="ln1038">    gtk_widget_set_sensitive(GTK_WIDGET(ui-&gt;combo_album), TRUE);</a>
<a name="ln1039">  }</a>
<a name="ln1040">  else</a>
<a name="ln1041">  {</a>
<a name="ln1042">    gtk_button_set_label(ui-&gt;button_login, _(&quot;login&quot;));</a>
<a name="ln1043">    g_free(ui-&gt;gphoto_api-&gt;token);</a>
<a name="ln1044">    g_free(ui-&gt;gphoto_api-&gt;refresh_token);</a>
<a name="ln1045">    ui-&gt;gphoto_api-&gt;token = ui-&gt;gphoto_api-&gt;refresh_token = NULL;</a>
<a name="ln1046">    gtk_widget_set_sensitive(GTK_WIDGET(ui-&gt;combo_album), FALSE);</a>
<a name="ln1047">    GtkListStore *model_album = GTK_LIST_STORE(gtk_combo_box_get_model(ui-&gt;combo_album));</a>
<a name="ln1048">    gtk_list_store_clear(model_album);</a>
<a name="ln1049">  }</a>
<a name="ln1050">}</a>
<a name="ln1051"> </a>
<a name="ln1052">static void ui_combo_album_changed(GtkComboBox *combo, gpointer data)</a>
<a name="ln1053">{</a>
<a name="ln1054">  dt_storage_gphoto_gui_data_t *ui = (dt_storage_gphoto_gui_data_t *)data;</a>
<a name="ln1055"> </a>
<a name="ln1056">  const int index = gtk_combo_box_get_active(ui-&gt;combo_album);</a>
<a name="ln1057"> </a>
<a name="ln1058">  if(index == 0)</a>
<a name="ln1059">  {</a>
<a name="ln1060">    gtk_widget_set_no_show_all(GTK_WIDGET(ui-&gt;hbox_album), FALSE);</a>
<a name="ln1061">    gtk_widget_show_all(GTK_WIDGET(ui-&gt;hbox_album));</a>
<a name="ln1062">  }</a>
<a name="ln1063">  else</a>
<a name="ln1064">  {</a>
<a name="ln1065">    gtk_widget_set_no_show_all(GTK_WIDGET(ui-&gt;hbox_album), TRUE);</a>
<a name="ln1066">    gtk_widget_hide(GTK_WIDGET(ui-&gt;hbox_album));</a>
<a name="ln1067">  }</a>
<a name="ln1068">}</a>
<a name="ln1069"> </a>
<a name="ln1070">static gboolean ui_authenticate(dt_storage_gphoto_gui_data_t *ui)</a>
<a name="ln1071">{</a>
<a name="ln1072">  if(ui-&gt;gphoto_api == NULL)</a>
<a name="ln1073">  {</a>
<a name="ln1074">    ui-&gt;gphoto_api = gphoto_api_init();</a>
<a name="ln1075">  }</a>
<a name="ln1076"> </a>
<a name="ln1077">  dt_gphoto_context_t *ctx = ui-&gt;gphoto_api;</a>
<a name="ln1078">  gboolean mustsaveaccount = FALSE;</a>
<a name="ln1079"> </a>
<a name="ln1080">  gchar *uiselectedaccounttoken = NULL;</a>
<a name="ln1081">  gchar *uiselectedaccountrefreshtoken = NULL;</a>
<a name="ln1082">  gchar *uiselecteduserid = NULL;</a>
<a name="ln1083">  GtkTreeIter iter;</a>
<a name="ln1084">  gtk_combo_box_get_active_iter(ui-&gt;combo_username, &amp;iter);</a>
<a name="ln1085">  GtkTreeModel *accountModel = gtk_combo_box_get_model(ui-&gt;combo_username);</a>
<a name="ln1086">  gtk_tree_model_get(accountModel, &amp;iter, COMBO_USER_MODEL_TOKEN_COL, &amp;uiselectedaccounttoken, -1);</a>
<a name="ln1087">  gtk_tree_model_get(accountModel, &amp;iter, COMBO_USER_MODEL_REFRESH_TOKEN_COL, &amp;uiselectedaccountrefreshtoken,</a>
<a name="ln1088">                     -1);</a>
<a name="ln1089">  gtk_tree_model_get(accountModel, &amp;iter, COMBO_USER_MODEL_ID_COL, &amp;uiselecteduserid, -1);</a>
<a name="ln1090"> </a>
<a name="ln1091">  if(ctx-&gt;token != NULL)</a>
<a name="ln1092">  {</a>
<a name="ln1093">    g_free(ctx-&gt;token);</a>
<a name="ln1094">    g_free(ctx-&gt;refresh_token);</a>
<a name="ln1095">    ctx-&gt;userid[0] = 0;</a>
<a name="ln1096">    ctx-&gt;token = ctx-&gt;refresh_token = NULL;</a>
<a name="ln1097">  }</a>
<a name="ln1098"> </a>
<a name="ln1099">  if(uiselectedaccounttoken != NULL)</a>
<a name="ln1100">  {</a>
<a name="ln1101">    ctx-&gt;token = g_strdup(uiselectedaccounttoken);</a>
<a name="ln1102">    ctx-&gt;refresh_token = g_strdup(uiselectedaccountrefreshtoken);</a>
<a name="ln1103">    g_snprintf(ctx-&gt;userid, sizeof(ctx-&gt;userid), &quot;%s&quot;, uiselecteduserid);</a>
<a name="ln1104">  }</a>
<a name="ln1105">  // check selected token if we already have one</a>
<a name="ln1106">  if(ctx-&gt;token != NULL &amp;&amp; !gphoto_test_auth_token(ctx))</a>
<a name="ln1107">  {</a>
<a name="ln1108">    g_free(ctx-&gt;token);</a>
<a name="ln1109">    g_free(ctx-&gt;refresh_token);</a>
<a name="ln1110">    ctx-&gt;userid[0] = 0;</a>
<a name="ln1111">    ctx-&gt;token = ctx-&gt;refresh_token = NULL;</a>
<a name="ln1112">  }</a>
<a name="ln1113"> </a>
<a name="ln1114">  int ret = 0;</a>
<a name="ln1115">  if(ctx-&gt;token == NULL)</a>
<a name="ln1116">  {</a>
<a name="ln1117">    mustsaveaccount = TRUE;</a>
<a name="ln1118">    ret = gphoto_get_user_auth_token(ui); // ask user to log in</a>
<a name="ln1119">  }</a>
<a name="ln1120"> </a>
<a name="ln1121">  if(ctx-&gt;token == NULL || ctx-&gt;refresh_token == NULL || ret != 0)</a>
<a name="ln1122">  {</a>
<a name="ln1123">    return FALSE;</a>
<a name="ln1124">  }</a>
<a name="ln1125">  else</a>
<a name="ln1126">  {</a>
<a name="ln1127">    if(mustsaveaccount)</a>
<a name="ln1128">    {</a>
<a name="ln1129">      // Get first the refresh token</a>
<a name="ln1130">      dt_gphoto_account_info_t *accountinfo = gphoto_get_account_info(ui-&gt;gphoto_api);</a>
<a name="ln1131">      g_return_val_if_fail(accountinfo != NULL, FALSE);</a>
<a name="ln1132">      save_account_info(ui, accountinfo);</a>
<a name="ln1133"> </a>
<a name="ln1134">      // add account to user list and select it</a>
<a name="ln1135">      GtkListStore *model = GTK_LIST_STORE(gtk_combo_box_get_model(ui-&gt;combo_username));</a>
<a name="ln1136">      gboolean r;</a>
<a name="ln1137">      gchar *uid;</a>
<a name="ln1138"> </a>
<a name="ln1139">      gboolean updated = FALSE;</a>
<a name="ln1140"> </a>
<a name="ln1141">      for(r = gtk_tree_model_get_iter_first(GTK_TREE_MODEL(model), &amp;iter); r == TRUE;</a>
<a name="ln1142">          r = gtk_tree_model_iter_next(GTK_TREE_MODEL(model), &amp;iter))</a>
<a name="ln1143">      {</a>
<a name="ln1144">        gtk_tree_model_get(GTK_TREE_MODEL(model), &amp;iter, COMBO_USER_MODEL_ID_COL, &amp;uid, -1);</a>
<a name="ln1145"> </a>
<a name="ln1146">        if(g_strcmp0(uid, accountinfo-&gt;id) == 0)</a>
<a name="ln1147">        {</a>
<a name="ln1148">          gtk_list_store_set(model, &amp;iter, COMBO_USER_MODEL_NAME_COL, accountinfo-&gt;username,</a>
<a name="ln1149">                             COMBO_USER_MODEL_TOKEN_COL, accountinfo-&gt;token,</a>
<a name="ln1150">                             COMBO_USER_MODEL_REFRESH_TOKEN_COL, accountinfo-&gt;refresh_token, -1);</a>
<a name="ln1151">          updated = TRUE;</a>
<a name="ln1152">          break;</a>
<a name="ln1153">        }</a>
<a name="ln1154">      }</a>
<a name="ln1155"> </a>
<a name="ln1156">      if(!updated)</a>
<a name="ln1157">      {</a>
<a name="ln1158">        gtk_list_store_append(model, &amp;iter);</a>
<a name="ln1159">        gtk_list_store_set(model, &amp;iter, COMBO_USER_MODEL_NAME_COL, accountinfo-&gt;username,</a>
<a name="ln1160">                           COMBO_USER_MODEL_TOKEN_COL, accountinfo-&gt;token, COMBO_USER_MODEL_REFRESH_TOKEN_COL,</a>
<a name="ln1161">                           accountinfo-&gt;refresh_token, COMBO_USER_MODEL_ID_COL, accountinfo-&gt;id, -1);</a>
<a name="ln1162">      }</a>
<a name="ln1163">      g_signal_handlers_block_matched(ui-&gt;combo_username, G_SIGNAL_MATCH_FUNC, 0, 0, NULL,</a>
<a name="ln1164">                                      ui_combo_username_changed, NULL);</a>
<a name="ln1165">      gtk_combo_box_set_active_iter(ui-&gt;combo_username, &amp;iter);</a>
<a name="ln1166">      g_signal_handlers_unblock_matched(ui-&gt;combo_username, G_SIGNAL_MATCH_FUNC, 0, 0, NULL,</a>
<a name="ln1167">                                        ui_combo_username_changed, NULL);</a>
<a name="ln1168"> </a>
<a name="ln1169">      gphoto_account_info_destroy(accountinfo);</a>
<a name="ln1170">    }</a>
<a name="ln1171">    return TRUE;</a>
<a name="ln1172">  }</a>
<a name="ln1173">}</a>
<a name="ln1174"> </a>
<a name="ln1175"> </a>
<a name="ln1176">static void ui_login_clicked(GtkButton *button, gpointer data)</a>
<a name="ln1177">{</a>
<a name="ln1178">  dt_storage_gphoto_gui_data_t *ui = (dt_storage_gphoto_gui_data_t *)data;</a>
<a name="ln1179">  gtk_widget_set_sensitive(GTK_WIDGET(ui-&gt;combo_album), FALSE);</a>
<a name="ln1180">  if(ui-&gt;connected == FALSE)</a>
<a name="ln1181">  {</a>
<a name="ln1182">    if(ui_authenticate(ui))</a>
<a name="ln1183">    {</a>
<a name="ln1184">      ui_refresh_albums(ui);</a>
<a name="ln1185">      ui-&gt;connected = TRUE;</a>
<a name="ln1186">      gtk_button_set_label(ui-&gt;button_login, _(&quot;logout&quot;));</a>
<a name="ln1187">    }</a>
<a name="ln1188">    else</a>
<a name="ln1189">    {</a>
<a name="ln1190">      gtk_button_set_label(ui-&gt;button_login, _(&quot;login&quot;));</a>
<a name="ln1191">    }</a>
<a name="ln1192">  }</a>
<a name="ln1193">  else // disconnect user</a>
<a name="ln1194">  {</a>
<a name="ln1195">    if(ui-&gt;connected == TRUE &amp;&amp; ui-&gt;gphoto_api-&gt;token != NULL)</a>
<a name="ln1196">    {</a>
<a name="ln1197">      GtkTreeModel *model = gtk_combo_box_get_model(ui-&gt;combo_username);</a>
<a name="ln1198">      GtkTreeIter iter;</a>
<a name="ln1199">      gtk_combo_box_get_active_iter(ui-&gt;combo_username, &amp;iter);</a>
<a name="ln1200">      gchar *userid;</a>
<a name="ln1201">      gtk_tree_model_get(model, &amp;iter, COMBO_USER_MODEL_ID_COL, &amp;userid, -1);</a>
<a name="ln1202">      remove_account_info(userid);</a>
<a name="ln1203">      gtk_button_set_label(ui-&gt;button_login, _(&quot;login&quot;));</a>
<a name="ln1204">      ui_refresh_users(ui);</a>
<a name="ln1205">      ui-&gt;connected = FALSE;</a>
<a name="ln1206">    }</a>
<a name="ln1207">  }</a>
<a name="ln1208">  gtk_widget_set_sensitive(GTK_WIDGET(ui-&gt;combo_album), TRUE);</a>
<a name="ln1209">}</a>
<a name="ln1210"> </a>
<a name="ln1211"> </a>
<a name="ln1212"> </a>
<a name="ln1213">////////////////////////// darktable library interface</a>
<a name="ln1214"> </a>
<a name="ln1215">/* plugin name */</a>
<a name="ln1216">const char *name(const struct dt_imageio_module_storage_t *self)</a>
<a name="ln1217">{</a>
<a name="ln1218">  return _(&quot;google photos&quot;);</a>
<a name="ln1219">}</a>
<a name="ln1220"> </a>
<a name="ln1221">/* construct widget above */</a>
<a name="ln1222">void gui_init(struct dt_imageio_module_storage_t *self)</a>
<a name="ln1223">{</a>
<a name="ln1224">  self-&gt;gui_data = g_malloc0(sizeof(dt_storage_gphoto_gui_data_t));</a>
<a name="ln1225">  dt_storage_gphoto_gui_data_t *ui = self-&gt;gui_data;</a>
<a name="ln1226">  ui-&gt;gphoto_api = gphoto_api_init();</a>
<a name="ln1227"> </a>
<a name="ln1228">  self-&gt;widget = gtk_box_new(GTK_ORIENTATION_VERTICAL, 0);</a>
<a name="ln1229"> </a>
<a name="ln1230">  // create labels</a>
<a name="ln1231">  ui-&gt;label_album_title = GTK_LABEL(gtk_label_new(_(&quot;title&quot;)));</a>
<a name="ln1232">  ui-&gt;label_status = GTK_LABEL(gtk_label_new(NULL));</a>
<a name="ln1233"> </a>
<a name="ln1234">  gtk_widget_set_halign(GTK_WIDGET(ui-&gt;label_album_title), GTK_ALIGN_START);</a>
<a name="ln1235"> </a>
<a name="ln1236">  // create entries</a>
<a name="ln1237">  GtkListStore *model_username</a>
<a name="ln1238">      = gtk_list_store_new(COMBO_USER_MODEL_NB_COL, G_TYPE_STRING, G_TYPE_STRING, G_TYPE_STRING,</a>
<a name="ln1239">                           G_TYPE_STRING); // text, token, refresh_token, id</a>
<a name="ln1240">  ui-&gt;combo_username = GTK_COMBO_BOX(gtk_combo_box_new_with_model(GTK_TREE_MODEL(model_username)));</a>
<a name="ln1241">  GtkCellRenderer *p_cell = gtk_cell_renderer_text_new();</a>
<a name="ln1242">  g_object_set(G_OBJECT(p_cell), &quot;ellipsize&quot;, PANGO_ELLIPSIZE_MIDDLE, &quot;ellipsize-set&quot;, TRUE, &quot;width-chars&quot;, 35,</a>
<a name="ln1243">               (gchar *)0);</a>
<a name="ln1244">  gtk_cell_layout_pack_start(GTK_CELL_LAYOUT(ui-&gt;combo_username), p_cell, FALSE);</a>
<a name="ln1245">  gtk_cell_layout_set_attributes(GTK_CELL_LAYOUT(ui-&gt;combo_username), p_cell, &quot;text&quot;, 0, NULL);</a>
<a name="ln1246"> </a>
<a name="ln1247">  ui-&gt;entry_album_title = GTK_ENTRY(gtk_entry_new());</a>
<a name="ln1248"> </a>
<a name="ln1249">  dt_gui_key_accel_block_on_focus_connect(GTK_WIDGET(ui-&gt;combo_username));</a>
<a name="ln1250">  dt_gui_key_accel_block_on_focus_connect(GTK_WIDGET(ui-&gt;entry_album_title));</a>
<a name="ln1251"> </a>
<a name="ln1252">  // retrieve saved accounts</a>
<a name="ln1253">  ui_refresh_users(ui);</a>
<a name="ln1254"> </a>
<a name="ln1255">  //////// album list /////////</a>
<a name="ln1256">  GtkWidget *albumlist = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0);</a>
<a name="ln1257">  GtkListStore *model_album</a>
<a name="ln1258">      = gtk_list_store_new(COMBO_ALBUM_MODEL_NB_COL, G_TYPE_STRING, G_TYPE_STRING); // name, id</a>
<a name="ln1259">  ui-&gt;combo_album = GTK_COMBO_BOX(gtk_combo_box_new_with_model(GTK_TREE_MODEL(model_album)));</a>
<a name="ln1260">  p_cell = gtk_cell_renderer_text_new();</a>
<a name="ln1261">  g_object_set(G_OBJECT(p_cell), &quot;ellipsize&quot;, PANGO_ELLIPSIZE_MIDDLE, &quot;ellipsize-set&quot;, TRUE, &quot;width-chars&quot;, 35,</a>
<a name="ln1262">               (gchar *)0);</a>
<a name="ln1263">  gtk_cell_layout_pack_start(GTK_CELL_LAYOUT(ui-&gt;combo_album), p_cell, FALSE);</a>
<a name="ln1264">  gtk_cell_layout_set_attributes(GTK_CELL_LAYOUT(ui-&gt;combo_album), p_cell, &quot;text&quot;, 0, NULL);</a>
<a name="ln1265"> </a>
<a name="ln1266">  gtk_widget_set_sensitive(GTK_WIDGET(ui-&gt;combo_album), FALSE);</a>
<a name="ln1267">  gtk_combo_box_set_row_separator_func(ui-&gt;combo_album, combobox_separator, ui-&gt;combo_album, NULL);</a>
<a name="ln1268">  gtk_box_pack_start(GTK_BOX(albumlist), GTK_WIDGET(ui-&gt;combo_album), TRUE, TRUE, 0);</a>
<a name="ln1269"> </a>
<a name="ln1270">  ui-&gt;button_login = GTK_BUTTON(gtk_button_new_with_label(_(&quot;login&quot;)));</a>
<a name="ln1271">  ui-&gt;connected = FALSE;</a>
<a name="ln1272"> </a>
<a name="ln1273">  // pack the ui</a>
<a name="ln1274">  ////the auth box</a>
<a name="ln1275">  GtkWidget *hbox_auth = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 5);</a>
<a name="ln1276">  GtkWidget *vbox_auth_labels = gtk_box_new(GTK_ORIENTATION_VERTICAL, 0);</a>
<a name="ln1277">  GtkWidget *vbox_auth_fields = gtk_box_new(GTK_ORIENTATION_VERTICAL, 0);</a>
<a name="ln1278">  gtk_box_pack_start(GTK_BOX(hbox_auth), vbox_auth_labels, FALSE, FALSE, 0);</a>
<a name="ln1279">  gtk_box_pack_start(GTK_BOX(hbox_auth), vbox_auth_fields, TRUE, TRUE, 0);</a>
<a name="ln1280">  gtk_box_pack_start(GTK_BOX(self-&gt;widget), GTK_WIDGET(hbox_auth), TRUE, FALSE, 2);</a>
<a name="ln1281">  gtk_box_pack_start(GTK_BOX(vbox_auth_fields), GTK_WIDGET(ui-&gt;combo_username), TRUE, FALSE, 2);</a>
<a name="ln1282"> </a>
<a name="ln1283">  gtk_box_pack_start(GTK_BOX(vbox_auth_labels), GTK_WIDGET(gtk_label_new(&quot;&quot;)), TRUE, TRUE, 2);</a>
<a name="ln1284">  gtk_box_pack_start(GTK_BOX(vbox_auth_fields), GTK_WIDGET(ui-&gt;button_login), TRUE, FALSE, 2);</a>
<a name="ln1285"> </a>
<a name="ln1286">  gtk_box_pack_start(GTK_BOX(vbox_auth_fields), GTK_WIDGET(albumlist), TRUE, FALSE, 2);</a>
<a name="ln1287"> </a>
<a name="ln1288">  ////the album creation box</a>
<a name="ln1289">  ui-&gt;hbox_album = GTK_BOX(gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 5));</a>
<a name="ln1290">  gtk_widget_set_no_show_all(GTK_WIDGET(ui-&gt;hbox_album), TRUE); // hide it by default</a>
<a name="ln1291">  GtkWidget *vbox_album_labels = gtk_box_new(GTK_ORIENTATION_VERTICAL, 0);</a>
<a name="ln1292">  GtkWidget *vbox_album_fields = gtk_box_new(GTK_ORIENTATION_VERTICAL, 0);</a>
<a name="ln1293">  gtk_box_pack_start(GTK_BOX(self-&gt;widget), GTK_WIDGET(ui-&gt;hbox_album), TRUE, FALSE, 5);</a>
<a name="ln1294">  gtk_box_pack_start(GTK_BOX(ui-&gt;hbox_album), vbox_album_labels, FALSE, FALSE, 0);</a>
<a name="ln1295">  gtk_box_pack_start(GTK_BOX(ui-&gt;hbox_album), vbox_album_fields, TRUE, TRUE, 0);</a>
<a name="ln1296">  gtk_box_pack_start(GTK_BOX(vbox_album_labels), GTK_WIDGET(ui-&gt;label_album_title), TRUE, TRUE, 0);</a>
<a name="ln1297">  gtk_box_pack_start(GTK_BOX(vbox_album_fields), GTK_WIDGET(ui-&gt;entry_album_title), TRUE, FALSE, 0);</a>
<a name="ln1298"> </a>
<a name="ln1299">  // connect buttons to signals</a>
<a name="ln1300">  g_signal_connect(G_OBJECT(ui-&gt;button_login), &quot;clicked&quot;, G_CALLBACK(ui_login_clicked), (gpointer)ui);</a>
<a name="ln1301">  g_signal_connect(G_OBJECT(ui-&gt;combo_username), &quot;changed&quot;, G_CALLBACK(ui_combo_username_changed),</a>
<a name="ln1302">                   (gpointer)ui);</a>
<a name="ln1303">  g_signal_connect(G_OBJECT(ui-&gt;combo_album), &quot;changed&quot;, G_CALLBACK(ui_combo_album_changed), (gpointer)ui);</a>
<a name="ln1304"> </a>
<a name="ln1305">  g_object_unref(model_username);</a>
<a name="ln1306">  g_object_unref(model_album);</a>
<a name="ln1307">}</a>
<a name="ln1308"> </a>
<a name="ln1309">/* destroy resources */</a>
<a name="ln1310">void gui_cleanup(struct dt_imageio_module_storage_t *self)</a>
<a name="ln1311">{</a>
<a name="ln1312">  dt_storage_gphoto_gui_data_t *ui = self-&gt;gui_data;</a>
<a name="ln1313">  dt_gui_key_accel_block_on_focus_disconnect(GTK_WIDGET(ui-&gt;combo_username));</a>
<a name="ln1314">  dt_gui_key_accel_block_on_focus_disconnect(GTK_WIDGET(ui-&gt;entry_album_title));</a>
<a name="ln1315"> </a>
<a name="ln1316">  if(ui-&gt;gphoto_api != NULL) gphoto_api_destroy(ui-&gt;gphoto_api);</a>
<a name="ln1317">  g_free(self-&gt;gui_data);</a>
<a name="ln1318">}</a>
<a name="ln1319"> </a>
<a name="ln1320">/* reset options to defaults */</a>
<a name="ln1321">void gui_reset(struct dt_imageio_module_storage_t *self)</a>
<a name="ln1322">{</a>
<a name="ln1323">  // TODO?</a>
<a name="ln1324">}</a>
<a name="ln1325"> </a>
<a name="ln1326">/* try and see if this format is supported? */</a>
<a name="ln1327">int supported(struct dt_imageio_module_storage_t *self, struct dt_imageio_module_format_t *format)</a>
<a name="ln1328">{</a>
<a name="ln1329">  if(strcmp(format-&gt;mime(NULL), &quot;image/jpeg&quot;) == 0) return 1;</a>
<a name="ln1330">  return 0;</a>
<a name="ln1331">}</a>
<a name="ln1332"> </a>
<a name="ln1333">/* this actually does the work */</a>
<a name="ln1334">int store(dt_imageio_module_storage_t *self, struct dt_imageio_module_data_t *sdata, const int imgid,</a>
<a name="ln1335">          dt_imageio_module_format_t *format, dt_imageio_module_data_t *fdata, const int num, const int total,</a>
<a name="ln1336">          const gboolean high_quality, const gboolean upscale, dt_colorspaces_color_profile_type_t icc_type,</a>
<a name="ln1337">          const gchar *icc_filename, dt_iop_color_intent_t icc_intent)</a>
<a name="ln1338">{</a>
<a name="ln1339">  dt_storage_gphoto_gui_data_t *ui = self-&gt;gui_data;</a>
<a name="ln1340"> </a>
<a name="ln1341">  gint result = 1;</a>
<a name="ln1342">  dt_gphoto_context_t *ctx = (dt_gphoto_context_t *)sdata;</a>
<a name="ln1343"> </a>
<a name="ln1344">  const char *ext = format-&gt;extension(fdata);</a>
<a name="ln1345">  char fname[PATH_MAX] = { 0 };</a>
<a name="ln1346">  dt_loc_get_tmp_dir(fname, sizeof(fname));</a>
<a name="ln1347">  g_strlcat(fname, &quot;/darktable.XXXXXX.&quot;, sizeof(fname));</a>
<a name="ln1348">  g_strlcat(fname, ext, sizeof(fname));</a>
<a name="ln1349"> </a>
<a name="ln1350">  gint fd = g_mkstemp(fname);</a>
<a name="ln1351">  if(fd == -1)</a>
<a name="ln1352">  {</a>
<a name="ln1353">    dt_control_log(&quot;failed to create temporary image for google photos export&quot;);</a>
<a name="ln1354">    return 1;</a>
<a name="ln1355">  }</a>
<a name="ln1356">  close(fd);</a>
<a name="ln1357"> </a>
<a name="ln1358">  // get metadata</a>
<a name="ln1359">  const dt_image_t *img = dt_image_cache_get(darktable.image_cache, imgid, 'r');</a>
<a name="ln1360">  char *title = NULL;</a>
<a name="ln1361">  char *summary = NULL;</a>
<a name="ln1362">  GList *meta_title = NULL;</a>
<a name="ln1363"> </a>
<a name="ln1364">  title = g_path_get_basename(img-&gt;filename);</a>
<a name="ln1365">  (g_strrstr(title, &quot;.&quot;))[0] = '\0'; // Chop extension...</a>
<a name="ln1366"> </a>
<a name="ln1367">  meta_title = dt_metadata_get(img-&gt;id, &quot;Xmp.dc.title&quot;, NULL);</a>
<a name="ln1368">  summary = meta_title != NULL ? meta_title-&gt;data : &quot;&quot;;</a>
<a name="ln1369"> </a>
<a name="ln1370">  dt_image_cache_read_release(darktable.image_cache, img);</a>
<a name="ln1371"> </a>
<a name="ln1372">  if(dt_imageio_export(imgid, fname, format, fdata, high_quality, upscale, FALSE, icc_type, icc_filename, icc_intent,</a>
<a name="ln1373">                       self, sdata, num, total) != 0)</a>
<a name="ln1374">  {</a>
<a name="ln1375">    g_printerr(&quot;[gphoto] could not export to file: `%s'!\n&quot;, fname);</a>
<a name="ln1376">    dt_control_log(_(&quot;could not export to file `%s'!&quot;), fname);</a>
<a name="ln1377">    result = 0;</a>
<a name="ln1378">    goto cleanup;</a>
<a name="ln1379">  }</a>
<a name="ln1380"> </a>
<a name="ln1381">  if(!*(ctx-&gt;album_id))</a>
<a name="ln1382">  {</a>
<a name="ln1383">    if(ctx-&gt;album_title == NULL)</a>
<a name="ln1384">    {</a>
<a name="ln1385">      dt_control_log(_(&quot;unable to create album, no title provided&quot;));</a>
<a name="ln1386">      result = 0;</a>
<a name="ln1387">      goto cleanup;</a>
<a name="ln1388">    }</a>
<a name="ln1389">    const gchar *album_id  = gphoto_create_album(ui, ctx, ctx-&gt;album_title);</a>
<a name="ln1390">    if(album_id == NULL)</a>
<a name="ln1391">    {</a>
<a name="ln1392">      dt_control_log(_(&quot;unable to create album&quot;));</a>
<a name="ln1393">      result = 0;</a>
<a name="ln1394">      goto cleanup;</a>
<a name="ln1395">    }</a>
<a name="ln1396">    g_snprintf(ctx-&gt;album_id, sizeof(ctx-&gt;album_id), &quot;%s&quot;, album_id);</a>
<a name="ln1397">  }</a>
<a name="ln1398"> </a>
<a name="ln1399">  const char *photoid = gphoto_upload_photo_to_album(ctx, ctx-&gt;album_id, fname, title, summary, imgid);</a>
<a name="ln1400">  if(photoid == NULL)</a>
<a name="ln1401">  {</a>
<a name="ln1402">    dt_control_log(_(&quot;unable to export to google photos album&quot;));</a>
<a name="ln1403">    result = 0;</a>
<a name="ln1404">    goto cleanup;</a>
<a name="ln1405">  }</a>
<a name="ln1406"> </a>
<a name="ln1407">cleanup:</a>
<a name="ln1408">  g_unlink(fname);</a>
<a name="ln1409">  g_free(title);</a>
<a name="ln1410">  g_list_free_full(meta_title, &amp;g_free);</a>
<a name="ln1411"> </a>
<a name="ln1412">  if(result)</a>
<a name="ln1413">  {</a>
<a name="ln1414">    // this makes sense only if the export was successful</a>
<a name="ln1415">    dt_control_log(ngettext(&quot;%d/%d exported to google photos album&quot;, &quot;%d/%d exported to google photos album&quot;, num), num, total);</a>
<a name="ln1416">  }</a>
<a name="ln1417">  return 0;</a>
<a name="ln1418">}</a>
<a name="ln1419"> </a>
<a name="ln1420">static gboolean _finalize_store(gpointer user_data)</a>
<a name="ln1421">{</a>
<a name="ln1422">  dt_storage_gphoto_gui_data_t *ui = (dt_storage_gphoto_gui_data_t *)user_data;</a>
<a name="ln1423">  ui_reset_albums_creation(ui);</a>
<a name="ln1424"> </a>
<a name="ln1425">  return FALSE;</a>
<a name="ln1426">}</a>
<a name="ln1427"> </a>
<a name="ln1428">void finalize_store(struct dt_imageio_module_storage_t *self, dt_imageio_module_data_t *data)</a>
<a name="ln1429">{</a>
<a name="ln1430">  g_main_context_invoke(NULL, _finalize_store, self-&gt;gui_data);</a>
<a name="ln1431">}</a>
<a name="ln1432"> </a>
<a name="ln1433">size_t params_size(dt_imageio_module_storage_t *self)</a>
<a name="ln1434">{</a>
<a name="ln1435">  return sizeof(dt_gphoto_context_t) - 8 * sizeof(void *);</a>
<a name="ln1436">}</a>
<a name="ln1437"> </a>
<a name="ln1438">void init(dt_imageio_module_storage_t *self)</a>
<a name="ln1439">{</a>
<a name="ln1440">}</a>
<a name="ln1441">void *get_params(struct dt_imageio_module_storage_t *self)</a>
<a name="ln1442">{</a>
<a name="ln1443">  dt_storage_gphoto_gui_data_t *ui = (dt_storage_gphoto_gui_data_t *)self-&gt;gui_data;</a>
<a name="ln1444">  if(!ui) return NULL; // gui not initialized, CLI mode</a>
<a name="ln1445">  if(ui-&gt;gphoto_api == NULL || ui-&gt;gphoto_api-&gt;token == NULL)</a>
<a name="ln1446">  {</a>
<a name="ln1447">    return NULL;</a>
<a name="ln1448">  }</a>
<a name="ln1449">  dt_gphoto_context_t *p = (dt_gphoto_context_t *)g_malloc0(sizeof(dt_gphoto_context_t));</a>
<a name="ln1450"> </a>
<a name="ln1451">  p-&gt;curl_ctx = ui-&gt;gphoto_api-&gt;curl_ctx;</a>
<a name="ln1452">  p-&gt;json_parser = ui-&gt;gphoto_api-&gt;json_parser;</a>
<a name="ln1453">  p-&gt;errmsg = ui-&gt;gphoto_api-&gt;errmsg;</a>
<a name="ln1454">  p-&gt;token = g_strdup(ui-&gt;gphoto_api-&gt;token);</a>
<a name="ln1455">  p-&gt;refresh_token = g_strdup(ui-&gt;gphoto_api-&gt;refresh_token);</a>
<a name="ln1456"> </a>
<a name="ln1457">  int index = gtk_combo_box_get_active(ui-&gt;combo_album);</a>
<a name="ln1458">  if(index &lt; 0)</a>
<a name="ln1459">  {</a>
<a name="ln1460">    gphoto_api_destroy(p);</a>
<a name="ln1461">    return NULL;</a>
<a name="ln1462">  }</a>
<a name="ln1463">  else if(index == 0)</a>
<a name="ln1464">  {</a>
<a name="ln1465">    p-&gt;album_id[0] = 0;</a>
<a name="ln1466">    p-&gt;album_title = g_strdup(gtk_entry_get_text(ui-&gt;entry_album_title));</a>
<a name="ln1467"> </a>
<a name="ln1468">    /* Hardcode the album as private, to avoid problems with the old Gphoto interface */</a>
<a name="ln1469">    p-&gt;album_permission = 1;</a>
<a name="ln1470">  }</a>
<a name="ln1471">  else</a>
<a name="ln1472">  {</a>
<a name="ln1473">    GtkTreeModel *model = gtk_combo_box_get_model(ui-&gt;combo_album);</a>
<a name="ln1474">    GtkTreeIter iter;</a>
<a name="ln1475">    gchar *albumid = NULL;</a>
<a name="ln1476">    gtk_combo_box_get_active_iter(ui-&gt;combo_album, &amp;iter);</a>
<a name="ln1477">    gtk_tree_model_get(model, &amp;iter, COMBO_ALBUM_MODEL_ID_COL, &amp;albumid, -1);</a>
<a name="ln1478">    g_snprintf(p-&gt;album_id, sizeof(p-&gt;album_id), &quot;%s&quot;, albumid);</a>
<a name="ln1479">  }</a>
<a name="ln1480"> </a>
<a name="ln1481">  g_snprintf(p-&gt;userid, sizeof(p-&gt;userid), &quot;%s&quot;, ui-&gt;gphoto_api-&gt;userid);</a>
<a name="ln1482"> </a>
<a name="ln1483">  // recreate a new context for further usages</a>
<a name="ln1484">  ui-&gt;gphoto_api = gphoto_api_init();</a>
<a name="ln1485">  ui-&gt;gphoto_api-&gt;token = g_strdup(p-&gt;token);</a>
<a name="ln1486">  ui-&gt;gphoto_api-&gt;refresh_token = g_strdup(p-&gt;refresh_token);</a>
<a name="ln1487">  g_snprintf(ui-&gt;gphoto_api-&gt;userid, sizeof(ui-&gt;gphoto_api-&gt;userid), &quot;%s&quot;, p-&gt;userid);</a>
<a name="ln1488"> </a>
<a name="ln1489">  return p;</a>
<a name="ln1490">}</a>
<a name="ln1491"> </a>
<a name="ln1492">void free_params(struct dt_imageio_module_storage_t *self, dt_imageio_module_data_t *data)</a>
<a name="ln1493">{</a>
<a name="ln1494">  if(!data) return;</a>
<a name="ln1495">  dt_gphoto_context_t *ctx = (dt_gphoto_context_t *)data;</a>
<a name="ln1496">  gphoto_api_destroy(ctx);</a>
<a name="ln1497">}</a>
<a name="ln1498"> </a>
<a name="ln1499">int set_params(struct dt_imageio_module_storage_t *self, const void *params, const int size)</a>
<a name="ln1500">{</a>
<a name="ln1501">  if(size != self-&gt;params_size(self)) return 1;</a>
<a name="ln1502"> </a>
<a name="ln1503">  dt_gphoto_context_t *d = (dt_gphoto_context_t *)params;</a>
<a name="ln1504">  dt_storage_gphoto_gui_data_t *g = (dt_storage_gphoto_gui_data_t *)self-&gt;gui_data;</a>
<a name="ln1505"> </a>
<a name="ln1506">  g_snprintf(g-&gt;gphoto_api-&gt;album_id, sizeof(g-&gt;gphoto_api-&gt;album_id), &quot;%s&quot;, d-&gt;album_id);</a>
<a name="ln1507">  g_snprintf(g-&gt;gphoto_api-&gt;userid, sizeof(g-&gt;gphoto_api-&gt;userid), &quot;%s&quot;, d-&gt;userid);</a>
<a name="ln1508"> </a>
<a name="ln1509">  GtkListStore *model = GTK_LIST_STORE(gtk_combo_box_get_model(g-&gt;combo_username));</a>
<a name="ln1510">  GtkTreeIter iter;</a>
<a name="ln1511">  gboolean r;</a>
<a name="ln1512">  gchar *uid = NULL;</a>
<a name="ln1513">  gchar *albumid = NULL;</a>
<a name="ln1514"> </a>
<a name="ln1515">  for(r = gtk_tree_model_get_iter_first(GTK_TREE_MODEL(model), &amp;iter); r == TRUE;</a>
<a name="ln1516">      r = gtk_tree_model_iter_next(GTK_TREE_MODEL(model), &amp;iter))</a>
<a name="ln1517">  {</a>
<a name="ln1518">    gtk_tree_model_get(GTK_TREE_MODEL(model), &amp;iter, COMBO_USER_MODEL_ID_COL, &amp;uid, -1);</a>
<a name="ln1519">    if(g_strcmp0(uid, g-&gt;gphoto_api-&gt;userid) == 0)</a>
<a name="ln1520">    {</a>
<a name="ln1521">      gtk_combo_box_set_active_iter(g-&gt;combo_username, &amp;iter);</a>
<a name="ln1522">      break;</a>
<a name="ln1523">    }</a>
<a name="ln1524">  }</a>
<a name="ln1525">  g_free(uid);</a>
<a name="ln1526"> </a>
<a name="ln1527">  model = GTK_LIST_STORE(gtk_combo_box_get_model(g-&gt;combo_album));</a>
<a name="ln1528">  for(r = gtk_tree_model_get_iter_first(GTK_TREE_MODEL(model), &amp;iter); r == TRUE;</a>
<a name="ln1529">      r = gtk_tree_model_iter_next(GTK_TREE_MODEL(model), &amp;iter))</a>
<a name="ln1530">  {</a>
<a name="ln1531">    gtk_tree_model_get(GTK_TREE_MODEL(model), &amp;iter, COMBO_ALBUM_MODEL_ID_COL, &amp;albumid, -1);</a>
<a name="ln1532">    if(g_strcmp0(albumid, g-&gt;gphoto_api-&gt;album_id) == 0)</a>
<a name="ln1533">    {</a>
<a name="ln1534">      gtk_combo_box_set_active_iter(g-&gt;combo_album, &amp;iter);</a>
<a name="ln1535">      break;</a>
<a name="ln1536">    }</a>
<a name="ln1537">  }</a>
<a name="ln1538">  g_free(albumid);</a>
<a name="ln1539"> </a>
<a name="ln1540">  return 0;</a>
<a name="ln1541">}</a>
<a name="ln1542"> </a>
<a name="ln1543">// modelines: These editor modelines have been set for all relevant files by tools/update_modelines.sh</a>
<a name="ln1544">// vim: shiftwidth=2 expandtab tabstop=2 cindent</a>
<a name="ln1545">// kate: tab-indents: off; indent-width 2; replace-tabs on; indent-mode cstyle; remove-trailing-spaces modified;</a>

</code></pre>
<div class="balloon" rel="291"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v522/" target="_blank">V522</a> There might be dereferencing of a potential null pointer 'arg'. Check lines: 291, 290.</p></div>
<div class="balloon" rel="333"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v568/" target="_blank">V568</a> It's odd that 'sizeof()' operator evaluates the size of a pointer to a class, but not the size of the 'response' class object.</p></div>
<div class="balloon" rel="376"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v568/" target="_blank">V568</a> It's odd that 'sizeof()' operator evaluates the size of a pointer to a class, but not the size of the 'h' class object.</p></div>
<div class="balloon" rel="381"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v568/" target="_blank">V568</a> It's odd that 'sizeof()' operator evaluates the size of a pointer to a class, but not the size of the 'response' class object.</p></div>
<div class="balloon" rel="432"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v568/" target="_blank">V568</a> It's odd that 'sizeof()' operator evaluates the size of a pointer to a class, but not the size of the 'response' class object.</p></div>
<div class="balloon" rel="812"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v773/" target="_blank">V773</a> The function was exited without releasing the 'token' pointer. A memory leak is possible.</p></div>
<div class="balloon" rel="995"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1004/" target="_blank">V1004</a> The 'albumList' pointer was used unsafely after it was verified against nullptr. Check lines: 987, 995.</p></div>
<div class="balloon" rel="995"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v595/" target="_blank">V595</a> The 'albumList' pointer was utilized before it was verified against nullptr. Check lines: 995, 999.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
